[
    {
        "content": "<p>I'm creating a <a href=\"https://github.com/shortc1rcuit/sudoku-lean\">thing</a> that lets you solve Sudokus in lean while proving each step of the solution. I want to create some tactics to reduce repetitive code. I've done a couple using <code>macro_rules</code> but I think this one will need <code>elab</code>. </p>\n<p>Proving the value of a cell looks like this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">--This tracks the current progress of the sudoku</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">four_by_four_test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Progress</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">  </span><span class=\"o\">],</span>\n<span class=\"w\">                                     </span><span class=\"o\">[</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">none</span><span class=\"w\">  </span><span class=\"o\">],</span>\n<span class=\"w\">                                     </span><span class=\"o\">[</span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">],</span>\n<span class=\"w\">                                     </span><span class=\"o\">[</span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">  </span><span class=\"o\">]]</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">Grid is a function from Fin 4 × Fin 4 to ℕ.</span>\n<span class=\"cm\">We have this alongside the progress object as it's easier to reason about ℕ than Option ℕ</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">four_by_four_test_solve</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Grid</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SudokuRules</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hg_0_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg_0_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg_1_0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hg_2_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg_3_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg_3_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Solvable</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">four_by_four_test</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">four_by_four_test</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hg_1_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"c1\">--Turns the goal into proving that all the other cells in row 1 can't be equal to 1</span>\n<span class=\"w\">    </span><span class=\"n\">elimination</span><span class=\"w\"> </span><span class=\"n\">row_elim</span>\n<span class=\"w\">    </span><span class=\"c1\">--Can't be 1 as there's a 2 here</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hg_1_0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">--Can't be 1 as there's a one in the column</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">col_conflict</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hg_0_1</span>\n<span class=\"w\">    </span><span class=\"c1\">--Can't be 1 as there's a one in the column</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">col_conflict</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hg_3_2</span>\n<span class=\"w\">  </span><span class=\"c1\">--Updates the progress of the sudoku to include the value we just proved</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Solvable</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hg_1_3</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Progress</span><span class=\"bp\">.</span><span class=\"n\">set'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I want this to instead look something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">four_by_four_test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Progress</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">  </span><span class=\"o\">],</span>\n<span class=\"w\">                                     </span><span class=\"o\">[</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">none</span><span class=\"w\">  </span><span class=\"o\">],</span>\n<span class=\"w\">                                     </span><span class=\"o\">[</span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">],</span>\n<span class=\"w\">                                     </span><span class=\"o\">[</span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">  </span><span class=\"o\">]]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">four_by_four_test_solve</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Grid</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SudokuRules</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hg_0_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg_0_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg_1_0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hg_2_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg_3_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg_3_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Solvable</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">four_by_four_test</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">four_by_four_test</span>\n<span class=\"w\">  </span><span class=\"n\">set_cell</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"c1\">--set_cell should create the goal \"g (1, 3) = 1\"...</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">elimination</span><span class=\"w\"> </span><span class=\"n\">row_elim</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hg_1_0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">col_conflict</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hg_0_1</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">col_conflict</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hg_3_2</span>\n<span class=\"w\">  </span><span class=\"c1\">--...add it as a hypothesis with a generated name and apply it to the sudoku progress</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>The name format should be something like \"h[GRIDNAME]_[COORDINATES]\".</p>\n<p>My main questions are:</p>\n<ol>\n<li>How do you add in the new goal?</li>\n<li>How do you add the proven statement to the list of the hypotheses?</li>\n<li>How do you generate the name of the hypothesis?</li>\n</ol>\n<p>(Sorry that this isn't a proper mwe; if I tried to make that I would have to send most of the project in this message. I've linked the github repository of the project if you want to look at the definitions.)</p>",
        "id": 454056154,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1721942460
    },
    {
        "content": "<p>Not an answer to your question, but just checking that you were aware of <span class=\"user-mention\" data-user-id=\"260921\">@Markus Himmel</span> 's <a href=\"https://github.com/TwoFX/sudoku\">https://github.com/TwoFX/sudoku</a> (in Lean 3).</p>",
        "id": 454056465,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1721942604
    },
    {
        "content": "<p>Yes I am. That was an inspiration for this project. My main problem with that project is that you have to know what the solution is before you start (or have a computer to solve it for you). My project uses a method from <a href=\"https://github.com/dwrensha/animate-lean-proofs/blob/main/Chess.lean\">this project</a> to allow you to solve the sudoku without knowing the solution from the start.</p>",
        "id": 454057215,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1721942995
    },
    {
        "content": "<p>If I understand the question correctly, it's about how to metaprogram in Lean. So I think <a class=\"stream\" data-stream-id=\"239415\" href=\"/#narrow/stream/239415-metaprogramming-.2F-tactics\">#metaprogramming / tactics</a> might be more appropriate. I have forgotten all the stuff I learned so can't help for now :P</p>",
        "id": 454085542,
        "sender_full_name": "Gareth Ma",
        "timestamp": 1721953612
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"632788\">shortc1rcuit</span> has marked this topic as resolved.</p>",
        "id": 454317085,
        "sender_full_name": "Notification Bot",
        "timestamp": 1722005911
    },
    {
        "content": "<p>Ah fair I'll copy it over to there then</p>",
        "id": 454322734,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1722007300
    },
    {
        "content": "<p>(further discussion at <a class=\"stream-topic\" data-stream-id=\"239415\" href=\"/#narrow/stream/239415-metaprogramming-.2F-tactics/topic/Tactics.20for.20Sudoku\">#metaprogramming / tactics &gt; Tactics for Sudoku</a> )</p>",
        "id": 454399203,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1722042173
    }
]