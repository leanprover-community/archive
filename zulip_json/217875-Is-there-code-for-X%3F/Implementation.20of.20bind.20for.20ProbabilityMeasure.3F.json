[
    {
        "content": "<p>The <code>GiryMonad</code> docs talk about how the presentation has been generalized to arbitrary <code>Measure</code>s, despite the standard presentation focusing specifically on probability measures. This seems like a reasonable choice, but I was surprised that I couldn't find a version of <code>bind</code> that comes with an appropriate <code>IsProbabilityMeasure</code> proof. I'm relatively new to Mathlib, so there's a chance that I'm just missing something. Or maybe there's a technical reason that this is hard / not possible? Any help would be appreciated.</p>",
        "id": 556623966,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1763230478
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"686704\">@Harry Goldstein</span> <a href=\"https://loogle.lean-lang.org/?q=%22bind%22%2C+%22measure%22\">Loogle</a> (which everyone should learn) reveals <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/MeasureTheory/Measure/GiryMonad.html#MeasureTheory.Measure.bind\">MeasureTheory.Measure.bind</a>. Is this what you're looking for? (Disclaimer, I don't work with this part of the library)</p>",
        "id": 556625933,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763232392
    },
    {
        "content": "<p>I did check Loogle, it's a great tool! <code>Measure.bind</code> implements the functionality I'm after, but if I have a <code>ProbabilityMeasure</code> (which is a <code>Measure</code> satisfying <code>IsProbabilityMeasure</code>) then I don't have a version of bind that maintains the <code>IsProbabilityMeasure</code> proof. At least, not as far as I can tell.</p>",
        "id": 556626045,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1763232510
    },
    {
        "content": "<p>It looks to me that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.Measure.instIsProbabilityMeasureBindCoeKernelOfIsMarkovKernel#doc\">docs#MeasureTheory.Measure.instIsProbabilityMeasureBindCoeKernelOfIsMarkovKernel</a> might be the instance you want</p>",
        "id": 556626069,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1763232527
    },
    {
        "content": "<p>Ah that looks like it! I didn't think to search for things to do with kernels. Thank you!</p>",
        "id": 556626153,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1763232603
    },
    {
        "content": "<p><a href=\"https://loogle.lean-lang.org/?q=MeasureTheory.Measure.bind%2C%20MeasureTheory.IsProbabilityMeasure\">This is what I searched</a>, in case it's helpful in the future: I also didn't think to search for things about kernels!</p>",
        "id": 556626177,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1763232633
    },
    {
        "content": "<p>I don't know why I didn't think to search that way! That makes sense. Thanks</p>",
        "id": 556626271,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1763232717
    },
    {
        "content": "<p>Hmm. On further inspection this might not quite be what I want? Or if it is, the proof that shows it does what I want is a bit tricky.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">GiryMonad</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">DiracProba</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Probability</span><span class=\"bp\">.</span><span class=\"n\">Kernel</span><span class=\"bp\">.</span><span class=\"n\">Composition</span><span class=\"bp\">.</span><span class=\"n\">MeasureComp</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">MeasureTheory</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ProbabilityMeasure</span><span class=\"bp\">.</span><span class=\"n\">bind</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProbabilityMeasure</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ProbabilityMeasure</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">ProbabilityMeasure</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"bp\">.</span><span class=\"n\">bind</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">·.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">pf</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">x_prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">f_prop</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">κ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ProbabilityTheory</span><span class=\"bp\">.</span><span class=\"n\">Kernel</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProbabilityTheory</span><span class=\"bp\">.</span><span class=\"n\">IsMarkovKernel</span><span class=\"w\"> </span><span class=\"n\">κ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">f_prop</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsProbabilityMeasure</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">bind</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">κ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"w\">  </span><span class=\"n\">assumption</span>\n</code></pre></div>\n<p>That last <code>inferInstance</code> uses the instance mentioned above, but it requires me to make <code>f</code> a <code>Kernel</code>, and I don't see an easy route there. Anyone have ideas here? Or should I ask elsewhere?</p>",
        "id": 556746406,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1763355356
    },
    {
        "content": "<p>You need <code>f</code> to be measurable</p>",
        "id": 556799929,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763377382
    },
    {
        "content": "<p>Also you should use <code>Measure</code> with <code>IsProbabilityMeasure</code> instances instead of <code>ProbabilityMeasure</code>.</p>",
        "id": 556800678,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1763377601
    },
    {
        "content": "<p>Perhaps for some more clarity the reason there is no bind for <code>ProbabilityMeasure</code> is that <code>ProbabilityMeasure</code> is only supposed to be used when you are using the topology of weak convergence on the space of probability measures (convergence in distribution). Otherwise you should just use <code>Measure</code> with <code>IsProbabilityMeasure</code>. This way we don't have to duplicate the entire API for probability measures (or finite measures etc...) and all the API for measures also works for them.</p>",
        "id": 556805589,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1763379186
    },
    {
        "content": "<p>Also you can think of a Kernel as just a function <code>f : α → Measure β</code> with a measurability condition, and that measurability condition is needed to make statements like this true. So whatever your application is there is a good chance you want to be using the language of kernels anyway (and this is the reason there is more API for Kernels then bind directly).</p>",
        "id": 556806489,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1763379459
    }
]