[
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113489-new-members/topic/Unexpected.20token.20when.20deriving.20instance/near/520497562\">said</a>:</p>\n<blockquote>\n<p><code>deriving instance Lean.ToExpr for Rat</code></p>\n</blockquote>\n<p>I'm surprised that this isn't somewhere in mathlib already</p>",
        "id": 520499256,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748279902
    },
    {
        "content": "<p>Though I guess there's the question of whether it should use <code>a / b</code> or <code>OfScientific</code></p>",
        "id": 520499305,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748279925
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113489-new-members/topic/Unexpected.20token.20when.20deriving.20instance/near/520499305\">said</a>:</p>\n<blockquote>\n<p>Though I guess there's the question of whether it should use <code>a / b</code> or <code>OfScientific</code></p>\n</blockquote>\n<p>How would you use <code>OfScientific</code>?</p>",
        "id": 520500727,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1748280515
    },
    {
        "content": "<p>Only when b is of the form <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>x</mi></msup><msup><mn>5</mn><mi>y</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^x5^y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6644em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">x</span></span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord\">5</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">y</span></span></span></span></span></span></span></span></span></span></span> I guess</p>",
        "id": 520501670,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748280874
    },
    {
        "content": "<p>that sounds like it will cause some people debugging hell later</p>",
        "id": 520502780,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1748281331
    },
    {
        "content": "<p>You mean to say that people care about other primes too?</p>",
        "id": 520502896,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748281402
    },
    {
        "content": "<p>You're right though, <code>/</code> is the reasonable choice</p>",
        "id": 520502941,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748281431
    },
    {
        "content": "<p>Is this a reasonable implementation?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToExpr</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toTypeExpr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkApp3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``OfNat.ofNat</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">levelZero</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">mkRawNatLit</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat.instOfNat</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkRawNatLit</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">numAbs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"bp\">.</span><span class=\"n\">natAbs</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">numAbs</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">mkApp3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Neg.neg</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">levelZero</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat.instNeg</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"n\">numAbs</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">den</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">.</span><span class=\"n\">den</span>\n<span class=\"w\">      </span><span class=\"n\">mkApp6</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``HDiv.hDiv</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">levelZero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">levelZero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">levelZero</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">mkApp2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``instHDiv</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">levelZero</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Rat.instDiv</span><span class=\"w\"> </span><span class=\"o\">[]))</span>\n<span class=\"w\">        </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"n\">den</span>\n</code></pre></div>",
        "id": 520504348,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1748282113
    },
    {
        "content": "<p>I think we already have most of an instance inside norm_num</p>",
        "id": 520506713,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748283094
    },
    {
        "content": "<p>I guess the other question is whether we want <code>(-a) / b</code> or <code>-(a/b)</code></p>",
        "id": 520506805,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748283122
    },
    {
        "content": "<p><code>(-a) / b</code> pretty prints as <code>-a / b</code>, and <code>-(a/b)</code> pretty prints as <code>-(a / b)</code></p>",
        "id": 520507594,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1748283476
    },
    {
        "content": "<p>the normal form in <code>norm_num</code> is also <code>(-a) / b</code></p>",
        "id": 520507706,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1748283513
    },
    {
        "content": "<p>Neither of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=neg_div#doc\">docs#neg_div</a> or <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=neg_div%27#doc\">docs#neg_div'</a> are simp though, interestingly</p>",
        "id": 520507741,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748283530
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/113489-new-members/topic/Unexpected.20token.20when.20deriving.20instance/near/520507706\">said</a>:</p>\n<blockquote>\n<p>the normal form in <code>norm_num</code> is also <code>(-a) / b</code></p>\n</blockquote>\n<p>Nice evidence that the toExpr function almost already exists!</p>",
        "id": 520507811,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748283565
    },
    {
        "content": "<p>This is the closest I got when I needed it quickly before:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- hack, this should be constructed inline</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkRatQ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">m'n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkRawIntLit</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">.</span><span class=\"n\">num</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">m'd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkRawNatLit</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">.</span><span class=\"n\">den</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">isRat'</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m'n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m'd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"gr\">sorry</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"n\">m'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℝ</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"n\">hm'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">toSimpResult</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">m'</span>\n</code></pre></div>",
        "id": 520507990,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748283650
    },
    {
        "content": "<p>Where the relevant code is <a href=\"https://github.com/leanprover-community/mathlib4/blob/cdf00c3262877ba8a9c34e58215d2a31dee64adb/Mathlib/Tactic/NormNum/Result.lean#L429-L440\">here</a></p>",
        "id": 520508075,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748283699
    },
    {
        "content": "<p>16 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/channel/113489-new-members/topic/Unexpected.20token.20when.20deriving.20instance/with/520497512\">#new members &gt; Unexpected token when deriving instance</a> by <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>.</p>",
        "id": 520511637,
        "sender_full_name": "Notification Bot",
        "timestamp": 1748285123
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Lean.2EToExpr.20Rat/near/520508075\">said</a>:</p>\n<blockquote>\n<p>Where the relevant code is <a href=\"https://github.com/leanprover-community/mathlib4/blob/cdf00c3262877ba8a9c34e58215d2a31dee64adb/Mathlib/Tactic/NormNum/Result.lean#L429-L440\">here</a></p>\n</blockquote>\n<p>This seems to contradict the claim that the normal form in <code>norm_num</code> is <code>(-a) / b</code></p>",
        "id": 520533108,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748295066
    },
    {
        "content": "<p>I can clearly see <code>-(a / b)</code> there</p>",
        "id": 520533125,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748295078
    },
    {
        "content": "<p>and a test like <code>example : -1 / (2:Rat) = sorry := by norm_num</code> normalizes to <code>-(1 / 2)</code></p>",
        "id": 520533293,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748295184
    },
    {
        "content": "<p>The <code>pp.numericTypes</code> option assumes that rational numbers are of the form <code>HDiv.hDiv (nat &lt;|&gt; Neg.neg nat) nat</code> for what it's worth.</p>",
        "id": 520534646,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748295980
    },
    {
        "content": "<p>I think that's the right behavior for printing whatever the norm_num-normal form is, to avoid printing <code>(-(a / b) : Rat)</code></p>",
        "id": 520536149,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748296882
    }
]