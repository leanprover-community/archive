[
    {
        "content": "<p>Hi, I'm new to Lean, and wanted to know if there is some way to return a list of types that implements certain class.</p>\n<p>For example, supposing the following <code>Foo</code> class:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"I'm int\"</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"I'm nat\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"c1\">-- \"I'm Int\"</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"c1\">-- \"I'm Nat\"</span>\n\n<span class=\"c1\">-- It works</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">fooListOk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- I would want to get some error because UInt64 does not implement Foo</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">fooListBad</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>How I can refine the type of <code>fooListBad</code> to only allow types implementing <code>Foo</code>?</p>\n<p>Thanks!</p>",
        "id": 450952284,
        "sender_full_name": "Luis Enrique Muñoz Martín",
        "timestamp": 1720785998
    },
    {
        "content": "<p>Just make a structure with an <code>X : Type</code> and <code>foo : Foo X</code> fields.</p>",
        "id": 450965042,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720788717
    },
    {
        "content": "<p>Thanks for your fast answer!</p>\n<p>Ok, so supposing I have, as you've said:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">X</span>\n</code></pre></div>\n<p><del>Should be the type of <code>fooList</code> now <code>List FooTy</code>?</del><br>\n<del>Not quite sure how to initialize the field <code>foo : Foo X</code> when creating the list. Could you provide a super small example?</del></p>\n<p><del>If my elements need to implement 2 classes instead, let's say <code>Foo</code> and <code>Bar</code> classes, how could I encode that following the above?</del></p>\n<p>Thanks again!</p>",
        "id": 450992409,
        "sender_full_name": "Luis Enrique Muñoz Martín",
        "timestamp": 1720794516
    },
    {
        "content": "<p>After playing a bit more with it I figure out the list would be as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">fooTyList</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">⟨</span><span class=\"n\">Int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"I'm Int\"</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"I'm Nat\"</span><span class=\"o\">}</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Who creates the list is who chose the implementation of <code>foo</code>. Is it not possible to automatically use the method instance from the type?</p>",
        "id": 450997839,
        "sender_full_name": "Luis Enrique Muñoz Martín",
        "timestamp": 1720795573
    },
    {
        "content": "<p>You can do this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"I'm int\"</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"I'm nat\"</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">FooTy</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">FooTy</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"c1\">-- \"I'm Int\"</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"c1\">-- \"I'm Nat\"</span>\n\n<span class=\"c1\">-- It works</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">fooListOk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">⟨</span><span class=\"n\">Int</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Nat</span><span class=\"bp\">⟩</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- I would want to get some error because UInt64 does not implement Foo</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">fooListBad</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">⟨</span><span class=\"n\">Int</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Nat</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">UInt64</span><span class=\"bp\">⟩</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 451023267,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720801507
    },
    {
        "content": "<p>You can replace that <code>inductive</code> with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 451029886,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720803864
    },
    {
        "content": "<p>The binder kinds affect the constructor, so for example here <code>foo</code> will be solved for by default using typeclass inference.</p>",
        "id": 451030002,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720803908
    },
    {
        "content": "<p>Amazing!</p>\n<p>I understand the <code>foo</code> name in <code>[foo : Foo X]</code> is mandatory even although is not used directly.</p>\n<p>One more question regarding this . Using the list, I'm unable to call <code>foo</code> on an element. I would expect the following to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">fooListOk</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">X</span>\n</code></pre></div>\n<p>because the compiler should know that <code>X</code> implements <code>foo</code> <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>\n<p>but I get:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">fooListOk</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">X</span>\n</code></pre></div>",
        "id": 451046015,
        "sender_full_name": "Luis Enrique Muñoz Martín",
        "timestamp": 1720808882
    },
    {
        "content": "<p>Typeclass inference doesn't know to look into the <code>FooTy</code> term to make that instance available when you use the expression unfortunately.</p>\n<p>By the way, the name <code>foo</code> does matter, since you can use <code>fooListOk[0]!.foo</code> to refer to the instance.</p>",
        "id": 451047836,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720809551
    },
    {
        "content": "<p>Here's a trick that seems to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"I'm int\"</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"I'm nat\"</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"c1\">-- \"I'm Int\"</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"c1\">-- \"I'm Nat\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"bp\">.</span><span class=\"n\">withX</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">foo</span>\n\n<span class=\"c1\">-- It works</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">fooListOk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">⟨</span><span class=\"n\">Int</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Nat</span><span class=\"bp\">⟩</span><span class=\"o\">]</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"n\">Nat</span><span class=\"bp\">⟩⟩</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">fooListOk</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">withX</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"c1\">-- \"I'm Int\"</span>\n</code></pre></div>\n<p>You can even write <code>fooListOk[0]!.withX Foo.foo</code> without the <code>fun</code>.</p>",
        "id": 451048303,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720809749
    },
    {
        "content": "<p>Isn't <code>attribute [instance] FooTy.foo</code> sufficient to make things work as expected?</p>",
        "id": 451093949,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720826617
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">FooTy</span><span class=\"bp\">.</span><span class=\"n\">foo</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">fooListOk</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">X</span>\n<span class=\"c1\">-- \"I'm Int\"</span>\n</code></pre></div>",
        "id": 451098496,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720829317
    },
    {
        "content": "<p>There's a pragmatic argument that <code>attribute [instance] FooTy.foo</code> should be implied, but the problem with that is that there is then no way to opt out</p>",
        "id": 451098816,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720829513
    },
    {
        "content": "<p>Thanks for your answer, I didn't know about this!</p>\n<p>I understand the bad part of this is that you need to add each class found in <code>FooTy</code> to the attribute list: <code>attribute [instance] FooTy.foo FooTy.bar</code> ...</p>\n<p>Is there any way to add all classes/binders from a structure automatically? Something like <code>attribute [instance] FooTy.*</code> My real scenario would imply an structure with a lot of types with a lot of classes each type:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">add1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">sub1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">mul1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">div1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Div</span><span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"o\">]</span>\n\n<span class=\"w\">  </span><span class=\"n\">AccountId</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">add2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">AccountId</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">sub2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">AccountId</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">--more binder kinds ...</span>\n\n<span class=\"w\">  </span><span class=\"n\">ComplexTypeWithCustomClasses</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">    </span><span class=\"c1\">--more binder kinds ...</span>\n\n<span class=\"w\"> </span><span class=\"c1\">-- more types ...</span>\n</code></pre></div>\n<p>My intention is to pass this <code>Config</code> type \"everywhere\" on my library to allow the user customize the types used internally. Not sure if this is something out of scope for lean4</p>",
        "id": 451175522,
        "sender_full_name": "Luis Enrique Muñoz Martín",
        "timestamp": 1720878968
    },
    {
        "content": "<p>my advice would be to define </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span><span class=\"cm\"> class for types implementing Number interface -/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">NumClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Div</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> class for types implementing AccountId interface -/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AccountIdClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> class for types implementing complextype interface -/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ComplexTypeClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">instNumClass</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NumClass</span><span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">AccountId</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">instAccountIdClass</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccountIdClass</span><span class=\"o\">]</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>etc. This way, you can more easily group the classes you want. Basically, make sure you have a meaningful hierarchy of typeclasses for the kinds of interface you want.<br>\nthis way, you limit the number of <code>attribute</code>s you need to declare</p>",
        "id": 451190074,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1720885583
    },
    {
        "content": "<p>this also makes the functions where you use these types have more meaningful type signatures</p>",
        "id": 451190118,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1720885635
    },
    {
        "content": "<p>Thanks for the solution. Reduce significatly the boilerplate!</p>\n<p>With the above, I understand that I would need to implement <code>NumClass</code> for <code>Int</code>, <code>Nat</code>, etc in order to allow the user to use those types again, right? </p>\n<p>Can these classes be autoimplemented for the types that already implement the extended classes?</p>",
        "id": 451192892,
        "sender_full_name": "Luis Enrique Muñoz Martín",
        "timestamp": 1720887125
    },
    {
        "content": "<p>i'm afraid not. this is because that will cause typeclass synth to loop</p>",
        "id": 451193662,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1720887482
    },
    {
        "content": "<p>there might be a workaround though</p>",
        "id": 451193816,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1720887540
    },
    {
        "content": "<p>although, having tested it, maybe not?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instNumClass</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Div</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NumClass</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n</code></pre></div>\n<p>give this a go, no guarantees that this won't cause problems though</p>",
        "id": 451194719,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1720887921
    },
    {
        "content": "<p>Typeclass synthesis is allowed to have loops in Lean 4</p>",
        "id": 451197628,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720889332
    },
    {
        "content": "<p>oh, i didn't know that?</p>",
        "id": 451204127,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1720892982
    },
    {
        "content": "<p>nice</p>",
        "id": 451204131,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1720892987
    },
    {
        "content": "<p>Thanks!</p>\n<blockquote>\n<p>Typeclass synthesis is allowed to have loops in Lean 4</p>\n</blockquote>\n<p>What does it imply in the code? A different solution than <span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span>  mentioned?</p>",
        "id": 451375324,
        "sender_full_name": "Luis Enrique Muñoz Martín",
        "timestamp": 1720984186
    },
    {
        "content": "<p>no, it means that the solution i provided doesn't cause issues of the sort i expected.</p>",
        "id": 451375396,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1720984241
    },
    {
        "content": "<p>To sum up the above, just for reference. </p>\n<p>If you want a type you can pass though your library to customize the inner types used by it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AccountIdClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccountIdClass</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"w\">  </span><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">BalanceClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Div</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Div</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BalanceClass</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"w\">  </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">AccountId</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">accountIdClass</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AccountIdClass</span><span class=\"w\"> </span><span class=\"n\">AccountId</span><span class=\"o\">]</span>\n\n<span class=\"w\">    </span><span class=\"n\">Balance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">balanceClass</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BalanceClass</span><span class=\"w\"> </span><span class=\"n\">Balance</span><span class=\"o\">]</span>\n\n<span class=\"w\">  </span><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"bp\">.</span><span class=\"n\">accountIdClass</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"bp\">.</span><span class=\"n\">balanceClass</span>\n</code></pre></div>\n<p>You can use that type as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">addBalances</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">Balance</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">Balance</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">Balance</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span>\n\n<span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">myConfig</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">AccountId</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">Balance</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">addBalances</span><span class=\"w\"> </span><span class=\"n\">myConfig</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"c1\">-- 7</span>\n</code></pre></div>\n<p>Although not sure if with a bit of metaprogramming the above boilerplate could be reduced</p>",
        "id": 451419143,
        "sender_full_name": "Luis Enrique Muñoz Martín",
        "timestamp": 1721024425
    }
]