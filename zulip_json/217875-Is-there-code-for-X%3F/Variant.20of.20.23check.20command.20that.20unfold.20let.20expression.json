[
    {
        "content": "<p>I ask this out of curiosity, but would it be possible to create a variant of the #check command that would expand let expressions?</p>\n<p>For example, <code>#check (let x := 1; x)</code> does not show up as <code>1 : Nat</code>, but could it be made to show up as <code>1 : Nat</code>?</p>",
        "id": 504405271,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1741535195
    },
    {
        "content": "<p>yes</p>",
        "id": 504405364,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741535278
    },
    {
        "content": "<p>How can I implement this?</p>",
        "id": 504405417,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1741535301
    },
    {
        "content": "<p>write a wrapper for <code>#check</code> that zeta-reduces its argument first</p>",
        "id": 504405573,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741535422
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">:</span><span class=\"s2\">\"#checkz\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- copied from the `#check` command</span>\n<span class=\"w\">  </span><span class=\"n\">withoutModifyingEnv</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">runTermElabM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withDeclName</span><span class=\"w\"> </span><span class=\"ss\">`_check</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">zetaReduce</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"n\">synthesizeSyntheticMVarsNoPostponing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ignoreStuckTC</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Users might be testing out buggy elaborators. Let's typecheck before proceeding:</span>\n<span class=\"w\">  </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">levelMVarToParam</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">isSyntheticSorry</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{e} : {type}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">checkz</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>",
        "id": 504406246,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741535947
    },
    {
        "content": "<p>There is also <code>#simp</code> that can be useful in similar situations.</p>",
        "id": 504417689,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741544394
    },
    {
        "content": "<p>Or you could use <code>letI</code> here</p>",
        "id": 504436562,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741557899
    },
    {
        "content": "<p>Thank you!!</p>",
        "id": 504440458,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1741560995
    }
]