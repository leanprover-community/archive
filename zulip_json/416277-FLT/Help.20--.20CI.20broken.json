[
    {
        "content": "<p>Currently we have an error \"Error: Failed to CreateArtifact: Received non-retryable error: Failed request: (409) Conflict: an artifact with this name already exists on the workflow run\" in the second \"upload docs and blueprint artifact\" thingy (why are there two)?</p>\n<p><a href=\"/user_uploads/3121/45EVNFml3XEDmbWb0UPw-GfS/Screenshot-from-2024-08-04-11-05-00.png\">Screenshot-from-2024-08-04-11-05-00.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/45EVNFml3XEDmbWb0UPw-GfS/Screenshot-from-2024-08-04-11-05-00.png\" title=\"Screenshot-from-2024-08-04-11-05-00.png\"><img data-original-dimensions=\"1425x642\" src=\"/user_uploads/thumbnail/3121/45EVNFml3XEDmbWb0UPw-GfS/Screenshot-from-2024-08-04-11-05-00.png/840x560.webp\"></a></div><p>Anyone know what's going on?</p>",
        "id": 456296570,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722766024
    },
    {
        "content": "<p>You have a duplicated CI step. Do you see what I mean or should I open a PR?</p>",
        "id": 456296860,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1722766137
    },
    {
        "content": "<p>Please feel free to open a PR, I don't even know where CI is stored</p>",
        "id": 456296990,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722766164
    },
    {
        "content": "<p>CI is stored in the <code>.github</code> folder. Here are the relevant lines: <a href=\"https://github.com/ImperialCollegeLondon/FLT/blame/main/.github/workflows/push.yml#L103-L111\">https://github.com/ImperialCollegeLondon/FLT/blame/main/.github/workflows/push.yml#L103-L111</a></p>",
        "id": 456297224,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1722766244
    },
    {
        "content": "<p><del>flt#117</del> <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/117\">https://github.com/ImperialCollegeLondon/FLT/pull/117</a></p>",
        "id": 456297787,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1722766396
    },
    {
        "content": "<p>Whoops, wrong linkifier. Maybe someone here can fix it?</p>",
        "id": 456297933,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1722766432
    },
    {
        "content": "<p>Ok I now know where the CI instructions are stored -- thanks! The step isn't duplicated, one says <code>path: docs/</code> and the other says <code>path: docs/_site</code>. Why did you choose to delete the one you chose?</p>",
        "id": 456300800,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722767359
    },
    {
        "content": "<p>Only one of them is used. I kept the <code>docs/_site</code> one since it's the one that my projects use and they work <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span></p>",
        "id": 456301122,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1722767452
    },
    {
        "content": "<p>Linkifier is <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/117\">FLT#117</a></p>",
        "id": 456303841,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1722768343
    },
    {
        "content": "<p>The <code>docs/_site</code> means that the action is going to clone the repo to <code>docs/_site</code>.  I wonder whether having chosen this path will affect the later step that does <code>mv docs/docs .lake/build/doc</code>.  If CI fails, then maybe this one should change to <code>mv docs/_stye/docs .lake/build/doc</code>.</p>",
        "id": 456304054,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722768441
    },
    {
        "content": "<p>Anyway, working on CI is really like driving a car blindfolded: the implications of each step are really mysterious.</p>",
        "id": 456304347,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722768583
    },
    {
        "content": "<p>So the workflow is \"push something and see if it works\" rather than \"test to see if it works and then push\"?</p>",
        "id": 456305182,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722769057
    },
    {
        "content": "<p>Testing locally is always a good idea, but CI has a different set of rules, so not everything that works locally works in CI as is.</p>",
        "id": 456305647,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722769314
    },
    {
        "content": "<p>Usually, if you can make every step report some message it is <em>very</em> useful for debugging.</p>",
        "id": 456305709,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722769333
    },
    {
        "content": "<p>In this case, it worked, so everything is good!</p>",
        "id": 456305726,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722769344
    },
    {
        "content": "<p>But, for instance, when you ask to download your repo, unless you explicitly mention that you want to download <em>all</em> the repo, it just does a shallow clone, which means that you only get the current branch and no history.</p>",
        "id": 456305788,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722769389
    },
    {
        "content": "<p>So, maybe a better description is: if you know how to replicate <em>exactly</em> the steps that you run locally, then you are good!  But knowing that is very hard, at least for me.</p>",
        "id": 456305860,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722769438
    },
    {
        "content": "<p>How do you test locally? I'm on Ubuntu</p>",
        "id": 456330296,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722781238
    },
    {
        "content": "<p>You run the commands one at a time and see whether they have the required effects.  Some are \"actions\" so you should know what those are supposed to do.</p>",
        "id": 456330670,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781321
    },
    {
        "content": "<p>For instance,</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"nt\">jobs</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">style_lint</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Lint style</span>\n<span class=\"w\">    </span><span class=\"nt\">runs-on</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">ubuntu-latest</span>\n<span class=\"w\">    </span><span class=\"nt\">steps</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"nt\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Check for long lines</span>\n<span class=\"w\">        </span><span class=\"nt\">if</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">always()</span>\n<span class=\"w\">        </span><span class=\"nt\">run</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">|</span>\n<span class=\"w\">          </span><span class=\"no\">! (find FLT -name \"*.lean\" -type f -exec grep -E -H -n '^.{101,}$' {} \\; | grep -v -E 'https?://')</span>\n\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"nt\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Don't 'import Mathlib', use precise imports</span>\n<span class=\"w\">        </span><span class=\"nt\">if</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">always()</span>\n<span class=\"w\">        </span><span class=\"nt\">run</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">|</span>\n<span class=\"w\">          </span><span class=\"no\">! (find FLT -name \"*.lean\" -type f -print0 | xargs -0 grep -E -n '^import Mathlib$')</span>\n</code></pre></div>",
        "id": 456330847,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781376
    },
    {
        "content": "<p>is instructing the remote machine to run on <code>ubuntu-latest</code> the following <code>steps</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>!<span class=\"w\"> </span><span class=\"o\">(</span>find<span class=\"w\"> </span>FLT<span class=\"w\"> </span>-name<span class=\"w\"> </span><span class=\"s2\">\"*.lean\"</span><span class=\"w\"> </span>-type<span class=\"w\"> </span>f<span class=\"w\"> </span>-exec<span class=\"w\"> </span>grep<span class=\"w\"> </span>-E<span class=\"w\"> </span>-H<span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"s1\">'^.{101,}$'</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"se\">\\;</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>-v<span class=\"w\"> </span>-E<span class=\"w\"> </span><span class=\"s1\">'https?://'</span><span class=\"o\">)</span>\n!<span class=\"w\"> </span><span class=\"o\">(</span>find<span class=\"w\"> </span>FLT<span class=\"w\"> </span>-name<span class=\"w\"> </span><span class=\"s2\">\"*.lean\"</span><span class=\"w\"> </span>-type<span class=\"w\"> </span>f<span class=\"w\"> </span>-print0<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>xargs<span class=\"w\"> </span>-0<span class=\"w\"> </span>grep<span class=\"w\"> </span>-E<span class=\"w\"> </span>-n<span class=\"w\"> </span><span class=\"s1\">'^import Mathlib$'</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 456330906,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781419
    },
    {
        "content": "<p>the rest is intended mostly as a comment to both you and the computer to try to make sense of what is going on.</p>",
        "id": 456330962,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781442
    },
    {
        "content": "<p>So, likely, the first command is going to test for long lines (and you can see that there is <code>grep .{101}</code> somewhere in there and the second one is checking something about imports (and you can see that it is looking for lines that match exactly <code>import Mathlib</code>).</p>",
        "id": 456331126,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781508
    },
    {
        "content": "<p>However, the next step is</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"w\">  </span><span class=\"nt\">build_project</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">runs-on</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">ubuntu-latest</span>\n<span class=\"w\">    </span><span class=\"nt\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Build project</span>\n<span class=\"w\">    </span><span class=\"nt\">steps</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"nt\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Checkout project</span>\n<span class=\"w\">        </span><span class=\"nt\">uses</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">actions/checkout@v4</span>\n<span class=\"w\">        </span><span class=\"nt\">with</span><span class=\"p\">:</span>\n<span class=\"w\">          </span><span class=\"nt\">fetch-depth</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">0</span>\n</code></pre></div>\n<p>and this is an \"action\" (<code>actions/checkout@v4</code>): this is a bundled set of commands that in this case is downloading the whole repository (so this you cannot really test locally).</p>",
        "id": 456331224,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781586
    },
    {
        "content": "<p>The main takeaway is that <em>every</em> command that you issue has lots of \"implicit\" assumptions that depend on exactly what system you are using, in which timezone the command is run, what sorting convention you have for strings, and so on.</p>",
        "id": 456331493,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781729
    },
    {
        "content": "<p>So, basically, you are writing commands on <em>your</em> computer that are supposed to work on a <em>generic</em> other computer.</p>",
        "id": 456331570,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781751
    },
    {
        "content": "<p>That is why, sorting order, timezones, case-sensitivity, special characters in files are all quite problematic for CI and I think that every one of them has caused a CI failure at some point in mathlib in the last month or so.</p>",
        "id": 456331834,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722781815
    },
    {
        "content": "<p>Short version: setting up CI is a nightmare.</p>",
        "id": 456371791,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1722796849
    },
    {
        "content": "<p>nektos/act is a nice way to model GitHub runners and workflows locally</p>",
        "id": 456374395,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1722797977
    },
    {
        "content": "<p>(deleted -- hopefully solved)</p>",
        "id": 465211854,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1724684576
    },
    {
        "content": "<p>CI is broken again</p>",
        "id": 468755524,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725879686
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/416277-FLT/topic/Help.20--.20CI.20broken/near/468755524\">said</a>:</p>\n<blockquote>\n<p>CI is broken again</p>\n</blockquote>\n<p><a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/124\">FLT#124</a></p>",
        "id": 468761460,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1725881216
    },
    {
        "content": "<p>Thanks. I'm travelling and I don't seem to have a way of detecting this. Is there a way of getting a notification when I just blindly push to master (as I do a lot) and then CI breaks? Come October when I'm taking all of this very seriously I'm hoping to do better.</p>",
        "id": 468762972,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725881556
    },
    {
        "content": "<p>That's not exactly what you are asking, but one thing you can do is protect your main/master branch (in Settings/Branches) by setting \"Require a pull request before merging\". Then as the owner of the repo you can still push to master, but you'll see a big warning in your terminal that you are overruling the branch protection.<br>\nIt won't tell you when you broke master, but it will remind you that you should not push to master and should instead work on a branch and open a PR.</p>",
        "id": 468766003,
        "sender_full_name": "Rémy Degenne",
        "timestamp": 1725882315
    },
    {
        "content": "<p>I think this can work:<br>\n<a href=\"/user_uploads/3121/g3Jyloz_LcYc4LIu_zSB7GV0/Screenshot-from-2024-09-09-13-46-15.png\">Screenshot-from-2024-09-09-13-46-15.png</a><br>\nat <a href=\"https://github.com/settings/notifications\">https://github.com/settings/notifications</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/g3Jyloz_LcYc4LIu_zSB7GV0/Screenshot-from-2024-09-09-13-46-15.png\" title=\"Screenshot-from-2024-09-09-13-46-15.png\"><img data-original-dimensions=\"1243x216\" src=\"/user_uploads/thumbnail/3121/g3Jyloz_LcYc4LIu_zSB7GV0/Screenshot-from-2024-09-09-13-46-15.png/840x560.webp\"></a></div><p>But then you need to filter out the ones about FLT in your email client</p>",
        "id": 468766558,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1725882434
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>, I think you better get used to not pushing to master. :-) This is what CI is for. If you push to master directly without waiting for a CI, every time you break it you prevent everyone else from working on the project.</p>",
        "id": 468809450,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725890635
    },
    {
        "content": "<p>(And if you're really going to get FLT \"done\", you're not going to have time to push to anything except the blueprint. :-)</p>",
        "id": 468809635,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725890674
    },
    {
        "content": "<p>My two cents: I push to master on LeanAPAP and PFR, but I always run <code>lake exe mk_all; lake build</code> beforehand</p>",
        "id": 468810855,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1725890958
    },
    {
        "content": "<p>OK I'll switch to always PRing. Thanks! I have no idea what I'm doing but am keen to learn.</p>",
        "id": 468863575,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725901483
    },
    {
        "content": "<p>OK I give up. CI is broken and I just spent about an hour trying to fix it. <span class=\"user-mention\" data-user-id=\"556875\">@Pietro Monticone</span> your PR <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/120\">here</a> deleted a bunch of stuff from <code>lake-manifest.json</code> -- was this intentional? I've tried to put it back; this may or may not be what's causing the CI issues.</p>",
        "id": 468918604,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725916775
    },
    {
        "content": "<p>This should fix it <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/129\">https://github.com/ImperialCollegeLondon/FLT/pull/129</a>. </p>\n<p>I run the usual: </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>curl<span class=\"w\"> </span>-L<span class=\"w\"> </span>https://raw.githubusercontent.com/leanprover-community/mathlib4/master/lean-toolchain<span class=\"w\"> </span>-o<span class=\"w\"> </span>lean-toolchain\nlake<span class=\"w\"> </span>-Kenv<span class=\"o\">=</span>dev<span class=\"w\"> </span>update\nlake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get\n</code></pre></div>\n<p>But that didn't update <code>doc-gen4</code> and dependencies. Now I have run: </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>lake<span class=\"w\"> </span>-R<span class=\"w\"> </span>-Kenv<span class=\"o\">=</span>dev<span class=\"w\"> </span>update<span class=\"w\"> </span>«doc-gen4»\n</code></pre></div>\n<p>and it updated correctly.</p>",
        "id": 468921005,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1725917608
    },
    {
        "content": "<p>It didn't just not update doc-gen4, it deleted it from the manifest! Presumably this is the same phenomenon as <a href=\"#narrow/stream/270676-lean4/topic/checkdecl.20update.20surprise/near/437300239\">this</a> ?</p>",
        "id": 468923272,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725918458
    },
    {
        "content": "<p>I tend to believe so too.</p>",
        "id": 468923711,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1725918625
    },
    {
        "content": "<p>I have just tested it locally, and the documentation builds without issues.</p>",
        "id": 468925741,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1725919389
    },
    {
        "content": "<p>Yeah things are looking promising on github too :-) Thanks!</p>",
        "id": 468927082,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725919934
    }
]