[
    {
        "content": "<p>I'm getting an odd lake warning I haven't seen before:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">manifest</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">date</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">revision</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">dependency</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">mathlib'</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`lake</span><span class=\"w\"> </span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">it</span>\n</code></pre></div>",
        "id": 517842457,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747145595
    },
    {
        "content": "<p>Doesn't seem to actually get in the way of anything</p>",
        "id": 517842514,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747145608
    },
    {
        "content": "<p>This is because <code>lean-toolchain</code> in FLT doesn't agree with the <code>lean-toolchain</code>of the version of mathlib that <code>lake update mathlib</code> would bump FLT to</p>",
        "id": 517857562,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747149076
    },
    {
        "content": "<p>The only way I know to get rid of it is to keep the <code>rev = v4.19.0</code> line in the lakefile, rather than removing it once the bump is done locally</p>",
        "id": 517857745,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747149118
    },
    {
        "content": "<p>Really? Everything seems to be on leanprover/lean4:v4.20.0-rc5</p>",
        "id": 517863060,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747150453
    },
    {
        "content": "<p>Yes I specifically bumped FLT to 20-rc5 in an attempt to get rid of this warning (and it didn't).</p>",
        "id": 517865926,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747151243
    },
    {
        "content": "<p>Hmm then I am confused. Maybe lake now expects us to pin the commit too? As in <code>rev = commithash</code></p>",
        "id": 517865954,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747151248
    },
    {
        "content": "<p>I'm sorry I'm so clueless about these things (I guess I'm picking stuff up as I go). Variables I don't understand are <code>\"inputRev\"</code> in <code>lake-manifest.json</code> (am I supposed to edit this manually?) and the various incantations that one can add to the <code>lakefile.toml</code> e.g. <code>rev</code> (not to be confused with <code>\"rev\"</code> in the json)</p>",
        "id": 517867810,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747151710
    },
    {
        "content": "<p>If I <code>lake update mathlib</code> then the diff in the json is</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">-   \"rev\": \"4e685d14db58b1ab29024bb0761902a3615f3f14\",</span>\n<span class=\"gi\">+   \"rev\": \"33308ffdc0dc62f1437e76c5ce0857f52b7b3bfa\",</span>\n<span class=\"w\"> </span>   \"name\": \"mathlib\",\n<span class=\"w\"> </span>   \"manifestFile\": \"lake-manifest.json\",\n<span class=\"gd\">-   \"inputRev\": \"v4.20.0-rc5\",</span>\n<span class=\"gi\">+   \"inputRev\": null,</span>\n</code></pre></div>\n<p>and the warning goes away (at least for now -- will it come back again if a PR to mathlib is merged?)</p>",
        "id": 517868244,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747151838
    },
    {
        "content": "<p>Oh, did someone put inputRev in the lake manifest without putting it in the toml? That sounds plausible</p>",
        "id": 517869905,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747152240
    },
    {
        "content": "<p>Aah yes, we did do that. </p>\n<p>So lemme get this straight. Are there two kinds of bumps?</p>\n<p>1) mathlib does a lean version bump to lean v4.37; we then can, if we want, (and we should, esp if it's stable), choose to bump to the commit of mathlib tagged lean-v4.37, tag this FLT commit lean-4v.37 ourselves, so we're making an implicit promise that we're 100% compatible with everything else tagged lean-4v.37, and in this situation we add inputrev: \"v4.37\" to the json and also rev = [mathlib commit number for tag v4.37] in the toml</p>\n<p>2) mathlib merges a theorem I want so I just decide to bump of my own accord, then I delete the rev from the toml if it's there, and make sure it says <code>\"inputrev\": null</code> in the json?</p>",
        "id": 517871121,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747152571
    },
    {
        "content": "<p>What I've been doing for (1) is to add <code>rev = \"v4.17.0\"</code> to the toml, but then not commit that, and also not commit the change from <code>null</code> to <code>\"v4.17.0\"</code> in the json - but it's easy to miss that</p>",
        "id": 517880199,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747155149
    },
    {
        "content": "<p>Do you mean \"what I've been doing for (2) is...\"?</p>",
        "id": 517892906,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747159443
    },
    {
        "content": "<p>No, for the bump to stable, so I end up on the v4.X.0 commit without leaving a reference to the tag in the toml</p>",
        "id": 517898661,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747161468
    },
    {
        "content": "<p>Oh so there are different systems for bump to stable and bump to rc?? Or do you mean \"bump to mathlib lean-toolchain change\" in general?</p>",
        "id": 517914845,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747167149
    },
    {
        "content": "<p>I'm confused why anyone is touching <code>inputRev</code>.</p>\n<p>Just set the <code>rev</code> field in the <code>toml</code> to <code>v4.20.0-rc5</code> (notice no \"lean\" prefix, <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>), then run <code>lake update</code> (which will hopefully change your <code>lean-toolchain</code> to the toolchain Mathlib is using, or do this manually if that doesn't happen).</p>",
        "id": 517930418,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747173555
    },
    {
        "content": "<p>The thing is - if you leave the <code>rev</code> key in the toml, then you need to remove it again to update mathlib to latest master (notably if you have automation to bump for you). So I add it when updating to a stable tag, but I don't commit that change, and leave inputRev as null</p>",
        "id": 517931358,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747173948
    },
    {
        "content": "<p>I am still unclear about whether there are two different algorithms for the two different kinds of bumps which I am half-convinced exist: bumps because I want a mathlib commit and bumps because reservoir or whatever wants a tagged commit saying \"guaranteed to work with the v4.37 tag of mathlib\".</p>",
        "id": 517931855,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747174163
    },
    {
        "content": "<p>For the stable bump, you want to get the exact tagged revision of mathlib, so that acts as a synchronisation point for the ecosystem</p>",
        "id": 517932563,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747174548
    },
    {
        "content": "<p>It's not really clear to me that there is practical value in having everyone synchronize exactly. I think merely tagging the first commit of FLT when it was on the v4.X.Y toolchain would suffice.</p>\n<p>Later we will have better automatic methods to do things like this, for now make your life easy!</p>",
        "id": 517932750,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747174655
    },
    {
        "content": "<p>Hm, I don't see the point in synchronising if you don't do it exactly</p>",
        "id": 517973504,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747200652
    },
    {
        "content": "<p>Is there anyone depending on FLT + another downstream-of-Mathlib project? Hopefully there will be one day, but let's not make Kevin's life harder than it needs to be in the meantime.</p>",
        "id": 517980765,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747204408
    },
    {
        "content": "<p>Kim, I don't understand what you are saying. <code>inputRev</code> is touched <em>for us</em> by <code>lake update mathlib</code>, and this is what's causing the warnings</p>",
        "id": 517980994,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747204510
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/416277-FLT/topic/manifest.20out.20of.20date/near/517980765\">said</a>:</p>\n<blockquote>\n<p>Is there anyone depending on FLT + another downstream-of-Mathlib project? Hopefully there will be one day, but let's not make Kevin's life harder than it needs to be in the meantime.</p>\n</blockquote>\n<p>I wouldn't be surprised if that's the case, actually. A lot of AI companies are trying to automatically fill in sorries from various various projects in the ecosystem</p>",
        "id": 517981376,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747204675
    },
    {
        "content": "<p>There's a bit of a chicken and egg too - if there's no compatible revisions, it's going to be hard to create such a project</p>",
        "id": 517986069,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1747206471
    },
    {
        "content": "<p>I'm confused because I have never even noticed an <code>inputRev</code> field, because <code>lake-manifest.json</code> is not for human consumption. Never edit it by hand, never even read it! If there's a conflict nuke it and regenerate, and if that's not working ... <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a>.</p>",
        "id": 517987823,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747207088
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/416277-FLT/topic/manifest.20out.20of.20date/near/517986069\">said</a>:</p>\n<blockquote>\n<p>There's a bit of a chicken and egg too - if there's no compatible revisions, it's going to be hard to create such a project</p>\n</blockquote>\n<p>Agreed. Just make sure whatever workflows you set up here are not occupying Kevin's time when he's mean to be creating sorries for people. :-)</p>",
        "id": 517987906,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747207118
    },
    {
        "content": "<p>I am happy to bump often. We have a culture of bumping a lot in FLT because I remember what happened in perfectoid. We're currently on mathlib from 5 days ago. But usually I bump either because (a) I want a specific upstreamed commit which just landed in mathlib or (b) a bot opens an issue such as <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/471\">FLT#471</a> saying \"you might want to consider updating because the naive algorithm just failed\" (typically with errors of the form \"this declaration already exists\"). </p>\n<p>Auto-bumping to a new commit is very quick; the only hold-up is that it takes \"two passes\", one to make the trivial bump PR and then one an hour later once it's passed the interminable CI process which involves building all of the mathlib docs (it could be remarked that I literally never look at those docs or even the FLT docs, and I don't know anyone who does look at them, but they might). Manual bumping must be done manually but I don't mind doing that, I feel like mathlib itself is doing a good job of making sure that core changes aren't catastrophic, and this project is \"more of the same\" at the end of the day.</p>\n<p>Anyway, the bottom line is that right now when I buid mathlib I get a \"manifest out of date\" warning despite having reviewed and merged the bump PR so I made a mistake. Is the mistake \"don't ever have <code>\"inputRev\": \"v4.20.0-rc5\",</code> in <code>lake-manifest.json</code>\"? Right now people have talked a lot on this thread but I still don't really feel I'm any closer to understanding the actual workflow.</p>\n<p>Making a PR right now.</p>",
        "id": 517989375,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747207591
    },
    {
        "content": "<p><a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/496\">FLT#496</a></p>",
        "id": 517990195,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747207856
    },
    {
        "content": "<p>I wasn't able to reproduce this warning:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">warning: manifest out of date: git revision of dependency 'mathlib' changed; use `lake update mathlib` to update it</span>\n</code></pre></div>\n<p>I have just tested the usual workflow in FLT by</p>\n<ol>\n<li>Setting the <code>rev = \"v4.X\"</code> in the <code>lakefile.toml</code> file </li>\n<li>Running <code>lake update</code> and getting the correct <code>\"inputRev\": \"v4.20.0-rc5\"</code> in the <code>lake-manifest.json</code></li>\n<li>Removing the <code>rev = \"v4.X\"</code> in the <code>lakefile.toml</code> file </li>\n<li>Running <code>lake update</code> and getting the correct <code>\"inputRev\": null</code> in the <code>lake-manifest.json</code></li>\n</ol>\n<p>I'm not really sure there is any issue here, but I might have misunderstood something.</p>",
        "id": 518164635,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1747259293
    },
    {
        "content": "<p>I merged <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/497\">FLT#497</a> which fixed the manifest problem. If you go back to a pre-497 commit you should be able to see the warning.</p>",
        "id": 518165091,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747259528
    },
    {
        "content": "<p>For me the usual workflow was \"don't ever touch the toml, just type <code>lake update</code>\"</p>",
        "id": 518165160,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747259574
    },
    {
        "content": "<p>I virtually want back to a pre-497 just by setting the <code>rev = \"v4.20.0-rc5\"</code> in the <code>lakefile.toml</code> file and running <code>lake update</code>, right?</p>",
        "id": 518165203,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1747259602
    },
    {
        "content": "<p>The point is that I've never found necessary to run <code>lake update mathlib</code> so I'm asking if I'm doing something wrong.</p>",
        "id": 518165428,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1747259727
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"556875\">Pietro Monticone</span> <a href=\"#narrow/channel/416277-FLT/topic/manifest.20out.20of.20date/near/518164635\">said</a>:</p>\n<blockquote>\n<p>I have just tested the usual workflow in FLT by</p>\n<ol>\n<li>Setting the <code>rev = \"v4.X\"</code> in the <code>lakefile.toml</code> file</li>\n<li>Running <code>lake update</code> and getting the correct <code>\"inputRev\": \"v4.20.0-rc5\"</code> in the <code>lake-manifest.json</code></li>\n<li>Removing the <code>rev = \"v4.X\"</code> in the <code>lakefile.toml</code> file</li>\n<li>Running <code>lake update</code> and getting the correct <code>\"inputRev\": null</code> in the <code>lake-manifest.json</code></li>\n</ol>\n</blockquote>\n<p>The warning appears <em>before</em> you run step 4. Also I run <code>lake update mathlib</code> instead of <code>lake update</code>, but I doubt that changes anything</p>",
        "id": 518167209,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747260585
    },
    {
        "content": "<p>I didn't know that this was the workflow, when I've bumped because I wanted a commit, I've just typed either <code>lake update</code> or <code>lake update mathlib</code> randomly.</p>",
        "id": 518167523,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747260724
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> It doesn't seem to appear locally...</p>\n<p>EDIT: Ok, now I see it. Sorry.</p>",
        "id": 518167916,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1747260917
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/416277-FLT/topic/manifest.20out.20of.20date/near/518167523\">said</a>:</p>\n<blockquote>\n<p>I didn't know that this was the workflow, when I've bumped because I wanted a commit, I've just typed either <code>lake update</code> or <code>lake update mathlib</code> randomly.</p>\n</blockquote>\n<p>I don't think <code>lake update mathlib</code> is ever needed in this case, but I can't be 100% sure.</p>",
        "id": 518168036,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1747260962
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/416277-FLT/topic/manifest.20out.20of.20date/near/518167523\">said</a>:</p>\n<blockquote>\n<p>I didn't know that this was the workflow, when I've bumped because I wanted a commit, I've just typed either <code>lake update</code> or <code>lake update mathlib</code> randomly.</p>\n</blockquote>\n<p>That is perfectly fine if you know that the toolchain isn't going to change when you run <code>lake update</code> (like in the latest bump <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/497\">FLT#497</a>).</p>",
        "id": 518168458,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1747261176
    },
    {
        "content": "<p>In summary, the workflow should simply be: check whether a new version of <code>lean-toolchain</code> is available;  If <strong>yes</strong> (e.g., <code>v4.X</code>), update the <code>rev</code> field in the <code>lakefile.toml</code> file to <code>rev = \"v4.X\"</code> and run <code>lake update</code>; else remove the <code>rev</code> field in the <code>lakefile.toml</code> file and run <code>lake update</code>.</p>\n<p>The warning </p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">warning: manifest out of date: git revision of dependency 'mathlib' changed; use `lake update mathlib` to update it</span>\n</code></pre></div>\n<p>is exactly what you want in case the <code>lakefile.toml</code> doesn't specify a Mathlib <code>rev</code> (i.e. assuming <code>master</code>, I suppose) and you run <code>lake build</code>.</p>",
        "id": 518169571,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1747261686
    },
    {
        "content": "<p>So what you're saying is that bumps <em>need</em> to update the <code>rev</code> field?</p>",
        "id": 518211154,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1747288156
    },
    {
        "content": "<p>Yes.</p>",
        "id": 518213086,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1747289196
    }
]