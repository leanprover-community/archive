[
    {
        "content": "<p>I just wanted to share an algorithm I just <a href=\"https://github.com/digama0/lean4lean/blob/16cf0150ec225c9fafc737cee6f55d429d48427b/Lean4Lean/Level.lean#L240\">implemented</a> for lean4lean based on a <a href=\"https://lmf.cnrs.fr/downloads/Perso/long.pdf\">paper</a> by <span class=\"user-mention\" data-user-id=\"674647\">@Yoan Géran</span> which gives a complete normalization algorithm for imax expressions. Compared to Yoan's version, my version of the algorithm is able to reify expressions back into <code>Level</code>, rather than staying in the extended \"sublevel\" algebra used in the paper's normal form. Here are some fun equalities it can verify:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean4Lean</span><span class=\"bp\">.</span><span class=\"n\">Level</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"normalize \"</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">level</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">runTermElabM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{(← Elab.Term.elabLevel l).normalize'}\"</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">w</span>\n<span class=\"sd\">/-- info: max 1 u -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"sd\">/-- info: u -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"sd\">/-- info: max 1 (imax (u+1) u) -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"bp\">+</span><span class=\"mi\">1</span>\n<span class=\"sd\">/-- info: imax 2 u -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"sd\">/-- info: max v (imax (imax u v) w) -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"sd\">/-- info: max v (imax (imax u v) w) -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"sd\">/-- info: u -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"sd\">/-- info: max 1 (imax (u+1) u) -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">u</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>cc: <span class=\"user-mention\" data-user-id=\"432410\">@Arthur Adjedj</span> since we talked about this at TYPES</p>",
        "id": 540121994,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758154526
    },
    {
        "content": "<p>amazing but why are those weird <code>max 1 (imax (u+1) u)</code></p>",
        "id": 540124161,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758155986
    },
    {
        "content": "<p>turns out <code>u+1</code> has a funny normal form</p>",
        "id": 540124200,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758156009
    },
    {
        "content": "<p>because it can be split into the max of two things that don't dominate each other, namely <code>1</code> and <code>imax (u+1) u = if u=0 then 0 else u+1</code></p>",
        "id": 540124279,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758156054
    },
    {
        "content": "<p>interesting</p>",
        "id": 540124321,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758156085
    },
    {
        "content": "<p>does it work with metavariables</p>",
        "id": 540124368,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758156118
    },
    {
        "content": "<p>no, but it would not be any different, it would just be another kind of variable</p>",
        "id": 540124408,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758156148
    },
    {
        "content": "<p>unless you want to do unification</p>",
        "id": 540124424,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758156155
    },
    {
        "content": "<p>I guess unification would be hard?</p>",
        "id": 540124447,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758156171
    },
    {
        "content": "<p>it seems ill defined</p>",
        "id": 540124468,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758156186
    },
    {
        "content": "<p>I don't think it's that hard, the normal form is reasonably okay, but you have to decide what you actually want to get in the many ambiguous cases</p>",
        "id": 540124527,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758156230
    },
    {
        "content": "<p>I think \"given a finite set of equations (pairs of universe formulas) with metavariables, find any assignment of metavariables satisfying all the equations or report no solution exists\" could be described as unification</p>",
        "id": 540124850,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758156452
    },
    {
        "content": "<p>That's cool to see it implemented. I had planned to implement the algorithm in C++ for Lean, but couldn't find the time</p>",
        "id": 540186424,
        "sender_full_name": "Yoan Géran",
        "timestamp": 1758187188
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> Do we require the most general unifier (if it exists) or any unifier is good?</p>",
        "id": 540187145,
        "sender_full_name": "Yoan Géran",
        "timestamp": 1758187371
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> interesting! How does it compare to the work by Bezem, Coquand, Sozeau which is being implemented in Rocq ?</p>",
        "id": 540214302,
        "sender_full_name": "Bas Spitters",
        "timestamp": 1758196695
    },
    {
        "content": "<p><a href=\"https://msp.cis.strath.ac.uk/types2025/abstracts/TYPES2025_paper21.pdf\">https://msp.cis.strath.ac.uk/types2025/abstracts/TYPES2025_paper21.pdf</a></p>",
        "id": 540214455,
        "sender_full_name": "Bas Spitters",
        "timestamp": 1758196742
    },
    {
        "content": "<p>I think Rocq's universe algebra is more complicated, but it also doesn't have imax I think</p>",
        "id": 540214544,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758196763
    },
    {
        "content": "<p>the really hard part of this algorithm is dealing with <code>imax</code> expressions</p>",
        "id": 540214760,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1758196824
    },
    {
        "content": "<p>Thanks. Yes, I don't see imax in their work.</p>",
        "id": 540214979,
        "sender_full_name": "Bas Spitters",
        "timestamp": 1758196880
    }
]