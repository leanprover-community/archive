[
    {
        "content": "<p>I have figured out how to use the failure of normalization to encode well-founded recursion that is definitionally equal to its unfolding:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- https://arxiv.org/abs/1911.08174</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âˆ€</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Î´</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Î·</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Î·</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Î·</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Ï‰</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">propext</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">âŸ©</span><span class=\"w\"> </span><span class=\"bp\">â–¸</span><span class=\"w\"> </span><span class=\"n\">Î´</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Î©</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Î´</span><span class=\"w\"> </span><span class=\"n\">Ï‰</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">WellFounded</span><span class=\"bp\">.</span><span class=\"n\">fix'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hwf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WellFounded</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">âˆ€</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">âˆ€</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Acc</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î©</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">âˆ€</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Acc</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">wf</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">wf</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">âŸ©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hwf</span><span class=\"bp\">.</span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">WellFounded</span><span class=\"bp\">.</span><span class=\"n\">fix'_eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">WellFounded</span><span class=\"bp\">.</span><span class=\"n\">fix'</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">hwf</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">hwf</span><span class=\"bp\">.</span><span class=\"n\">fix'</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WellFounded</span><span class=\"bp\">.</span><span class=\"n\">fix'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">LT</span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_wfRel</span><span class=\"bp\">.</span><span class=\"n\">wf</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">â‰¥</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">â‰¥</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>Notably, this implementation does not require reducing the given proof of well-foundedness, since it constructs a new (non-normalizing) proof to use instead.</p>",
        "id": 533615706,
        "sender_full_name": "Parth Shastri",
        "timestamp": 1754793846
    },
    {
        "content": "<p>how do make sure it doesn't run forever</p>",
        "id": 533615844,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754794007
    },
    {
        "content": "<p>that's the well founded part</p>",
        "id": 533635381,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754814909
    },
    {
        "content": "<p>Well, <code>#reduce</code> still runs forever but I suppose <code>whnf</code> gets you to the if statement</p>",
        "id": 533635651,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754815169
    },
    {
        "content": "<blockquote>\n<p><code>#reduce</code> still runs forever</p>\n</blockquote>\n<p>Works fine in practice for me, I guess\"by accident\"</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"c1\">-- 25ms</span>\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">64</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 533657573,
        "sender_full_name": "Albert Smith",
        "timestamp": 1754838571
    },
    {
        "content": "<p>even with <code>(proofs := true)</code>, which blows up the equivalent with <code>Nat.log2</code></p>",
        "id": 533658041,
        "sender_full_name": "Albert Smith",
        "timestamp": 1754839075
    },
    {
        "content": "<p>Neat!</p>\n<p><span class=\"user-mention silent\" data-user-id=\"497571\">Parth Shastri</span> <a href=\"#narrow/channel/236446-Type-theory/topic/Definitional.20well-founded.20recursion/near/533615706\">schrieb</a>:</p>\n<blockquote>\n<p>since it constructs a new (non-normalizing) proof to use instead.</p>\n</blockquote>\n<p>Do these proofs grow in size? (If so, then this wouldnâ€™t quite solve the problem that decision procedures by well-founded recursion are not well-suited for <code>by decide</code>) Or will the proof just always be <code>Î© (âˆ€ x, Acc r x)</code> as the function reduces?</p>",
        "id": 534623309,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1755249507
    },
    {
        "content": "<p>I think they stay small, but I'm not an expert so don't take my word for it. At the very least it plays nice with <code>decide</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sqrt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">â‰¤</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">  </span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_wfRel</span><span class=\"bp\">.</span><span class=\"n\">wf</span><span class=\"bp\">.</span><span class=\"n\">fix'</span>\n<span class=\"w\">      </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">guess</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">guess</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">guess</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">guess</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">h</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">guess</span>\n\n<span class=\"c1\">-- works!!</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sqrt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">10</span><span class=\"bp\">^</span><span class=\"mi\">200</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"bp\">^</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 534663376,
        "sender_full_name": "Albert Smith",
        "timestamp": 1755268404
    },
    {
        "content": "<p>Does that mean we won't need PRs like <a href=\"https://github.com/leanprover-community/mathlib4/pull/24514\">#24514</a>, or will the Lean kernel block such hacks?</p>",
        "id": 534664429,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755268851
    },
    {
        "content": "<p>I tried some manual reduction and the proofs don't seems to be getting bigger</p>",
        "id": 534667056,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755269917
    },
    {
        "content": "<p>I did encounter some deep recursion in the kernel though</p>",
        "id": 534667085,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755269930
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> <a href=\"#narrow/channel/236446-Type-theory/topic/Definitional.20well-founded.20recursion/near/534623309\">said</a>:</p>\n<blockquote>\n<p>Do these proofs grow in size?</p>\n</blockquote>\n<p>No, and this fact is actually an important part of why the defeq succeeds. My initial attempt at achieving definitional well-founded recursion was to replace <code>Acc.rec</code> directly, like so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Acc</span><span class=\"bp\">.</span><span class=\"n\">rec'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">type_of</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Acc</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Acc</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î©</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">âˆ€</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Acc</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Acc</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">ryx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"n\">ryx</span><span class=\"o\">)</span><span class=\"bp\">âŸ©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Acc</span><span class=\"bp\">.</span><span class=\"n\">rec'_eq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Acc</span><span class=\"bp\">.</span><span class=\"n\">rec'</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">ryx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Acc</span><span class=\"bp\">.</span><span class=\"n\">rec'</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"n\">ryx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Acc</span><span class=\"bp\">.</span><span class=\"n\">rec'</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">LT</span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">â‰¥</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_wfRel</span><span class=\"bp\">.</span><span class=\"n\">wf</span><span class=\"bp\">.</span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- 64</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">â‰¥</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- error: maximum recursion depth has been reached</span>\n</code></pre></div>\n<p>With this approach, the proof term gets bigger. However, this doesn't seem to cause any problems for <code>decide</code>, as the reduction performance is not that much slower (<a href=\"https://live.lean-lang.org/#codez=CYUwZgBAKhBcEAUBOB7ADnAvBQAEQTQDQQAUGgSYT4CUEF5+AUKJIC3AJAXnNNfDLNmAFcAdvgiB24AgALCJgB849iRgUo1AJbAIGiBwwTJlRuAiBJ4E69+wiAH0bUmfLSo0IAB4AXCIAvyQSNtypIl87AI1AS/IIQA7SCGYjSEBK4HMsGNN6eiEUIQBjFABbNAF3AEMAIwAbEAgmCABBLKyAOiQQLIByTncATxdrFDAAUggAATrG5saAbwFrAEYiAQBfZKHgwEbgCCQIXJR3NQA3SrUhd1QIV3s5eghh0aaWiHXN7d2DrWPT8+JE4jxXIlGNmcaLV6oDXNRiME1NJztIAl4/hBgp0Np1zqFpCjiJIGkc9qjwWEIcFbHD5AYgQY0hlsnkCsVypVqmUUABzABMJBE8AAckV3NwIHzPHwrjd6nc2kL+RAADJQBplTyQqy2fzyYXEqx+CAsjkOLSQaTwESAUyIIJz3JIQCI9ZziCIAPQWiElFF5ECsorUADUEBmEBAZQAzpUAAzUETEYWK9zWADuYAASkGGomGkU0GgyiihIZ6KG4+hdpktkVXCmsgAREBoK3+gBsABYwwBWN70ADEu1yIC7zWAAiylTtJAbrdbAGYGwA9dmthv5mk5fKFUoVKrGADqQbKADEUMJQMAGmA1K52hN1vAAMooJCeRYQCabeDrCjvxDOJbYxOcHdlPuh5CMeGzUBMADCnCfneD4QHsP57pwvxED8ECdEQmwoucFBQZ01C4Wc1DnPAUEkZgYojBK4wPICKoiOc6oQGRWoMSE8hIeCQJfCQKEglkYKsRAf7ovICJBFYKJMX+nRElI6aZtm2FLpkK70uuTLGHa7S8jKFDClgYoAUBR4gCeZ4XiQr7YPKsbUDGSoJsmqZ/sEtpspyoRGpwZoWhAVo2rqHlchAzrsq67q9l6vr+oGIbhmkha9HWailrk5aVjWdbSDMzZth23ZqL2/ZmUOI4ee0xDjlOs7zou9BAA\">Benchmark</a>).<br>\nThe actual problem with this approach is that defeq checking runs forever for well-founded definitions like <code>log2</code> (both the elaborator and the kernel loop). The underlying issue is that <code>(Nat.lt_wfRel.wf.apply n).inv (h : m &lt; n)</code> and <code>Nat.lt_wfRel.wf.apply m</code> are definitionally equal by proof irrelevance, but they are not syntactically equal, and the defeq algorithm will reduce the <code>Acc.rec</code> application indefinitely. <code>WellFounded.fix'</code> avoids this issue because the proofs do not grow in size and the defeq check terminates because the two sides become syntactically equal.</p>",
        "id": 534774683,
        "sender_full_name": "Parth Shastri",
        "timestamp": 1755364675
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Is the algorithmic definitional equality from <a href=\"https://github.com/digama0/lean-type-theory/releases/tag/v1.0\">#leantt</a> actually decidable? It seems to me that <code>fix'_eq</code> holds definitionally according to the algorithmic definitional equality rules, which allows the same undecidability proof from <a href=\"https://github.com/digama0/lean-type-theory/releases/tag/v1.0\">#leantt</a> to apply. If it is in fact undecidable, is there any other theoretical reason to prefer it over the ideal definitional equality?</p>",
        "id": 535433095,
        "sender_full_name": "Parth Shastri",
        "timestamp": 1755754827
    },
    {
        "content": "<p>Well it can run forever on this</p>",
        "id": 535472664,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755771523
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"497571\">Parth Shastri</span> <a href=\"#narrow/channel/236446-Type-theory/topic/Definitional.20well-founded.20recursion/near/535433095\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> Is the algorithmic definitional equality from <a href=\"https://github.com/digama0/lean-type-theory/releases/tag/v1.0\">#leantt</a> actually decidable? It seems to me that <code>fix'_eq</code> holds definitionally according to the algorithmic definitional equality rules, which allows the same undecidability proof from <a href=\"https://github.com/digama0/lean-type-theory/releases/tag/v1.0\">#leantt</a> to apply. If it is in fact undecidable, is there any other theoretical reason to prefer it over the ideal definitional equality?</p>\n</blockquote>\n<p>I don't think it is decidable. (Note that this paper was written before the Abel-Coquand counterexample.) However, I think it is still possible to have a relation which is decidable and whose transitive closure is ideal defeq. You should never reduce proof terms, but you still reduce Acc.rec applied directly to Acc.intro. Unfolding would proceed by a transitivity chain of defeq replacements using proof irrelevance and reductions until the next step.</p>",
        "id": 535478143,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1755773592
    },
    {
        "content": "<p>why is the code above noncomputable?</p>",
        "id": 535478578,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755773734
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/236446-Type-theory/topic/Definitional.20well-founded.20recursion/near/535478143\">said</a>:</p>\n<blockquote>\n<p>You should never reduce proof terms, but you still reduce Acc.rec applied directly to Acc.intro. Unfolding would proceed by a transitivity chain of defeq replacements using proof irrelevance and reductions until the next step.</p>\n</blockquote>\n<p>If we would sacrifice kernel reducibility of WF recursion anyways, why not go all the way and make the (ideal) definitional equality decidable by removing large elimination from <code>Acc</code>?</p>",
        "id": 535532177,
        "sender_full_name": "Parth Shastri",
        "timestamp": 1755791145
    },
    {
        "content": "<p>that would require huge code changes</p>",
        "id": 535532361,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1755791202
    },
    {
        "content": "<p>what I'm talking about is a change to the theory that impacts no users</p>",
        "id": 535532396,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1755791216
    },
    {
        "content": "<p>There is a difference between WF recursion not being provable by the kernel and WF recursion not even being true in theory</p>",
        "id": 535532574,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1755791268
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/236446-Type-theory/topic/Definitional.20well-founded.20recursion/near/535532361\">schrieb</a>:</p>\n<blockquote>\n<p>that would require huge code changes</p>\n</blockquote>\n<p>Would it? Assuming in practice already all users of well-founded recursion donâ€™t rely on any defeqs, then making <code>fix_eq</code> an axiom should be rather smooth? (I thought you even suggested that once?)</p>\n<p>Or are you thinking of manual uses of <code>Acc</code> independent of wfrec?</p>",
        "id": 535533636,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1755791585
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/opaque.20recursion.20definitions.20break.20mergeSort.20decidability/near/512143634\">#lean4 &gt; opaque recursion definitions break mergeSort decidability @ ðŸ’¬</a></p>",
        "id": 535543074,
        "sender_full_name": "Parth Shastri",
        "timestamp": 1755794996
    },
    {
        "content": "<p>well in any case it's for me a separate question from what should be documented in the paper. I want to document lean as it exists, and we can also talk about changing lean and the document will change to match if/when this becomes a clear plan of action</p>",
        "id": 535543551,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1755795229
    }
]