[
    {
        "content": "<p>When running <code>lake exe cache get</code>, I see something like</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Downloaded: 2 file(s) [attempted 2/2 = 100%, 193 KB/s]\nDecompressing 7394 file(s)\n</code></pre></div>\n<p>Why does it always decompress <em>all</em> files, even though it only downloaded a few of them? The others should already be present in their uncompressed form, I would assume, and so it should only be necessary to decompress the files that were actually downloaded.</p>",
        "id": 547150311,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1761502926
    },
    {
        "content": "<p>It is definitely always true that if you don't have to download a file, then the decompressed version is already in your lakefile. You might have downloaded that compressed file for a different project.</p>\n<p>If it is significantly cheaper to check whether the correct decompressed version is already there than it is to decompress a file, then we could consider doing that.</p>",
        "id": 547166810,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1761520518
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/536994-ecosystem-infrastructure/topic/lake.20exe.20cache.20get.20always.20decompresses/near/547166810\">said</a>:</p>\n<blockquote>\n<p>If it is significantly cheaper to check whether the correct decompressed version is already there than it is to decompress a file, then we could consider doing that.</p>\n</blockquote>\n<p>Is this being looked at currently? Just now:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>&gt; lake exe cache get\nCurrent branch: MS_Heights_3\nUsing cache (Azure) from origin: MichaelStollBayreuth/mathlib4\nAttempting to download 3 file(s) from leanprover-community/mathlib4 cache\nDownloaded: 0 file(s) [attempted 3/3 = 100%, 0 KB/s]\nAttempting to download 3 file(s) from MichaelStollBayreuth/mathlib4 cache\nDownloaded: 3 file(s) [attempted 3/3 = 100%, 300 KB/s]\nDecompressing 7910 file(s)\nUnpacked in 32499 ms\nCompleted successfully!\n</code></pre></div>\n<p>It is a bit annoying that after downloading three files, it still spends half a minute decompressing lots of files that are already present in decompressed form...</p>",
        "id": 571189247,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1769859470
    },
    {
        "content": "<p>One of my machines has a slow filesystem and it can take over 2 minutes to unpack 7000 files.</p>",
        "id": 571189956,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1769860196
    },
    {
        "content": "<p>You might be interested in </p>\n<blockquote>\n<p>feat: pipeline downloads and decompression inÂ <code>cache get</code>Â <a href=\"https://github.com/leanprover-community/mathlib4/pull/32987\">#32987</a></p>\n</blockquote>\n<p>which has been waiting for review for a few weeks.</p>",
        "id": 571253020,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769918778
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/536994-ecosystem-infrastructure/topic/lake.20exe.20cache.20get.20always.20decompresses/near/571189247\">said</a>:</p>\n<blockquote>\n<p>It is a bit annoying that after downloading three files, it still spends half a minute decompressing lots of files that are already present in decompressed form...</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/34667\">#34667</a> tries to address this, and seems to be much faster on my machine. I'm a bit surprised this is worth doing, as leantar is apparently filtering as well, and I would expect it to be fast.</p>\n<p>Could someone take a look, <span class=\"user-mention\" data-user-id=\"479359\">@Michael Stoll</span> or <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>, with this PR, and see if it is faster for you too?</p>",
        "id": 571257495,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769923352
    },
    {
        "content": "<p>It does seem to improve matters:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>$ gh pr checkout 34667\n(...)\n$ lake exe cache get\nCurrent branch: skip-already-unpacked-cache\nUsing cache (Azure) from git@github.com:kim-em/mathlib4.git: kim-em/mathlib4\nAttempting to download 5174 file(s) from leanprover-community/mathlib4 cache\nDownloaded: 5174 file(s) [attempted 5174/5174 = 100%, 254 KB/s]\nNo files to download\nDecompressing 5217 file(s) (2698 already unpacked)\nUnpacked in 13255 ms\nCompleted successfully!\n</code></pre></div>\n<p>(I guess the <code>No files to download</code> refers to <del>Kim's fork</del> the Mathlib repo(?), which didn't have to provide files in this case.)</p>",
        "id": 571271055,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1769937607
    },
    {
        "content": "<p>I seem to remember that somebody (<span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> ? Yes: <a href=\"#narrow/channel/287929-mathlib4/topic/.60lake.20exe.20cache.20get.60.20decompressing.20as.20it.20downloads/near/564156150\">#mathlib4 &gt; &#96;lake exe cache get&#96; decompressing as it downloads @ ðŸ’¬</a>) floated the idea of interleaving decompressing files with downloading. This should also speed up things quite a bit (with the plan I have at home, downloading the cache takes quite a bit longer than decompressing the files). See <a href=\"https://github.com/leanprover-community/mathlib4/pull/32987\">#32987</a>. It would be really nice if both PRs could make it into Mathlib soon!</p>",
        "id": 571271307,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1769937906
    },
    {
        "content": "<p>I donâ€™t know if itâ€™s the same question, but itâ€™s very frustrating to me that every time I update the Verbose Lean dependency in my course it decompresses mathlib that hasnâ€™t changed at all. My lakefile only requires verbose, and the mathlib version used by verbose very very rarely changes.</p>",
        "id": 571287966,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1769953489
    }
]