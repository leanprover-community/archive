[
    {
        "content": "<p>Hi! I'm working on generating some universe polymorphic terms using metaprogramming, but I don't know how to generate user-facing fresh names for universe levels. Here is a MWE: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\">  </span><span class=\"c1\">-- version 4.15.0</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkLevelParam</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">mkFreshUserName</span><span class=\"w\"> </span><span class=\"ss\">`u</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">αName</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshUserName</span><span class=\"w\"> </span><span class=\"ss\">`α</span>\n<span class=\"w\">  </span><span class=\"n\">withLocalDecl</span><span class=\"w\"> </span><span class=\"n\">αName</span><span class=\"w\"> </span><span class=\"n\">BinderInfo</span><span class=\"bp\">.</span><span class=\"n\">implicit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``True</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"testterm\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">test</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">testterm</span>\n</code></pre></div>\n<p>The <code>#check</code> shows <code>fun {α} =&gt; True : {α : Sort u✝} → Prop</code>, which seems to indicate that <code>mkFreshUserName</code> generates a user-friendly name for <code>α</code> but not <code>u</code>, since <code>u</code> has a dagger symbol appended. </p>\n<p>How should I generate fresh user-facing names for universe levels properly? Thanks in advance!</p>",
        "id": 502266106,
        "sender_full_name": "Qiyuan Zhao",
        "timestamp": 1740657778
    },
    {
        "content": "<p>It's a bit of a hack, but <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/TypeStar.lean\">https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/TypeStar.lean</a> has a way to do it.</p>",
        "id": 502488524,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740714430
    },
    {
        "content": "<p>That's in TermElabM by the way.</p>",
        "id": 502488592,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740714474
    },
    {
        "content": "<p>But I should say that using hygienic names like this is probably the right way, unless the point is you're generating theorems or something like that.</p>\n<p>Also, introducing new universe levels might not be correct. Universe polymorphism is a top-level concept, and terms inside a definition can't themselves be universe polymorphic. They all have to be instantiated using the universe levels in effect.</p>",
        "id": 502488842,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740714633
    },
    {
        "content": "<p>Another thing to look at might be <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/CategoryTheory/Elementwise.lean\">https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/CategoryTheory/Elementwise.lean</a>, which needs to create some theorems with new universe levels.</p>\n<p>Take a look at the use of mkUnusedName.</p>",
        "id": 502489099,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740714768
    },
    {
        "content": "<p>Thank you for the detailed references! I think in my scenario, introducing new universe levels should be fine, since the new theorems that I plan to create are typically based on those without universe levels (e.g., purely propositional ones).</p>",
        "id": 502522646,
        "sender_full_name": "Qiyuan Zhao",
        "timestamp": 1740731639
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"689027\">Qiyuan Zhao</span> has marked this topic as resolved.</p>",
        "id": 502522714,
        "sender_full_name": "Notification Bot",
        "timestamp": 1740731648
    }
]