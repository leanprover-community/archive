[
    {
        "content": "<p>Is there a variant of <code>whnf(R)</code> which does not unfold a variable <code>a</code> which has been defined previously using <code>let a := ...</code>?  (I believe this is the \"zetaDelta\" kind of let, but I may be wrong about the naming.)</p>\n<p>I would still like it to see through mdata, perform beta-reduction and look inside <code>abbrev</code>s.  I tried <code>e.consumeMData.headBeta</code>, but (in retrospect, predictably) this managed the first two but not the third.</p>",
        "id": 482065368,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731458688
    },
    {
        "content": "<p>Related: is there a version of isDefEq which doesn't see through this kind of \"let\"?</p>",
        "id": 482091628,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731475102
    },
    {
        "content": "<p>There is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.whnfCore#doc\">docs#Lean.Meta.whnfCore</a>, which takes a configuration argument. In this configuration you can set <code>zetaDelta := false</code>. <code>whnfCore</code> is a somewhat weaker version of <code>whnf</code>, which doesn't unfold constants. (you can see this in how it is used in the definition of <code>whnf</code> at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.whnfImp#doc\">docs#Lean.Meta.whnfImp</a>). Since you want to still look through abbrevs, you would have to do this manually. For example, this is a function in the <code>DiscrTree</code>, which also unfolds abbrevs and does eta reduction:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WhnfCoreConfig</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">whnfCore</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">config</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unfoldDefinition?</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">config</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">etaExpandedStrict?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">config</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">   </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">e</span>\n</code></pre></div>\n<p>To make sure you only unfold abbrevs, remember to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.withReducible#doc\">docs#Lean.Meta.withReducible</a>.</p>",
        "id": 482095685,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1731477776
    },
    {
        "content": "<p>Unfortunately you can't set this configuration for <code>isDefEq</code>.</p>",
        "id": 482095912,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1731477926
    },
    {
        "content": "<p>Thanks, Jovan!  That's helpful.</p>\n<p>I realised that to do an <code>isDefEq</code> which treats <code>let</code>s as black boxes I could do something like</p>\n<ul>\n<li>save state</li>\n<li>clear the values of all the local definitions (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.clearValue#doc\">docs#Lean.MVarId.clearValue</a>)</li>\n<li>get the result of <code>isDefEq</code></li>\n<li>restore the state</li>\n</ul>\n<p>This seems a bit hacky but maybe it would work -- is there anything that could go wrong with this approach?</p>",
        "id": 482215020,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731515797
    },
    {
        "content": "<p>54 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"239415\" href=\"/#narrow/channel/239415-metaprogramming-.2F-tactics/topic/isDefEq.20variant.20which.20preserves.20let-bindings\">#metaprogramming / tactics &gt; isDefEq variant which preserves let-bindings</a> by <span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span>.</p>",
        "id": 482714651,
        "sender_full_name": "Notification Bot",
        "timestamp": 1731715883
    },
    {
        "content": "<p>Returning to Jovan's idea of using <code>whnfCore e (config := { zetaDelta := false })</code> (perhaps with tricks to handle abbrevs, etc.) to get \"<code>whnf</code> which preserves let-bindings\" ....</p>\n<p>I noticed that <code>whnf</code> is <a href=\"https://github.com/leanprover/lean4/blob/7dc1ceb8d4312850b39cef9e751e0a3b651946e3/src/Lean/Meta/Basic.lean#L581-L588\">an <code>extern</code></a>, which I think means the real implementation is in the C code, whereas <code>whnfCore</code> is <a href=\"https://github.com/leanprover/lean4/blob/7dc1ceb8d4312850b39cef9e751e0a3b651946e3/src/Lean/Meta/WHNF.lean#L610-L665\">implemented in Lean</a>.  Does this mean I should expect worse performance if I switch from <code>whnf</code> to <code>whnfCore</code>?</p>",
        "id": 482715529,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731716463
    },
    {
        "content": "<p>There are a couple functions such as <code>whnf</code> which look like they are implemented in C, but they are actually implemented in Lean. So if you see for example <code>@[extern 6 \"lean_whnf\"]</code>, then you should search in the lean source code for the string <code>lean_whnf</code>, which will lead you to find its definition:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">lean_whnf</span><span class=\"kd\">]</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">whnfImp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withIncRecDepth</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whnfEasyCases</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">useCache</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">useWHNFCache</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">cached?</span><span class=\"w\"> </span><span class=\"n\">useCache</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">e'</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">    </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">withTraceNode</span><span class=\"w\"> </span><span class=\"ss\">`Meta.whnf</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Non-easy whnf: {e}\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">checkSystem</span><span class=\"w\"> </span><span class=\"s2\">\"whnf\"</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">whnfCore</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">reduceNat?</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">useCache</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">   </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">reduceNative?</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">useCache</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">   </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unfoldDefinition?</span><span class=\"w\"> </span><span class=\"n\">e'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">e''</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">useCache</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">whnfImp</span><span class=\"w\"> </span><span class=\"n\">e''</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">useCache</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">e'</span>\n</code></pre></div>",
        "id": 482716592,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1731717287
    },
    {
        "content": "<p>We use whnfCore when we want to do whnf with <em>just</em> the rules of lambda calculus</p>",
        "id": 482716771,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731717424
    },
    {
        "content": "<p>It's like <code>whnf</code> if there were a transparency setting below <code>reducible</code></p>",
        "id": 482716794,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731717451
    },
    {
        "content": "<p>So from the definition of <code>whnfImp</code>, we can see <code>whnf</code> is just <code>whnfCore</code> + <code>unfoldDefinition</code> + <code>reduceNative?</code> + <code>reduceNat?</code> and with some caching</p>",
        "id": 482716827,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1731717481
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/whnf.20variant.20which.20preserves.20let-bindings/near/482716592\">said</a>:</p>\n<blockquote>\n<p>There are a couple functions such as <code>whnf</code> which look like they are implemented in C, but they are actually implemented in Lean. So if you see for example <code>@[extern 6 \"lean_whnf\"]</code>, then you should search in the lean source code for the string <code>lean_whnf</code>, which will lead you to find its definition:</p>\n</blockquote>\n<p>Thanks!  How would I tell the difference between this and a function that is actually implemented in C?  Do I just have to search the codebase for <code>@[export lean_whnf]</code>, and if nothing turns up then it means that it's implemented in C?</p>",
        "id": 482719161,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731719095
    },
    {
        "content": "<p>Yeah, that's what I do. Actually I think the only ones I know of where the definition is in a different file are defined right after <code>opaque whnf</code> in the same file (inferType, isExprDefEqAux, isLevelDefEqAux, synthPending)</p>",
        "id": 482719439,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1731719287
    },
    {
        "content": "<p>And <code>MVarId.checkedAssign</code> in the same file.</p>",
        "id": 482719511,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1731719367
    },
    {
        "content": "<p>I know the FRO is generally hesitant to make changes to really foundational pieces of Lean, but it really seems to be very easy to provide a <code>whnfImp</code> variant which takes an optional <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.WhnfCoreConfig#doc\">docs#Lean.Meta.WhnfCoreConfig</a> argument:   only the calls to <code>whnfEasyCases</code> and <code>whnfCore</code> need to be changed, and these both already admit an optional <code>WhnfCoreConfig</code> argument.  (And then <code>whnfImp</code> itself could be a one-line specialization of the variant.)</p>\n<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> (or another FRO employee), do you think core would consider making this change?  There is a lot of algebraic automation in Lean in which (I believe) it is preferable for <code>let</code>s to be preserved, for much the same reasons that were advanced in <a href=\"https://github.com/leanprover/lean4/pull/2682\">lean4#2682</a> in favour of <code>simp</code> preserving <code>let</code>s.  For example, I think <code>ring_nf</code> and <code>abel_nf</code> would ideally preserve <code>let</code>s.  See <a href=\"https://github.com/leanprover-community/mathlib4/pull/19120\">#19120</a>.</p>\n<p>I can open an issue on the Lean 4 repo, but first wanted to check whether this change would be considered at all.</p>",
        "id": 482733494,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731730279
    },
    {
        "content": "<p>Didn't look closely, but isn't it maybe the case that Leo happens to be working on exactly that, independent of this discussion? <a href=\"https://github.com/leanprover/lean4/pull/6053\">https://github.com/leanprover/lean4/pull/6053</a></p>",
        "id": 482789679,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1731779775
    },
    {
        "content": "<p>Yes, very nice. I see that this PR adds the <code>whnfCoreConfig</code> options into the configuration of the <code>MetaM</code> monad instead of passing them as an explicit argument to <code>whnfCore</code></p>",
        "id": 482792010,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1731781882
    },
    {
        "content": "<p>Thanks for pointing this out! That's a big PR of Leo's and it seems that this change I had hoped for is just a side effect -- do you know what the main point of the PR is?</p>",
        "id": 482795621,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731785078
    },
    {
        "content": "<p>Do I understand correctly that (among other things) that PR would enable both the two things I asked about: turning off zetaDelta in <code>whnf</code> and also in <code>isDefEq</code>?</p>",
        "id": 482795754,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731785178
    },
    {
        "content": "<p>It looks to me like that is exactly the point: global configurability of reductions like <code>zetaDelta</code>, so that these can be set in functions like <code>isDefEq</code>.</p>",
        "id": 482798983,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1731788120
    },
    {
        "content": "<p>That's great!</p>",
        "id": 482799094,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731788219
    },
    {
        "content": "<p>Have there been previous discussions of this point, or other places where people requested this feature? I hadn't noticed any.</p>",
        "id": 482799168,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731788287
    },
    {
        "content": "<p>This is an independent development, as part of some performance and correctness improvements</p>",
        "id": 482800548,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731789534
    },
    {
        "content": "<p>Interesting ... looking through recent PRs I see <a href=\"https://github.com/leanprover/lean4/pull/6051\">lean4#6051</a>, <a href=\"https://github.com/leanprover/lean4/pull/6054\">lean4#6054</a>, <a href=\"https://github.com/leanprover/lean4/pull/6072\">lean4#6072</a> -- are they related?  So this is something to do with <code>simp</code> performance?</p>",
        "id": 482800961,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731789931
    },
    {
        "content": "<p>Yes, they're related. My understanding is that we need zetaDelta to be set in a consistent way to make sure the discrimination tree can index local hypotheses correctly.</p>",
        "id": 482801231,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731790132
    },
    {
        "content": "<p>Is this (indirectly) a consequence of <a href=\"https://github.com/leanprover/lean4/pull/2682\">lean4#2682</a>, then?  Giving <code>simp</code> a <code>zetaDelta</code> flag ended up requiring that all the core metaprogramming machinery have a zetaDelta flag too?</p>",
        "id": 482801497,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731790353
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span>, do you want to continue with <a href=\"https://github.com/leanprover-community/mathlib4/pull/19120\">#19120</a>? I think you can remove the function <code>whnfWithConfig</code>, and instead just add a <code>withConfig ({. with zetaDelta := false })</code> to the <code>whnf</code>.</p>",
        "id": 495887964,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1737824939
    }
]