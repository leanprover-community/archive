[
    {
        "content": "<p>I want to elaborate a term <code>t</code> and access its <code>ti : TermInfo</code>, and be able to <code>ti.runMetaM</code>. It seems like no context is saved in this case. Or, more likely, I do not know the go-to way of giving it the root context.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">printTrees</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getInfoTrees</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{&lt;- t.format}\"</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#foo\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"n\">printTrees</span>\n\n<span class=\"bp\">#</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"w\"> </span><span class=\"c1\">-- prints `‚Ä¢ &lt;context-not-available&gt;`</span>\n</code></pre></div>",
        "id": 569807448,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769204659
    },
    {
        "content": "<p>Why do you want to do this?</p>",
        "id": 569808885,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769205451
    },
    {
        "content": "<p>I'm making a small typst DSL, and want to be able to have a command like <code>#typst[And therefore {x * 2 = 5}]</code> which contains lean terms. I want to elaborate these lean terms and render them in a nice way as typst, for this I match on the syntax and get the term info from the infotree.</p>",
        "id": 569809088,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769205555
    },
    {
        "content": "<p>There is <code>InfoTree.findInfo?</code>, but it does not give you the ContextInfo.</p>",
        "id": 569809257,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769205635
    },
    {
        "content": "<p>The context node is actually missing here because the infostate has been reset (and saved) by <code>liftTermElabM</code>. The new infotrees are saved inside a fresh context node by <code>liftTermElabM</code> when it finishes. EDIT: rewording!</p>",
        "id": 569809642,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769205833
    },
    {
        "content": "<p>I suppose the proper solution would be to add a <code>.context</code> InfoTree node myself, right after the liftTermElabM?</p>",
        "id": 569809739,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769205883
    },
    {
        "content": "<p>(I've edited my message a bit to be more accurate!) The context should already be saved when outside of <code>liftTermElabM</code>; if you change the type signature of <code>printTrees</code> to be in <code>CommandElabM</code>, you should see the trees without any issue. Does doing this afterwards in <code>CommandElabM</code> work for you?</p>",
        "id": 569810154,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769206068
    },
    {
        "content": "<p>Ohhhh! That explains a lot. Lemme see if that'll work for what I'm doing.</p>",
        "id": 569810314,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769206163
    },
    {
        "content": "<p>(Note also that I think <code>liftCoreM</code> does something similar, because <code>liftCoreM printTrees</code>out in <code>CommandElabM</code> after <code>liftTermElabM</code> doesn't seem to show any infotrees. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>)</p>",
        "id": 569810559,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769206299
    },
    {
        "content": "<p>I don't think that will work, since I will have a sequence of interleaved and potentially nested typst and lean. <code>#[Hello {x * #text(red)[123]} is just {3}.]</code>, so when I start looking at the word \"is\", I already want to have finished processing the stuff before.</p>",
        "id": 569810887,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769206504
    },
    {
        "content": "<p>I could make it work anyhow, but it would be very different from the code I have so far.</p>",
        "id": 569811026,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769206593
    },
    {
        "content": "<p>Hmmm, interesting...I wonder if the right solution is to create your own context nodes, or just to grab the state you need directly from the <code>TermElabM</code> monad in order to run <code>MetaM</code> (if that's your primary goal).</p>",
        "id": 569811189,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769206712
    },
    {
        "content": "<p>looks like you can get some command context info with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.CommandContextInfo.save#doc\">docs#Lean.Elab.CommandContextInfo.save</a></p>",
        "id": 569811234,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769206739
    },
    {
        "content": "<p>You also might be able to wrap your elabTerm in <code>withSaveInfoContext</code>‚Äîthat's what <code>liftTermElabM</code> does ultimately (and relies on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.CommandContextInfo.save#doc\">docs#Lean.Elab.CommandContextInfo.save</a> as a component)</p>",
        "id": 569812053,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769207233
    },
    {
        "content": "<p>Testing it, it seems like <code>withSaveInfoContext</code> works; but I actually still wonder if maybe there's a better approach in general? What information are you getting from the infotree that you don't have in the course of elaboration itself already?</p>",
        "id": 569812349,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769207394
    },
    {
        "content": "<p>If I have a <code>stx : Term</code> which is a function application with a bunch of implicit arguments, I can elaborate it and obtain the Expr equivalent, that works, sure. But now I want to generate typst from this, and for example hide the implicit arguments. Or I want to distinguish <code>@f 1 2</code> from <code>f 2</code>, which elaborate to the same expression, but should render differently to typst. So looking at the Expr is not enough, I need to look at the original Syntax. And I am using InfoTree to associate Syntax with its elaborated Expr.</p>",
        "id": 569812958,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769207769
    },
    {
        "content": "<p>Yeah, <code>withSaveInfoContext</code> works! I would not have found this myself, thank you so much!</p>",
        "id": 569813065,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769207833
    },
    {
        "content": "<p>No problem, happy to help! :D</p>",
        "id": 569815520,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769209281
    },
    {
        "content": "<p>I have packaged it into as the following, which I am happy with. Just in case anyone finds this thread in the future.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabTermAndGetInfoTree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oldTrees</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getResetInfoTrees</span><span class=\"w\"> </span><span class=\"c1\">-- wipe existing trees</span>\n<span class=\"w\">  </span><span class=\"n\">try</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">withSaveInfoContext</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"c1\">-- https://leanprover.zulipchat.com/#narrow/channel/239415-metaprogramming-.2F-tactics/topic/InfoTree.20with.20ContextInfo.20from.20liftTermElabM/near/569812053s</span>\n<span class=\"w\">      </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">expected</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">trees</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getResetInfoTrees</span><span class=\"w\"> </span><span class=\"c1\">-- should just be the latest one</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">trees</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">e</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">trees</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"[elabTermAndGetInfo] somehow got {trees.size} trees instead of 1.\"</span>\n<span class=\"w\">  </span><span class=\"n\">finally</span>\n<span class=\"w\">    </span><span class=\"n\">modifyInfoState</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">trees</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">oldTrees</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>Edit: Ah, damn, nevermind, this prevents any infos from getting attached to the term, so that semantic highlighting and on-hover type info break :/.</p>",
        "id": 569857676,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769253403
    },
    {
        "content": "<p>I think that's because you're resetting the infotrees in the end; note that <code>withSaveInfoContext</code> already saves then resets the infotree context, then restores the earlier infotrees afterwards. I'd avoid calling <code>getResetInfoTrees</code> manually and instead rely on <code>withSaveInfoContext</code>; note also that <code>getInfoTrees</code> can let you inspect the size without destroying the trees!</p>\n<p>(You can also use <code>withInfoTreeContext</code>/<code>withInfoContext</code> as combinators for resetting/restoring infotrees with new additions, but my suspicion is that you probably don't need to! <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span>)</p>",
        "id": 569974008,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769366986
    }
]