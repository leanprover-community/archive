[
    {
        "content": "<p>I'm trying to declare some types from an elaborator.<br>\nI believe this code should do the trick, but it doesn't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">typeName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`MyType</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">typeName2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`MyType2</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fieldName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`myField</span>\n\n<span class=\"c1\">-- this attempt works:</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- this part doesn't :(</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName2</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">fieldName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName2</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>It looks that the problem lies within the use of <code>$fieldName</code>: everything works if I used a regular ident within the syntax quotation.<br>\nBut I can't use the working elab: the <code>x</code> field would have a <em>secret</em> name that I can't access, due to macro hygiene.</p>\n<p>I tried to look into the elaborators that implements the <code>inductive</code> command, to create a type manually without relying on existing elaborators, but that logic seems <em>very</em> complicated.<br>\nThe same is true for <code>structure</code> and other types.</p>\n<p>How can I declare types from my elaborators?</p>",
        "id": 491880007,
        "sender_full_name": "Spanky",
        "timestamp": 1735999623
    },
    {
        "content": "<p>What does \"doesn't work\" mean? I'm just seeing a parse error in the quotation, is that the problem?</p>\n<p>Often you need to add syntax type annotations to get these to parse.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName2</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">fieldName</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeName2</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 491893313,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736012073
    },
    {
        "content": "<p>Yes, the issue was the parse error.<br>\nI couldn't figure out that a syntax annotation would fix the problem and couldn't find that suggestion anywhere.<br>\nThank you!</p>",
        "id": 491894608,
        "sender_full_name": "Spanky",
        "timestamp": 1736013240
    },
    {
        "content": "<p>Got another related(ish) question about elabs.<br>\nI'm trying to define some new command within an elab, and then use that same command within the same elab:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elabCommand</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cmdCat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`command</span>\n\n<span class=\"c1\">-- this works</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#X\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">cmdCat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"X\"</span><span class=\"o\">)</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">X</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- this fails</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#Y\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">cmdCat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Y\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- error: unexpected token '#'; expected identifier or term</span>\n\n<span class=\"c1\">-- this fails too, with a different error (it's the same thing, but without `#`)</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"c1\">-- error: unexpected command</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"Y\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">cmdCat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Y\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I get the same errors if I try to run a command (<code>#Y</code> or <code>Y</code>) that hasn't been created yet outside of elaborators.</p>\n<p>It feels to me like the syntax quotation creates the second <code>TSyntax `command</code>s before elaborating the first. But that shouldn't happen, since the syntax quotation itself is a <code>CommandElabM</code> action.</p>\n<p>Why does this happen, and how can I make it work?</p>",
        "id": 491953037,
        "sender_full_name": "Spanky",
        "timestamp": 1736070174
    },
    {
        "content": "<p>You'll get a better error from</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#Y\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">cmdCat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Y\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">Y</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 491963096,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736079969
    },
    {
        "content": "<p>(which is consistent with and without <code>#</code>)</p>",
        "id": 491963102,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736079978
    },
    {
        "content": "<p>This works, but is ugly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"Y\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">cmdCat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Y\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"ss\">`command</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">    </span><span class=\"c1\">-- need to parse a string, otherwise the syntax is parsed before we run the above line</span>\n<span class=\"w\">    </span><span class=\"s2\">\"Y\"</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">e</span>\n</code></pre></div>",
        "id": 491963265,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736080162
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"815997\">Spanky</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Declare.20types.20programmatically.2C.20via.20elaborators/near/491953037\">said</a>:</p>\n<blockquote>\n<p>But that shouldn't happen, since the syntax quotation itself is a <code>CommandElabM</code> action.</p>\n</blockquote>\n<p>My understanding is that the monad is only used to attach source information to the syntax, not to influence the parsing itself.</p>",
        "id": 491963369,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736080237
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Declare.20types.20programmatically.2C.20via.20elaborators/near/491963369\">said</a>:</p>\n<blockquote>\n<p>My understanding is that the monad is only used to attach source information to the syntax, not to influence the parsing itself.</p>\n</blockquote>\n<p>Ohh, so the syntax quotation gets evaluated before the actions are executed?<br>\nThat's a bummer.</p>\n<p>I wonder if there are better ways to achieve the goal.<br>\nOtherwise I guess I'll introduce some term-elaborator to generate the string and the expression which parses it.</p>",
        "id": 491966560,
        "sender_full_name": "Spanky",
        "timestamp": 1736083181
    },
    {
        "content": "<p>I would be interested in hearing more about your use case. This is not something that should usually come up because for new syntax to be used in a quotation, it must be sufficiently static, while having it generated implies there must be some dynamic parts.</p>",
        "id": 491969996,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736086217
    },
    {
        "content": "<p>[I'm still OP. Using an account I created from my parents' computer when I had no access to my mail]</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Declare.20types.20programmatically.2C.20via.20elaborators/near/491969996\">said</a>:</p>\n<blockquote>\n<p>I would be interested in hearing more about your use case.</p>\n</blockquote>\n<p>I was trying to write a command which wraps a list of other commands and was surprised to see it misbehave:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">cmds</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">cmds</span><span class=\"bp\">.</span><span class=\"n\">forM</span><span class=\"w\"> </span><span class=\"n\">elabCommand</span>\n\n<span class=\"o\">{</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#greet\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Hi!\"</span>\n<span class=\"bp\">#</span><span class=\"n\">greet</span><span class=\"w\"> </span><span class=\"c1\">-- uh oh! :-(</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>I've seen how <code>namespace</code> avoids the problem: it doesn't handle the commands it contains. It rather modifies the env, and then the <code>end</code> command undoes the changes.<br>\nIn my case I wanted to manipulate the commands (filter and/or print the command to be executed).</p>\n<p>In any case, I'm not doing anything important. Just playing with the elaborator to understand the whole system better.</p>",
        "id": 491977179,
        "sender_full_name": "Blue",
        "timestamp": 1736092296
    },
    {
        "content": "<p>Yes we don't currently have an abstraction for introducing such scoping commands</p>",
        "id": 491980310,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736095126
    }
]