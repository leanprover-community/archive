[
    {
        "content": "<p>Recently, <code>finiteness</code> tactic (a wrapper around <code>aesop</code>) was added to Mathlib. How do I call it from meta code? <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> :  I want to make <code>positivity</code> handle <code>x¯¹</code> on <code>ENNReal</code> by proving <code>x ≠ ∞</code> using <code>finiteness</code>.</p>",
        "id": 479994795,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1730435693
    },
    {
        "content": "<p><code>finiteness</code> is only written as a <code>macro</code> wrapper around <code>aesop</code>, so there is no <code>MetaM</code> or <code>TacticM</code> interface.</p>",
        "id": 480001998,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730441304
    },
    {
        "content": "<p>You can fake it using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.runTactic#doc\">docs#Lean.Elab.runTactic</a>.</p>",
        "id": 480002049,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730441348
    },
    {
        "content": "<p>e.g. as in <code>Mathlib.Tactic.Bound</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Plain `bound` elaboration, with no hypotheses</span>\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rule_sets</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bound</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">default</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Bound</span><span class=\"bp\">.</span><span class=\"n\">boundConfig</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">liftMetaTactic</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">runTactic</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">tac</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n</code></pre></div>",
        "id": 480002064,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730441366
    },
    {
        "content": "<p>Is there a <code>*M</code> interface to <code>aesop</code>?</p>",
        "id": 480004973,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1730443611
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Aesop.search#doc\">docs#Aesop.search</a></p>",
        "id": 480005547,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730444068
    },
    {
        "content": "<p>and see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Aesop.evalAesop#doc\">docs#Aesop.evalAesop</a> for how it prepares the arguments from the surface syntax.</p>",
        "id": 480005564,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730444084
    },
    {
        "content": "<p>I'll look into this over the weekend.</p>",
        "id": 480005630,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1730444147
    },
    {
        "content": "<p>Yury, I suggest you read how <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Meta.Positivity.evalFinsetCard#doc\">docs#Mathlib.Meta.Positivity.evalFinsetCard</a> calls aesop through <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Meta.proveFinsetNonempty#doc\">docs#Mathlib.Meta.proveFinsetNonempty</a></p>",
        "id": 480021050,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730452821
    },
    {
        "content": "<p>I think an easier interface is <code>evalTactic</code>. This can be written like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">focus</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rule_sets</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bound</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">default</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Bound</span><span class=\"bp\">.</span><span class=\"n\">boundConfig</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tac</span>\n</code></pre></div>\n<p>The added <code>focus</code> makes sure that aesop sees only the current goal. Not necessary here, but it can be useful when you write tactics this way.</p>",
        "id": 480064834,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730472783
    },
    {
        "content": "<p>Adding <code>focus</code> is a very good habit that will prevent extremely weird behavior for users.</p>",
        "id": 480213671,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1730549658
    }
]