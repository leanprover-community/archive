[
    {
        "content": "<p>The tactic <code>intro x</code> makes it seem like we assigned the main goal to <code>fun x =&gt; ?M</code> for some new metavariable <code>?M</code> which contains <code>x</code> in the local context. This metavariable is the goal state after the tactic. However, it appears this is not possible, as <code>x</code> would need to be a bvar for <code>?M</code>, not an fvar. Here's an experiment I ran with <code>mkLetFVars</code>, which is used in the implementation of <code>intro</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">withLetDecl</span><span class=\"w\"> </span><span class=\"ss\">`test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">inner</span>\n<span class=\"w\">    </span><span class=\"c1\">-- ?_uniq.22524</span>\n<span class=\"w\">    </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">fvar</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">usedLetOnly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let test : Nat := ?_uniq.22522; ?_uniq.22525</span>\n<span class=\"w\">    </span><span class=\"n\">inner</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">fvar</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let test : Nat := ?_uniq.22522; ?_uniq.22525</span>\n<span class=\"o\">)</span>\n</code></pre></div>\n<p>Rather than assigning <code>goal</code> to a let definition with body <code>inner</code>, it creates a new metavariable that does not respond to updates in <code>inner</code>. This is sensible, but it implies that the tactics after <code>intro</code> have to be evaluated first, before the <code>mkLambdaFVars</code> is applied. This is surprising to me, as I thought tactics were run in order.</p>\n<p>My main question is: is it possible to create a function that assigns a metavariable to a let definition of other metavariables, where the latter has an extended local context, and where assignments of those metavariables would be propagated?</p>",
        "id": 547159850,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761512801
    },
    {
        "content": "<p>this is the delayed assignment thing</p>",
        "id": 547160134,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761513079
    },
    {
        "content": "<p>tactics are run in order I'm pretty sure</p>",
        "id": 547160163,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761513104
    },
    {
        "content": "<p>it's just delayed assigned mvars are weird</p>",
        "id": 547160185,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761513122
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346696\">Chase Norman</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/How.20.60intro.60.20works.20with.20mvars/near/547159850\">said</a>:</p>\n<blockquote>\n<p>My main question is: is it possible to create a function that assigns a metavariable to a let definition of other metavariables, where the latter has an extended local context, and where assignments of those metavariables would be propagated?</p>\n</blockquote>\n<p>can you give some pseudocode of what you want to assign</p>",
        "id": 547160217,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761513153
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">assignLet</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MVarId</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">withLetDecl</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">getType</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">fvar</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">usedLetOnly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">body</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 547160344,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761513279
    },
    {
        "content": "<p>I want this but something that would actually work</p>",
        "id": 547160363,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761513294
    },
    {
        "content": "<p>Just edited it to return the new mvars</p>",
        "id": 547160460,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761513369
    },
    {
        "content": "<p>The idea would be that then you could present these mvars to a user, and they would be assigned later</p>",
        "id": 547160483,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761513397
    },
    {
        "content": "<p>ok now I'm confused this mvar is weird</p>",
        "id": 547160960,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761513917
    },
    {
        "content": "<p>the mvar structure has some questionable design choices</p>",
        "id": 547161110,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514086
    },
    {
        "content": "<p>I think you assigned an mvar that was already assigned and that's why it wasn't updating</p>",
        "id": 547161152,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514124
    },
    {
        "content": "<p>specifically, the <code>mkLambdaFVars</code> in your first example assigned <code>inner</code></p>",
        "id": 547161170,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514146
    },
    {
        "content": "<p>so when you assigned it again it broke the thing</p>",
        "id": 547161183,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514160
    },
    {
        "content": "<p>That appears to be true. I want <code>inner</code> to be just like what <code>intro</code> does, unassigned and presentable to a user for assignment.</p>",
        "id": 547161284,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761514267
    },
    {
        "content": "<p>look it's already assigned</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">withLetDecl</span><span class=\"w\"> </span><span class=\"ss\">`test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">inner</span>\n<span class=\"w\">    </span><span class=\"c1\">-- ?_uniq.22524</span>\n<span class=\"w\">    </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">fvar</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">usedLetOnly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let test : Nat := ?_uniq.22522; ?_uniq.22525</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">isAssigned</span>\n<span class=\"w\">    </span><span class=\"c1\">-- true</span>\n<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 547161307,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514287
    },
    {
        "content": "<p>if you want it to not be assigned then maybe making it synthetic opaque will do something</p>",
        "id": 547161326,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514309
    },
    {
        "content": "<p>since that's what tactics work on</p>",
        "id": 547161340,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514323
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MetavarKind.syntheticOpaque#doc\">docs#Lean.MetavarKind.syntheticOpaque</a></p>",
        "id": 547161402,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514409
    },
    {
        "content": "<p>This is progress:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">2026</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">2029</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">2026</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">test</span>\n</code></pre></div>",
        "id": 547161420,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761514440
    },
    {
        "content": "<p>I guess you can't expect the top to read just <code>?inner</code> because that breaks the Expr invariant</p>",
        "id": 547161436,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761514472
    },
    {
        "content": "<p>wait what's the expr invariant</p>",
        "id": 547161559,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514587
    },
    {
        "content": "<p>That <code>test</code> should be bound in the body</p>",
        "id": 547161584,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761514610
    },
    {
        "content": "<p>Meaning any mvar that uses it has to be passed it as an argument</p>",
        "id": 547161608,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761514633
    },
    {
        "content": "<p>Is there a way to <code>instantiateMVars</code> that also greedily instantiates delayed mvars? It would be nice to be able to show the partial assignment, even though there are still mvars around</p>",
        "id": 547161621,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761514656
    },
    {
        "content": "<p>nope can't find anything</p>",
        "id": 547161691,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514740
    },
    {
        "content": "<p>there is a pp option <code>pp.mvars.delayed</code></p>",
        "id": 547161716,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514766
    },
    {
        "content": "<p>it seems to be doing something</p>",
        "id": 547161722,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761514775
    },
    {
        "content": "<p>I see no effect</p>",
        "id": 547161786,
        "sender_full_name": "Chase Norman",
        "timestamp": 1761514832
    }
]