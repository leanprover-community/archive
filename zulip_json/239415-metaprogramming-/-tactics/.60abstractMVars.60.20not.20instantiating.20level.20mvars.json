[
    {
        "content": "<p>If the type of an mvar includes an assigned level mvar, <code>abstractMVars</code> fails to realize this and abstracts that level mvar. This seems inconsistent to me because <code>abstractMVars</code> does instantiate mvars it runs into.</p>\n<p>Here's a MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">levelMVar</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshLevelMVar</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkSort</span><span class=\"w\"> </span><span class=\"n\">levelMVar</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkSort</span><span class=\"w\"> </span><span class=\"n\">levelMVar</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkSort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkLevelParam</span><span class=\"w\"> </span><span class=\"ss\">`u</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">mvar</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{mvar}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">abstractResult</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">abstractMVars</span><span class=\"w\"> </span><span class=\"n\">mvar</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{abstractResult.paramNames}\"</span>\n</code></pre></div>\n<p>Is this a bug? It definitely surprised me.</p>",
        "id": 541918246,
        "sender_full_name": "Eric Paul",
        "timestamp": 1759093002
    },
    {
        "content": "<p>Yes, this is a bug, thanks.</p>\n<p>(<a href=\"https://github.com/leanprover/lean4/pull/10612\">lean4#10612</a> has a potential fix; waiting on CI and mathlib testing.)</p>",
        "id": 542016191,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759146646
    },
    {
        "content": "<p>Great!</p>\n<p>Also, for the fix, instead of calling <code>instantiateMVars</code> on the type, you can instead check what the level mvar is assigned to in the function <code>abstractLevelMVars</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">depth</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mctx</span><span class=\"bp\">.</span><span class=\"n\">getLevelDepth</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">depth</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">mctx</span><span class=\"bp\">.</span><span class=\"n\">depth</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"c1\">-- metavariables from lower depths are treated as constants</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"c1\">-- Added check</span>\n<span class=\"w\">          </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMCtx</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">lAssignment</span><span class=\"o\">[</span><span class=\"n\">mvarId</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">level</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">level</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">lmap</span><span class=\"o\">[</span><span class=\"n\">mvarId</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">   </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">              </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">paramId</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">mkNum</span><span class=\"w\"> </span><span class=\"ss\">`_abstMVar</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">nextParamIdx</span>\n<span class=\"w\">              </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkLevelParam</span><span class=\"w\"> </span><span class=\"n\">paramId</span>\n<span class=\"w\">              </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">nextParamIdx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">nextParamIdx</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lmap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">lmap</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">paramNames</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">paramNames</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">paramId</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">              </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">u</span>\n</code></pre></div>",
        "id": 542030411,
        "sender_full_name": "Eric Paul",
        "timestamp": 1759150342
    },
    {
        "content": "<p>Ah but I guess this potentially goes against the documentation that all mvars should be instantiated first.  Is there a reason to require that instead of just checking what the mvars we run into are assigned to? It wouldn't require any calls to <code>instantiateMVars</code>.</p>",
        "id": 542031578,
        "sender_full_name": "Eric Paul",
        "timestamp": 1759150630
    },
    {
        "content": "<p>Instantiating metavariables is somewhat complicated — there are delayed assignments to resolve, and it also does some beta reduction. The pre-PR code also has a bug where if the type of a metavariable contains an assigned delayed assignment then that metavariable will be abstracted, which the added <code>instantiateMVars</code> fixes.</p>",
        "id": 542048688,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759154450
    },
    {
        "content": "<p>I see, that makes sense. Thanks for looking at at this!</p>",
        "id": 542049031,
        "sender_full_name": "Eric Paul",
        "timestamp": 1759154526
    },
    {
        "content": "<p>There's still a lingering bug, where if there are some delayed assignments that are not ready to be resolved the abstracted term will be overly general (that's to say, <code>abstractMVars</code> ignores delayed assignments completely).</p>",
        "id": 542049109,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759154542
    }
]