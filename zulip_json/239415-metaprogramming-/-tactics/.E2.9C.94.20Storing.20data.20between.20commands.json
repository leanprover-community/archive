[
    {
        "content": "<p>Hello ! I'm defining a couple custom commands, let's say <code>#commandA</code> and <code>#commandB</code>. I would like <code>#commandA</code> to store some data that I can latter access in <code>#commandB</code>. Is there an API to do this ?</p>",
        "id": 474808053,
        "sender_full_name": "Mathis Bouverot-Dupuis",
        "timestamp": 1728043295
    },
    {
        "content": "<p>Look at environment extensions. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.EnvExtension#doc\">docs#Lean.EnvExtension</a> if the data only needs to be accessible to commands in the same file; <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PersistentEnvExtension#doc\">docs#Lean.PersistentEnvExtension</a> otherwise.</p>",
        "id": 474814941,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1728045839
    },
    {
        "content": "<p>Thanks ! How do I register an env extension ? Apparently I have to do it during initialization but I don't know how to do this.</p>",
        "id": 474819652,
        "sender_full_name": "Mathis Bouverot-Dupuis",
        "timestamp": 1728047261
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">registerEnvExtension</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>Note that initialisation commands are executed at <code>import</code> time, so they only take effect in files that import the file containing the <code>initialize</code> command.</p>",
        "id": 474819918,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1728047353
    },
    {
        "content": "<p>Ok but I need to give a (global) name to the env extension, how do I do that ?</p>",
        "id": 474820257,
        "sender_full_name": "Mathis Bouverot-Dupuis",
        "timestamp": 1728047450
    },
    {
        "content": "<p>I suspect I need to use IO refs but I can't get it working by trial and error</p>",
        "id": 474820949,
        "sender_full_name": "Mathis Bouverot-Dupuis",
        "timestamp": 1728047665
    },
    {
        "content": "<p>I managed to register the env extension, but when I use it the program crashes. Any ideas what I'm doing wrong ?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">myext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EnvExtension</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">registerEnvExtension</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#show_contents\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">contents</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"n\">EnvExtension</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"n\">myext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"n\">getEnv</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Contents : { contents }\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">show_contents</span>\n<span class=\"c1\">-- Server process for file:///home/mathis/Documents/work/coq-metaprogramming/DeriveMap/Lean/Command.lean crashed, likely due to a stack overflow or a bug.</span>\n</code></pre></div>",
        "id": 474824967,
        "sender_full_name": "Mathis Bouverot-Dupuis",
        "timestamp": 1728048906
    },
    {
        "content": "<p>You need to put the <code>initialize</code> and the rest of the file into two different files. Though I'm not sure if it's supposed to crash if you don't. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 474827475,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1728049679
    },
    {
        "content": "<p>Oh thanks this was it ! It does crash if you make the mistake :)</p>",
        "id": 474828193,
        "sender_full_name": "Mathis Bouverot-Dupuis",
        "timestamp": 1728049890
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"763287\">Mathis Bouverot-Dupuis</span> has marked this topic as resolved.</p>",
        "id": 474828208,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728049896
    }
]