[
    {
        "content": "<p>Hi! I was wondering what is the best way to rename variables in an <code>Expr</code>? Suppose I am trying to create the following pattern-match programmatically:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>In the pattern match above, the <code>n</code> in the pattern <code>Nat.succ n</code> shadows the scrutinee <code>n</code>, so I'd like to replace all occurrences of <code>n</code> in the LHSes &amp; RHSes of the pattern match with some fresh variable <code>n'</code>, with this being the resultant pattern-match:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">n'</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>I am working in a codebase in which the following <code>structure</code> (simplified) is used to create these pattern-matches programmatically:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">PatternMatch</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Cases (LHSes) of the pattern match -/</span>\n<span class=\"w\">  </span><span class=\"n\">matchLHSes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/--  RHSes of the pattern match (Invariant: `matchLHSes.length == matchRHSes.length`) -/</span>\n<span class=\"w\">  </span><span class=\"n\">matchRHSes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n</code></pre></div>\n<p>I was wondering how to rename the variable <code>n</code> in the <code>Expr</code>s in both <code>matchLHSes</code> and <code>matchRHSes</code> in a principled way? I plan on using <code>LocalContext.getUnusedName</code> to produce a fresh user-accessible name, so I'm wondering whether I should just use <code>LocalContext.renameUserName</code> to rename <code>n</code> to <code>n'</code>,  or if I ought to use <code>Expr.replaceFVar</code> to perform the replacement directly on <code>Expr</code>s (the latter requires manipulating <code>FVarId</code>s, which I am worried about)? Thanks!</p>",
        "id": 524750281,
        "sender_full_name": "Ernest Ng",
        "timestamp": 1750266336
    },
    {
        "content": "<p>Just to be clear, variables themselves don't have names, due to the locally nameless encoding. Names in closed expressions are encoded in the forallE, lam, and letE expressions themselves, and for open expressions they are encoded in the LocalContext.</p>\n<p>If you have the variables as fvars, then to make a name change all you need to do is take the current local context, create a new one from it with changed names, then use <code>withLCtx'</code> to enter this new context, where you build the expression.</p>\n<p>If you are manipulating Exprs directly after the fact, you only need to modify the corresponding forallE/lam/letE to do the alpha rename.</p>\n<p>You're right to hesitate with manipulating FVarIds. That's likely too low level, and also I'm not sure how this would rename the variables (unless you somehow have a local context with two copies of variables, one with the new name?)</p>",
        "id": 524752871,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750267383
    },
    {
        "content": "<p>Great, thank you so much! It looks like creating a new <code>LocalContext</code> and using <code>withLCtx'</code> to enter the new context did the trick for my example above!</p>",
        "id": 524756759,
        "sender_full_name": "Ernest Ng",
        "timestamp": 1750269112
    },
    {
        "content": "<p>It's possible to change types of local variables too this way too — but if you ever do this, take care! There are caches in MetaM that likely need to be cleared (<code>withFreshCache</code>), for example the <code>inferType</code> cache. Also, there is the LocalInstances cache that could need refreshing.</p>\n<p>It's fine changing names of variables though without worrying what this will do to the caches, since the names don't affect anything in MetaM.</p>",
        "id": 524758087,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750269701
    },
    {
        "content": "<p>Ah good to know, thanks! I only plan on using <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/LocalContext.html#Lean.LocalContext.renameUserName\">LocalContext.renameUserName</a> to update the <code>LocalContext</code>, so hopefully all the changes I'm making (i.e. renaming) are type-preserving.</p>",
        "id": 524765440,
        "sender_full_name": "Ernest Ng",
        "timestamp": 1750272727
    }
]