[
    {
        "content": "<p>\"solve_by_elim only L\"   cannot prove some goals that \"solve_by_elim L\" can prove without using any lemmas outside L.<br>\nExample:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">iff_example</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\"> </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">U</span>\n<span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">U</span>\n<span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">solve_by_elim</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h2</span><span class=\"o\">]</span><span class=\"w\">         </span><span class=\"c1\">-- here it works</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">solve_by_elim</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">]</span><span class=\"w\">    </span><span class=\"c1\">-- with only it does not</span>\n</code></pre></div>\n<p>My wild guess is that one of the following two things happens:</p>\n<ol>\n<li>\"only\" disallows introducing hypotheses (i.e. intro)</li>\n<li>hypotheses are introduced, but they are not added to the list L of usable hypotheses, like it should IMHO</li>\n</ol>\n<p>Is this a known issue? Is there a simple workaround and/or could/should solve_by_elim being patched?</p>",
        "id": 454869538,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1722267311
    },
    {
        "content": "<p>Followup: looking at the solve_by_elim code the cause is clearly hypothesis 2.</p>",
        "id": 454871667,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1722267877
    },
    {
        "content": "<p>Using <code>show_term</code> shows indeed an unexpected (by me) behaviour:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">U</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">constructor</span>\n<span class=\"w\">    </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"c1\">-- clear h1 -- if you uncomment `clear h1`, `solve_by_elim` finds `exact fun a =&gt; h2 a`</span>\n<span class=\"w\">      </span><span class=\"n\">show_term</span><span class=\"w\"> </span><span class=\"n\">solve_by_elim</span><span class=\"w\"> </span><span class=\"c1\">-- a detour `exact fun a =&gt; h2 (h1 (h2 a))`</span>\n<span class=\"w\">    </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>If it can go on a detour, it does.</p>",
        "id": 454872537,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722268133
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> the detour is not nice, but it is unrelated to what I am reporting. Indeed</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">solve_by_elim</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">,</span><span class=\"n\">h2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>also fails to find a proof, even if the ingredients for the detour are there. The problem is that the tactic starts doing \"intro a\" but NOT adding \"a\" to the list of lemmas and therefore after applying \"h2\" it cannot conclude</p>",
        "id": 454874791,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1722268705
    },
    {
        "content": "<p>I agree, but I imagine that this could be expected behaviour: when you use <code>only</code> you have not specified using the introduced variable (and you probably have no way of doing that, since it is not available to begin with).</p>\n<p><code>*</code> gives you access to everything and then you can prevent the detour using <code>solve_by_elim only [*, h2, -h1]</code> (the <code>-h1</code> is in fact not really needed).</p>",
        "id": 454876246,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722269111
    },
    {
        "content": "<ol>\n<li>The behaviour is not expected from equivalent tactics in other systems (Coq/Matita): there every additional hypotheses introduced by the tactic itself is allowed.  This also allows the natural specification \"the tactic solves the goal using only iff it solves the goal without only using only the listed lemmas\"</li>\n<li>My expected behaviour is the useful one for reconstructing proofs found by external provers and to speed up proof search: once you find the proof the first time (or an external proof does), you cut down using \"only\" on the only lemmas that are required. But this requires my semantics</li>\n<li>In my particular case I am writing a macro used in teaching that forces the students to write explicitly the hypotheses that are required.  If the hypotheses introduced by the tactic itself are not considered, then I canno tuse solve_by_elim for this and I need to duplicate the code of solve_by_elim to impose my semantics. (And I am not even sure if the code lives all in user space)</li>\n</ol>",
        "id": 454878066,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1722269496
    },
    {
        "content": "<p>Finally, I do not see any advantages of the current semantics of \"only\". Can you see any?</p>",
        "id": 454878378,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1722269564
    },
    {
        "content": "<p>I was using \"expected behaviour\" to mean \"this is what the tactic might be expected to do\", with no connotation of whether this was desirable or not.  I imagine that limiting the hypotheses to the ones initially available may make the tactic more performant.  I can also imagine that this is an oversight and the authors intended the <code>only</code> flag to just shield the initially available hypotheses, but not also \"new\" ones.  For this, we probably have to wait for the authors of the tactic to comment, I guess.</p>",
        "id": 454879531,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722269836
    },
    {
        "content": "<p>I, for one, would not have expected the tactic to use more hypotheses than the ones that I would give it, when using the <code>only</code> flag, but I do not have any experience with other proof assistants.</p>",
        "id": 454879773,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722269890
    },
    {
        "content": "<p>In fact, <code>solve_by_elim</code> introducing hypotheses at all came after the implementation of <code>only</code>, so this is just an oversight.</p>",
        "id": 459388260,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723186490
    },
    {
        "content": "<p>I think I agree that even with <code>only</code>, introduced hypotheses should be used.</p>",
        "id": 459388309,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723186502
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"733059\">@Claudio Sacerdoti Coen</span>, I'm not sure if you're interested in investigating, but I'd be open to reviewing a change to the tactic implementation to this effect.</p>",
        "id": 459388426,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723186529
    },
    {
        "content": "<p>Otherwise, you could open an issue! No promises for fast action on this one, however.</p>",
        "id": 459388493,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723186551
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I had opened the RFC <a href=\"https://github.com/leanprover/lean4/issues/4870\">https://github.com/leanprover/lean4/issues/4870</a></p>",
        "id": 459856094,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1723364346
    }
]