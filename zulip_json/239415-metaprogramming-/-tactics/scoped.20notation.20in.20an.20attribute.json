[
    {
        "content": "<p>In CSLib we have <a href=\"https://github.com/leanprover/cslib/blob/main/Cslib/Foundations/Semantics/ReductionSystem/Basic.lean#L91-L142\">a command and attribute</a> that creates notations. I would like to change these to be scoped the same as the declaration the attribute is applied to. On its own having <code>scoped notation3</code> in a macro is fine, but will not work from within an attribute. Is there a way I can manually specify the namespace the notation should use?</p>",
        "id": 546708344,
        "sender_full_name": "Chris Henson",
        "timestamp": 1761232712
    },
    {
        "content": "<p>I had the thought that I could manually assemble the <code>Lean.ParserDescr</code>, but there are several downsides to this:</p>\n<ul>\n<li>for <code>notation3</code>, this doesn't handle the generated delaborators</li>\n<li>even if I add the definition, I'm not sure how that gets registered as notation</li>\n<li>a bit annoying for maintainability</li>\n</ul>\n<p>What I feel I need is a way to pass to <code>scoped</code> (within an attribute/macro) what namespace it should be using.</p>",
        "id": 546769827,
        "sender_full_name": "Chris Henson",
        "timestamp": 1761253827
    },
    {
        "content": "<p>Does this work?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"s2\">\"reduction_notation\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">str</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span>\n<span class=\"w\">      </span><span class=\"bp\">$</span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"s2\">\" ⭢\"</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\">  </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t'</span>\n<span class=\"w\">      </span><span class=\"bp\">$</span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"s2\">\" ↠\"</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">MRed</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t'</span>\n<span class=\"w\">     </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span>\n<span class=\"w\">      </span><span class=\"bp\">$</span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"s2\">\" ⭢ \"</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\">  </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t'</span>\n<span class=\"w\">      </span><span class=\"bp\">$</span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"s2\">\" ↠ \"</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">MRed</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t'</span>\n<span class=\"w\">     </span><span class=\"o\">)</span>\n</code></pre></div>\n<p>(found by looking at <a href=\"https://github.com/leanprover-community/mathlib4/blob/cd0d35771eeffaaec105eb48ee56c978dc740766/Mathlib/Util/Notation3.lean#L520\">this line</a>)</p>",
        "id": 547254441,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761565113
    },
    {
        "content": "<p>Ah, that got me halfway there, thanks! Along with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.modifyScope#doc\">docs#Lean.Elab.Command.modifyScope</a>, I was able to make it work from within an attribute in <a href=\"https://github.com/leanprover/cslib/pull/133\">cslib#133</a>.</p>",
        "id": 547264514,
        "sender_full_name": "Chris Henson",
        "timestamp": 1761568162
    }
]