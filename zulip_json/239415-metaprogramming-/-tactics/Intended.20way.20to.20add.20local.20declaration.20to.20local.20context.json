[
    {
        "content": "<p>In my tactic, I'd like to add a <code>have</code> statement, which in my understanding means adding something to the LocalContext. Poking around that API, I see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.LocalContext.addDecl#doc\">docs#Lean.LocalContext.addDecl</a>, but this isn't meant to be used directly. I also see that I can do <code>evalTactic (‚Üê </code>(tactic| have ...))`, but this feels too high-level to be the right solution. What's the intended API / method for this?</p>",
        "id": 510804562,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744080083
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.intro1P#doc\">docs#Lean.MVarId.intro1P</a> probably</p>",
        "id": 510804733,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080197
    },
    {
        "content": "<p>see also <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Tactic.haveLetCore#doc\">docs#Mathlib.Tactic.haveLetCore</a></p>",
        "id": 510804825,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080244
    },
    {
        "content": "<p>I think you might be looking for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.assertHypotheses#doc\">docs#Lean.MVarId.assertHypotheses</a> and friends!</p>",
        "id": 510804837,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744080253
    },
    {
        "content": "<p>and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.assert#doc\">docs#Lean.MVarId.assert</a></p>",
        "id": 510804870,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080272
    },
    {
        "content": "<p>I don't think intro1P is what I'm looking for, but the other three suggestions look very helpful. What's the distinction between haveLetCore and assert(Hypotheses)?</p>",
        "id": 510804933,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744080322
    },
    {
        "content": "<p>haveLetCore is halfway to a tactic frontend, notice that it takes <code>Syntax</code> arguments</p>",
        "id": 510804972,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080359
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.note#doc\">docs#Lean.MVarId.note</a> is also basically <code>have</code>, using its ancient name</p>",
        "id": 510805075,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080409
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 510805112,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744080438
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/239415-metaprogramming-.2F-tactics/topic/Intended.20way.20to.20add.20local.20declaration.20to.20local.20context/near/510805075\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarID.note#doc\">docs#Lean.MVarID.note</a> is also basically <code>have</code>, using its ancient name</p>\n</blockquote>\n<p>Ohh, I was wondering about that!</p>",
        "id": 510805149,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1744080465
    },
    {
        "content": "<p>once upon a time <code>note</code> was the tactic and <code>have</code> was the term. We're talking lean 3.1 or so</p>",
        "id": 510805245,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080503
    },
    {
        "content": "<p><code>note</code> seems to do what I want, thank you! (Although it's slightly confusing to me that I'm changing the mvar, and I don't know what the first argument it returns is...)</p>",
        "id": 510805810,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744080874
    },
    {
        "content": "<p>most \"MetaM tactics\" take and return an MVarId</p>",
        "id": 510805888,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080953
    },
    {
        "content": "<p>that's basically your current goal state</p>",
        "id": 510805938,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080964
    },
    {
        "content": "<p>you thread it around explicitly, and the number of MVarIds you get back is the number of subgoals</p>",
        "id": 510805983,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744080995
    },
    {
        "content": "<p>Ah, including the local context. So the idea is that I'm meant to pass around this MVarId (presumably with the same name), and rewrite over the old ones? Isn't this exactly what a state monad is meant to handle for me?</p>",
        "id": 510806021,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744081034
    },
    {
        "content": "<p><code>note</code> returns an <code>FVarId</code> as well (which exists in the returned <code>MVarId</code> goal state), which refers to the hypothesis you've just created</p>",
        "id": 510806035,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081043
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Intended.20way.20to.20add.20local.20declaration.20to.20local.20context/near/510806021\">said</a>:</p>\n<blockquote>\n<p>Ah, including the local context. So the idea is that I'm meant to pass around this MVarId (presumably with the same name), and rewrite over the old ones? Isn't this exactly what a state monad is meant to handle for me?</p>\n</blockquote>\n<p>Yes, that state monad is called <code>TacticM</code></p>",
        "id": 510806053,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081058
    },
    {
        "content": "<p>but what you lose with that monad is type soundness wrt subgoals as I mentioned. You can't tell the difference between a tactic that solves the goal and one which operates on two goals and produces three subgoals, they all have the same type</p>",
        "id": 510806189,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081140
    },
    {
        "content": "<p>Right okay, this is why the input type of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.liftMetaFinishingTactic#doc\">docs#Lean.Elab.Tactic.liftMetaFinishingTactic</a> is what it is</p>",
        "id": 510806250,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744081188
    },
    {
        "content": "<p>and you are never really sure whether you even have a main goal</p>",
        "id": 510806258,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081192
    },
    {
        "content": "<p>which impacts how type checking works since every expression has to elaborate in the context of the appropriate goal</p>",
        "id": 510806351,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081233
    },
    {
        "content": "<p>I think I see, so the state monad I wanted does exist but it's more precise in some sense to handle these things by hand</p>",
        "id": 510806435,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744081292
    },
    {
        "content": "<p>same thing with FVarIds, the local context is stored in the state but you want to hold on to FVarIds as \"handles\" to them so that you don't get confused and have to go find them again by name and worry about shadowing and not finding the right one later etc</p>",
        "id": 510806622,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081401
    },
    {
        "content": "<p>Just to be clear, the local context is stored in the state of MetaM (which I presume is some ReaderT/StateT/IO stack), or in the state of TacticM? edit, just found the answer to this in the metaprogramming book, it's in the state of MetaM</p>",
        "id": 510806774,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744081460
    },
    {
        "content": "<p>The local context is in the read only state of MetaM</p>",
        "id": 510806816,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081495
    },
    {
        "content": "<p>this is why anything that changes the local context will be in a callback shape</p>",
        "id": 510806855,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081518
    },
    {
        "content": "<p>Am I to read that as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ReaderT.adapt#doc\">docs#ReaderT.adapt</a>, or something else? I don't quite see the callback shape in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.note#doc\">docs#Lean.MVarId.note</a>, unless it's the MVarId passing (and even then I don't really see how that's a callback shape)</p>",
        "id": 510806997,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744081587
    },
    {
        "content": "<p>ah, good point</p>",
        "id": 510807072,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081642
    },
    {
        "content": "<p>I believe it actually isn't changing the local context (it can't), which means you probably have to do <code>mvar.withContext</code> immediately after the <code>note</code> call on the mvar you get back if you want to make use of the fvarid and generally do things in the new context</p>",
        "id": 510807174,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081698
    },
    {
        "content": "<p>and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.withContext#doc\">docs#Lean.MVarId.withContext</a> is hopefully more obviously in a callback shape</p>",
        "id": 510807255,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744081779
    },
    {
        "content": "<p>I think this makes sense, thanks!</p>",
        "id": 510807492,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744081940
    }
]