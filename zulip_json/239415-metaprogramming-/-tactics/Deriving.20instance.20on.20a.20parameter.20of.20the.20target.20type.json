[
    {
        "content": "<p>Is there a written example somewhere of what it would look like to write a deriving handlers that derives some instances on a <em>parameter</em> of the target type a declaration?</p>\n<p>To give some context, in Mathlib we have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Functor.FullyFaithful#doc\">docs#CategoryTheory.Functor.FullyFaithful</a> as a (non-instance) structure which allows to define two instances of the Prop-classes <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Functor.Full#doc\">docs#CategoryTheory.Functor.Full</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Functor.Faithful#doc\">docs#CategoryTheory.Functor.Faithful</a> via declarations <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Functor.FullyFaithful.full#doc\">docs#CategoryTheory.Functor.FullyFaithful.full</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Functor.FullyFaithful.faithful#doc\">docs#CategoryTheory.Functor.FullyFaithful.faithful</a>. To learn a few new things I’d like to have a go at writing a <code>deriving</code> handler that would let me write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fullyFaithfulFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">FullyFaithful</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">blah</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Functor</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">…</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">FullAndFaithful</span><span class=\"w\"> </span><span class=\"c1\">-- Automatically derives blah.Full and blah.Faithful</span>\n</code></pre></div>\n<p>and avoid having to manually register the two instances manually each time (which is what we do in Mathlib currently). But from what I could read and my limited understanding of metaprogramming, all of the examples I see about deriving handlers are about deriving stuff on inductive types, so I have a bit of trouble understanding how I would go at adapting them to this kind of situation.<br>\nFirst: is this a good use case for a <code>deriving</code> handler ?<br>\nIf yes, any pointers/code to learn form (even vague) to achieve this kind of stuff?</p>",
        "id": 574384495,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1771362245
    },
    {
        "content": "<p>I don't know how <code>deriving</code> handlers are implemented, but I'm wondering what the advantage is of <code>deriving</code> over an attribute, like in <code>@[to_additive]</code> or <code>@[to_fun]</code>.</p>",
        "id": 574537204,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771428697
    },
    {
        "content": "<p>I think better deriving handlers would be great, especially if we find ourselves needing to implement lots of structure wrappers for some reason...</p>",
        "id": 574537677,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1771428834
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Deriving.20instance.20on.20a.20parameter.20of.20the.20target.20type/near/574537204\">said</a>:</p>\n<blockquote>\n<p>I don't know how <code>deriving</code> handlers are implemented, but I'm wondering what the advantage is of <code>deriving</code> over an attribute, like in <code>@[to_additive]</code> or <code>@[to_fun]</code>.</p>\n</blockquote>\n<p>Yes, my \"backup plan\" would be an attribute using <code>addRelatedDecl</code>, but I wanted this as a occasion to learn more about the inner workings. I think for the functionality of automatically declaring these instances, both would be pretty similar.</p>",
        "id": 574537853,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1771428880
    },
    {
        "content": "<p>My intuition of <code>def foo deriving Bar</code> is that it will generate an instance of <code>Bar foo</code>. Your example doesn't fit into this pattern, so I would find it a bit confusing.</p>",
        "id": 574538139,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771428952
    }
]