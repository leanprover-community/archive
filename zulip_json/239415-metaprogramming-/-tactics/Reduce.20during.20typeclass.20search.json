[
    {
        "content": "<p>Is there some way to make Lean reduce terms while doing typeclass search? I was doing some logic programming using typeclasses, for no real reason aside from seeing if it was possible, and was wondering if there was some hidden option somewhere which might make the typechecker reduce before it looks for matching instances? </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Reflect</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">is_true</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Reflect</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"bp\">⟩</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Reflect</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- It can synthesize an instance for Reflect (5 == 5) when it reduces first</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ReflectClient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n1</span><span class=\"w\"> </span><span class=\"n\">n2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n1</span><span class=\"w\"> </span><span class=\"n\">n2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Reflect</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n1</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">n2</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReflectClient</span><span class=\"w\"> </span><span class=\"n\">n1</span><span class=\"w\"> </span><span class=\"n\">n2</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"c1\">-- set_option trace.Meta.synthInstance true</span>\n<span class=\"c1\">-- check #synth ReflectClient 5 5</span>\n<span class=\"c1\">-- [Meta.synthInstance] ❌️ ReflectClient 5 5</span>\n<span class=\"c1\">--   [Meta.synthInstance] new goal ReflectClient 5 5</span>\n<span class=\"c1\">--     [Meta.synthInstance.instances] #[@instReflectClientOfReflectBeqNat]</span>\n<span class=\"c1\">--   [Meta.synthInstance] ✅️ apply @instReflectClientOfReflectBeqNat to ReflectClient 5 5</span>\n<span class=\"c1\">--     [Meta.synthInstance.tryResolve] ✅️ ReflectClient 5 5 ≟ ReflectClient 5 5</span>\n<span class=\"c1\">--     [Meta.synthInstance] no instances for Reflect (5 == 5)   -- Doesn't reduce so doesn't find an instance</span>\n<span class=\"c1\">--       [Meta.synthInstance.instances] #[]</span>\n<span class=\"c1\">--   [Meta.synthInstance] result &lt;not-available&gt;</span>\n</code></pre></div>",
        "id": 520530122,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1748293512
    },
    {
        "content": "<p>Two things are needed here:</p>\n<ol>\n<li><code>instance : Reflect (no_index true) := ⟨rfl⟩</code>. Without <code>no_index</code> it will only consider this instance if it's already <code>true</code> before reduction</li>\n<li>Use more reducible functions like <code>n1.beq n2</code></li>\n</ol>\n<p>I have honestly no clue why the first one succeeded lol</p>",
        "id": 520584130,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748325211
    },
    {
        "content": "<p>I think the first one succeeding is not typeclass search doing something but the <code>#synth</code> command doing something special</p>",
        "id": 520584241,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748325263
    },
    {
        "content": "<p>Gabriel Ebner pointed out this trick awhile ago:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">When</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">When</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">When</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>This allows adding <code>[When (m &lt; n)]</code> instances for example.</p>\n<p>This works because Lean does more reduction for implicit arguments. Maybe you can make use of this somehow?</p>",
        "id": 520585210,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748325724
    },
    {
        "content": "<p>This needs <code>no_index</code> as well though, no?</p>",
        "id": 520585788,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748325968
    },
    {
        "content": "<p>Hmm no? Weird</p>",
        "id": 520585828,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748326000
    },
    {
        "content": "<p>Oh it's an instance argument</p>",
        "id": 520585883,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748326031
    },
    {
        "content": "<p>Yeah, makes sense</p>",
        "id": 520585894,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748326036
    },
    {
        "content": "<p>this seems similar to <code>Fact</code> for some reason...</p>",
        "id": 520641726,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1748344631
    },
    {
        "content": "<p>but i guess it's different (crucially for this topic) due to the instance argument in the type</p>",
        "id": 520642092,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1748344748
    },
    {
        "content": "<p>The <code>When</code> trick seems to work! Super clever, thanks all :)</p>",
        "id": 520880294,
        "sender_full_name": "Markus de Medeiros",
        "timestamp": 1748435394
    }
]