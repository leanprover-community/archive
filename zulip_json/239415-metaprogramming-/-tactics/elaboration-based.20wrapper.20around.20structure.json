[
    {
        "content": "<p>I am trying to write a macro that, as part of other things that it does, produces a structure definition. For reasons not included in the simplified example I've given, my macro runs at elaboration time: (I've tried searching for this, but no hits pop up for a kernal message \"(kernel) constant has already been declared\").</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"mystructure \"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" where \"</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">structFields</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mystructure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">structFields</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">     </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)))</span>\n\n<span class=\"n\">mystructure</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">   </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>\n<p>This fails with the error \"(kernel) constant has already been declared\".</p>",
        "id": 484136825,
        "sender_full_name": "Kiran",
        "timestamp": 1732439935
    },
    {
        "content": "<p>What made you try <code>TSyntax.mk t.raw</code>? The expected type at that point is <code>TSyntax `structCtor</code>, that doesn't sound like something we should squeeze <code>structFields</code> into to me</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mystructure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">structFields</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">     </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">structFields</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 484137593,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1732440607
    },
    {
        "content": "<p>Note that elab_rules vs macro_rules doesn't make any difference here</p>",
        "id": 484137658,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1732440685
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/elaboration-based.20wrapper.20around.20structure/near/484137593\">said</a>:<br>\nAh, my bad, sorry, yeah, that fixes it! for whatever reason I coerced it into structCtor earlier.</p>",
        "id": 484137857,
        "sender_full_name": "Kiran",
        "timestamp": 1732440880
    }
]