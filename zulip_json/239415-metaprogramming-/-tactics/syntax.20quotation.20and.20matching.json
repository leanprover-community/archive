[
    {
        "content": "<p>in a study group the following question came up:<br>\nwe can match on syntax using syntax quotations without issue. However, when trying to <code>#check</code> the syntax quotation, we couldn't figure out how to get it to actually be of type <code>Syntax</code>.<br>\nmodifying an example from the metaprogramming book:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isAdd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works, `(Nat.add $x $y) somehow becomes of type Syntax</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fails, some large type mismatch</span>\n</code></pre></div>\n<p>Could someone explain what enables this jump in behaviour?</p>",
        "id": 509622039,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743579354
    },
    {
        "content": "<p>Does it work if you add <code>return</code>?</p>",
        "id": 509628056,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743581122
    },
    {
        "content": "<p>The syntax quotations are somewhat monadic, so you may have to enable that.</p>",
        "id": 509628153,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743581146
    },
    {
        "content": "<p>the weird thing we don't get is that <em>you don't need to write <code>return</code> when matching</em></p>",
        "id": 509628444,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743581214
    },
    {
        "content": "<p>Yes, there is some extra voodoo going on there.</p>",
        "id": 509628524,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743581238
    },
    {
        "content": "<p>For instance, you cannot mix quotations and normal matching.</p>",
        "id": 509628563,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743581255
    },
    {
        "content": "<p>does that mean that the notation for matching on syntax quotations is different from the \"usual\" matching syntax? or just that the elaborator makes this distinction?</p>",
        "id": 509653500,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743588459
    },
    {
        "content": "<p>this is really surprising</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isAdd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works, `(Nat.add $x $y) somehow becomes of type Syntax</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- unused variable!!!!!</span>\n</code></pre></div>",
        "id": 509654038,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743588638
    },
    {
        "content": "<p>so yes, you indeed cannot mix them</p>",
        "id": 509654173,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743588695
    },
    {
        "content": "<p>Quotations have type <code>[Monad m] [MonadQuotation m] =&gt; m (TSyntax _)</code>, in order to attach macro scopes and position information to the generated syntax.</p>",
        "id": 509656068,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743589291
    },
    {
        "content": "<p>There's a special <code>match</code> elaborator that's just for the case when syntax quotations are detected among the patterns. Entry point: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.Quotation.elabMatchSyntax#doc\">docs#Lean.Elab.Term.Quotation.elabMatchSyntax</a></p>",
        "id": 509665637,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743592190
    },
    {
        "content": "<p><code>#check (`(Nat.add 1 1) : Lean.Meta.MetaM Syntax)</code> works</p>",
        "id": 509666428,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743592432
    },
    {
        "content": "<p>yea, we figured that much, the confusion was why the match syntax was allowed</p>",
        "id": 509666607,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743592478
    }
]