[
    {
        "content": "<p>I am trying a small example based on the first example of the <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/06_macros.html\">macro section</a> of the metaprogramming book for Lean4, and I'm guetting an error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xorMacro</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"s2\">\" ⊕ \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">xorMacro</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">xorMacroImpl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">!$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!$</span><span class=\"n\">r</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n\n<span class=\"c1\">-- Overload error, don't know how to disambiguate in this case</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- false</span>\n</code></pre></div>\n<p>From the error I understand it thinks I'm declaring a sum type:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">overloaded</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">errors</span>\n<span class=\"w\">  </span><span class=\"n\">elaboration</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">xorMacro'</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">implemented</span>\n<span class=\"w\">    </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"w\">  </span><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">    </span><span class=\"n\">Sum</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">argument</span>\n<span class=\"w\">    </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">    </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">    </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">687</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">687</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>What's the idiomatic way to go around this issue?</p>",
        "id": 473719304,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1727700765
    },
    {
        "content": "<p>The first part of the error message tells you that something is wrong with the macro (and so Lean then takes the next possible interpretation of <code>⊕</code> and throws a type error). Let me try to fix this...</p>",
        "id": 473743486,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727705068
    },
    {
        "content": "<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"s2\">\" ⊕ \"</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">!$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!$</span><span class=\"n\">r</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- false</span>\n</code></pre></div>",
        "id": 473744231,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727705227
    },
    {
        "content": "<p>I think this issue is caused by the fact that you can't have an overloaded operator with a macro and elab implementation. Adding <code>(priority := high)</code> or using another symbol makes it work as expected</p>",
        "id": 473745607,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727705512
    },
    {
        "content": "<p>Shouldn't my version with the <code>macro</code> sugar then also fail?</p>",
        "id": 473751650,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727706471
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> <a href=\"#narrow/stream/239415-metaprogramming-.2F-tactics/topic/Small.20error.20disambiguating.20macro/near/473751650\">said</a>:</p>\n<blockquote>\n<p>Shouldn't my version with the <code>macro</code> sugar then also fail?</p>\n</blockquote>\n<p>I would imagine as well, unless <code>macro</code> also creates an elab implementation?</p>",
        "id": 473753790,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1727706866
    },
    {
        "content": "<p>Thank you for the other example <span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> . Now I'm curious why yours work and the other doesn't haha.</p>",
        "id": 473753996,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1727706908
    },
    {
        "content": "<p>It's surprisingly subtle! I was very confused here because <code>macro_rules</code> wasn't agreeing with its own direct macro expansion:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xorMacro</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"s2\">\" ⊕ \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xorMacro</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">!$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!$</span><span class=\"n\">r</span><span class=\"o\">))</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n<span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">xorMacro</span><span class=\"kd\">]</span>\n<span class=\"n\">aux_def</span><span class=\"w\"> </span><span class=\"n\">macroRules</span><span class=\"w\"> </span><span class=\"n\">xorMacro</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">!$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!$</span><span class=\"n\">r</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">no_error_if_unused</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">Exception</span><span class=\"bp\">.</span><span class=\"n\">unsupportedSyntax</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">aux_Mathlib_Test___macroRules_xorMacro_1</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">aux_Mathlib_Test___macroRules_xorMacro_2</span>\n</code></pre></div>",
        "id": 473763110,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727708601
    },
    {
        "content": "<p>If you compare the two generated definitions, you will see that the difference is that in the second one, the subexpression <code> `($l:term ⊕ $r:term)</code> (the pattern in the pattern match) contains a choice node, which will cause it to fail to work correctly. There is some code in <code>elabMacroRules</code> which deletes these choice nodes from the syntax, resulting in syntax which you cannot type directly, a reference to the \"correct\" <code>⊕</code> overload, making the pattern match work as expected.</p>",
        "id": 473764257,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727708759
    },
    {
        "content": "<p>Oh that's a bit weird, having a choice node in a pattern. Thank you for investigating!</p>",
        "id": 473825748,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727722346
    },
    {
        "content": "<p>oh wow</p>",
        "id": 474225291,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1727856145
    },
    {
        "content": "<p>Do you know where that choice node comes from? is it just part of the match?</p>",
        "id": 474225422,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1727856180
    },
    {
        "content": "<p>ty btw <span aria-label=\"ok\" class=\"emoji emoji-1f44c\" role=\"img\" title=\"ok\">:ok:</span></p>",
        "id": 474225440,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1727856187
    },
    {
        "content": "<p>The choice node arises because the <code>syntax</code> declaration is overloading another <code>syntax</code> declaration for this same syntax defined in core (for <code>Sum</code>, as you can see in the error messages). If you really want to use this syntax, I would suggest to skip the <code>syntax</code> declaration entirely and only define a <code>macro_rules</code> (not a <code>macro</code> which is <code>syntax</code> + <code>macro_rules</code>) so that the parser doesn't have to disambiguate between two identical grammar productions</p>",
        "id": 474243013,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727860844
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479841\">Tomás Díaz</span> has marked this topic as resolved.</p>",
        "id": 474243132,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727860886
    }
]