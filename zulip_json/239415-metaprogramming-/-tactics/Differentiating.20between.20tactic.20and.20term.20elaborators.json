[
    {
        "content": "<p>I am running into an annoying error that I don't know how to resolve. Here is a MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fooTacStx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"c1\">--syntax (name := tooTermStx) \"foo%\" str term : term &lt;&lt;--- uncomment for error below.</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">fooTacStx</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">elabExplainTac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"n\">foo</span><span class=\"bp\">%$</span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>\n<p>If you uncomment the indicated line, the elaborator results in an error at the location token <code>tk</code>, I suppose because Lean gets confused about <code>foo%</code>. Is there a way around this, or do I just need to use different names for the tactic foo and the term elaborator <code>foo%</code>?</p>",
        "id": 483951368,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732294368
    },
    {
        "content": "<p>Is defining <code>foo%</code> after the elaborator an option?</p>",
        "id": 483952051,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732294613
    },
    {
        "content": "<p>I guess, but that seems more like a hack than a fix.</p>",
        "id": 483952101,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732294630
    },
    {
        "content": "<p>It feels like a better hack than choosing different names</p>",
        "id": 483952239,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732294682
    },
    {
        "content": "<p>Yeah I agree with that.</p>",
        "id": 483952296,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732294695
    },
    {
        "content": "<p>Idealy something like <code>$[foo]%$tk</code> would work here to disambiguate</p>",
        "id": 483952301,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732294696
    },
    {
        "content": "<p>I've also wanted <code>$[foo $x]%$tk</code> in the past to refer to <code>group</code>s</p>",
        "id": 483952430,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732294741
    },
    {
        "content": "<p>FWIW, I'm using <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> 's hack in <a href=\"https://github.com/leanprover-community/mathlib4/pull/19378\">#19378</a> (this is tagged with RFC for now)</p>",
        "id": 483955147,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732295593
    },
    {
        "content": "<p>(This is based on a discussion I had with <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> earlier today, in case he wants to take a look)</p>",
        "id": 483955342,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732295660
    },
    {
        "content": "<p>I am not sure of the consequences, but this also \"resolves\" the error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tooTermStx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"s2\">\"%\"</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"c1\">--&lt;&lt;--- uncomment for error below.</span>\n</code></pre></div>",
        "id": 483959334,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732297069
    },
    {
        "content": "<p>Can you use the same notation for both cases?</p>",
        "id": 483959450,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732297101
    },
    {
        "content": "<p>you mean <code>explain ...</code> for both the tactic and term I suppose?</p>",
        "id": 483961316,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732297719
    },
    {
        "content": "<p>and yes, I agree with your comment on the PR that <code>explain ... in ...</code> is nicer :)</p>",
        "id": 483961364,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732297736
    },
    {
        "content": "<p>Yes, in the same way that we have <code>set_option .. in</code> for both tactics and terms</p>",
        "id": 483961775,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732297864
    },
    {
        "content": "<p>(there might also be some pretty-printer instructions about indenting the term after <code>in</code> you can copy from elsewhere)</p>",
        "id": 483961856,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732297900
    },
    {
        "content": "<p>Hmm ok I'll try to look into that.</p>",
        "id": 483962006,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732297938
    },
    {
        "content": "<p>If you have somewhere you can point me to that would be very helpful</p>",
        "id": 483962050,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732297951
    },
    {
        "content": "<p>An example I know of that has such a pretty printing hint is <a href=\"https://leanprover-community.github.io/mathlib4_docs/Batteries/Util/ProofWanted.html#proof_wanted\">proof_wanted</a>, but I'm sure there are other more relevant examples.</p>",
        "id": 483963554,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732298478
    },
    {
        "content": "<p><code>count_heartbeats</code> starts with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"count_heartbeats! \"</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:(</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"s2\">\"in\"</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"n\">tac</span><span class=\"o\">:</span><span class=\"n\">tacticSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n</code></pre></div>",
        "id": 483963916,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732298592
    },
    {
        "content": "<p>I think that <code>ppLine</code> instructs the pretty-printer to use a new line.</p>",
        "id": 483963979,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732298612
    },
    {
        "content": "<p>yeah, I do think <code>ppIndent</code> is more appropriate here, right?</p>",
        "id": 483964015,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732298626
    },
    {
        "content": "<p>we want </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">explain</span><span class=\"w\"> </span><span class=\"s2\">\"this\"</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"n\">that</span>\n</code></pre></div>\n<p>as opposed to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">explain</span><span class=\"w\"> </span><span class=\"s2\">\"this\"</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">that</span>\n</code></pre></div>",
        "id": 483964161,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732298662
    },
    {
        "content": "<p>Probably.  I would also say that in count_heartbeats there should be a space after <code>num</code>, if <code>num</code> is present.</p>",
        "id": 483964175,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732298666
    },
    {
        "content": "<p>Btw, I think that the <code>ppRountrip</code> linter may have an option to show the pp version of a command.</p>",
        "id": 483964242,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732298689
    },
    {
        "content": "<p>It certainly compares the current version with what the pretty-printer thinks that it should be,</p>",
        "id": 483964318,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732298713
    },
    {
        "content": "<p>Okay, I'll play around with this when I have time to do so (not now unfortunately)</p>",
        "id": 483964397,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732298738
    },
    {
        "content": "<p>Hmm, the ppRoundtrip was just some debugging command that did not make it to the final version, but that was just a convenience: it is easy enough to log the syntax anyway.</p>",
        "id": 483964629,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732298820
    },
    {
        "content": "<p>In case you still need it <span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span>, one workaround is to index the syntax directly (ew)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">fooTacStx</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabExplainTac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>",
        "id": 483975568,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1732303191
    },
    {
        "content": "<p>ew is right :-/</p>",
        "id": 483989292,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732308640
    },
    {
        "content": "<p>What I find surprising is that I would expect lean to <em>know</em> that <code>foo% ...</code> is not valid syntax is the <code>tactic</code> syntax category because no such tactic syntax was declared, yet it still gets confused.</p>",
        "id": 483989525,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732308742
    },
    {
        "content": "<p>It's because when you define a term, <code>foo%</code> becomes a keyword, and keywords are keywords for all time in all contexts.</p>",
        "id": 483992405,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1732310137
    },
    {
        "content": "<p>(It's worth pointing out that tactics are special: when you define them the initial token does not become a keyword. It's like it inserts <code>&amp;</code> automatically.)</p>",
        "id": 483992522,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1732310196
    },
    {
        "content": "<p>Should we reconsider the <code>%</code> convention for term elaborators?</p>",
        "id": 483996094,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732311869
    },
    {
        "content": "<p>I'd prefer that the quotation syntax gain some grouping operator to make this a non-issue, such as</p>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Differentiating.20between.20tactic.20and.20term.20elaborators/near/483952430\">said</a>:</p>\n<blockquote>\n<p>I've also wanted <code>$[foo $x]%$tk</code> in the past to refer to <code>group</code>s</p>\n</blockquote>",
        "id": 483996225,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732311942
    },
    {
        "content": "<p>Though separately, I've heard that the <code>foo%</code> convention was intended to mean \"this is an implementation detail\" not \"this is a term elaborator\"</p>",
        "id": 483996336,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732311990
    },
    {
        "content": "<p>Is that really the case? There are many instances of <code>reassoc_of%</code> being used in mathlib.</p>",
        "id": 483999489,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732313451
    },
    {
        "content": "<p>If <code>%</code> is an implementation detail, do we even have a convention for term elaborators?</p>",
        "id": 483999569,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1732313489
    },
    {
        "content": "<p>I think the context of that rumor was that core intended <code>%</code> to mean implementation detail, and mathlib adopted it to mean term elaborator</p>",
        "id": 484002200,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732314942
    },
    {
        "content": "<p>I think it's nice when there's <em>some</em> sort of indication so you know \"ceci n'est pas une fonction\"</p>\n<p>For example, the <code>congr(...)</code> term uses parentheses with no whitespace, so you know it has to be something special.</p>",
        "id": 484006130,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1732317116
    },
    {
        "content": "<p>Taking that to its extreme though we end up with <code>return(x)</code> instead of <code>return x</code></p>",
        "id": 484006311,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732317208
    },
    {
        "content": "<p>Core language keywords are special though, since they don't vary project to project (plus that's a doElem not a term)</p>",
        "id": 484006786,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1732317498
    },
    {
        "content": "<p>To some extent though the syntax highlighting acts as the indication that something is not a function</p>",
        "id": 484007774,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732318103
    },
    {
        "content": "<p>Though it would be helpful if all such keywords had the same parsing precedence (<code>unsafe</code> and <code>no_index</code> disagreeing gets me every time)</p>",
        "id": 484007802,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732318129
    }
]