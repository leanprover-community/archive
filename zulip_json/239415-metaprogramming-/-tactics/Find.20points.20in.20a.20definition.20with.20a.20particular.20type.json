[
    {
        "content": "<p>I have a situation where i have an Term of a given type, I want to find all points at which within subterms it has another type lets say given the prior defn:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">CoList</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">CoList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">CoList</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>and the term <code>.cons n x : CoList nat</code>, if the type I am looking for is <code>CoList nat</code> then it would yield the entire term and x, is something like this possible or should I try to take a different approach?</p>\n<p>The reasons behind why I want to do this are quite strange but also fun, I need to transform applications of constructors like <code>CoList.cons hd tl</code> with this transformed structure <code>Other.cons hd (.inr tl)</code> and i do not quite know how to go about doing this in practice.</p>",
        "id": 454252462,
        "sender_full_name": "William Sørensen",
        "timestamp": 1721985184
    },
    {
        "content": "<p>Also would this be possible with <code>Expr</code>s maybe instead of <code>Term</code>s as I am aware there is type infrastructure for these at least. Anything really goes</p>",
        "id": 454253598,
        "sender_full_name": "William Sørensen",
        "timestamp": 1721985489
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"736115\">@William Sørensen</span> Would <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.kabstract#doc\">docs#Lean.Meta.kabstract</a> be useful here? This can be used to replace all occurrences of a certain pattern in an expression with another one. This function is used in implementing Lean's <code>rw</code> tactic.</p>",
        "id": 463722628,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1724165400
    },
    {
        "content": "<p>thanks for the tip, i will take a look. I ended up making this goofy function that uses unification to detect where it would be required but i wasnt able to finish it as i had some situations where a partially applied expression would unify but not the raw expression, maybe this would be useful though</p>",
        "id": 463982623,
        "sender_full_name": "William Sørensen",
        "timestamp": 1724229191
    },
    {
        "content": "<p>Maybe you could apply each partially applied expression to meta-variable arguments and then try unifying.</p>",
        "id": 464028899,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1724241398
    },
    {
        "content": "<p>This is what i am currently trying, but i dont know if unification would be able to figure out the dependent type thats needed. well see though</p>",
        "id": 464053453,
        "sender_full_name": "William Sørensen",
        "timestamp": 1724246014
    },
    {
        "content": "<p>Can you just use <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Expr.html#Lean.Expr.foldlM\">https://leanprover-community.github.io/mathlib4_docs/Lean/Expr.html#Lean.Expr.foldlM</a> to replace, and the appropriate meta functions for type inference and checking what the constructor application is, etc.? You walk (and can map) over all subterms during the fold and just see whether they're applications of <code>.cons</code> and replace them if they are.</p>",
        "id": 464157857,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1724270953
    }
]