[
    {
        "content": "<p>Given two <code>Expr</code>s (in my specific use case, one is <code>tgtDecl.type</code> for a certain <code>tgtDecl : ConstantInfo</code> and the other is generated from another <code>decl : Constantinfo</code> via the <code>to_additive</code> machinery), is there an easy way to check whether they're defeq?</p>\n<p>I tried the obvious thing of using <code>isDefEq expr1 expr2</code> but ran into the issue (mentioned as a possibility by <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> in <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/Checking.20defeq.20in.20Command/near/389770725\">#lean4 &gt; Checking defeq in Command @ üí¨</a> ) that the unverse variables sometimes happen to have different names which then causes the defeq check to fail. </p>\n<p>This is extracted from <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Order.20dual.20tactic/near/505520343\">#mathlib4 &gt; Order dual tactic @ üí¨</a>.  <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>  did give some suggestions in that thread but due to my inexperience I wasn't able to turn them into concrete code. Sorry!</p>",
        "id": 506000231,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1742161892
    },
    {
        "content": "<p>Given that they are both from ConstantInfos, we have the lists of universe level parameters available ‚Äî¬†do you expect the universe levels to match up, or do you think they're going to be permutations?</p>",
        "id": 506000400,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742162039
    },
    {
        "content": "<p>If the match up, we could start by renaming all the levels in one of the expressions, and then go ahead with isDefEq.</p>",
        "id": 506000533,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742162143
    },
    {
        "content": "<p>Good question; I can't think of any cases where they would end up permuted, but maybe I'm missing some bizarre use case.</p>",
        "id": 506000538,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1742162150
    },
    {
        "content": "<p>If you zip up the parameter lists to make the mapping, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Expr.replaceLevel#doc\">docs#Lean.Expr.replaceLevel</a> seems useful</p>",
        "id": 506000683,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742162252
    },
    {
        "content": "<p>Actually, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Expr.instantiateLevelParams#doc\">docs#Lean.Expr.instantiateLevelParams</a> seems even better</p>",
        "id": 506000777,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742162320
    },
    {
        "content": "<p><code>Expr.initiateLevelParams decl.type decl.levelParams (tgtDecl.levelParams.map mkLevelParam)</code></p>",
        "id": 506000841,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742162395
    },
    {
        "content": "<p>Or <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ConstantInfo.instantiateTypeLevelParams#doc\">docs#Lean.ConstantInfo.instantiateTypeLevelParams</a>, which lets you write <code>decl.initiateTypeLevelParams (tgtDecl.levelParams.map mkLevelParam)</code></p>",
        "id": 506000982,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742162453
    },
    {
        "content": "<p>Awesome! I ended up going with the first variant:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- Run applyReplacementFun on the type of given `srcDecl` and return the resulting `Expr` -/</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">checkDeclType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BundledExtensions</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">tgt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">srcDecl</span><span class=\"w\"> </span><span class=\"n\">tgtDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ConstantInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">reorder</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">srcDecl.updateName</span><span class=\"w\"> </span><span class=\"n\">tgt</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">reorder.flatten</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decl.updateLevelParams</span><span class=\"w\"> </span><span class=\"n\">decl.levelParams.swapFirstTwo</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decl_type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decl.type.instantiateLevelParams</span>\n<span class=\"w\">    </span><span class=\"n\">decl.levelParams</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tgtDecl.levelParams.map</span><span class=\"w\"> </span><span class=\"n\">mkLevelParam</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">applyReplacementFun</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">reorderForall</span><span class=\"w\"> </span><span class=\"n\">reorder</span>\n<span class=\"w\">    </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">expand</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">unfoldAuxLemmas</span><span class=\"w\"> </span><span class=\"n\">decl_type</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">‚ü®</span><span class=\"n\">exp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">exp</span><span class=\"w\"> </span><span class=\"n\">tgtDecl.type</span><span class=\"o\">‚ü©</span>\n</code></pre></div>\n<p>This now works perfectly on all the examples that were failing before! Thanks so much!</p>",
        "id": 506003951,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1742164830
    }
]