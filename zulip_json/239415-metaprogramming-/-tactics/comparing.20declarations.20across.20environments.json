[
    {
        "content": "<p>I have an autograder for checking student homework assignments written in Lean. Proofs are easy: check that the declaration's type matches what we expect and that the body doesn't contain any disallowed axioms. Checking definitions is harder (theoretically undecidable and technically more complicated). To check a student's definition <code>defProblem</code>, we want to do something like, take the body <code>submission</code> of the student's definition, the body <code>reference</code> of our solution, set up a goal <code>submission = reference</code>, and try to prove it with some custom tactic.</p>\n<p>But we need to choose an environment in which to set up this goal. And since either or both definitions may refer to aux declarations (generated or user defined), we can't assume that either environment is an extension of the other. Even worse the two solutions could refer to different aux declarations with the same name. So the naive approach of just copying <code>submission</code> into the environment of <code>reference</code> fails unless the definitions are reasonably simple. (This isn't just hypothetical, we hit it very quickly.)</p>\n<p>The way I can see to fix this is to recursively copy <code>submission</code> into the <code>reference</code> environment, renaming any name conflicts that aren't defeq to the existing versions. We'd also have to copy equational lemmas if we want to use <code>simp</code> to discharge goals. </p>\n<p>This sounds moderately annoying so I wanted to ask if anyone had a better idea, or existing work that does this kind of environment embedding. It sounds somewhat similar to some of the stuff that happened in the Lean 3 -&gt; Lean 4 port (<span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> ?)</p>",
        "id": 474839577,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728053336
    },
    {
        "content": "<p>Why not just make the reference implementation live inside a <code>__NoStudentWillGuessThis</code> namespace</p>",
        "id": 474839802,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728053412
    },
    {
        "content": "<p>you can probably also use hygienic names by putting it all in a macro</p>",
        "id": 474839932,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728053464
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/239415-metaprogramming-.2F-tactics/topic/comparing.20declarations.20across.20environments/near/474839802\">said</a>:</p>\n<blockquote>\n<p>Why not just make the reference implementation live inside a <code>__NoStudentWillGuessThis</code> namespace</p>\n</blockquote>\n<p>Hmm, yeah, that would solve the name clash problem. Right now the autograder assumes solution and submission names line up so it introduces an alignment issue but that's easy enough to handle.</p>",
        "id": 474840792,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728053744
    },
    {
        "content": "<p>I mean they can't have the <em>same</em> name otherwise you would have a name clash</p>",
        "id": 474840958,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728053782
    },
    {
        "content": "<p>like you wrote <code>submission = reference</code> and not <code>submission = submission</code></p>",
        "id": 474841036,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728053805
    },
    {
        "content": "<p>Right now we aren't actually creating a new declaration when we copy <code>submission</code> over, we just take the body</p>",
        "id": 474841100,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728053824
    },
    {
        "content": "<p>so it's more like <code>submission = &lt;body of reference&gt;</code>?</p>",
        "id": 474841169,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728053843
    },
    {
        "content": "<p>Right</p>",
        "id": 474841181,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728053848
    },
    {
        "content": "<p>Or maybe even <code>&lt;body of submission&gt; = &lt;body of reference&gt;</code></p>",
        "id": 474841349,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728053884
    },
    {
        "content": "<p>if the autograder knows about the <code>__NoStudentWillGuessThis</code> namespace you can use name coincidences with and without it to form your alignment, so the only thing you have to do to mark the reference side is to add a <code>namespace __NoStudentWillGuessThis</code> at the top of the file</p>",
        "id": 474841535,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728053935
    },
    {
        "content": "<p>you may even be able to do it automatically</p>",
        "id": 474841585,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728053949
    },
    {
        "content": "<p>Yeah. The medium term goal for this is to have a package for people teaching with Lean, and I don't <em>love</em> that interface. It's easy to forget and not even necessary if you're only checking proofs. But we can probably find a way to make it manageable</p>",
        "id": 474842092,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728054091
    },
    {
        "content": "<p>if you do it automatically then it won't be a problem</p>",
        "id": 474842197,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728054116
    },
    {
        "content": "<p>except that maybe some stuff breaks if you put it in a namespace; best to report this early on the reference file</p>",
        "id": 474842377,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728054167
    },
    {
        "content": "<p>What do you mean by doing it automatically?</p>",
        "id": 474842395,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728054174
    },
    {
        "content": "<p>the autograder takes the reference file and edits it to add the <code>namespace</code> line before processing it to get an environment</p>",
        "id": 474842469,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728054203
    },
    {
        "content": "<p>Ah, editing the source file</p>",
        "id": 474842501,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728054216
    },
    {
        "content": "<p>you could also modify the toplevel but that seems somewhat heavyweight</p>",
        "id": 474842638,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728054249
    },
    {
        "content": "<p>This could even simplify the implementation. If we namespace the entire reference file, we can just build an environment that imports both the submission and the reference without any name clashes</p>",
        "id": 474843552,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728054550
    },
    {
        "content": "<p>So no recursive copying needed, no trickery to figure out what equational lemmas we need</p>",
        "id": 474843607,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728054570
    },
    {
        "content": "<p>exactly</p>",
        "id": 474843635,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728054576
    },
    {
        "content": "<p>This sounds slightly uglier but much easier than what I was imagining. Thanks!</p>",
        "id": 474843857,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728054632
    },
    {
        "content": "<p>I wonder how much we expect to break in practice by namespacing an entire file</p>",
        "id": 474843941,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728054660
    },
    {
        "content": "<p>Not too much, I think the main culprit will be <code>_root_</code> references but I wouldn't expect to see much of that in an instructor-written solution file</p>",
        "id": 474844063,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728054706
    },
    {
        "content": "<p>One occurrence in last year's homeworks <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 474844330,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728054798
    },
    {
        "content": "<p>luckily you only have to worry about hacks in the instructor's file and not the student's</p>",
        "id": 474844413,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728054828
    },
    {
        "content": "<p>Also dot notation could break. E.g., if you add a <code>List.foo</code> lemma, and then later in the file call <code>l.foo</code> on <code>l : List Î±</code>.</p>",
        "id": 474844435,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1728054835
    },
    {
        "content": "<p>seems hygienic namespaces don't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"open_foo\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"o\">)</span>\n<span class=\"n\">open_foo</span><span class=\"w\"> </span><span class=\"c1\">-- invalid scope</span>\n</code></pre></div>\n<p>not that I'm surprised, because namespaces have to be concatenated as name components and hygiene makes use of that for storing additional information</p>",
        "id": 474844922,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728054991
    },
    {
        "content": "<p>A potential hiccup: student submissions may have build errors, in particular incomplete proofs. (We can assume solutions build.) This will block us from creating a merge file that imports both, won't it?</p>",
        "id": 474845390,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1728055153
    },
    {
        "content": "<p>You can also fix that by editing, just insert an import of the instructor's file at the top of the student's and insert a line at the end which calls your checker</p>",
        "id": 474855286,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728058262
    },
    {
        "content": "<p>or override the toplevel to process each command, which gives you more control to handle failures as appropriate</p>",
        "id": 474855654,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728058334
    }
]