[
    {
        "content": "<p>What is the best way to get the number of declarations defined in a particular file? Probably from <code>CoreM</code>...</p>\n<p>I found <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Tactic.Lint.getDeclsInPackage#doc\">docs#Std.Tactic.Lint.getDeclsInPackage</a> which seems to do something like that, but for example for <code> `Lean</code> it returns all declarations in any file <code>Lean/XY/_.lean</code> and I thought having it return <code>0</code> would be better in my use case, as <code>Lean.lean</code> is an empty file (with some imports).</p>",
        "id": 466695054,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725192575
    },
    {
        "content": "<p>The <code>Environment</code> contains <code>const2ModIdx</code>, though you then have to find the correct <code>modIdx</code>.  I think that there is a function that tells you directly the declarations in the current module, but maybe that's not what you want (and I'm on mobile and cannot find it now).</p>",
        "id": 466699533,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725194666
    },
    {
        "content": "<p>E.g., something like this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#decls_in \"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">moduleIdxForModule?</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logWarning</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Sorry, module '{id}' does not exist\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">csts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">const2ModIdx</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cInM</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">csts</span><span class=\"bp\">.</span><span class=\"n\">foldM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">isBlackListed</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">({}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Found {cInM.size} declarations in '{id}':</span><span class=\"se\">\\n\\n</span><span class=\"s2\">{cInM.toArray.qsort (·.toString &lt; ·.toString)}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">decls_in</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n</code></pre></div>",
        "id": 466702653,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725196154
    },
    {
        "content": "<p>That's <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Tactic.Lint.getDeclsInCurrModule#doc\">docs#Std.Tactic.Lint.getDeclsInCurrModule</a>.</p>\n<p>I see, that's roughly what I'm trying now with <code>const2ModIdx</code>, thanks!</p>\n<p>Dumb sanity question, if I have a file with two <code>def</code>s in there and nothing else, like this here: <a href=\"https://github.com/leanprover-community/batteries/blob/a7fd140a94bbbfa40cf10839227bbb9e8492be2d/Batteries/Lean/IO/Process.lean\">Batteries/Lean/IO/Process.lean</a>, should the number of decls be 2?</p>",
        "id": 466702658,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725196155
    },
    {
        "content": "<p>I removed the \"blacklisted\" decls, otherwise you get a lot of <code>_aux</code> stuff.</p>",
        "id": 466702700,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725196191
    },
    {
        "content": "<p>Try filtering out more or less what you want, to see what suits you.</p>",
        "id": 466702759,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725196215
    },
    {
        "content": "<p>In general, I find it always a little tricky to find out <em>exactly</em> what declarations I care about: normally, everything that is \"visible\" is something that I would want, <code>to_additive</code> stuff tends also to be what I want, but anything after that... it depends!</p>",
        "id": 466703067,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725196452
    },
    {
        "content": "<p>Ah thanks, that's awesome! (I see, I didn't use <code>env.moduleIdxForModule?</code> so probably got a random index <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n<p>I'm not in <code>Mathlib</code> so I have to see what to replace <code>isBlacklisted</code> with (I vaguely remember that Lean had some <code>isInternal</code> or so.</p>",
        "id": 466703239,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725196539
    },
    {
        "content": "<p>For the particular file that you mentioned, with <code>isBlacklisted</code> you do get only two declarations, but there 16 more that are blacklisted.</p>",
        "id": 466703346,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725196565
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isBlackListed</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadEnv</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">``sorryAx</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"s2\">\"inj\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"s2\">\"noConfusionType\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"bp\">.</span><span class=\"n\">isInternalDetail</span>\n<span class=\"w\">   </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">isAuxRecursor</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n<span class=\"w\">   </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">isNoConfusion</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n<span class=\"w\">  </span><span class=\"bp\">&lt;||&gt;</span><span class=\"w\"> </span><span class=\"n\">isRec</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"bp\">&lt;||&gt;</span><span class=\"w\"> </span><span class=\"n\">isMatcher</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n</code></pre></div>",
        "id": 466703427,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725196594
    },
    {
        "content": "<p>This may be a \"minimized\" version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> from `Mathlib.Lean.Expr.Basic` -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isBlackListed</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadEnv</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">``sorryAx</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"s2\">\"inj\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"s2\">\"noConfusionType\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"bp\">.</span><span class=\"n\">isInternalDetail</span>\n<span class=\"w\">   </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">isAuxRecursor</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n<span class=\"w\">   </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">isNoConfusion</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n<span class=\"w\">  </span><span class=\"bp\">&lt;||&gt;</span><span class=\"w\"> </span><span class=\"n\">isRec</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"bp\">&lt;||&gt;</span><span class=\"w\"> </span><span class=\"n\">isMatcher</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> from `Batteries.Tactic.OpenPrivate` -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Environment</span><span class=\"bp\">.</span><span class=\"n\">moduleIdxForModule?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mod</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ModuleIdx</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">allImportedModuleNames</span><span class=\"bp\">.</span><span class=\"n\">indexOf?</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#decls_in \"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">moduleIdxForModule?</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logWarning</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Sorry, module '{id}' does not exist\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">csts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">const2ModIdx</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cInM</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">csts</span><span class=\"bp\">.</span><span class=\"n\">foldM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">isBlackListed</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">({}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Found {cInM.size} declarations in '{id}':</span><span class=\"se\">\\n\\n\\</span>\n<span class=\"s2\">                {cInM.toArray.qsort (·.toString &lt; ·.toString)}\"</span>\n</code></pre></div>",
        "id": 466704138,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725196865
    },
    {
        "content": "<p>so, yesterday I ended up with this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Get all declarations in the specified file. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getDeclsInFile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">&larr;</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">moduleIdxForModule?</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">const2ModIdx</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declsIn</span><span class=\"w\"> </span><span class=\"bp\">&larr;</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"bp\">.</span><span class=\"n\">foldM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">modIdx</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&larr;</span><span class=\"w\"> </span><span class=\"n\">isBlackListed</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">({}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">declsIn</span>\n</code></pre></div>\n<p>(<a href=\"https://github.com/leanprover-community/import-graph/blob/3f133b58f8c0a6f3418b41f108f3a13c22073a4c/ImportGraph/Gexf.lean#L27-L36\">source</a>)</p>\n<p>However, I have a hunch that this is quite slow and all I need later is <code>(&larr; getDeclsInFile n).size</code> to create some node-sizes in this mathlib graph (which some might remember from Lean3):</p>\n<p><a href=\"/user_uploads/3121/bY5qdeTUj6MFcm67hfjkFh4Z/Screenshot_20240901_231516.png\">Screenshot_20240901_231516.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/bY5qdeTUj6MFcm67hfjkFh4Z/Screenshot_20240901_231516.png\" title=\"Screenshot_20240901_231516.png\"><img data-original-dimensions=\"2880x1550\" src=\"/user_uploads/thumbnail/3121/bY5qdeTUj6MFcm67hfjkFh4Z/Screenshot_20240901_231516.png/840x560.webp\"></a></div><p>Do you have a suggestion for a faster method to get some meaningful node sizes? Maybe just retrieving the file size?</p>",
        "id": 466899821,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725271780
    },
    {
        "content": "<p>Hmm apparently de-monadifying everything and only calling <code>let env ← getEnv</code> once outside is already an improvement. Is <code>← getEnv</code>something that's usually slow?</p>",
        "id": 466902929,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725272490
    },
    {
        "content": "<p>I am not sure about <code>getEnv</code> being slow: could it be that re-getting the environment means that a lot of cached information is thrown away?</p>",
        "id": 466904070,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725272765
    },
    {
        "content": "<p>If you just want to count the definitions that are \"visible\", you might also look at the <code>.ilean</code>s that contain information about what is defined in a file, though only the declarations that have some syntax, I believe.</p>",
        "id": 466904628,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725272913
    },
    {
        "content": "<p>So, <code>to_additive</code> declarations would not be there, probably.</p>",
        "id": 466904673,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725272928
    },
    {
        "content": "<p>As a general rule, I do not have a very good feeling for what is slow and what is fast, so it is very likely that the code above could be made immensely more efficient by small changes that I ignore...</p>",
        "id": 466904897,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725272990
    },
    {
        "content": "<p>I don't understand this too well, so maybe your guess about the cache is something.</p>\n<p>In any case, only getting the <code>env</code> once and passing it into the functions reduced the time to 6 minutes for mathlib, which I guess is acceptable. (but it takes 5 seconds in total if I just set the size to <code>1</code>)</p>\n<p>I'll try the <code>.ilean</code>. Do you know if there's an intended way to read them? I guess finding them in <code>.lake</code> and parsing as JSON is somewhat hacky...</p>",
        "id": 466909348,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725274118
    },
    {
        "content": "<p>If you want the count for all modules, maybe you can setup a <code>HashMap Name Nat</code> that loops through the declarations once and adds them where they should go?</p>",
        "id": 466913027,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725275052
    },
    {
        "content": "<p>For instance, this takes a few seconds on the server, although I have not tested it very much:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#tally_decls\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">invert</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">allImportedModuleNames</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">invert</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">invert</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleIdx?</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">tots</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">const2ModIdx</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">isBlackListed</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tots</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">      </span><span class=\"n\">tots</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tots</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{tots.toArray.map fun (idx, tot) =&gt; ((invert.find? idx).getD default, tot)}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">tally_decls</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">[(Init.Prelude, 864),</span>\n<span class=\"cm\"> (Init.Coe, 63),</span>\n<span class=\"cm\"> (Init.Notation, 126),</span>\n<span class=\"cm\"> (Init.Tactics, 167),</span>\n<span class=\"cm\"> (Init.SizeOf, 75),</span>\n<span class=\"cm\"> (Init.Core, 494),</span>\n<span class=\"cm\"> (Init.SimpLemmas, 136),</span>\n<span class=\"cm\"> (Init.Data.Nat.Basic, 332),</span>\n<span class=\"cm\"> (Init.WF, 67),</span>\n<span class=\"cm\"> (Init.MetaTypes, 97),</span>\n<span class=\"cm\"> (Init.WFTactics, 5),</span>\n<span class=\"cm\"> (Init.Data.Nat.Div, 59),</span>\n<span class=\"cm\"> (Init.Data.List.Notation, 2),</span>\n<span class=\"cm\"> (Init.Data.List.Basic, 290),</span>\n<span class=\"cm\"> (Init.Data.Nat.Bitwise.Basic, 18),</span>\n<span class=\"cm\"> (Init.Data.Fin.Basic, 51),</span>\n<span class=\"cm\"> (Init.Data.UInt.Basic, 197),</span>\n<span class=\"cm\"> (Init.Data.Char.Basic, 23),</span>\n<span class=\"cm\">...</span>\n<span class=\"cm\">(Mathlib.Topology.Sheaves.SheafCondition.EqualizerProducts, 51),</span>\n<span class=\"cm\"> (Mathlib.Topology.Sheaves.Sheafify, 8),</span>\n<span class=\"cm\"> (Mathlib.Topology.Sheaves.Skyscraper, 39),</span>\n<span class=\"cm\"> (Mathlib.Topology.UniformSpace.AbsoluteValue, 2),</span>\n<span class=\"cm\"> (Mathlib.Topology.UniformSpace.CompareReals, 13),</span>\n<span class=\"cm\"> (Mathlib.Util.AssertNoSorry, 1),</span>\n<span class=\"cm\"> (Mathlib.Util.Export, 54),</span>\n<span class=\"cm\"> (Mathlib.Util.FormatTable, 12),</span>\n<span class=\"cm\"> (Mathlib.Util.GetAllModules, 2),</span>\n<span class=\"cm\"> (Mathlib.Util.IncludeStr, 1),</span>\n<span class=\"cm\"> (Mathlib.Util.LongNames, 3),</span>\n<span class=\"cm\"> (Mathlib.Util.SleepHeartbeats, 2),</span>\n<span class=\"cm\"> (Mathlib.Util.TermBeta, 2),</span>\n<span class=\"cm\"> (Mathlib.Util.Time, 2)]</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 466920006,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725276636
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/239415-metaprogramming-.2F-tactics/topic/Counting.20declarations/near/466913027\">said</a>:</p>\n<blockquote>\n<p>If you want the count for all modules, maybe you can setup a <code>HashMap Name Nat</code> that loops through the declarations once and adds them where they should go?</p>\n</blockquote>\n<p>actually true, I'm looping way to often! Thanks!</p>",
        "id": 466920513,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725276734
    },
    {
        "content": "<p>Btw, I find the dance around <code>ModuleIdx</code> and <code>Name</code> very annoying: I never remember which way the functions go and do not really know why it is so hard to get a human-readable name out of a <code>ModuleIdx</code>!</p>",
        "id": 466921237,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725276909
    },
    {
        "content": "<p>Ah wow, down to 7 seconds <span aria-label=\"star struck\" class=\"emoji emoji-1f929\" role=\"img\" title=\"star struck\">:star_struck:</span> </p>\n<p>I did this now:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getNumberOfDeclsPerFile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameMap</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">const2ModIdx</span><span class=\"bp\">.</span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">allImportedModuleNames</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"n\">idx</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isBlackListed</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">findD</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n</code></pre></div>\n<p>from your code I assume <code>env.allImportedModuleNames.get! idx</code> should be how one could retrieve the module name, is that right?</p>",
        "id": 466926475,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725278180
    },
    {
        "content": "<p>Because this is how it's defined under the hood:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getModuleIdx?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">moduleName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ModuleIdx</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">header</span><span class=\"bp\">.</span><span class=\"n\">moduleNames</span><span class=\"bp\">.</span><span class=\"n\">findIdx?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">moduleName</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 466926955,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725278295
    },
    {
        "content": "<p>I do not know whether the order of the <code>ModuleIdx</code> is the same as the one in which they are stored in <code>allImportedModuleNames</code>.  It would make sense, but I do not know.</p>",
        "id": 466926976,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725278299
    },
    {
        "content": "<p>ah yes, let me double-check these definitions</p>",
        "id": 466927119,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725278343
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">allImportedModuleNames</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">header</span><span class=\"bp\">.</span><span class=\"n\">moduleNames</span>\n</code></pre></div>",
        "id": 466927266,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725278382
    },
    {
        "content": "<p>I typed my comment, while you sent your message with the definition of <code>getModuleIdx?</code>, so do not take my comment as a reply to your message just above it, but to the one before that!</p>",
        "id": 466927437,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725278412
    },
    {
        "content": "<p>I.e., I still do not know what is the order, since I have not yet fully parsed what the functions do!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 466927612,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725278443
    },
    {
        "content": "<p>Ok, I have not tested it, but you are probably right: it seems that <code>moduleNames</code> is an array and the <code>ModuleIdx</code> is the index within that array of the module name.</p>",
        "id": 466928338,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725278641
    },
    {
        "content": "<p>So, then also my command above can be shortened, since <code>invert</code> was just a way of doing what you suggested with <code>get!</code>ing the Array entry.</p>",
        "id": 466928508,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725278681
    },
    {
        "content": "<p>Yep, the messages are a bit out of order. So to restate this, it looks like <code>env.header.moduleNames</code> is just an <code>Array Name</code>, <code>env.allImportedModuleNames</code> is just a wrapper for the same array and <code>env.getModuleIdx? `MyModule </code> seems to just use <code>Array.findIdx?</code> to find the index in this array, which is then the <code>ModuleIdx</code> (as <code>def ModuleIdx := Nat</code>)</p>",
        "id": 466928682,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725278731
    },
    {
        "content": "<p>I agree!  Maybe test it on a couple of modules, just to make sure, but I am convinced that this is what it is.</p>",
        "id": 466928874,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725278780
    },
    {
        "content": "<p>I was just worried that these arrays were obtained after storing their entries in a HashSet or something, forgetting any ordering, but it seems like this is not the case.</p>",
        "id": 466928969,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725278818
    },
    {
        "content": "<p>Btw, here is the result: <a href=\"https://github.com/leanprover-community/import-graph/pull/30\">https://github.com/leanprover-community/import-graph/pull/30</a></p>",
        "id": 466931050,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725279304
    },
    {
        "content": "<p>Very cool!</p>",
        "id": 466932077,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725279492
    },
    {
        "content": "<p>I wonder whether we should add the graph to the summary of every PR. <span aria-label=\"lol\" class=\"emoji emoji-1f606\" role=\"img\" title=\"lol\">:lol:</span></p>",
        "id": 466932184,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725279515
    },
    {
        "content": "<p>... and at a visual-based linter to test the yarn ball isn't messier than previously <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 466945146,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1725281857
    }
]