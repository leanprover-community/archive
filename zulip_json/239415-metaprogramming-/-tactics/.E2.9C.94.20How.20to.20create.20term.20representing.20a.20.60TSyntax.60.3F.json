[
    {
        "content": "<p>Hi everyone.</p>\n<p>I'm trying to \"store\" the syntax for some constructors in a record and later use these stored constructors to define an <code>inductive</code> type, but I can't figure out how to create a <code>TSyntax `term</code>from a <code>TSyntax `Lean.Parser.Command.ctor</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ADecl</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span>\n<span class=\"w\">  </span><span class=\"n\">ctor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Command.ctor</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabADecl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">br</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`Lean.explicitBinders</span><span class=\"o\">)):</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"bp\">.</span><span class=\"n\">getId</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"ss\">`decl</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">labelTypeName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`Label</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctor</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ctor</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">labelTypeName</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``ADecl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"c1\">-- FIXME: how to create a ```TSyntax `term``` from `ctor`?</span>\n<span class=\"w\">    </span><span class=\"c1\">-- argument</span>\n<span class=\"w\">    </span><span class=\"c1\">--   ctor</span>\n<span class=\"w\">    </span><span class=\"c1\">-- has type</span>\n<span class=\"w\">    </span><span class=\"c1\">--   TSyntax `Lean.Parser.Command.ctor : Type</span>\n<span class=\"w\">    </span><span class=\"c1\">-- but is expected to have type</span>\n<span class=\"w\">    </span><span class=\"c1\">--   TSyntax `term : Type</span>\n<span class=\"w\">    </span><span class=\"n\">ctor</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ctor</span>\n<span class=\"w\">  </span><span class=\"o\">})</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"{stx}\"</span>\n<span class=\"w\">  </span><span class=\"n\">liftCommandElabM</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">br</span><span class=\"o\">:(</span><span class=\"n\">explicitBinders</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">runTermElabM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">elabADecl</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"n\">br</span>\n\n<span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Any help is greatly appreciated!</p>",
        "id": 487027012,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1733758551
    },
    {
        "content": "<p>Try <code>$ctor:term</code>. When you want the syntax quotation system to make a coercion, an explicit annotation of the target syntax category is often needed.</p>\n<p>These annotations also generally help the quotation system and make error messages more comprehensible, so I recommend inserting them liberally whenever something weird happens.</p>",
        "id": 487043528,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1733762174
    },
    {
        "content": "<p>Actually, that's not the root issue here. <code>$ctor</code> isn't a term and therefore can't be used there. What is the declaration you expect <code>elabADecl</code> to produce, in Lean syntax?</p>",
        "id": 487043927,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1733762298
    },
    {
        "content": "<p>The quoting function you want does not currently exist, you would have to write it yourself. That said, depending on what you want to do with that data, an environment extension may be an easier solution as you do not have to go through <code>Syntax</code>/<code>Expr</code> in that case for storing data</p>",
        "id": 487046200,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1733762889
    },
    {
        "content": "<p>Thanks to both of you! Using an environment extension works in my case.</p>",
        "id": 487158563,
        "sender_full_name": "George Pîrlea",
        "timestamp": 1733804913
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"542918\">George Pîrlea</span> has marked this topic as resolved.</p>",
        "id": 487158568,
        "sender_full_name": "Notification Bot",
        "timestamp": 1733804915
    }
]