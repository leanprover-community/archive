[
    {
        "content": "<p>Is there documentation about <code>assumeInstancesCommute</code> / <code>assertInstancesCommute</code> somewhere?<br>\nWhy is <a href=\"https://github.com/leanprover-community/mathlib4/blob/cd0d35771eeffaaec105eb48ee56c978dc740766/Mathlib/Tactic/NormNum/Basic.lean#L517\">this line</a> needed, and not done by the <code>assumeInstancesCommute</code> on the next line? (it's adding the equation <code>«$mα» =Q «$inst».toNonAssocSemiring.toAddCommMonoidWithOne.toAddMonoidWithOne</code>)<br>\nDoes <code>assertInstancesCommute</code> only add defeqs for type-class instances of the same type? (If so: what does the word \"commute\" signify?)</p>\n<p>Reason for asking: <span class=\"user-mention\" data-user-id=\"726531\">@Pan Lin</span>  and I just ran into a similar situation where we had to add <code>_ =Q _ </code> line as well (we're making <code>positivity</code> more general, but that might require adding <code>_ =Q _</code> lines in many places).</p>",
        "id": 547246378,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1761562612
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/assumeInstancesCommute.20.2F.20assertInstancesCommute/near/547246378\">said</a>:</p>\n<blockquote>\n<p>Does <code>assertInstancesCommute</code> only add defeqs for type-class instances of the same type?</p>\n</blockquote>\n<p>No, since one of its most common uses is to demonstrate that a synthesized <code>LinearOrder</code> is compatible with the <code>PartialOrder</code> passed to positivity extensions</p>",
        "id": 547247606,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761562976
    },
    {
        "content": "<p>My guess is that that line is needed because otherwise Qq only assumes that <code>ma</code> and <code>ma'</code> are equal, without finding the third instance</p>",
        "id": 547247746,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761563029
    },
    {
        "content": "<p>The failure that Pan and I was precisely the case where we had 1 LinearOrder instance and 2 PartialOrder instances in a positivity extension, but <code>assumeInstancesCommute</code> didn't unify them all.<br>\nMaybe <span class=\"user-mention\" data-user-id=\"726531\">@Pan Lin</span> can create a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>? (It's a bit tricky since it's on top of a modified version of positivity)</p>",
        "id": 547252141,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1761564414
    },
    {
        "content": "<p>Here's a mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">i2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">i3</span><span class=\"bp\">.</span><span class=\"n\">toPartialOrder</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">by_elabq</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">assumeInstancesCommute</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">z</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 547253606,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761564846
    },
    {
        "content": "<p>Yes, that seems to reproduce exactly the issue we ran into. If you replace the variable lines by </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">i3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">i3</span><span class=\"bp\">.</span><span class=\"n\">toPartialOrder</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>then it works correctly.</p>",
        "id": 547303041,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1761577836
    }
]