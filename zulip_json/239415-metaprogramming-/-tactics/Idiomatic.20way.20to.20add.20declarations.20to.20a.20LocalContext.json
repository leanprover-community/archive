[
    {
        "content": "<p>Hi! I was wondering what is the idiomatic way to add extra declarations to a <code>LocalContext</code>? </p>\n<p>For context, I am inheriting a codebase in which the following function is used to add extra decls to the LocalContext, and I am unsure if this implementation is the correct way of doing things:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- For each `(arg, ty)` pair in `Array.zip argNames input_types`,</span>\n<span class=\"c1\">-- `mkInputLocalContext` adds a new declaration `arg : ty` is added to the local</span>\n<span class=\"c1\">-- context. The resultant LocalContext is returned by this function.</span>\n<span class=\"c1\">-- Invariant: `input_types.size == argNames.size`</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkInputLocalContext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input_types</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">argNames</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span>\n<span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">LocalContext</span>\n<span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">   </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">   </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arg</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">argNames</span><span class=\"bp\">.</span><span class=\"n\">zip</span><span class=\"w\"> </span><span class=\"n\">input_types</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">argname</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">mkStr1</span><span class=\"w\"> </span><span class=\"n\">arg</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fvarid</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\">  </span><span class=\"n\">mkFreshFVarId</span>\n<span class=\"w\">    </span><span class=\"n\">input_args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">input_args</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">fvarid</span>\n<span class=\"w\">    </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"n\">mkLocalDecl</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"n\">fvarid</span><span class=\"w\"> </span><span class=\"n\">argname</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">lctx</span>\n</code></pre></div>\n<p>Specifically, I am unsure whether the technique of first calling <code>mkFreshFVarId</code> and then calling <code>mkLocalDecl</code> is the recommended way of adding decls, since  the <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/LocalContext.html#Lean.LocalContext.mkLocalDecl\">docs</a> for <code>mkLocalDecl</code> that <code>mkLocalDecl</code> should not be called directly. </p>\n<p>I was wondering if the idiomatic solution is instead to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/Basic.html#Lean.Meta.withLocalDecl\">Meta.withLocalDecl</a> instead? However, I see that <code>Meta.withLocalDecl</code> reverts the context after it is called, and I was wondering if there is an function analogous to <code>withLocalDecl</code> which provides the caller with the updated local context (after the extra decls have been added)?</p>\n<p>Thanks!</p>",
        "id": 526139496,
        "sender_full_name": "Ernest Ng",
        "timestamp": 1751051139
    },
    {
        "content": "<p><code>withLocalDecl</code> is idiomatic, and you can get the local context from inside it with <code>getLCtx</code></p>",
        "id": 526139618,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751051199
    },
    {
        "content": "<p><code>withLocalDecls</code> lets you add many at once</p>",
        "id": 526139692,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751051238
    },
    {
        "content": "<p>Thanks for the quick reply! I saw in the <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/Basic.html#Lean.Meta.withLocalDecl\">docs</a> for <code>withLocalDecl</code> that it \"reverts the context\" after it is called, and I was wondering if there is a variant of <code>withLocalDecl</code> that doesn't revert the context?</p>",
        "id": 526139960,
        "sender_full_name": "Ernest Ng",
        "timestamp": 1751051372
    },
    {
        "content": "<p>No, that's not possible, since the local context is part of the monad's reader state. It's not actively being reverted, but rather you leave the scope where it's temporarily been changed.</p>",
        "id": 526140069,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751051440
    },
    {
        "content": "<p>In any case, that doesn't matter, because you can use <code>getLCtx</code> from within that callback to obtain the local context. You can do whatever you want with it.</p>",
        "id": 526140104,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751051461
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkInputLocalContext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inputTypes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">argNames</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">LocalContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inputTypes</span><span class=\"bp\">.</span><span class=\"n\">zip</span><span class=\"w\"> </span><span class=\"n\">argNames</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">mkSimple</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">withLocalDecls</span><span class=\"w\"> </span><span class=\"n\">spec</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n</code></pre></div>",
        "id": 526140124,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751051466
    },
    {
        "content": "<p>Ah I see that makes sense, thanks! It seems like calling <code>getLCtx</code> within the callback (continuation) that is passed to <code>withLocalDecls</code> is the preferred way of \"explicitly threading\" the <code>LocalContext</code> between different function calls.</p>",
        "id": 526140341,
        "sender_full_name": "Ernest Ng",
        "timestamp": 1751051569
    },
    {
        "content": "<p>That's not necessarily the case; it's often better to run your code from within <code>withLocalDecls</code> rather than working with the local context itself, threading it around.</p>\n<p>That said, it does happen, and for that there's <code>withLCtx</code>. Notice that it also takes a list that caches the local instances. That's one of the things that <code>withLocalDecl</code> properly manages for you.</p>",
        "id": 526140635,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751051729
    },
    {
        "content": "<p>(I should say that there's a good amount of code out there that uses the <code>mkLocalDecl</code> interface, but it's pretty low level and it's usually done for some specialized low-level optimization. It's best to avoid it unless you know you really need it.)</p>",
        "id": 526140868,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751051863
    },
    {
        "content": "<p>Ah that's fair, good point! It looks like <code>withLocalDecl</code> also properly handles the low-level operations associated with managing <code>FVarId</code>s (since it takes in a <code>Name</code> and a type and adds it to the context for you), and using <code>withLocalDecls</code>to add a bunch of declarations to the <code>LocalContext</code> is to be preferred over managing <code>FVarId</code>s yourself.</p>",
        "id": 526140985,
        "sender_full_name": "Ernest Ng",
        "timestamp": 1751051923
    }
]