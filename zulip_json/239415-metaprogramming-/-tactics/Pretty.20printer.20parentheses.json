[
    {
        "content": "<p>How does the pretty-printer decide when to drop the parentheses of an expression?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: unsolved goals</span>\n<span class=\"sd\">n : ℕ</span>\n<span class=\"sd\">p : ℕ × ℕ</span>\n<span class=\"sd\">⊢ Nat.Prime (n ! + p.1!)</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">)</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n</code></pre></div>",
        "id": 567836803,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768330061
    },
    {
        "content": "<p>It's the parenthesizer which adds them back, see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Parenthesizer#doc\">docs#Lean.PrettyPrinter.Parenthesizer</a></p>",
        "id": 567844773,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768332892
    },
    {
        "content": "<p>I spent a while writing a custom parenthesizer for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.term_%21#doc\">docs#Nat.term_!</a>, it worked but felt really hacky</p>",
        "id": 567846631,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768333467
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Pretty.20printer.20parentheses/near/567844773\">said</a>:</p>\n<blockquote>\n<p>It's the parenthesizer which adds them back, see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Parenthesizer#doc\">docs#Lean.PrettyPrinter.Parenthesizer</a></p>\n</blockquote>\n<p>Wdym \"adds them back\", who drops them in the first place?<br>\nI know that the <code>Syntax</code> objects contain parentheses, so something drops them somewhere.</p>",
        "id": 567849578,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768334543
    },
    {
        "content": "<p>In particular, the flow is:</p>\n<p>String --parsing--&gt; Syntax --elaboration--&gt; Expr</p>\n<p>and </p>\n<p>Expr --delaboration--&gt; Syntax --parenthesization--&gt; Syntax --formatting--&gt; String</p>",
        "id": 567850071,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768334698
    },
    {
        "content": "<p>If you imaging going from String to String by applying both sequences, there's some sense in which it \"adds them back\", but to be more precise, parenthesization is a step of the pretty printing process for Expr's.</p>",
        "id": 567850235,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768334757
    },
    {
        "content": "<p>The Expr type doesn't have any concept of parentheses at all. It's the raw fully-elaborated expression that Lean works with internally.</p>",
        "id": 567850363,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768334805
    },
    {
        "content": "<p>Ooh so the problem is going through <code>Expr</code>, thanks!<br>\nWhich parts are called \"pretty printing\", the entire reverse process or just the parnthesization+formatting?<br>\nIs it possible specifically for the infoview to skip <code>Expr</code> and only do parsing+formatting? Or will skipping elaboration give wrong goals?</p>",
        "id": 567850651,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768334920
    },
    {
        "content": "<p>The entire second line of operations in my message is pretty printing of expressions.</p>",
        "id": 567850716,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768334944
    },
    {
        "content": "<p>And no, there's no way to skip Exprs. The Syntax is just surface representation. Lean only operates on Exprs.</p>",
        "id": 567850806,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768334976
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"933054\">Snir Broshi</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Pretty.20printer.20parentheses/near/567849578\">said</a>:</p>\n<blockquote>\n<p>Wdym \"adds them back\", who drops them in the first place?</p>\n</blockquote>\n<p>That would be the elaborator, which turn the <code>Syntax</code> into an <code>Expr</code></p>",
        "id": 567850861,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768334994
    },
    {
        "content": "<p>In usual programming-language terms, would <code>Syntax</code> be a CST and <code>Expr</code> an AST, or is the elab/delab terminology very Lean-specific and I should not try to fit Lean into such boxes?</p>",
        "id": 567851168,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768335107
    },
    {
        "content": "<p><code>Syntax</code> is like the CST, and it's got enough information to know exactly how it lines up with the source.</p>",
        "id": 567851264,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768335143
    },
    {
        "content": "<p>The <code>Expr</code> is like an AST after typechecking/inference.</p>",
        "id": 567851352,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768335177
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"933054\">Snir Broshi</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Pretty.20printer.20parentheses/near/567850651\">said</a>:</p>\n<blockquote>\n<p>Is it possible specifically for the infoview to skip <code>Expr</code> and only do parsing+formatting? Or will skipping elaboration give wrong goals?</p>\n</blockquote>\n<p>You can skip <code>Expr</code> and just parenthesize and format <code>Syntax</code> objects, but not in the infoview since many parts of Lean (including the infoview) only work with <code>Expr</code></p>",
        "id": 567851613,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768335279
    },
    {
        "content": "<p>By the way, it would be possible to preserve parentheses by creating a new elaborator for parenthesis notation that inserts metadata into the expressions, and have that metadata pretty print using parentheses. It's something you can hack together as a user.</p>",
        "id": 567852072,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1768335449
    },
    {
        "content": "<p>I guess that'll only work for the first goal, since only it really comes from parsing a string, since tactics would work with <code>Expr</code>?</p>",
        "id": 567852756,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768335756
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Pretty.20printer.20parentheses/near/567851613\">said</a>:</p>\n<blockquote>\n<p>You can skip <code>Expr</code> and just parenthesize and format <code>Syntax</code> objects</p>\n</blockquote>\n<p>Would formatting be <code>Lean.PrettyPrinter.formatCategory `command stx</code> for <code>stx : Syntax</code>?</p>",
        "id": 567852921,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768335821
    },
    {
        "content": "<p>yes that's just formatting (without parenthesizing)</p>",
        "id": 567854183,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768336350
    }
]