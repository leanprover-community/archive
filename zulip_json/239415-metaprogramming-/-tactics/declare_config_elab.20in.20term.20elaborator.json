[
    {
        "content": "<p>There's not a monad lift between <code>TacticM</code> and <code>TermElabM</code>, right? So what is the best way to use the function generated by <code>declare_config_elab</code> in a term elaborator?</p>",
        "id": 535709272,
        "sender_full_name": "Chris Henson",
        "timestamp": 1755877173
    },
    {
        "content": "<p>The underlying function of <code>declare_config_elab</code> actually operates in <code>TermElabM</code>; <code>declare_config_elab</code> just requires <code>TacticM</code> for no reason that I can see. (This should perhaps be changed.) So you can easily define a variant that declares config elaborators in <code>TermElabM</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">configElab</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">doc?</span><span class=\"o\">:(</span><span class=\"n\">docComment</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"s2\">\"declare_config_elab\"</span><span class=\"w\"> </span><span class=\"n\">elabName</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">mkConfigElaborator</span><span class=\"w\"> </span><span class=\"n\">doc?</span><span class=\"w\"> </span><span class=\"n\">elabName</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkCIdent</span><span class=\"w\"> </span><span class=\"ss\">``TacticM</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> ! -/</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkCIdent</span><span class=\"w\"> </span><span class=\"ss\">``id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">recover</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 535720017,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1755880857
    },
    {
        "content": "<p>The reason it uses TacticM is the <code>recover</code> flag is only in TacticM. That's used to decide what sort of error recovery should be done if the tactic configuration has errors.</p>\n<p>You can see in <code>declare_command_config_elab</code> how you might adapt this to a monad that doesn't have recovery. The <code>TermElabM</code> monad sort of has recovery in the form of <code>errToSorry</code>. It would be nice if \"recovery\" was a more well-developed concept (for example if there were a typeclass that gave the current recovery state, then <code>declare_config_elab</code> could run in any monad extending CoreM that implemented it). </p>\n<p>I'm not remembering exactly why <code>Lean.Elab.Tactic.mkConfigElaborator</code> is private. At least <code>Lean.Elab.Tactic.elabConfig</code> is public...</p>",
        "id": 535723092,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755882078
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"687698\">Chris Henson</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/declare_config_elab.20in.20term.20elaborator/near/535709272\">said</a>:</p>\n<blockquote>\n<p>There's not a monad lift between <code>TacticM</code> and <code>TermElabM</code>, right?</p>\n</blockquote>\n<p>That's correct, but TacticM is TermElabM with some additional monad transformers wrapped around it. You can use the <code>run</code> functions for these with whatever reader/state objects you want, and it should work. Just think about what you want from error recovery and set <code>recover</code> appropriately. I believe you can use Name.anonymous for the <code>elaborator</code>, and the <code>goals</code> can be <code>[]</code>.</p>",
        "id": 535723374,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755882211
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/declare_config_elab.20in.20term.20elaborator/near/535723374\">said</a>:</p>\n<blockquote>\n<p>That's correct, but TacticM is TermElabM with some additional monad transformers wrapped around it. You can use the <code>run</code> functions for these with whatever reader/state objects you want, and it should work. Just think about what you want from error recovery and set <code>recover</code> appropriately. I believe you can use Name.anonymous for the <code>elaborator</code>, and the <code>goals</code> can be <code>[]</code>.</p>\n</blockquote>\n<p>That works, thanks!</p>",
        "id": 535726069,
        "sender_full_name": "Chris Henson",
        "timestamp": 1755883380
    }
]