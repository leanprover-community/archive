[
    {
        "content": "<p>Here's an (unrelated) problematic interaction with the module system:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MySup</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_dual</span><span class=\"kd\">]</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyInf</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyLattice</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">MySup</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MyInf</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">to_dual</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">MyLattice</span><span class=\"bp\">.</span><span class=\"n\">toMySup</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">trying to realize `_private.Lean.Environment.0.Lean.Environment.RealizeConstKey` value but `enableRealizationsForConst` must be called for 'MyLattice.toMyInf' first</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 561507279,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764705352
    },
    {
        "content": "<p>It can be fixed locally by following the instructions from the error, by calling</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">enableRealizationsForConst</span><span class=\"w\"> </span><span class=\"ss\">``MyLattice.toMyInf</span>\n</code></pre></div>\n<p>Though I don't really understand what is going on.</p>",
        "id": 561507641,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764705485
    },
    {
        "content": "<p>This is unrelated to the module system, there is no <code>module</code> :-)</p>",
        "id": 561584960,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1764749987
    },
    {
        "content": "<p>3 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"239415\" href=\"/#narrow/channel/239415-metaprogramming-.2F-tactics/topic/to_additive.20.20and.20module.20system/with/561452122\">#metaprogramming / tactics &gt; to_additive  and module system</a> by <span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span>.</p>",
        "id": 561585005,
        "sender_full_name": "Notification Bot",
        "timestamp": 1764750009
    },
    {
        "content": "<p>Looks like <code>to_dual</code> is trying to use <code>realizeConst MyLattice.toMyInf</code>. That function can only be used on declarations after <code>Lean.enableRealizationsForConst</code> has run on them, which Lean core does on for most, but all declarations. </p>\n<p>A fix would be to find the place in Lean core where <code>toMyInf</code> is declared and add a call to <code>enableRealizationsForConst</code>after and near the <code>addDecl</code> call.</p>",
        "id": 561585296,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1764750128
    },
    {
        "content": "<p>Do you want to report an issue and give fixing it a shot?</p>",
        "id": 561585356,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1764750149
    },
    {
        "content": "<p>Here's a to_dual-free version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MySup</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyInf</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyLattice</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">MyInf</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MySup</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">getEqnsFor?</span><span class=\"w\"> </span><span class=\"ss\">``MyLattice.toMySup</span>\n</code></pre></div>",
        "id": 561633258,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764763487
    },
    {
        "content": "<p>Ok, I've implemented a fix in the <code>to_dual</code> implementation, since it turns out we don't actually want to look at the equation lemmas for <code>MyLattice.MySup</code>. <a href=\"https://github.com/leanprover-community/mathlib4/pull/32396\">#32396</a></p>\n<p>If you are still insterested in fixing this in core, I think that the filter <a href=\"https://github.com/JovanGerb/lean4/blob/42e17fa9c7f53dd3996e020182d083a95aa70fec/src/Lean/Elab/Structure.lean#L1264-L1265\">here</a> is responsible for the trouble.</p>",
        "id": 561654296,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764769274
    }
]