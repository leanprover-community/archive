[
    {
        "content": "<p>I have written a command that takes a bundled relation and a symbol to define notations, e.g. <code>a ⭢ᵗ b</code> or <code>a ⭢ᶠ b</code>. I would like to extend this to also defining a corresponding unexpander. Here is an mwe showing the issues I'm running into:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"reduction_notation\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">notationItem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"s2\">\" ⭢\"</span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">)</span>\n\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"s2\">\"ᵗ\"</span>\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"s2\">\"ᶠ\"</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- info: rs_true.Red m n : Prop -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">⭢ᵗ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- info: rs_false.Red m n : Prop -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">⭢ᶠ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- this works individually</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_true_pp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⭢ᵗ</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_false_pp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⭢ᶠ</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"sd\">/-- info: m ⭢ᵗn : Prop -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">⭢ᵗ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- info: m ⭢ᶠn : Prop -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">⭢ᶠ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- but I want a command that works with the notationItem used as a variable, here's what I tried</span>\n<span class=\"c1\">-- two problems here:</span>\n<span class=\"c1\">--   I don't know how to distinguish a nested antiquotation ($a and $b)</span>\n<span class=\"c1\">--   writing ⭢$sym tries to parse as the above notations (and if you remove them would still fail)</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"reduction_pp\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">notationItem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">reduction_pp</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⭢$</span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">   </span><span class=\"o\">)</span>\n\n<span class=\"n\">reduction_pp</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"s2\">\"ᵗ\"</span>\n<span class=\"n\">reduction_pp</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"s2\">\"ᶠ\"</span>\n</code></pre></div>\n<p>I have the notion that it would be easier if I assembled the left and right hand sides of the match in the unexpander beforehand to avoid nested antiquotation, but I wasn't sure how to do this.</p>",
        "id": 532021416,
        "sender_full_name": "Chris Henson",
        "timestamp": 1753953314
    },
    {
        "content": "<p>Conceptual question, do you mean to define a notation with <code>⭢ᵗ</code> as an atom, or is the fact that <code>m ⭢ ᵗ n</code> parses ok?</p>\n<p><code>notation</code> doesn't support it, but if there were <code>noWs</code> between the two in the syntax then that would keep it from parsing if it has whitespace.</p>\n<p>The <code>notation</code> command also requires that you give precedence levels to the terms that appear, since otherwise they default to max. I assume you want this to work like <code>infix</code>, in which case everything should have <code>:39</code>.</p>\n<p>If you use <code>notation3</code> from Mathlib, you get pretty printers for this for free:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"reduction_notation\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">notation3</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"s2\">\" ⭢\"</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">)</span>\n\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"s2\">\"ᵗ \"</span>\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"s2\">\"ᶠ \"</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- info: m ⭢ᵗ n : Prop -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">⭢ᵗ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- info: m ⭢ᶠ n : Prop -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">⭢ᶠ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 532134718,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753984134
    },
    {
        "content": "<p>Here's a little improvement with the macro to get the pretty printing to have the right whitespace without needing to put it into the <code>reduction_notation</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sym</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"bp\">.</span><span class=\"n\">getString</span><span class=\"bp\">.</span><span class=\"n\">endsWith</span><span class=\"w\"> </span><span class=\"s2\">\" \"</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkStrLit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sym</span><span class=\"bp\">.</span><span class=\"n\">getString</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\" \"</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">notation3</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"s2\">\" ⭢\"</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t'</span><span class=\"o\">)</span>\n\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"s2\">\"ᵗ\"</span>\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"s2\">\"ᶠ\"</span>\n</code></pre></div>",
        "id": 532135148,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753984270
    },
    {
        "content": "<p>Using unexpanders for this is unfortunately a bit problematic. The issue is that they match syntactically, so in <code>ReductionSystem.Red rs_true m n</code>, the <code>rs_true</code> might not refer to the constant you think it is. Or, if you switch namespaces, it might start pretty printing as <code>SomeNS.rs_true</code>, and the unexpander won't apply anymore.</p>",
        "id": 532135736,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753984446
    },
    {
        "content": "<p>I see, thank you. I've not used <code>notation3</code> before, that is helpful.</p>\n<p>Can I ask though, if I did want to do this \"manually\" along the lines I started above, is it possible to have these nested antiquotations? My trying to do it that way came from seeing <a href=\"https://github.com/UCSCFormalMethods/LeanLTL/blob/ef8d4c9dd94d3ae85e76328549b70e35551891f2/LeanLTL/TraceSet/Notation.lean#L268-L290\">this example in LeanLTL</a> that you linked to the other day. I didn't quite follow everything, but this seemed like what your <code>antiquote</code> function was helping to do? Where you have <code>`($unexpandLHS) =&gt; $unexpandRHS</code>, these include antiquotations, right?</p>",
        "id": 532140319,
        "sender_full_name": "Chris Henson",
        "timestamp": 1753985883
    },
    {
        "content": "<p>Yes, I was just working out how to get this all to work using a slightly different scheme. Here are some nested antiquotations:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">reductionKind</span>\n\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">reductionArrowStx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"s2\">\" ⭢\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">reductionKind</span><span class=\"w\"> </span><span class=\"n\">ppSpace</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"reduction_notation\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[])]</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">resolveGlobalName</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"s2\">\"could not resolve name\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">redKind</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">addMacroScope</span><span class=\"w\"> </span><span class=\"ss\">`redKind</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">redKindIdent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdentFrom</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"n\">redKind</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">redKindIdent</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">reductionKind</span>\n<span class=\"w\">      </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`reductionArrowStx</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">⭢$$</span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"n\">reductionKind</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">redKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span><span class=\"o\">)</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"bp\">⟩</span>\n\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"s2\">\"ᵗ\"</span>\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"s2\">\"ᶠ\"</span>\n</code></pre></div>",
        "id": 532140815,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753986027
    },
    {
        "content": "<p>What you were running into with your unexpander is that each reduction notation defines its <em>own</em> arrow, with its own syntax kind, so you can't actually use quotations in that context.</p>\n<p>Using a syntax category like this lets all the reduction arrows share the same syntax kind, but with different nodes at the reductionKind spot</p>",
        "id": 532141029,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753986094
    },
    {
        "content": "<p>(The resolveGlobalName isn't necessary yet, but its use will pop up when I add in the delaborator)</p>",
        "id": 532141106,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753986119
    },
    {
        "content": "<p>Got it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">reductionKind</span>\n\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">reductionArrowStx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"s2\">\" ⭢\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">reductionKind</span><span class=\"w\"> </span><span class=\"n\">ppSpace</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabReductionSystem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">reduct</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`reductionKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">whenNotPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPExplicit</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">    </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">getAppNumArgs</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">getArg!</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">isConstOf</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withAppFn</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withAppArg</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withAppArg</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⭢$</span><span class=\"n\">reduct</span><span class=\"o\">:</span><span class=\"n\">reductionKind</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"reduction_notation\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[])]</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">resolveGlobalName</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"s2\">\"could not resolve name\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">redKind</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">addMacroScope</span><span class=\"w\"> </span><span class=\"ss\">`redKind</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">redKindIdent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdentFrom</span><span class=\"w\"> </span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"n\">redKind</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">redKindIdent</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">reductionKind</span>\n<span class=\"w\">      </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`reductionArrowStx</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">⭢$$</span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"n\">reductionKind</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">redKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">ReductionSystem</span><span class=\"bp\">.</span><span class=\"n\">Red</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">      </span><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``ReductionSystem.Red</span><span class=\"o\">)</span><span class=\"kd\">]</span>\n<span class=\"w\">      </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabReduction</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">        </span><span class=\"n\">delabReductionSystem</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">mkNode</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">redKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkAtom</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sym</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"o\">]</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"bp\">⟩</span>\n\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_true</span><span class=\"w\"> </span><span class=\"s2\">\"ᵗ\"</span>\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">rs_false</span><span class=\"w\"> </span><span class=\"s2\">\"ᶠ\"</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- info: m ⭢ᵗ n : Prop -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">⭢ᵗ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- info: m ⭢ᶠ n : Prop -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">⭢ᶠ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 532143050,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753986714
    },
    {
        "content": "<p>That <code>mkNode $(quote redKind) #[mkAtom .none $sym:str]</code> hints at some of the difficulty here with creating syntax. The problem is that from within the macro, the <code>syntax</code> hasn't been run, so it can't be used to parse the rest of the quotation, so we have to create the node manually.</p>",
        "id": 532143314,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753986792
    },
    {
        "content": "<p>If you modify the delaborator like so</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabReductionSystem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">reduct</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`reductionKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">whenNotPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPExplicit</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">    </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">getAppNumArgs</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">getArg!</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">isConstOf</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withAppFn</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withAppArg</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withAppArg</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Hack: treate `reduct` as a term and give it terminfo pointing to `self`</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">reduct</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`reductionKind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨←</span><span class=\"w\"> </span><span class=\"n\">withAppFn</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withAppFn</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withAppArg</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">annotateTermInfo</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">reduct</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⭢$</span><span class=\"n\">reduct</span><span class=\"o\">:</span><span class=\"n\">reductionKind</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>then you also get hoverable reductionKinds in the pretty printed output:</p>\n<p><a href=\"/user_uploads/3121/hi_D2WQvKlllYqkNN0UvMkhe/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/hi_D2WQvKlllYqkNN0UvMkhe/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"576x94\" src=\"/user_uploads/thumbnail/3121/hi_D2WQvKlllYqkNN0UvMkhe/image.png/840x560.webp\"></a></div>",
        "id": 532143992,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753987042
    },
    {
        "content": "<p>Yeah, I tried for a bit to figure out how to construct it manually since the errors hinted in that direction. Using a syntax category for the reduction arrow is also very helpful. Thanks again!</p>",
        "id": 532144203,
        "sender_full_name": "Chris Henson",
        "timestamp": 1753987117
    },
    {
        "content": "<p>Is it expected that these unexpanders would not work if there is a variable in the type of the <code>ReductionSystem</code>? For instance the following doesn't pretty print:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">term_rel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ReductionSystem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Var</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨λ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">⟩</span>\n\n<span class=\"n\">reduction_notation</span><span class=\"w\"> </span><span class=\"n\">term_rel</span><span class=\"w\"> </span><span class=\"s2\">\"β\"</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Var</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- term_rel.Red a b : Prop</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⭢</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>\n<p>My guess was that this is because syntactically <code>term_rel</code> is <code>@term_rel Var</code>?</p>",
        "id": 532413028,
        "sender_full_name": "Chris Henson",
        "timestamp": 1754107826
    },
    {
        "content": "<p>Using <code>notation3</code> works for this, so I suppose it is able to capture this case of implicit variables?</p>",
        "id": 532413661,
        "sender_full_name": "Chris Henson",
        "timestamp": 1754108321
    },
    {
        "content": "<p>I am looking at the <code>notation3</code> source and trying to understand where this happens. I see in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Notation3.mkExprMatcher#doc\">docs#Mathlib.Notation3.mkExprMatcher</a> it mentions variables?</p>",
        "id": 532414345,
        "sender_full_name": "Chris Henson",
        "timestamp": 1754108886
    },
    {
        "content": "<p>A big difference between <code>notation</code> and <code>notation3</code> is that <code>notation</code> generates an unexpander (so a Syntax -&gt; Syntax transformation for pretty printing) but <code>notation3</code> generates a delaborator (so an Expr -&gt; Syntax transformation). It elaborates the RHS of <code>=&gt;</code> to construct the <code>Expr</code> matcher. That matcher is generated in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=exprToMatcher#doc\">docs#exprToMatcher</a> in particular.</p>\n<p>With the macro I wrote earlier, the generated delaborator is looking for a plain constant (with <code>isConstOf</code>). Since <code>term_rel</code> elaborates to <code>@term_rel Var</code>, that's no longer a plain constant, but an application.</p>\n<p>If you think that the head constant suffices to distinguish between different notations, you could change that line to <code>guard &lt;| self.getAppFn.isConstOf n</code> I believe (didn't test it).</p>",
        "id": 532420203,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754113597
    },
    {
        "content": "<p>That makes sense, thanks! I will likely just use notation3, but this has been a good exercise to understand unexpanders versus delaborators.</p>",
        "id": 532420678,
        "sender_full_name": "Chris Henson",
        "timestamp": 1754113998
    }
]