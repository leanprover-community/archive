[
    {
        "content": "<p>Good morning! I've been having trouble understanding some behavior of <code>scoped syntax</code> declarations. For example, something like this is totally fine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">outer</span>\n\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"myterm\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">outer</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"n\">myterm</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- parses as an identifier</span>\n</code></pre></div>\n<p>...but calling  the <code>withNamespace</code> function at any point beforehand changes things:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withNamespace</span><span class=\"w\"> </span><span class=\"ss\">`outer</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"shouldn't affect anything\"</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">outer</span>\n\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"myterm\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">outer</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"n\">myterm</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- now parses as a keyword (`outer.termMyterm) despite being out of scope</span>\n</code></pre></div>\n<p>...and running it at any point within the namespace with any argument also changes things:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">outer</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withNamespace</span><span class=\"w\"> </span><span class=\"ss\">`anything</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"shouldn't affect anything\"</span>\n\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"myterm\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">outer</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"n\">myterm</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- parses as a keyword again</span>\n</code></pre></div>\n<p>Even more strangely, everything is fine if these namespaces are opened/closed manually using <code>namespace ... /end ...</code>, or if <code>addNamespace</code> is <code>open private</code>d and used; and <code>#where</code> reveals no namespace leakage or other weirdness. I've tested this all on v4.28.0. </p>\n<p>I can't make heads or tails of this... is this intended behavior? Is there a better way to programatically declare <code>scoped syntax</code> (as I was hoping to do using <code>withNamespace</code>)? Thank you very much!</p>",
        "id": 574960175,
        "sender_full_name": "Tate Rowney",
        "timestamp": 1771599356
    },
    {
        "content": "<p>I think this is a bug in the <a href=\"https://github.com/leanprover/lean4/blob/985f350dcd18fc7814dfa677cac09933f44f3215/src/Lean/Elab/BuiltinCommand.lean#L73-L77\">definition of <code>withNamespace</code></a>. If you look at the <a href=\"https://github.com/leanprover/lean4/blob/7b30214e54d1b834befafd5bc1edf79bdf335ff8/src/Lean/Elab/BuiltinCommand.lean#L236-L265\">definition of <code>end</code></a> you'll see that it ends with a <code>popScopes</code>, which is missing in <code>withNamespace</code> even though it calls an analogous <code>pushScope</code> (indirectly), which I guess desyncs scoped persistent env extensions including the one used for parser extensions. The fix should just be to add <code>popScopes ns.getNumParts</code> to <code>withNamespace</code> just before the return</p>",
        "id": 574999654,
        "sender_full_name": "Albert Smith",
        "timestamp": 1771609937
    },
    {
        "content": "<p>Thank you, this indeed appears to be the problem. Adding the proper calls to <code>popScope</code> fixes it. I've opened an issue on GitHub.</p>",
        "id": 575020522,
        "sender_full_name": "Tate Rowney",
        "timestamp": 1771618134
    }
]