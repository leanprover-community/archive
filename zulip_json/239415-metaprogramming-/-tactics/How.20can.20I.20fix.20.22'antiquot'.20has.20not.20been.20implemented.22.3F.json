[
    {
        "content": "<p>In the below code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">xxx</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"mi\">42</span><span class=\"o\">)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">yyy</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">xxx</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I am basically expecting <code>$(q(·))</code> to be an identity function - <code>q</code> turns program to data (string), and <code>$</code> turns data (string) to program.<br>\nHowever, the second line gives me the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elaboration</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">term</span><span class=\"bp\">.</span><span class=\"n\">pseudo</span><span class=\"bp\">.</span><span class=\"n\">antiquot'</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">implemented</span>\n<span class=\"w\">  </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">xxx</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>How can I fix this issue, or am I doing something wrong here?</p>",
        "id": 493985116,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736963666
    },
    {
        "content": "<p>Antiquotations are only allowed inside a quotation. (Note that Lean doesn't operate on strings, it operates on more complex data structures, like Syntax and Expr.)</p>\n<p>It's possible to do compile-time evaluation and reflection of the result though.</p>",
        "id": 493988494,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736964757
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Notation</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Eval</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">`expr% t` evaluates `t` (which should yield an expression) and then yields that expression as the result.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"expr% \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">withSynthesize</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTermEnsuringType</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">safety</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unsafe</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">xxx</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"mi\">42</span><span class=\"o\">)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">yyy</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">xxx</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">yyy</span>\n<span class=\"c1\">-- 42</span>\n</code></pre></div>",
        "id": 493989862,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736965230
    },
    {
        "content": "<p>I guess that can actually be implemented using a macro:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">`expr% t` evaluates `t` (which should yield an expression) and then inserts the result.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"expr% \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">by_elab</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This is to say that to \"antiquote\" an expression, you can write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">yyy</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">by_elab</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">xxx</span>\n</code></pre></div>",
        "id": 493990681,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736965525
    },
    {
        "content": "<p>Thank you for the answer, <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> !</p>\n<blockquote>\n<p>Antiquotations are only allowed inside a quotation.</p>\n</blockquote>\n<p>I am no expert in metaprogramming, but in the literature of staged programming, it seems it is possible to splice a term without it needing to be inside a quotation. For exmaple, the first three paragraph of <a href=\"https://xnning.github.io/papers/icfp24functor.pdf\">this paper</a> describes \"staged programming 101\" example, where at the end they splice the term <code>$(mpower 3 &lt;&lt;2&gt;&gt;)</code> which is not inside the quotation.<br>\nThus the question: is there a reason that splicing is only allowed inside a quotation? (just out of curiosity, not being critical) Maybe the core Lean4's quotation doesn't bring enough type information for this to work safely. But wouldn't it be possible in Qq?</p>\n<blockquote>\n<p>It's possible to do compile-time evaluation and reflection of the result though.<br>\nI guess that can actually be implemented using a macro:</p>\n</blockquote>\n<p>Thanks, this looks really cool! I will try them out!</p>",
        "id": 493993019,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736966398
    },
    {
        "content": "<p>I think you could define the <code>$(...)</code> syntax to be a macro for <code>by_elab return xxx</code>. It's just not done for whatever reason (possibly because such level-zero splicings are very infrequently done)</p>",
        "id": 493994454,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736966892
    },
    {
        "content": "<p>Lean doesn't have the guarantees given at the end of the first paragraph of the introduction of that paper:</p>\n<blockquote>\n<p>language support for multi-stage programming often provides additional guarantees (e.g. that well-typed generating programs generate only well-scoped and well-typed code).</p>\n</blockquote>\n<p>Qq helps with this though. With more work the above <code>expr%</code> syntax could try to ensure type correctness at elaboration time.</p>",
        "id": 493995065,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736967120
    },
    {
        "content": "<p>I left open the possibility of top-level quotations when implementing the parser but never implemented the corresponding elaborator for lack of use cases. There's also some unclear details on whether it should e.g. support both pure and monadic values.</p>",
        "id": 493995942,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736967474
    },
    {
        "content": "<p>Should the elaborator be implemented to just emit an error message like \"top level antiquots are not supported\"?</p>",
        "id": 494010390,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736972938
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Thank you for the explanations, that makes very much sense.</p>",
        "id": 495213248,
        "sender_full_name": "Youngju Song",
        "timestamp": 1737530063
    }
]