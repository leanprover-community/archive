[
    {
        "content": "<p>Hi I was trying to elaborate the simple expression <code>fun n : Nat =&gt; (1 + n)</code> and it ended up including a mvar, I have both <code>withoutPostponing</code>and <code>withSynthesize</code>so I wouldn't expect a <code>mvar</code>. Is there something im missing here?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#elab\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withoutPostponing</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withSynthesize</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withoutErrToSorry</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">withDeclName</span><span class=\"w\"> </span><span class=\"ss\">`nm</span><span class=\"w\"> </span><span class=\"k\">do</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">xType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ensureHasType</span><span class=\"w\"> </span><span class=\"n\">xType</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">xType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">xType</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"({repr x}) : ({repr xType})\"</span>\n\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"({←ppExpr x}) : ({←ppExpr xType})\"</span>\n\n<span class=\"bp\">#</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- No mvar in expr</span>\n<span class=\"bp\">#</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- mvar in expr</span>\n</code></pre></div>\n<p><a href=\"https://live.lean-lang.org/#code=import%20Lean%0A%0Aopen%20Lean%20Elab%20Command%20Term%20Meta%0A%0Aelab%20%22%23elab%22%20t%3Aterm%20%3A%20command%20%3D%3E%0A%20%20open%20Parser.Term%20in%0A%20%20liftTermElabM%20do%0A%20%20%20%20withoutPostponing%20do%0A%20%20%20%20withSynthesize%20do%0A%20%20%20%20withoutErrToSorry%20do%0A%20%20%20%20Elab.Term.withDeclName%20%60nm%20do%0A%0A%20%20%20%20let%20x%20%E2%86%90%20elabTerm%20t%20none%0A%20%20%20%20let%20xType%20%E2%86%90%20inferType%20x%0A%20%20%20%20let%20x%20%E2%86%90%20ensureHasType%20xType%20x%0A%0A%20%20%20%20let%20xType%20%E2%86%90%20instantiateMVars%20xType%0A%20%20%20%20let%20x%20%E2%86%90%20instantiateMVars%20x%0A%0A%20%20%20%20IO.println%20s!%22(%7Brepr%20x%7D)%20%3A%20(%7Brepr%20xType%7D)%22%0A%0A%20%20%20%20IO.println%20s!%22(%7B%E2%86%90ppExpr%20x%7D)%20%3A%20(%7B%E2%86%90ppExpr%20xType%7D)%22%0A%0A%23elab%20(1%20%3A%20Nat)%20--%20No%20mvar%20in%20expr%0A%23elab%20fun%20a%20%3A%20Nat%20%3D%3E%20(1%20%2B%20a%20%3A%20Nat)%20--%20mvar%20in%20expr%0A%0A\">Web link</a></p>\n<p>Thanks for any help :)</p>",
        "id": 462146095,
        "sender_full_name": "William Sørensen",
        "timestamp": 1723562939
    },
    {
        "content": "<p>To make things stranger it is not the case if I use other syntax that <code>+</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- No mvar in expr</span>\n<span class=\"bp\">#</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HAdd</span><span class=\"bp\">.</span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- no mvar</span>\n<span class=\"bp\">#</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Add</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- no mvar</span>\n<span class=\"bp\">#</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- mvar in expr</span>\n</code></pre></div>",
        "id": 462148372,
        "sender_full_name": "William Sørensen",
        "timestamp": 1723563590
    },
    {
        "content": "<p>You need to actually exit <code>withSynthesize</code> first for it to have an effect</p>",
        "id": 462148816,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1723563730
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/239415-metaprogramming-.2F-tactics/topic/Metavariable.20in.20type-class.20for.20.60OfNat.20Nat.60/near/462148816\">said</a>:</p>\n<blockquote>\n<p>You need to actually exit <code>withSynthesize</code> first for it to have an effect</p>\n</blockquote>\n<p>What do you mean with exit it?</p>",
        "id": 462148900,
        "sender_full_name": "William Sørensen",
        "timestamp": 1723563760
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> would you be able to provide code-snippet /  place to look about doing this?</p>",
        "id": 462379976,
        "sender_full_name": "William Sørensen",
        "timestamp": 1723652636
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#elab\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withoutErrToSorry</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">withDeclName</span><span class=\"w\"> </span><span class=\"ss\">`nm</span><span class=\"w\"> </span><span class=\"k\">do</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withSynthesize</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">xType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ensureHasType</span><span class=\"w\"> </span><span class=\"n\">xType</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">xType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">xType</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"({repr x}) : ({repr xType})\"</span>\n\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"({←ppExpr x}) : ({←ppExpr xType})\"</span>\n</code></pre></div>",
        "id": 462380415,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1723652819
    },
    {
        "content": "<p>Lol thank you so much i was really being stupid here. have a nice day :)</p>",
        "id": 462380811,
        "sender_full_name": "William Sørensen",
        "timestamp": 1723652927
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"736115\">William Sørensen</span> has marked this topic as resolved.</p>",
        "id": 462380851,
        "sender_full_name": "Notification Bot",
        "timestamp": 1723652938
    }
]