[
    {
        "content": "<p>Hi all, this one might be easy for people who have made Elaborators but I'm stuck. I'm reading the <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/07_elaboration.html\">Lean Metaprogramming book</a> and making an S-expression DSL, and I'm trying to figure out how to define my own kind of identifier that behaves differently than Lean's built-in <code>ident</code>. For instance, <code>-</code> should be allowed within an identifier, and keywords like <code>if</code> can be identifiers. </p>\n<p>Could someone point me in the right direction? Thanks!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Sexpr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Sexpr</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Sexpr</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Sexpr</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">sexpr</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sexpr</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">sexpr</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sexpr</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sexpr</span>\n\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabSexpr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Expr</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">sexpr</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``Sexpr.symbol</span><span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkStrLit</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">getString!</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">sexpr</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">xs</span><span class=\"o\">:</span><span class=\"n\">sexpr</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">xsElab</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">elabSexpr</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">`Sexpr.list</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkListLit</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">`Sexpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">xsElab</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\">  </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"&gt;&gt;\"</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">:</span><span class=\"n\">sexpr</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;&lt;\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">elabSexpr</span><span class=\"w\"> </span><span class=\"n\">p</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;</span>\n<span class=\"c1\">-- unexpected token 'if'; expected ')'</span>\n</code></pre></div>",
        "id": 491917923,
        "sender_full_name": "Ray Myers",
        "timestamp": 1736033772
    },
    {
        "content": "<p>Looks like this overlaps with this question as luck would have it...</p>\n<p><a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/How.20can.20I.20parse.20custom.20tokens.20with.20the.20Lean.20Parser.3F\">#general &gt; How can I parse custom tokens with the Lean Parser?</a></p>",
        "id": 491952287,
        "sender_full_name": "Ray Myers",
        "timestamp": 1736069412
    },
    {
        "content": "<p>I had quite a similar few days ago (the overlapping question you linked).</p>\n<p>I found a few solutions:</p>\n<ol>\n<li>You can roll your own parser for identifiers. It's fiddly and tedious and requires a lot of effort to work well, but it allows you to define identifiers exactly like you want them.</li>\n<li>Instead of <code>ident</code>, use <code>rawIdent</code> (<code>Lean.Parser.rawIdent</code>) in your <code>syntax</code> declaration (but keep using <code>ident</code> in the syntax quotations). <code>rawIdent</code> is a similar to <code>ident</code>, but which ignores the registered tokens and that doesn't support namespacing. It doesn't give you full control over what's an allowed identifier, but it's perfect for prototyping.</li>\n<li>Use <code>«if»</code> instead of <code>if</code>, that way the <code>ident</code> parser treats it as an identifier rather than a keyword.</li>\n</ol>",
        "id": 491953629,
        "sender_full_name": "Spanky",
        "timestamp": 1736070783
    }
]