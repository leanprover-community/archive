[
    {
        "content": "<p>Is there a way to get the current <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lake.Workspace#doc\">docs#Lake.Workspace</a> (if <code>lake</code> is running) in say <code>CommandElabM</code>? I managed to obtain a <code>Lake.LoadConfig</code>, but this is not enough as far as I can tell:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">CLI</span><span class=\"bp\">.</span><span class=\"n\">Main</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#foobaz\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elanInstall?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">leanInstall?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lakeInstall?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">findInstall?</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftIO</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">MonadError</span><span class=\"bp\">.</span><span class=\"n\">runEIO</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">    </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">mkLoadConfig</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">elanInstall?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">leanInstall?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lakeInstall?</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{config.lakeDir}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">foobaz</span>\n</code></pre></div>\n<p>More specifically, I would like to get a list of the dependencies of the current project in a command.</p>",
        "id": 566796087,
        "sender_full_name": "Christian Merten",
        "timestamp": 1767810198
    },
    {
        "content": "<p>You might find some useful code in Mathlib's <a href=\"https://github.com/leanprover-community/mathlib4/blob/6ec3a4cecb338d7f672126ef95e356bbe8ac21cb/scripts/lint-style.lean#L80\"><code>scripts/lint-style.lean</code></a>, which uses Lake to parse options from the Lakefile.</p>",
        "id": 566921864,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1767872083
    },
    {
        "content": "<p>On the other hand, maybe it would be easier to parse <code>lake-manifest.json</code> yourself?</p>",
        "id": 566921984,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1767872132
    },
    {
        "content": "<p>The code you linked to unfortunately calls <code>getWorkspaceRoot</code> which in turn calls <a href=\"https://github.com/leanprover-community/mathlib4/blob/6ec3a4cecb338d7f672126ef95e356bbe8ac21cb/scripts/lint-style.lean#L38\"><code>Lake.loadWorkspace</code></a>. Running this in a command triggers an infinite recursion:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">CLI</span><span class=\"bp\">.</span><span class=\"n\">Main</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#foobaz\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elanInstall?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">leanInstall?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lakeInstall?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">findInstall?</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftIO</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">MonadError</span><span class=\"bp\">.</span><span class=\"n\">runEIO</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">    </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">mkLoadConfig</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">elanInstall?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">leanInstall?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lakeInstall?</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">workspace</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">loadWorkspace</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toBaseIO</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"failed to load Lake workspace\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">foobaz</span>\n</code></pre></div>",
        "id": 566922688,
        "sender_full_name": "Christian Merten",
        "timestamp": 1767872447
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Access.20lake.20workspace.20during.20elaboration/near/566921984\">said</a>:</p>\n<blockquote>\n<p>On the other hand, maybe it would be easier to parse <code>lake-manifest.json</code> yourself?</p>\n</blockquote>\n<p>This is what I have been doing, but seems a bit hacky. That's why I asked if there is a intended way to do this. But thanks, I guess I'll stick to manual parsing for now.</p>",
        "id": 566923048,
        "sender_full_name": "Christian Merten",
        "timestamp": 1767872590
    }
]