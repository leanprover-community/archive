[
    {
        "content": "<h1>New <code>monomorphize</code> tactic</h1>\n<p><span class=\"user-mention\" data-user-id=\"346696\">@Chase Norman</span>  and I developed <code>monomorphize</code>, a new tactic which eliminates typeclass instances from a goal.<br>\nIt comes pre-packaged with <a href=\"#narrow/channel/113486-announce/topic/Canonical.20is.20available.20now!/near/517154362\">Canonical</a>, and powers its new support for typeclass instance.</p>\n<p>In this example, <code>add_comm</code> is specialized to <code>Nat</code>, since the problem is about natural numbers.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Canonical</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">canonicalize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  add_comm_0 : ∀ (a b : ℕ), a + b = b + a</span>\n<span class=\"cm\">  ⊢ x + y = y + x</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>\n<p>If <code>canonicalize</code> is enabled, all operations involving instances will be replaced with specialized versions.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  HAdd_hAdd_0 : ℤ → ℤ → ℤ</span>\n<span class=\"cm\">  Nat_cast_0 : ℕ → ℤ</span>\n<span class=\"cm\">  HMul_hMul_0 : ℤ → ℤ → ℤ</span>\n<span class=\"cm\">  ⊢ HAdd_hAdd_0 (Nat_cast_0 n) z = HMul_hMul_0 (Nat_cast_0 n) z</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>\n<p>If there are multiple matching instances for a type class, all possible monomorphizations will be generated.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  add_comm_0 : ∀ (a b : ℕ), HAdd_hAdd_0 a b = HAdd_hAdd_0 b a</span>\n<span class=\"cm\">  add_comm_1 : ∀ (a b : ℝ), HAdd_hAdd_1 a b = HAdd_hAdd_1 b a</span>\n<span class=\"cm\">  HAdd_hAdd_1 : ℝ → ℝ → ℝ</span>\n<span class=\"cm\">  HAdd_hAdd_0 : ℕ → ℕ → ℕ</span>\n<span class=\"cm\">  Nat_cast_0 : ℕ → ℝ</span>\n<span class=\"cm\">  OfNat_ofNat_0 : ℕ → ℕ</span>\n<span class=\"cm\">  ⊢ Nat_cast_0 (HAdd_hAdd_0 x (OfNat_ofNat_0 10)) = HAdd_hAdd_1 a b</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>\n<p>Instances with parameters have their parameters propagated to the monomorphized symbol.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  HAdd_hAdd_0 : ℕ → ℕ → ℕ</span>\n<span class=\"cm\">  HAppend_hAppend_0 : (α : Type) → (n m : ℕ) → Vector α n → Vector α m → Vector α (HAdd_hAdd_0 n m)</span>\n<span class=\"cm\">  ⊢ HAppend_hAppend_0 α n n v v = HAppend_hAppend_0 α n n v v</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  add_comm_0 : ∀ (x_0 : ℕ) (a b : ZMod x_0), HAdd_hAdd_0 x_0 a b = HAdd_hAdd_0 x_0 b a</span>\n<span class=\"cm\">  HAdd_hAdd_0 : (n : ℕ) → ZMod n → ZMod n → ZMod n</span>\n<span class=\"cm\">  ⊢ HAdd_hAdd_0 n x y = HAdd_hAdd_0 n x y</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>\n<p>Instances can come from the local context.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">*</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pow_two</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  pow_two_0 : ∀ (a : X), HPow_hPow_0 a (OfNat_ofNat_0 2) = HMul_hMul_0 a a</span>\n<span class=\"cm\">  HMul_hMul_0 : X → X → X</span>\n<span class=\"cm\">  OfNat_ofNat_0 : ℕ → ℕ</span>\n<span class=\"cm\">  HPow_hPow_0 : X → ℕ → X</span>\n<span class=\"cm\">  ⊢ HPow_hPow_0 x (OfNat_ofNat_0 2) = HMul_hMul_0 x x</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">default</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  Inhabited_default_0 : X</span>\n<span class=\"cm\">  ⊢ X</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>\n<p>Instances that are not found by other means can by generated by <code>synthInstance</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">zpowRec</span><span class=\"w\"> </span><span class=\"c1\">-- {G : Type} [One G] [Mul G] [Inv G] : (ℕ → G → G) → ℤ → G → G</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">zpowRec</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  zpowRec_0 : (ℕ → ℚ → ℚ) → ℤ → ℚ → ℚ</span>\n<span class=\"cm\">  HMul_hMul_0 : ℚ → ℚ → ℚ</span>\n<span class=\"cm\">  ⊢ HMul_hMul_0 a b = HMul_hMul_0 a b</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>\n<p>Bonus:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">monomorphize</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  OfNat_ofNat_1 : ℕ → ℕ</span>\n<span class=\"cm\">  OfNat_ofNat_0 : ℕ → ℝ</span>\n<span class=\"cm\">  ⊢ OfNat_ofNat_0 (OfNat_ofNat_1 8) = OfNat_ofNat_0 (OfNat_ofNat_1 8)</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>",
        "id": 534715883,
        "sender_full_name": "One An",
        "timestamp": 1755293706
    },
    {
        "content": "<p>Stupid remark: Isn't the verb for \"making things canonical\" <code>canonize</code> instead of <code>canonicalize</code>?</p>",
        "id": 534739446,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755321353
    },
    {
        "content": "<p>I had the same remark for Mario in some PR =)</p>",
        "id": 534749418,
        "sender_full_name": "Alok Singh",
        "timestamp": 1755333930
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Monomorphize.20Tactic/near/534739446\">said</a>:</p>\n<blockquote>\n<p>Stupid remark: Isn't the verb for \"making things canonical\" <code>canonize</code> instead of <code>canonicalize</code>?</p>\n</blockquote>\n<p>Canonize doesn't mean to normalize. Canonicalize on the other hand does mean to normalize.</p>",
        "id": 534769873,
        "sender_full_name": "(deleted)",
        "timestamp": 1755359004
    },
    {
        "content": "<p>To me, canonize means to add into the canon. Perhaps there is an entirely different name that makes more sense.</p>",
        "id": 534783263,
        "sender_full_name": "Chase Norman",
        "timestamp": 1755376625
    }
]