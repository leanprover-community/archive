[
    {
        "content": "<p>Can someone give me a \"hello world\" example of a custom <code>KeyedDeclsAttribute</code>? So far I have managed to piece together the following, but it still doesn't let me use the attribute.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">greeterAttr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"greeter\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">attr</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Greeter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">greeters</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KeyedDeclsAttribute</span><span class=\"w\"> </span><span class=\"n\">Greeter</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span>\n<span class=\"w\">  </span><span class=\"n\">mkElabAttribute</span><span class=\"w\"> </span><span class=\"n\">Greeter</span><span class=\"w\"> </span><span class=\"ss\">`builtin_greeter</span><span class=\"w\"> </span><span class=\"ss\">`greeter</span><span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"ss\">``Greeter</span><span class=\"w\"> </span><span class=\"s2\">\"greeter\"</span><span class=\"w\"> </span><span class=\"n\">decl_name</span><span class=\"bp\">%</span>\n</code></pre></div>\n<p>And then in another file:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">greeter</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"c1\">-- unknown attribute `greeterAttr`</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Greeter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 570660789,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769634763
    },
    {
        "content": "<p>maybe don't use builtin initialize?</p>",
        "id": 570662622,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769635466
    },
    {
        "content": "<p>Using <code>initialize</code> instead doesn't help unfortunately.</p>",
        "id": 570663089,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769635645
    },
    {
        "content": "<p>I'll try take a look at the code</p>",
        "id": 570663220,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769635691
    },
    {
        "content": "<p>wow I can't tell if this is supposed to be used</p>",
        "id": 570663635,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769635832
    },
    {
        "content": "<p>reading the docs really gives the impression it's only for builtin attributes</p>",
        "id": 570663697,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769635860
    },
    {
        "content": "<p>your <code> `greeter</code> might need to be a <code> ``greeterAttr</code></p>",
        "id": 570665242,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769636489
    },
    {
        "content": "<p>and yes, definitely not <code>builtin_initialize</code></p>",
        "id": 570665270,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769636501
    },
    {
        "content": "<p>that's for bootstrapping stuff</p>",
        "id": 570665303,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769636517
    },
    {
        "content": "<p><code>KeyedDeclsAttribute</code> does not appear anywhere in Mathlib. This is a very bad omen.</p>",
        "id": 570665600,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1769636625
    },
    {
        "content": "<p>With <code>''greeterAttr</code> I now get \"Unexpected attribute argument\" when using the attribute. At least that's a different error message, so, progress!</p>",
        "id": 570667200,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769637312
    },
    {
        "content": "<p>How does the <code>@[macro]</code> attribute work? In the Lean compiler source, there is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkMacroAttributeUnsafe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">KeyedDeclsAttribute</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">mkElabAttribute</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"ss\">`builtin_macro</span><span class=\"w\"> </span><span class=\"ss\">`macro</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Macro</span><span class=\"w\"> </span><span class=\"s2\">\"macro\"</span><span class=\"w\"> </span><span class=\"n\">ref</span>\n\n<span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">macroAttribute</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KeyedDeclsAttribute</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">mkMacroAttribute</span><span class=\"w\"> </span><span class=\"n\">decl_name</span><span class=\"bp\">%</span>\n</code></pre></div>\n<p>Which seems almost exactly like what I'm doing, and yet my version doesn't work :(.</p>",
        "id": 570669120,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769638088
    },
    {
        "content": "<p>Well you need to specify an argument. I'll give you a rough idea of how to use elab attributes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Greeter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">greeting</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">greeters</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">KeyedDeclsAttribute</span><span class=\"w\"> </span><span class=\"n\">Greeter</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span>\n<span class=\"w\">  </span><span class=\"n\">mkElabAttribute</span><span class=\"w\"> </span><span class=\"n\">Greeter</span><span class=\"w\"> </span><span class=\"ss\">`builtin_greeter</span><span class=\"w\"> </span><span class=\"ss\">`greeter</span><span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"ss\">``Greeter</span><span class=\"w\"> </span><span class=\"s2\">\"greeter\"</span><span class=\"w\"> </span><span class=\"n\">decl_name</span><span class=\"bp\">%</span>\n\n<span class=\"c1\">-- idk why core doesn't have this</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadMacroAdapter</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getNextMacroScope</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getThe</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">nextMacroScope</span>\n<span class=\"w\">  </span><span class=\"n\">setNextMacroScope</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">modifyThe</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">nextMacroScope</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">runGreeterFor</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">liftMacroM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">expandMacroImpl?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">decl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stxNew?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stxNew</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">liftMacroM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">liftExcept</span><span class=\"w\"> </span><span class=\"n\">stxNew?</span>\n<span class=\"w\">    </span><span class=\"n\">runGreeterFor</span><span class=\"w\"> </span><span class=\"n\">stxNew</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getKind</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">candidates</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">greeters</span><span class=\"bp\">.</span><span class=\"n\">getEntries</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">kind</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">saveState</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">candidate</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">candidates</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">try</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">candidate</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">      </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">unsupportedSyntaxExceptionId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">restore</span>\n<span class=\"w\">          </span><span class=\"k\">else</span>\n<span class=\"w\">            </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">ex</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">ex</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>\n<p>Other file:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hiThere</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"hi!\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">greeting</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">greeter</span><span class=\"w\"> </span><span class=\"n\">hiThere</span><span class=\"kd\">]</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"n\">meta</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">greetHiThere</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Greeter</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">greeting</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">hi!</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"Hi, there!\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"n\">runGreeterFor</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">greeting</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">hi!</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 570669150,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769638102
    },
    {
        "content": "<p>(code adjusted from the definition of <code>elabTerm</code>)</p>",
        "id": 570669352,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769638187
    },
    {
        "content": "<p>Is that also using <code>syntax (name := greeterAttr) \"greeter\" : attr</code> ?</p>",
        "id": 570670050,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769638460
    },
    {
        "content": "<p>No, not at all</p>",
        "id": 570671100,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769638870
    },
    {
        "content": "<p>We don't define syntax for the attribute</p>",
        "id": 570671111,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769638875
    },
    {
        "content": "<p>I think if we did, it would be confused because it already expects a certain builtin attribute syntax</p>",
        "id": 570671189,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769638915
    },
    {
        "content": "<p>Now, you probably also want</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Basically, code copied from Lean.Elab.ElabRules</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabElabRulesGreetingAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">doc?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``docComment</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">attrs?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSepArray</span><span class=\"w\"> </span><span class=\"ss\">``attrInstance</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``attrKind</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">alts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``matchAlt</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">alts</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">alts</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">alt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``matchAlt</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">alt</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">matchAltExpr</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">pats</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rhs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pats</span><span class=\"bp\">.</span><span class=\"n\">elemsAndSeps</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">pat</span><span class=\"bp\">.</span><span class=\"n\">isQuot</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">quoted</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">getQuotContent</span><span class=\"w\"> </span><span class=\"n\">pat</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">quoted</span><span class=\"bp\">.</span><span class=\"n\">getKind</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">checkRuleKind</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">alt</span>\n<span class=\"w\">      </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">k'</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">choiceKind</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">         </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">quoted</span><span class=\"bp\">.</span><span class=\"n\">getArgs</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">quotAlt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">checkRuleKind</span><span class=\"w\"> </span><span class=\"n\">quotAlt</span><span class=\"bp\">.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">         </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">        </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">alt</span><span class=\"w\"> </span><span class=\"s2\">\"invalid elab_rules alternative, expected syntax node kind `{k}`\"</span>\n<span class=\"w\">         </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">quoted</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pat</span><span class=\"bp\">.</span><span class=\"n\">setArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">quoted</span>\n<span class=\"w\">           </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pats</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">pats</span><span class=\"bp\">.</span><span class=\"n\">elemsAndSeps</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">pat</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">           </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">matchAltExpr</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">pats</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rhs</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">alt</span><span class=\"w\"> </span><span class=\"s2\">\"invalid elab_rules alternative, unexpected syntax node kind `{k'}`\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mkAttrs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntaxArray</span><span class=\"w\"> </span><span class=\"ss\">``attrInstance</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">attrInstance</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">attrKind</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"o\">):</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">mkIdentFromRef</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">):</span><span class=\"n\">ident</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">attrs?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">attrs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">attrs</span><span class=\"bp\">.</span><span class=\"n\">getElems</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">attr</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">attr</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">vis</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">visibility</span><span class=\"bp\">.</span><span class=\"n\">ofAttrKind</span><span class=\"w\"> </span><span class=\"n\">attrKind</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">doc?</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">mkAttrs</span><span class=\"w\"> </span><span class=\"ss\">`greeter</span><span class=\"o\">),</span><span class=\"bp\">*</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">vis</span><span class=\"o\">:</span><span class=\"n\">visibility</span>\n<span class=\"w\">    </span><span class=\"n\">aux_def</span><span class=\"w\"> </span><span class=\"n\">elabRules</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Greeter</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">$</span><span class=\"n\">alts</span><span class=\"o\">:</span><span class=\"n\">matchAlt</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">no_error_if_unused</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"bp\">¬´</span><span class=\"n\">elab_rules</span><span class=\"bp\">¬ª</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabElabRulesGreeting</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">adaptExpander</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">doc?</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"kd\">@[</span><span class=\"bp\">$</span><span class=\"n\">attrs?</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"kd\">]</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">attrKind</span><span class=\"o\">:</span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">kind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">greeting</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">alts</span><span class=\"o\">:</span><span class=\"n\">matchAlt</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">elabElabRulesGreetingAux</span><span class=\"w\"> </span><span class=\"n\">doc?</span><span class=\"w\"> </span><span class=\"n\">attrs?</span><span class=\"w\"> </span><span class=\"n\">attrKind</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">resolveSyntaxKind</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">alts</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>\n</div></div>\n<p>so you can do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"hi!\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">greeting</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"Hi, there!\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"n\">runGreeterFor</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">greeting</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">hi!</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 570671365,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769638986
    },
    {
        "content": "<p>Oh huh, I was not aware these attributes take an argument. But this actually solves a second issue I was about to have, so that's great!</p>",
        "id": 570672524,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769639520
    },
    {
        "content": "<p>So, if I understand it correctly, for example <code>macro_rules</code> generates a <code>@[macro theParser] def ...</code> for every match arm, where <code>theParser</code> is the top level parser of the match arm?</p>",
        "id": 570672785,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769639644
    },
    {
        "content": "<p>(or elab_rules, either way)</p>",
        "id": 570672900,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769639713
    },
    {
        "content": "<p>All right I think I get it! This is cool! Thanks a lot for the help!</p>",
        "id": 570673040,
        "sender_full_name": "Max Nowak üêâ",
        "timestamp": 1769639786
    }
]