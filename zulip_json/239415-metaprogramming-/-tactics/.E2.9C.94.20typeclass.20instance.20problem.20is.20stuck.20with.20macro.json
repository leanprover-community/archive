[
    {
        "content": "<p>I was trying out a silly example with macros and I'm running into this typeclass instance error, but I don't really understand why.<br>\nThe only thing I'm doing is transforming things into <code>True</code> using a notation, and otherwise recursively applying it.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">test1</span>\n<span class=\"w\">  </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"μ\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandBar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">True</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">Q</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">Q</span><span class=\"o\">))</span><span class=\"w\">  </span><span class=\"c1\">-- Error here</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">test1</span>\n</code></pre></div>\n<p>The thing I don't understand is that the error is about the <code>Bind</code> typeclass:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">typeclass</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">problem</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">stuck</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">often</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">metavariables</span>\n<span class=\"w\">  </span><span class=\"n\">Bind</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1017</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr</span><span class=\"bp\">✝²</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr</span><span class=\"bp\">✝¹</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Do I need to add more information to the quoted terms or do something else?</p>",
        "id": 479454607,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1730200703
    },
    {
        "content": "<p>It might help to look at the result of macro expansion to understand what is complaining:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">macro</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandBar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">    </span><span class=\"n\">let_fun</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">`test1.bar</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">let_fun</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr_1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr</span><span class=\"bp\">.</span><span class=\"n\">getArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">let_fun</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr_2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr</span><span class=\"bp\">.</span><span class=\"n\">getArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">MonadRef</span><span class=\"bp\">.</span><span class=\"n\">mkInfoFromRefPos</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">scp</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getCurrMacroScope</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mainModule</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainModule</span>\n<span class=\"w\">        </span><span class=\"n\">pure</span>\n<span class=\"w\">            </span><span class=\"o\">({</span>\n<span class=\"w\">              </span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">                </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">node3</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Term.arrow</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">node3</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Term.paren</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"o\">)</span>\n<span class=\"w\">                    </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">node2</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"ss\">`test1.bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"s2\">\"μ\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">))</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"s2\">\"-&gt;\"</span><span class=\"o\">)</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">node3</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Term.paren</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"o\">)</span>\n<span class=\"w\">                    </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">node2</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"ss\">`test1.bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"s2\">\"μ\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">}:</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">let_fun</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr_2</span><span class=\"w\"> </span><span class=\"o\">}:</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">MonadRef</span><span class=\"bp\">.</span><span class=\"n\">mkInfoFromRefPos</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">scp</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getCurrMacroScope</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mainModule</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainModule</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span>\n<span class=\"w\">          </span><span class=\"o\">({</span>\n<span class=\"w\">              </span><span class=\"n\">raw</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">                </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"s2\">\"True\"</span><span class=\"bp\">.</span><span class=\"n\">toSubstring'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">addMacroScope</span><span class=\"w\"> </span><span class=\"n\">mainModule</span><span class=\"w\"> </span><span class=\"ss\">`True</span><span class=\"w\"> </span><span class=\"n\">scp</span><span class=\"o\">)</span>\n<span class=\"w\">                  </span><span class=\"o\">[</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Preresolved</span><span class=\"bp\">.</span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"ss\">`True</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Preresolved</span><span class=\"bp\">.</span><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"ss\">`True</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">}:</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">raw</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">let_fun</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">discr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n</code></pre></div>",
        "id": 479455745,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730201121
    },
    {
        "content": "<p>The error is because <code>rhs</code> is unused, so lean doesn't have enough information to infer the type. The reason it is unused is because the constructed case tree doesn't use it, which is because the second branch of the pattern is unreachable because the first branch shadows it</p>",
        "id": 479456127,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730201252
    },
    {
        "content": "<p>in other words, this is a poor way of reporting a \"redundant alternative\" error</p>",
        "id": 479456349,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730201329
    },
    {
        "content": "<p>Ahhh, I'm an idiot... I was putting it in the incorrect order, thinking about macro_rules and how the last one is the first to apply. But since I'm doing the match explicitly here it is picking up the cases differently</p>",
        "id": 479466673,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1730204661
    },
    {
        "content": "<p>ty !</p>",
        "id": 479466679,
        "sender_full_name": "Tomás Díaz",
        "timestamp": 1730204663
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479841\">Tomás Díaz</span> has marked this topic as resolved.</p>",
        "id": 479466831,
        "sender_full_name": "Notification Bot",
        "timestamp": 1730204734
    }
]