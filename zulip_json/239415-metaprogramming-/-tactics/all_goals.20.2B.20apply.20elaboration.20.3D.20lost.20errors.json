[
    {
        "content": "<p>Does anyone know a workaround for the following issue, until the bug is fixed? It pops up in a set of tactics I implemented for didactics and it is currently affecting my class badly</p>\n<p><a href=\"https://github.com/leanprover/lean4/issues/4888\">https://github.com/leanprover/lean4/issues/4888</a></p>\n<p>Basically, if all_goals is fed a tactic that uses a term that fails to typecheck, the error is completely swallowed and ignored<br>\nand the tactic succeds.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bug</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\"> </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\">   </span><span class=\"c1\">-- Nat.succ True is not well typed, but the tactic succeeds</span>\n<span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 474298903,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1727875975
    },
    {
        "content": "<p>This is very interesting!  I wonder whether it is related to the fact that <code>logStuff</code> does not get reliably logged.  The error that the tactic is trying to generate is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">here</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">sorryAx</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">succ</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>\n<p>I think, but <code>logException</code> of that does nothing.</p>",
        "id": 474362995,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727891943
    },
    {
        "content": "<p>See <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.evalAllGoals#doc\">docs#Lean.Elab.Tactic.evalAllGoals</a>, <a href=\"https://github.com/leanprover/lean4/blob/dc2533473114eb8656439ff2b9335209784aa640/src/Lean/Elab/Tactic/BuiltinTactic.lean#L273\">this line</a>.</p>",
        "id": 474363245,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727892009
    },
    {
        "content": "<p>It looks like the code goes there, but <code>logException</code> does not do its thing.</p>",
        "id": 474363304,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727892031
    },
    {
        "content": "<p>In fact, replacing that line with <code>logInfo ex.toMessageData</code> shows the \"correct\" error message.</p>",
        "id": 474363542,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727892107
    },
    {
        "content": "<p>This may be a minimization of sorts.  It also highlights a problem that I have observed elsewhere that <code>logInfo</code> and friends can be really slow if you do not explicitly add a type ascription.</p>",
        "id": 474365845,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727892969
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"all_goals1 \"</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">:</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarIds</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getGoals</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">mvarIds</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">try</span>\n<span class=\"w\">        </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">raw</span>\n<span class=\"w\">      </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">recover</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"I am printed\"</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">logException</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- this speeds up a lot!</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bug</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\"> </span><span class=\"n\">all_goals1</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\">   </span><span class=\"c1\">-- Nat.succ True is not well typed, but the tactic succeeds</span>\n<span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 474365853,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727892972
    },
    {
        "content": "<p>Actually, this is enough for the reported issue:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"all_goals1 \"</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">:</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">try</span>\n<span class=\"w\">    </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"I am printed\"</span>\n<span class=\"w\">    </span><span class=\"n\">logException</span><span class=\"w\"> </span><span class=\"n\">ex</span>\n</code></pre></div>",
        "id": 474366085,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727893069
    },
    {
        "content": "<p>Wrapping calls to all_goals (and to all Lean tactics implemented on top of it, like &lt;;&gt;) with either withoutRecover or withouthErrToSorry yields the behaviour I would expect.  At this point I am quite confused though: is my reported issue valid or are tactic invocations like \"all_goals exact Nat.succ True\" or \" tac &lt;.&gt; exact Nat.succ True\" really NOT supposed to fail?</p>",
        "id": 474399798,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1727904260
    },
    {
        "content": "<p>My expectation is that they should fail.  The logException step makes me suspect that this is indeed the intended (and unachieved) behaviour as well.</p>",
        "id": 474400970,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727904541
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"733059\">@Claudio Sacerdoti Coen</span> would you be able to open an issue on the lean4 repository reporting this?</p>",
        "id": 474541438,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727949001
    },
    {
        "content": "<p>Is it not <a href=\"https://github.com/leanprover/lean4/pull/4888\">lean4#4888</a> ?</p>",
        "id": 474541750,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727949070
    },
    {
        "content": "<p>Yes, it is. I added there a link to this chat as well</p>",
        "id": 474556939,
        "sender_full_name": "Claudio Sacerdoti Coen",
        "timestamp": 1727952811
    },
    {
        "content": "<p>I suspect that this is an even further minimization:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"done_or_fail\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">try</span>\n<span class=\"w\">    </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">done</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"bp\">.</span><span class=\"n\">toMessageData</span>\n<span class=\"w\">    </span><span class=\"n\">logException</span><span class=\"w\"> </span><span class=\"n\">ex</span>\n\n<span class=\"sd\">/-- info: internal exception #4 -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">done_or_fail</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 474566077,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727954984
    }
]