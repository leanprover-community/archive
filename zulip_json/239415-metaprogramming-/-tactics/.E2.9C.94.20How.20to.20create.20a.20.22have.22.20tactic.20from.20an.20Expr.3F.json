[
    {
        "content": "<p>I want to create a <code>have</code> tactic from an <code>Expr</code>  - but I failed: I have no idea how to convert an <code>Expr</code> into the needed type which is IMHO a \"TSyntax `term\". (Creating a new Ident kind of works.)</p>\n<p>Here is a complete - but unfortunately not running - example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"testTactic\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goalType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MVarId</span><span class=\"bp\">.</span><span class=\"n\">getType</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"goalType [{goalType}]\"</span>\n<span class=\"w\">  </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Get the lhs from the Eq expression</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">goalType</span><span class=\"bp\">.</span><span class=\"n\">getArg!</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"w\">    </span><span class=\"c1\">-- Failed attempts</span>\n<span class=\"w\">    </span><span class=\"c1\">--let lhsSyntax : TSyntax `term := Lean.quote lhs</span>\n<span class=\"w\">    </span><span class=\"c1\">--let lhsSyntax : TSyntax `term := `( $lhs )</span>\n<span class=\"w\">    </span><span class=\"c1\">--let lhsSyntax := `($lhs:term)</span>\n<span class=\"w\">    </span><span class=\"c1\">--let lhsSyntax := `( $lhs )</span>\n<span class=\"w\">    </span><span class=\"c1\">--let lhsSyntax : TSyntax `term := `($lhs)</span>\n<span class=\"w\">    </span><span class=\"c1\">--let lhsSyntax : TSyntax `term := (← ($lhs))</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Also prettyPrint and then trying to use the string.</span>\n<span class=\"w\">    </span><span class=\"c1\">--let lhsStr ← Lean.Meta.ppExpr lhs</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">haveName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">`h1</span>\n<span class=\"w\">    </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">haveName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">lhsSyntax</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Created hypothesis: {lhsSyntax} = True\"</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">testTactic</span>\n</code></pre></div>\n<p>How to convert the <code>lhs</code> that it can be used in a <code>have</code> tactic?</p>\n<p>Supplementary question: The <code>sorry</code> is here only for development and debugging. In my tactic I want to add the complete proof step by step. Is there a way to have an \"open\" <code>have</code> tactic, which means to end at <code>:= by</code> ?<br>\nWhen not adding a proof, or at least <code>:= by sorry</code> I get the error <code>unexpected token</code>.</p>\n<p>Any idea?<br>\nAlso any hint to documentation about this topic is highly appreciated.</p>",
        "id": 472077305,
        "sender_full_name": "florath",
        "timestamp": 1727033371
    },
    {
        "content": "<p>I think <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Expr.toSyntax#doc\">docs#Lean.Expr.toSyntax</a> is the <code>Expr</code>-to-<code>Syntax</code> function you are looking for.  That is, after importing <code>Batteries.Lean.Expr</code>, you can do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">toSyntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">goalType</span><span class=\"bp\">.</span><span class=\"n\">getArg!</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 472077997,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1727033946
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"706789\">florath</span> <a href=\"#narrow/stream/239415-metaprogramming-.2F-tactics/topic/How.20to.20create.20a.20.22have.22.20tactic.20from.20an.20Expr.3F/near/472077305\">said</a>:</p>\n<blockquote>\n<p>Supplementary question: The <code>sorry</code> is here only for development and debugging. In my tactic I want to add the complete proof step by step. Is there a way to have an \"open\" <code>have</code> tactic, which means to end at <code>:= by</code> ?<br>\nWhen not adding a proof, or at least <code>:= by sorry</code> I get the error <code>unexpected token</code>.</p>\n</blockquote>\n<p>Do you just want to create a second goal?  If so, I think this works (creating a second goal called <code>haveGoal</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">haveName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">haveGoal</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 472078217,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1727034137
    },
    {
        "content": "<p>By the way, you can achieve the same effect as <code>have</code> in meta code (with no <code>Syntax</code>) with <code>MVarId.assert</code> and friends (e.g. <code>assertHypotheses</code>) :) <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.assertHypotheses#doc\">docs#Lean.MVarId.assertHypotheses</a></p>",
        "id": 472078257,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1727034203
    },
    {
        "content": "<p>(And using a fresh metavariable as the value of the asserted expression is completely legal! :) )</p>",
        "id": 472078534,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1727034411
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> : Thanks a lot. The <code>toSyntax</code> does the job.</p>\n<p>Supplementary question: Yes - I want to add a second goal to proof the have-statement (hypothesis). The <code>?haveGoal</code> does not work for me: <code>unexpected token '?'; expected '{' or tactic</code></p>",
        "id": 472078704,
        "sender_full_name": "florath",
        "timestamp": 1727034576
    },
    {
        "content": "<p>Given that message, I think you might be writing <code>:= by ?haveGoal</code> instead of <code>:= ?haveGoal</code>!</p>",
        "id": 472078777,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1727034625
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> thanks for the hint to the <code>by</code>. My fault!</p>\n<p>Also thanks for the hint to programmatically use tactics. I have only very limited experience (as you see) and I find it very hard to correctly handle the different return values of different tactics. Some return one, some others two or more results. Some are goals that need to be set, some are proofs that need to be applied (when I correctly remember I failed using the <code>byCases</code> tactic programmatically). As for now I'd like to stick with the approach of using <code>evalTactic</code> everywhere in my program; in addition to applying the tactics, my program collects and outputs all tactics. I'm using something like the following for the tactics buffer.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tBEvalAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"w\">  </span><span class=\"n\">tBAdd</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"bp\">...</span>\n<span class=\"n\">tBEvalAdd</span><span class=\"w\"> </span><span class=\"n\">tBTrue</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">))</span>\n<span class=\"bp\">...</span>\n<span class=\"n\">tBWriteLog</span><span class=\"w\"> </span><span class=\"n\">tBTrue</span>\n</code></pre></div>\n<p>Having programmatic calls to tactics would complicate this approach.</p>",
        "id": 472080394,
        "sender_full_name": "florath",
        "timestamp": 1727036063
    },
    {
        "content": "<p>Ah, makes sense! :) Note: as a potential gotcha that arises with doing things this way, be mindful of inserting <code>withMainContext</code>s after <code>evalTactic</code> if you go back into meta code afterwards, as <code>evalTactic</code> does not (cannot) alter the ambient local context (only the goal list and <code>MetaM</code> state).</p>\n<p>(You probably don’t need to worry about doing this after <em>every</em> single <code>evalTactic</code>, though. For example, you won’t need it before additional subsequent <code>evalTactic</code>s, since all tactics should include <code>withMainContext</code> themselves. You’ll only when you do something that relies on the context, like <code>isDefEq</code>.)</p>",
        "id": 472090699,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1727044430
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"706789\">florath</span> has marked this topic as resolved.</p>",
        "id": 472125118,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727067048
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"706789\">florath</span> has marked this topic as unresolved.</p>",
        "id": 472936113,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727368650
    },
    {
        "content": "<p>I want to re-open this question.<br>\nIn principle the suggested solution works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">toSyntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">goalType</span><span class=\"bp\">.</span><span class=\"n\">getArg!</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">haveName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">haveGoal</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>and it executes correctly in the current context.<br>\nBut in addition to executing the tactic I want to store it - because I want to re-apply the tactic later on (within a different context).</p>\n<p>The problem is, that execution at a later point of time fails. Example: the lhs is converted to a syntax:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"k\">forall</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">]</span>\n<span class=\"n\">lhsSyntax</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"bp\">✝</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which results in:</p>\n<p><code>have  h  :  ?  a  =  False  :=  ?  haveGoal</code></p>\n<p>Here is a fully working minimal example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Syntax</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tBAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">tactic</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tBEvalAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tBAdd</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">tBDebugLog</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tacticStrs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">reprint</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tstr</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">tacticStrs</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"tacticBuffer [{tstr}]\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleImp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhsI</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">lhs</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhsIS</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lhsI</span><span class=\"bp\">.</span><span class=\"n\">consumeMData</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhsSyntax</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">toSyntax</span><span class=\"w\"> </span><span class=\"n\">lhsIS</span>\n\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"handleImp: lhs false -lhs [{lhs}]\"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"handleImp: lhs false -lhsI [{lhsI}]\"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"handleImp: lhs false -lhsIS [{lhsIS}]\"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"handleImp: lhs false -lhsSyntax [{lhsSyntax}]\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tB</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">([]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tB</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">tBEvalAdd</span><span class=\"w\"> </span><span class=\"n\">tB</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">lhsSyntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">haveGoal</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">tBDebugLog</span><span class=\"w\"> </span><span class=\"n\">tB</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"handle_logic\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">  </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">handleImp</span><span class=\"w\"> </span><span class=\"n\">lhs</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">handle_logic</span>\n</code></pre></div>\n<p>Is there a way to modify the <code>evalTactic ... have</code> or the output function in the way, that the complete expression (here <code>(∀ (x1 : Prop), x1)</code> ) instead of <code>?a</code> is used / printed later on?</p>\n<p>Alternative question: is there a simple way to execute a tactic that is provided as a string?<br>\nE.g.</p>\n<p><code>evalTacticStr \"decide\"</code></p>",
        "id": 472944285,
        "sender_full_name": "florath",
        "timestamp": 1727371836
    },
    {
        "content": "<p>I found a possibility to execute tactics provided as string:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">evalTacticStr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tacticStr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Use your version of runParserCategory</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`tactic</span><span class=\"w\"> </span><span class=\"n\">tacticStr</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Failed to parse tactic: {e}\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Evaluate the parsed tactic</span>\n<span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n</code></pre></div>\n<p>I still need to check how this behaves in different contexts.</p>",
        "id": 473046455,
        "sender_full_name": "florath",
        "timestamp": 1727425581
    },
    {
        "content": "<p>To finalize this:<br>\nit looks that it not a good decision to store tactics and try to execute them later (in another context). I run into a couple of different problems. (My assumption is, that a tactic stores some internals which are only valid at the point of execution.)</p>\n<p>What works for me is, storing tactics as string (resolve meta-variables and pretty print) and use the above function to execute them later in a different context.</p>",
        "id": 473451006,
        "sender_full_name": "florath",
        "timestamp": 1727617820
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"706789\">florath</span> has marked this topic as resolved.</p>",
        "id": 473451016,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727617828
    }
]