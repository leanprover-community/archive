[
    {
        "content": "<p>So, after being confused one too many times in proofs using non-canonical instances of <code>TopologicalSpace</code>, I decided to make a delaborator that will delaborate into the <code>IsOpen[t]</code> notation when the inferred topology is not what is synthesized:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabIsOpen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferTypeQ</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&lt;-</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">getExpr</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">IsOpen</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"c1\">-- fully applied</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">τ'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">trySynthInstanceQ</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">defEq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEqQ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"n\">τ'</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">IsOpen</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">τ</span><span class=\"o\">)</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"c1\">-- partially applied</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">τ'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">trySynthInstanceQ</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">defEq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEqQ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"n\">τ'</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"o\">)])</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"o\">)])</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 554527692,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762654918
    },
    {
        "content": "<p>This works, as far as I can tell, but it's clunky, repeating essentially the same code as many as four times in parts. Unfortunately the limited API around <code>LOption</code> and mixing dependently typed functions with monadic contexts make it difficult to merge cases, but I'd like to find out if I'm just missing a nicer solution. I'm also never entirely sure what best practices are with metaprogramming, so I'd appreciate some help golfing + failsafe-ing this code before PR.</p>",
        "id": 554527709,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762654940
    },
    {
        "content": "<p>oh this looks bad</p>",
        "id": 554528388,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762655804
    },
    {
        "content": "<p>glad to hear it :v</p>",
        "id": 554528399,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762655819
    },
    {
        "content": "<p>when you click on the thing in the brackets in the infoview, it shows unrelated hover info</p>",
        "id": 554528418,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762655841
    },
    {
        "content": "<p>that's why you should use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Delaborator.SubExpr.withNaryArg#doc\">docs#Lean.PrettyPrinter.Delaborator.SubExpr.withNaryArg</a></p>",
        "id": 554528436,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762655863
    },
    {
        "content": "<p>Huh. Doesn't do that on my local copy, where I've pasted the above at the bottom of <code>Mathlib.Topology.Defs.Basic</code> itself...</p>",
        "id": 554528453,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762655883
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554528436\">said</a>:</p>\n<blockquote>\n<p>that's why you should use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Delaborator.SubExpr.withNaryArg#doc\">docs#Lean.PrettyPrinter.Delaborator.SubExpr.withNaryArg</a></p>\n</blockquote>\n<p>then I can't use Qq and the code turns into an illegible stateful mess :&lt;</p>",
        "id": 554528478,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762655911
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"359992\">Robert Maxton</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554528453\">said</a>:</p>\n<blockquote>\n<p>Huh. Doesn't do that on my local copy, where I've pasted the above at the bottom of <code>Mathlib.Topology.Defs.Basic</code> itself...</p>\n</blockquote>\n<p>did you click in the infoview?</p>",
        "id": 554528491,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762655934
    },
    {
        "content": "<p>click on the subexpression in the infoview</p>",
        "id": 554528505,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762655950
    },
    {
        "content": "<p>Yeah, in the infoview.<br>\n<a href=\"/user_uploads/3121/wKygzeX8tGXwBx4VMg8upXVP/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/wKygzeX8tGXwBx4VMg8upXVP/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"509x323\" src=\"/user_uploads/thumbnail/3121/wKygzeX8tGXwBx4VMg8upXVP/image.png/840x560.webp\"></a></div>",
        "id": 554528520,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762655972
    },
    {
        "content": "<p>Actually it works in the playground too?</p>",
        "id": 554528546,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762655995
    },
    {
        "content": "<p>click on the subexpression, on the <code>f σ</code> or on the <code>s</code></p>",
        "id": 554528557,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762656004
    },
    {
        "content": "<p>you clicked on the whole expression</p>",
        "id": 554528565,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762656010
    },
    {
        "content": "<p>ah, okay</p>",
        "id": 554528580,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656032
    },
    {
        "content": "<p>also, instead of making ident <code>IsOpen</code> you <del>can</del> should just <code>failure -- fail over to the default delaborator</code></p>",
        "id": 554528635,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762656094
    },
    {
        "content": "<p>mm. </p>\n<p>The other thing is, Qq is clear enough to be self-documenting, the <code>withFoo</code> series really, really isn't</p>",
        "id": 554528755,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656260
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"359992\">@Robert Maxton</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabIsOpen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">space</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">instE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">trySynthInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">space</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getAppNumArgs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">instE</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">set</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span><span class=\"o\">)[</span><span class=\"bp\">$</span><span class=\"n\">inst</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span><span class=\"o\">)[</span><span class=\"bp\">$</span><span class=\"n\">inst</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">set</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 554528834,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762656381
    },
    {
        "content": "<p>... Well, I guess if you outright do it for me I can just use that, then :wry:</p>\n<p>I'll see if I can understand this well enough to extend it for <code>Continuous[_, _]</code>, at least.</p>\n<p>Thanks? :p</p>",
        "id": 554528899,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656469
    },
    {
        "content": "<p>I must say, this requirement of not fixing the number of arguments is a bit noncanonical</p>",
        "id": 554528939,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762656533
    },
    {
        "content": "<p>How often do you need to talk about the equality of IsOpen predicate</p>",
        "id": 554528954,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762656552
    },
    {
        "content": "<p>Almost never, but I want it to work even if you do?</p>",
        "id": 554528963,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656567
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554528939\">said</a>:</p>\n<blockquote>\n<p>I must say, this requirement of not fixing the number of arguments is a bit noncanonical</p>\n</blockquote>\n<p>what does this mean?</p>",
        "id": 554528972,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762656582
    },
    {
        "content": "<p>he wants both <code>IsOpen[t]</code> and <code>IsOpen[t] s</code> to work</p>",
        "id": 554528983,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762656598
    },
    {
        "content": "<p>It's not quite <em>free</em> (especially since someone else did the work for me this time :p) but it is a small one-time cost and ensures that the notation behaves consistently when partially applied</p>",
        "id": 554528994,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656612
    },
    {
        "content": "<p>... Also I take that back, it comes up <em>constantly</em></p>",
        "id": 554529004,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656623
    },
    {
        "content": "<p>every time you prove that a map is inducing or a quotient map, you're proving equality of some topology with <code>(co)induced</code></p>",
        "id": 554529017,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656638
    },
    {
        "content": "<p>... hm, actually, that should go straight to <code>IsOpen[σ] s ↔ IsOpen[τ] s</code></p>",
        "id": 554529103,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656733
    },
    {
        "content": "<p>oh, I think it's <code>le_def</code> I'm thinking of</p>",
        "id": 554529134,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656772
    },
    {
        "content": "<p>there's a couple places where you get illegible <code>IsOpen ≤ IsOpen</code>s, anyway; that was what motivated trying this at all</p>",
        "id": 554529165,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762656812
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"359992\">@Robert Maxton</span> take 2</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabIsOpen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">space</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">iE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">trySynthInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">space</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">iE</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span><span class=\"o\">)[</span><span class=\"bp\">$</span><span class=\"n\">inst</span><span class=\"o\">])</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getAppNumArgs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">delab</span><span class=\"o\">))</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=ₛ</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=ₛ</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 554529618,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762657372
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554528635\">said</a>:</p>\n<blockquote>\n<p>also, instead of making ident <code>IsOpen</code> you <del>can</del> should just <code>failure -- fail over to the default delaborator</code></p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> reminder to not mkident isopen</p>",
        "id": 554533075,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762662357
    },
    {
        "content": "<p>Also you used the wrong syntax</p>",
        "id": 554533096,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762662397
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554533075\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> reminder to not mkident isopen</p>\n</blockquote>\n<p>Can you clarify what you mean and why?</p>",
        "id": 554533849,
        "sender_full_name": "Chris Henson",
        "timestamp": 1762663371
    },
    {
        "content": "<p><code> ... then `($(mkIdent ``IsOpen)) else </code> can be replaced with <code>... then failure else</code></p>",
        "id": 554533879,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762663420
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"bp\">.</span><span class=\"n\">delabUnary</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">τE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">τ'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">trySynthInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">α</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">τE</span><span class=\"w\"> </span><span class=\"n\">τ'</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">failure</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)[</span><span class=\"bp\">$</span><span class=\"n\">τ</span><span class=\"o\">])</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getAppNumArgs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">delab</span><span class=\"o\">))</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabIsOpen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">delabUnary</span><span class=\"w\"> </span><span class=\"ss\">``IsOpen</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">IsClosed</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabIsClosed</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">delabUnary</span><span class=\"w\"> </span><span class=\"ss\">``IsClosed</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabClosure</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">delabUnary</span><span class=\"w\"> </span><span class=\"ss\">``closure</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"bp\">.</span><span class=\"n\">delabContinuous</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">τE₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">τ₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">τE₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">τ₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">τ₁'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">trySynthInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">α</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">τ₂'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">trySynthInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">β</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">τE₁</span><span class=\"w\"> </span><span class=\"n\">τ₁'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">τE₂</span><span class=\"w\"> </span><span class=\"n\">τ₂'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">failure</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Continuous</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">τ₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">τ₂</span><span class=\"o\">])</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getAppNumArgs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">delab</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>Refactored for better code reuse. However, the fact that I can't write <code>`($(mkIdent name)[$τ₁, $τ₂])</code> as a general <code>delabBinary</code> builder makes me think I'm doing some kind of abuse-of-syntax here, and somehow getting away with building syntax that's being initially parsed as a <code>getElem</code> and is re-interpreted as a proper <code>IsOpen[_]</code> later.</p>",
        "id": 554539785,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762670681
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> , that still looks wrong to me, I think you want</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabIsOpen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withOverApp</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">synthInst</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">trySynthInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">α</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"n\">synthInst</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">instD</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">instD</span><span class=\"o\">])</span>\n</code></pre></div>",
        "id": 554554253,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762686203
    },
    {
        "content": "<p>Otherwise you're generating <code>GetElem</code> notation on <code>IsOpen</code></p>",
        "id": 554554294,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762686260
    },
    {
        "content": "<p>I thought that was what was going on there. It's a delab, so we're getting away with it, but it's probably not exactly best practice.</p>",
        "id": 554554321,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762686299
    },
    {
        "content": "<p>You're not getting away with it, if you hover over the <code>[</code> in the infoview in the previous version it says the wrong thing (i.e., not the docstring for <code>IsOpen[</code> notation)</p>",
        "id": 554554360,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762686327
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> I see, I didn't know about withOverApp and also I wasn't thinking about getelem</p>",
        "id": 554554476,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762686441
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554528983\">said</a>:</p>\n<blockquote>\n<p>he wants both <code>IsOpen[t]</code> and <code>IsOpen[t] s</code> to work</p>\n</blockquote>\n<p>Indeed, <code>withOverApp</code> is the answer to this</p>",
        "id": 554554495,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762686457
    },
    {
        "content": "<p>I instead tried <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/PrettyPrinter/Delaborator/SubExpr.html#Lean.PrettyPrinter.Delaborator.SubExpr.withBoundedAppFn\">withBoundedAppFn</a> and got an error</p>",
        "id": 554554510,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762686475
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"359992\">@Robert Maxton</span>, could you adjust your continuity delaborator to use the style of my message, and then PR both in a single PR?</p>",
        "id": 554554561,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762686530
    },
    {
        "content": "<p>... Hm, interesting. I knew about <code>withOverApp</code>, but I usually think of it in the case of \"After fully applying this constant, the result may sometimes be a function and therefore might be further applied\", which can't be the case here because <code>IsOpen</code> becomes a <code>Prop</code>. But okay, this is a new usage for me!</p>",
        "id": 554554614,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762686599
    },
    {
        "content": "<p><code>IsOpen[t]</code> is a function, not a Prop</p>",
        "id": 554554638,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762686627
    },
    {
        "content": "<p>a function can become prop</p>",
        "id": 554554651,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762686644
    },
    {
        "content": "<p>yeah, but <code>IsOpen[t] s</code> is a <code>Prop</code>, so that's what I was focusing on</p>",
        "id": 554554654,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762686646
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/31425\">#31425</a></p>",
        "id": 554555620,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762687716
    },
    {
        "content": "<p>though if it fails CI I'll fix it tomorrow, it's late</p>",
        "id": 554555636,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762687729
    },
    {
        "content": "<p>Do I need to do anything after making the MathlibTest file? <code>mk_all</code> or the like?</p>",
        "id": 554597197,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762728087
    },
    {
        "content": "<p>Also, while the delaborator works in examples, it seems to throw 'false negatives' in <code>#check</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Topology</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">induced</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- Infoview correctly shows `IsOpen t ↔ IsOpen[induced f τ] s`:</span>\n<span class=\"c1\">-- `τ` is the only instance on β, thus 'canonical'</span>\n<span class=\"c1\">-- `induced f τ` is not defeq to the instance `σ`, thus 'noncanonical'.</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">τ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">induced</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">τ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- Printed message is `IsOpen[τ] t`; should just be `IsOpen t`</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">τ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">t</span>\n</code></pre></div>",
        "id": 554597712,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762728662
    },
    {
        "content": "<p>mm</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Delaborate unary notation referring to non-standard topologies. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabUnary</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkStx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">DelabM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withOverApp</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"delabUnary called for space {← PrettyPrinter.delab α}\"</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">trySynthInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``TopologicalSpace</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">α</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"delabUnary: no synthInst\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">undef</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"delabUnary: synthInst = undef\"</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">synthInst</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">      </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"assertNonCanonical: space = {← PrettyPrinter.delab α}, synthInst = {← PrettyPrinter.delab synthInst}, inst = {← PrettyPrinter.delab inst}\"</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"n\">synthInst</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">instD</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">      </span><span class=\"n\">mkStx</span><span class=\"w\"> </span><span class=\"n\">instD</span>\n</code></pre></div>\n<p>This version with traces shows that <code>trySynthInstance</code> fails in the <code>#check</code>, but works fine in the <code>example</code>s; is there something we can do about that?</p>",
        "id": 554602640,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762733478
    },
    {
        "content": "<p>sounds like a possible problem with <code>#check</code></p>",
        "id": 554602718,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762733543
    },
    {
        "content": "<p>mm<br>\nMeanwhile, <code>guard_target</code> accepts too much: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=ₛ</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>passes</p>",
        "id": 554602809,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762733635
    },
    {
        "content": "<p>well <code>guard_target</code> only does a \"syntactic\" check</p>",
        "id": 554602925,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762733744
    },
    {
        "content": "<p>right<br>\nI was hoping for something like \"<code>IsOpen[σ] s</code> is delaborated to <code>IsOpen s</code> and then fails the <code>guard_target</code> for not being syntactically equal to <code>IsOpen[σ] s</code>\", but I guess that would be annoying in a different way</p>",
        "id": 554603062,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762733860
    },
    {
        "content": "<p>yeah \"syntactic\" equality isn't about syntax</p>",
        "id": 554603091,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762733880
    },
    {
        "content": "<p>pft</p>",
        "id": 554603106,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762733887
    },
    {
        "content": "<p>I see</p>",
        "id": 554603108,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762733889
    },
    {
        "content": "<p>syntax contains way too much information for a direct equality check to be useful</p>",
        "id": 554603167,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762733934
    },
    {
        "content": "<p>for example, the source position of everything</p>",
        "id": 554603178,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762733944
    },
    {
        "content": "<p>fair</p>",
        "id": 554603382,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762734136
    },
    {
        "content": "<p>anyway, is there another way than <code>#check</code> to trace a hypothesis/target for checking?</p>",
        "id": 554603403,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762734165
    },
    {
        "content": "<p>Does replacing <code>trySynthInstance</code> with <code>synthInstance</code> help?</p>",
        "id": 554603443,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762734219
    },
    {
        "content": "<p>Alternatively, do <code>trace_state</code> in a proof instead of #check</p>",
        "id": 554603523,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762734290
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554603443\">said</a>:</p>\n<blockquote>\n<p>Does replacing <code>trySynthInstance</code> with <code>synthInstance</code> help?</p>\n</blockquote>\n<p>... sort of, in that it explicitly fails and makes the specific problem obvious<br>\n<code>failed to pretty print expression (use 'set_option pp.rawOnError true' for raw representation) : Prop</code></p>",
        "id": 554603559,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762734317
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554603523\">said</a>:</p>\n<blockquote>\n<p>Alternatively, do <code>trace_state</code> in a proof instead of #check</p>\n</blockquote>\n<p><code>trace_state</code> gives the exact same behavior</p>",
        "id": 554603925,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762734653
    },
    {
        "content": "<p>it's <em>only</em> the infoview itself that seems to be working properly</p>",
        "id": 554603935,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762734665
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">  trace: α : Type u_1</span>\n<span class=\"sd\">σ : TopologicalSpace α</span>\n<span class=\"sd\">s : Set α</span>\n<span class=\"sd\">⊢ IsOpen s</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"o\">(</span><span class=\"n\">trace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"o\">[</span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">trace_state</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>fails because <code>trace_state</code> gives <code>IsOpen[σ] s</code></p>",
        "id": 554604209,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1762734929
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/554602925\">said</a>:</p>\n<blockquote>\n<p>well <code>guard_target</code> only does a \"syntactic\" check</p>\n</blockquote>\n<p>but <code>#guard_msgs</code> is able to work on the level of strings?</p>",
        "id": 554655516,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762767635
    },
    {
        "content": "<p>Okay, we seem to have a deeper problem.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Order</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">discrete</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">IsOpen</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"n\">isOpen_univ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n<span class=\"w\">  </span><span class=\"n\">isOpen_inter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"n\">isOpen_sUnion</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">discrete</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">topology_nat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">discrete</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">topology_nat'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>This is deeply surprising behavior to me; <code>σ</code> hasn't even been given instance brackets, but it's automatically become the default <code>TopologicalSpace</code> instance on <code>Nat</code>. Is this known intended behavior somehow? Because I'm halfway through writing a bug report on Lean core otherwise lol</p>",
        "id": 558778468,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763779528
    },
    {
        "content": "<p>This isn't really a blocker for the original notation <em>per se</em>, though it does complicate writing properly general checks; it also means that the two-topologies test <span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> asked for is going to give different results than you might predict</p>",
        "id": 558778578,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763779658
    },
    {
        "content": "<p>That's just kind of how it works</p>",
        "id": 558780115,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763781487
    },
    {
        "content": "<p>To the best of my knowledge this is intended</p>",
        "id": 558780120,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763781498
    },
    {
        "content": "<p>Huh, really? But usually, when you define a function, seeing <code>(h : Foo)</code> means you have to provide the instance explicitly, and only <code>[Foo]</code> means that the instance is synthesized...</p>\n<p>I guess that's actually the dual behavior, when the definition is used, huh. Still, somehow I had thought that if you didn't use <code>[_]</code>, the proof would treat it like a <code>def</code>-without-<code>instance</code>-attribute</p>",
        "id": 558780338,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763781740
    },
    {
        "content": "<p>Certainly, it seems a bug that it takes <em>priority</em> over registered instances even without instance-implicit binders</p>",
        "id": 558780351,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763781760
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"359992\">Robert Maxton</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Delaborators.20for.20.60IsOpen.5Bt.5D.60.20etc/near/558780351\">said</a>:</p>\n<blockquote>\n<p>Certainly, it seems a bug that it takes <em>priority</em> over registered instances even without instance-implicit binders</p>\n</blockquote>\n<p>That's probably not a bug too</p>",
        "id": 558780629,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763782082
    },
    {
        "content": "<p>how about this: when you <code>let : TypeClass Foo := instance</code> that should make it an instance, even though let-binders are always default binderinfo and not inst-implicit</p>",
        "id": 558780723,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763782186
    },
    {
        "content": "<p>Mm. I feel like that's 'an exception that is required because of limits on <code>let</code>', rather than 'desired canonical behavior'?<br>\nlike, I would be happy having to write <code>let [_] : TypeClass Foo</code> instead</p>",
        "id": 558781405,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763782982
    },
    {
        "content": "<p>Also, all those theorems that take <code>{h : Decidable c}</code> for example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=dif_pos#doc\">docs#dif_pos</a></p>",
        "id": 558781734,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763783372
    },
    {
        "content": "<p>mmmmm<br>\nThat's true. It starts to feel like you'd almost want a second 'layer' of notation, so you can specify separately what get  synthesized and what gets registered as an instance</p>",
        "id": 558781791,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763783437
    },
    {
        "content": "<p>I do recall Kyle mentioning once that deciding what should and shouldn't be registered is hard, this is probably what he was talking about :wry:</p>",
        "id": 558781802,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763783454
    },
    {
        "content": "<p>Well, anyway, I guess I'll just stick with using <code>(co)induced</code> to generate my non-canonical instances then, since variables complicate things</p>",
        "id": 558781964,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763783643
    },
    {
        "content": "<p>I think \"I just put two different topologies on a type and now things are weird\" is expected behaviour; the point of the typeclass system is \"don't put more than one instance on a type\", as opposed to \"put more than one instance on a type and then expect to know which one typeclass inference will find at any given point\". Note that already</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">discrete</span>\n</code></pre></div>\n<p>is bad because <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instTopologicalSpaceNat#doc\">docs#instTopologicalSpaceNat</a> is already there (as you can see with <code>#synth TopologicalSpace ℕ</code> -- note also that the idiomatic spelling of <code>discrete</code> is <code>⊥ : TopologicalSpace X</code>, as was used there). If you want to put more than one instance of a topological space on a type, use a type synonym.</p>",
        "id": 558857059,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763862943
    },
    {
        "content": "<p>Note that the example does not import <code>Mathlib.Topology.Order</code>, as it's intended for a unit testing file where I would prefer not to import more than the specific file required. In that file <code>Nat</code> has no registered instance yet and the lattice structure on <code>TopologicalSpace a</code> has not yet been defined.</p>",
        "id": 558857468,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763863420
    },
    {
        "content": "<p>Also, the weirdness would be expected if there were two <em>instances</em> (that were manifestly instances) on a type; the confusion is precisely because they're \"just\" normal variable definitions/free floating hypotheses.</p>",
        "id": 558857545,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763863509
    },
    {
        "content": "<p>There's no difference in lean 4 (at least as far as I know)</p>",
        "id": 558858761,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763864903
    },
    {
        "content": "<p>I mean, <code>def Foo</code> and <code>instance Foo</code> are definitely different; it just seems that <code>variable (t : TopologicalSpace a)</code> and <code>variable [TopologicalSpace a]</code> are the same.</p>",
        "id": 558859855,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1763866189
    },
    {
        "content": "<p>well it changes the behavior when you're using the theorems</p>",
        "id": 558859923,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763866277
    },
    {
        "content": "<p>and it changes the binderinfo</p>",
        "id": 558859926,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763866282
    },
    {
        "content": "<p>so when you <code>revert</code> it will preserve the binderinfo</p>",
        "id": 558859937,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763866292
    },
    {
        "content": "<p>but I think they're mostly the same for instance synthesis</p>",
        "id": 558859945,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763866306
    },
    {
        "content": "<p>Yeah exactly, I mean to say that once you're in a proof then everything in the local context is visible to the typeclass inference system.</p>",
        "id": 558894494,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763904395
    }
]