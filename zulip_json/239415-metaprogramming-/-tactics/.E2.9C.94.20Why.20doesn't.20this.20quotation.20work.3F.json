[
    {
        "content": "<p>In the below code snippet, I am curious why <code>abc2</code> does not work.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">abc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">abc2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- does not work</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">abc3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>\n<p>I am not entirely sure about the evaluation model here, but anyhow, when executing <code>q($a)</code> we could know that <code>a</code> is in fact <code>42</code>, so I was assuming <code>abc2</code> to work the same with <code>abc</code>.<br>\nInterestingly, the <code>let</code> binding and function argument behaves differently here. In <code>abc3</code>, it is possible to define <code>f</code>. The fact that <code>abc2</code> does not work while <code>f</code> in <code>abc3</code> works is surprising to me - I was expecting all three to work, and if any, <code>abc3</code> looked harder than <code>abc2</code> for me (in the sense that <code>abc2</code> knows the value of <code>a</code> and <code>f</code> in <code>abc3</code> does not).</p>",
        "id": 493982393,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736962825
    },
    {
        "content": "<p><code>let a := 42; by exact q($a)</code> also works</p>",
        "id": 493983931,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736963286
    },
    {
        "content": "<p>It's possible this is indicative of a missing <code>withMainContext</code> in Qq</p>",
        "id": 493983962,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736963297
    },
    {
        "content": "<p>It's likely because it doesn't know the type of <code>a</code>. Defaulting to Nat will happen after the let body is elaborated.</p>\n<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">abc2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 493991528,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736965839
    },
    {
        "content": "<p>Eric's trick with <code>by exact</code> defers elaborating <code>q($a)</code> until after defaulting.</p>",
        "id": 493991586,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736965862
    },
    {
        "content": "<p>(I think it's worth mentioning that it should be a pleasant surprise that this works at all, being able to reflect runtime values into Exprs like this, blurring the different levels of representation.)</p>\n<p>Maybe if Qq doesn't find a ToExpr instance, it should try postponing elaboration <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>?</p>",
        "id": 493992302,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736966116
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Thank you for the comments! That makes very much sense - I wouldn't have imagined the root cause without your help.</p>",
        "id": 494051816,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736992778
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"748258\">Youngju Song</span> has marked this topic as resolved.</p>",
        "id": 495213012,
        "sender_full_name": "Notification Bot",
        "timestamp": 1737529950
    }
]