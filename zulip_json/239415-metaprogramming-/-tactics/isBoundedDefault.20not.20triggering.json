[
    {
        "content": "<p>When working with <code>liminf</code> and <code>limsup</code>, there are some boundedness hypotheses which may have to be checked on some spaces (such as reals) but are automatically satisfied on other spaces (such as extended reals).</p>\n<p>In order to avoid duplicate theorems, and not having to fill these hypotheses by hand when they are trivially satisfied, the current philosophy is to have each theorem in the largest generality (with these boundedness hypotheses), and an <code>isBoundedDefault</code> tactic which automatically fills these hypotheses (defined in Mathlib.Order.LiminfLimsup).</p>\n<p>The problem is that <code>isBoundedDefault</code> does trigger in direct proof terms (or <code>exact</code>, <code>have</code>...), but not on <code>apply</code>. Some kind of minimal example is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">EReal</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">LiminfLimsup</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Filter</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">proof_term</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Filter</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">EReal</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">≤ᶠ</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">limsup</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">limsup</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">limsup_le_limsup</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">by_exact</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Filter</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">EReal</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">≤ᶠ</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">limsup</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">limsup</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">limsup_le_limsup</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">by_apply</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Filter</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">EReal</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">≤ᶠ</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">limsup</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">limsup</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">limsup_le_limsup</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">⊥;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">⊤;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>This makes the proofs more awkward and cluttered than they need to be. Would it be possible to modify <code>isBoundedDefault</code> to trigger on <code>apply</code>?</p>\n<p>Paging <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span></p>",
        "id": 450437091,
        "sender_full_name": "Damien Thomine",
        "timestamp": 1720614289
    },
    {
        "content": "<p>I'd like to mention that I think it's an important issue. Unfortunately, I am not competent on this, we need some metaprogramming understanding here I'd say.</p>",
        "id": 450475392,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1720623114
    },
    {
        "content": "<p>Is it just a matter of a missing <code>assumption</code>?  In the example above, this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">repeat</span><span class=\"w\"> </span><span class=\"n\">first</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">isCobounded_le_of_bot</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">isCobounded_ge_of_top</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">isBounded_le_of_top</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">isBounded_ge_of_bot</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">assumption</span>\n</code></pre></div>",
        "id": 450484806,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720625058
    },
    {
        "content": "<p>I tried looking at the lean3 code and it uses <code>applyc</code>.  Looking into that, it may be that <code>applyc</code> did try some form of <code>assumption</code> on the goals, so this may be indeed a fix.</p>",
        "id": 450494294,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720626975
    },
    {
        "content": "<p>If you have more examples where this fails, I can look into it!</p>",
        "id": 450494339,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720626989
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14617\">#14617</a></p>",
        "id": 450494878,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720627174
    },
    {
        "content": "<p>Let me sum up here the discussion in <a href=\"https://github.com/leanprover-community/mathlib4/pull/14617\">#14617</a>:</p>\n<ul>\n<li>There is a distinction between</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">limsup_le_limsup</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>which has always worked, and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">limsup_le_limsup</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>which we would like to have.</p>\n<ul>\n<li>The latter is not fixed by adding <code>assumption</code>.</li>\n<li>In the meantime, there are a few imperfect solutions: <code>refine limsup_le_limsup ?_</code>, <code>apply limsup_le_limsup ?_</code>, <code>apply (limsup_le_limsup)</code>.</li>\n</ul>\n<p>Thank you for your efforts. I must say that this behaviour is puzzling for somebody like me who does not know the intricacies of Lean.</p>",
        "id": 450538763,
        "sender_full_name": "Damien Thomine",
        "timestamp": 1720638498
    },
    {
        "content": "<p>My vague understanding of the issue is that <code>apply</code> does not pass information about the meta variables that it leaves behind until it is too late for the auto-param to realize that it could have made progress.  The workarounds above either give more context to the remaining goals or delay them a bit.</p>",
        "id": 450547490,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720640345
    },
    {
        "content": "<p>filed as a bug under <a href=\"https://github.com/leanprover/lean4/pull/10681\">lean#10681</a> (please upvote if you want to see this fixed)</p>",
        "id": 543267932,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1759744811
    }
]