[
    {
        "content": "<p>I'm trying to benchmark a tactic I've been working on but I've encountered some issues where the code I'm using to test my tactic yields different results from actually running the tactic in practice.</p>\n<p>Here is an mwe showcasing one such difference in behavior. In this example. <code>myTactic</code> is the tactic I'm attempting to benchmark using <code>testMyTactic</code>. The intended output of <code>testMyTactic</code> is <code>true</code> if <code>myTactic</code> does not throw an error and <code>false</code> otherwise:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> myTactic adds `x : Nat`, `hx : x = x`, `y : Int`, and `hy : y = y` to the local context -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"myTactic\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">evalMyTactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">myTactic</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">existsTerm1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"c1\">-- A term representing `∃ x : Nat, x = x`</span>\n<span class=\"w\">    </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">withLocalDeclD</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"s2\">\"x\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">`Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xFVar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">existsBody</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">`Eq</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">xFVar</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">xFVar</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">existsArg</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">xFVar</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">existsBody</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">binderInfoForMVars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``Exists</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">existsArg</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">existsTerm1Stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withOptions</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"ss\">`pp.funBinderTypes</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">existsTerm1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">existsTerm2</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"c1\">-- A term representing `∃ y : Int, y = y`</span>\n<span class=\"w\">    </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">withLocalDeclD</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"s2\">\"y\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">`Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xFVar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">existsBody</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">`Eq</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">xFVar</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">xFVar</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">existsArg</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">xFVar</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">existsBody</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">binderInfoForMVars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``Exists</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">existsArg</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">existsTerm2Stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withOptions</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"ss\">`pp.funBinderTypes</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">existsTerm2</span>\n<span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">    </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">        </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">⟨$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"s2\">\"x\"</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"hx\"</span><span class=\"o\">)))</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">existsTerm1Stx</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">          </span><span class=\"gr\">sorry</span>\n<span class=\"w\">      </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">    </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">        </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">⟨$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"s2\">\"y\"</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"hy\"</span><span class=\"o\">)))</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">existsTerm2Stx</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">          </span><span class=\"gr\">sorry</span>\n<span class=\"w\">      </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">myTactic</span>\n<span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> Tactic state at this location:</span>\n<span class=\"cm\">      x : Nat</span>\n<span class=\"cm\">      hx : x = x</span>\n<span class=\"cm\">      y : Int</span>\n<span class=\"cm\">      hy : y = y</span>\n<span class=\"cm\">      ⊢ True</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"c1\">-- Goal is successfully closed with no errors</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testMyTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Run `tac` on the goal `⊢ True`</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">gs</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">    </span><span class=\"n\">try</span>\n<span class=\"w\">      </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"w\"> </span><span class=\"n\">tac</span>\n<span class=\"w\">    </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"Error: {← e.toMessageData.toString}\"</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">gs</span><span class=\"bp\">.</span><span class=\"n\">isSome</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">testMyTactic</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"o\">)</span>\n<span class=\"c\">/-</span><span class=\"cm\"> Output:</span>\n<span class=\"cm\">Error: no goals to be solved</span>\n<span class=\"cm\">false</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>Some comments on the above example:</p>\n<ul>\n<li>Running <code>myTactic</code> on <code>example : True := ...</code> does not result in an error and does exactly what it is supposed to do (add <code>x : Nat</code>, <code>hx : x = x</code>, <code>y : Int</code>, and <code>hy : y = y</code> to the local context)</li>\n<li>Running <code>testMyTactic</code> to simulate whether <code>myTactic</code> would throw an error on the goal <code>⊢ True</code> DOES result in an error (no goals to be solved)</li>\n<li><code>testMyTactic</code> does NOT fail if <code>myTactic</code> does not include both <code>evalTactic</code> calls</li>\n<li><code>testMyTactic</code> does NOT fail if the first <code>evalTactic</code> has its anonymous constructor removed (e.g. replacing <code>have ⟨$(mkIdent (.str .anonymous \"x\")), $(mkIdent (.str .anonymous (\"hx\")))⟩ : $existsTerm1Stx:term := by sorry</code> with <code>have $(mkIdent (.str .anonymous (\"hx\"))) : $existsTerm1Stx:term := by sorry</code></li>\n<li><code>testMyTactic</code> DOES still fail if the first <code>evalTactic</code> remains as is and the second <code>evalTactic</code> has its anonymous constructor removed (actually running <code>myTactic</code> does not result in any issue though)</li>\n</ul>\n<p>I'm a bit baffled by what could possibly be causing this. Presumably, somehow the combination of the anonymous constructors and multiple <code>evalTactic</code> calls is creating an issue (since these appear to be necessary components to cause the discrepancy I'm seeing), but I have no understanding on why this would be the case or what I should do to deal with it (the actual tactic I'm trying to benchmark has both of these elements and neither can easily be eliminated).</p>\n<p>Does anyone have any insight on what could be causing this?</p>\n<p>(By the way, I'm testing this on lean v4.11.0 in case if that's relevant)</p>",
        "id": 477348235,
        "sender_full_name": "Josh Clune",
        "timestamp": 1729138521
    },
    {
        "content": "<p>I'm not at a computer, but my experience is that whenever you force lean to accept pure syntax as typed syntax (the anonymous constructors), you have to be <em>really</em> sure that you are doing is right.  A way of testing this is often using <code>logInfo stx</code>, since it will pick up on potential issues and will refuse to print invalid syntax (and some valid syntax as well).</p>",
        "id": 477349836,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729139315
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/239415-metaprogramming-.2F-tactics/topic/Difference.20in.20behavior.20between.20performing.20Tactic.2Erun.20and.20act/near/477349836\">said</a>:</p>\n<blockquote>\n<p>I'm not at a computer, but my experience is that whenever you force lean to accept pure syntax as typed syntax (the anonymous constructors), you have to be <em>really</em> sure that you are doing is right.  A way of testing this is often using <code>logInfo stx</code>, since it will pick up on potential issues and will refuse to print invalid syntax (and some valid syntax as well).</p>\n</blockquote>\n<p>That's helpful to know in general, but I'm reasonably confident that's not the issue in this particular case. <code>logInfo</code> shows the expressions I'm intending, and when there's just one <code>evalTactic</code> with the anonymous constructor, it works both in actual use and in <code>testMyTactic</code>. Somehow, having both <code>evalTactic</code> calls is necessary to cause <code>testMyTactic</code> to fail.</p>",
        "id": 477352192,
        "sender_full_name": "Josh Clune",
        "timestamp": 1729140967
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"239415\" href=\"/#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Difference.20in.20behavior.20between.20performing.20Tactic.2Erun.20and.20act\">#metaprogramming / tactics &gt; Difference in behavior between performing Tactic.run and act</a> by <span class=\"user-mention silent\" data-user-id=\"436568\">Josh Clune</span>.</p>",
        "id": 477469259,
        "sender_full_name": "Notification Bot",
        "timestamp": 1729178466
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"436568\">@Josh Clune</span>, I get \"auxiliary declaration cannot be created when declaration name is not available\" from your #eval line, triggered by the </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">$</span>\n<span class=\"w\">    </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">        </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"bp\">⟨$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"s2\">\"x\"</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"hx\"</span><span class=\"o\">)))</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">existsTerm1Stx</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">          </span><span class=\"gr\">sorry</span>\n<span class=\"w\">      </span><span class=\"o\">)</span>\n</code></pre></div>\n<p>line.</p>",
        "id": 478394053,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729647548
    },
    {
        "content": "<p>(this is on <code>master</code>)</p>",
        "id": 478394060,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729647553
    },
    {
        "content": "<p>Changing <code>testMyTactic</code> to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testMyTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``True</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Run `tac` on the goal `⊢ True`</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">gs</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">    </span><span class=\"n\">try</span>\n<span class=\"w\">      </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"w\"> </span><span class=\"n\">tac</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">declName?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`fake</span><span class=\"o\">})</span>\n<span class=\"w\">    </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"Error: {← e.toMessageData.toString}\"</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">gs</span><span class=\"bp\">.</span><span class=\"n\">isSome</span>\n</code></pre></div>\n<p>results in the <code>#eval</code> succeeding.</p>",
        "id": 478394178,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729647656
    },
    {
        "content": "<p>Let me know if that doesn't work out for you (e.g. it does appear the behaviour was different in the version you're running, and perhaps pinned to?)</p>",
        "id": 478394209,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729647696
    },
    {
        "content": "<p>I wasn't able to reproduce the error message you described. I tried lean toolchains v4.11.0, v4.12.0, v4.13.0-rc4, stable, and nightly, and they all gave the error <code>Error: no goals to be solved</code> rather than <code>auxiliary declaration cannot be created when declaration name is not available</code>. I'm not sure why that is. But I can confirm that your change fixed the behavior regardless. I'm now wondering whether there's something about my setup that's amiss, but I suppose that's for me to figure out. Regardless, thank you for the input.</p>",
        "id": 478400475,
        "sender_full_name": "Josh Clune",
        "timestamp": 1729652432
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"436568\">Josh Clune</span> has marked this topic as resolved.</p>",
        "id": 478400493,
        "sender_full_name": "Notification Bot",
        "timestamp": 1729652442
    },
    {
        "content": "<p>Another way to do what Kim fixed is to use the <code>withDeclName</code> combinator, like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">      </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">withDeclName</span><span class=\"w\"> </span><span class=\"ss\">`_testMyTactic</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"w\"> </span><span class=\"n\">tac</span>\n</code></pre></div>",
        "id": 478403384,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729653235
    },
    {
        "content": "<p>I think what's going on is that on <code>master</code> we've fixed <code>#eval</code> so that it actually reports log messages when you use the <code>MetaM</code> monad</p>",
        "id": 478403453,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729653276
    },
    {
        "content": "<p>One way you could check is by trying</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">testMyTactic</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">myTactic</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>because the <code>CommandElabM</code> monad was still able to report log messages with <code>#eval</code></p>",
        "id": 478403649,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729653450
    },
    {
        "content": "<p>Oh, that's very helpful to know. Yes, adding <code>Command.liftTermElabM</code> gives me the error that Kim described.</p>",
        "id": 478403806,
        "sender_full_name": "Josh Clune",
        "timestamp": 1729653568
    },
    {
        "content": "<p>So the only difference at play here is that in <code>master</code> the way errors are being logged/reported is different than when Lean is built otherwise?</p>",
        "id": 478403906,
        "sender_full_name": "Josh Clune",
        "timestamp": 1729653628
    },
    {
        "content": "<p>Yeah, that's what appears to be happening. You should be able to use <code>#eval Command.liftTermElabM</code> for now — I think that should be enough to keep you away from any <code>#eval</code> issues until the next release.</p>",
        "id": 478404775,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729654320
    }
]