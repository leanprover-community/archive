[
    {
        "content": "<p>Hey everyone.</p>\n<p>I have been toying around with an idea of a command generating multiple theorems, each of which is proven by hand by the user.<br>\nHere's the gist of it (very simplified to reflect the user experience problems that I am facing):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">:</span><span class=\"s2\">\"my_command \"</span><span class=\"w\"> </span><span class=\"n\">tacs</span><span class=\"o\">:</span><span class=\"n\">tacticSeq</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">thms</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"ss\">`x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``True</span><span class=\"o\">),</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"ss\">`y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``True</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Simulate doing some stuff before generating the theorems</span>\n<span class=\"w\">  </span><span class=\"c1\">-- How could we cache this? And is it a good idea?</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">3000</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">thms</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">thm</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">thms</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">tac</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tacs</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">thmDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Declaration</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">thmDecl</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">        </span><span class=\"n\">levelParams</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">        </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">thm</span>\n<span class=\"w\">        </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tac</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">thm</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">catchExPostpone</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">synthesizeSyntheticMVarsNoPostponing</span>\n<span class=\"w\">          </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">      </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"n\">thmDecl</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"w\">    </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"w\"> </span><span class=\"s2\">\"There still are goals to discharge\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tacs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">thms</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">tacs</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"No more goals to discharge\"</span>\n\n<span class=\"n\">my_command</span>\n<span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"o\">}</span>\n<span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">iterate</span><span class=\"w\"> </span><span class=\"mi\">250</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>Here's the crux of the problem. When editing one of the proof scripts after <code>my_command</code>, it seems like the whole command is re-run, hence every edit of a proof script results in a 3s slow down.<br>\nIs there any way to \"cache\" what the command is doing (thereby paying the cost of what the command does only once, not in subsequent edits)?<br>\nMaybe the tactics could be separated into their own commands? But in that case, how would I go about reporting errors about missing tactics/too many tactics?</p>",
        "id": 561828952,
        "sender_full_name": "Ghilain Bergeron",
        "timestamp": 1764840045
    },
    {
        "content": "<p>Hi! I'm not sure there's a convenient way to do this in general, since modifying any part of a command in the editor will recompute the entire thing. If you were ok with splitting it into multiple commands (like have a <code>my_command</code> before each of the <code>tacticSeq</code>s), you could probably save some time by sharing a value of a simple type between them; just by adding the cached value as a constant to the environment. For example if you wanted to just store a string:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"bp\">.</span><span class=\"n\">Macro</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`_cached_value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"bp\">.</span><span class=\"n\">value?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Literal</span><span class=\"bp\">.</span><span class=\"n\">strVal</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\">     </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"wrong type :(\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">value</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Declaration</span><span class=\"bp\">.</span><span class=\"n\">defnDecl</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">      </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">val</span>\n<span class=\"w\">      </span><span class=\"n\">levelParams</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">      </span><span class=\"n\">hints</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span>\n<span class=\"w\">      </span><span class=\"n\">safety</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">DefinitionSafety</span><span class=\"bp\">.</span><span class=\"n\">safe</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"n\">decl</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">val</span>\n</code></pre></div>\n<p>Then within your command you could just do something like...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cached_value</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"c1\">-- thing that take a long time</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"mi\">3000</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"s2\">\"value you want to cache\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>...which would only compute it the first time around. You could also keep track of the value of <code>missing</code> and such by updating the environment similarly. </p>\n<p>The problem with using this for more general types is that at the meta level you get the cached constant back as an Expr, so recovering its actual value (as with line 7 above) gets to be kind of annoying, but definitely possible. </p>\n<p>I hope this helps!</p>",
        "id": 562138362,
        "sender_full_name": "Tate Rowney",
        "timestamp": 1764951397
    },
    {
        "content": "<p>Some time ago, I was looking into that here:<br>\n<a href=\"https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/Incremental.lean\">https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/Incremental.lean</a></p>",
        "id": 562262889,
        "sender_full_name": "Mirek Ol≈°√°k",
        "timestamp": 1765051661
    },
    {
        "content": "<p>There should be a thread about it here, trying to find</p>",
        "id": 562262968,
        "sender_full_name": "Mirek Ol≈°√°k",
        "timestamp": 1765051768
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/custom.20incremental.20elaboration/near/508593919\">#lean4 &gt; custom incremental elaboration @ üí¨</a></p>",
        "id": 562263133,
        "sender_full_name": "Mirek Ol≈°√°k",
        "timestamp": 1765051951
    },
    {
        "content": "<p>Perhaps I should have made the PR to core myself, I tried to push <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> for it (as he had more contribution experience) but he was not too motivated <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 562265346,
        "sender_full_name": "Mirek Ol≈°√°k",
        "timestamp": 1765054642
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Ol≈°√°k</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Incremental.20elaboration.20of.20commands.2Fcaching/near/562262889\">said</a>:</p>\n<blockquote>\n<p>Some time ago, I was looking into that here:<br>\n<a href=\"https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/Incremental.lean\">https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/Incremental.lean</a></p>\n</blockquote>\n<p>Let me know if it still works (we were doing this about half-year ago), and if it can fit to your project. You should also look at <code>IncrementalTest.lean</code>, and <code>CustomEval.lean</code> at that repository. I see that in your case, you are not exactly in a proof environment, so I am not sure if it works the same way but it could.</p>",
        "id": 562270342,
        "sender_full_name": "Mirek Ol≈°√°k",
        "timestamp": 1765061706
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"951211\">Tate Rowney</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Incremental.20elaboration.20of.20commands.2Fcaching/near/562138362\">said</a>:</p>\n<blockquote>\n<p>Hi! I'm not sure there's a convenient way to do this in general, since modifying any part of a command in the editor will recompute the entire thing. If you were ok with splitting it into multiple commands (like have a <code>my_command</code> before each of the <code>tacticSeq</code>s), you could probably save some time by sharing a value of a simple type between them; just by adding the cached value as a constant to the environment. For example if you wanted to just store a string:<br>\n[...]</p>\n</blockquote>\n<p>Unfortunately, splitting the command into multiple subcommands doesn't seem possible to me. Since the commands generates some theorems internally, but waits for the user proof scripts to actually add them to the environment (via <code>addDecl</code>), it seems that the user may simple never put any <code>tacticSeq</code>s next, thus have nothing to prove and get the false sense that everything's fine (but it is not: the internal theorems have not been proven, and in fact not even generated!).<br>\nMaybe the UX of the command isn't the right one for this job (at least in Lean), but I can't think of another one that would solve all issues that I have (while still forcing users to discharge all internally generated theorems).</p>",
        "id": 562694017,
        "sender_full_name": "Ghilain Bergeron",
        "timestamp": 1765289390
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Ol≈°√°k</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Incremental.20elaboration.20of.20commands.2Fcaching/near/562270342\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Ol≈°√°k</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Incremental.20elaboration.20of.20commands.2Fcaching/near/562262889\">said</a>:</p>\n<blockquote>\n<p>Some time ago, I was looking into that here:<br>\n<a href=\"https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/Incremental.lean\">https://github.com/Human-Oriented-ATP/lean-humanproof/blob/main/HumanProof/Incremental.lean</a></p>\n</blockquote>\n<p>Let me know if it still works (we were doing this about half-year ago), and if it can fit to your project. You should also look at <code>IncrementalTest.lean</code>, and <code>CustomEval.lean</code> at that repository. I see that in your case, you are not exactly in a proof environment, so I am not sure if it works the same way but it could.</p>\n</blockquote>\n<p>I am unsure how to apply this solution to my problem, unfortunately. In a tactic sequence, the snapshot seems to \"simply\" look up whether the syntax of a tactic changed, in which case it will either re-execute it or replay the saved state.<br>\nIn my case, the registered syntax of the whole command would change after a simple change in one of the proof scripts, replaying the whole command anyway.<br>\nI also tried to trick Lean by registering an environment extension (just as you did), but have not been successful at all (maybe because of the issue above?), quite sadly. My initial try with a simple <code>IO.Ref</code> did not succeed either.</p>",
        "id": 562694911,
        "sender_full_name": "Ghilain Bergeron",
        "timestamp": 1765289578
    },
    {
        "content": "<p>Can you split your code so that you have separate functions?</p>\n<ol>\n<li>That does all the preprocessing, and save it into an environment extension</li>\n<li>That processes a single tactic (possibly interacting with the environment extension)</li>\n</ol>\n<p>Honestly, to me this is all also a bit of black magic, <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> could be the only one who understands properly what is going on, on the other hand, I don't see a fundamental reason why my approach should not be working.</p>",
        "id": 562705452,
        "sender_full_name": "Mirek Ol≈°√°k",
        "timestamp": 1765292001
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Ol≈°√°k</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Incremental.20elaboration.20of.20commands.2Fcaching/near/562705452\">said</a>:</p>\n<blockquote>\n<p>Can you split your code so that you have separate functions?</p>\n<ol>\n<li>That does all the preprocessing, and save it into an environment extension</li>\n<li>That processes a single tactic (possibly interacting with the environment extension)</li>\n</ol>\n</blockquote>\n<p>Yes, this is basically what I ended up doing. Instead of a single <code>my_command</code>, I have two commands: one that does the heavy lifting and saves everything in an <code>EnvExtension</code>, and the other that simply tries to discharge all goals (read from the <code>EnvExtension</code>) with the given tactic sequences.<br>\nThis is still a bit slow on big proof scripts, but I may be able to reuse some of your code so that each tactic sequence gets processed incrementally!</p>",
        "id": 562948273,
        "sender_full_name": "Ghilain Bergeron",
        "timestamp": 1765371434
    }
]