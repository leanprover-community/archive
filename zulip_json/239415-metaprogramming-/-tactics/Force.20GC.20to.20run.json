[
    {
        "content": "<p>Is there a way to force Lean's GC to run to avoid out of memory problems?</p>",
        "id": 561796739,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764825541
    },
    {
        "content": "<p>Lean does not have a garbage collector. The system is based on ref counting and frees memory when the compiler thinks the right time for freeing memory is. In particular the reference counting is guaranteed to be garbage free by construction.</p>",
        "id": 561834176,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1764841795
    },
    {
        "content": "<p>(do make sure you're on 4.24.1/4.25.2/4.26.0-rc2 or above!)</p>",
        "id": 561851381,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764847110
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/561851381\">said</a>:</p>\n<blockquote>\n<p>(do make sure you're on 4.24.1/4.25.2/4.26.0-rc2 or above!)</p>\n</blockquote>\n<p>Just curious what's the context for these versions? Some critical bugs fixed or major ref counting improvements?</p>",
        "id": 561961530,
        "sender_full_name": "Gavin Zhao",
        "timestamp": 1764877314
    },
    {
        "content": "<p>We identified and fixed a few major and minor memleaks in those patches</p>",
        "id": 561966870,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1764879329
    },
    {
        "content": "<p>Could there be any memory leaks regarding Lean strings? I have a test case where elaborating thousands of expressions leads to OOM and <code>std::bad_alloc</code></p>",
        "id": 561967518,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764879612
    },
    {
        "content": "<p>I did also fix two memory leaks in the string subsystem in those versions yes</p>",
        "id": 561967927,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1764879775
    },
    {
        "content": "<p>But in these patch versions we know all major memory leaks and I think at least most minor ones to be absent according to lsan</p>",
        "id": 561968224,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1764879880
    },
    {
        "content": "<p>If I run the elaborator many times do I need to manually clear out any caches?</p>",
        "id": 561969732,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764880479
    },
    {
        "content": "<p>As long as you don't run <code>importModules</code> many times, there shouldn't be anything to do. If you can find a reproducer of any suspect behavior, we would certainly be interested in that though.</p>",
        "id": 561971450,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764881122
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/561971450\">said</a>:</p>\n<blockquote>\n<p>As long as you don't run <code>importModules</code> many times, there shouldn't be anything to do. If you can find a reproducer of any suspect behavior, we would certainly be interested in that though.</p>\n</blockquote>\n<p>I managed to repro the behaviour here: <a href=\"https://codeberg.org/aniva/lean4-reverse-ffi\">https://codeberg.org/aniva/lean4-reverse-ffi</a></p>\n<p>The failure is at iteration &gt; 80000, and I could not get it below say 10 iterations.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Iteration</span><span class=\"w\"> </span><span class=\"mi\">79000</span>\n<span class=\"n\">Iteration</span><span class=\"w\"> </span><span class=\"mi\">80000</span>\n<span class=\"n\">Iteration</span><span class=\"w\"> </span><span class=\"mi\">81000</span>\n<span class=\"n\">libc</span><span class=\"bp\">++</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">terminating</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"bp\">::</span><span class=\"n\">bad_alloc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"bp\">::</span><span class=\"n\">bad_alloc</span>\n</code></pre></div>\n<p>I also tried creating the <code>STRef</code>'s per iteration to eliminate any cache problems, but the issue persists.</p>",
        "id": 562022777,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764911274
    },
    {
        "content": "<p>Ah, FFI does add complexity. Could you try downloading an fsanitize build from our CI and build the C file using -fsanitize=address as well to get started?</p>",
        "id": 562041507,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764922342
    },
    {
        "content": "<p>The most obvious thing that jumps out at me is that you are using the IO and BaseIO API in a wrong way in the C code. With IO RealWorld removed there is no need to pass along real world parameters and there is also no need to do things like unwrapping the result of an <code>st_mk_ref</code>, it is directly the lean object without boxing.</p>",
        "id": 562044340,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1764923332
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562044340\">said</a>:</p>\n<blockquote>\n<p>The most obvious thing that jumps out at me is that you are using the IO and BaseIO API in a wrong way in the C code. With IO RealWorld removed there is no need to pass along real world parameters and there is also no need to do things like unwrapping the result of an <code>st_mk_ref</code>, it is directly the lean object without boxing.</p>\n</blockquote>\n<p>ah I didnt know that was removed.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cat<span class=\"w\"> </span><span class=\"k\">$(</span>lean<span class=\"w\"> </span>--print-prefix<span class=\"k\">)</span>/include/lean/lean.h<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>st_mk_\nLEAN_EXPORT<span class=\"w\"> </span>lean_obj_res<span class=\"w\"> </span>lean_st_mk_ref<span class=\"o\">(</span>lean_obj_arg,<span class=\"w\"> </span>lean_obj_arg<span class=\"o\">)</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>It seems like <code>st_mk_ref</code> still takes a world argument here? I'm on 4.25.2. If I pass in just one arg to this function there would be a compilation error. If I remove the unwrap after <code>lean_st_mk_ref</code> the program crashes on iteration 0.</p>",
        "id": 562046007,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764923899
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562041507\">said</a>:</p>\n<blockquote>\n<p>Ah, FFI does add complexity. Could you try downloading an fsanitize build from our CI and build the C file using -fsanitize=address as well to get started?</p>\n</blockquote>\n<p>Is there a way to do it with elan?</p>",
        "id": 562049511,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764925086
    },
    {
        "content": "<p>Oh the IO realworld removal is a 4.26 feature, my bad</p>",
        "id": 562050118,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1764925249
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562049511\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562041507\">said</a>:</p>\n<blockquote>\n<p>Ah, FFI does add complexity. Could you try downloading an fsanitize build from our CI and build the C file using -fsanitize=address as well to get started?</p>\n</blockquote>\n<p>Is there a way to do it with elan?</p>\n</blockquote>\n<p>No. And it is only available on recent master, so it would require the changes Henrik mentioned first</p>",
        "id": 562051791,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764925688
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562051791\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562049511\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562041507\">said</a>:</p>\n<blockquote>\n<p>Ah, FFI does add complexity. Could you try downloading an fsanitize build from our CI and build the C file using -fsanitize=address as well to get started?</p>\n</blockquote>\n<p>Is there a way to do it with elan?</p>\n</blockquote>\n<p>No. And it is only available on recent master, so it would require the changes Henrik mentioned first</p>\n</blockquote>\n<p>is there any instructions on how to do this? I couldn't find it in contributing.md</p>",
        "id": 562052053,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764925762
    },
    {
        "content": "<p>To be completely transparent, I don't think this has been tried before by anyone in combination with FFI so I can only provide guesses for now. But if we do suspect a true memory leak, the sanitizer is the most promising approach in my experience.</p>",
        "id": 562052979,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764926001
    },
    {
        "content": "<p>I guess I was a bit too pessimistic about elan: when you've downloaded the toolchain, you can certainly add it via <code>elan toolchain link</code></p>",
        "id": 562053128,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764926037
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562052979\">said</a>:</p>\n<blockquote>\n<p>To be completely transparent, I don't think this has been tried before by anyone in combination with FFI so I can only provide guesses for now. But if we do suspect a true memory leak, the sanitizer is the most promising approach in my experience.</p>\n</blockquote>\n<p>where can I find the nightly fsanitize builds?</p>",
        "id": 562054265,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764926370
    },
    {
        "content": "<p>Argh my bad, we do not actually upload an artifact for the sanitized build right now. So you would have to build Lean from source, using <code>cmake --preset sanitize</code>. This may be better/necessary in any way because it allows you to ensure Lean and your C code are built with the same compiler and sanitizer version</p>",
        "id": 562054307,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764926384
    },
    {
        "content": "<p>If you could make the C changes to make the code compatible with master, I can look into sanitizer part as well, though likely not in the next few days</p>",
        "id": 562055191,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764926650
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562055191\">said</a>:</p>\n<blockquote>\n<p>If you could make the C changes to make the code compatible with master, I can look into sanitizer part as well, though likely not in the next few days</p>\n</blockquote>\n<p>I'll see what I can find on 4.25.2 for now.  Has there been any significant modification about memory since 4.25.2?</p>",
        "id": 562055423,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764926724
    },
    {
        "content": "<p>We've identified and fixed additional small leaks found by the sainitizer but no indication elaboration of usual Lean files was affected so far</p>",
        "id": 562057087,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764927266
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562054307\">said</a>:</p>\n<blockquote>\n<p>Argh my bad, we do not actually upload an artifact for the sanitized build right now. So you would have to build Lean from source, using <code>cmake --preset sanitize</code>. This may be better/necessary in any way because it allows you to ensure Lean and your C code are built with the same compiler and sanitizer version</p>\n</blockquote>\n<p>I got this error after</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cmake<span class=\"w\"> </span>--preset<span class=\"w\"> </span>sanitize\nmake<span class=\"w\"> </span>-C<span class=\"w\"> </span>build/sanitize\nelan<span class=\"w\"> </span>toolchain<span class=\"w\"> </span>link<span class=\"w\"> </span>sanitize<span class=\"w\"> </span>build/sanitize/stage1\nelan<span class=\"w\"> </span>default<span class=\"w\"> </span>sanitize\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>/home/aniva/Projects/contrib/formalization/lean4/src/runtime/compact.cpp:400:66: runtime error: addition of unsigned offset to 0x776b21dee858 overflowed to 0x776b21de4ae0\nSUMMARY: UndefinedBehaviorSanitizer: undefined-behavior /home/aniva/Projects/contrib/formalization/lean4/src/runtime/compact.cpp:400:66\n✖ [6/7] Building mystery:shared\ntrace: .&gt; cc -shared -o /home/aniva/Projects/contrib/formalization/lean4-reverse-ffi/.lake/build/lib/libmystery.so /home/aniva/Projects/contrib/formalization/lean4-reverse-ffi/.lake/build/ir/Mystery/Basic.c.o.export /home/aniva/Projects/contrib/formalization/lean4-reverse-ffi/.lake/build/ir/Mystery.c.o.export -L /home/aniva/Projects/contrib/formalization/lean4/build/sanitize/stage1/lib/lean -lstdc++ -Wl,--as-needed -lLake_shared -Wl,--no-as-needed -fsanitize=address,undefined -fsanitize-link-c++-runtime /usr/lib/libgmp.so -L/usr/lib -luv -lm -ldl -pthread\ninfo: stderr:\ncc: error: unrecognized command-line option ‘-fsanitize-link-c++-runtime’\nerror: external command 'cc' exited with code 1\nSome required targets logged failures:\n- mystery:shared\nerror: build failed\n</code></pre></div>",
        "id": 562059662,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1764928033
    },
    {
        "content": "<p>Ah, that's pretty far already! It does sound like this isn't the same C compiler cmake chose for Lean. You can check that using</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cmake<span class=\"w\"> </span>-LA<span class=\"w\"> </span>build/sanitize/stage1<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>CMAKE_C_COMPILER:\n</code></pre></div>",
        "id": 562060860,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764928396
    },
    {
        "content": "<p>Note that the ub warning in your output is fixed by <a href=\"https://github.com/leanprover/lean4/commit/72573928b1bc73eb80aa54477333039028fb4366#diff-3c4090168b45d2755473a9a29bb956bdf0b9fe2dd98f3e4d77170b8dd7c5c4cbR400\">https://github.com/leanprover/lean4/commit/72573928b1bc73eb80aa54477333039028fb4366#diff-3c4090168b45d2755473a9a29bb956bdf0b9fe2dd98f3e4d77170b8dd7c5c4cbR400</a>. You might need to backport that and the subsequent diff if they obscure the actual leak analysis.</p>",
        "id": 562062110,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764928790
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562060860\">said</a>:</p>\n<blockquote>\n<p>Ah, that's pretty far already! It does sound like this isn't the same C compiler cmake chose for Lean. You can check that using</p>\n<p><div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cmake<span class=\"w\"> </span>-LA<span class=\"w\"> </span>build/sanitize/stage1<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>CMAKE_C_COMPILER:\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I'll take a look at this later when I have more time. The equivalent code in Lean doesn't crash:</p>\n<p><a href=\"https://codeberg.org/aniva/lean4-reverse-ffi/src/branch/main/Main.lean\">https://codeberg.org/aniva/lean4-reverse-ffi/src/branch/main/Main.lean</a></p>",
        "id": 562278897,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1765073850
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562055191\">said</a>:</p>\n<blockquote>\n<p>If you could make the C changes to make the code compatible with master, I can look into sanitizer part as well, though likely not in the next few days</p>\n</blockquote>\n<p>I updated the example to v4.26.0. It now crashes on iteration 114k instead of 81k.</p>",
        "id": 564654182,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1766137231
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/562055191\">said</a>:</p>\n<blockquote>\n<p>If you could make the C changes to make the code compatible with master, I can look into sanitizer part as well, though likely not in the next few days</p>\n</blockquote>\n<p>I updated the example to v4.26.0. It now crashes on iteration 114k instead of 81k.</p>",
        "id": 564654191,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1766137234
    },
    {
        "content": "<p>And were you able to make progress on the sanitized build as well?</p>",
        "id": 564702981,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1766153020
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Force.20GC.20to.20run/near/564702981\">said</a>:</p>\n<blockquote>\n<p>And were you able to make progress on the sanitized build as well?</p>\n</blockquote>\n<p>no sorry I have been pretty busy</p>",
        "id": 564762736,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1766172079
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"599027\">@Leni Aniva</span> I returned to work on the sanitize build today. I checked out your helpful reproducer and was able to link it with a few more flags. Actually a sanitized build was not necessary, a debug build is sufficient to find the immediate failure:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">LEAN</span><span class=\"w\"> </span><span class=\"n\">ASSERTION</span><span class=\"w\"> </span><span class=\"n\">VIOLATION</span>\n<span class=\"n\">File</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">sebastian</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">sandebug</span><span class=\"bp\">/</span><span class=\"n\">stage1</span><span class=\"bp\">/</span><span class=\"n\">include</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span>\n<span class=\"n\">Line</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1112</span>\n<span class=\"n\">lean_is_string</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Going up the stack reveals this is the case because you call <code>lean_io_result_show_error</code> on a non-<code>IO</code> value but an <code>EIO Lean.Exception</code> that's at the bottom of <code>TermElabM</code>. You need to be more careful at the FFI boundary, you should not peek through monad layers in the foreign code but unwrap everything up to <code>(E)IO</code> (or even <code>BaseIO</code> and handling errors on the Lean side) at the boundary, which I think would have made the mismatch more apparent.</p>\n<p>Printing the <code>Exception</code> on the Lean side reveals the actual root error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"ss\">`elaborator</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">200000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n</code></pre></div>\n<p>This makes sense as you call <code>elabTerm</code> in a loop. You will likely want to wrap each iteration in <code>withCurrHeartbeats</code> to make the counter local to that iteration.</p>",
        "id": 567733208,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1768301355
    },
    {
        "content": "<p>Thank you! Does this this mean it is not possible to call <code>TermElabM</code> and <code>MetaM</code> without a shim on the C side?</p>",
        "id": 567846875,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1768333554
    },
    {
        "content": "<p>The call itself is technically not problematic, although it does rely on the implementation of <code>MetaM</code> / <code>TermElabM</code>. The problem is specifically the error case here, since the error is a <code>Lean.Exception</code> and not an <code>IO.Error</code>. Thus you would need to do something more complicated to get an error string or print out the error. The best way to handle both things though (reliance on implementation details, handling <code>Lean.Exception</code>) would be to offload this to Lean.</p>",
        "id": 567857316,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1768337749
    }
]