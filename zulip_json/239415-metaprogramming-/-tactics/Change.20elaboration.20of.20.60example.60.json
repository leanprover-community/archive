[
    {
        "content": "<p>I want <code>example</code> to add a declaration to the environment with an automatically generated name, so that I can access it later for further processing.</p>\n<p>For this I tried the following very naive attempt: Essentially it is a macro that replaces <code>example</code> by <code>def</code> with an auto-generated name:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eExampleS</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"eExample\"</span><span class=\"w\"> </span><span class=\"s2\">\" : \"</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">eExample</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">eExample</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">newLocalName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">getDeclsInCurrModule</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"name_{(decls.filter fun name ↦ ¬ (name.isInternal)).size}\"</span><span class=\"bp\">.</span><span class=\"n\">toName</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">eExampleExpander</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Syntax</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">eExample</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newLocalName</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">eExample</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newLocalName</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">eExampleS</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">eExampleElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">adaptExpander</span><span class=\"w\"> </span><span class=\"n\">eExampleExpander</span>\n\n<span class=\"c1\">-- work</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"c1\">-- does not work</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#alldecls\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">getDeclsInCurrModule</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{decls.filter fun name ↦ ¬ (name.isInternal)}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">alldecls</span>\n</code></pre></div>\n<p>The issue is that this only works for a small subset of the syntax supported by the <code>example</code> command. Certainly it is possible to extend this to eventually match all possible cases, but I would rather have a more principled solution that uses the <code>example</code> parser directly. I found <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Command.example#doc\">docs#Lean.Parser.Command.example</a>, but I have no idea how to use this to write a macro / elaborator that does the above.</p>",
        "id": 501400887,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740337282
    },
    {
        "content": "<p>(side note: I tried to get rid of the additional <code>eExample</code> step with <code>elab_rules</code>, but I could not figure out how to hook <code>eExampleExpander</code> into that.)</p>",
        "id": 501401038,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740337397
    },
    {
        "content": "<p>What does this do that <code>theorem</code> does not do?  Is it simply giving the declaration a name that you do not know what it is?</p>",
        "id": 501401594,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740337832
    },
    {
        "content": "<p>The usecase is the following: I am given a file with a bunch of <code>example</code>s (and regular <code>theorem</code>s, <code>def</code>s) and I need to inspect all declarations including examples in this file. I could of course do some manual, text-based preprocessing to turn all <code>example</code>s into <code>def</code>s or <code>theorem</code>s and then run the inspection, but I would rather just import a file at the top that changes how <code>example</code> elaborates without touching the actual code.</p>",
        "id": 501401777,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740337996
    },
    {
        "content": "<p>(This depends on my assumption that there is no way to inspect <code>example</code>s, because they don't change the environment. If there is a way to do that directly, without changing the elaboration of <code>example</code>, that would of course be better)</p>",
        "id": 501401903,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740338096
    },
    {
        "content": "<p>What kind of inspection do you want to do?</p>",
        "id": 501402034,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740338190
    },
    {
        "content": "<p>Also, you can take a look at <code>Mathlib/Tactic/SuppressCompilation.lean</code> to see how <code>suppress_compilation</code> parses <code>example</code>s.</p>",
        "id": 501402063,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740338224
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Change.20elaboration.20of.20.60example.60/near/501402034\">said</a>:</p>\n<blockquote>\n<p>What kind of inspection do you want to do?</p>\n</blockquote>\n<p>I have a list of pairs of type signatures and a list of allowed axioms and I need to check if the input file contains a declaration for every entry in that list (i.e. a declaration with the given type signature) and if that declaration uses no other axioms besides the allowed axioms.</p>",
        "id": 501402269,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740338393
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Change.20elaboration.20of.20.60example.60/near/501402063\">said</a>:</p>\n<blockquote>\n<p>Also, you can take a look at <code>Mathlib/Tactic/SuppressCompilation.lean</code> to see how <code>suppress_compilation</code> parses <code>example</code>s.</p>\n</blockquote>\n<p>Ah, thanks! This looks promising. I will report back if I could get it to work from there.</p>",
        "id": 501402385,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740338474
    },
    {
        "content": "<p>Indeed, copy pasting from <code>Mathlib/Tactic/SuppressCompilation.lean</code> worked:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">newLocalName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">getDeclsInCurrModule</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"name_{(decls.filter fun name ↦ ¬ (name.isInternal)).size}\"</span><span class=\"bp\">.</span><span class=\"n\">toName</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">replaceExampleByDef</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">doc?</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">attrs?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">vis?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"kn\">noncomputable</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">unsafe?</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n<span class=\"w\">    </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">recKind?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newLocalName</span>\n<span class=\"w\">  </span><span class=\"n\">elabDeclaration</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">doc?</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">attrs?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">vis?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">unsafe?</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n<span class=\"w\">    </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">recKind?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#alldecls\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decls</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">getDeclsInCurrModule</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{decls.filter fun name ↦ ¬ (name.isInternal)}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">alldecls</span>\n</code></pre></div>\n<p>Thanks again Damiano.</p>",
        "id": 501404610,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740340033
    },
    {
        "content": "<p>Looking quickly at the code above, you seem to have made all \"new\" declarations <code>noncomputable</code> (which is a goal of <code>suppress_compilation</code>), but maybe you want to preserve the same <code>noncomputable</code> flag in your use-case?</p>",
        "id": 501404783,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740340182
    },
    {
        "content": "<p>Oops, yes that was not intended, this should be correct:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">replaceExampleByDef</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">doc?</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">attrs?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">vis?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"kn\">noncomputable</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">unsafe?</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n<span class=\"w\">    </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">recKind?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newLocalName</span>\n<span class=\"w\">  </span><span class=\"n\">elabDeclaration</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">doc?</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">attrs?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">vis?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"kn\">noncomputable</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">unsafe?</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n<span class=\"w\">    </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">recKind?</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>",
        "id": 501404955,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740340307
    },
    {
        "content": "<p>Instead of <code>newLocalName</code>, there's <code>mkAuxName `example 1</code>, which will generate a name like <code>example_5</code>, guaranteed to be unused.</p>",
        "id": 501405310,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740340567
    },
    {
        "content": "<p>The matching can probably be simplified to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">replaceExampleByDef</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dms</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newLocalName</span>\n<span class=\"w\">  </span><span class=\"n\">elabDeclaration</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dms</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>",
        "id": 501405947,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740341110
    },
    {
        "content": "<p>Yes, that works and is quite a bit more readable, thanks. While checking that things still work, I noticed that <code>private</code> declarations (also <code>def</code>) don't show up in my <code>#alldecls</code> command from above, because they are filtered out by <code>¬ name.isInternal</code>. </p>\n<p>Is there a more robust way to query all top level, user accessible declarations of a file, including <code>private</code> ones? Just <code>getDeclsInCurrModule</code> returns many auxiliary declarations.</p>",
        "id": 501407206,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740342126
    },
    {
        "content": "<p>Maybe you can look in <code>Batteries/Tactic/OpenPrivate.lean</code> for <code>private</code>?  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 501407478,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740342365
    },
    {
        "content": "<p>Or maybe use <code>Lean.isPrivateName</code> to unfilter out what's filtered out by <code>isInternal</code>?</p>",
        "id": 501407600,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740342477
    },
    {
        "content": "<p>like <code>Lean.isPrivateName n || !n.isInternal</code></p>",
        "id": 501407669,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740342514
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Change.20elaboration.20of.20.60example.60/near/501407669\">said</a>:</p>\n<blockquote>\n<p>like <code>Lean.isPrivateName n || !n.isInternal</code></p>\n</blockquote>\n<p>This is probably good enough for my purposes, but now contains all internal declarations of private declarations, because also <code>_private.foo._cstage1</code> satisfies <code>Lean.isPrivateName</code>.</p>",
        "id": 501408028,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740342825
    },
    {
        "content": "<p>Since you are already redefining the elaboration of some declarations, maybe you can redefine them all (like in <code>suppress_compilation</code>) and, after each declaration has been elaborated append the type signature and axioms to an environment extension.</p>",
        "id": 501408422,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740343111
    },
    {
        "content": "<p>After that, the environment extension only contains what you added.</p>",
        "id": 501408464,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740343153
    },
    {
        "content": "<p>That sounds like a good idea! I'll try it out.</p>",
        "id": 501408720,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740343369
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"648495\">@Christian Merten</span> Ok, then theres <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.privateToUserName%3F#doc\">docs#Lean.privateToUserName?</a></p>\n<p>Something like <code>let n' := (Lean.privateToUserName? n).getD n; !n'.isInternal</code> should work better.</p>",
        "id": 501408784,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740343433
    },
    {
        "content": "<p>That works perfectly, thanks Kyle!</p>",
        "id": 501409320,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740343872
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Change.20elaboration.20of.20.60example.60/near/501408422\">said</a>:</p>\n<blockquote>\n<p>Since you are already redefining the elaboration of some declarations, maybe you can redefine them all (like in <code>suppress_compilation</code>) and, after each declaration has been elaborated append the type signature and axioms to an environment extension.</p>\n</blockquote>\n<p>I gave this a try. The main issue is that I can't figure out how to properly access the name of the added declaration. Right now I am doing this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isRelevant</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">!</span><span class=\"o\">((</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">privateToUserName?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isInternal</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">appendDeclInfoDemo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dms</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAuxName</span><span class=\"w\"> </span><span class=\"ss\">`example</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">elabDeclaration</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dms</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"added {declName}\"</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">allDeclsBefore</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">getDeclsInCurrModule</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isRelevant</span>\n<span class=\"w\">  </span><span class=\"n\">elabDeclaration</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">allDeclsAfter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">getDeclsInCurrModule</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isRelevant</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">allDeclsAfter</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∉</span><span class=\"w\"> </span><span class=\"n\">allDeclsBefore</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">newDecls</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">head!</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"added {declName}\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>\n<p>This seems to work, but is certainly not very robust. Is there a better way?</p>",
        "id": 501525276,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740398898
    },
    {
        "content": "<p>Here is a possible alternative approach:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isRelevant</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">!</span><span class=\"o\">((</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">privateToUserName?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isInternal</span>\n\n<span class=\"n\">partial</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">scanInfoTree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">NameSet</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">parentDeclCtx</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">scanInfoTree</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">scanInfoTree</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">union</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">scanInfoTree</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∅</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">hole</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">∅</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getAllNames</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PersistentArray</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">scanInfoTree</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">union</span><span class=\"w\"> </span><span class=\"bp\">∅</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">appendDeclInfoDemo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dms</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAuxName</span><span class=\"w\"> </span><span class=\"ss\">`example</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">elabDeclaration</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dms</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getInfoTrees</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"Using `InfoTree`s: {(getAllNames ts).toArray}\"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"added {declName}\"</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">allDeclsBefore</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">getDeclsInCurrModule</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isRelevant</span>\n<span class=\"w\">  </span><span class=\"n\">elabDeclaration</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getInfoTrees</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"Using `InfoTree`s: {(getAllNames ts).toArray}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">allDeclsAfter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">getDeclsInCurrModule</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">isRelevant</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">allDeclsAfter</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∉</span><span class=\"w\"> </span><span class=\"n\">allDeclsBefore</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">newDecls</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">head!</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"added {declName}\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">X</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToString</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">InRoot</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">InRoot</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span><span class=\"w\"> </span><span class=\"c1\">-- panic!</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span>\n</code></pre></div>",
        "id": 501544225,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740403872
    },
    {
        "content": "<p>I have not seen an example where the <code>NameSet</code> that <code>getAllNames</code> returns consists of more than a single name, but I honestly do not understand <code>InfoTree</code>s enough to know whether this is just me not trying hard enough or whether it is a structural property.</p>",
        "id": 501544598,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740403948
    },
    {
        "content": "<p>If you can guarantee that the <code>NameSet</code> consists of a single name, then you can avoid traversing all of the <code>InfoTree</code> and simply return the first (non-anonymous?) name that it finds.</p>",
        "id": 501545321,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740404131
    },
    {
        "content": "<p>It also just occurred to me that the above will ignore entirely <code>mutual</code> definitions: I do not know if this is something that is relevant in your use-case or not.</p>",
        "id": 501545757,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740404235
    },
    {
        "content": "<p>Thanks, that looks quite a bit better, although I understand less what is going on :) Do I understand correctly that the (or one of the) <code>PartialContextInfo</code>s will be of the form <code>.parentDeclCtx parentDecl</code> where <code>parentDecl</code> is the name of the added declaration? I am surprised by the fact that this information leaks out of the call to <code>elabDeclaration</code>.</p>",
        "id": 501549602,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740405157
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Change.20elaboration.20of.20.60example.60/near/501545757\">said</a>:</p>\n<blockquote>\n<p>It also just occurred to me that the above will ignore entirely <code>mutual</code> definitions: I do not know if this is something that is relevant in your use-case or not.</p>\n</blockquote>\n<p>For now, ignoring <code>mutual</code> defs is fine for my use case.</p>",
        "id": 501549902,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740405248
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Change.20elaboration.20of.20.60example.60/near/501549602\">said</a>:</p>\n<blockquote>\n<p>Thanks, that looks quite a bit better, although I understand less what is going on <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> Do I understand correctly that the (or one of the) <code>PartialContextInfo</code>s will be of the form <code>.parentDeclCtx parentDecl</code> where <code>parentDecl</code> is the name of the added declaration? I am surprised by the fact that this information leaks out of the call to <code>elabDeclaration</code>.</p>\n</blockquote>\n<p>I think that this is correct, but I am not entirely sure.  My vague understanding is that a <code>parentDecl</code> in <code>PartialContextInfo</code> contains the name of the declaration that is currently being elaborated.  I would hope that such a node is always present when you are elaborating a declaration!</p>",
        "id": 501550852,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740405497
    },
    {
        "content": "<p>So <code>elabDeclaration</code> is updating the info tree with this information somewhere?</p>",
        "id": 501552494,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740405912
    },
    {
        "content": "<p>I think that <em>everything</em> that elaborates <em>anything</em> is expected to update the infotrees.  I even think that if it does not, then it might be considered a bug!</p>",
        "id": 501552655,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740405955
    },
    {
        "content": "<p>The information that is stored in the infotrees is used, I think, by the hover information and if you hover over the name of a declaration, you see it's fully-qualified name.  This suggests to me that some node of the infotree will contain that information.</p>",
        "id": 501553009,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740406044
    },
    {
        "content": "<p>I have a conjecture that any information that you may want to extract from lean code you can extract from the infotrees.</p>",
        "id": 501553279,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740406110
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Change.20elaboration.20of.20.60example.60/near/501552655\">said</a>:</p>\n<blockquote>\n<p>I think that <em>everything</em> that elaborates <em>anything</em> is expected to update the infotrees.  I even think that if it does not, then it might be considered a bug!</p>\n</blockquote>\n<p>But this is up to the implementation of the specific elaborator and not automatically done by the <code>elab</code> or <code>@[command_elab]</code> infrastructure, right? Moving your</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getInfoTrees</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"Using `InfoTree`s: {(getAllNames ts).toArray}\"</span>\n</code></pre></div>\n<p>before <code>elabDeclaration</code> yields an empty output.</p>",
        "id": 501553673,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740406224
    },
    {
        "content": "<p>Ah, yes, I probably expressed myself badly: you should expect the infotrees to be updated by <code>elabDeclaration</code> (or rather some of the inner <code>elabXXX</code> that <code>elabDeclaration</code> calls.  There, I was piggy-backing the infotrees that <code>elabDeclaration</code> updated.  Until you call <code>elabDeclaration</code> the infotrees for the declaration have not yet been created.</p>",
        "id": 501556640,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740406953
    },
    {
        "content": "<p><code>elabDeclaration</code> also takes care of updating the environment, which is what you were exploiting in your code: you were storing the declarations <em>before</em> elaboration and comparing them to the ones <em>after</em>.</p>",
        "id": 501557044,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740407047
    },
    {
        "content": "<p>In the \"after\" world, besides the change in the environment, there are also infotrees to play with.</p>",
        "id": 501557111,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740407066
    },
    {
        "content": "<p>When I talked about it being a bug not updating the infotrees, I meant that the low-level <code>elabXXX</code> should do that for you, not that you should be doing that yourself.</p>",
        "id": 501557381,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740407138
    },
    {
        "content": "<p>(Also, do not take what I said too literally, since a lot about infotrees is obscure to me!)</p>",
        "id": 501558046,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740407278
    },
    {
        "content": "<p>Thanks for the explanations, Damiano. That makes it a lot clearer.</p>",
        "id": 501558814,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740407421
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Change.20elaboration.20of.20.60example.60/near/501405310\">said</a>:</p>\n<blockquote>\n<p>Instead of <code>newLocalName</code>, there's <code>mkAuxName `example 1</code>, which will generate a name like <code>example_5</code>, guaranteed to be unused.</p>\n</blockquote>\n<p>This does not seem to interact well with namespaces, for example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">replaceExampleByDef</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dms</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAuxName</span><span class=\"w\"> </span><span class=\"ss\">`example</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">elabDeclaration</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dms</span><span class=\"o\">:</span><span class=\"n\">declModifiers</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">sig</span><span class=\"o\">:</span><span class=\"n\">optDeclSig</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">declVal</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: 'Foo.example_1' has already been declared</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n</code></pre></div>\n<p>How do I make <code>mkAuxName</code> namespace aware? My guess is that the check <a href=\"https://github.com/leanprover/lean4/blob/fafd381c90598fe9969f3cb8f1df9b3d1b87a219/src/Lean/MonadEnv.lean#L84\">here</a> does not first resolve the namespace of <code>candidate</code>, hence it sees that <code>example_1</code> does not exist, so it returns that name, which is then added as <code>Foo.example_1</code> by <code>elabDeclaration</code>.<br>\n(For now, I just went back to my naive <code>newLocalName</code>, but I would like to know how to do it properly)</p>",
        "id": 510392492,
        "sender_full_name": "Christian Merten",
        "timestamp": 1743873017
    },
    {
        "content": "<p>If you do <code>let name ← `_root_ ++ mkAuxName `example 1</code>, I think it should work. That would have it always go into the root namespace.</p>\n<p>Or, you could do something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">baseName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getCurrNamespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"ss\">`example</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">mkAuxName</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"ss\">`_root_</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">baseName</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>if you want it to be inside the namespace.</p>",
        "id": 510394274,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743874408
    },
    {
        "content": "<p>You probably meant <code>let name := `_root_ ++ (← mkAuxName `example 1)</code> which works, thanks! The second one fails with the same error as above, though.</p>",
        "id": 510395258,
        "sender_full_name": "Christian Merten",
        "timestamp": 1743875175
    },
    {
        "content": "<p>Yes, that was a mistake!</p>",
        "id": 510395433,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743875335
    },
    {
        "content": "<p>The second one should be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">baseName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getCurrNamespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"ss\">`example</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`_root_</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">mkAuxName</span><span class=\"w\"> </span><span class=\"n\">baseName</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 510395548,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743875408
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 510395732,
        "sender_full_name": "Christian Merten",
        "timestamp": 1743875573
    }
]