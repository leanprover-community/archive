[
    {
        "content": "<p>Is there a standard way to extract (and instantiate ) all metavariables in a type? For example, assume that I have some existing type variables <code>(A B ... : Type)</code> that I want to use in <code>?α</code>, <code>?α × ?β</code>, ..., <code>List ?α</code>, <code>List (?α × ?β)</code>,  <code>List (?α × ?β × ?γ)</code>, etc. The assumption here is that the only metavariables are these type variables</p>",
        "id": 480108581,
        "sender_full_name": "Chris Henson",
        "timestamp": 1730490277
    },
    {
        "content": "<p>Could you say a bit more about the context of what you're doing?</p>",
        "id": 480108827,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730490373
    },
    {
        "content": "<p>The gist is that I'd like to write a macro to insert some typeclass instances that are basically serving as type hints. Something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Hint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- I'd like a macro where `add_hint List (?α × ?β)` expands to</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Hint</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Hint</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n</code></pre></div>",
        "id": 480110428,
        "sender_full_name": "Chris Henson",
        "timestamp": 1730491093
    },
    {
        "content": "<p>See <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/CollectMVars.html\">https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/CollectMVars.html</a></p>",
        "id": 480111329,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1730491457
    },
    {
        "content": "<p>What is the actual output you want? A new instance? Or instance syntax with a \"try this\"-like functionality?</p>",
        "id": 480111552,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730491559
    },
    {
        "content": "<p>If there is another way to hint to typeclass inference to </p>\n<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Extract.20and.20instantiate.20metavariables.20of.20a.20type/near/480111329\">said</a>:</p>\n<blockquote>\n<p>See <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/CollectMVars.html\">https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/CollectMVars.html</a></p>\n</blockquote>\n<p>This looks helpful, thanks!</p>",
        "id": 480111871,
        "sender_full_name": "Chris Henson",
        "timestamp": 1730491690
    },
    {
        "content": "<p>Could you clarify your first sentence <span class=\"user-mention\" data-user-id=\"687698\">@Chris Henson</span> ? Sorry, I'm not following what you mean.</p>",
        "id": 480112132,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730491809
    },
    {
        "content": "<p>Anyway, there are some limitations with this (namely mkAppM can fail because it won't assign universe level variables, which is fixable), but a metaprogramming approach can be to use metavariable abstraction functions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Hint</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"add_hint \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">runTermElabM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabType</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"w\">    </span><span class=\"n\">synthesizeSyntheticMVarsNoPostponing</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">abstractMVars</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">levels</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">lambdaBoundedTelescope</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"bp\">.</span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"bp\">.</span><span class=\"n\">numMVars</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">margs</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newDecls</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">margs</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">marg</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshUserName</span><span class=\"w\"> </span><span class=\"ss\">`inst</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">BinderInfo</span><span class=\"bp\">.</span><span class=\"n\">instImplicit</span><span class=\"o\">,</span>\n<span class=\"w\">          </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">`Hint</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">marg</span><span class=\"o\">])</span>\n<span class=\"w\">      </span><span class=\"n\">withLocalDecls</span><span class=\"w\"> </span><span class=\"n\">newDecls</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">hints</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkForallFVars</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">margs</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">hints</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">`Foo</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">expr</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"hinted type is {ty}\"</span>\n\n\n<span class=\"n\">add_hint</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">β</span><span class=\"o\">)</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">hinted type is (α : Type ?u.5137) →</span>\n<span class=\"cm\">  (β : Type ?u.5136) → [inst : Hint (Type ?u.5137)] → [inst : Hint (Type ?u.5136)] →</span>\n<span class=\"cm\">  Foo (List (α × β))</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"n\">add_hint</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">hinted type is (n : ℕ) → (α : Type ?u.5155) → [inst : Hint (Type ?u.5155)] → Foo (List α → Fin n)</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 480113122,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730492308
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Extract.20and.20instantiate.20metavariables.20of.20a.20type/near/480112132\">said</a>:</p>\n<blockquote>\n<p>Could you clarify your first sentence <span class=\"user-mention silent\" data-user-id=\"687698\">Chris Henson</span> ? Sorry, I'm not following what you mean.</p>\n</blockquote>\n<p>No worries, I'm new to the metaprogramming and probably a bit unclear. Let me try explaining again. </p>\n<p>In my actual use case, I'm trying to tag these certain type variables to be used in some other typeclass inference. I'm doing so via this empty <code>Hint</code> typeclass, which works fine but is a bit clunky. So I'd just like that a macro so that calling <code>add_hint T</code>, extract all metavariables from <code>T</code> (which I think the suggestion from Daniel does) and end up expanding to the output instance <code>instance [Hint A] [Hint B] ... : Foo T</code>, where I have instantiated all the type metavariables in T.</p>\n<p>Very likely not the \"right\" think to do, I'm just learning what's possible at this point.</p>",
        "id": 480113316,
        "sender_full_name": "Chris Henson",
        "timestamp": 1730492413
    },
    {
        "content": "<p>To be clear, when you say \"expand\", you mean update the source code right? There are multiple levels of representation, and it matters a lot which you want to operate on.</p>",
        "id": 480113550,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730492549
    },
    {
        "content": "<p>If it's just at the Syntax level, you can avoid touching Meta stuff completely.</p>",
        "id": 480113598,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730492583
    },
    {
        "content": "<p>I see you did say \"macro\", did you mean that in the Lean macro sense?</p>",
        "id": 480113900,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730492744
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Extract.20and.20instantiate.20metavariables.20of.20a.20type/near/480113900\">said</a>:</p>\n<blockquote>\n<p>I see you did say \"macro\", did you mean that in the Lean macro sense?</p>\n</blockquote>\n<p>Okay took me a bit to walk through your code, but I think I mostly understand. I think  elab would have been more accurate to say. (Thanks for your patience, still learning the verbiage!) I think your code is doing roughly what I was thinking, though I did mean just creating a new instance. A couple of questions. This constructs and works with the instances locally for the logging, but if I wanted, I could just silently create this instance, right? I also don't quite get what you mean about \"just at the Syntax level\", you mean a different approach that manipulates just the syntax that happens to have metavariables in it?</p>",
        "id": 480117498,
        "sender_full_name": "Chris Henson",
        "timestamp": 1730494766
    },
    {
        "content": "<p>Yes, you can manipulate the <code>?x</code> syntax directly, without actually working with metavariables per se. Take a look at the implementation of the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Tactic.congrM#doc\">docs#Mathlib.Tactic.congrM</a> syntax for an example. You could construct an <code>instance</code> Syntax and then elaborate that with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.elabCommand#doc\">docs#Lean.Elab.Command.elabCommand</a></p>",
        "id": 480129637,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730502845
    },
    {
        "content": "<p>Okay that makes sense and seems nicer in some ways. In contrast If I were to build from your example using metavariables, I would create the instance there too using something like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.addInstance#doc\">docs#Lean.Meta.addInstance</a>, right?</p>",
        "id": 480130865,
        "sender_full_name": "Chris Henson",
        "timestamp": 1730503947
    },
    {
        "content": "<p><code>addInstance</code> would be the last step, after actually defining the function and adding it to the environment. It tends to be easier to make macros that just ask <code>def</code>/<code>instance</code>/etc. to handle everything for you.</p>",
        "id": 480131374,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730504452
    }
]