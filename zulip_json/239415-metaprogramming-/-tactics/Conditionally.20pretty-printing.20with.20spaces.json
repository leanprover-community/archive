[
    {
        "content": "<p>I'm trying to make a syntax that will pretty pretty spaces between its parameters only if those parameters are <em>not</em> numeric literals. Specifically, I want <code>[O2|C4]</code>, but <code>[O n|C3]</code>, <code>[O2|C k]</code>, and <code>[O n|C m]</code>. </p>\n<p>I think I need to write a <code>PrettyPrinter.Formatter</code>, but there's no equivalent to <code>app_unexpander</code> or <code>app_delab</code> that I'm aware of, for example, and I don't know how else to set up the trigger. (<code>combinator_formatter termFoo</code> at least typechecks but doesn't actually <em>run</em>, as verified by <code>dbgTrace</code>). I would <em>like</em> to be able to just write something like </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[O\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lookahead</span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">ppSpace</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"|C\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lookahead</span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">ppSpace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>but you can't use <code>notation</code> with general syntax and since I don't know any way of putting explicit whitespace into a <code>Syntax</code> object I can't make an unexpander to make the above macro pretty-print the way I want.</p>",
        "id": 541938560,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1759116319
    },
    {
        "content": "<p>You might run into some trouble here since the formatter is token-aware. It'll insert spaces automatically between <code>O</code> and <code>2</code> because <code>O2</code> parses as an identifier.</p>\n<p>How is <code>O2</code> able to parse? It's generally not a good idea to pretty print in a way that's not parseable.</p>\n<p>One hack you can do is use a <a href=\"https://en.wikipedia.org/wiki/Zero-width_space\">zero-width space</a>.</p>",
        "id": 542010580,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759145048
    },
    {
        "content": "<p>Oh, right, <code>\"[O\"</code> makes the parsing possible.</p>",
        "id": 542011042,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759145174
    },
    {
        "content": "<p>Here's a hack:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[O\"</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">preSpace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ppSpace</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkPreSpace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Unhygienic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">preSpace</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpandF</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$_</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">])</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$_</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkPreSpace</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)])</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">O2</span><span class=\"o\">]</span>\n<span class=\"c1\">-- [O2]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span>\n<span class=\"c1\">-- [O n]</span>\n</code></pre></div>",
        "id": 542012414,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759145552
    },
    {
        "content": "<p>So that's how you do it. I was thinking about something like that, but I'd forgotten (if I ever knew) how to set up a term generator outside of a quasiquote. Thanks, that'll work nicely!</p>",
        "id": 542204868,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1759218502
    }
]