[
    {
        "content": "<p>While imperative programming features (<code>let mut</code>, <code>break</code>) are convenient, and especially helpful to people not used to functional code, there are a bunch of well known catches.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"c1\">-- x := false -- not compatible with monadic functions</span>\n<span class=\"w\">  </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">withTransparency</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">reducible</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"hello\"</span>\n<span class=\"w\">    </span><span class=\"c1\">-- x := false -- annoyingly including context modifications</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"sum\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"not a sum\"</span>\n<span class=\"w\">    </span><span class=\"c1\">-- x := false -- or Qq match</span>\n</code></pre></div>\n<p>I was curious if there is any plan to something with that. My intuitive expectation would be that e.g. <code>let mut</code> should create something like <code>StateT</code>, and program flow commands such as <code>break</code> / <code>return</code> something like <code>ExceptT</code>. Are there reasons why it is not the case? Efficiency? Breaking / too slow type inference?</p>\n<p>One of the reasons I am asking is that I thought if commands like <code>run_cmd</code> could run each line under a different <code>Ref</code>, so for example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"A\"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"B\"</span>\n</code></pre></div>\n<p>would shows \"A\", \"B\" on the corresponding lines rather than all at the first line <code>run_cmd</code>. I could imagine running each line with <code>withRef</code> but I am unsure how to make it compatible with imperative programming features.</p>",
        "id": 533233693,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1754551884
    },
    {
        "content": "<p>The logInfo problem wouldn't be helped by adding <code>withRef</code> to each line. This is a compile-time/run-time staging problem. At runtime, the ref is not going to be the source code being run, but instead whatever the ref happens to be in the monad reader context. The <code>run_cmd</code> elaborator sets the ref to <code>run_cmd</code> before evaluating the compiled code.</p>\n<p>The easiest solution to this is probably making a macro for logging that's specifically for <code>#eval</code>/<code>run_cmd</code>/etc., which captures the ref and quotes it to produce a <code>logInfoAt</code> syntax.</p>",
        "id": 533325612,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754583772
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Olšák</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Imperative.20catches/near/533233693\">said</a>:</p>\n<blockquote>\n<p>I was curious if there is any plan to something with that</p>\n</blockquote>\n<p>I've heard some ideas before about being able to extend what counts as control flow for <code>do</code> notation. I don't know much about it though, other than that rewriting <code>do</code> notation is one of this year's tasks for the FRO, so we'll finally start seeing some improvements in this area.</p>",
        "id": 533326105,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754583983
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Imperative.20catches/near/533325612\">said</a>:</p>\n<blockquote>\n<p>making a macro for logging</p>\n</blockquote>\n<p>Quick example of this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Substring</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">SourceInfo</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">ToExpr</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Syntax</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">:</span><span class=\"s2\">\"log_info_here!\"</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">interpolatedStr</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">refExpr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">exprToSyntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"n\">tk</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">``</span><span class=\"o\">(</span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">refExpr</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">log_info_here!</span><span class=\"w\"> </span><span class=\"s2\">\"msg {x}\"</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"n\">log_info_here!</span><span class=\"w\"> </span><span class=\"s2\">\"msg {x}\"</span>\n</code></pre></div>\n<p>The messages are localized to each <code>log_info_here!</code></p>",
        "id": 533327935,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754584679
    },
    {
        "content": "<p>This <em>must</em> not be used in compiled code that gets run in a different module.</p>\n<p>It would be kind of neat though if there were an option you could set where all the debug messages that could appear in the current file do appear in the current file. I've definitely wanted this before, though with unique enough trace messages you can figure out where everything's coming from, so it's not blocking debugging things.</p>",
        "id": 533328173,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754584769
    },
    {
        "content": "<blockquote>\n<p>This <em>must</em> not be used in compiled code that gets run in a different module</p>\n</blockquote>\n<p>Could you elaborate on why?</p>",
        "id": 533333879,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754587136
    },
    {
        "content": "<p>It will show the error in the current file, using whatever source range was compiled into the function.</p>\n<p>I forget the exact number, but it would be like the \"line 45 problem\" in Lean 3, where certain errors showed up at a specific spot in the current file, because that's the line the macro was defined on in another file.</p>",
        "id": 533335058,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754587631
    },
    {
        "content": "<p>It's possible to detect that it's running from a different module (assuming you have access to the environment), and you could choose some policy, like \"don't log\" or \"log at the current ref instead\", but the point is that you can't use the prototype above as-is as a general solution.</p>",
        "id": 533335464,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754587785
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Imperative.20catches/near/533325612\">said</a>:</p>\n<blockquote>\n<p>The logInfo problem wouldn't be helped by adding <code>withRef</code> to each line. This is a compile-time/run-time staging problem. At runtime, the ref is not going to be the source code being run, but instead whatever the ref happens to be in the monad reader context. The <code>run_cmd</code> elaborator sets the ref to <code>run_cmd</code> before evaluating the compiled code.</p>\n<p>The easiest solution to this is probably making a macro for logging that's specifically for <code>#eval</code>/<code>run_cmd</code>/etc., which captures the ref and quotes it to produce a <code>logInfoAt</code> syntax.</p>\n</blockquote>\n<p>This is not exactly how I imagine it should work. When I have an arbitrary function calling some logInfo's inside, it makes more sense to see the messages on that line rather than at the top. But thanks for the example, this is what I meant by inserting <code>withRef</code>s (which in general could break <code>do</code> syntax if I wanted to do it more automated) </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"withRefHere\"</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">refExpr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">exprToSyntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">``</span><span class=\"o\">(</span><span class=\"n\">withRef</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">refExpr</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">helloWorld</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"hello world!\"</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withRefHere</span><span class=\"w\"> </span><span class=\"n\">helloWorld</span>\n</code></pre></div>",
        "id": 533338092,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1754588850
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Imperative.20catches/near/533326105\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Olšák</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Imperative.20catches/near/533233693\">said</a>:</p>\n<blockquote>\n<p>I was curious if there is any plan to something with that</p>\n</blockquote>\n<p>I've heard some ideas before about being able to extend what counts as control flow for <code>do</code> notation. I don't know much about it though, other than that rewriting <code>do</code> notation is one of this year's tasks for the FRO, so we'll finally start seeing some improvements in this area.</p>\n</blockquote>\n<p>Good to hear that Lean's FRO sees the <code>do</code> notation as worth improving.</p>",
        "id": 533338319,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1754588949
    },
    {
        "content": "<p>Actually, maybe it doesn't break <code>do</code> notation if I only wrap insides of all the <code>do</code> commands.</p>",
        "id": 533339145,
        "sender_full_name": "Mirek Olšák",
        "timestamp": 1754589318
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133339\">Mirek Olšák</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Imperative.20catches/near/533338092\">said</a>:</p>\n<blockquote>\n<p>this is what I meant by inserting</p>\n</blockquote>\n<p>I understood that, but I was suggesting something else that seemed better (inserting <code>withRefHere</code>s automatically is interesting, but it also seems like it might lead to surprising behaviors — still, doesn't hurt to try it out).</p>\n<p>The example with putting the message on the line in the <code>run_cmd</code> does clarify what you're going for.</p>\n<p>Maybe you could look at all the possible doElems and evaluate which ones you can put withRefHere in front of, or into. Presumably you'd also want it inside <code>(&lt;- ...)</code> term notation.</p>",
        "id": 533350841,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754594468
    }
]