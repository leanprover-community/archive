[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">statement</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"k\">forall</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">forallTelescope</span><span class=\"w\"> </span><span class=\"n\">statement</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eq?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Goal is not an Eq\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkFreshLevelMVar</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkFreshExprSyntheticOpaqueMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkSort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkFreshExprSyntheticOpaqueMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">forallE</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkFreshExprSyntheticOpaqueMVar</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkFreshExprSyntheticOpaqueMVar</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkFreshExprSyntheticOpaqueMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkEq</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"n\">a₂</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">getDecl</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">lctx</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">decl</span><span class=\"bp\">.</span><span class=\"n\">fvarId</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">revert</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">fvars</span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">h'</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"bp\">.</span><span class=\"n\">getType</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>fails with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">5</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">3</span>\n<span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">application</span>\n<span class=\"w\">  </span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">5</span>\n</code></pre></div>\n<p>what is going on here? All the mvars up to <code>h'</code> seem to be fine and pass <code>Meta.check</code>.</p>\n<p>This is on Lean v4.25.2 and v4.26.0</p>",
        "id": 562841621,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1765332296
    },
    {
        "content": "<p>it's something with delay assigned mvars</p>",
        "id": 562843309,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765333190
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/.60Meta.2Echeck.60.20fails.20after.20revert/near/562843309\">said</a>:</p>\n<blockquote>\n<p>it's something with delay assigned mvars</p>\n</blockquote>\n<p>is my code incorrect or is this a Lean bug? Ive never seen it before</p>",
        "id": 562843352,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1765333213
    },
    {
        "content": "<p>I think it's a lean bug</p>",
        "id": 562844213,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765333671
    },
    {
        "content": "<p>I looked through the log of <code>Meta/Basic.lean</code> and didn't find anything suspicious down to 4.24</p>\n<p><code>Meta.withAssignableSyntheticOpaque</code> seems to be a viable workaround for now.</p>",
        "id": 562844513,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1765333818
    },
    {
        "content": "<p><code>Meta.check</code> doesn't actually check anything about metavariable consistency. It probably should, but unfortunately that means that <code>Meta.check</code> succeeding doesn't mean things are ok.</p>\n<p>(I haven't read your code carefully)</p>",
        "id": 562845120,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1765334110
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/.60Meta.2Echeck.60.20fails.20after.20revert/near/562845120\">said</a>:</p>\n<blockquote>\n<p><code>Meta.check</code> doesn't actually check anything about metavariable consistency. It probably should, but unfortunately that means that <code>Meta.check</code> succeeding doesn't mean things are ok.</p>\n<p>(I haven't read your code carefully)</p>\n</blockquote>\n<p>but in this case it fails</p>",
        "id": 562845173,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1765334132
    },
    {
        "content": "<p>the two <code>?m.3</code>s in the error message are two different delay-assigned mvars</p>",
        "id": 562845213,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765334154
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/.60Meta.2Echeck.60.20fails.20after.20revert/near/562845213\">said</a>:</p>\n<blockquote>\n<p>the two <code>?m.3</code>s in the error message are two different delay-assigned mvars</p>\n</blockquote>\n<p>Yes. This is evident after enabling <code>pp.all</code></p>",
        "id": 562845260,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1765334180
    },
    {
        "content": "<p>Should I write a bug report? Looking from the result of my fuzzing tests it seems like this behaviour shows up in other cases.</p>",
        "id": 562845373,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1765334239
    },
    {
        "content": "<p>Also, for my use case I don't need to do the full <code>check</code> but just <code>isProof</code>. It seems like they use the same code path</p>",
        "id": 563285554,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1765488443
    },
    {
        "content": "<p>Filed as <a href=\"https://github.com/leanprover/lean4/issues/11978\">https://github.com/leanprover/lean4/issues/11978</a></p>",
        "id": 573451332,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1770881635
    }
]