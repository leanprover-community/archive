[
    {
        "content": "<p>I have this example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"by \"</span><span class=\"w\"> </span><span class=\"n\">colGt</span><span class=\"w\"> </span><span class=\"n\">tacticSeqIndentGt</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"kd\">@[</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">implTest</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{repr stx[1]}, {stx[1].getOptional?}\"</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">test</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I see <code>stx[1]</code> got something in the second <code>test</code>, but <code>stx[1].getOptional?</code> is returning <code>none</code>. Is it designed that way, or is that a bug?</p>",
        "id": 542159293,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1759189457
    },
    {
        "content": "<p>Hmm I see the documentatation is not the best here, better would maybe be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">Assuming `stx` was parsed by `optional`, returns the enclosed syntax</span>\n<span class=\"sd\">if it parsed exactly one syntax node and `none` otherwise.</span>\n<span class=\"sd\">-/</span>\n</code></pre></div>\n<p>In other words, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Syntax.getOptional%3F#doc\">docs#Lean.Syntax.getOptional?</a> only works when there is exactly one node inside of it; here you have 2 though: <code>\"by \"</code> and <code>tacticSeqIndentGt</code>.<br>\nAnyways, you should usually not need to bother with this, use <code>elab</code> or <code>elab_rules</code> or in general syntax match instead:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"by \"</span><span class=\"w\"> </span><span class=\"n\">colGt</span><span class=\"w\"> </span><span class=\"n\">tacticSeqIndentGt</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{seq}\"</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"c1\">-- none</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">trivial</span><span class=\"w\"> </span><span class=\"c1\">-- some (trivial)</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 542159983,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1759190080
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Why.20.60getOptional.3F.60.20is.20not.20working.20for.20.60.28tacticSeq.29.3F.60.3F/near/542159983\">said</a>:</p>\n<blockquote>\n<p>Hmm I see the documentatation is not the best here, better would maybe be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">Assuming `stx` was parsed by `optional`, returns the enclosed syntax</span>\n<span class=\"sd\">if it parsed exactly one syntax node and `none` otherwise.</span>\n<span class=\"sd\">-/</span>\n</code></pre></div>\n<p>In other words, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Syntax.getOptional%3F#doc\">docs#Lean.Syntax.getOptional?</a> only works when there is exactly one node inside of it; here you have 2 though: <code>\"by \"</code> and <code>tacticSeqIndentGt</code>.<br>\nAnyways, you should usually not need to bother with this, use <code>elab</code> or <code>elab_rules</code> or in general syntax match instead:</p>\n</blockquote>",
        "id": 542160737,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1759190556
    },
    {
        "content": "<p>Thanks! I found that doing matching on <code>stx[2].getArgs</code> also solves the problem, but I felt that's not the standard way to do so. Your solution is definitely more elegant!</p>",
        "id": 542160898,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1759190627
    }
]