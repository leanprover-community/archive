[
    {
        "content": "<p>After a PR to Lean of mine, <code>to_additive</code> fails with </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">GroupTheory</span><span class=\"bp\">/</span><span class=\"n\">Congruence</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">200</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">translated</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">correct</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">help</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">docstring</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"ss\">`to_additive</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"ss\">`Troubleshooting</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">declaration</span>\n<span class=\"n\">AddCon</span><span class=\"bp\">.</span><span class=\"n\">quotientKerEquivRange</span><span class=\"o\">:</span>\n<span class=\"n\">Unknown</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"ss\">`AddMonoidHom.mrangeRestrict._proof_2</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>I could fix this by </p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gi\">+import all Mathlib.Algebra.Group.Submonoid.Operations`</span>\n</code></pre></div>\n<p>Is that the right away to expose to <code>to_additive</code> such helper theorems?</p>",
        "id": 561428052,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1764685775
    },
    {
        "content": "<p>Currently yes, I think so. Curiously there is only one other such import right now, maybe a few more I haven't annotated with a comment. It would be great to come up with better approaches.</p>",
        "id": 561436550,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764687568
    },
    {
        "content": "<p>Can either of you explain what is going on here? Presumably the module system doesn't make such internal declarations available anymore by default? However, if <code>AddMonoidHom.mrangeRestrict._proof_2</code> is not available, then why is <code>MonoidHom.mrangeRestrict._proof_2</code> (i.e. the multiplicative of the auxiliary decl) available (which I presume it is, since it should occurs in the definition of <code>Con.quotientKerEquivRange</code> - the declaration we are currently additivizing).</p>",
        "id": 561446769,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1764689675
    },
    {
        "content": "<p><del>These theorems are available, but without their body (for almost everything but <code>to_additive</code> theorem bodies are irrelevant)</del></p>\n<p>Ah, I see what you are saying: Because <code>MonoidHom.mrangeRestrict</code> has been to-additivized, the aux proof should be as well (in a context where there the proof body is visible)?</p>",
        "id": 561452122,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1764690627
    },
    {
        "content": "<p>The definition <code>MonoidHom.mrangeRestrict</code> has two auxiliary theorems: <code>mrangeRestrict._proof_1</code> and <code>mrangeRestrict._proof_2</code>. The additive version of <code>mrangeRestrict._proof_1</code> already exists, and is <code>AddMonoidHom.mrange_comp._proof_1</code>. As a result, the additive version of <code>mrangeRestrict._proof_2</code> is <code>AddMonoidHom.mrangeRestrict._proof_1</code>. So, we should translate <code>mrangeRestrict._proof_2</code> to <code>AddMonoidHom.mrangeRestrict._proof_1</code> instead of <code>AddMonoidHom.mrangeRestrict._proof_2</code> (which doesn't exist).</p>\n<p>The reason why <code>AddMonoidHom.mrange_comp._proof_1</code> already exists and <code>MonoidHom.mrange_comp._proof_1</code> does not, is that <code>to_additive</code> is too aggressive with abstracting proofs: is should only do this in the value of <code>def</code>s (which is what normal definitions do). For this I've made <a href=\"https://github.com/leanprover-community/mathlib4/pull/32393\">#32393</a>.</p>\n<p>I do not know why any of these proofs were showing up for you though, because I would have expected them to all be <code>private</code> to the module system.</p>",
        "id": 561621488,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764760478
    },
    {
        "content": "<p>So <a href=\"https://github.com/leanprover-community/mathlib4/pull/32393\">#32393</a> is likely an unrelated bug, not fixing the \"Unknown constant\"-error Joachim encountered, right?<br>\nOne thing that might be relevant is that <code>to_additive</code> <a href=\"https://github.com/leanprover-community/mathlib4/blob/94d3ca273ea5d6cfe1c29c6aa66c17da56eaa628/Mathlib/Tactic/Translate/Core.lean#L540\">unfolds</a> all aux-declarations occurring in its value. This is necessary to have enough context for <code>to_additive</code> translation heuristics to work correctly.</p>",
        "id": 561763596,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1764801505
    },
    {
        "content": "<p>Right, and that needs access to the non exposed bodies, so same module or import all</p>",
        "id": 561764674,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1764802135
    }
]