[
    {
        "content": "<p>I am writing a automatic theorem solver and in the process I need to know the type of the end goal and hypotheses, I know how to get their values, but when developing the solver I need to know their raw value to match them and apply simple tactics on them</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">endSorry</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"sorry?\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`Eq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"by Simp Eq\"</span>\n<span class=\"w\">        </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{a}\"</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`Eq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"by Eq\"</span>\n<span class=\"w\">        </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{a}\"</span>\n<span class=\"w\">        </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{b}\"</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"By default: {a}\"</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getRef</span>\n<span class=\"w\">        </span><span class=\"n\">addTermSuggestion</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`sorry</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">admitGoal</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n</code></pre></div>\n<p>right now there are 2 cases the EQ case (which does not work) and the default case, What I want to know is if there is any easy way to know the value (type) in a, since with <code>m!\"{a}\"</code> I get the user friendly <code>a = a</code> and with <code>s!\"{a}\"</code> I get <code>Eq.{u_1} _uniq.13 _uniq.14 _uniq.14</code>, when what I want is of the format <code>Expr.(...) (...)</code> so I can know with what I am matching</p>",
        "id": 527887484,
        "sender_full_name": "Francisco Lima",
        "timestamp": 1752067372
    },
    {
        "content": "<p>You shouldn't use <code>match</code>, here, because of metavariables</p>",
        "id": 527887971,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752067486
    },
    {
        "content": "<p>try <code>set_option pp.all true</code> to get the pretty printer to display something closer to what is actually represented by the exprs</p>",
        "id": 527888509,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752067605
    },
    {
        "content": "<p>How should I do it then? I thought of using if let but since there would be a few dozen rules it would become impractical quite quickly</p>",
        "id": 527888589,
        "sender_full_name": "Francisco Lima",
        "timestamp": 1752067620
    },
    {
        "content": "<p>for <code>Eq</code> specifically you can use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.matchEq%3F#doc\">docs#Lean.Meta.matchEq?</a></p>",
        "id": 527888675,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752067635
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"936530\">Francisco Lima</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/See.20raw.20value.20of.20a.20Expr.20variable/near/527888589\">said</a>:</p>\n<blockquote>\n<p>How should I do it then? I thought of using if let but since there would be a few dozen rules it would become impractical quite quickly</p>\n</blockquote>\n<p>You should try out <a href=\"https://github.com/leanprover-community/quote4\">Quote4</a>, it's really useful, with <code>Qq</code> you can write a sort of match expression</p>",
        "id": 527888964,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752067700
    },
    {
        "content": "<p>ok, using it now but the match now expects a Q but the type is Expr, is there anything in Qq to make a Q from a Arbitrary expression?</p>",
        "id": 527892916,
        "sender_full_name": "Francisco Lima",
        "timestamp": 1752068830
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Qq.inferTypeQ#doc\">docs#Qq.inferTypeQ</a></p>",
        "id": 527894271,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752069226
    },
    {
        "content": "<p>Ok, thanks do you understand why this gives an error?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">qType</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">inferTypeQ</span><span class=\"w\"> </span><span class=\"n\">type</span>\n\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">qType</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">admitGoal</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"By default: {a}\"</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getRef</span>\n<span class=\"w\">        </span><span class=\"n\">addTermSuggestion</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"gr\">sorry</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">admitGoal</span><span class=\"w\"> </span><span class=\"n\">goal</span>\n</code></pre></div>\n<p>I get </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">kernel</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">metavariables</span><span class=\"w\"> </span><span class=\"bp\">'_</span><span class=\"n\">aux_EndSorry_Syntax___elabRules_endSorry_1'</span>\n</code></pre></div>",
        "id": 527896242,
        "sender_full_name": "Francisco Lima",
        "timestamp": 1752069753
    },
    {
        "content": "<p>And a type mismatch on <code>~q($a = $b)</code></p>",
        "id": 527896466,
        "sender_full_name": "Francisco Lima",
        "timestamp": 1752069811
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/239415-metaprogramming-.2F-tactics/topic/See.20raw.20value.20of.20a.20Expr.20variable/near/527896242\">#metaprogramming / tactics &gt; See raw value of a Expr variable @ üí¨</a> </p>\n<p>Discovered this one error, it is because of the <code>q(sorry)</code></p>",
        "id": 527899548,
        "sender_full_name": "Francisco Lima",
        "timestamp": 1752070657
    },
    {
        "content": "<p>Got it, no need</p>",
        "id": 527906503,
        "sender_full_name": "Francisco Lima",
        "timestamp": 1752072705
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"936530\">Francisco Lima</span> has marked this topic as resolved.</p>",
        "id": 527906572,
        "sender_full_name": "Notification Bot",
        "timestamp": 1752072721
    },
    {
        "content": "<p>Are there any good learning resource on QQ? <span class=\"user-mention\" data-user-id=\"936530\">@Francisco Lima</span>  I am struggling trying to use it to refactor a tactic I wrote. And I don't understand in which case I should use QQ or why it is not part of the language?</p>",
        "id": 528141339,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1752173276
    }
]