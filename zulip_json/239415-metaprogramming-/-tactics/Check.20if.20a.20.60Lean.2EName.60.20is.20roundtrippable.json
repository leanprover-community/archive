[
    {
        "content": "<p>How do I check if a <code>Lean.Name</code> is roundtrippable?</p>",
        "id": 565735560,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767058325
    },
    {
        "content": "<p>meaning, if I convert it into a <code>String</code> and parse the result it should give me the same name</p>",
        "id": 565735610,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767058434
    },
    {
        "content": "<p>I'm pretty sure <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Name.toString#doc\">docs#Lean.Name.toString</a> does this anyway, when <code>escape := true</code> (the default)</p>",
        "id": 565735761,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767058648
    },
    {
        "content": "<p>Ah, wait, I see the caveat...</p>",
        "id": 565735777,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767058672
    },
    {
        "content": "<p>how am I supposed to interpret the result</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- \"example\"</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"ss\">`example</span>\n</code></pre></div>\n<p>(this one doesn't roundtrip because <code>example</code> is a token)</p>",
        "id": 565735802,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767058718
    },
    {
        "content": "<p>Ah, I see...looking into the code it seems like there's an <code>isToken</code> function passed into helper functions which controls escaping of tokens, which is false by default. Presumably this could be changed... <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span> Do you have control over the stringification, or do you just need to evaluate if <code>toString</code> roundtrips?</p>",
        "id": 565736081,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767059154
    },
    {
        "content": "<p>it's whatever <code>Lean.PrettyPrinter.ppCategory</code> does</p>",
        "id": 565736289,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767059459
    },
    {
        "content": "<p>It seems to me <code>ppCategory</code> successfully escapes tokens in names by experiment—I also found <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Formatter.identNoAntiquot.formatter#doc\">docs#Lean.PrettyPrinter.Formatter.identNoAntiquot.formatter</a>, which seems to avoid all tokens via the <code>isToken</code> argument, so maybe that's what's responsible</p>",
        "id": 565736438,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767059716
    },
    {
        "content": "<p>e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"sd\">/-- info: «example» -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">ppCategory</span><span class=\"w\"> </span><span class=\"ss\">`ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">    </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"bp\">.</span><span class=\"n\">toRawSubstring</span><span class=\"w\"> </span><span class=\"ss\">`example</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n</code></pre></div>",
        "id": 565736462,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767059766
    },
    {
        "content": "<p>It of course doesn't know how to handle <code>num</code> components, though...</p>",
        "id": 565736501,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767059869
    },
    {
        "content": "<p>yeah so I need to know whether it will roundtrip</p>",
        "id": 565736514,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767059897
    },
    {
        "content": "<p>You could of course just try roundtripping it and seeing if you get a parse error and, if not, if it matches <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>\n<p>But assuming you want something better, my guess would be that if the name</p>\n<ul>\n<li>has no numeric components</li>\n<li>has no string components which contain <code>«</code> or <code>»</code></li>\n<li>is not anonymous</li>\n</ul>\n<p>it'll roundtrip. Just a hunch, though.</p>",
        "id": 565736884,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767060144
    },
    {
        "content": "<p>Hmm, actually, nevermind; you can stick all sorts of things in a string component that won't parse. We should just look at what can parse as an ident...</p>",
        "id": 565736957,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767060249
    },
    {
        "content": "<p>This might work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">willRoundTrip</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">!</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">isAnonymous</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">escapePart</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 565737634,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767061193
    },
    {
        "content": "<p>It seems like <code>escapePart</code> might be the \"right\" bit of infrastructure around <code>toString</code> to rip out here...it looooks like it ultimately recreates the important bits of identifier parsing to determine whether escape is possible.</p>\n<p>It does do a bit of extra work constructing the escaped string, but every component declaration is private; so if you need every bit of performance you could ofc rip out the internals and just do the checking.</p>",
        "id": 565737932,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767061601
    },
    {
        "content": "<p>this is probably good enough</p>",
        "id": 565737942,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767061620
    },
    {
        "content": "<p>there is the little edge case where the name <code>_</code> doesn't work properly since it's expecting a <code>binderIdent</code></p>",
        "id": 565737974,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767061651
    },
    {
        "content": "<p>and also the thing where when I put newlines in my name it inserts an indentation in the middle of the name which fills it with many spaces</p>",
        "id": 565738005,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767061711
    },
    {
        "content": "<p>but this is probably good enough</p>",
        "id": 565738007,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767061716
    },
    {
        "content": "<p>Ah, right, because prettyprinting messes with whitespace, on that second point...I wonder if it messes with anything else?</p>",
        "id": 565738079,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767061791
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/Check.20if.20a.20.60Lean.2EName.60.20is.20roundtrippable/near/565737974\">said</a>:</p>\n<blockquote>\n<p>there is the little edge case where the name <code>_</code> doesn't work properly since it's expecting a <code>binderIdent</code></p>\n</blockquote>\n<p>Also, hmm, maybe <code>escapePart</code> is generally inappropriate for the first component of the ident</p>",
        "id": 565738199,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767061940
    },
    {
        "content": "<p>Looks like <code>?</code> and <code>?_</code>, <code>?e</code>, etc. are also edge cases...</p>",
        "id": 565738559,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767062412
    },
    {
        "content": "<p>maybe I shouldn't implement this checking and just blame the pretty printer instead</p>",
        "id": 565738615,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767062497
    },
    {
        "content": "<p>Okay, it looks like the pretty printer uses this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">toStringWithToken</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">escape</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isToken</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- never escape \"prettified\" inaccessible names or macro scopes or pseudo-syntax introduced by the delaborator</span>\n<span class=\"w\">  </span><span class=\"n\">toStringWithSep</span><span class=\"w\"> </span><span class=\"s2\">\".\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">escape</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">isInaccessibleUserName</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">hasMacroScopes</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">maybePseudoSyntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">isToken</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">maybePseudoSyntax</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">`_</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- output hole as is</span>\n<span class=\"w\">      </span><span class=\"n\">true</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getRoot</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- could be pseudo-syntax for loose bvar or universe mvar, output as is</span>\n<span class=\"w\">      </span><span class=\"s2\">\"#\"</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"s2\">\"?\"</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">false</span>\n</code></pre></div>\n<p>which means that whenever <code>escape &amp;&amp; !n.isInaccessibleUserName &amp;&amp; !n.hasMacroScopes &amp;&amp; !maybePseudoSyntax</code> is false, we don't escape, even though we \"should\". Edge case: <code>isInaccessibleUserName</code> is also <code>true</code> for names containing <code>_inaccessible</code>, which actually does not need to be escaped, it seems?</p>\n<p>Putting all that together, I thiiiink:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">willRoundTrip</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">!</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">isAnonymous</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">hasMacroScopes</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">maybePseudoSyntax</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">!</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">'✝'</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">'\\</span><span class=\"n\">n'</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">escapePart</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span>\n<span class=\"w\">        </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">maybePseudoSyntax</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">`_</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- output hole as is</span>\n<span class=\"w\">      </span><span class=\"n\">true</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getRoot</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- could be pseudo-syntax for loose bvar or universe mvar, output as is</span>\n<span class=\"w\">      </span><span class=\"s2\">\"#\"</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"s2\">\"?\"</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">false</span>\n</code></pre></div>",
        "id": 565739701,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767063825
    },
    {
        "content": "<p>now I'm confused</p>",
        "id": 565739865,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767064054
    },
    {
        "content": "<p>What's up? It's possible I did something silly.</p>",
        "id": 565740036,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767064295
    },
    {
        "content": "<p>where did all these checks come from</p>",
        "id": 565740046,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767064311
    },
    {
        "content": "<p>why are we checking for <code>'✝'</code> and <code>'\\n'</code></p>",
        "id": 565740078,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767064339
    },
    {
        "content": "<p>I'm copying over \"exceptions\" made by the pretty printer in <code>toStringWithToken</code> (to make sure we <em>don't</em> count them as exceptions); <code>'✝'</code> is a better <code>isInaccessibleUserName</code>, because <code>isInaccessibleUserName</code> goes too far and considers <code>_inaccessible</code> to be inaccessible; <code>'\\n'</code> is actually the only one that doesn't come from <code>toStringWithToken</code>, and is meant to handle the newline edge case you described</p>",
        "id": 565740135,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767064429
    },
    {
        "content": "<p>ah I see</p>",
        "id": 565740209,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767064530
    },
    {
        "content": "<p>So, for example, while the pretty printer goes ahead and pretty-prints <code>Name.str .anonymous \"?u\"</code> as <code>?u</code> (because it satisfies <code>maybePseudoSyntax</code>), we want to identify that therefore this will not round trip via pretty printing</p>",
        "id": 565740213,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767064532
    },
    {
        "content": "<p>is <code>(Name.escapePart s).isSome</code> just the same as <code>s.isEmpty || !s.any Lean.isIdEndEscape</code></p>",
        "id": 565741019,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767065660
    },
    {
        "content": "<p>I guess I'll just plug this in</p>",
        "id": 565744572,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767069480
    },
    {
        "content": "<p>No, I think there's also the <code>needsNoEscape</code> condition in <code>escapePart</code>'s source, right? Which handles whether it starts correctly (I think, haven't checked)</p>",
        "id": 565744605,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767069525
    },
    {
        "content": "<p>I think if the name contains <code>»</code> then <code>needsNoEscape</code> is always false</p>",
        "id": 565744716,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767069627
    },
    {
        "content": "<p>But doesn't it also e.g. check that the name doesn't include something like a greek letter?</p>",
        "id": 565744867,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767069762
    },
    {
        "content": "<p>names can contain greek letters</p>",
        "id": 565744880,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1767069782
    },
    {
        "content": "<p>Ah, right, which matters if we want to escape it, but not if it'll roundtrip</p>",
        "id": 565744929,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767069842
    }
]