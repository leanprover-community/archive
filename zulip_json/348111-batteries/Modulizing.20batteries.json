[
    {
        "content": "<p>As an early heads-up, I would soon like to start with porting batteries to the module system (I am open to help of course but also prepared to do it myself). The PR would target nightly-testing until at least the next RC cycle. Any concerns or other comments?</p>",
        "id": 530583381,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1753369060
    },
    {
        "content": "<p>I was just about to create an issue about doing just that! Let me know how I can help!</p>",
        "id": 530599740,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1753373915
    },
    {
        "content": "<p>I created a stub issue at <a href=\"https://github.com/leanprover-community/batteries/pull/1345\">batteries#1345</a></p>",
        "id": 530617442,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1753379688
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>, are you planning on making <code>module</code> allowed in nightlies for this release cycle? On Batteries' <code>nightly-testing</code> branch I still get \"<code>module</code> keyword is experimental and not enabled here\".</p>\n<p>(Noting that the next release is delayed by two weeks as we move to the mid-month release schedule.)</p>",
        "id": 531956589,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753922312
    },
    {
        "content": "<p>Yes, that could be in scope for the next cycle. But also projects we're actively supporting in the move shouldn't shy away from putting <code>experimental.module=true</code> in their lakefiles</p>",
        "id": 532002524,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1753947640
    },
    {
        "content": "<p>Ahha! I didn't know about that option. I'm in that class of users who needs every warning controllable by an option to mention the option!</p>",
        "id": 532037596,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753957968
    },
    {
        "content": "<p>I started looking at using <code>module</code>, in <a href=\"https://github.com/leanprover-community/batteries/pull/1362\">batteries#1362</a> (note this is a PR to nightly-testing).</p>\n<p>I've run into a \"Not a definitional equality\" <a href=\"https://github.com/leanprover-community/batteries/actions/runs/16647080714/job/47110225189?pr=1362#step:3:201\">error</a> that I don't know how to resolve.</p>",
        "id": 532043097,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753959701
    },
    {
        "content": "<p>Either <code>ofBits</code> needs to be exposed or the simp theorem should be changed to hold only propositionally, via <code>:= (rfl)</code>. Perhaps the latter given the definition is not that trivial?</p>",
        "id": 532046541,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1753960847
    },
    {
        "content": "<p>I was planning to write automation for at the very least adapting module headers, though questions like this will likely need be left to humans :)</p>",
        "id": 532046760,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1753960917
    },
    {
        "content": "<p><code>:= (rfl)</code> gives a type mismatch error instead.</p>",
        "id": 532049447,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753961762
    },
    {
        "content": "<p>(and <code>@[expose]</code> doesn't help)</p>",
        "id": 532049561,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753961791
    },
    {
        "content": "<p>Ah, <code>Fin.foldr</code> is not exposed either. <code>simp [ofBits]</code> does the trick.</p>",
        "id": 532049824,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1753961876
    },
    {
        "content": "<p>Okay. Say I now want to pause on my module-izing adventure, and PR this to Batteries as is.</p>\n<p>Batteries/Data/Int.lean fails because it can't see Nat.ofBits_lt_two_pow from Batteries/Data/Nat/Lemmas.lean.</p>\n<p>Without adding any more <code>module</code> keywords, how do I finish?</p>",
        "id": 532188964,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754005816
    },
    {
        "content": "<p>I think you have to <code>import all</code> when a non-module wants to see a module's guts</p>",
        "id": 532202420,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754012632
    },
    {
        "content": "<p>But I can't use <code>import all</code> in a non-module.</p>",
        "id": 532203274,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754013080
    },
    {
        "content": "<p>hm... actually I recall non-modules acting as though they <code>import all</code>'d all of their imports? Is this function supposed to be public?</p>",
        "id": 532203532,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013222
    },
    {
        "content": "<p>I assume <code>Batteries.Data.Int</code> in this scenario is a non-module importing private lemma <code>Nat.ofBits_lt_two_pow</code> from module <code>Batteries.Data.Nat.Lemmas</code></p>",
        "id": 532203613,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013270
    },
    {
        "content": "<p>I reread the reference manual and I can't find much of a description of non-modules at all</p>",
        "id": 532204122,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013507
    },
    {
        "content": "<p>I think <code>Nat.ofBits_lt_two_pow</code> should be public to begin with</p>",
        "id": 532204270,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013598
    },
    {
        "content": "<p>in fact almost all lemmas in Batteries should be public</p>",
        "id": 532204294,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013609
    },
    {
        "content": "<p>I think you should use <code>public section</code> in the default preamble of every module in Batteries other than meta stuff</p>",
        "id": 532204725,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013812
    },
    {
        "content": "<p>likewise in mathlib</p>",
        "id": 532204742,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013820
    },
    {
        "content": "<p>the problem here is that you marked the module as a module but didn't do anything else, so everything in it is private</p>",
        "id": 532204811,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013862
    },
    {
        "content": "<p>using <code>public section</code> means that definition signatures and theorems will be public by default, which is the right default for batteries and mathlib. Definitions will still have private bodies, so we will either need to use <code>@[expose] public section</code> or put <code>@[expose]</code> on every definition. I think we should experiment a bit there to decide which is a better default</p>",
        "id": 532205052,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754013972
    },
    {
        "content": "<p>Okay, but adding <code>public section</code> at the top of Batteries/Data/Nat/Lemmas.lean causes errors everywhere... :-(</p>",
        "id": 532205160,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754014031
    },
    {
        "content": "<p>like what?</p>",
        "id": 532205339,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754014142
    },
    {
        "content": "<p>you might need <code>public import</code> in the imports of <code>Batteries.Data.Nat.Lemmas</code></p>",
        "id": 532205455,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754014205
    },
    {
        "content": "<p>Hopefully you shouldn't need <code>import all</code> unless the upstream module was poorly annotated or there is genuine coupling of modules</p>",
        "id": 532205740,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754014346
    },
    {
        "content": "<p>One thing which I'm wondering about is whether here</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Before we started introducing the module system in Batteries, this was a `rfl` lemma.</span>\n<span class=\"c1\">-- There is probably little downside to it no longer being a `rfl` lemma,</span>\n<span class=\"c1\">-- but if anyone wants to restore it we will need to add @[expose] to `Fin.foldr`.</span>\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ofBits_zero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ofBits</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ofBits</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>it is actually the case that we can't add <code>@[expose]</code> post facto to <code>Fin.foldr</code>, given that <code>import all</code> would do basically that</p>",
        "id": 532205853,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754014415
    },
    {
        "content": "<p><code>import all</code> affects only the current module, a post-hoc expose would have to affect all downstream modules</p>",
        "id": 532228670,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754026840
    },
    {
        "content": "<p><code>public import all</code> impacts all downstream modules though</p>",
        "id": 532372521,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754079243
    },
    {
        "content": "<p>It does not:</p>\n<blockquote>\n<p><code>public import all M</code> behaves like <code>public import M</code> followed by <code>import all M</code>, i.e. the <code>all</code> modifier becomes irrelevant for downstream modules.</p>\n</blockquote>\n<p>I will remove that shorthand, it is too confusing</p>",
        "id": 532439450,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754129647
    },
    {
        "content": "<p>If anyone wants to checkout <a href=\"https://github.com/leanprover-community/batteries/pull/1362\">batteries#1362</a> and try to fix it that would be great. I don't understand the errors after adding <code>public section</code> at the top of <code>Batteries/Data/Nat/Lemmas.lean</code>, and don't know another way to proceed.</p>",
        "id": 532536117,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754211808
    },
    {
        "content": "<p>You are trying to use <code>Nat.recAuxOn</code> in a public theorem type but it has not been imported publicly. You should always start porting by bumping existing <code>import</code>s to <code>public import</code>, which is what the scrappy version of the automation that I've been using and want to rewrite does</p>",
        "id": 532537623,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754213054
    },
    {
        "content": "<p>Okay. </p>\n<p>In <code>Batteries/Data/Nat/Lemmas.lean</code> I've changed <code>import all Batteries.Data.Nat.Basic</code> to <code>public import all Batteries.Data.Nat.Basic</code>, and I've added a lot of <code>@[expose]</code> statements in <code>Batteries.Data.Nat.Basic</code>, and Batteries compiles now.</p>",
        "id": 532546533,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754220228
    },
    {
        "content": "<p>I really only want the <code>@[expose]</code> statements to last until <code>Batteries.Data.Nat.Lemmas</code>: one might hope that the theorems proved there are then sufficient for downstream users. Or do we have to re-arrange things to put theorems in the same file as the definition to achieve this?</p>\n<p>In this case it wouldn't be bad, but I fear we do have places where the characterising theorems for a definition really do belong in a separate file.</p>",
        "id": 532546644,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754220311
    },
    {
        "content": "<p>You can elide the <code>[expose]</code>s then and leave it to <code>import all</code> but some definitional equalities will not hold publicly anymore, so you will need to change their proofs to <code>(rfl)</code> if you think it is okay to break them.</p>",
        "id": 532546935,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754220516
    },
    {
        "content": "<p>The last part would be a change that would affect all downstream users, not just <code>module</code>s</p>",
        "id": 532547001,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754220576
    },
    {
        "content": "<p>Any Batteries contributors want to chime in here? My inclination is to break all the definitional equalities and see if anything goes wrong. :-)</p>",
        "id": 532547969,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754221319
    },
    {
        "content": "<p>For the aux recursors, hiding their bodies is probably not worth it - the bodies are barely more complex than their types and very unlikely to change. And their defeqs may certainly be helpful.</p>",
        "id": 532548404,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754221665
    },
    {
        "content": "<p>It's more for definitions like <code>ofBits</code> where some actual complexity and implementation detail can be hidden</p>",
        "id": 532548487,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754221736
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>, what about the common pattern of \"defs in <code>Defs</code>, characterizing lemmas which need the bodies in <code>Lemmas</code>, but afterwards the bodies are not needed\"? Can I do this?</p>",
        "id": 532610859,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754262998
    },
    {
        "content": "<p>I guess I would be happy to proceed for now on <a href=\"https://github.com/leanprover-community/batteries/pull/1362\">batteries#1362</a> (note that at this point it's still a PR to <code>nightly-testing</code>).</p>",
        "id": 532642533,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754281481
    },
    {
        "content": "<p>Also -- <code>shake</code> is going to need to be updated for the module system. We don't actually run <code>shake</code> in Batteries CI yet, so it's not an immediate obstacle.</p>",
        "id": 532642582,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754281510
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/348111-batteries/topic/Modulizing.20batteries/near/532610859\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span>, what about the common pattern of \"defs in <code>Defs</code>, characterizing lemmas which need the bodies in <code>Lemmas</code>, but afterwards the bodies are not needed\"? Can I do this?</p>\n</blockquote>\n<p>Yes, this is exactly what <code>import all</code> is for. You might just need to break some of these public dsimp lemmas in that case.</p>",
        "id": 532657483,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754290088
    },
    {
        "content": "<p>I think I'll roll up my porting automation into a module-aware version of <code>shake</code> since it's already manipulating module headers</p>",
        "id": 532662219,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754292017
    },
    {
        "content": "<p>Shall we proceed with \"feat: begin using the module system\" <a href=\"https://github.com/leanprover-community/batteries/pull/1362\">batteries#1362</a>. If this looks okay we can get the rest of the module headers in soon, and open the way to people exploring <code>module</code> in Mathlib with the next release.</p>",
        "id": 533398448,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754630024
    },
    {
        "content": "<p>LGTM</p>",
        "id": 533425842,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754643775
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Modulizing.20batteries/near/532547969\">said</a>:</p>\n<blockquote>\n<p>Any Batteries contributors want to chime in here? My inclination is to break all the definitional equalities and see if anything goes wrong. :-)</p>\n</blockquote>\n<p>Sorry I missed this part of the thread; as I've said a few times now I think for these functions about which there are characterizing theorems, they should by and large be <code>@[expose]</code>. The only definitions in batteries which actually have steps taken to block their defeqs are <code>Rat.add</code> and friends</p>",
        "id": 533449273,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754653988
    },
    {
        "content": "<p>I don't think there are any definitions in Nat.Basic which should be opaque</p>",
        "id": 533449345,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754654018
    },
    {
        "content": "<p>I might have missed this part, but why do you think definitions with characterizing lemmas should be <code>expose</code>d? One big advantage of the module system is to help building stable APIs, and it is much easier to keep definitions stable propositionally instead of definitionally. Definitions with characterizing lemmas seem like especially good candidates to keep them unexposed because unfolding them can be avoided more often.</p>\n<p>It's possible that there are reasons why things need to be different in Batteries, though -- I might not have enough overview over Batteries. I would be interested in the rationale, though.</p>",
        "id": 533460506,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1754658309
    },
    {
        "content": "<p>I think it needs to be taken case by case, but IME the majority of mathematical definitions are supposed to have an exposed definition</p>",
        "id": 533460649,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754658371
    },
    {
        "content": "<p>It's very rare to have a definition where unfolding is more than \"medium-strong discouraged\"</p>",
        "id": 533461000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754658509
    },
    {
        "content": "<p>I get very worried about potential use cases I'm blocking to say that unfolding should be made <em>impossible</em> for a given definition</p>",
        "id": 533461230,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754658599
    },
    {
        "content": "<p>and proof by <code>rfl</code> for derived definitions applied to literals is an especially important case</p>",
        "id": 533461390,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754658650
    },
    {
        "content": "<p>The only examples of such definitions that shouldn't be unfolded I can think of are <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=TensorProduct#doc\">docs#TensorProduct</a> and other universal constructions</p>",
        "id": 533461440,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1754658667
    },
    {
        "content": "<p>when a definition is mathematical and also not <code>noncomputable</code>, I think someone will surely request it to be exposed sooner or later</p>",
        "id": 533461588,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754658724
    },
    {
        "content": "<p>Thanks for explaining it to me. Seems that I underestimated the amount of required defeq use in mathematics.</p>",
        "id": 533462500,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1754659050
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221653\">Paul Reichert</span> <a href=\"#narrow/channel/348111-batteries/topic/Modulizing.20batteries/near/533460506\">said</a>:</p>\n<blockquote>\n<p>One big advantage of the module system is to help building stable APIs, and it is much easier to keep definitions stable propositionally instead of definitionally.</p>\n</blockquote>\n<p>Mathlib goes to great lengths to ensure that definitions line up to definitional equality and not just propositional equality, because of diamond issues. It's definitely not the case that we don't care about definitional equality, even though it is used in API boundaries and we tell people not to exploit definitional equality. This is a discouragement and not an iron wall</p>",
        "id": 533462520,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754659056
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/348111-batteries/topic/Modulizing.20batteries/near/533461440\">said</a>:</p>\n<blockquote>\n<p>The only examples of such definitions that shouldn't be unfolded I can think of are <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=TensorProduct#doc\">docs#TensorProduct</a> and other universal constructions</p>\n</blockquote>\n<p>I don't even agree with that, to the extent that I think <code>lift f (tmul x y) = f x y</code> should be a defeq, just like it is for simpler Quotient types.</p>",
        "id": 533588603,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754756920
    }
]