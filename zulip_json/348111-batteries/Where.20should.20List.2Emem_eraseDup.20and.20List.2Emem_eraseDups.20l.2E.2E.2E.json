[
    {
        "content": "<p>I've proven membership lemmas for <code>eraseDup</code> (Batteries) and <code>eraseDups</code> (Lean core), analogous to Mathlib's <code>mem_dedup</code>. The proofs currently depend on Mathlib (<code>LawfulBEq</code>, <code>pwFilter_cons_of_pos/neg</code>).</p>\n<p>See this gist: <a href=\"https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316\">https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316</a></p>\n<p>It is unclear to me where such proofs belong.</p>\n<p>Options:</p>\n<ol>\n<li><strong>Batteries</strong> - since <code>eraseDup</code> is defined there</li>\n<li><strong>Mathlib</strong> - since proofs use Mathlib lemmas</li>\n<li><strong>Lean core</strong> - for <code>mem_eraseDups</code> at least, since <code>eraseDups</code> is in core</li>\n</ol>\n<p>My take:</p>\n<ol>\n<li><strong>Batteries could accept it directly</strong> - If the proof can be rewritten using only Batteries lemmas, it could go into Batteries without creating a Mathlib dependency</li>\n<li><strong>Faster builds</strong> - Batteries-only code compiles much faster than Mathlib-dependent code</li>\n<li><strong>Broader usability</strong> - Projects not using Mathlib could still use these lemmas</li>\n</ol>\n<h3>Good News: Most lemmas ARE in Batteries!</h3>\n<ul>\n<li><span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> <code>pwFilter_cons_of_pos</code> - In [\\leanprover-community\\batteries\\tree\\main\\Batteries\\Data\\List\\Pairwise.lean](vscode-file://vscode-app/c:/Users/nfr/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html)</li>\n<li><span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> <code>pwFilter_cons_of_neg</code> - In [\\leanprover-community\\batteries\\tree\\main\\Batteries\\Data\\List\\Pairwise.lean](vscode-file://vscode-app/c:/Users/nfr/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html)</li>\n<li><span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> <code>pwFilter_subset</code> - In [\\leanprover-community\\batteries\\tree\\main\\Batteries\\Data\\List\\Pairwise.lean](vscode-file://vscode-app/c:/Users/nfr/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-browser/workbench/workbench.html)</li>\n<li><span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> <code>LawfulBEq</code> - In Lean core / Std</li>\n</ul>\n<h3>The Real Mathlib Dependencies:</h3>\n<ol>\n<li>\n<p><strong><code>push_neg</code> tactic</strong> - This is from Mathlib. Used to transform <code>¬∀ y ∈ xs.eraseDup, (a != y) = true</code> into <code>∃ y ∈ xs.eraseDup, ¬(a != y) = true</code></p>\n</li>\n<li>\n<p><strong><code>rcases</code> / <code>obtain</code></strong> - These are Mathlib tactics for pattern matching</p>\n</li>\n<li>\n<p><strong><del><code>bne_iff_ne</code></del></strong> - (<span class=\"user-mention\" data-user-id=\"870257\">@Jakub Nowak</span> pointed that this is in core)</p>\n</li>\n</ol>\n<p>Thoughts?</p>",
        "id": 565087763,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766452484
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/SimpLemmas.html#bne_iff_ne\">bne_iff_ne</a> is in core.</p>",
        "id": 565088219,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766453014
    },
    {
        "content": "<p><code>rcases</code> and <a href=\"https://lean-lang.org/doc/reference/latest/Tactic-Proofs/Tactic-Reference/#obtain\">obtain</a> are also in core.</p>",
        "id": 565089084,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766454147
    },
    {
        "content": "<p>(deleted) used a mathlib lemma</p>",
        "id": 565132298,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1766485809
    },
    {
        "content": "<p>The entire arm using push_neg can be replaced by <code>simp_all [eraseDup, pwFilter_cons_of_neg hball]</code></p>",
        "id": 565133493,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1766486300
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"761203\">Vlad Tsyrklevich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Where.20should.20List.2Emem_eraseDup.20and.20List.2Emem_eraseDups.20live.3F/near/565133493\">said</a>:</p>\n<blockquote>\n<p>The entire arm using push_neg can be replaced by <code>simp_all [eraseDup, pwFilter_cons_of_neg hball]</code></p>\n</blockquote>\n<p>Thanks Vlad!</p>\n<p>I updated the gist so that it only depends on Batteries.<br>\nThere's additional simplification possible that I'm looking into.</p>",
        "id": 565186744,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766508831
    },
    {
        "content": "<p>I have simplified the proofs and separated potential contributions to Batteries and Std in the revised gist:</p>\n<p><a href=\"https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316\">https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316</a></p>\n<p>Are these in a reasonable shape to submit issues &amp; PRs?</p>",
        "id": 565198239,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766514594
    },
    {
        "content": "<p>I'll note that the first one in <code>ToStd_EraseDups.lean</code> can also be proven by:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">mem_eraseDupsBy_loop</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LawfulBEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">eraseDupsBy</span><span class=\"bp\">.</span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fun_induction</span><span class=\"w\"> </span><span class=\"n\">eraseDupsBy</span><span class=\"bp\">.</span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">grind</span>\n</code></pre></div>\n<p><code>grind</code> is seriously powerful!</p>",
        "id": 565216204,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1766526624
    },
    {
        "content": "<p>Wow! Thanks <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> ! The proofs are elegant now.</p>\n<p><a href=\"https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316#file-tostd_erasedups-lean\">https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316#file-tostd_erasedups-lean</a></p>",
        "id": 565225792,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766533781
    },
    {
        "content": "<p>Thanks, everyone, for your helpful suggestions.</p>\n<p>I wrote two RFCs from the much simplified gist.</p>\n<p><a href=\"https://github.com/leanprover/lean4/issues/11786\">https://github.com/leanprover/lean4/issues/11786</a><br>\nThis is about: <a href=\"https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316#file-tostd_erasedups-lean\">https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316#file-tostd_erasedups-lean</a></p>\n<p><a href=\"https://github.com/leanprover-community/batteries/issues/1572\">https://github.com/leanprover-community/batteries/issues/1572</a><br>\nThis is about: <a href=\"https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316#file-tobatteries_erasedup-lean\">https://gist.github.com/NicolasRouquette/3f05e55649926b2ba47d30af3b36c316#file-tobatteries_erasedup-lean</a></p>",
        "id": 565228485,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766536491
    },
    {
        "content": "<p>Do you want to make the PRs?</p>",
        "id": 565270004,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1766573558
    },
    {
        "content": "<p>Ok I’ll prepare PRs</p>",
        "id": 565332076,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766628162
    },
    {
        "content": "<p>Do we have a reason to have both definitions, or one of them should be deprecated?</p>",
        "id": 565341935,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766640888
    },
    {
        "content": "<p>I guess if we were to deprecate one it would be <code>eraseDup</code>? That one has no lemmas about it. Also: <code>as.eraseDup = as.reverse.eraseDups.reverse</code>:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Proof</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDupsBy_append_singleton</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDupsBy</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDupsBy</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDupsBy</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDupsBy</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDupsBy_cons</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDupsBy_append_singleton</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">cons_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eraseDupsBy_cons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">decide_eq_false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">filter_append</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">filter_cons</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">not_eq_eq_eq_not</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">not_true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">filter_nil</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem_cons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">forall_eq_or_imp</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">apply_ite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n<span class=\"n\">decreasing_by</span><span class=\"w\"> </span><span class=\"n\">grind</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">pwFilter_eq_eraseDupsBy</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableRel</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">as</span><span class=\"bp\">.</span><span class=\"n\">pwFilter</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">as</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"bp\">.</span><span class=\"n\">eraseDupsBy</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">reverse_inj</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">reverse_reverse</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">reverse_cons</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eraseDupsBy_append_singleton</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem_reverse</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">not_eq_eq_eq_not</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">not_false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">decide_eq_true_eq</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">split</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">rename_i</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pwFilter_cons_of_pos</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">reverse_cons</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pwFilter_cons_of_neg</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDup_eq_eraseDups</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">as</span><span class=\"bp\">.</span><span class=\"n\">eraseDup</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"bp\">.</span><span class=\"n\">eraseDups</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDup</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">pwFilter_eq_eraseDupsBy</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">eraseDups</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">bne</span><span class=\"o\">]</span>\n</code></pre></div>\n</div></div>",
        "id": 565387830,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1766691831
    },
    {
        "content": "<p>FYI: for this issue: <a href=\"https://github.com/leanprover/lean4/issues/11786\">https://github.com/leanprover/lean4/issues/11786</a><br>\nI submitted a PR: <a href=\"https://github.com/leanprover/lean4/pull/11811\">https://github.com/leanprover/lean4/pull/11811</a></p>\n<p>Unfortunately, I could not use <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> 's concise proof because <code>grind</code> isn't available in the context of <code>src/Init/Data</code> but I managed to work around this (thanks to Claude Sonnet 4.5 &amp; Github Copilot).</p>",
        "id": 565492065,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766815507
    },
    {
        "content": "<p>Although <code>List.eraseDup</code> is not used anywhere in Batteries, cslib, or Mathlib currently, there are several legitimate arguments for keeping it thanks to help from Github Copilot + Claude Opus 4.5:</p>\n<ol>\n<li>\n<p><strong>Different semantics</strong>: <code>eraseDup</code> and <code>eraseDups</code> produce <em>different results</em> — they preserve different occurrences:</p>\n<ul>\n<li><code>eraseDups [1, 0, 2, 2, 1] = [1, 0, 2]</code> (keeps <strong>first</strong> occurrence)</li>\n<li><code>eraseDup [1, 0, 2, 2, 1] = [0, 2, 1]</code> (keeps <strong>last</strong> occurrence)</li>\n</ul>\n<p>These are not interchangeable! Formalizations may specifically require \"last occurrence\" semantics.</p>\n</li>\n<li>\n<p><strong>Proof architecture</strong>: Being defined as <code>pwFilter (· != ·)</code>, <code>eraseDup</code> inherits all <code>pwFilter</code> lemmas for free. Proofs follow natural structural induction without needing loop invariants for accumulators. For example, <code>mem_eraseDup</code> uses <code>pwFilter_cons_of_pos/neg</code> directly, while <code>mem_eraseDups</code> requires reasoning about <code>eraseDupsBy.loop</code>'s accumulator.</p>\n</li>\n<li>\n<p><strong>Composability</strong>: <code>pwFilter</code> is a general-purpose \"maximal pairwise sublist\" combinator. Having <code>eraseDup</code> as a named specialization:</p>\n<ul>\n<li>Makes proofs about deduplication more readable</li>\n<li>Allows leveraging theorems like <code>pairwise_pwFilter</code>, <code>pwFilter_eq_self</code>, <code>pwFilter_idem</code>, <code>forall_mem_pwFilter</code> directly</li>\n<li>Connects to <code>Nodup</code> via <code>Pairwise (≠)</code></li>\n</ul>\n</li>\n<li>\n<p><strong>@Robin Arnez's equivalence theorem</strong> demonstrates the relationship between these implementations, but they serve different purposes — efficiency vs. proof ergonomics.</p>\n</li>\n</ol>\n<p>The fact that it's unused today doesn't mean it won't be useful. Having both functions provides flexibility for formalizations where the choice of which duplicate to keep matters, or where the <code>pwFilter</code>-based proof structure is more natural.</p>",
        "id": 565526569,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766862977
    },
    {
        "content": "<p>FYI: for this issue: <a href=\"https://github.com/leanprover-community/batteries/issues/1572\">https://github.com/leanprover-community/batteries/issues/1572</a><br>\nI submitted a PR: <a href=\"https://github.com/leanprover-community/batteries/pull/1580\">https://github.com/leanprover-community/batteries/pull/1580</a></p>\n<p>It includes <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> 's equivalence theorem and the one from my Gist.</p>",
        "id": 565528483,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766865941
    },
    {
        "content": "<p>Note that both docstrings claim to preserve the first element, so at least, we should fix the wrong one.</p>",
        "id": 565534554,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766875615
    },
    {
        "content": "<p>Also, if we're going to keep both, then we should find better names that tell the users what's the difference.</p>",
        "id": 565534572,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766875655
    },
    {
        "content": "<p>Thanks, <span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span>! I've applied your suggestion and realized my PR was missing <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>'s equivalence theorem. The PR is now updated.</p>",
        "id": 565541170,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766886084
    },
    {
        "content": "<p>Regarding the names, I kept the naming conventions -- these are theorems about list membership &amp; operations.<br>\nInstead, I added a descriptive docstring. Does this adequately address your naming concern <span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span> ?</p>",
        "id": 565541478,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766886592
    },
    {
        "content": "<p>I'm talking about renaming the definitions, not theorems. I think that having two definitions that differ by <code>s</code> at the end is a footgun.</p>",
        "id": 565548488,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766899973
    },
    {
        "content": "<p>But I'm neither a Lean core maintainer, nor a Batteries maintainer. You should ask them.</p>",
        "id": 565548495,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766899989
    },
    {
        "content": "<p>The naming collision between <code>eraseDup</code> (last occurrence) and <code>eraseDups</code> (first occurrence) is indeed problematic. </p>\n<p>How about the following to prevent confusion with Lean's <code>List.eraseDups</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- `eraseDupLast l` removes duplicates from `l` (keeping the last occurrence).</span>\n<span class=\"sd\">Defined as `pwFilter (≠)`.</span>\n\n<span class=\"sd\">    eraseDupLast [1, 0, 2, 2, 1] = [0, 2, 1] -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">eraseDupLast</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pwFilter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">eraseDupLast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"2025-12-28\"</span><span class=\"o\">)</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">eraseDup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eraseDupLast</span>\n</code></pre></div>",
        "id": 565599131,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1766962008
    },
    {
        "content": "<p>I'm moving this discussion from <a class=\"stream\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4\">#mathlib4</a> to <a class=\"stream\" data-stream-id=\"348111\" href=\"/#narrow/channel/348111-batteries\">#batteries</a>.</p>",
        "id": 565599161,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766962084
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Where.20should.20List.2Emem_eraseDup.20and.20List.2Emem_eraseDups.20l.2E.2E.2E\">#mathlib4 &gt; Where should List.mem_eraseDup and List.mem_eraseDups l...</a> by <span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span>.</p>",
        "id": 565599177,
        "sender_full_name": "Notification Bot",
        "timestamp": 1766962131
    },
    {
        "content": "<p>This thread is about modifying Batteries and/or core Lean, not Mathlib, so I think this is a better place for the discussion.</p>",
        "id": 565599773,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766963074
    },
    {
        "content": "<p><code>eraseLastDup</code> seems more grammatical than <code>eraseDupLast</code>. Otherwise, I agree!</p>",
        "id": 565619355,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1766989923
    },
    {
        "content": "<p>For me, <code>eraseLastDup</code> looks like \"erase the last duplicate\", not \"erase all duplicates but the last one\".</p>",
        "id": 565623076,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766992752
    },
    {
        "content": "<p>I'm fully in holiday mayhem, so I won't act on the batteries PR until January. However, my current leaning is to deprecate the Batteries version and just keep the core version. (Reversing lists is relatively cheap, so there is minimal gain in duplication. Note that reversing arrays is not at all as cheap, but that's not relevant.)</p>\n<p>Although both the core PR and batteries PR were very verbose, they failed to mention each other. This is bad since it could lead to the worst outcome: both core and batteries deprecating the functions , each expecting the other to keep it.</p>",
        "id": 565696876,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1767026505
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span> for taking the time to comment on this discussion.</p>\n<p>I updated both PRs to refer to this relocated thread, link the PRs with each other, and comment on the deprecation, if any, of Batteries' <code>List.eraseDup</code> given its low usage compared to Lean's <code>List.eraseDups</code>.</p>",
        "id": 565706513,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1767031749
    },
    {
        "content": "<p>Thanks for the discussion! I'd like to summarize what I see as the two key decisions, and I'd appreciate guidance on how the community typically handles these:</p>\n<p><strong>1) Does it make sense to keep Batteries' <code>eraseDup</code>?</strong></p>\n<p>This function originates from <a href=\"https://github.com/leanprover-community/batteries/blob/9aedf87b447cc655d0dcf803e05b3f8e99e81171/Std/Data/List/Basic.lean#L959-L967\">this commit</a>.</p>\n<p>I shared my thoughts on keeping it <a href=\"#narrow/channel/348111-batteries/topic/Where.20should.20List.2Emem_eraseDup.20and.20List.2Emem_eraseDups.20l.2E.2E.2E/near/565526569\">here</a>, but I'm curious what the usual process is for deciding whether to deprecate vs. keep such functions?</p>\n<p><strong>2) If we do keep it, how should we rename it to avoid the footgun?</strong></p>\n<p>Since the key difference is which duplicate to keep, perhaps names that make this explicit would help? </p>\n<p>For example:</p>\n<ul>\n<li><code>List.eraseDupsKeepLast</code> (current Batteries <code>List.eraseDup</code>)</li>\n<li><code>List.eraseDupsKeepFirst</code> (current Lean <code>List.eraseDups</code>)</li>\n</ul>\n<p>Just a suggestion — happy to hear other ideas!</p>",
        "id": 565841760,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1767136558
    },
    {
        "content": "<p>Actually, it originates from <a href=\"https://github.com/leanprover-community/mathlib3/commit/8f4327ae0c45ed36037beb1449f8285cae1ebe9c\">this commit</a> from 8 years ago at which point it also had <a href=\"https://github.com/leanprover-community/mathlib3/blob/e628a2c6b91335e56890b00a66e9bd420af6322f/data/list/basic.lean#L4060-L4105\">a lot more API</a> including a rather short proof of <code>mem_erase_dup</code>. Then, 6 years ago, core lean 4 independently got a definition of <code>eraseDups</code> in <a href=\"https://github.com/leanprover/lean4/commit/8b0730ef7d3d8f92fbd6767764d833ca8e8414c6\">this commit</a>. After that, the definition of <code>erase_dup</code> got ported to mathlib4 4 years ago in <a href=\"https://github.com/leanprover-community/mathlib4/pull/59\">#59</a> but without porting any lemmas. In February of 2022, <code>erase_dup</code> then got <em>renamed</em> to <code>dedup</code> in <a href=\"https://github.com/leanprover-community/mathlib3/pull/12057\">mathlib3#12057</a> and finally in December of the same year, the definition of <code>dedup</code> with the corresponding lemmas was ported to mathlib4 in <a href=\"https://github.com/leanprover-community/mathlib4/pull/803\">#803</a>. The lemmas about <code>eraseDups</code> actually came a while later in April of this year in <a href=\"https://github.com/leanprover-community/mathlib4/pull/8148\">#8148</a>.<br>\nIn short, the fact that we got <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.eraseDup#doc\">docs#List.eraseDup</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.dedup#doc\">docs#List.dedup</a> is a miscommunication / porting mistake while <code>eraseDups</code> was added independently before any ports to mathlib4 happened.<br>\nSo we should propably properly replace <code>eraseDup</code> with the definition of <code>dedup</code> from mathlib. I'm not exactly sure what to do for <code>eraseDups</code> vs <code>dedup</code> though.</p>",
        "id": 565845236,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767140503
    },
    {
        "content": "<p>Is the difference in order between <code>eraseDups</code> and <code>dedup</code> that important to necessitate having both?</p>",
        "id": 565987530,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1767284470
    },
    {
        "content": "<p>It looks like <span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span> suggests we drop the Batteries version (probably, together with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.dedup#doc\">docs#List.dedup</a>).</p>",
        "id": 565997482,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767297816
    },
    {
        "content": "<p>Yes, but the API should be merged with no loss on all three sides.</p>\n<p>The ball is in core's court now.</p>",
        "id": 566172329,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1767470198
    },
    {
        "content": "<p>We can remove mathlib's definition of <code>Lean.dedup</code> but keep verification API in mathlib, but with <code>dedup</code> replaced with core's <code>Lean.eraseDups</code> (this would require remaking proofs).</p>",
        "id": 566173169,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1767471044
    },
    {
        "content": "<p>We can deprecate the other two definitions and translate the relevant lemmas to use the core def. Then core team can upstream these lemmas on their own schedule. WDYT?</p>",
        "id": 566173183,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767471072
    },
    {
        "content": "<p><del>I can make a RFC in core to enshrine this as a MOU between all three parties to make sure that actions are properly coordinated and have a common goal.</del></p>\n<p>AFAICT there are no uses of Batteries' <code>eraseDup</code> in Mathlib, so I will make a deprecation PR.</p>",
        "id": 566175061,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1767472789
    },
    {
        "content": "<p>There are no visible uses of Batteries' <code>List.eraseDup</code> and there is no associated API, so I just deprecated it.</p>",
        "id": 566192549,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1767494181
    }
]