[
    {
        "content": "<p>We're now in the situation of having both <code>Batteries.HashMap</code> and <code>Std.HashMap</code> (we also have <code>Lean.HashMap</code>, but that is already being dealt with). I'd like to consolidate these, but I need some help.</p>\n<p>There are no longer any uses of <code>Batteries.HashMap</code> in repositories that I visit regularly (outside of deprecated files). (I'm happy to hear about other current uses.)</p>\n<p>I think the steps going forward are:</p>\n<ol>\n<li>Identify currently existing <code>Batteries.HashMap</code> functionality/theorems that could not be implemented on top of <code>Std.HashMap</code>.</li>\n<li>Put these on <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>'s TODO list. :-)</li>\n<li>Verify that any remaining functionality/theorems in <code>Batteries.HashMap</code> could be implemented on top of <code>Std.HashMap</code>.</li>\n<li>Replace <code>Batteries.HashMap</code> with a synonym for <code>Std.HashMap</code>, implementing any remaining functionality/theorems on top, still in Batteries.</li>\n<li>(Optional/later): move that remaining functionality to <code>Std.HashMap</code></li>\n<li>(Optional/later): deprecate <code>Batteries.HashMap</code>.</li>\n</ol>\n<p>Does this seem reasonable? Pinging in particular <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>  to confirm this matches what you had in mind. If not, I'm happy to discuss alternative plans to reduce duplication.</p>\n<p>If this is the right approach, then the current blocker is step 1. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, is this something you would be willing to take on? I can then drive 2. and 3. and perhaps 4. when appropriate.</p>",
        "id": 477103618,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729044647
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/477103618\">said</a>:</p>\n<blockquote>\n<p>We're now in the situation of having both <code>Batteries.HashMap</code> and <code>Std.HashMap</code> (we also have <code>Lean.HashMap</code>, but that is already being dealt with). I'd like to consolidate these, but I need some help.</p>\n<p>There are no longer any uses of <code>Batteries.HashMap</code> in repositories that I visit regularly (outside of deprecated files). (I'm happy to hear about other current uses.)</p>\n<p>I think the steps going forward are:</p>\n<ol>\n<li>Identify currently existing <code>Batteries.HashMap</code> functionality/theorems that could not be implemented on top of <code>Std.HashMap</code>.</li>\n<li>Put these on <span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span>'s TODO list. :-)</li>\n<li>Verify that any remaining functionality/theorems in <code>Batteries.HashMap</code> could be implemented on top of <code>Std.HashMap</code>.</li>\n<li>Replace <code>Batteries.HashMap</code> with a synonym for <code>Std.HashMap</code>, implementing any remaining functionality/theorems on top, still in Batteries.</li>\n<li>(Optional/later): move that remaining functionality to <code>Std.HashMap</code></li>\n<li>(Optional/later): deprecate <code>Batteries.HashMap</code>.</li>\n</ol>\n<p>Does this seem reasonable? Pinging in particular <span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span>  to confirm this matches what you had in mind. If not, I'm happy to discuss alternative plans to reduce duplication.</p>\n<p>If this is the right approach, then the current blocker is step 1. <span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span>, is this something you would be willing to take on? I can then drive 2. and 3. and perhaps 4. when appropriate.</p>\n</blockquote>\n<p>Could I ping on this? I'm happy to do 1. as well, but would like there to be some plan in this direction.</p>",
        "id": 484112063,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732412883
    },
    {
        "content": "<p>With my batteries maintainer hat on I don't see any reason to push this process along, but I agree those are the steps that the FRO needs to do before we can deprecate <code>Batteries.HashMap</code>.</p>",
        "id": 484112891,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732413751
    },
    {
        "content": "<p>About <code>Lean.HashMap</code>, could you please add deprecation tags to functions, not only types? I'm trying to port code written by someone else, and I have to search for the corresponding function every time.</p>",
        "id": 484113660,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1732414677
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484112891\">said</a>:</p>\n<blockquote>\n<p>With my batteries maintainer hat on I don't see any reason to push this process along, but I agree those are the steps that the FRO needs to do before we can deprecate <code>Batteries.HashMap</code>.</p>\n</blockquote>\n<p>It turns out there is nothing missing except for <code>findEntry?</code>, which has a slightly complicated spec: <code>m.findEntry? a</code> returns <code>some (a', b)</code>, for some <code>a' == a</code> already in the HashMap, but this <code>a'</code> may not actually be <code>a</code> if <code>BEq</code> ignores some data.</p>\n<p>If it's okay to just replace this with <code>(a, ·) &lt;$&gt; self[a]?</code>, then otherwise we're good to go, and steps 1-4 are all finished by <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a>.</p>",
        "id": 484115741,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732417050
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484113660\">said</a>:</p>\n<blockquote>\n<p>About <code>Lean.HashMap</code>, could you please add deprecation tags to functions, not only types? I'm trying to port code written by someone else, and I have to search for the corresponding function every time.</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/6192\">lean#6192</a></p>",
        "id": 484116355,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732417697
    },
    {
        "content": "<p>No, <code>findEntry?</code> exists exactly because you might want the element in the map and not the one you have already</p>",
        "id": 484159079,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732461665
    },
    {
        "content": "<p>in particular, it is used as a building block in other functions on sets IIRC (at least, in the RBMap version which has a more complete API)</p>",
        "id": 484159161,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732461729
    },
    {
        "content": "<p>Can we find any usages of <code>Batteries.HashMap.findEntry?</code> or <code>Lean.HashMap.findEntry?</code>? In what I've seen so far, I think it was just copied over from the <code>Lean.HashMap</code> API when it was forked, but isn't actually used.</p>",
        "id": 484178274,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480519
    },
    {
        "content": "<p>(I agree that <code>Batteries.RBMap.findEntry?</code> is a different story.)</p>",
        "id": 484178329,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480562
    },
    {
        "content": "<p>No, it's copied from the RBMap API</p>",
        "id": 484178358,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480567
    },
    {
        "content": "<p>the other thing I want to know is how far along the lemmas are wrt the RBMap API</p>",
        "id": 484178367,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480585
    },
    {
        "content": "<p>You mean for <code>Std.HashMap</code> compared to <code>Batteries.RBMap</code>? Or Markus's new work on ordered maps compared to <code>Batteries.RBMap</code>?</p>",
        "id": 484178387,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480611
    },
    {
        "content": "<p>Is RBMap on the chopping block too? <span aria-label=\"face with diagonal mouth\" class=\"emoji emoji-1fae4\" role=\"img\" title=\"face with diagonal mouth\">:face_with_diagonal_mouth:</span></p>",
        "id": 484178428,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480673
    },
    {
        "content": "<p>If these are supposed to be replacements, then they should have the lemmas too. That was the whole reason we were doing this, I thought</p>",
        "id": 484178500,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480728
    },
    {
        "content": "<p>How far along is that work?</p>",
        "id": 484178504,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480736
    },
    {
        "content": "<p>I got so much flak for not having all the theorems about hashmaps when this was under discussion</p>",
        "id": 484178518,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480759
    },
    {
        "content": "<p>I think the new implementation Markus is working on it not actually an RBMap, it is something else, but I don't recall the details right now. Certainly the intention is that it will have at least as thorough verification API.</p>",
        "id": 484178538,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480783
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260921\">@Markus Himmel</span>, just pinging you on this when you're available.</p>",
        "id": 484178550,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480800
    },
    {
        "content": "<p>But right now I'm talking about hashmaps</p>",
        "id": 484178592,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480804
    },
    {
        "content": "<p>we can deal with the other stuff later</p>",
        "id": 484178605,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480820
    },
    {
        "content": "<p>Oh, then there is quite a bit more verification than there was previously.</p>",
        "id": 484178611,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480827
    },
    {
        "content": "<p>I'm not comparing to what currently exists in batteries master (which is almost nothing), I'm comparing to the RBMap API and also the work that wojciech did on a PR which was never merged</p>",
        "id": 484178641,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480867
    },
    {
        "content": "<p>(Std.HashMap vs Batteries.HashMap)</p>",
        "id": 484178643,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480869
    },
    {
        "content": "<p>Sorry, I thought you said we were talking about HashMaps.</p>",
        "id": 484178655,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480890
    },
    {
        "content": "<p>I am</p>",
        "id": 484178656,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480895
    },
    {
        "content": "<p>there is a bunch of proof work on batteries hashmaps which was deliberately blocked because of the work on Std.HashMap</p>",
        "id": 484178670,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480920
    },
    {
        "content": "<p>I'm happy to go make a comparison, but I think the only code that I can actually compare against is Std.HashMap vs Batteries.RBMap?</p>",
        "id": 484178711,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480926
    },
    {
        "content": "<p>Where is this?</p>",
        "id": 484178716,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732480931
    },
    {
        "content": "<p>Which part? The batteries RBMap API is pretty close to what I would like to see from a complete map verification API</p>",
        "id": 484178739,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732480974
    },
    {
        "content": "<p>Plus there's a copy and paste to hashsets</p>",
        "id": 484178760,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481008
    },
    {
        "content": "<p>That's all to scope out what lemmas we should have, not what lemmas we do have</p>",
        "id": 484178777,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481034
    },
    {
        "content": "<p>Are you talking about <a href=\"https://github.com/leanprover-community/batteries/pull/279\">batteries#279</a>?</p>",
        "id": 484178780,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481037
    },
    {
        "content": "<p>Yes, that's what we do have</p>",
        "id": 484178823,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481052
    },
    {
        "content": "<p>Okay, but there's no point doing a lemma-by-lemma comparison there, because that work never actually reached the point of the user-facing API, right?</p>",
        "id": 484178840,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481077
    },
    {
        "content": "<p>HashMap has never been completed, I want to know if it's complete now</p>",
        "id": 484178871,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481116
    },
    {
        "content": "<p>The <code>toList</code> function is has no verification.</p>",
        "id": 484178877,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481130
    },
    {
        "content": "<p>and if not I want to put pressure until it is</p>",
        "id": 484178878,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481130
    },
    {
        "content": "<p>Otherwise there is a fair bit.</p>",
        "id": 484178881,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481137
    },
    {
        "content": "<p>And someone (again, this will have to wait until Markus arrives) is working on the <code>toList</code> part of the story.</p>",
        "id": 484178892,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481155
    },
    {
        "content": "<p>it is frustrating that <code>proof_wanted</code> never really worked out here, and it seems likely that we're about to lose track entirely of what we even want from this API</p>",
        "id": 484178951,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481207
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/blob/master/src/Std/Data/HashMap/Lemmas.lean\">https://github.com/leanprover/lean4/blob/master/src/Std/Data/HashMap/Lemmas.lean</a></p>",
        "id": 484178954,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481208
    },
    {
        "content": "<p>is the current state of things</p>",
        "id": 484178958,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481214
    },
    {
        "content": "<p>(although note this file comes in four versions, for the dependent and raw versions as well)</p>",
        "id": 484178973,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481233
    },
    {
        "content": "<p>Sometime later today I'll try to go lemma-by-lemma through Batteries.RBMap and Std.HashMap and see how they compare, and create issues if I find something missing.</p>",
        "id": 484179045,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481290
    },
    {
        "content": "<p>is there anything about permutations in this file?</p>",
        "id": 484179085,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481344
    },
    {
        "content": "<p>maybe that's what you mean by <code>toList</code> having no verification</p>",
        "id": 484179106,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481386
    },
    {
        "content": "<p>How do the benchmarks look between the three hashmap implementations?</p>",
        "id": 484179188,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481457
    },
    {
        "content": "<p>Again, I'll wait for Markus, but he benchmarked rather carefully, and from what I remember he was happy with the outcomes.</p>",
        "id": 484179406,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481713
    },
    {
        "content": "<p>Okay --- <a href=\"https://gist.github.com/kim-em/73bc3e4516271244e1a9702a5490189c\">https://gist.github.com/kim-em/73bc3e4516271244e1a9702a5490189c</a> is just the theorem statements from <code>Batteries.Data.RBMap.Lemmas</code>. Am I missing anything else?</p>",
        "id": 484179445,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481762
    },
    {
        "content": "<p>Later I'll go through these and make a comparison.</p>",
        "id": 484179490,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732481776
    },
    {
        "content": "<p>IIRC there is a lot more in the previous section?</p>",
        "id": 484179505,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481805
    },
    {
        "content": "<p>most of the theorems are on <code>RBNode</code></p>",
        "id": 484179512,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481820
    },
    {
        "content": "<p>(Note the use of <code>findEntry?</code> in one of those lemmas. That would be incorrect with the new <code>findEntry?</code>)</p>",
        "id": 484179603,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732481913
    },
    {
        "content": "<p>Sorry, theorems about RBNode are implementation details. I don't want to compare something other than the surface API.</p>",
        "id": 484179698,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482005
    },
    {
        "content": "<p>There are also two notions of membership, namely \"find would succeed\" and \"the entry is in the map\". I think these are called <code>Mem</code> and <code>EMem</code> respectively in RBMap</p>",
        "id": 484179708,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482014
    },
    {
        "content": "<p>No, <code>RBNode</code> is the equivalent of <code>HashSet</code></p>",
        "id": 484179726,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482029
    },
    {
        "content": "<p>but also, the low level API is also important, especially depending on how transparent you expect the internals to be</p>",
        "id": 484179757,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482070
    },
    {
        "content": "<p>Can you point me to specific lemmas you're interested in, that are relevant for a comparison to a hashmap?</p>",
        "id": 484179785,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482114
    },
    {
        "content": "<p>I'm not seeing anything in the RBNode section that seems relevant to the discussion here, sorry.</p>",
        "id": 484179831,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482131
    },
    {
        "content": "<p>I don't see an equivalent for</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mem_toList_insert</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">TransCmp</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">cmp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RBSet</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">cmp</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">v'</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v'</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">v'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">v'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>",
        "id": 484179901,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482238
    },
    {
        "content": "<p><code>Std.HashMap</code> is just so far ahead of <code>Lean.HashMap</code> and <code>Batteries.HashMap</code> (hand-checked IR, benchmarks, simp lemmas for pairwise combinations of lemmas, thorough framework for verifying further operations, including custom tactics to reduce proof obligations to list-based models, etc., etc.). I'm sort of at a loss as to what the obstacle to switching out Batteries.HashMap is.</p>",
        "id": 484179944,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482244
    },
    {
        "content": "<p>Yes --- the <code>HashMap.toList</code> function doesn't have any verification API yet.</p>",
        "id": 484179959,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482276
    },
    {
        "content": "<p>This lemma isn't really about toList, <code>a \\in toList map</code> is how this API says \"exact membership\"</p>",
        "id": 484179981,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482307
    },
    {
        "content": "<p>I guess you could do the same for hashmap but of course that means you will need a lot of lemmas about toList</p>",
        "id": 484180060,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482388
    },
    {
        "content": "<p>\"exact membership\" is an implementation detail that is not meant to be exposed. My understanding is that the verification of <code>toList</code> will be under appropriate <code>Lawful</code> hypotheses. (Again, I'm not involved in verifying <code>toList</code>, I may be wrong here.)</p>",
        "id": 484180095,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482429
    },
    {
        "content": "<p>?? It's externally visible</p>",
        "id": 484180105,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482445
    },
    {
        "content": "<p>It's not at all an implementation detail, it's what the user put into the map</p>",
        "id": 484180115,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482468
    },
    {
        "content": "<p>the precise ordering of <code>toList</code> is an implementation detail, but up to permutation <code>toList</code> on a hashmap is an external API</p>",
        "id": 484180192,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482524
    },
    {
        "content": "<p>hence <code>a \\in toList map</code> matters for hashmaps too</p>",
        "id": 484180205,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482543
    },
    {
        "content": "<p>Yes, and <code>a ∈ map.toList ↔ a ∈ map</code> with appropriate <code>Lawful</code> hypotheses.</p>",
        "id": 484180217,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482568
    },
    {
        "content": "<p>no, that is false</p>",
        "id": 484180228,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482581
    },
    {
        "content": "<p>unless by appropriate Lawful hypotheses you mean that beq is equivalent to eq</p>",
        "id": 484180237,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482601
    },
    {
        "content": "<p>which is too strong of an assumption</p>",
        "id": 484180283,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482609
    },
    {
        "content": "<p>In principle there's no reason why this can't be done. My understanding was that it wasn't useful to do it, but I'm not involved in verifying <code>toList</code>. <span aria-label=\"woman shrugging\" class=\"emoji emoji-1f937-200d-2640\" role=\"img\" title=\"woman shrugging\">:woman_shrugging:</span></p>\n<p>I think we're getting a bit off track --- this is not something that Batteries.HashMap allows doing in any case.</p>",
        "id": 484180346,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482689
    },
    {
        "content": "<p>I'm not sure what you mean, of course you can do it</p>",
        "id": 484180370,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482715
    },
    {
        "content": "<p>and the lemmas Wojciech wrote let you verify that the right things have been replaced or not</p>",
        "id": 484180423,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482741
    },
    {
        "content": "<p>But this is non-existent work, Mario.</p>",
        "id": 484180433,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482760
    },
    {
        "content": "<p>The lemma just isn't there.</p>",
        "id": 484180437,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482766
    },
    {
        "content": "<p>I agreee that one might one it</p>",
        "id": 484180455,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482790
    },
    {
        "content": "<p>so if there's a use case for it, lets make it happen as part of Std.HashMap.toList verification.</p>",
        "id": 484180480,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482823
    },
    {
        "content": "<p>Is it possible to prove such a lemma as a user without breaking the API boundary?</p>",
        "id": 484180524,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482844
    },
    {
        "content": "<p>it's not great to provide a partial API and also get annoyed when people work around it</p>",
        "id": 484180555,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482892
    },
    {
        "content": "<p>if you say the internals are open, then it's possible for people to just do this stuff on their own dime</p>",
        "id": 484180592,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482946
    },
    {
        "content": "<p>but if you seal the internals then you need enough lemmas at the low level so that people won't want to break the boundary</p>",
        "id": 484180653,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732482981
    },
    {
        "content": "<p>Isn't the relevant lemma <code>map.toList.contains a ↔ a ∈ map</code> anyway? I'm a bit confused why you want to mix up BEq and Eq here.</p>",
        "id": 484180658,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732482990
    },
    {
        "content": "<p>The question is essentially \"what happens to the keys (up to <code>Eq</code>) when you insert/find/... in a map, where the <code>BEq</code> relation is a quotient of the type?\"</p>",
        "id": 484180688,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483041
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484179901\">said</a>:</p>\n<blockquote>\n<p>I don't see an equivalent for</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mem_toList_insert</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">TransCmp</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">cmp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RBSet</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">cmp</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">v'</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v'</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">v'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">v'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>\n</blockquote>\n<p>Lemmas like this are how you answer that question</p>",
        "id": 484180705,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483069
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484180524\">said</a>:</p>\n<blockquote>\n<p>Is it possible to prove such a lemma as a user without breaking the API boundary?</p>\n</blockquote>\n<p>I'm pretty sure yes: there's nothing forbidding anyone from following the usual mechanism to provide more lemmas.</p>",
        "id": 484180801,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483153
    },
    {
        "content": "<p>the usual mechanism meaning what exactly?</p>",
        "id": 484180821,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483181
    },
    {
        "content": "<p>There's a long discussion of this at <a href=\"https://github.com/leanprover/lean4/blob/master/src/Std/Data/DHashMap/Internal/Defs.lean\">https://github.com/leanprover/lean4/blob/master/src/Std/Data/DHashMap/Internal/Defs.lean</a></p>",
        "id": 484180826,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483188
    },
    {
        "content": "<p>Sorry, I'd assumed you'd seen that.</p>",
        "id": 484180906,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483243
    },
    {
        "content": "<p>to be clear, you mean PRing to lean</p>",
        "id": 484180931,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483264
    },
    {
        "content": "<p>I don't think so?</p>",
        "id": 484180936,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483275
    },
    {
        "content": "<p>I mean, of course welcome to.</p>",
        "id": 484180938,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483280
    },
    {
        "content": "<p>I think the summary of steps to add a new operation is being written from that perspective?</p>",
        "id": 484180953,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483297
    },
    {
        "content": "<p>Oh, in the sense that it tells you where to put content? Yes. But I don't know of anything reason it can't be done in separate files.</p>",
        "id": 484181021,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483346
    },
    {
        "content": "<p>Lean doesn't complain. :-)</p>",
        "id": 484181026,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483353
    },
    {
        "content": "<p>but FRO members might</p>",
        "id": 484181035,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483365
    },
    {
        "content": "<p>I feel like I've been blamed for using the array API in formalizations of HashMap and UnionFind in the past</p>",
        "id": 484181064,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483407
    },
    {
        "content": "<p>I mean, if it's good work we'd love to have it PR'd to the repository? It would be sad if good work on operations or lemmas for HashMap had to be implemented multiple times.</p>",
        "id": 484181067,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483411
    },
    {
        "content": "<p>I think the next stage for batteries.hashmap should be making it an overlay API for std.hashmap and encouraging lemma contributions there</p>",
        "id": 484181152,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483477
    },
    {
        "content": "<p>Concretely what does that look like relative to <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a>?</p>",
        "id": 484181182,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483520
    },
    {
        "content": "<p>Nothing, that's the first part, and the second part is adding a bunch of <code>proof_wanted</code> for all the things that have come out in this discussion</p>",
        "id": 484181263,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483570
    },
    {
        "content": "<p>I agree that the tutorial on extending that I linked to above would be even better with a \"worked example\" outside of the Lean repo.</p>",
        "id": 484181264,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483573
    },
    {
        "content": "<p>So one can see by example what exactly is needed at each layer.</p>",
        "id": 484181288,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483608
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484181264\">said</a>:</p>\n<blockquote>\n<p>I agree that the tutorial on extending that I linked to above would be even better with a \"worked example\" outside of the Lean repo.</p>\n</blockquote>\n<p>I think linking to a PR that just implements the full procedure for one function might be fine? (Shameless plug: <a href=\"https://github.com/leanprover/lean4/pull/5244/\">https://github.com/leanprover/lean4/pull/5244/</a> though that does it for 4 operations, a more minimal example would truly be just one)</p>",
        "id": 484181407,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1732483707
    },
    {
        "content": "<p>How about we deprecate <code>Batteries.HashMap.findEntry?</code>, to make sure that if there is actually a user of it, they see the warning about the changed behaviour, and then add some proof_wanteds or module docs about the desire to replace it?</p>",
        "id": 484181408,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483710
    },
    {
        "content": "<p>Why not just test the process you are advocating by implementing it instead?</p>",
        "id": 484181433,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483740
    },
    {
        "content": "<p>As I mentioned earlier, it plays a role in some theorem statements too</p>",
        "id": 484181456,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483764
    },
    {
        "content": "<p>the proposed implementation is just wrong</p>",
        "id": 484181474,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483787
    },
    {
        "content": "<p>But it plays a role in theorem statements that haven't to date been written. :-)</p>",
        "id": 484181543,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483812
    },
    {
        "content": "<p>I have wanted from the beginning to have a robust HashMap library in lean. We're closer now, but having one person do all the work is not a scalable solution</p>",
        "id": 484181597,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483876
    },
    {
        "content": "<p>Well, it's not one person: note that PR Henrik linked above is person 2. :-) And there's WIP about <code>toList</code>, but I forget who is working on it.</p>",
        "id": 484181626,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732483919
    },
    {
        "content": "<p>People from TU Dresden.</p>",
        "id": 484181671,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1732483930
    },
    {
        "content": "<p>As soon as this stops being a FRO priority I expect the lemmas to stop there</p>",
        "id": 484181687,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483960
    },
    {
        "content": "<p>and I don't know that there is a good pathway for external contributors to influence that</p>",
        "id": 484181699,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732483982
    },
    {
        "content": "<p>hence why I want Batteries.HashMap to be the receiver for that energy instead</p>",
        "id": 484181714,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484005
    },
    {
        "content": "<p>we <a href=\"https://github.com/leanprover-community/batteries/blob/0dc51ac7947ff6aa2c16bcffb64c46c7149d1276/Batteries/Data/HashMap/Lemmas.lean#L29-L32\">actively discouraged</a> people from getting involved, I would like that to end once we do this</p>",
        "id": 484181798,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484079
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484181798\">said</a>:</p>\n<blockquote>\n<p>we <a href=\"https://github.com/leanprover-community/batteries/blob/0dc51ac7947ff6aa2c16bcffb64c46c7149d1276/Batteries/Data/HashMap/Lemmas.lean#L29-L32\">actively discouraged</a> people from getting involved, I would like that to end once we do this</p>\n</blockquote>\n<p>Sorry, wasn't that just pointing out that the lemma existed already? It's not discouraging people to tell them that the work has already been done.</p>",
        "id": 484181839,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484128
    },
    {
        "content": "<p>that and the complete lack of other <code>proof_wanted</code>s in this file I'm quite sure has been effective in keeping people away from working on hashmaps</p>",
        "id": 484181916,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484172
    },
    {
        "content": "<p>I know it has been effective on me and Wojciech at least</p>",
        "id": 484181932,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484198
    },
    {
        "content": "<p>but, but... \"the complete lack of other <code>proof_wanted</code>s in this file\" is on you, isn't it? Who else would have written them? I'm confused.</p>",
        "id": 484181958,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484229
    },
    {
        "content": "<p>The messaging at me to stop messing with hashmaps has been coming loud and clear for the past few months</p>",
        "id": 484182025,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484285
    },
    {
        "content": "<p>re: Wojciech, I started reviewing their PR, and it then immediately went silent?</p>",
        "id": 484182042,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484304
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484182025\">said</a>:</p>\n<blockquote>\n<p>The messaging at me to stop messing with hashmaps has been coming loud and clear for the past few months</p>\n</blockquote>\n<p>Sure, of course, as soon as we planned to write a replacement we said so.</p>",
        "id": 484182065,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484329
    },
    {
        "content": "<p>right, so now that this work is settled down I want hashmap to be back in business for me and others</p>",
        "id": 484182101,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484374
    },
    {
        "content": "<p>Great! Yes.</p>",
        "id": 484182109,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484385
    },
    {
        "content": "<p>I think it will be great if there are people (including you) who would like to contribute more operations and verification lemmas for <code>Std.HashMap</code>.</p>",
        "id": 484182160,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484407
    },
    {
        "content": "<p>and speaking for myself at least, I don't see any problem with that incubating at least in Batteries.</p>",
        "id": 484182178,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484429
    },
    {
        "content": "<p>I'm not going to write a PR to lean though, I'm going to write PRs for batteries and you can take them to lean</p>",
        "id": 484182188,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484445
    },
    {
        "content": "<p>this is a much less stressful approach for everyone</p>",
        "id": 484182201,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484458
    },
    {
        "content": "<p>and hopefully if there is good work on Std.HashMap in Batteries, then authors will be pleased when/if we ask if we can incorporate it into the Lean repo.</p>",
        "id": 484182213,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484468
    },
    {
        "content": "<p>Great! It sounds like furious agreement all round, then. :-)</p>",
        "id": 484182233,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484487
    },
    {
        "content": "<p>but this does mean that batteries.hashmap isn't going to be deprecated any time soon</p>",
        "id": 484182293,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484525
    },
    {
        "content": "<p>and in fact it might become the default for anyone downstream of batteries</p>",
        "id": 484182308,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484547
    },
    {
        "content": "<p>Why not change the namespace over to Std, though? Batteries (the library) can add code to Std (the namespace).</p>",
        "id": 484182330,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732484579
    },
    {
        "content": "<p>That is a possibility as well</p>",
        "id": 484182343,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484602
    },
    {
        "content": "<p>am I getting your permission to not make a stink about batteries having theorems about std internals?</p>",
        "id": 484182396,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732484650
    },
    {
        "content": "<p>Let's pause until Markus is available, but in principle yes, I think the sounds great:</p>\n<ul>\n<li>We merge <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a> (either as is, or probably better with <code>findEntry?</code> deprecated for now)</li>\n<li>Preferably we subsequently switch over the namespace too.</li>\n<li>You or others are welcome to add operations and lemmas about Std.HashMap in Batteries<ul>\n<li>preferably following the standard approach from <a href=\"https://github.com/leanprover/lean4/blob/master/src/Std/Data/DHashMap/Internal/Defs.lean\">https://github.com/leanprover/lean4/blob/master/src/Std/Data/DHashMap/Internal/Defs.lean</a> (ideally even we organize files in Batteries to match that file structure)</li>\n<li>preferably being sure to maintain parity across the four dependent/raw variants</li>\n</ul>\n</li>\n<li>Said authors understand that the optimal outcome for good/stable code added in this way to Batteries is that it is upstreamed subsequently to the Lean repo, but there's no expectation or obligation that they do it themselves.</li>\n<li>Given that there will also be people contributing HashMap code directly to the Lean repo, I attempt to provide communication in both directions about things I know people are working on.</li>\n</ul>",
        "id": 484183066,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732485371
    },
    {
        "content": "<p>I think if no implementation of <code>findEntry?</code> is available in the new shim, it would be better to replace it with a <code>panic! \"not implemented\"</code> than replace it with an implementation that does something different to what it did before</p>",
        "id": 484184009,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732486267
    },
    {
        "content": "<p>I've replaced <code>findEntry?</code> with a panic in <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a>.</p>",
        "id": 484186091,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732488341
    },
    {
        "content": "<p>I feel like <code>panic!</code> is strictly worse than removing <code>findEntry?</code> (temporarily). In both cases I need to fix my code, but if it's removed I at least get a compiler error, rather than just a warning. Having a function in the library, even a deprecated one, that just straight up panics would be extremely surprising.</p>",
        "id": 484189486,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1732491969
    },
    {
        "content": "<p>I also don't think there is any need to remove the function at all, it's not much more than a copy paste job on <code>find?</code></p>",
        "id": 484189502,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732492002
    },
    {
        "content": "<p>Having a copy-paste job on one function still seems like an improvement over the status quo where the</p>\n<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484189486\">said</a>:</p>\n<blockquote>\n<p>I feel like <code>panic!</code> is strictly worse than removing <code>findEntry?</code> (temporarily). In both cases I need to fix my code, but if it's removed I at least get a compiler error, rather than just a warning. Having a function in the library, even a deprecated one, that just straight up panics would be extremely surprising.</p>\n</blockquote>\n<p>I guess ideally you want want a compiler error saying \"this has been removed, see discussion\" rather than \"this name is missing, good luck working out whether you're missing an import or something else is going on\"</p>",
        "id": 484189611,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732492145
    },
    {
        "content": "<p>it would be nice to have another deprecation-like attribute for post-removal assistance</p>",
        "id": 484189719,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732492284
    },
    {
        "content": "<p>My preference was just to deprecate it and change the behaviour.</p>",
        "id": 484190768,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732493231
    },
    {
        "content": "<p>but why though? The new behavior is clearly worse</p>",
        "id": 484190782,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732493259
    },
    {
        "content": "<p>If someone would like to include an new implementation of <code>findEntry?</code> in <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a>, that would be great: please let me know! If someone would like to write a new implementation <em>after</em> <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a>, that would also be great.</p>",
        "id": 484190824,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732493283
    },
    {
        "content": "<p>I don't see any justification for it other than it's less work given that the correct implementation doesn't exist yet</p>",
        "id": 484190835,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732493286
    },
    {
        "content": "<p>Particularly if it's just a copy paste job?</p>",
        "id": 484190850,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732493306
    },
    {
        "content": "<p>I don't want to drag this out longer for a function that is currently unused. We've got a path, as discussed above, for anyone who needs it to add it, either PRing to the Lean repo or the Batteries repo.</p>",
        "id": 484191009,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732493513
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484189486\">said</a>:</p>\n<blockquote>\n<p>In both cases I need to fix my code, </p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span>, are you using <code>findEntry?</code>? I thought Aesop wasn't using Batteries.HashMap at all anymore.</p>",
        "id": 484191869,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732494438
    },
    {
        "content": "<p>No, I meant \"I\" as in \"a hypothetical downstream user\". Maybe not my clearest formulation. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 484191972,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1732494531
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484181626\">schrieb</a>:</p>\n<blockquote>\n<ol start=\"2\">\n<li>:-) And there's WIP about <code>toList</code>, but I forget who is working on it.</li>\n</ol>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484181671\">schrieb</a>:</p>\n<blockquote>\n<p>People from TU Dresden.</p>\n</blockquote>\n<p>Not sure if other people are working on it, but <span class=\"user-mention\" data-user-id=\"645809\">@Lukas Gerlach</span> and I  are working on <code>ofList</code> not <code>toList</code> and with that on <code>insertMany</code> for Lists.</p>",
        "id": 484220755,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1732517617
    },
    {
        "content": "<p>Regarding <code>findEntry?</code>: a possible compromise might be to use</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">findEntry</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Hashable</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std.HashMap</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m.getKey</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">m.get</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>\n<p>in the shim, which isn't particularly efficient but should have the same behavior as the current implementation in batteries.</p>",
        "id": 484223611,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1732519239
    },
    {
        "content": "<p>Thanks Markus, great to know that is possible. I will put that in, with a note.</p>",
        "id": 484266040,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732531880
    },
    {
        "content": "<p>Okay, I've now restored <code>findEntry?</code> with the original behaviour.</p>",
        "id": 484266699,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732532046
    },
    {
        "content": "<p>I think <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a> is ready for review?</p>",
        "id": 484266726,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732532053
    },
    {
        "content": "<p>(Thanks for the review comments, <span class=\"user-mention\" data-user-id=\"260921\">@Markus Himmel</span>, I've dealt with these now.)</p>",
        "id": 484270929,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732533221
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484182042\">said</a>:</p>\n<blockquote>\n<p>re: Wojciech, I started reviewing their PR, and it then immediately went silent?</p>\n</blockquote>\n<p>Thank you for looking at that (<a href=\"https://github.com/leanprover-community/batteries/pull/279\">batteries#279</a>), and sorry for not getting back to you. The reason I abandoned it is that at that point I was feeling burnt out on specifically the \"building a hashmap API for other people to use\"  front as a previous PR to that end existed for about a year, code-rotted, and never got merged, and I had also heard some rumours about the FRO starting new work on hashmaps. I should have communicated this better. I am personally happy with any solution that provides the necessary API (see below).</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Unifying.20.60Batteries.2EHashMap.60.20and.20.60Std.2EHashMap.60.2E/near/484178840\">said</a>:</p>\n<blockquote>\n<p>Okay, but there's no point doing a lemma-by-lemma comparison there, because that work never actually reached the point of the user-facing API, right?</p>\n</blockquote>\n<p>It has reached the user-facing API, I just never made an honest attempt to upstream it for reasons outlined above. I am using the user-facing lemmas <a href=\"https://github.com/rebryant/cpog/blob/main/VerifiedChecker/ProofChecker/Data/HashMap/Lemmas.lean\">in this verification project</a>. So, for me the ideal new <code>Std.HashMap</code> would provide replacements for everything I use there, at least in the sense that if some fact I use is not directly available in <code>Std.HashMap</code>, it is still trivial to prove given what is there in <code>Std.HashMap</code>. Note that that project assumes <code>LawfulBEq</code>, so subtleties of <code>Eq</code> vs <code>BEq</code> mostly don't apply.</p>",
        "id": 484347644,
        "sender_full_name": "𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒",
        "timestamp": 1732553062
    },
    {
        "content": "<p>I have only looked briefly in this and didn't find everything yet in Std, but this feels wrong to me: <code>theorem ext_findEntry? [LawfulBEq α] (m₁ m₂ : HashMap α β) : (∀ a, m₁.findEntry? a = m₂.findEntry? a) → m₁ = m₂</code>.  The order of elements in the bucket shouldn't matter for <code>findEntry?</code>,  but in order for both maps to be equal the order in every buckets must be the same.</p>",
        "id": 484384267,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1732566513
    },
    {
        "content": "<p>yeah I think it should say <code>m₁ ~ m₂</code></p>",
        "id": 484384405,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732566579
    },
    {
        "content": "<p>this being an equivalence relation exposed by the API with lemmas about how all the operations respect it</p>",
        "id": 484384536,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732566622
    },
    {
        "content": "<p>(Just to be clear for context, this problem with <code>ext_findEntry?</code> is about the project Wojciech linked just above, not about the PR discussed here <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a>.)</p>",
        "id": 484399266,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732573118
    },
    {
        "content": "<p>Oops, that's what I get for leaving a <code>sorry</code>. Thanks for spotting that! It is used to prove <code>insert_comm</code> which is wrong for the same reason.</p>",
        "id": 484403512,
        "sender_full_name": "𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒",
        "timestamp": 1732575017
    },
    {
        "content": "<p>Okay fixed it <a href=\"https://github.com/rebryant/cpog/commit/bfa5aeee15f304053f8557906dd6d2b65d84243e\">here</a>. As far as I can see, a big thing that I need that is not there for <code>Std.HashMap</code> atm are lemmas about <code>fold</code>.</p>",
        "id": 484425869,
        "sender_full_name": "𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒",
        "timestamp": 1732589973
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128280\">@Wojciech Nawrocki</span>, just double checking --- lemmas about fold, which are indeed not written yet for <code>Std.HashMap</code> (they will be presumably just say that <code>fold</code> agrees with <code>toList.fold</code>; i.e. they are part of the the verification lemmas for <code>toList</code>), also don't exist anywhere for <code>Batteries.HashMap</code>, right?</p>",
        "id": 484429388,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732592494
    },
    {
        "content": "<p>they exist in <a href=\"https://github.com/rebryant/cpog/blob/48b06cdfe689fa436837884e92d7fd8e397c3158/VerifiedChecker/ProofChecker/Data/HashMap/Lemmas.lean#L369-L374\">Wojciech's project</a></p>",
        "id": 484483475,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732618047
    },
    {
        "content": "<p>Are we ready to merge <a href=\"https://github.com/leanprover-community/batteries/pull/1063\">batteries#1063</a>?</p>",
        "id": 485001427,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732840165
    },
    {
        "content": "<p>Pinging on this again, <span class=\"user-mention\" data-user-id=\"128280\">@𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒</span>. <code>Std.HashMap</code> now has fairly complete lemmas about the <code>toList</code> function and <code>fold</code>.</p>",
        "id": 506878679,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1742445558
    },
    {
        "content": "<p>Okay, I'm going to interpret that emoji response as \"yes, seen, and acknowledged\", and I'll merge tomorrow. Just let me know if there's further reason to wait!</p>",
        "id": 508408794,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743039046
    },
    {
        "content": "<p>Sorry, I just haven't had the chance to see if the lemmas that are now in Std suffice to reproduce my proofs. At any rate I am not opposed to the unification.</p>",
        "id": 508416377,
        "sender_full_name": "𝚠𝚘𝚓𝚌𝚒𝚎𝚌𝚑 𝚗𝚊𝚠𝚛𝚘𝚌𝚔𝚒",
        "timestamp": 1743043125
    }
]