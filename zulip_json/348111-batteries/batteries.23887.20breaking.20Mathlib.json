[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span>, <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, Mathlib needs adaptations for <a href=\"https://github.com/leanprover-community/batteries/pull/887\">batteries#887</a>. The automatic bump process is reporting failures: <a href=\"#narrow/stream/345428-mathlib-reviewers/topic/Mathlib.20.60lake.20update.60.20failure/near/472580810\">https://leanprover.zulipchat.com/#narrow/stream/345428-mathlib-reviewers/topic/Mathlib.20.60lake.20update.60.20failure/near/472580810</a></p>",
        "id": 472586247,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727219242
    },
    {
        "content": "<p>(Also noting that batteries changes that Mathlib needs adapation for also break Mathlib's <code>nightly-testing</code> branch, and hence delay being able to test Lean PRs against Mathlib.)</p>",
        "id": 472586584,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727219442
    },
    {
        "content": "<p>point me to what to do to avoid messing up your process</p>",
        "id": 472586762,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727219561
    },
    {
        "content": "<p>In some form, we need to have adaptations for Mathlib ready to go.</p>\n<ol>\n<li>We could do this manually: if a maintainer judges that it is likely that a change will break Mathlib, we ask if there is an adaptation ready before merging.</li>\n<li>We could automate this, like Lean automatically tests Batteries and Mathlib. That is, a CI process would continue after normal Batteries CI completes, creating a <code>batteries-pr-testing-NNNN</code> branch of Mathlib and updating the lakefile there to depend on the PR branch of Batteries. Then run normal CI on that branch, and report back via a label <code>breaks-mathlib</code> or <code>builds-mathlib</code> on the Batteries branch.</li>\n<li>Or we could do this reactively -- the notifications are all already in place --- by having enough people watching the <a href=\"#narrow/stream/345428-mathlib-reviewers/topic/Mathlib.20.60lake.20update.60.20failure\">Mathlib update failures</a> topic or the <a href=\"#narrow/stream/428973-nightly-testing/topic/Mathlib.20status.20updates\">Mathlib status updates</a> topic in <a class=\"stream\" data-stream-id=\"428973\" href=\"/#narrow/stream/428973-nightly-testing\">#nightly-testing</a> to notice when Batteries has introduced a Mathlib breakage, and fixing it promptly. (Here \"enough\" just means \"not primarily me\". :-)</li>\n</ol>",
        "id": 472587106,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727219838
    },
    {
        "content": "<p>Ideally, we can do all three. 1. will mostly stop things breaking, and 3. will backstop that when needed. If we can get started (either implementing or asking for help) on 2., that can gradually take the workload off maintainers.</p>",
        "id": 472587554,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220150
    },
    {
        "content": "<p>But I think we need to do at least one!</p>",
        "id": 472587576,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220165
    },
    {
        "content": "<p>is there a way to make this fail in the merge queue?</p>",
        "id": 472587597,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727220195
    },
    {
        "content": "<p>So, variants of 2. would be possible, where rather than just reporting back with labels, we actually fail a CI check (that is either run all the time, or --- as you suggest --- only in the merge queue) if Mathlib doesn't cleanly adapt.</p>",
        "id": 472587688,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220254
    },
    {
        "content": "<p>How does lean core do it? Seems like breaking changes are merged all the time without adaptations ready to go</p>",
        "id": 472587712,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727220281
    },
    {
        "content": "<p>Yes, just judgement about whether testing is needed. If you want downstream testing, then you make sure your PR is based off <code>nightly-with-mathlib</code> (which is a branch tracking the most recent nightly for which we know Mathlib succeeds).</p>",
        "id": 472587756,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220329
    },
    {
        "content": "<p>For this PR, I expect the adaptations to be very simple, since it's just a rename in some namespaces that will be used in a handful of tactics</p>",
        "id": 472587824,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727220365
    },
    {
        "content": "<p>If you don't want downstream testing (either because you're confident it isn't needed, because you know Mathlib is currently badly out of sync (thankfully this is rare recently), or because you know that I'm available to clean up), then you don't base off <code>nightly-with-mathlib</code>, and instead the bot just reports that it isn't going to test Batteries+Mathlib.</p>",
        "id": 472587847,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220394
    },
    {
        "content": "<p>Yes, for this PR option 3. above is perfectly fine. Just I'd like it to happen without me be the sole person to notice it needs to happen. :-)</p>",
        "id": 472587881,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220426
    },
    {
        "content": "<p>(i.e. option 3 is only fine if the \"enough\" clause there holds!)</p>",
        "id": 472587909,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220453
    },
    {
        "content": "<p>Note a virtuous cycle here: the more often Mathlib is compatible with lean's nightlies, the higher expectations Lean PR authors will have that testing against Mathlib will give useful signal, and the more likely they are to do the testing, and thus have adaptations (at either the Mathlib or Lean end!) ready before merging.</p>",
        "id": 472588059,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220563
    },
    {
        "content": "<p>Okay, I am going to go fix this manually now.</p>",
        "id": 472589250,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727221525
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/17117\">#17117</a></p>",
        "id": 472589427,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727221666
    },
    {
        "content": "<p>and cherry-picked onto <code>nightly-testing</code>.</p>",
        "id": 472589633,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727221815
    },
    {
        "content": "<p>Ooops, and my local build found another problem, which I've now deployed in both places.</p>",
        "id": 472589849,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727222006
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> sorry messing up the process and thanks for fixing it. </p>\n<p>I asked earlier about handling downstream breakage (of course not thinking it was in process) so it is good to get some answers and plans to make things smoother (hopefully). </p>\n<p>Is there anyway to get that Zulip message from the bump automation to be more specific about what is being bumped?</p>",
        "id": 472648972,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1727255600
    },
    {
        "content": "<p>I guess we could have the bot link to the diff on the <code>lake-manifest.json</code>?</p>",
        "id": 472792961,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727310736
    },
    {
        "content": "<p>It is usually 75% batteries, 25% aesop, at least recently.</p>",
        "id": 472792982,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727310761
    },
    {
        "content": "<p>Is there a convenient way to trigger 2 on-demand? (The manual process is time consuming and prone to error.)</p>",
        "id": 472801916,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727317795
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span>, option 2. for a Batteries PR doesn't exist at all at the moment. Are you talking about for a Lean PR? What would \"on demand\" look like?</p>",
        "id": 472803417,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727318819
    },
    {
        "content": "<p>Could be triggered by a maintainer or by the author on a case by case basis. For example, if I believe a PR might break Mathlib but I'm not sure how, then I could press the button to create a <code>batteries-pr-testing-NNNN</code> branch to check it out. (But it might be easier to do it for all PRs.)</p>",
        "id": 472805503,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727320333
    },
    {
        "content": "<p>Yeah, seems easier to do it for everything than for some!</p>",
        "id": 472805534,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727320368
    },
    {
        "content": "<p>Agreed, I was mostly wondering if it already existed and I had been missing out.</p>",
        "id": 472805609,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727320428
    },
    {
        "content": "<p>No, this all exists for Lean, but no where else.</p>",
        "id": 472805680,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727320461
    },
    {
        "content": "<p>It would be great to have that for Batteries but I'm not sure about the implementation costs. It doesn't look like an easy task at all even though a working model already exists in Lean.</p>",
        "id": 472805878,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727320617
    },
    {
        "content": "<p>I think would just be a matter of copying <code>.github/workflows/pr-release.yml</code> (from the lean4 repo), dropping everything before line 284, and adapting a bit.</p>",
        "id": 472806396,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727320981
    },
    {
        "content": "<p>We'd also need to update at the mathlib end to report back to Batteries for failures on <code>batteries-pr-testing-NNNN</code> branches.</p>",
        "id": 472806420,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727321000
    },
    {
        "content": "<p>I think it would suffice to just always test Mathlib master, so it's actually a good bit simpler than the Lean case.</p>",
        "id": 472806557,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727321089
    },
    {
        "content": "<p>If someone could sanity check <a href=\"https://github.com/leanprover-community/batteries/pull/958\">batteries#958</a>, that is hopefully most of what is needed.</p>",
        "id": 472807482,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727321688
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/17144\">#17144</a> is the mathlib end of it.</p>",
        "id": 472808820,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727322645
    },
    {
        "content": "<p>Again, sanity check please, and then I'll set up the tokens and we can test in production.</p>",
        "id": 472808852,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727322667
    },
    {
        "content": "<p>That was really fast! LGTM</p>",
        "id": 472824770,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727333233
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/348111-batteries/topic/batteries.23887.20breaking.20Mathlib/near/472808820\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/17144\">#17144</a> is the mathlib end of it.</p>\n</blockquote>\n<p>LGTM</p>",
        "id": 472828001,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1727334630
    },
    {
        "content": "<p>Okay, I will install tokens soon!</p>",
        "id": 472829252,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727335087
    },
    {
        "content": "<p>Hmm, we did it again, and <a href=\"https://github.com/leanprover-community/batteries/pull/956\">batteries#956</a> breaks Mathlib and nightly-testing.</p>",
        "id": 472862829,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727346097
    },
    {
        "content": "<p>:-(</p>",
        "id": 472862853,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727346107
    },
    {
        "content": "<p>Looks like this is just about deleting the lemmas from Mathlib.Data.List.OfFn that were moved to Batteries as well as the obsolete <code>_go</code> lemmas. So I just need to do that directly on nightly-testing. Is there some kind of signal so that we don't step on each other's toes?</p>",
        "id": 472867286,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727347709
    },
    {
        "content": "<p>Got it. I figured out the workflow.</p>",
        "id": 472868164,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727348006
    },
    {
        "content": "<p>Where did <code>length_ofFn</code> go?</p>",
        "id": 472868828,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348245
    },
    {
        "content": "<p>In this case we shouldn't be touching nightly-testing.</p>",
        "id": 472868934,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348279
    },
    {
        "content": "<p>It's getting <code>lake update</code> to work on <code>master</code> that is the problem.</p>",
        "id": 472869000,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348288
    },
    {
        "content": "<p>Fixing that and <code>nightly-testing</code> will come good automatically.</p>",
        "id": 472869022,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348299
    },
    {
        "content": "<p>It's on Batteries now.</p>",
        "id": 472869049,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727348307
    },
    {
        "content": "<p>￼<del>Protected?</del> never mind</p>",
        "id": 472869055,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1727348308
    },
    {
        "content": "<p>Unfortunately the bot that posts about <code>lake update</code> breakages on <code>master</code> is in a private stream that <span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span> doesn't have access to.</p>",
        "id": 472869137,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348338
    },
    {
        "content": "<p>I'll work out how to make that happen.</p>",
        "id": 472869152,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348343
    },
    {
        "content": "<p>Oh, it's just imports that need fixing, in that case.</p>",
        "id": 472869248,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348375
    },
    {
        "content": "<p>We need to import <code>Batteries.Data.List.OfFn</code> at the right place in Mathlib.</p>",
        "id": 472869270,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348386
    },
    {
        "content": "<p>Yes, I'm fixing that now.</p>",
        "id": 472869305,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727348401
    },
    {
        "content": "<p>And I'm getting you access to things. :-)</p>",
        "id": 472869694,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348522
    },
    {
        "content": "<p>Got it. I just push on nightly-testing directly or is there an intermediate step?</p>",
        "id": 472869793,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727348552
    },
    {
        "content": "<p>Ah, as I was saying above, it's better to fix this on <code>master</code></p>",
        "id": 472869837,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348568
    },
    {
        "content": "<p>i.e. a PR in which we <code>lake update</code> and then do this fix.</p>",
        "id": 472869920,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348595
    },
    {
        "content": "<p>hopefully you could just take whatever change you've got and transplant it over</p>",
        "id": 472869941,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348606
    },
    {
        "content": "<p>(If we fix it directly on master, a bot will merge the change to nightly-testing. If we just fix on nightly-testing, master will still need manual updating.)</p>",
        "id": 472870004,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348638
    },
    {
        "content": "<p>(but besides that point yes, you are welcome to push direct to nightly-testing)</p>",
        "id": 472870087,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727348658
    },
    {
        "content": "<p>That makes sense!</p>",
        "id": 472870098,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727348662
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/17159\">#17159</a></p>",
        "id": 472871745,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727349263
    },
    {
        "content": "<p>Don't you also need a change in List.FinRange, since <code>List.getElem_ofFn</code> is protected now?</p>",
        "id": 472871827,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727349298
    },
    {
        "content": "<p>but with that <span aria-label=\"peace sign\" class=\"emoji emoji-270c\" role=\"img\" title=\"peace sign\">:peace_sign:</span> :-)</p>",
        "id": 472871873,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727349312
    },
    {
        "content": "<p>OK. It will take a bit to internalize the workflow but I will definitely be able to help more going forward.</p>",
        "id": 472872733,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727349651
    },
    {
        "content": "<p>Just a heads up that I have installed all the requisite tokens and secrets, and merged <a href=\"https://github.com/leanprover-community/batteries/pull/958\">batteries#958</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/17144\">#17144</a>.</p>",
        "id": 472997208,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727400337
    },
    {
        "content": "<p>In an ideal world, this will result in every PR to Batteries automatically generating a <code>batteries-pr-testing-NNNN</code> branch on Mathlib which uses that PR, and then Mathlib CI reporting back with a label <code>breaks-mathlib</code> or <code>builds-mathlib</code>.</p>",
        "id": 472997271,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727400373
    },
    {
        "content": "<p>In the real world, where we have to test Github CI in production, none of this will work.</p>",
        "id": 472997278,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727400387
    },
    {
        "content": "<p>I don't have time right now to test this, but if no one else has in a few hours time I should be able to later today.</p>",
        "id": 472997292,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727400411
    },
    {
        "content": "<p>A fair number of fixes later, I think <a href=\"https://github.com/leanprover-community/batteries/pull/960\">batteries#960</a> has demonstrated that it basically works!</p>",
        "id": 473088273,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727437398
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/pull/966\">batteries#966</a> was just labeled <code>builds-mathlib</code>!</p>",
        "id": 473107192,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727442720
    },
    {
        "content": "<p>And <a href=\"https://github.com/leanprover-community/batteries/pull/854\">batteries#854</a> was labeled <code>builds-mathlib</code> after an update.</p>",
        "id": 473212501,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727471059
    },
    {
        "content": "<p>It's confirmed that <a href=\"https://github.com/leanprover-community/batteries/pull/960\">batteries#960</a> works as intended in real life!</p>",
        "id": 473212588,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727471102
    },
    {
        "content": "<p>It already caught an unexpected error in <a href=\"https://github.com/leanprover-community/batteries/pull/948\">batteries#948</a>. (Not a major one, just a test that needs an update.)</p>",
        "id": 473214470,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727472101
    },
    {
        "content": "<p>I'd like to mention that this change means <a href=\"https://leanprover-community.github.io/contribute/tags_and_branches.html\">https://leanprover-community.github.io/contribute/tags_and_branches.html</a> may need an update about this feature, since it's not clear with whom the responsibilty for fixing the breaking change lies, and where/how this should be solved. i started a discussion of this in <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/workflow.20for.20fixing.20breaking.20changes.20to.20Batteries\">#mathlib4 &gt; workflow for fixing breaking changes to Batteries</a> , but feel free to move it here if that is more appropriate</p>",
        "id": 473349194,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727531053
    }
]