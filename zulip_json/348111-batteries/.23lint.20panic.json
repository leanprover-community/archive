[
    {
        "content": "<p>Not too important, but the following code causes a panic</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Common</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span><span class=\"w\"> </span><span class=\"c1\">-- expected error</span>\n<span class=\"bp\">#</span><span class=\"n\">lint</span><span class=\"w\"> </span><span class=\"c1\">-- unexpected panic</span>\n</code></pre></div>\n<p>Probably more commands assume that everything in the environment has a valid name (at least, I expect that causes the panic).</p>",
        "id": 476785260,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1728912187
    },
    {
        "content": "<p>Oh, I guess this is technically Batteries, not Mathlib. Let me move this.</p>",
        "id": 476785365,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1728912222
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/.23lint.20panic\">#mathlib4 &gt; #lint panic</a> by <span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span>.</p>",
        "id": 476785419,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728912238
    },
    {
        "content": "<p>The <code>dupNamespace</code> linter has this line</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dup</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"bp\">.</span><span class=\"n\">zip</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"bp\">.</span><span class=\"n\">tail!</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">y</span>\n</code></pre></div>\n<p>that uses <code>tail!</code> and it might be the culprit of the panic.</p>",
        "id": 476786528,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728912474
    },
    {
        "content": "<p>I think this is a bug in the <code>theorem</code> command that it was even able to create a definition called <code>.anonymous</code>?</p>",
        "id": 476788537,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728912943
    },
    {
        "content": "<p>I checked locally and replacing <code>tail!</code> with a more graceful <code>tail?.getD []</code> \"fixes\" the panic.</p>",
        "id": 476789699,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728913206
    },
    {
        "content": "<p>This isn't even an error</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"o\">):</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span><span class=\"o\">))</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">assert!</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span>\n</code></pre></div>",
        "id": 476789717,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728913210
    },
    {
        "content": "<p>this seems... undesirable...</p>",
        "id": 476789869,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728913249
    },
    {
        "content": "<p>that's a very global definition name</p>",
        "id": 476789917,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728913260
    },
    {
        "content": "<p><code>#check</code> and <code>#print</code> don't seem to like it though</p>",
        "id": 476790207,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728913326
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/348111-batteries/topic/.23lint.20panic/near/476788537\">said</a>:</p>\n<blockquote>\n<p>I think this is a bug in the <code>theorem</code> command that it was even able to create a definition called <code>.anonymous</code>?</p>\n</blockquote>\n<p>I think it is an intended design decision that Lean tries to recover from many errors. This is very useful in case the type of a theorem contains an error. At least the name exists and can still be referred to below. I think it makes some sense to also do this in case there is an error in the theorem name.</p>",
        "id": 476790394,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1728913374
    },
    {
        "content": "<p>It makes sense that lean will recover from many errors, but the low level <code>Environment</code> interface should outright reject an attempt to add a definition with name <code>[anonymous]</code></p>",
        "id": 476790578,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728913418
    },
    {
        "content": "<p>and just do nothing instead</p>",
        "id": 476790627,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728913431
    },
    {
        "content": "<p>That sounds fair.</p>",
        "id": 476790746,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1728913449
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, could you open an issue with your example above? I agree we should fix this.</p>",
        "id": 476871162,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1728953477
    }
]