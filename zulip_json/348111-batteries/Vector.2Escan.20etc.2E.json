[
    {
        "content": "<p>I've been thinking a bit about what it would take to add scan combinators to Vector to bring it to parity with List (and Arrays+Iterators should those PRs be merged). Ideally you'd re-use the Array implementation, however this does present a problem which is that there is no theorem at present about the length of 'scanlM` (because its monadic).</p>\n<p>It seems like there are two-ish options:<br>\n(1) prove a <code>SatisfiesM</code> length theorem for List/Array, and then use <code>MonadSatisfying.satisfying</code> to write the Vector implementation. The upside of this is that its the easiest. The downside here is this means that <code>Vector.scanlM</code> would carry a <code>MonadSatisfying</code> bound.  <br>\n(2) Don't re-use Array, and just reimplement <code>scanlM</code>/<code>scanrM</code> for vector. The downside here is obviously the code duplication (though I guess you could then make the 'Array' implementation be in terms of the 'Vector' one).<br>\n(3) something else? I don't really understand mvcgen, does it do anything magical here?</p>",
        "id": 570455039,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769565697
    },
    {
        "content": "<p>2.</p>",
        "id": 570461071,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769569943
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> ooi why is the preference to re-implement stuff for Vector?</p>",
        "id": 570986186,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1769767495
    },
    {
        "content": "<p>To maintain the API barrier, as it were?</p>",
        "id": 570986243,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1769767509
    },
    {
        "content": "<p>fwiw i did option 2 here:</p>\n<p><a href=\"https://github.com/leanprover-community/batteries/pull/1643\">https://github.com/leanprover-community/batteries/pull/1643</a></p>",
        "id": 571096986,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769797441
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"330967\">@Wrenna Robson</span>, to avoid the <code>MonadSatisfying</code> argument I think?</p>",
        "id": 571097909,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769797793
    },
    {
        "content": "<p>Ah, I am not familiar with that one.</p>",
        "id": 571097977,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1769797814
    },
    {
        "content": "<p>Yeah, <code>MonadSatisfying</code> is a dead end, which we should be deleting rather than using.</p>",
        "id": 571142507,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769816666
    },
    {
        "content": "<p>Beyond that, I think we should consider deprecating <code>SatisfiesM</code> itself / moving it elsewhere, and just direct people to using mvcgen. </p>\n<p>As far as I am aware there are no downstream projects that use <code>SatisfiesM</code>, except for <a href=\"https://github.com/FormalSAT/trestle\">https://github.com/FormalSAT/trestle</a> which only uses it in a file called <code>Trash.lean</code>!</p>\n<p>Within Batteries, there are many theorems with <code>SatisfiesM</code> in their conclusion (so, I think, deprecatable along with the framework), and then three that feel somewhat more useful (but, per above, have never been used):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mapM_mk</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LawfulMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadSatisfying</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h'</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">satisfying</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">size_mapM</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">map_inj_right</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">toArray_inj</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">map_map</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MonadSatisfying</span><span class=\"bp\">.</span><span class=\"n\">val_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toArray_mapM</span><span class=\"o\">]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mapIdxM_mk</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LawfulMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadSatisfying</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapIdxM</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h'</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">satisfying</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">size_mapIdxM</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">map_inj_right</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">toArray_inj</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">map_map</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MonadSatisfying</span><span class=\"bp\">.</span><span class=\"n\">val_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toArray_mapIdxM</span><span class=\"o\">]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mapFinIdxM_mk</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LawfulMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadSatisfying</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapFinIdxM</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h'</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">satisfying</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">size_mapFinIdxM</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">h'</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">map_inj_right</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">toArray_inj</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">map_map</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MonadSatisfying</span><span class=\"bp\">.</span><span class=\"n\">val_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toArray_mapFinIdxM</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 571144081,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769817736
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Vector.2Escan.20etc.2E/near/571144081\">said</a>:</p>\n<blockquote>\n<p>we should consider deprecating <code>SatisfiesM</code> itself / moving it elsewhere, and just direct people to using mvcgen.</p>\n</blockquote>\n<p>As a starting point can we modify the docstring of SatisfiesM to note what the mvcgen analog is?</p>",
        "id": 571147174,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769819545
    },
    {
        "content": "<p>There's no analog, it's a completely different approach to dealing with verification of monadic code.</p>",
        "id": 571147967,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769820159
    },
    {
        "content": "<p>Isnt' the answer that <code>P x -&gt; SatisfiesM Q (f x)</code> is instead spelt <code>Triple P Q f</code> or similar?</p>",
        "id": 571150768,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769822303
    },
    {
        "content": "<p>I'm not really asking about verification (proving), I'm asking about how to even state properties!</p>",
        "id": 571150878,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769822393
    },
    {
        "content": "<p>How difficult would it be to port these theorems to mvcgen? (If such a thing is in fact possible) Even if they aren’t widely used, I  think it might be beneficial to just have more (including simple) examples of how to use mvcgen</p>",
        "id": 571153815,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769825120
    },
    {
        "content": "<p>(I’m speaking somewhat selfishly here)</p>",
        "id": 571154211,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769825555
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"130195\">@Sebastian Graf</span> what do you think of this? I agree it worked be great to have some examples in Batteries.</p>",
        "id": 571163396,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769835342
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"130195\">@Sebastian Graf</span> (apologies, I think you weren't previously subscribed here, so probably didn't see this until now), could you assist with this <code>sorry</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Do</span><span class=\"bp\">.</span><span class=\"n\">Triple</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Classes</span><span class=\"bp\">.</span><span class=\"n\">SatisfiesM</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Do</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Triple</span><span class=\"bp\">.</span><span class=\"n\">of_satisfiesM</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LawfulMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadSatisfying</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">WPMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SatisfiesM</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Triple</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">True</span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⇓</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">⌝</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Get the witness from SatisfiesM</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hx'</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Rewrite x as Subtype.val &lt;$&gt; x'</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">hx'</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Unfold Triple to get the entailment goal</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Triple</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">WPMonad</span><span class=\"bp\">.</span><span class=\"n\">wp_map</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PredTrans</span><span class=\"bp\">.</span><span class=\"n\">map_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- The postcondition (fun a =&gt; ⌜p a.val⌝) is equivalent to (fun _ =&gt; ⌜True⌝)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- because for a : {a // p a}, we have a.property : p a.val</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">heq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"bp\">⌝</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⌜</span><span class=\"n\">True</span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Assertion</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">SPred</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">SPred</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SPred</span><span class=\"bp\">.</span><span class=\"n\">pure_nil</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"n\">ULift</span><span class=\"bp\">.</span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">propext</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">trivial</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">heq</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SPred</span><span class=\"bp\">.</span><span class=\"n\">entails_nil</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SPred</span><span class=\"bp\">.</span><span class=\"n\">pure_nil</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">forall_const</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ⊢ (wp⟦x'⟧ (fun x =&gt; { down := True }, ExceptConds.false)).down</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 571348491,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770008904
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Vector.2Escan.20etc.2E/near/571163396\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"130195\">Sebastian Graf</span> what do you think of this? I agree it worked be great to have some examples in Batteries.</p>\n</blockquote>\n<p>I played around with mvcgen a bit this weekend, and I was able to port some of the SatisfiesM theorems over (specs for mapM, anyM, mapFinIdx, and a few lemmas about them). Would a PR to batteries aiming to port these and the rest of the satisfiesM theorems to mvcgen be of interest?</p>",
        "id": 571351913,
        "sender_full_name": "cmlsharp",
        "timestamp": 1770011734
    },
    {
        "content": "<p>I think so, yes.</p>",
        "id": 571354681,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770013596
    },
    {
        "content": "<p>Note that a lot is already in the lean4 repo, although sometimes still in more general form than I know what to do with.</p>\n<p>As an example, the </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">satisfiesM_foldlM</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LawfulMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">SatisfiesM</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">SatisfiesM</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldlM</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">generalizing</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">SatisfiesM</span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">h₀</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"n\">tl</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foldlM_cons</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">SatisfiesM</span><span class=\"bp\">.</span><span class=\"n\">bind_pre</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">q</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">qh</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">h₀</span><span class=\"w\"> </span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"n\">mem_cons_self</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bh</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"n\">bh</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">bh</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">am</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">bh</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mem_cons_of_mem</span><span class=\"w\"> </span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"n\">am</span><span class=\"o\">))</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">qh</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>in Batteries would be replaced by<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Do.Spec.foldlM_list_const_inv#doc\">docs#Std.Do.Spec.foldlM_list_const_inv</a>, although the Batteries version we have today is really the two step specialization given by:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Triple version of foldlM specification.</span>\n<span class=\"sd\">If each step preserves the motive and doesn't throw, the whole fold preserves the motive</span>\n<span class=\"sd\">and doesn't throw. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foldlM_triple</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">WPMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Triple</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⇓</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"bp\">⌝</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Triple</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldlM</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⇓</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"bp\">⌝</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Spec</span><span class=\"bp\">.</span><span class=\"n\">foldlM_list_const_inv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">⌝</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ExceptConds</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">h₁</span>\n\n<span class=\"sd\">/-- Triple version of foldlM specification with `motive init` as a hypothesis.</span>\n<span class=\"sd\">This gives a trivial `True` precondition in the conclusion. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foldlM_triple'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">WPMonad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Triple</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⇓</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"bp\">⌝</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Triple</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldlM</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">True</span><span class=\"bp\">⌝</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⇓</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⌜</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">b'</span><span class=\"bp\">⌝</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">SPred</span><span class=\"bp\">.</span><span class=\"n\">pure_intro</span><span class=\"w\"> </span><span class=\"n\">h₀</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foldlM_triple</span><span class=\"w\"> </span><span class=\"n\">h₁</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 571354852,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770013706
    },
    {
        "content": "<p>The analogue for <code>SatisfiesM m</code> is <code>Std.Do.WP m .pure</code>, which is used in the definition of <code>Std.Do.Triple</code>. I played around with <code>SatisfiesM</code> last year and IIRC concluded that it is weaker (even too weak) compared to <code>Std.Do.WP</code>. Therefore, I don't think you can prove <code>Triple.of_satisfiesM</code>.</p>\n<p>Furthermore, <code>Std.Do.WP</code> lacks a generic notion of adequacy lemma (i.e., the field of a hypothetical <code>LawfulWP</code>), so there are instance-specific ones for <code>Id</code>, <code>StateM</code>, <code>Except</code>, etc. For example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Do.Id.of_wp_run_eq#doc\">docs#Std.Do.Id.of_wp_run_eq</a>. That's a TODO I keep around for some time now... I'll resolve it once I know how it interacts with <a href=\"https://github.com/leanprover/lean4/blob/c7a9a4e18c2c1defa4261b852f38f6d67f18eb1c/src/Init/Control/MonadAttach.lean#L30\"><code>MonadAttach</code></a> and <a href=\"https://github.com/leanprover/lean4/blob/c7a9a4e18c2c1defa4261b852f38f6d67f18eb1c/src/Init/Control/MonadAttach.lean#L51\"><code>LawfulMonadAttach</code></a> which is yet another way of expressing a variant of <code>SatisfiesM</code>.</p>\n<p>For <code>foldlM</code> specifically, there is the spec <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Do.Spec.foldlM_list_const_inv#doc\">docs#Std.Do.Spec.foldlM_list_const_inv</a>, although <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Do.Spec.foldlM_list#doc\">docs#Std.Do.Spec.foldlM_list</a> is the one that is picked up by <code>mvcgen</code> (which requires the user to state an invariant). It would be great to have similar specs for other functions in batteries. I understand that the spec lemmas involving loop invariants are challenging to understand, though.</p>\n<p>Completely unrelated: I'm still unhappy with the naming convention I picked. Since you are experienced library maintainers, I would love input here: Where would you put the spec <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.Do.Spec.foldlM_list#doc\">docs#Std.Do.Spec.foldlM_list</a> for <code>foldlM</code>? Perhaps <code>List.foldlM.spec</code> is better? Any other ideas? Fortunately it's unlikely that users will refer to these by name very often...</p>",
        "id": 571363375,
        "sender_full_name": "Sebastian Graf",
        "timestamp": 1770017974
    },
    {
        "content": "<p>(I don’t qualify as an advanced library maintainer, but my personal experience is I usually don’t have to go manually hunting for theorems because things in the standard library usually have the names you expect, and my editor’s autocomplete is usually sufficient. The specs for foldlM etc were an exception because they weren’t somewhere in the List (resp. Array) namespace)</p>\n<p>But on the other hand, I was not searching for these to use them by name (as you say, mvcgen itself picked them up for me), however I had to know what specs existed so I knew e.g. to write a mapM spec I should rewrite it in terms of foldlM</p>",
        "id": 571440309,
        "sender_full_name": "cmlsharp",
        "timestamp": 1770041168
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/348111-batteries/topic/Vector.2Escan.20etc.2E/near/571354681\">said</a>:</p>\n<blockquote>\n<p>I think so, yes.</p>\n</blockquote>\n<p>draft PR with my current progress <a href=\"https://github.com/leanprover-community/batteries/pull/1649\">batteries#1649</a></p>",
        "id": 571478144,
        "sender_full_name": "cmlsharp",
        "timestamp": 1770050428
    }
]