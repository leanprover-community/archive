[
    {
        "content": "<p>After <a href=\"https://github.com/leanprover/lean4/pull/10625\">https://github.com/leanprover/lean4/pull/10625</a> (zero cost IO), the implementations of <code>LawfulMonad</code>, <code>LawfulMonadList</code>, and <code>MonadSatisfying</code> for the core monad stack (e.g. <code>IO</code>, <code>CoreM</code>, <code>MetaM</code>) are all broken.</p>\n<p>I have commented these out in 534980065 on the nightly-testing branch.</p>\n<p>Are there consumers of these instances (if so, Henrik says he's horrified :-)?</p>\n<p>Would anyone like to restore these instances? They are still true. Please feel free to make a PR to the nightly-testing branch.</p>\n<p>Otherwise, perhaps we should just delete them?</p>",
        "id": 546784265,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761262635
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/commit/534980065504cbde92405615ff0b7fbc003c81cf\"><code>534980065504cbde92405615ff0b7fbc003c81cf</code></a></p>",
        "id": 546785209,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761263298
    },
    {
        "content": "<p>It sounds like the fix is \"Prove <code>LawfulMonad (EST e)</code>\"</p>",
        "id": 546785281,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761263356
    },
    {
        "content": "<p>Oh, and a test that needs commenting  out in bed425c95.</p>",
        "id": 546786624,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761264297
    },
    {
        "content": "<p>I added the instance back in <a href=\"https://github.com/leanprover-community/batteries/commit/979dcd04\">https://github.com/leanprover-community/batteries/commit/979dcd04</a></p>",
        "id": 546846369,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761296586
    },
    {
        "content": "<p>Probably</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LawfulMonad</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ST</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk'</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">id_map</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">pure_bind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">bind_assoc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LawfulMonad</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">EST</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk'</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">id_map</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">bind</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">pure_bind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">bind_assoc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bind</span><span class=\"bp\">.</span><span class=\"n\">bind</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">EST</span><span class=\"bp\">.</span><span class=\"n\">bind</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>should be upstreamed to avoid needing to import the private details</p>",
        "id": 546846565,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761296647
    },
    {
        "content": "<p>Sorry <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> for pushing a broken commit, 6d70f73c006a12aa83c8866a562f2d8e10d36199 restores the instances _and_ passes <code>lake test</code> :)</p>",
        "id": 546861363,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761301201
    },
    {
        "content": "<p>I haven't attempted the <code>SatisfiesM</code> instances</p>",
        "id": 546861396,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761301211
    }
]