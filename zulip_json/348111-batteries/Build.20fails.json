[
    {
        "content": "<p>I'm trying to build <code>batteries</code> and it always fails at:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Batteries</span><span class=\"bp\">/</span><span class=\"n\">CodeAction</span><span class=\"bp\">/</span><span class=\"n\">Misc</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">317</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"k\">at</span>\n<span class=\"w\">  </span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">'</span>\n<span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Char</span>\n</code></pre></div>\n<p>It's the same for <code>v4.12.0</code> and <code>v4.13.0-rc3</code>. Is this expected?</p>",
        "id": 478920036,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1729863100
    },
    {
        "content": "<p>which version?</p>",
        "id": 478922381,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729863881
    },
    {
        "content": "<p>There is nothing at <a href=\"https://github.com/leanprover-community/batteries/blob/main/Batteries/CodeAction/Misc.lean#L317C8-L317C9\">that position of that file</a> so I am suspicious of the provenance of your installation</p>",
        "id": 478922442,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729863908
    },
    {
        "content": "<p>You should in any case be using the version listed in the lean-toolchain for the version of batteries you're using: <a href=\"https://github.com/leanprover-community/batteries/blob/main/lean-toolchain\">https://github.com/leanprover-community/batteries/blob/main/lean-toolchain</a></p>",
        "id": 478922495,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1729863930
    },
    {
        "content": "<p>Actually there has never in the history of batteries been a token at position <code>317:8</code>, at least while it had the name <code>Batteries/CodeAction/Misc.lean</code></p>",
        "id": 478923176,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729864189
    },
    {
        "content": "<p>There is an occurrence of <code>' '</code> a few lines up so perhaps the signature of <code>String.pushn</code> is wrong?</p>",
        "id": 478923978,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729864461
    },
    {
        "content": "<p>Ahhhh, I think it's because I was incorrectly <code>cat</code>ing that file and didn't notice. Or somewhere along the line the <code>\\n</code> turned into a newline.</p>",
        "id": 478924036,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1729864483
    },
    {
        "content": "<p>wait what? How did <code>cat</code> get involved in the pipeline here</p>",
        "id": 478924108,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729864508
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/348111-batteries/topic/Build.20fails/near/478924108\">said</a>:</p>\n<blockquote>\n<p>wait what? How did <code>cat</code> get involved in the pipeline here</p>\n</blockquote>\n<p>Only because of my personal use case. I just didn't notice that that was still happening.</p>",
        "id": 478924167,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1729864534
    },
    {
        "content": "<p>Oh, you are right, replacing the line with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">indent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"</span>\n<span class=\"s2\">\"</span><span class=\"bp\">.</span><span class=\"n\">pushn</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">findIndentAndIsStart</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">source</span><span class=\"w\"> </span><span class=\"n\">tacPos</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n</code></pre></div>\n<p>causes exactly the error you reported</p>",
        "id": 478924252,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729864562
    },
    {
        "content": "<p>Yeah, sorry for the noise.</p>",
        "id": 478924319,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1729864576
    },
    {
        "content": "<p>This by the way is an exceedingly weird interpretation on lean's part:</p>\n<ul>\n<li>The expression </li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">indent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"</span>\n<span class=\"s2\">\"</span><span class=\"bp\">.</span><span class=\"n\">pushn</span>\n</code></pre></div>\n<p>interprets the literal ... literally, so you end up with <code>let indent := \"\\n\".pushn</code>, which is defining <code>indent</code> to be a partially applied function</p>\n<ul>\n<li>Between the <code>pushn</code> and <code>' '</code> is a space, but it can't be an application because it appears to the left of the <code>let</code>, which was set as the <code>withPosition</code> mark in the enclosing <code>do</code> block</li>\n<li>However, the character literal happens to perfectly line up with the <code>let</code>, so <code>' ' (findIndentAndIsStart doc.meta.text.source tacPos).1</code> is interpreted as the next doElem in the sequence, which fails because <code>' '</code> is not a function</li>\n</ul>",
        "id": 478925159,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729864835
    },
    {
        "content": "<p>this seems like abuse of the offside rule</p>",
        "id": 478925536,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729864938
    },
    {
        "content": "<p>well this is entertaining:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>all the <code>x</code>'s are used exactly once, can you figure out which is which?</p>",
        "id": 478927411,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729865559
    }
]