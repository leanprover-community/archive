[
    {
        "content": "<p>I tried my hand at verifying Batteries.BinaryHeap.  The PR is still a work in progress but the biggest pieces are there (<code>heapifyDown</code>, <code>heapifyUp</code>, and <code>mkHeap</code>). Any comments/suggestions/critiques would be greatly appreciated!</p>\n<p><a href=\"https://github.com/leanprover-community/batteries/pull/1602\">batteries#1602</a></p>",
        "id": 566489021,
        "sender_full_name": "cmlsharp",
        "timestamp": 1767682541
    },
    {
        "content": "<p>Can you update to current <code>main</code>? There are downstream users of BinaryHeap, so we'll have to make sure the API change here is viable for them.</p>",
        "id": 566490777,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1767683747
    },
    {
        "content": "<p>I have synced my branch with the current main</p>",
        "id": 566529131,
        "sender_full_name": "cmlsharp",
        "timestamp": 1767700206
    },
    {
        "content": "<p>As a side note: </p>\n<p>The original API functions were not @[expose]. I temporarily marked the whole public section as @[expose] so I could access the definitions in my lemma module. Is there a way to expose definitions but only to some other internal module and not to external users?</p>",
        "id": 566530945,
        "sender_full_name": "cmlsharp",
        "timestamp": 1767700988
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1006649\">cmlsharp</span> <a href=\"#narrow/channel/348111-batteries/topic/Verifying.20BinaryHeap.20.28PR.20Review.29/near/566530945\">schrieb</a>:</p>\n<blockquote>\n<p>Is there a way to expose definitions but only to some other internal module and not to external users?</p>\n</blockquote>\n<p><code>import all MyModule</code> imports all private declarations and all declaration bodies. For your lemmas you'll probably need both <code>public import Batteries.Data.BinaryHeap.Basic</code> and <code>import all Batteries.Data.BinaryHeap.Basic</code>.</p>",
        "id": 566542932,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767705969
    },
    {
        "content": "<p>And don't forget to put your lemmas into a public section!</p>",
        "id": 566543026,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767706004
    },
    {
        "content": "<p>Thank you for the tip! I'm experiencing a slightly odd issue when I remove the @[expose] annotations from the BinaryHeap functions and instead use 'import all' in my Lemmas module. This mostly works, but it causes a couple lemmas I'm currently using grind for to fail (separately, I need to be using grind less for performance reasons, but I don't understand why this break happens)</p>\n<p>For example.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">BinaryHeap</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">BinaryHeap</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"c1\">-- ...</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">heapifyDown_preserves_prefix</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ord</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">sz</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">sz</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">heapifyDown</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)[</span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">heapifyDown</span><span class=\"bp\">.</span><span class=\"n\">induct</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">heapifyDown</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>'heapifyDown.induct' works fine, and I can <code>unfold heapifyDown</code> so the definition is in scope, however I get the following failure from <code>grind</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">▼</span><span class=\"w\"> </span><span class=\"mi\">237</span><span class=\"o\">:</span><span class=\"mi\">47</span><span class=\"bp\">-</span><span class=\"mi\">237</span><span class=\"o\">:</span><span class=\"mi\">66</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span>\n<span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">pattern</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"ss\">`heapifyDown.match_1.congr_eq_2</span><span class=\"bp\">`</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">BinaryHeap</span><span class=\"bp\">.</span><span class=\"n\">heapifyDown</span><span class=\"bp\">.</span><span class=\"n\">match_1</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"o\">]</span>\n<span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">following</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">parameters</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">instantiated</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">sz</span>\n<span class=\"w\">  </span><span class=\"n\">heq_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">j</span>\n</code></pre></div>\n<p>This is resolved by marking <code>heapifyDown</code> as <code>@[expose]</code> (this is the state of the repo at present)</p>",
        "id": 566558271,
        "sender_full_name": "cmlsharp",
        "timestamp": 1767710838
    },
    {
        "content": "<p>It would be super helpful if you could produce a standalone example of this (i.e. something where you use <code>import all</code> and <code>public import</code>, but <code>grind</code> fails unless you add <code>@[expose]</code> to a definition in the imported file), so we can diganose.</p>",
        "id": 566630602,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1767737923
    },
    {
        "content": "<p>Ok, I will try to come up with a minimal example</p>",
        "id": 566630641,
        "sender_full_name": "cmlsharp",
        "timestamp": 1767737943
    },
    {
        "content": "<p>A message was moved from this topic to <a class=\"stream-topic\" data-stream-id=\"348111\" href=\"/#narrow/channel/348111-batteries/topic/Strange.20.27import.20all.27.20bug/with/567006215\">#batteries &gt; Strange 'import all' bug</a> by <span class=\"user-mention silent\" data-user-id=\"1006649\">cmlsharp</span>.</p>",
        "id": 567006217,
        "sender_full_name": "Notification Bot",
        "timestamp": 1767896660
    },
    {
        "content": "<p>Update: I was able to prove that Array.heapSort is a sorted permutation of the original array. I think modulo the aforementioned bug requiring some definitions (specifically heapifyDown) to be exposed that oughtn't the main set of lemmas one would want to have about a binary heap are there.</p>",
        "id": 569609593,
        "sender_full_name": "cmlsharp",
        "timestamp": 1769125758
    }
]