[
    {
        "content": "<p>In <code>Std.Data.List.Init.Lemmas</code> we <a href=\"https://github.com/leanprover/std4/blob/main/Std/Data/List/Init/Lemmas.lean#L18C1-L18C1\">add</a> the <code>@[simp]</code> attribute to a lot of definitions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">attribute</span> <span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span> <span class=\"n\">get</span> <span class=\"n\">reverseAux</span> <span class=\"n\">eraseIdx</span> <span class=\"n\">map</span> <span class=\"n\">join</span> <span class=\"n\">find</span><span class=\"bp\">?</span> <span class=\"n\">findSome</span><span class=\"bp\">?</span>\n  <span class=\"n\">replace</span> <span class=\"n\">elem</span> <span class=\"n\">lookup</span> <span class=\"n\">drop</span> <span class=\"n\">take</span> <span class=\"n\">foldl</span> <span class=\"n\">foldr</span> <span class=\"n\">zipWith</span> <span class=\"n\">unzip</span> <span class=\"n\">range.loop</span> <span class=\"n\">enumFrom</span>\n  <span class=\"n\">intersperse</span> <span class=\"n\">isPrefixOf</span> <span class=\"n\">isEqv</span> <span class=\"n\">dropLast</span> <span class=\"n\">iota</span> <span class=\"n\">mapM.loop</span> <span class=\"n\">mapA</span> <span class=\"n\">List.forM</span> <span class=\"n\">forA</span> <span class=\"n\">filterAuxM</span>\n  <span class=\"n\">filterMapM.loop</span> <span class=\"n\">List.foldlM</span> <span class=\"n\">firstM</span> <span class=\"n\">anyM</span> <span class=\"n\">allM</span> <span class=\"n\">findM</span><span class=\"bp\">?</span> <span class=\"n\">findSomeM</span><span class=\"bp\">?</span> <span class=\"n\">forIn.loop</span> <span class=\"n\">forIn'.loop</span>\n  <span class=\"n\">concat_eq_append</span> <span class=\"n\">append_assoc</span>\n</code></pre></div>\n<p>Is this really a good idea? I thought that we had decided <em>not</em> to put <code>@[simp]</code> on declarations like these, as it makes for unpredictable unfolding.</p>",
        "id": 390695679,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1694602150
    },
    {
        "content": "<p>The example where I've recently been annoyed by this reduced to:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span> <span class=\"n\">autoImplicit</span> <span class=\"n\">true</span>\n<span class=\"kd\">set_option</span> <span class=\"n\">relaxedAutoImplicit</span> <span class=\"n\">true</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">List.foldl</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">List.zip</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">::</span> <span class=\"n\">as</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">b</span> <span class=\"o\">::</span> <span class=\"n\">bs</span><span class=\"o\">))</span> <span class=\"bp\">=</span> <span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">List.foldl</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">List.zip</span> <span class=\"n\">as</span> <span class=\"n\">bs</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">simp</span> <span class=\"c1\">-- simp made no progress, since we haven't added @[simp] yet</span>\n  <span class=\"gr\">sorry</span>\n\n<span class=\"kn\">attribute</span> <span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span> <span class=\"n\">List.foldl</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">List.foldl</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">List.zip</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">::</span> <span class=\"n\">as</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">b</span> <span class=\"o\">::</span> <span class=\"n\">bs</span><span class=\"o\">))</span> <span class=\"bp\">=</span> <span class=\"n\">f</span> <span class=\"o\">(</span><span class=\"n\">List.foldl</span> <span class=\"n\">f</span> <span class=\"n\">x</span> <span class=\"o\">(</span><span class=\"n\">List.zip</span> <span class=\"n\">as</span> <span class=\"n\">bs</span><span class=\"o\">))</span> <span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">List.foldl</span><span class=\"o\">]</span>\n  <span class=\"c1\">-- Goal is now:</span>\n  <span class=\"c1\">-- ‚ä¢ List.foldl f (f x (a, b)) (List.zipWith Prod.mk as bs) = f (List.foldl f x (List.zip as bs)) (a, b)</span>\n  <span class=\"c1\">-- Note that `List.zip` has been replaced with `List.zipWith Prod.mk`!</span>\n  <span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 390695857,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1694602209
    },
    {
        "content": "<p>It would be some work to undo these attributes, but I think it might be a good idea.</p>",
        "id": 390695909,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1694602229
    },
    {
        "content": "<p>The work in Std is not terrible: <a href=\"https://github.com/leanprover/std4/pull/260\">std4#260</a>. No idea yet how Mathlib copes or otherwise.</p>",
        "id": 390720450,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1694610705
    },
    {
        "content": "<p>The corresponding Mathlib PR is now at <a href=\"https://github.com/leanprover-community/mathlib4/pull/7134\">#7134</a>, but it has a sorry that I would be happy to have help with.</p>",
        "id": 390732281,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1694614167
    },
    {
        "content": "<p>I can have a look</p>",
        "id": 390735436,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1694615016
    },
    {
        "content": "<p>Which sorry do you mean, the one in <code>mapIdx_eq_enum_map</code>?</p>",
        "id": 390735739,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1694615094
    },
    {
        "content": "<p>Awesome, thanks!</p>",
        "id": 390736570,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1694615334
    },
    {
        "content": "<p>Most of them seem to be bad ideas, and have been removed slowly. Specifically, putting <code>@[simp]</code> on a non-recursive function defined by pattern matching has different behavior in lean 3 and lean 4 and the lean 4 behavior is undesirable. Maybe some day this will be fixed, but for now we have to write all the equation lemmas we actually want to be <code>@[simp]</code> here by hand</p>",
        "id": 390782442,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1694630848
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/2042\">lean4#2042</a> is the tracking issue for that behavior change, presumably <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span>ing it if you care is worth something</p>",
        "id": 390790513,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1694634193
    }
]