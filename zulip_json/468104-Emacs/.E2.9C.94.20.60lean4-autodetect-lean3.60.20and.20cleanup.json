[
    {
        "content": "<p>I install <code>lean4-mode</code> using an ad-hoc Nix derivation, and I also use <code>lean-mode</code> from Nixpkgs (yes, I do use Lean 3 every once in a while). My <code>init.el</code> contains:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"bp\">-</span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"o\">(</span><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"o\">(</span><span class=\"n\">setq</span><span class=\"w\"> </span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">autodetect</span><span class=\"bp\">-</span><span class=\"n\">lean3</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Before <a href=\"https://github.com/leanprover-community/lean4-mode/commit/a15876a7058340ef665468b039339e8590baf398\">a15876a7058340ef665468b039339e8590baf398</a>, opening Lean 4 files worked fine. After it, I get errors of the form below, which suggests Lean 3 is being automatically detected. I think adding duplicate entries (<code>push</code> instead of <code>add-to-list</code>) was intentional to support <code>lean4-autodetect-lean3</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Debugger</span><span class=\"w\"> </span><span class=\"n\">entered</span><span class=\"c1\">--Lisp error: (json-readtable-error 47)</span>\n<span class=\"w\">  </span><span class=\"n\">json</span><span class=\"bp\">-</span><span class=\"n\">read</span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">json</span><span class=\"bp\">-</span><span class=\"n\">read</span><span class=\"bp\">-</span><span class=\"k\">from</span><span class=\"bp\">-</span><span class=\"n\">string</span><span class=\"o\">(</span><span class=\"s2\">\"/home/collares/.elan/toolchains/leanprover--lean4---v4.15.0-rc1/bin/lean: option requires an argument -- 'p'</span><span class=\"se\">\\n</span><span class=\"s2\">Unknown command line option ...\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">leanpkg</span><span class=\"bp\">-</span><span class=\"n\">find</span><span class=\"bp\">-</span><span class=\"n\">path</span><span class=\"bp\">-</span><span class=\"n\">file</span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">server</span><span class=\"bp\">-</span><span class=\"n\">ensure</span><span class=\"bp\">-</span><span class=\"n\">alive</span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">server</span><span class=\"bp\">-</span><span class=\"n\">window</span><span class=\"bp\">-</span><span class=\"n\">scroll</span><span class=\"bp\">-</span><span class=\"n\">function</span><span class=\"bp\">-</span><span class=\"n\">hook</span><span class=\"o\">(</span><span class=\"bp\">#&lt;</span><span class=\"n\">window</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"bp\">-</span><span class=\"n\">window</span><span class=\"bp\">-</span><span class=\"n\">buffer</span><span class=\"o\">(</span><span class=\"bp\">#&lt;</span><span class=\"n\">window</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">#&lt;</span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"bp\">&gt;</span><span class=\"o\">)</span>\n<span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 488694567,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1734028181
    },
    {
        "content": "<p>That being said, <code>auto-mode-alist</code> looks like this on my machine after the commit I mentioned above:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">...</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.hlean$\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.lean$\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"bp\">...</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.lean$\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.lean</span><span class=\"se\">\\\\</span><span class=\"s2\">'\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">select</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>So <code>lean4-select-mode</code> ends up on the list, but much later than expected. If I revert the commit, then the alist looks like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">...</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.lean$\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">select</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"bp\">...</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.hlean$\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.lean$\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"bp\">...</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.lean$\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\\\</span><span class=\"s2\">.lean$\"</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">select</span><span class=\"bp\">-</span><span class=\"n\">mode</span><span class=\"o\">)</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>I think the duplicated lines are due to <code>;;;###autoload</code> cookies: I guess it runs once when <code>PKG-autoloads.el</code> is evaluated, which is very early (and autoloads from different packages probably run in an unspecified order), and later when you actually <code>require</code> the package.</p>\n<p>If reverting the commit is not desirable, another possible solution to be investigated would be to keep <code>add-to-list</code> but remove the autoload cookie for that line. I'm not sure this is ideal, though, since I have 11 installed packages which use autoload cookies to manipulate <code>auto-mode-alist</code>.</p>",
        "id": 488696781,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1734029036
    },
    {
        "content": "<p>Does it mean that it would load if Lean 4's <code>add-to-list</code> was evaluated after Lean 3's?</p>",
        "id": 488745161,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734051416
    },
    {
        "content": "<p>If the first Lean 4 <code>add-to-list</code> executes after <em>all</em> Lean 3 <code>push</code>es (the autoload one and the require one), then it would work. But the first <code>add-to-list</code> currently has an autoload cookie, so it runs pretty early. Perhaps a more robust option would be for <code>lean4-mode</code> to remove all other <code>.lean</code> associations before adding its own.</p>",
        "id": 488804847,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1734083967
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"325367\">Mauricio Collares</span> <a href=\"#narrow/stream/468104-Emacs/topic/.60lean4-autodetect-lean3.60.20and.20cleanup/near/488696781\">said</a>:</p>\n<p>thanks for reporting. there is definetly some bug here. i'll fix asap.</p>\n<blockquote>\n<p>I think the duplicated lines are due to <code>;;;###autoload</code> cookies</p>\n</blockquote>\n<p>i'd rather suspect that duplications are caused by lean(3)-mode using <code>push</code> instead of <code>add-to-list</code>.</p>",
        "id": 489199866,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1734345180
    },
    {
        "content": "<p>another challenge is that lean(3)-mode uses a $-ending regexp which is not correct.</p>",
        "id": 489200348,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1734345338
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"779400\">Mekeor Melire</span> <a href=\"#narrow/channel/468104-Emacs/topic/.60lean4-autodetect-lean3.60.20and.20cleanup/near/489199866\">said</a>:</p>\n<blockquote>\n<p>i'd rather suspect that duplications are caused by lean(3)-mode using <code>push</code> instead of <code>add-to-list</code>.</p>\n</blockquote>\n<p>Pedantically, I think both explanations complement each other: The line runs twice because of the autoload cookie (which runs earlier than the <code>require</code>), and <code>push</code> makes the second execution create a duplicated entry. That is, I think either removing the autoload cookie or changing <code>push</code> to <code>add-to-list</code> would remove the duplication (provided <code>lean-mode</code> was only <code>require</code>d once). Either way, <code>lean-mode</code> was removed from MELPA and the repository is archived, so it could be annoying to change anything there.</p>",
        "id": 489238951,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1734356310
    },
    {
        "content": "<p>as always: well analyzed, mauricio :)</p>",
        "id": 489254151,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1734360066
    },
    {
        "content": "<p>Can you workaround by <code>push</code>ing an extra copy in your init file?</p>",
        "id": 489330091,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734379193
    },
    {
        "content": "<p>if it needs manual work to make lean(3)-mode and lean4-mode work well together, i'd suggest to drop the autodetect feature. what do you think?</p>",
        "id": 489331685,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1734379687
    },
    {
        "content": "<p>Personally, I think it's fair to expect some manual configuration from users when they want to use the deprecated version of Lean.</p>",
        "id": 489331929,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1734379766
    },
    {
        "content": "<p>Where do you suggest to move the code that decides if the current file is Lean 3 or Lean 4?</p>",
        "id": 489342178,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734382925
    },
    {
        "content": "<p>For reference: here is the code</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nb\">defun</span><span class=\"w\"> </span><span class=\"nv\">lean4-select-mode</span><span class=\"w\"> </span><span class=\"p\">()</span>\n<span class=\"w\">  </span><span class=\"s\">\"Automatically select mode (Lean 3 vs Lean 4).\"</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"nv\">lean4-autodetect-lean3</span>\n<span class=\"w\">           </span><span class=\"p\">(</span><span class=\"nf\">eq</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">car</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">lean4--version</span><span class=\"p\">))))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"nv\">lean-mode</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">lean4-mode</span><span class=\"p\">)))</span>\n</code></pre></div>",
        "id": 489342404,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734383013
    },
    {
        "content": "<p>Possibly, the answer is \"docs and users' init files\".</p>",
        "id": 489342915,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734383168
    },
    {
        "content": "<p>The code you quoted of course won't work without a definition of the <code>lean4-autodetect-lean3</code> variable. Also, when removing the feature of automatic version detection, we'd delete the <code>lean4--version</code> function.</p>\n<p>My personal recommendation to occasional users of Lean version 3 would be to use directory-local variables. For example, you could put something like this in your init.el:</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"c1\">;; Eagerly load both in order to avoid problems with autoloaded</span>\n<span class=\"c1\">;; additions to `auto-mode-alist'.</span>\n<span class=\"p\">(</span><span class=\"nb\">require</span><span class=\"w\"> </span><span class=\"ss\">'lean-mode</span><span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"nb\">require</span><span class=\"w\"> </span><span class=\"ss\">'lean4-mode</span><span class=\"p\">)</span>\n\n<span class=\"p\">(</span><span class=\"k\">defvar</span><span class=\"w\"> </span><span class=\"nv\">my-lean-version</span><span class=\"w\"> </span><span class=\"nf\">#'</span><span class=\"nv\">lean4-mode</span><span class=\"p\">)</span>\n\n<span class=\"p\">(</span><span class=\"nb\">defun</span><span class=\"w\"> </span><span class=\"nv\">my-lean-version-start</span><span class=\"w\"> </span><span class=\"p\">()</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"nf\">funcall</span><span class=\"w\"> </span><span class=\"nv\">my-lean-version</span><span class=\"p\">))</span>\n\n<span class=\"p\">(</span><span class=\"nb\">push</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"p\">(</span><span class=\"s\">\"\\\\.lean\\\\'\"</span><span class=\"w\"> </span><span class=\"o\">.</span><span class=\"w\"> </span><span class=\"nv\">my-lean-version-start</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"nv\">auto-mode-alist</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>And then, in the root directory of a project that uses Lean version 3, you'd directory-locally set the variable <code>my-lean-version</code> to <code>lean-mode</code> (from <code>lean-mode</code> aka <code>lean3-mode</code>). By the way, in recent Emacs versions, you can type <code>M-x customize-dirlocals RET</code> for this purpose.</p>",
        "id": 513974333,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1745447178
    },
    {
        "content": "<p>(I'm marking this topic as resolved in favor of this Github issue: <a href=\"https://github.com/leanprover-community/lean4-mode/issues/104\">https://github.com/leanprover-community/lean4-mode/issues/104</a>)</p>",
        "id": 513975238,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1745447672
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"779400\">Mekeor Melire</span> has marked this topic as resolved.</p>",
        "id": 513975247,
        "sender_full_name": "Notification Bot",
        "timestamp": 1745447675
    }
]