[
    {
        "content": "<p>Moving the discussion from a closed PR <a href=\"https://github.com/leanprover-community/lean4-mode/pull/100\">https://github.com/leanprover-community/lean4-mode/pull/100</a></p>",
        "id": 521592333,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748806343
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"779400\">@Mekeor Melire</span> , I've run the following test:</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nb\">defun</span><span class=\"w\"> </span><span class=\"nv\">lean4-root-dir-p</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">dir</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"s\">\"Check if directory DIR contains \\\"lakefile.lean\\\" or \\\"lakefile.toml\\\".\"</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">or</span>\n<span class=\"w\">   </span><span class=\"p\">(</span><span class=\"nf\">file-exists-p</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">expand-file-name</span><span class=\"w\"> </span><span class=\"s\">\"lakefile.lean\"</span><span class=\"w\"> </span><span class=\"nv\">dir</span><span class=\"p\">))</span>\n<span class=\"w\">   </span><span class=\"p\">(</span><span class=\"nf\">file-exists-p</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">expand-file-name</span><span class=\"w\"> </span><span class=\"s\">\"lakefile.toml\"</span><span class=\"w\"> </span><span class=\"nv\">dir</span><span class=\"p\">))))</span>\n\n<span class=\"p\">(</span><span class=\"nf\">message</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">locate-dominating-file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">elt</span><span class=\"w\"> </span><span class=\"nv\">argv</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nf\">#'</span><span class=\"nv\">lean4-root-dir-p</span><span class=\"p\">))</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>tree<span class=\"w\"> </span>find-dir-test\nfind-dir-test\n├──<span class=\"w\"> </span>a\n│<span class=\"w\">   </span>└──<span class=\"w\"> </span>b\n│<span class=\"w\">       </span>├──<span class=\"w\"> </span>c\n│<span class=\"w\">       </span>│<span class=\"w\">   </span>└──<span class=\"w\"> </span>d\n│<span class=\"w\">       </span>└──<span class=\"w\"> </span>d\n└──<span class=\"w\"> </span>lakefile.toml\n</code></pre></div>\n<p>(all the leaves are files, not directories)</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>strace<span class=\"w\"> </span>emacs<span class=\"w\"> </span>--script<span class=\"w\"> </span>find-dir.el<span class=\"w\"> </span>find-dir-test/a/b/c/d<span class=\"w\"> </span><span class=\"m\">2</span>&gt;<span class=\"p\">&amp;</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>grep<span class=\"w\"> </span>find-dir-test\n</code></pre></div>\n<p>There is no <code>find-dir-test/a/b/d</code> in the output, but there are non-existing directories like <code> find-dir-test/.hg</code> etc</p>",
        "id": 521592629,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748806524
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"779400\">@Mekeor Melire</span> I'm reading the source code of <code>locate-dominating-file</code> trying to find out why it's looking at these directories.</p>",
        "id": 521592793,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748806616
    },
    {
        "content": "<p>I tried to run it line by line using <code>(debug-on-entry 'locate-dominating-file)</code>, but these <code>*.hg</code>/<code>*.git</code> files don't show up in the log.</p>",
        "id": 521593695,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748807212
    },
    {
        "content": "<p>I've tried to paste the strace log, but it's too long. I'll try again when I come home</p>",
        "id": 521598383,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748810220
    },
    {
        "content": "<p>just a reminder that <code>locate-dominating-file</code> is already being called (and probably more commonly than in <code>lean4-lake.el</code>) at <code>lean4-create-lsp-workspace</code> on <code>lean4-mode.el</code></p>",
        "id": 521612360,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1748819487
    },
    {
        "content": "<p>We should probably merge these 2 searches.</p>",
        "id": 521618006,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748823273
    },
    {
        "content": "<p><span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span> I've figured out why <code>strace</code> indicated access to all those <code>.git</code>/<code>.hg</code> files. I didn't reset <code>argv</code> to <code>nil</code> at the end of the script, so Emacs tried to load <code>find-dir-test/a/b/c/d</code> then, and was looking for <code>.git</code>/<code>.hg</code>/<code>.dir-locals</code> etc.</p>",
        "id": 521643400,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748838861
    },
    {
        "content": "<p>tl;dr <code>locate-dominating-file</code> only runs the predicate on the (grand)parent directories, not on any siblings.</p>",
        "id": 521643531,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748838941
    },
    {
        "content": "<p>Thank you very much for investigating, Yury.</p>",
        "id": 521677811,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1748852220
    }
]