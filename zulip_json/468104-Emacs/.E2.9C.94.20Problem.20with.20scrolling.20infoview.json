[
    {
        "content": "<p>When using <code>lean4-mode</code> with the infoview buffer <code>*Lean Goal*</code> open in another window, I often want to scroll the infoview (e.g. because my proof state has so many hypotheses that they fill up the buffer and I want to see the goal). However, for some reason, <code>C-M-v</code> does not work - whenever I scroll the infoview using it, the buffer immediately scrolls back to the top. This forces me to switch to the infoview buffer to scroll (which does work).</p>\n<p>Any idea why this happens? (This has been happening for years, so it shouldn't be related to any recent changes to <code>lean4-mode</code>, if that helps.)</p>",
        "id": 524731670,
        "sender_full_name": "Raghuram",
        "timestamp": 1750259937
    },
    {
        "content": "<p>I guess this happens because the InfoView is regenerated completely everytime the cursor in any <code>lean4-mode</code> window is moved?</p>",
        "id": 524732042,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1750260040
    },
    {
        "content": "<p>Hmm, but <code>C-M-v</code> doesn't move the cursor in the <code>.lean</code> file, right? As far as I can tell, <code>*Lean Goal*</code> isn't in <code>lean4-mode</code>.</p>",
        "id": 524733224,
        "sender_full_name": "Raghuram",
        "timestamp": 1750260412
    },
    {
        "content": "<p>Oh, true <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 524747477,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1750265331
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"422703\">Malvin Gattinger</span> <a href=\"#narrow/channel/468104-Emacs/topic/Problem.20with.20scrolling.20infoview/near/524732042\">said</a>:</p>\n<blockquote>\n<p>I guess this happens because the InfoView is regenerated completely everytime the cursor in any <code>lean4-mode</code> window is moved?</p>\n</blockquote>\n<p>It's regenerated in the buffer-local <code>post-command-hook</code>, so whenever a command is run in the <code>lean4-mode</code> buffer</p>",
        "id": 524927854,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1750355217
    },
    {
        "content": "<p>I'm not using the upstream <code>lean4-mode</code>, but you could try scrolling to the previous position after redisplay like this (untested)</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nv\">advice-add</span><span class=\"w\"> </span><span class=\"ss\">'lean4-info-buffer-redisplay</span><span class=\"w\"> </span><span class=\"nb\">:around</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"nb\">defun</span><span class=\"w\"> </span><span class=\"nv\">lean4-info-buffer-redisplay/preserve-scroll</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">redisplay-f</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"nv\">when-let*</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"nv\">window</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">get-buffer-window</span><span class=\"w\"> </span><span class=\"nv\">lean4-info-buffer-name</span><span class=\"p\">))</span>\n<span class=\"w\">                          </span><span class=\"p\">(</span><span class=\"nv\">pos</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">window-start</span><span class=\"w\"> </span><span class=\"nv\">window</span><span class=\"p\">)))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nf\">funcall</span><span class=\"w\"> </span><span class=\"nv\">redisplay-f</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nf\">set-window-start</span><span class=\"w\"> </span><span class=\"nv\">window</span><span class=\"w\"> </span><span class=\"nv\">pos</span><span class=\"p\">))))</span>\n</code></pre></div>",
        "id": 524929670,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1750356202
    },
    {
        "content": "<p>possibly this will also prevent <code>C-M-v</code> from working with the infoview at all, in which case you'd need to check if <code>this-command</code> is not eq to <code>scroll-other-window</code> in the advice</p>",
        "id": 524943922,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1750364638
    },
    {
        "content": "<p>This worked, thanks!</p>",
        "id": 524947102,
        "sender_full_name": "Raghuram",
        "timestamp": 1750366509
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"501683\">Raghuram</span> has marked this topic as resolved.</p>",
        "id": 524959742,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750377595
    }
]