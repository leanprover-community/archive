[
    {
        "content": "<p>Hi all,</p>\n<p>I have now finished a package supporting semantic tokens in Eglot. It creates a new server class <code>eglot-semtok-server</code> which can be used in a user configuration or another package.</p>\n<p><a href=\"https://github.com/estradilua/eglot-semtok\">https://github.com/estradilua/eglot-semtok</a></p>",
        "id": 537014552,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756681798
    },
    {
        "content": "<p>I'm also working on a tree-sitter grammar and mode (but they may take some time to finish)</p>\n<p><a href=\"https://github.com/estradilua/tree-sitter-lean\">https://github.com/estradilua/tree-sitter-lean</a><br>\n<a href=\"https://github.com/estradilua/lean-ts-mode\">https://github.com/estradilua/lean-ts-mode</a></p>",
        "id": 537014608,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756681891
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"571941\">Lua Viana Reis</span> <a href=\"#narrow/channel/468104-Emacs/topic/.E2.9C.94.20Development.3A.20Maintainership/near/537014552\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"779400\">Mekeor Melire</span> if you (or anyone else here) are working on Lean + Eglot, I have now finished a package supporting semantic tokens in Eglot. It creates a new server class <code>eglot-semtok-server</code> which can be used in a user configuration or another package.</p>\n<p><a href=\"https://github.com/estradilua/eglot-semtok\">https://github.com/estradilua/eglot-semtok</a></p>\n</blockquote>\n<p>Hi <span class=\"user-mention\" data-user-id=\"571941\">@Lua Viana Reis</span>,</p>\n<p>I use a <a href=\"https://github.com/bustercopley/lean4-mode\">fork</a> of <code>lean4-mode</code> adapted to Eglot.</p>\n<p>The server class is registered in <code>eglot-server-programs</code> as follows (we delay constructing the LSP server command until the server is started, because it depends which version of Lake Elan selects):</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nb\">defun</span><span class=\"w\"> </span><span class=\"nv\">lean4--server-cmd</span><span class=\"w\"> </span><span class=\"p\">()</span>\n<span class=\"w\">  </span><span class=\"s\">\"Return Lean server command.</span>\n<span class=\"s\">If found lake version at least 3.1.0, then return '/path/to/lake serve',</span>\n<span class=\"s\">otherwise return '/path/to/lean --server'.\"</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"k\">condition-case</span><span class=\"w\"> </span><span class=\"no\">nil</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">string-version-lessp</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">car</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">process-lines</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">lean4-get-executable</span><span class=\"w\"> </span><span class=\"s\">\"lake\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"s\">\"--version\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"s\">\"3.1.0\"</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"o\">`</span><span class=\"p\">(</span><span class=\"o\">,</span><span class=\"p\">(</span><span class=\"nv\">lean4-get-executable</span><span class=\"w\"> </span><span class=\"nv\">lean4-executable-name</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"s\">\"--server\"</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"o\">`</span><span class=\"p\">(</span><span class=\"o\">,</span><span class=\"p\">(</span><span class=\"nv\">lean4-get-executable</span><span class=\"w\"> </span><span class=\"s\">\"lake\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"s\">\"serve\"</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"ne\">error</span><span class=\"w\"> </span><span class=\"o\">`</span><span class=\"p\">(</span><span class=\"o\">,</span><span class=\"p\">(</span><span class=\"nv\">lean4-get-executable</span><span class=\"w\"> </span><span class=\"nv\">lean4-executable-name</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"s\">\"--server\"</span><span class=\"p\">))))</span>\n\n<span class=\"c1\">;; Eglot init</span>\n<span class=\"p\">(</span><span class=\"nb\">defun</span><span class=\"w\"> </span><span class=\"nv\">lean4--server-class-init</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kp\">&amp;optional</span><span class=\"w\"> </span><span class=\"nv\">_interactive</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"nf\">cons</span><span class=\"w\"> </span><span class=\"ss\">'lean4-eglot-lsp-server</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">lean4--server-cmd</span><span class=\"p\">)))</span>\n\n<span class=\"p\">(</span><span class=\"nb\">push</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">cons</span><span class=\"w\"> </span><span class=\"ss\">'lean4-mode</span><span class=\"w\"> </span><span class=\"nf\">#'</span><span class=\"nv\">lean4--server-class-init</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">eglot-server-programs</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>I'm not sure how to insert <code>eglot-semtok-server</code>. I tried replacing the init function <code>lean4--server-class-init</code>, like this [edited]:</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nb\">require</span><span class=\"w\"> </span><span class=\"ss\">'eglot-semtok</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nb\">defun</span><span class=\"w\"> </span><span class=\"nv\">my/lean4-server-class-init</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kp\">&amp;optional</span><span class=\"w\"> </span><span class=\"nv\">_interactive</span><span class=\"w\"> </span><span class=\"nv\">_project</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"o\">`</span><span class=\"p\">(</span><span class=\"nv\">eglot-semtok-server</span><span class=\"w\"> </span><span class=\"nv\">lean4-eglot-lsp-server</span><span class=\"w\"> </span><span class=\"o\">,@</span><span class=\"p\">(</span><span class=\"nv\">lean4--server-cmd</span><span class=\"p\">)))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nb\">push</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">cons</span><span class=\"w\"> </span><span class=\"ss\">'lean4-mode</span><span class=\"w\"> </span><span class=\"nf\">#'</span><span class=\"nv\">my/lean4-server-class-init</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">eglot-server-programs</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>It doesn't work. The message \"[eglot] (warning) Wrong type argument: processp, nil\" is printed and the LSP server is not started. Maybe I slipped up, or maybe this approach is doomed to fail. Before I try to debug, do you have any advice?</p>",
        "id": 537096778,
        "sender_full_name": "Richard Copley",
        "timestamp": 1756728731
    },
    {
        "content": "<p>Oh. Your README doesn't claim what I thought it claims. I think I need to change <code>lean4-eglot-lsp-server</code> to inherit from or delegate to <code>eglot-semtok-server</code>. I might try that some time.</p>",
        "id": 537133547,
        "sender_full_name": "Richard Copley",
        "timestamp": 1756740889
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"400544\">@Richard Copley</span>,</p>\n<p>as you realize, you have to change a line in <code>lean4-mode.el</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">- (defclass lean4-eglot-lsp-server (eglot-lsp-server) nil</span>\n<span class=\"gi\">+ (defclass lean4-eglot-lsp-server (eglot-semtok-server) nil</span>\n</code></pre></div>\n<p>I have not tested this, but perhaps you can do that in your config too, i.e., redefine</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nb\">defclass</span><span class=\"w\"> </span><span class=\"nv\">lean4-eglot-lsp-server</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">eglot-semtok-server</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"no\">nil</span>\n<span class=\"w\">  </span><span class=\"nb\">:documentation</span><span class=\"w\"> </span><span class=\"s\">\"Eglot LSP server subclass for the Lean 4 server.\"</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>after loading your package</p>",
        "id": 537140163,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756743612
    },
    {
        "content": "<p>after this, eglot should take care of initializing <code>eglot-semtok-mode</code> if the server supports it</p>",
        "id": 537140341,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756743691
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"571941\">Lua Viana Reis</span> <a href=\"#narrow/channel/468104-Emacs/topic/.E2.9C.94.20Development.3A.20Maintainership/near/537140163\">said</a>:</p>\n<blockquote>\n<p>after loading your package</p>\n</blockquote>\n<p>if it doesn't work after, then I think there is a good chance it would work if you redefine before</p>",
        "id": 537141842,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756744283
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"571941\">Lua Viana Reis</span> <a href=\"#narrow/channel/468104-Emacs/topic/.E2.9C.94.20Development.3A.20Maintainership/near/537140163\">said</a>:</p>\n<blockquote>\n<p>as you realize, you just have to change a line in <code>lean4-mode.el</code>:</p>\n<p><div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">- (defclass lean4-eglot-lsp-server (eglot-lsp-server) nil</span>\n<span class=\"gi\">+ (defclass lean4-eglot-lsp-server (eglot-semtok-server) nil</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Great, thank you. I thought it would be harder! Looks very nice.</p>",
        "id": 537142010,
        "sender_full_name": "Richard Copley",
        "timestamp": 1756744355
    },
    {
        "content": "<p>please report any semantic tokens issues you have, as there is a possibility that this could be upstreamed to eglot</p>",
        "id": 537143658,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756744884
    },
    {
        "content": "<p>9 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"468104\" href=\"/#narrow/channel/468104-Emacs/topic/.E2.9C.94.20Development.3A.20Maintainership/with/513978034\">#Emacs &gt; ✔ Development: Maintainership</a> by <span class=\"user-mention silent\" data-user-id=\"400544\">Richard Copley</span>.</p>",
        "id": 537144091,
        "sender_full_name": "Notification Bot",
        "timestamp": 1756745114
    },
    {
        "content": "<p>There's also a package by Harald Kirsch that extends Eglot by semantic token support: <a href=\"https://codeberg.org/harald/eglot-supplements#semantic-tokens\">https://codeberg.org/harald/eglot-supplements#semantic-tokens</a></p>",
        "id": 537278617,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1756817274
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"779400\">@Mekeor Melire</span> I did try what was available before writing something else.<br>\n But their implementation is problematic starting from the fact it hardcodes the colors for the tokens. It also completely replaces the major-mode fontification instead of extending it, and does not support delta requests.</p>",
        "id": 537284093,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756818808
    },
    {
        "content": "<p>also, a lot of \"FIXME\"s in there, and it won't request new data after buffer changes or will make requests too often, e.g. when scrolling the buffer</p>",
        "id": 537286489,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1756819535
    },
    {
        "content": "<p>The semantic tokens feature has been merged into Eglot! </p>\n<p>Unfortunately, João decided not to include the <code>semanticTokens/refresh</code> handler for now; this means that when a file takes a long time to elaborate (more than <code>jsonrpc-default-request-timeout</code>), the tokens will be missing, because they only become available after that. The Lean server then sends this notification (for instance, see this <a href=\"#narrow/channel/270676-lean4/topic/colour.20glitch.20in.20VS.20Code/with/561018081\">topic</a> — only that unlike VSCode, Eglot would not eventually catch up with the highlighting).</p>",
        "id": 561029607,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1764534561
    },
    {
        "content": "<p>(in fact, our Eglot implementation prompted <code>lsp-mode</code> to \"<a href=\"https://github.com/emacs-lsp/lsp-mode/pull/4912\">fix</a>\" theirs; only that they fixed it in the wrong way, and unless I'm mistaken — I have only read, not tested their code — the <code>lsp-mode</code> tokens will blink every time you edit a file)</p>",
        "id": 561030428,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1764535165
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"571941\">Lua Viana Reis</span> <a href=\"#narrow/channel/468104-Emacs/topic/Semantic.20Tokens/near/561029607\">said</a>:</p>\n<blockquote>\n<p>Unfortunately, João decided not to include the <code>semanticTokens/refresh</code> handler for now</p>\n</blockquote>\n<p>That said, this can be fixed in the <code>{lean-ts,nael}-mode</code> side by implementing the handler ourselves. I still want to investigate the best way to do this, and after that I can send it here, or to upstream Eglot if that makes sense.</p>",
        "id": 561030791,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1764535482
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"571941\">@Lua Viana Reis</span>, this is freaking awesome, congratulations!</p>",
        "id": 561031766,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1764536223
    },
    {
        "content": "<p>From my beginner's perspective, I agree that Eglot should have merged the handler for semanticTokens/refresh, too.</p>\n<p>Without looking into it, I'd guess Lean major modes can define their own subclass of Eglot language servers and define a method on them? Similar to rocq-mode, for example: <a href=\"https://codeberg.org/jpoiret/rocq-mode.el/src/branch/main/rocq-mode.el\">https://codeberg.org/jpoiret/rocq-mode.el/src/branch/main/rocq-mode.el</a></p>",
        "id": 561032016,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1764536395
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"779400\">@Mekeor Melire</span> this should suffice for now:</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nv\">cl-defmethod</span><span class=\"w\"> </span><span class=\"nv\">eglot-handle-request</span>\n<span class=\"w\">  </span><span class=\"p\">((</span><span class=\"nv\">server</span><span class=\"w\"> </span><span class=\"nv\">nael-eglot-lsp-server</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">_method</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">eql</span><span class=\"w\"> </span><span class=\"nv\">workspace/semanticTokens/refresh</span><span class=\"p\">)))</span>\n<span class=\"w\">  </span><span class=\"s\">\"Handle a semanticTokens/refresh request from SERVER.\"</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"nb\">dolist</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">buffer</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">eglot--managed-buffers</span><span class=\"w\"> </span><span class=\"nv\">server</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">eglot--when-live-buffer</span><span class=\"w\"> </span><span class=\"nv\">buffer</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"nb\">setf</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">plist-get</span><span class=\"w\"> </span><span class=\"nv\">eglot--semtok-state</span><span class=\"w\"> </span><span class=\"nb\">:docver</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"no\">nil</span><span class=\"p\">)</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"nv\">eglot--widening</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">font-lock-flush</span><span class=\"p\">)))))</span>\n</code></pre></div>\n<p>but unfortunately, sometimes it does not! I have been testing the file <code>examples/custom-genre/SimplePage/Demo.lean</code> of the <code>verso</code> repository, and even in VSCode it sometimes looks like this:</p>\n<p><a href=\"/user_uploads/3121/B7cEDkpQsQArIky5160lx01L/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/B7cEDkpQsQArIky5160lx01L/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1788x2048\" src=\"/user_uploads/thumbnail/3121/B7cEDkpQsQArIky5160lx01L/image.png/840x560.webp\"></a></div><p>but if I do <code>Lean 4 Server: Restart Server</code>, it looks like this instead:</p>\n<p><a href=\"/user_uploads/3121/SzPXOiEAdBGRPdFr9j7hoarp/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/SzPXOiEAdBGRPdFr9j7hoarp/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1788x2048\" src=\"/user_uploads/thumbnail/3121/SzPXOiEAdBGRPdFr9j7hoarp/image.png/840x560.webp\"></a></div>",
        "id": 561035143,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1764538847
    },
    {
        "content": "<p>until you edit something, and then it updates properly (and Eglot too)</p>",
        "id": 561035326,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1764539023
    },
    {
        "content": "<p>Actually, in this specific example this is a bug in Verso. It is doing its own LSP request handling</p>",
        "id": 561036379,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1764540081
    },
    {
        "content": "<p>Thanks! I'll try out the snippet some time.</p>",
        "id": 561039896,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1764543482
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"571941\">@Lua Viana Reis</span>, congratulations to the new Eglot release that includes your implementation of semantic tokens!</p>\n<blockquote>\n<p>Changes in Eglot 1.20 (11/1/2026) [...] Support for semantic tokens (<a href=\"https://github.com/leanprover-community/bug/pull/79374\">bug#79374</a>)</p>\n<p>The new minor mode 'eglot-semantic-tokens-mode' provides enhanced syntax highlighting based on the language server's analysis, going beyond traditional regular-expression-based fontification.  The 'eglot-semantic-faces' customization group contains options for controlling which token types and modifiers to consider, as well as faces for customizing their appearance.  The minor mode is on by default: consult the manual on how to turn it off.</p>\n</blockquote>\n<p><a href=\"https://cgit.git.savannah.gnu.org/cgit/emacs.git/tree/etc/EGLOT-NEWS?id=b4a5948d3330f7ca02c61075eed94b467645ea83#n112\">https://cgit.git.savannah.gnu.org/cgit/emacs.git/tree/etc/EGLOT-NEWS?id=b4a5948d3330f7ca02c61075eed94b467645ea83#n112</a></p>",
        "id": 569588457,
        "sender_full_name": "Mekeor Melire",
        "timestamp": 1769115899
    }
]