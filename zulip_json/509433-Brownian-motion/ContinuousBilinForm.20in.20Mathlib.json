[
    {
        "content": "<p>I've written some API for continuous bilinear forms, as they are an essential component of Gaussian measures on infinite-dimensional Banach spaces, because of the covariance operator. Following the message of R√©my about starting to PR some of the project to Mathlib, I thought this was a good start.<br>\nHowever, I am a bit afraid by the duplication it might create. A large part of what I introduced is not at all specific to <strong>continuous</strong> bilinear forms, and works well for <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/LinearAlgebra/BilinearMap.html#LinearMap.BilinForm\">LinearMap.BilinForm</a>. On the other hand, I really want to be able to write things like <code>f.IsSymm</code> when <code>f</code> is a continuous bilinear form, and this does not work if I don't define <code>IsSymm</code> for <code>ContinuousBilinForm</code>. It does not either trigger a coercion to <code>BilinForm</code>, although <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/LinearAlgebra/BilinearForm/Properties.html#LinearMap.BilinForm.IsSymm\">LinearMap.BilinForm.IsSymm</a> already exists.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">RCLike</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"c\">/-</span><span class=\"cm\"> The type of continuous bilinear forms. -/</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">ContinuousBilinForm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ùïú</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ùïú</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ùïú</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ContinuousBilinForm</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- The underlying bilinear form of a continuous bilinear form -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">coe</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ContinuousBilinForm</span><span class=\"bp\">.</span><span class=\"n\">toBilinForm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">BilinForm</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">map_add'</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"n\">map_smul'</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ContinuousBilinForm</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">BilinForm</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">toBilinForm</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">IsSymm</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">BilinForm</span><span class=\"bp\">.</span><span class=\"n\">IsSymm</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">BilinForm</span><span class=\"bp\">.</span><span class=\"n\">IsSymm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">BilinForm</span><span class=\"bp\">.</span><span class=\"n\">IsSymm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">BilinForm</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works, but lengthy, and explicit coercion</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">toBilinForm</span><span class=\"bp\">.</span><span class=\"n\">IsSymm</span><span class=\"w\"> </span><span class=\"c1\">-- works, but lengthy, and explicit coercion</span>\n</code></pre></div>\n<p>So here are my questions: can you think of a better way to define things so that the coercion does trigger automatically? If not, then do you think it's ok if I duplicate some API? (In the end I do not need much of what already exists for <code>BilinForm</code>, it's more a matter of principle. I also intend to define concepts for <code>ContinuousBilinForm</code> which would still make sense for <code>BilinForm</code>, but I'm not sure I want to define them for <code>BilinForm</code> because that would just duplicate things I have no use for.)</p>",
        "id": 525015734,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750414972
    },
    {
        "content": "<p><code>#check LinearMap.BilinForm.IsSymm (R := ùïú) (M := E) f</code> works (although obviously not a good solution). I believe it may be an instance of this <a href=\"https://github.com/leanprover/lean4/issues/7440\">issue</a>. The last option you listed <code>f.toBilinForm.IsSymm</code> doesn't seem that bad to me tbh.</p>",
        "id": 525112982,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1750460528
    },
    {
        "content": "<p>The choice seems to be between duplication and adding <code>toBilinForm</code>. The latter does not sound too bad?</p>",
        "id": 525201047,
        "sender_full_name": "R√©my Degenne",
        "timestamp": 1750580472
    },
    {
        "content": "<p>Then I would also write <code>f.toBilinForm.toMatrix</code>. It feels a bit heavy to me, but I agree it's better than duplication. I think I'll go with that.</p>",
        "id": 525219533,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750606652
    },
    {
        "content": "<p>Actually I can't even write <code>f.toBilinForm.toMatrix</code> for some reason, I think that's because <code>toMatrix</code> is an equiv so it does not support dot notation. I think I'll keep things as they are.</p>",
        "id": 525227110,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750616770
    },
    {
        "content": "<p>I opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/26274\">#26274</a>. In the end I stuck with <code>f.toBilinForm.IsSymm</code> but I redefined <code>toMatrix</code> to allow for dot notation.</p>",
        "id": 525234608,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750627963
    },
    {
        "content": "<p>I went back to this today but honestly I am at a loss as to what to do. I have <a href=\"https://github.com/leanprover-community/mathlib4/pull/28052\">#28052</a> defining positive semidefinite sesquilinear maps and <a href=\"https://github.com/leanprover-community/mathlib4/pull/26315\">#26315</a> for continuous ones, but I am worried that relying too much on abbreviations will lead to lots of duplication. But I also think that I do not want to work with <code>ContinuousSesquilinForm</code> when the map is actually bilinear.</p>",
        "id": 541892422,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1759066057
    },
    {
        "content": "<p>Perhaps you should post a question about that issue in a more visible channel, with a summary of all the abbreviations that could possibly be involved (and the ones that are already there), and the long expressions that one should write if the abbreviations are not used.<br>\nI won't have much time to look at that question for a week at least, but this is something that is not specific to our project and I think others who are not in this project channel could give valuable advice on how to proceed.</p>",
        "id": 542686255,
        "sender_full_name": "R√©my Degenne",
        "timestamp": 1759394563
    },
    {
        "content": "<p>Etienne wrote a description of the issue here: <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Duplication.20for.20sesquilinear.20forms.20and.20bilinear.20forms/with/542720081\">#mathlib4 &gt; Duplication for sesquilinear forms and bilinear forms</a></p>",
        "id": 542759651,
        "sender_full_name": "R√©my Degenne",
        "timestamp": 1759416014
    },
    {
        "content": "<p>I went for duplicating code from sesquilinear forms but won't do the duplication for continuous bilinear forms, so I wont introduce a <code>ContinuousBilinForm</code> abbreviation like I did in the project. I wrote the PRs in <a class=\"stream-topic\" data-stream-id=\"509433\" href=\"/#narrow/channel/509433-Brownian-motion/topic/Mathlib.20PRs/with/543409355\">#Brownian motion &gt; Mathlib PRs</a>, it's mostly about sesquilinear forms, which we don't really need but positive semidefinite forms and their links with positive semidefinite matrices make sense in that generality so it would not be great to restrain the definition to the bilinear case only.</p>",
        "id": 543409712,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1759785479
    }
]