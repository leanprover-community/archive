[
    {
        "content": "<p>In this PR, we implemented <code>CanonAtomM</code> which does almost the same thing as <code>AtomM</code> with the same APIs (though the number of parameters of the state has some difference). We did this because we noticed that in the docstring part of <code>AtomM</code>, it is recommended to use <code>CanonM</code> instead, but they have different APIs (which seems to be why <code>module</code> tactic didn't refactor to <code>CanonM</code>?), so we decided to build something on top of that which has the same API and functionality so that future usage could be easier, and possibly utilizing refactoring of older tactics to a faster way.</p>",
        "id": 503673349,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1741225252
    },
    {
        "content": "<p>I think part of the reason for not using CanonM was that it didn't behave as we wanted it to; it would be worth finding and linking to the Zulip thread where this was previously discussed.</p>",
        "id": 503673816,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741225544
    },
    {
        "content": "<p>A similar discussion is found at <a href=\"https://github.com/leanprover-community/mathlib4/pull/16593\">#16593</a>, where  <code>match_scalars</code> and <code>module</code> are merged into mathlib.  The link of the discussion is <a href=\"https://github.com/leanprover-community/mathlib4/pull/16593/files#r1749623191\">https://github.com/leanprover-community/mathlib4/pull/16593/files#r1749623191</a></p>",
        "id": 503674479,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1741225955
    },
    {
        "content": "<p>And <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Transparency.20in.20CanonM/with/482304698\">#lean4 &gt; Transparency in CanonM</a>  may be one of the relevant discussions</p>",
        "id": 503674725,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1741226116
    },
    {
        "content": "<p>Well, another PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/22618\">#22618</a> is opened to benchmark and test if the switch from <code>AtomM</code> to <code>CanonAtomM</code> is applicable and how it performs. One of the first questions emerging is that, when you have something like <code>let u := v</code> (often for the sake of simplicity of the proof), then <code>u</code> and <code>v</code> are considered different atoms in <code>CanonAtomM</code> but the same in <code>AtomM</code>.</p>",
        "id": 503794626,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1741268092
    },
    {
        "content": "<p>This is independently fixed by <a href=\"https://github.com/leanprover-community/mathlib4/pull/19120\">#19120</a>, maybe</p>",
        "id": 503805584,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741270697
    },
    {
        "content": "<p>What is the status of <a href=\"https://github.com/leanprover-community/mathlib4/pull/19120\">#19120</a>? <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span>, <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>, could either of you give an update?</p>",
        "id": 503912189,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741303745
    },
    {
        "content": "<p>I have an open PR that adds the <code>zetaDelta</code> option to <code>ring_nf</code> and <code>abel_nf</code>, and sets it to false by default <a href=\"https://github.com/leanprover-community/mathlib4/pull/21194\">#21194</a>. This means that if you have <code>let u := v</code> (for the simplicity of the proof), then it will now treat the <code>u</code> as an atom.</p>\n<p>This PR is instead of <a href=\"https://github.com/leanprover-community/mathlib4/pull/19120\">#19120</a>.</p>",
        "id": 503918995,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1741306684
    },
    {
        "content": "<p>I decided it wasn't worth adding this feature to closing tactics like <code>ring</code> and <code>abel</code>, since this only makes the tactics weaker. For normalization tactics <code>ring_nf</code> and <code>abel_nf</code> however, it is nice to stop the tactic from unfolding let variables.</p>",
        "id": 503919396,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1741306906
    },
    {
        "content": "<p>I'm happy with <a href=\"https://github.com/leanprover-community/mathlib4/pull/21194\">#21194</a>. I'm out of time for the week, but if no one has merged it I'll try to review it properly early next week.</p>",
        "id": 503946768,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741322498
    },
    {
        "content": "<p>Yeah, I agree that for <code>ring</code> and <code>abel</code>, this feature will only make them weaker. The thing here is that, when I tried the refactoring from <code>AtomM</code> to <code>CanonAtomM</code>, they automatically have this feature, which makes some proofs that needed <code>let</code> to be unfolded break down.</p>",
        "id": 503947542,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1741322933
    },
    {
        "content": "<p>So I guess some more work have to be done on <a href=\"https://github.com/leanprover-community/mathlib4/pull/22618\">#22618</a> to fix all the broken proofs? Or if this is really an undesired refactoring so the work isn't needed now?</p>",
        "id": 503947911,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1741323154
    },
    {
        "content": "<p>For <a href=\"https://github.com/leanprover-community/mathlib4/pull/22618\">#22618</a>, if the motivation is to deal with let variables differently, then this is unnecessary since <a href=\"https://github.com/leanprover-community/mathlib4/pull/21194\">#21194</a> does that.</p>\n<p>However, if the motivation is to improve performance, then feel free to try it without modifying the let variable behaviour (or copy the behaviour from <a href=\"https://github.com/leanprover-community/mathlib4/pull/21194\">#21194</a>), and benchmark it to see the performance effect.</p>",
        "id": 504063262,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1741344226
    },
    {
        "content": "<p>Then I think I'll probably still give it a try, and see how does this refactoring change the performance.</p>",
        "id": 504097630,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1741354894
    },
    {
        "content": "<p>Well, after fixing a bunch of compile errors, unfortunately it appears that the proposed refactoring of <code>ring</code> and <code>module</code> to <code>CanonAtomM</code> is actually slowing things down. You can see the benchmark result at this <a href=\"https://speed.lean-lang.org/mathlib4/compare/09ec283a-51d3-405c-9ebd-cc462ff82804/to/b9abf1b8-ae2a-48af-9a5b-10129928939d\">link</a>. The first result is the modified version, and the second result is before this refactoring.</p>",
        "id": 505844370,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1742042341
    },
    {
        "content": "<p>So I guess, since this is both slowing things down and making tactics weaker, I can just stop this PR and the <code>lie_ring</code> tactic can stick to <code>CanonAtomM</code>?</p>",
        "id": 505844423,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1742042401
    },
    {
        "content": "<p>Why not have <code>lie_ring</code> stick to <code>AtomM</code>?</p>",
        "id": 505844941,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742042768
    },
    {
        "content": "<p>Sorry, that's a typo. <code>lie_ring</code> should stick to <code>AtomM</code>.</p>",
        "id": 505844986,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1742042815
    },
    {
        "content": "<p>Yes, we should definitely try to get <code>lie_ring</code> merged with <code>AtomM</code>, rather than blocking it on discussion about CanonM</p>",
        "id": 505845036,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742042865
    },
    {
        "content": "<p>Well, at least this attempt showed that sticking to <code>AtomM</code> isn't such a bad choice.</p>",
        "id": 505845105,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1742042896
    },
    {
        "content": "<p>I just closed the benchmarking PR with a comment like above. Perhaps I should close this PR as well? Since it doesn't appear to be a useful one.</p>",
        "id": 505845595,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1742043312
    },
    {
        "content": "<p>It might be good to add a comment about your attempt in the <code>AtomM</code> file.</p>",
        "id": 505847402,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1742044636
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322614.20CanonAtomM/near/505847402\">said</a>:</p>\n<blockquote>\n<p>It might be good to add a comment about your attempt in the <code>AtomM</code> file.</p>\n</blockquote>\n<p>That seems reasonable to me. Thanks! I'd probably add a comment on the other PR of lie algebra tactic  and close this one.</p>",
        "id": 505854637,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1742049907
    }
]