[
    {
        "content": "<p>The change and motivation for this PR looks reasonable to me. But, the performance of a few files gets worse: 11 files get at least 5% slower, and one gets almost 30% slower. Should we investigate what's going on in these situations before merging? (Mathlib as a whole has +0.08% on this.)<br>\n(cc <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>, who was hoping for a performance improvement!)</p>",
        "id": 513106527,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1745015961
    },
    {
        "content": "<p>I was hoping this would improve performance back when I was defining</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"bp\">.</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"bp\">.</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"bp\">⊥</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">coe_le_coe</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"bp\">.</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"bp\">.</span><span class=\"n\">instLE</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithBot</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"bp\">.</span><span class=\"n\">LE</span>\n</code></pre></div>",
        "id": 513107432,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745016683
    },
    {
        "content": "<p>Instead, the PR currently has</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">WithBot</span><span class=\"bp\">.</span><span class=\"n\">instLE</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithBot</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">le</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⊥</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⊥</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">⊥</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">False</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⊥</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>",
        "id": 513107441,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745016693
    },
    {
        "content": "<p>I am rather sure this is the cause of the performance regressions</p>",
        "id": 513107459,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745016714
    },
    {
        "content": "<p>The issue with the <code>inductive</code> approach is that it makes the order instances on <code>WithBot αᵒᵖ</code> and <code>(WithTop α)ᵒᵖ</code> not defeq anymore (because they are two different inductives). Using a <code>match</code> is a cheap way to get around that, but in turn it makes <code>↑a ≤ ↑b</code> and <code>a ≤ b</code> defeq, which makes Lean confused in a few places</p>",
        "id": 513107755,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745016939
    },
    {
        "content": "<p>I claim that's fine, because similar situations happen for example with the coercion <code>ℕ → ℤ</code>, but if we really wanted to we could instead do a variant of the <code>inductive</code> approach where <code>≤</code> on <code>WithBot α</code> and <code>WithTop α</code> is defined with a single inductive (by abusing the defeq between <code>WithBot α</code> and <code>WithTop α</code>)</p>",
        "id": 513108061,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745017174
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2319668.20define.20.60.E2.89.A4.60.2F.60.3C.60.20on.20.60WithBot.60.2F.60WithTop.60.20by.20induction/near/513108061\">said</a>:</p>\n<blockquote>\n<p>similar situations happen for example with the coercion <code>ℕ → ℤ</code></p>\n</blockquote>\n<p>What do you mean by this? They don't seem to be defeq to me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 513108495,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1745017523
    },
    {
        "content": "<p>Similar thing happen with the induced order on subtypes</p>",
        "id": 513108587,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1745017593
    },
    {
        "content": "<p>Oh interesting, but certainly there are plenty of other coercions where that's the case, eg all set-like types</p>",
        "id": 513108600,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745017610
    },
    {
        "content": "<p>I'm still not quite sure I follow - there isn't an order on subtypes? Do you have a concrete example of what you mean?</p>",
        "id": 513108924,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1745017855
    },
    {
        "content": "<p>Of course there is: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subtype.preorder#doc\">docs#Subtype.preorder</a> along with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subtype.coe_le_coe#doc\">docs#Subtype.coe_le_coe</a></p>",
        "id": 513109038,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745017955
    },
    {
        "content": "<p>Ah, I was mis-parsing completely! Now I follow. (I thought you were comparing different subtypes!)</p>",
        "id": 513109066,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1745017988
    }
]