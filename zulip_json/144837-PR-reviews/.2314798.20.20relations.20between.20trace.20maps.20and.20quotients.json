[
    {
        "content": "<p>Maybe I ask for a review of <a href=\"https://github.com/leanprover-community/mathlib4/pull/14798\">#14798</a>? It is a about technical stuff relating trace and quotients, and it is pretty standard in number theory (from flt-regular, but surely needed for other projects).</p>\n<p>Thanks!</p>",
        "id": 476730158,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1728898044
    },
    {
        "content": "<p>Two small comments</p>",
        "id": 476733822,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728898933
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 476733871,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1728898949
    },
    {
        "content": "<p>After</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IsLocalization</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"bp\">⁰</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hM</span>\n<span class=\"n\">algebraize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">g</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>says \"unknown identifier 'g'\". Am I missing something?</p>",
        "id": 476737264,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1728899800
    },
    {
        "content": "<p>Huh. Maybe it doesn't work with <code>let</code> bindings?</p>",
        "id": 476737933,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728899985
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"132603\">@Calle Sönne</span></p>",
        "id": 476738083,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728900013
    },
    {
        "content": "<p>I don't know, but even replacing <code>g</code> with its definition I get an error</p>",
        "id": 476738104,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1728900019
    },
    {
        "content": "<p>I will minimize it later today</p>",
        "id": 476738146,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1728900027
    },
    {
        "content": "<p>I have actually never tested the tactic with <code>let</code> bindings, so this may very well be a general error!</p>",
        "id": 476758347,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1728905565
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2314798.20.20relations.20between.20trace.20maps.20and.20quotients/near/476738146\">said</a>:</p>\n<blockquote>\n<p>I will minimize it later today</p>\n</blockquote>\n<p>That would be great!</p>",
        "id": 476758378,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1728905571
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Algebraize</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">castRingHom</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"n\">algebraize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>gives the error \"unknown identifier 'f'\", but replacing <code>[f]</code> with <code>[Int.castRingHom R]</code> seems OK.</p>",
        "id": 476767301,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1728907897
    },
    {
        "content": "<p>It's a missing <code>withMainContext</code></p>",
        "id": 476769099,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728908359
    },
    {
        "content": "<p>This works around it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Algebraize</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">castRingHom</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">algebraize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 476769211,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728908392
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2314798.20.20relations.20between.20trace.20maps.20and.20quotients/near/476769099\">said</a>:</p>\n<blockquote>\n<p>It's a missing <code>withMainContext</code></p>\n</blockquote>\n<p>Thanks!</p>",
        "id": 476814515,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1728920929
    },
    {
        "content": "<p>Will open a PR fixing this now unless someone has already (<a href=\"https://github.com/leanprover-community/mathlib4/pull/17737\">#17737</a>)</p>",
        "id": 476814578,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1728920966
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2314798.20.20relations.20between.20trace.20maps.20and.20quotients/near/476769211\">said</a>:</p>\n<blockquote>\n<p>This works around it:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Algebraize</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">castRingHom</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">algebraize</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>What local context am I accessing if I have not called <code>withMainContext</code>? Or rather why does this work?</p>",
        "id": 476816752,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1728921772
    },
    {
        "content": "<p>You are missing any changes to the context since the last <code>by</code> keyword</p>",
        "id": 476841064,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728933800
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2314798.20.20relations.20between.20trace.20maps.20and.20quotients/near/476841064\">said</a>:</p>\n<blockquote>\n<p>You are missing any changes to the context since the last <code>by</code> keyword</p>\n</blockquote>\n<p>Is there a default context that gets used if I have not called <code>withMainContext</code> (is context the wrong word for this?)</p>",
        "id": 476847692,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1728937422
    },
    {
        "content": "<p>Contexts are part of a reader monad, and the reader monad context is fixed at construction. So the only way it is changed is when:</p>\n<ul>\n<li>you explicitly enter a different context within a scope</li>\n<li>you start the monad for the first time, which roughly speaking happens at <code>by</code>s.</li>\n</ul>",
        "id": 476847882,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728937543
    },
    {
        "content": "<p>This is super helpful, thanks!</p>",
        "id": 476848223,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1728937737
    },
    {
        "content": "<p>Arguably this is a design flaw/compromise in the tactic monad; the current approach I think is designed to prevent accidental modification, but it comes at the expense of this foot-gun. Perhaps more annoyingly, it means that you can't use <code>for</code> loops or other <code>do</code> notation to introduce new variables.</p>",
        "id": 476849635,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728938532
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"132603\">@Calle Sönne</span> Do you think the problems discussed here are related to the issue in</p>\n<blockquote>\n<p>feat(RingTheory/StandardSmooth): meta properties of standard smooth ring homomorphisms <a href=\"https://github.com/leanprover-community/mathlib4/pull/16868\">#16868</a></p>\n</blockquote>",
        "id": 476937947,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728982287
    },
    {
        "content": "<p>Or is that a different thing?</p>",
        "id": 476937971,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728982296
    },
    {
        "content": "<p>That seems like a different thing, will look into it as soon as I have the time!</p>",
        "id": 477067773,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1729025101
    },
    {
        "content": "<p>The tactic should definitely support other arguments that are not just the morphism, such as the dimension <code>n</code> in this example. I just (somewhat intentionally) forgot to consider that when working on the tactic, as none of the examples I looked at had this.</p>",
        "id": 477068114,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1729025262
    },
    {
        "content": "<p>If its not too complicated I will try to get a fix in the next few days for this</p>",
        "id": 477072478,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1729027176
    },
    {
        "content": "<p>Okay this wasn't too hard, I can have a PR fixing this ready tomorrow or thursday</p>",
        "id": 477078130,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1729029850
    },
    {
        "content": "<p>I should mention how I intend it to work in general: tagging your property with <code>@[algebraize]</code> will only work in the best cases. It assumes that if your property is called <code>Property</code> then <code>RingHom.Property f</code> is defeq to <code>Algebra.Property f.toAlgebra</code>, but as I just found out, it also assumes that there are no other parameters to either of them (because the tactic first tries to construct the type <code>Algebra.Property f.toAlgebra</code> and after that it gives it <code>hf : RingHom.Property f</code> as a term, and since additional parameters like <code>n</code> or additional universes will need to be induced from <code>hf</code> this will not work in that setting).</p>\n<p>So for all other cases, one should tag the property with <code>@[algebraize theorem_or_constructor_name]</code> where <code>theorem_or_constructor_name</code> is a theorem or constructor that gives you the <code>Algebra</code> property using the <code>RingHom</code> property. So the solution for that PR will be that you need to create a lemma like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">IsStandardSmooth</span><span class=\"bp\">.</span><span class=\"n\">toAlgebra</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsStandardSmooth</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">IsStandardSmooth</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">toAlgebra</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n</code></pre></div>\n<p>and the tag on <code>Algebra.IsStandardSmooth</code> should be:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">algebraize</span><span class=\"w\"> </span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">IsStandardSmooth</span><span class=\"bp\">.</span><span class=\"n\">toAlgebra</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">IsStandardSmooth</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">IsStandardSmooth</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">toAlgebra</span>\n</code></pre></div>\n<p>But this won't work yet because I found another error in that part of the functionality which is what the PR is for</p>",
        "id": 477080874,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1729031452
    },
    {
        "content": "<p>I will also add more documentation explaining what I just wrote</p>",
        "id": 477081445,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1729031750
    },
    {
        "content": "<p>Here it is! <a href=\"https://github.com/leanprover-community/mathlib4/pull/17839\">#17839</a> (sorry for taking over this thread with stuff about this tactic)</p>",
        "id": 477301448,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1729113191
    },
    {
        "content": "<p>Thanks! <span aria-label=\"writing\" class=\"emoji emoji-270d\" role=\"img\" title=\"writing\">:writing:</span></p>",
        "id": 477364058,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1729147175
    }
]