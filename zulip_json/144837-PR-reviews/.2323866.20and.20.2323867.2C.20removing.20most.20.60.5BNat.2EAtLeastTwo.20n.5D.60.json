[
    {
        "content": "<p>This is an interesting pair of PRs, that I wasn't expecting would work out as nicely.</p>",
        "id": 511157297,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744201346
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23866\">#23866</a>  changes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">instOfNatAtLeastTwo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NatCast</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">AtLeastTwo</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">instOfNatAtLeastTwo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NatCast</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>with minimal fall-out.</p>",
        "id": 511157398,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744201369
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23867\">#23867</a> then removes nearly all <code>[AtLeastTwo n]</code> hypotheses from theorems across Mathlib. (In a few places, replacing it with <code>[NeZero n]</code>.)</p>\n<p>More can be removed, but at the cost of a little patching, which I've kept out of this PR, which is strictly weakening hypotheses.</p>",
        "id": 511157623,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744201429
    },
    {
        "content": "<p>Potentially this opens the door to non-defeq <code>OfNat Œ± 0</code> and <code>OfNat Œ± 1</code> instances, but in practice it doesn't seem onerous, we already do a good job of avoiding these.</p>",
        "id": 511157801,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744201471
    },
    {
        "content": "<p>The big pay-off is that now most arithmetic types satisfy <code>[‚àÄ n, OfNat Œ± n]</code>, which according to the current proposed design for Grobner bases in <code>grind</code> will be a requirement. If we can make this change, then Mathlib types will just work in <code>grind</code> without any plumbing. Without this change, some minor (but still tolerable) plumbing is required. In practice this probably only affects <code>ZMod n</code>.</p>",
        "id": 511158253,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744201580
    },
    {
        "content": "<p>... and <code>Fin n</code></p>",
        "id": 511171683,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1744204910
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511157801\">said</a>:</p>\n<blockquote>\n<p>Potentially this opens the door to non-defeq <code>OfNat Œ± 0</code> and <code>OfNat Œ± 1</code> instances, but in practice it doesn't seem onerous, we already do a good job of avoiding these.</p>\n</blockquote>\n<p>I thought the reason we ended up with <code>Nat.AtLeastTwo</code> was precisely because there were some cases where the non-defeq could not be avoided</p>",
        "id": 511174595,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744205544
    },
    {
        "content": "<p>For instance, right now this is not defeq, and so will become an instance diamond with your change:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 511174809,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744205593
    },
    {
        "content": "<p>(this particular case, and many like it, can be fixed by removing <code>irreducible_def</code>s)</p>",
        "id": 511175075,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744205652
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511158253\">said</a>:</p>\n<blockquote>\n<p>The big pay-off is that now most arithmetic types satisfy <code>[‚àÄ n, OfNat Œ± n]</code>, which according to the current proposed design for Grobner bases in <code>grind</code> will be a requirement.</p>\n</blockquote>\n<p>Is there a reason for the design to prefer <code>[‚àÄ n, OfNat Œ± n]</code> over <code>NatCast Œ±</code>?</p>",
        "id": 511175177,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744205680
    },
    {
        "content": "<p>Also, if we want to avoid the diamonds with generic <code>AddMonoidWithOne</code> etc, then we need to replace <code>extends AddMonoid M</code> with all the fields of <code>AddMonoid M</code> that use <code>Nat.cast 0</code> for zero.</p>",
        "id": 511245127,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744225548
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511175075\">said</a>:</p>\n<blockquote>\n<p>(this particular case, and many like it, can be fixed by removing <code>irreducible_def</code>s)</p>\n</blockquote>\n<p>I think, a better example would be some structure <code>MyStruct Œ±</code> that always has <code>Zero</code> and/or <code>One</code>, but has <code>NatCast</code> only if <code>Œ±</code> satisfies some typeclass assumptions.</p>",
        "id": 511245974,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744225885
    },
    {
        "content": "<p>OTOH, in that case we can write a <code>NatCast</code> instance so that <code>Nat.cast 0 = 0</code> and <code>Nat.cast 1 = 1</code> are defeq.</p>",
        "id": 511246099,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744225927
    },
    {
        "content": "<p>BTW, do we care about reducible defeq or semireducible defeq here?</p>",
        "id": 511246261,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744226002
    },
    {
        "content": "<p>E.g., is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NatCast</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">natCast</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">myFunc</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>\n<p>good enough?</p>",
        "id": 511246401,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744226057
    },
    {
        "content": "<p>I'll note that you asked the same question long ago in <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/ofReal_two/near/340944146\">#mathlib4 &gt; ofReal_two @ üí¨</a></p>",
        "id": 511256389,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744230228
    },
    {
        "content": "<p>This time I've reversed <code>NatCast</code> and <code>OfNat</code>. Thanks for the link, I totally forgot about the old discussion!</p>",
        "id": 511261255,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744232309
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511175177\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511158253\">said</a>:</p>\n<blockquote>\n<p>The big pay-off is that now most arithmetic types satisfy <code>[‚àÄ n, OfNat Œ± n]</code>, which according to the current proposed design for Grobner bases in <code>grind</code> will be a requirement.</p>\n</blockquote>\n<p>Is there a reason for the design to prefer <code>[‚àÄ n, OfNat Œ± n]</code> over <code>NatCast Œ±</code>?</p>\n</blockquote>\n<p>Yes, <code>grind</code> is already a huge project, and Leo uses <code>OfNat</code> throughout it. :-) We discussed using <code>NatCast</code> or even <code>IntCast</code> here, but Leo is not keen. It's possible, but seems undesirable to me.</p>",
        "id": 511278059,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744240571
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511174809\">said</a>:</p>\n<blockquote>\n<p>For instance, right now this is not defeq, and so will become an instance diamond with your change:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Yes. I don't think this is a blocker, because we can patch such problems up either with reducibility changes, or just accept that <code>simp</code> is needed here.</p>\n<p>Are you saying that this is a blocker to merging these PRs as is? (That's fine, I just can't tell from your message.)</p>",
        "id": 511278195,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744240662
    },
    {
        "content": "<p>This weekend Leo is working on Grobner, so I need to be able to tell him by Friday one of:</p>\n<ul>\n<li>\"It looks likely we can make this change at Mathlib, and <code>grind</code> can work out of the box with Mathlib types\"</li>\n<li>\"It looks unlikely Mathlib is happy with this change, and we will need to redesign\"</li>\n<li>\"No conclusion yet, sorry, Mathlib discussions ongoing.\"</li>\n</ul>\n<p>:-)</p>",
        "id": 511278385,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744240785
    },
    {
        "content": "<p>If we want to make a decision fast, then let me tag all <span class=\"user-group-mention\" data-user-group-id=\"2494\">@maintainers</span>.</p>",
        "id": 511278546,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744240885
    },
    {
        "content": "<p>I'm writing a wiki page with the description of the issue and different approaches.</p>",
        "id": 511279356,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744241346
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511278195\">said</a>:</p>\n<blockquote>\n<p>Are you saying that this is a blocker to merging these PRs as is? (That's fine, I just can't tell from your message.)</p>\n</blockquote>\n<p>I would consider the presence of any instance diamond a blocker to merging these, yes. Allowing users to end up in a goal state of <code>1 = 1</code> and <code>rfl</code> not working seems like a deal breaker to me.</p>",
        "id": 511280305,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744241870
    },
    {
        "content": "<p>I'm not opposed to removing the <code>irreducible_defs</code>, but I worry that:</p>\n<ul>\n<li>we won't catch them all, and will have a tail of fixes, possibly with performance considerations we didn't plan for</li>\n<li>there are some cases where the diamond is unavoidable</li>\n</ul>",
        "id": 511280468,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744241944
    },
    {
        "content": "<p>Do you have examples of unavoidable diamonds?</p>",
        "id": 511280536,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744241985
    },
    {
        "content": "<p>A metaprogram to check for the presence of a diamond here would be really great! (by comparing synthesis with the new instance and the old one, for everything that implements <code>OfNat</code> in mathlib)</p>",
        "id": 511280612,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744242007
    },
    {
        "content": "<p>We need to change the definitions of <code>AddMonoidWithOne</code> etc, if we want to avoid diamonds for generic types.</p>",
        "id": 511280677,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242048
    },
    {
        "content": "<p>I'm writing about that.</p>",
        "id": 511280686,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242053
    },
    {
        "content": "<p>I think we still run into trouble if someone implements</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>but then goes on to define the <code>AddMonoidWithOne</code> instance (which you're suggesting we remove the <code>one</code> field from) in a different way</p>",
        "id": 511280796,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744242121
    },
    {
        "content": "<p>We should have a metaprogram that tries to generate <code>One</code> and <code>Zero</code> for each <code>NatCast</code>/<code>AddMonoidWithOne</code> instance and checks for defeq.</p>",
        "id": 511280961,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242188
    },
    {
        "content": "<p>I'd make the stronger claim that having such a metaprogram is a pre-requisite for merging the titular PRs</p>",
        "id": 511281158,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744242286
    },
    {
        "content": "<p>First draft: <a href=\"https://github.com/leanprover-community/mathlib4/wiki/RFC:-drop-%60Nat.AtLeastTwo%60\">https://github.com/leanprover-community/mathlib4/wiki/RFC:-drop-%60Nat.AtLeastTwo%60</a></p>",
        "id": 511281208,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242305
    },
    {
        "content": "<p>I won't edit it for the next hour or two, feel free to modify it.</p>",
        "id": 511281251,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242327
    },
    {
        "content": "<p>We will need to modify, e.g., either <code>Ring</code> instance or <code>Zero</code>/<code>One</code> instances for <code>Module.End</code>.</p>",
        "id": 511281613,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242503
    },
    {
        "content": "<p>Are there more complicated types, where it's impossible?</p>",
        "id": 511281660,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242529
    },
    {
        "content": "<p>Okay, I will go back to the drawing board for the prerequisites for <code>grind</code>. :-(</p>\n<p>Probably my next attempt will be to parametrize by <code>[OfNat Œ± 0] [OfNat Œ± 1] [‚àÄ n, OfNat Œ± (n+2)]</code>. Sounds ugly, but might work.</p>",
        "id": 511281867,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744242644
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I would wait for a day. Possibly, we can turn 2nd approach into something that doesn't create diamonds.</p>",
        "id": 511281949,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242694
    },
    {
        "content": "<p><code>Module.End</code> is a nice example, where we really need the defeq <code>1 = id</code> and this change would force us to give-up the non-essential <code>Nat.cast n = n ‚Ä¢ 1</code> defeq</p>",
        "id": 511282059,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744242741
    },
    {
        "content": "<p>Why do we need the defeq <code>1 = id</code>?</p>",
        "id": 511282182,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242806
    },
    {
        "content": "<p>Note: this works</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">inst1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">inst2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">MyNat</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">(</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">inst1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">inst2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 511282257,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242842
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511282182\">said</a>:</p>\n<blockquote>\n<p>Why do we need the defeq <code>1 = id</code>?</p>\n</blockquote>\n<p>Maybe I'm wrong about it being necessary, but certainly this would be a very sad defeq to lose</p>",
        "id": 511282399,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744242904
    },
    {
        "content": "<p>IIRC one of the main non-defeq cases was when the type was a variable, e.g. provided by a <code>Ring</code> instance</p>",
        "id": 511282408,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744242906
    },
    {
        "content": "<p>because we unavoidably had duplicate data in the typeclass coming from the <code>zero</code> instance and the <code>ofNat</code> function</p>",
        "id": 511282459,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744242937
    },
    {
        "content": "<p>We can fix this, if we modify the <code>AddMonoidWIthOne</code></p>",
        "id": 511282479,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744242948
    },
    {
        "content": "<p>(but the fix makes it rather easy to accidentally create diamonds without automation support)</p>",
        "id": 511282562,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744242975
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511281867\">said</a>:</p>\n<blockquote>\n<p>Probably my next attempt will be to parametrize by <code>[OfNat Œ± 0] [OfNat Œ± 1] [‚àÄ n, OfNat Œ± (n+2)]</code>. Sounds ugly, but might work.</p>\n</blockquote>\n<p>If you go this route, it perhaps makes sense to upstream <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=One#doc\">docs#One</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Zero#doc\">docs#Zero</a>, or perhaps even a base class of <code>AddMonoidWithOne</code></p>",
        "id": 511282700,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744243067
    },
    {
        "content": "<p><code>One</code> and <code>Zero</code> are already upstream.</p>",
        "id": 511283373,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744243379
    },
    {
        "content": "<p><code>NatCast</code> too...</p>",
        "id": 511283455,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744243414
    },
    {
        "content": "<p>Yes, but as I said above we don't want to use NatCast or IntCast.</p>",
        "id": 511283498,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744243442
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511283373\">said</a>:</p>\n<blockquote>\n<p><code>One</code> and <code>Zero</code> are already upstream.</p>\n</blockquote>\n<p>According to the docs links, Zero is but One is not!</p>",
        "id": 511283584,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744243489
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511283498\">said</a>:</p>\n<blockquote>\n<p>Yes, but as I said above we don't want to use NatCast or IntCast.</p>\n</blockquote>\n<p>I saw that, but the considered alternatives sound like they might be worse</p>",
        "id": 511283686,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744243543
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511283584\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511283373\">said</a>:</p>\n<blockquote>\n<p><code>One</code> and <code>Zero</code> are already upstream.</p>\n</blockquote>\n<p>According to the docs links, Zero is but One is not!</p>\n</blockquote>\n<p>It's out of date.</p>",
        "id": 511283800,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744243575
    },
    {
        "content": "<p>I have some ideas how we can workaround this. I have family duties for an hour or two, then I write the details.</p>",
        "id": 511283836,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744243594
    },
    {
        "content": "<p>Out of curiosity, is the motivation here primarily about parsing expressions into <code>Nat</code> (for which I think we already have ~5 competing functions that work with the current design), or serializing them back (for which <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Qq.ofNatQ#doc\">docs#Qq.ofNatQ</a> is probably the best mathlib solution, but obviously not one that can be upstreamed).</p>",
        "id": 511284138,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744243749
    },
    {
        "content": "<p>I added some details. Please read and comment.</p>",
        "id": 511293890,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744249139
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/wiki/RFC:-drop-%60Nat.AtLeastTwo%60\">https://github.com/leanprover-community/mathlib4/wiki/RFC:-drop-%60Nat.AtLeastTwo%60</a></p>",
        "id": 511296644,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744250595
    },
    {
        "content": "<p>Just adding some further motivation, pointed out to me by Leo:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">instOfNatAtLeastTwo</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">instNatCast</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">instNatAtLeastTwo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">instOfNatNat</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">))))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n</code></pre></div>\n<p>Ugly, no?</p>\n<p>Moreover, just writing <code>def thirtySeven : ‚Ñù := 30 + 7</code> generates auxiliary declarations <code>thirtySeven._proof_1 : (28 + 2).AtLeastTwo</code> and <code>thirtySeven._proof_2 : (5 + 2).AtLeastTwo</code>, which seems ... a bit heavyweight for just mentioning a numeral. :-)</p>",
        "id": 511297462,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744250961
    },
    {
        "content": "<p>TBH I already had this thought when we introduced <code>OfNat</code> depending on a numeral</p>",
        "id": 511297575,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744251008
    },
    {
        "content": "<p>you have to duplicate the whole typeclass twice in order to derive numerals from a ring or something</p>",
        "id": 511297618,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744251042
    },
    {
        "content": "<p>Technically the second occurrence of <code>OfNat.ofNat</code> there is not required, it is using an OfNat instance on Nat</p>",
        "id": 511297862,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744251161
    },
    {
        "content": "<p>The canonicalizer already special cases <code>OfNat</code> and <code>instOfNatNat</code> applications to prevent an infinite regress of canonicalization, it could also special case <code>instNatAtLeastTwo</code> arguments</p>",
        "id": 511297963,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744251234
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> Could you please add it to the \"Why change?\" section?</p>",
        "id": 511298415,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744251498
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511297963\">said</a>:</p>\n<blockquote>\n<p>The canonicalizer already special cases <code>OfNat</code> and <code>instOfNatNat</code> applications to prevent an infinite regress of canonicalization, it could also special case <code>instNatAtLeastTwo</code> arguments</p>\n</blockquote>\n<p>I don't think it's very likely <code>Nat.AtLeastTwo</code> will ever appear in special casing in Lean! I think we want less of it, not more.</p>",
        "id": 511311005,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744259313
    },
    {
        "content": "<p>I'm content now that I have a design for <code>Lean.Grind.CommRing</code> that satisfies our constraints, and works \"out of the box\" with Mathlib types such as ZMod. Even better, all of the \"suffering\" associated with Mathlib's different treatment of 0, 1, n+2 will live in Mathlib, not Lean. :-)</p>\n<p>The main change (see <a href=\"https://github.com/leanprover/lean4/pull/7870\">lean#7870</a>) is that <code>Lean.Grind.CommRing</code> will take a <em>field</em> <code>[ofNat : ‚àÄ n, OfNat Œ± n]</code> rather than a parameter, and then provide a low priority instance <code>attribute [instance 100] CommRing.ofNat</code>.</p>\n<p>Then in Mathlib (<a href=\"https://github.com/leanprover-community/mathlib4/compare/lean-pr-testing-7873...lean-pr-testing-7870\">https://github.com/leanprover-community/mathlib4/compare/lean-pr-testing-7873...lean-pr-testing-7870</a> is the best diff I can offer right now) we have the slightly suffery:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"bp\">.</span><span class=\"n\">toGrindCommRing</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n<span class=\"w\">    </span><span class=\"n\">add_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_zero</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">neg_add_cancel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">neg_add_cancel</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">mul_one</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_one</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">zero_mul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">zero_mul</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">pow_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">    </span><span class=\"n\">pow_succ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pow_succ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">ofNat_succ</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">zero_add</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">one_add_one_eq_two</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rfl</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">AddCommGroupWithOne</span><span class=\"bp\">.</span><span class=\"n\">natCast_succ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>but then both</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">IsCharP</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p>work out of the box.</p>\n<p>So I will probably merge this soon. We can independently work on lessening our use of <code>AtLeastTwo</code> in Mathlib, but it's no longer going to get in the way of having Grobner bases. :-)</p>",
        "id": 511333539,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744270181
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2323866.20and.20.2323867.2C.20removing.20most.20.60.5BNat.2EAtLeastTwo.20n.5D.60/near/511333539\">said</a>:</p>\n<blockquote>\n<p>and then provide a low priority instance <code>attribute [instance 100] CommRing.ofNat</code>.</p>\n</blockquote>\n<p>Doesn't this introduce all the same diamonds?</p>",
        "id": 511358397,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744277242
    },
    {
        "content": "<p>No (for any specific literal number), because Mathlib's instance does case analysis.</p>",
        "id": 511424793,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744294873
    },
    {
        "content": "<p>What are you referring to by \"mathlib's instance\"? The status quo? <code>CommRing.toGrindCommRing</code>? Or the proposed changes to mathlib?</p>",
        "id": 511428815,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744295763
    },
    {
        "content": "<p>I think the above suggestion amounts to adding</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoidWithOne</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p>to mathlib, though so far I haven't managed to find any diamonds with it</p>",
        "id": 511430512,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744296203
    },
    {
        "content": "<p>I was talking about <code>CommRing.toGrindCommRing</code>.</p>",
        "id": 511449012,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744300586
    },
    {
        "content": "<p>This creates diamonds for an unspecified <code>n</code>, but AFAICT not for any specific numeric literal.</p>",
        "id": 511449205,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744300639
    },
    {
        "content": "<p>BTW, if we add this instance (instead of the current <code>AtLeastTwo</code> one), then Lean core can assume <code>[‚àÄ n, OfNat Œ± n]</code> as an argument.</p>",
        "id": 511545702,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744337799
    }
]