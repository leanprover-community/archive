[
    {
        "content": "<p>For some reason, <a href=\"https://github.com/leanprover-community/mathlib4/pull/23992\">#23992</a> is failing CI because, of all things, it can't add a \"closed-pr\" emoji in Zulip somewhere? I am very confused and looking at the detailed log doesn't much clarify things.</p>",
        "id": 515601459,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746143821
    },
    {
        "content": "<p>I suspect we may be hitting some kind of API limit. Let me ping <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> who may be able to give a quicker answer.</p>\n<p>For now I would say you can ignore that particular red x. That job isn't required to succeed for us to merge your PR anyways.</p>",
        "id": 515607346,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1746146677
    },
    {
        "content": "<p>Mmk. So long as it gets into the review queue -- I've got a backlog ^.^;</p>",
        "id": 515607521,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746146741
    },
    {
        "content": "<p>I agree with Bryan's assessment: the failure is likely due to hitting an API limit (or maybe just some other random transient issue).</p>\n<p>As for it being included in the queue, let me then delegate to <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> since he might know!</p>",
        "id": 515642170,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746164273
    },
    {
        "content": "<p>You can check <a href=\"https://leanprover-community.github.io/queueboard/\">#queueboard</a> to see if it's on the queue</p>",
        "id": 515654724,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1746170554
    },
    {
        "content": "<p>But we all have a backlog, I'm afraid :)</p>",
        "id": 515654758,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1746170570
    },
    {
        "content": "<p>Alas<br>\nAt any rate, I already checked the queue board, it's being held up by CI, which presumably means this specific word thing<br>\nI'll try just re-running CI tho</p>",
        "id": 515654931,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746170645
    },
    {
        "content": "<p>I just verified: the queue includes all PRs whose CI passes. CI failing (for any reason, including network errors, or a non-essential workflow like this one) means a PR is not on the queue.</p>",
        "id": 515655399,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746170856
    },
    {
        "content": "<p>Re-running sounds reasonable</p>",
        "id": 515655430,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746170874
    },
    {
        "content": "<p>One <em>could</em> try to change the definition of \"queue\" to take this into account. For the github-search based qeueue, that will be difficult - for the queueboard, that's not hard.</p>",
        "id": 515655585,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746170930
    },
    {
        "content": "<p>The queueboard already has a notion of \"inessential CI jobs which fail\". (It was missing this one workflow, which I just added - thanks for making me look!) One <em>could</em> have a bot which looks \"are there any such PRs\" and posts on zulip, so people could take a look quickly.</p>",
        "id": 515655696,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746170997
    },
    {
        "content": "<p>... Mm. Nope, it fails even on rerunning.</p>",
        "id": 515655932,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746171085
    },
    {
        "content": "<p>The error says something about \"malformed API key\". That doesn't look like a network failure; if it's a rate limit, the error is extremely bad.</p>",
        "id": 515656120,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746171153
    },
    {
        "content": "<p>Update. The PR now appears on <a href=\"https://leanprover-community.github.io/queueboard/help_out.html#inessential-CI-fails\">this dashboard</a></p>",
        "id": 515656165,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746171175
    },
    {
        "content": "<p>I think that this is an error that other times I interpreted as API limits.</p>",
        "id": 515656182,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171184
    },
    {
        "content": "<p>However, this action is hard to re-run, since I am not sure that clicking on \"re-run job\" actually does anything.</p>",
        "id": 515656256,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171219
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/Add.20.22closed-pr.22.20emoji.20in.20Zulip.3F/near/515656165\">said</a>:</p>\n<blockquote>\n<p>Update. The PR now appears on <a href=\"https://leanprover-community.github.io/queueboard/help_out.html#inessential-CI-fails\">this dashboard</a></p>\n</blockquote>\n<p>I'll take it! (Though if anyone finds something I can do to fix it properly, please let me know!)</p>",
        "id": 515656368,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746171267
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/Add.20.22closed-pr.22.20emoji.20in.20Zulip.3F/near/515656256\">said</a>:</p>\n<blockquote>\n<p>However, this action is hard to re-run, since I am not sure that clicking on \"re-run job\" actually does anything.</p>\n</blockquote>\n<p>Would rerunning all jobs change anything?</p>",
        "id": 515656397,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746171286
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/workflows/zulip_emoji_closed_pr.yaml\">This</a> should be the list of all the times that this script ran.  I had \"re-run\" it earlier, but it does not appear in the list above.</p>",
        "id": 515656447,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171311
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"359992\">Robert Maxton</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/Add.20.22closed-pr.22.20emoji.20in.20Zulip.3F/near/515656397\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/Add.20.22closed-pr.22.20emoji.20in.20Zulip.3F/near/515656256\">said</a>:</p>\n<blockquote>\n<p>However, this action is hard to re-run, since I am not sure that clicking on \"re-run job\" actually does anything.</p>\n</blockquote>\n<p>Would rerunning all jobs change anything?</p>\n</blockquote>\n<p>I am not sure, since this job runs only when a PR is <code>closed</code> or <code>reopened</code>.  In fact, I am not sure why it even triggered on your PR.</p>",
        "id": 515656611,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171374
    },
    {
        "content": "<p>.... Ah. I think this might have been one of the PRs I accidentally first contributed to my own fork and attempted to merge from there.<br>\nOr, at least, maybe it shared a branch name with such a PR? I've been using <code>robertmaxton/quiv-helpersN</code> in order, so it's possible I reused a number when I thought a previous PR had been canceled/closed</p>",
        "id": 515656993,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746171542
    },
    {
        "content": "<p>I shall endeavor not to do do so in the future :wry:</p>",
        "id": 515657046,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746171573
    },
    {
        "content": "<p>That may explain why the action tried to run in the first place.  Maybe then the API failure could be that the token it used came from your fork, which is not the one that the mathlib CI was expecting.</p>",
        "id": 515657186,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171624
    },
    {
        "content": "<p>This would make the error message be more pertinent as well.  It all seems to line up!</p>",
        "id": 515657215,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171642
    },
    {
        "content": "<p>Mm, maybe. If that's the case it needs to have somehow remembered the wrong token even after I closed and reopened the PR properly -- the CI doesn't actually support merges from forks<br>\nIf there's a mechanism for that, then yeah, it lines up.</p>",
        "id": 515657431,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746171745
    },
    {
        "content": "<p>It is always hard to fully understand CI, but the \"troubled history\" of this PR is a likely explanation for why things are failing.  Very likely, it would be possible to catch these issues and be more graceful about them, but I would not really know how to do that...</p>",
        "id": 515657742,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171871
    },
    {
        "content": "<p><em>nodnod</em> Fair enough, then</p>",
        "id": 515657766,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746171887
    },
    {
        "content": "<p>Besides, I think that getting some mechanism on the <a href=\"https://leanprover-community.github.io/queueboard/\">#queueboard</a> to list the PRs for which the \"relevant\" CI checks are successful is definitely a good outcome!</p>",
        "id": 515657888,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171940
    },
    {
        "content": "<p>This means that the error emitted by the emoji script is noticed, can be reviewed, but the PR is still \"where it needs to be\" in terms of reviewing.</p>",
        "id": 515657994,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171977
    },
    {
        "content": "<p>The review can be, as in this case, \"let it go\"!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 515658043,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746171998
    },
    {
        "content": "<p>Let me repeat to ensure I understood correctly: you're proposing to change the definition of the queueboard queue, from \"CI passes\" to \"CI passes or there are only inessential failures\", right?</p>",
        "id": 515658706,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746172255
    },
    {
        "content": "<p>Well, already your \"spurious job failure\" is a good place!  In fact, if this PR were to be merged, I think that bors would ignore this failure: it will do its checks and would not look at the fact that this job failed.</p>",
        "id": 515659055,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746172391
    },
    {
        "content": "<p>Ah, ok! So the only thing that might be missing is surfacing spurious CI errors earlier?</p>",
        "id": 515659212,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746172454
    },
    {
        "content": "<p>How difficult is it to write a workflow that</p>\n<ul>\n<li>downloads a json file from somewhere</li>\n<li>checks if that contains any PRs</li>\n<li>if it does, posts a message on zulip?</li>\n</ul>\n<p>Having the queueboard generate a json file with spurious CI failures is easy for me, but I'd need help with the other half.</p>",
        "id": 515659337,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746172510
    },
    {
        "content": "<p>There are many scripts already that post messages on Zulip, so the second half should be ok as well.  At least if you do not want the message to contain a backtick.</p>",
        "id": 515659573,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746172618
    },
    {
        "content": "<p>No, backticks should not be necessary.</p>",
        "id": 515659678,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746172662
    },
    {
        "content": "<p>Here is a sample from <code>.github/workflows/maintainer_merge.yml</code>.</p>\n<div class=\"codehilite\" data-code-language=\"yml\"><pre><span></span><code>      - name: Send message on Zulip\n        if: ${{ ! steps.merge_or_delegate.outputs.mOrD == '' }}\n        uses: zulip/github-actions-zulip/send-message@e4c8f27c732ba9bd98ac6be0583096dea82feea5 # v1.0.2\n        with:\n          api-key: ${{ secrets.ZULIP_API_KEY }}\n          email: 'github-mathlib4-bot@leanprover.zulipchat.com'\n          organization-url: 'https://leanprover.zulipchat.com'\n          to: 'mathlib reviewers'\n          type: 'stream'\n          topic: ${{ steps.determine_topic.outputs.topic }}\n          content: ${{ steps.form_the_message.outputs.title }}\n</code></pre></div>\n<p>It should be clear what the various fields are.  In this case, <code>topic</code> and <code>content</code> were determined by other scripts in the previous CI steps.</p>",
        "id": 515660305,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746172916
    },
    {
        "content": "<p>Maybe we should modify instructions to users from \"please reopen this PR from a branch not a fork\" to \"... and also ensure that you use a new branch name\"</p>",
        "id": 516003514,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746344565
    },
    {
        "content": "<p>I think we saw this phenomenon at least once before</p>",
        "id": 516003609,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746344646
    },
    {
        "content": "<p>As a side note, I checked and can confirm that this was indeed the PR that was originally from a fork.</p>",
        "id": 516360012,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1746513436
    },
    {
        "content": "<p>Oh, is it then actually the branch name that's the issue or that both PRs are made with the exact same commit hash?</p>",
        "id": 516366636,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1746515875
    },
    {
        "content": "<p>Oh my bet is on the commit hash being the thing which confuses github, I think that was the issue before. Sorry for the noise.</p>",
        "id": 516621124,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746609699
    }
]