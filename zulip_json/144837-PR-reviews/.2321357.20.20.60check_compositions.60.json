[
    {
        "content": "<p>I was just looking at <span class=\"user-mention\" data-user-id=\"459699\">@Joël Riou</span>'s <a href=\"https://github.com/leanprover-community/mathlib4/pull/18976\">#18976</a> on enrichment of functor categories, and investigating the appearance of an <code>erw</code> there. I'm not certain whether that <code>erw</code> is appropriate or not, but I did write a small tool for re-type-checking categorical compositions in the goal, and reporting whether sources and targets of morphisms match up, at \"reducible and instances\" transparency, with the \"declared\" sources and targets in <code>CategoryStruct.comp _ _ X Y Z f g</code>.</p>",
        "id": 497304753,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738540869
    },
    {
        "content": "<p><del>Also -- I need a mechanism to enforce that people don't leave this tactic in proof scripts (it is silent it if doesn't find any problems). Perhaps I should just make sure it is always noisy, i.e. report \"No discrepancies found\".</del> (The <code>unusedTactic</code> linter already handles this.)</p>",
        "id": 497304834,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738540915
    },
    {
        "content": "<p>This tool is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/21357\">#21357</a> as <code>check_compositions</code>.</p>",
        "id": 497304940,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738540952
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"459699\">@Joël Riou</span> and <span class=\"user-mention\" data-user-id=\"519559\">@Dagur Asgeirsson</span>, I'd be interested to hear your opinions about whether we can do something better with this defeq, and whether <code>check_compositions</code> is reporting the relevant problem here.</p>",
        "id": 497304947,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738540955
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span> and <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span>, if either of you wanted to investigate if this tool is actually useful in practice at <code>erw</code> sites in the category theory library, that would be very helpful. :-)</p>",
        "id": 497304948,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738540957
    },
    {
        "content": "<p>Suggestions for generalizations of the tool, if it is useful, might be good as well.</p>",
        "id": 497304951,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738540958
    },
    {
        "content": "<p>As an example, after the first <code>dsimp</code> in the <a href=\"https://github.com/leanprover-community/mathlib4/pull/18976/files#diff-f312a031d32dcaa3697b57219e9a0abceaa66865e64310e2af2d8b0bbc10aeaaR359\">first  <code>erw</code> proof</a> in <a href=\"https://github.com/leanprover-community/mathlib4/pull/18976\">#18976</a>, <code>check_compositions</code> reports:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">In</span><span class=\"w\"> </span><span class=\"n\">composition</span>\n<span class=\"w\">  </span><span class=\"n\">enrichedId</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">precompEnrichedHom</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span>\n<span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">of</span>\n<span class=\"w\">  </span><span class=\"n\">precompEnrichedHom</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span>\n<span class=\"n\">is</span>\n<span class=\"w\">  </span><span class=\"n\">enrichedHom</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span>\n<span class=\"w\">  </span><span class=\"n\">enrichedHom</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j'</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Under</span><span class=\"bp\">.</span><span class=\"n\">forget</span><span class=\"w\"> </span><span class=\"n\">j'</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">F₁</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 497306022,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738541641
    },
    {
        "content": "<p>That looks very nice, I'll definitely be trying it out as I go through the concrete category cleanup!</p>",
        "id": 497390778,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738578396
    }
]