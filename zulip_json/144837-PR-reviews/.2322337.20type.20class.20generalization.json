[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22337\">#22337</a> is a large change automatically applying type class generalization across mathlib. This is about half of the total such changes I have to contribute. In <a href=\"#narrow/channel/287929-mathlib4/topic/Elab.20to.20generalize.20type.20classes.20for.20theorems/near/501288855\">this thread</a> it was suggested I just open a large change rather than trying to e.g. split it by directory, but if anyone has feedback on ways to make this easier/better to review I'm all ears.</p>\n<p>I will soon have some small spin-off PRs applying small fix-ups that I found didn't apply cleanly (e.g. causing linter warnings or triggered some linter edge case). I will mention them here when they're ready.</p>",
        "id": 503208758,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741077581
    },
    {
        "content": "<p>I had a go at reviewing this PR, but had to give up, because (in my browser at least) the GitHub \"Files changed\" screen  slows down to the point of utter unusability for PRs that touch this many files. I'd recommend splitting it up.</p>",
        "id": 503269357,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741095449
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322337.20type.20class.20generalization/near/503269357\">said</a>:</p>\n<blockquote>\n<p>I had a go at reviewing this PR, but had to give up, because (in my browser at least) the GitHub \"Files changed\" screen  slows down to the point of utter unusability for PRs that touch this many files. I'd recommend splitting it up.</p>\n</blockquote>\n<p>If you use the \"viewed files\" feature, that should never happen</p>",
        "id": 503270198,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1741095659
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> could you please comment on how the diff was created? I know you used metaprogramming to find the lemmas that can be generalized. But did you also use automation to create the diff?</p>",
        "id": 503270210,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741095662
    },
    {
        "content": "<p>If so, that might influence how reviewers will inspect the changes. (E.g. review the tool that created the diff, instead of the diff itself.)</p>",
        "id": 503270366,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741095700
    },
    {
        "content": "<p>The linter offers \"Try this\" suggestions in the IDE, but since clicking hundreds of times would be tedious, I have some debug output that I then use a script to apply the changes</p>",
        "id": 503270595,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741095756
    },
    {
        "content": "<p>Sounds great!</p>",
        "id": 503270876,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741095834
    },
    {
        "content": "<p>Would you mind sharing the script, and adding the explanation of how you generated the diff to the PR commit message?</p>",
        "id": 503270998,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741095858
    },
    {
        "content": "<p>I think since the linter is fairly new, this PR should probably get a fair amount of review outside of reviewing the linter since there are a lot of things that may be wrong, e.g. one thing <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>  noted is that sometimes I offered generalizations that are pointless, e.g. Module R M where R=Ring and the 'generalization' was M=AddCommGroup-&gt;AddCommMonoid. This particular generalization is now filtered out, but I don't know if there are other similar 'generalizations' I should be filtering out.</p>\n<p>That said, I would of course be happy to share more about the linter and how I generated the changes. Note that there are a couple of follow-up commits on that PR fixing small issues (mostly reverting changes but also some cases where I had to delete an additional type class to satisfy the unusedArguments linter.) I will expand on the commit message, and put up a side-branch that is not yet-ready-for-review with the linter and the script.</p>",
        "id": 503271872,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741096076
    },
    {
        "content": "<p>I think splitting by top level directory might be a good idea after all, assuming the changes to files don't interact with each other</p>",
        "id": 503277557,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741097494
    },
    {
        "content": "<p>(Or splitting by the kind of generalisation you making.)</p>",
        "id": 503277916,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1741097569
    },
    {
        "content": "<p>Yes, a PR for everything that remove a <code>Comm</code> would be a natural candidate, etc</p>",
        "id": 503279776,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741098022
    },
    {
        "content": "<p>There are a few types of generalizations that reoccur repeatedly, and then a long tail of them that don't. For the ones that do reoccur, I will break out some PRs. After that, I'll take a look at what remains and perhaps that can be done by top-level dir.</p>",
        "id": 503289615,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741100435
    },
    {
        "content": "<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>A long list for that anyone wants to look</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>50 Semiring -&gt; NonAssocSemiring<br>\n  27 AddMonoid -&gt; AddZeroClass<br>\n  26 Ring -&gt; Semiring<br>\n  25 Monoid -&gt; MulOneClass<br>\n  24 Module -&gt; DistribMulAction<br>\n  22 PartialOrder -&gt; Preorder<br>\n  21 CommRing -&gt; Ring<br>\n  20 Preorder -&gt; LE<br>\n  19 IsDedekindDomain -&gt; IsDedekindRing<br>\n  14 Field -&gt; DivisionRing<br>\n  11 CommSemigroup -&gt; CommMagma<br>\n  11 CommRing -&gt; Semiring<br>\n  11 AddCommMonoid -&gt; AddZeroClass<br>\n   9 Semiring -&gt; NonUnitalNonAssocSemiring<br>\n   8 Semiring -&gt; Monoid<br>\n   8 Preorder -&gt; LT<br>\n   8 MulOneClass -&gt; Mul<br>\n   8 MonoidHomClass -&gt; MulHomClass<br>\n   8 CommSemiring -&gt; Semiring<br>\n   8 AddCommMonoid -&gt; AddMonoid<br>\n   8 AddCommGroup -&gt; AddGroup<br>\n   7 NonAssocSemiring -&gt; NonUnitalNonAssocSemiring<br>\n   7 IsTopologicalGroup -&gt; ContinuousMul<br>\n   7 DistribMulAction -&gt; MulAction<br>\n   6 MulAction -&gt; SMul<br>\n   6 Monoid -&gt; Mul<br>\n   6 Module -&gt; SMul<br>\n   6 LinearOrder -&gt; Preorder<br>\n   6 LinearOrder -&gt; PartialOrder<br>\n   6 Field -&gt; CommRing<br>\n   6 DirectSum.GRing -&gt; DirectSum.GSemiring<br>\n   5 StarAddMonoid -&gt; Star<br>\n   5 Semiring -&gt; MonoidWithZero<br>\n   5 SemilatticeInf -&gt; PartialOrder<br>\n   5 RCLike -&gt; NormedField<br>\n   5 NonUnitalRing -&gt; NonUnitalNonAssocRing<br>\n   5 MetricSpace -&gt; PseudoMetricSpace<br>\n   5 LinearOrderedSemiring -&gt; StrictOrderedSemiring<br>\n   5 IsTopologicalSemiring -&gt; ContinuousMul<br>\n   5 IsTopologicalRing -&gt; IsTopologicalSemiring<br>\n   5 IsDomain -&gt; Nontrivial<br>\n   5 DistribMulAction -&gt; SMul<br>\n   4 MulZeroClass -&gt; Zero<br>\n   4 Module -&gt; MulAction<br>\n   4 IsDomain -&gt; IsCancelMulZero<br>\n   3 T35Space -&gt; CompletelyRegularSpace<br>\n   3 SemilatticeSup -&gt; PartialOrder<br>\n   3 Semigroup -&gt; Mul<br>\n   3 SMulWithZero -&gt; SMulZeroClass<br>\n   3 Ring -&gt; AddGroupWithOne<br>\n   3 PartialOrder -&gt; LE<br>\n   3 MonoidWithZero -&gt; MulZeroOneClass<br>\n   3 MonoidWithZero -&gt; MulZeroClass<br>\n   3 LinearOrderedRing -&gt; StrictOrderedRing<br>\n   3 IsTopologicalGroup -&gt; ContinuousInv<br>\n   3 IsTopologicalAddGroup -&gt; ContinuousNeg<br>\n   3 IsTopologicalAddGroup -&gt; ContinuousAdd<br>\n   3 IsOrderedCancelSMul -&gt; IsOrderedSMul<br>\n   3 DivisionSemiring -&gt; GroupWithZero<br>\n   3 DistribSMul -&gt; SMulZeroClass<br>\n   3 ConnectedSpace -&gt; PreconnectedSpace<br>\n   3 Algebra -&gt; SMul<br>\n   3 AddZeroClass -&gt; Add<br>\n   3 AddMonoidWithOne -&gt; NatCast<br>\n   3 AddGroup -&gt; SubNegMonoid<br>\n   3 AddGroup -&gt; AddMonoid<br>\n   3 AddCommSemigroup -&gt; AddCommMagma<br>\n   3 AddCommMonoid -&gt; Zero<br>\n   3 AddCommGroup -&gt; AddCommMonoid<br>\n   2 ValuationRing -&gt; PreValuationRing<br>\n   2 SubNegZeroMonoid -&gt; NegZeroClass<br>\n   2 StarRing -&gt; Star<br>\n   2 Semiring -&gt; MulZeroClass<br>\n   2 Semiring -&gt; AddMonoidWithOne<br>\n   2 SMulWithZero -&gt; SMul<br>\n   2 RingHomClass -&gt; MonoidWithZeroHomClass<br>\n   2 RingHomClass -&gt; MonoidHomClass<br>\n   2 Ring -&gt; MulZeroClass<br>\n   2 NormedAlgebra -&gt; Algebra<br>\n   2 NontriviallyNormedField -&gt; NormedField<br>\n   2 NonUnitalSemiring -&gt; NonUnitalNonAssocSemiring<br>\n   2 NonUnitalRing -&gt; NonUnitalSemiring<br>\n   2 NonUnitalNonAssocSemiring -&gt; MulZeroClass<br>\n   2 NonAssocSemiring -&gt; AddMonoidWithOne<br>\n   2 Monoid -&gt; Semigroup<br>\n   2 LinearOrderedCommGroupWithZero -&gt; LinearOrderedCommMonoidWithZero<br>\n   2 LinearOrder -&gt; LT<br>\n   2 IsWellOrder -&gt; IsWellFounded<br>\n   2 IsTopologicalRing -&gt; ContinuousMul<br>\n   2 IsCancelAdd -&gt; IsLeftCancelAdd<br>\n   2 Group -&gt; Inv<br>\n   2 Field -&gt; Ring<br>\n   2 EMetricSpace -&gt; PseudoEMetricSpace<br>\n   2 DirectSum.GRing -&gt; GradedMonoid.GOne<br>\n   2 CommSemiring -&gt; Mul<br>\n   2 CommMonoid -&gt; One<br>\n   2 CommMonoid -&gt; MulOneClass<br>\n   2 CommMonoid -&gt; Monoid<br>\n   2 BoundedOrder -&gt; OrderBot<br>\n   2 AddZeroClass -&gt; Zero<br>\n   2 AddTorsor -&gt; VAdd<br>\n   2 AddMonoid -&gt; Zero<br>\n   2 AddGroup -&gt; AddSemigroup<br>\n   1 T3Space -&gt; RegularSpace<br>\n   1 SubsemiringClass -&gt; SubmonoidClass<br>\n   1 StarRing -&gt; StarMul<br>\n   1 Semiring -&gt; MulZeroOneClass<br>\n   1 Semiring -&gt; Distrib<br>\n   1 SeminormedAddCommGroup -&gt; PseudoMetricSpace<br>\n   1 SemilatticeSup -&gt; Preorder<br>\n   1 Semifield -&gt; CommSemiring<br>\n   1 Ring -&gt; NonUnitalNonAssocSemiring<br>\n   1 Ring -&gt; NonAssocSemiring<br>\n   1 Ring -&gt; Monoid<br>\n   1 Ring -&gt; AddCommGroup<br>\n   1 RCLike -&gt; DenselyNormedField<br>\n   1 OrderedRing -&gt; OrderedAddCommGroup<br>\n   1 OrderedCommSemiring -&gt; OrderedSemiring<br>\n   1 OrderedCancelCommMonoid -&gt; OrderedCommMonoid<br>\n   1 NormedSpace -&gt; SMul<br>\n   1 NormedSpace -&gt; Module<br>\n   1 NormedAddCommGroup -&gt; AddCommGroup<br>\n   1 NonUnitalNonAssocSemiring -&gt; AddCommMonoid<br>\n   1 NonUnitalNonAssocRing -&gt; AddGroup<br>\n   1 NonAssocSemiring -&gt; MulZeroOneClass<br>\n   1 NonAssocRing -&gt; NonAssocSemiring<br>\n   1 MonoidWithZeroHomClass -&gt; ZeroHomClass<br>\n   1 MonoidWithZero -&gt; Monoid<br>\n   1 MonoidHomClass -&gt; OneHomClass<br>\n   1 LinearOrderedCommRing -&gt; StrictOrderedRing<br>\n   1 LinearOrderedAddCommMonoid -&gt; Add<br>\n   1 IsWellOrder -&gt; IsTrichotomous<br>\n   1 IsWellOrder -&gt; IsTrans<br>\n   1 IsTopologicalRing -&gt; ContinuousAdd<br>\n   1 IsCancelAdd -&gt; IsRightCancelAdd<br>\n   1 IrreducibleSpace -&gt; PreirreducibleSpace<br>\n   1 Group -&gt; MulOneClass<br>\n   1 Group -&gt; Monoid<br>\n   1 Group -&gt; DivInvMonoid<br>\n   1 DivisionCommMonoid -&gt; InvolutiveInv<br>\n   1 DivisionCommMonoid -&gt; Div<br>\n   1 DenselyNormedField -&gt; NormedField<br>\n   1 ConditionallyCompleteLinearOrder -&gt; ConditionallyCompleteLattice<br>\n   1 CompleteLattice -&gt; SupSet<br>\n   1 CompleteLattice -&gt; InfSet<br>\n   1 CompleteLattice -&gt; CompleteSemilatticeSup<br>\n   1 CommSemiring -&gt; NonAssocSemiring<br>\n   1 CommSemiring -&gt; CommMonoid<br>\n   1 CommSemiring -&gt; AddCommMonoidWithOne<br>\n   1 CommSemigroup -&gt; Mul<br>\n   1 CommRing -&gt; Zero<br>\n   1 CommRing -&gt; NonUnitalNonAssocSemiring<br>\n   1 CommRing -&gt; AddCommGroup<br>\n   1 CommMonoidWithZero -&gt; SemigroupWithZero<br>\n   1 CommMonoidWithZero -&gt; MonoidWithZero<br>\n   1 CommGroupWithZero -&gt; GroupWithZero<br>\n   1 CommGroup -&gt; Monoid<br>\n   1 CancelCommMonoidWithZero -&gt; CommMonoidWithZero<br>\n   1 AddMonoidHomClass -&gt; ZeroHomClass<br>\n   1 AddGroupWithOne -&gt; IntCast<br>\n   1 AddGroupWithOne -&gt; AddMonoidWithOne<br>\n   1 AddGroup -&gt; Neg<br>\n   1 AddCommSemigroup -&gt; Add<br>\n   1 AddCommGroupWithOne -&gt; AddGroupWithOne<br>\n   1 AddCommGroup -&gt; Zero<br>\n   1 AddCancelMonoid -&gt; AddLeftCancelMonoid</p>\n</div></div>",
        "id": 503290177,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741100578
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322337.20type.20class.20generalization/near/503270198\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322337.20type.20class.20generalization/near/503269357\">said</a>:</p>\n<blockquote>\n<p>I had a go at reviewing this PR, but had to give up, because (in my browser at least) the GitHub \"Files changed\" screen  slows down to the point of utter unusability for PRs that touch this many files. I'd recommend splitting it up.</p>\n</blockquote>\n<p>If you use the \"viewed files\" feature, that should never happen</p>\n</blockquote>\n<p>I don't understand – the browser is already borderline unusable as soon as I open the \"Files changed\" page, this is before the \"Viewed\" box is even displayed.</p>",
        "id": 503321277,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741108347
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22566\">#22566</a> CommRing -&gt; Ring/Semiring</p>",
        "id": 503342314,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741114909
    },
    {
        "content": "<p>I've realized submitting these on a fine-grained basis is difficult since there are lots of linter failures interspersed and it takes a long to do rebuilds to check for them. So I'm going to submit some PRs that just include a mish-mash of generalizations that happen to cause linter failures because otherwise trying to split this up will be a nightmare for me.</p>",
        "id": 503342533,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741114974
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22569\">#22569</a> Generalize *Order type classes</p>",
        "id": 503347268,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741116496
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22570\">#22570</a> Generalizations that triggered the long line linter</p>",
        "id": 503347487,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741116576
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22571\">#22571</a> A single generalization that requires a downstream fixup</p>",
        "id": 503360406,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741120921
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Module and Algebra are two common type classes that relate the types of their arguments that make naive generalizations like the one I'm generating potentially inappropriate. Can you think of other type classes with this pattern?</p>",
        "id": 503367631,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741123696
    },
    {
        "content": "<p>Yes, sometimes <code>IsAddCancel</code> is undesirable to generalize to the left or right version</p>",
        "id": 503368283,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741123882
    },
    {
        "content": "<p>Because usually the proof works for either case, and has to pick a side arbitrarily</p>",
        "id": 503368410,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741123921
    },
    {
        "content": "<p>I see only 3 of these but I'll note it to filter it out</p>",
        "id": 503368637,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741123995
    },
    {
        "content": "<p>I'm a little worried that to make this linter work in a generic way will require a lot of hacky rules, but so far if I just have to custom handle Module/Algebra and filter out a couple of type classes that's ok</p>",
        "id": 503368760,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741124034
    },
    {
        "content": "<p>We could have a <code>no_generalize</code> notation to mark the places where not to make the generalizations</p>",
        "id": 503370122,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741124541
    },
    {
        "content": "<p>Yes I currently use <code>set_option linter.generalizeTypeClass false in</code> in one place already in my local dev branch (explained why in the comment for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Int.cast_neg_natCast#doc\">docs#Int.cast_neg_natCast</a>), but I'd rather not have to sprinkle that around. Plus that relies on the Algebra being explicit next to the Ring type and easy to spot, but sometimes it's in a variable block far away.</p>",
        "id": 503370388,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741124651
    },
    {
        "content": "<p>I am not familiar with the mathematics enough but this seems like another example of something to filter out:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">-</span><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsTopologicalRing</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">→ₐ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">≃ₜ</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span>\n<span class=\"bp\">+</span><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsTopologicalSemiring</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">→ₐ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Does it ever make sense to have a topological semiring structure over a ring?</p>",
        "id": 503371850,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741125247
    },
    {
        "content": "<p>I've marked <a href=\"https://github.com/leanprover-community/mathlib4/pull/22566\">#22566</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/22570\">#22570</a> draft for now</p>",
        "id": 503371881,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741125263
    },
    {
        "content": "<p>Yes, I think <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsTopologicalSemiring#doc\">docs#IsTopologicalSemiring</a> suggests avoiding that combination</p>",
        "id": 503374140,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741126090
    },
    {
        "content": "<p>Another way we could handle this is to write linters that test for these meaningless generalizations, and then have your tool refuse to generalize them if the results give a linter warning</p>",
        "id": 503374231,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741126138
    },
    {
        "content": "<p>That's a good idea, that would work. Let me put it on the list to give it a shot</p>",
        "id": 503374445,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741126216
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsTopologicalSemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">IsTopologicalRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">    </span><span class=\"n\">continuous_neg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"n\">suffices</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">        </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span>\n<span class=\"w\">      </span><span class=\"n\">fun_prop</span>\n</code></pre></div>\n<p>so this is another bad change (oh Eric said this as I was proving it)</p>",
        "id": 503374454,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741126220
    },
    {
        "content": "<p>Maybe this is a design wart in mathlib; why can't we drop the Ring version entirely?</p>",
        "id": 503393853,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741135167
    },
    {
        "content": "<p>Why do we want to avoid these vacuous generalizations? For pedagogical reasons? Or do we expect them to cause a net slowdown? Sure, every semiring that is an algebra over a ring is itself a ring. But if the proof doesn't use the negation/subtraction, is it really evil to state the result using <code>Semiring</code>?</p>",
        "id": 503427701,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741153003
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22582\">#22582</a> is another small PR specifically targeting generalizations that cause linter failures: in this case generalizing some class causes type classes in <code>variable</code> blocks to go unused.</p>",
        "id": 503442328,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1741160405
    },
    {
        "content": "<p>It looks like there is a design decision to be made here, but note that the two running examples we have are different in the following sense: if we only demand <code>IsTopologicalSemiring</code> and then later on need <code>IsTopologicalRing</code> then this only involves adding a proof. But if we have <code>[Ring R] [AddCommMonoid M] [Module R M]</code> and later on need <code>[AddCommGroup M]</code> then we have to create data which you could imagine might form a diamond. I think Johan's question is: \"why not go down to monoids in precisely the cases where there is no risk of a diamond\" and perhaps the main argument against is loss of mathematical readability, which isn't much of an argument.</p>",
        "id": 503446506,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741162078
    },
    {
        "content": "<p>I also think that creating the <code>sub</code>/<code>neg</code> fields is likely to cause issues.  The proofs seem less trouble.</p>",
        "id": 503447124,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741162297
    },
    {
        "content": "<p>I think the proposal is that we drop the AddCommGroup hypothesis precisely when the sub/neg fields are not created at all.</p>",
        "id": 503450753,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741163528
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2322337.20type.20class.20generalization/near/503393853\">said</a>:</p>\n<blockquote>\n<p>Maybe this is a design wart in mathlib; why can't we drop the Ring version entirely?</p>\n</blockquote>\n<p>Because Kevin made it too easy. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsTopologicalRing#doc\">docs#IsTopologicalRing</a> doesn't require unital rings. This is not a design wart.</p>",
        "id": 503779577,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1741263933
    },
    {
        "content": "<p>Just to check I've understood you -- you are sometimes in a situation where you want to demand that negation is continuous (and in particular you have a negation) but you don't have a 1 so you can't get it from multiplication being continuous?</p>",
        "id": 503784946,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741265472
    },
    {
        "content": "<p>Sorry, just seeing this. Yes, that's correct Kevin.</p>",
        "id": 505311748,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1741838170
    },
    {
        "content": "<p>Classic example: the non-unital ring of compactly supported continuous functions.</p>",
        "id": 505311987,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1741838282
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322337.20type.20class.20generalization/near/503374231\">said</a>:</p>\n<blockquote>\n<p>Another way we could handle this is to write linters that test for these meaningless generalizations, and then have your tool refuse to generalize them if the results give a linter warning</p>\n</blockquote>\n<p>It seems that mathlib has some cases where it triggers the 'meaningless generalizations' checks, but they're rare enough that this can still be a useful tool for my generalizer. It may require fixing mathlib before trying to use it as its own linter, but I'm not going to try to make it separate right now. Some examples:</p>\n<ul>\n<li>Ring + AddCommMonoid over a Module (~30 failures): examples <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Module/Defs.html#smul_add_one_sub_smul\">1</a> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Analysis/Normed/Operator/Compact.html#IsCompactOperator.isCompact_closure_image_of_isVonNBounded'\">2</a></li>\n<li>Algebra over a ring where the center is a semiring (~dozen failures): examples <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/RingTheory/Localization/FractionRing.html#algebraMap_injective_of_field_isFractionRing\">1</a>  <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/LinearAlgebra/LinearIndependent/Lemmas.html#linearIndependent_algHom_toLinearMap'\">2</a></li>\n<li>IsTopologicalSemiring + Ring: There are only 3 failures, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsTopologicalSemiring.toIsTopologicalRing#doc\">docs#IsTopologicalSemiring.toIsTopologicalRing</a> seems correct, and <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/ContinuousMap/StoneWeierstrass.html#ContinuousMapZero.mul_nonUnitalStarAlgHom_apply_eq_zero\">1</a> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/ContinuousMap/StoneWeierstrass.html#ContinuousMapZero.nonUnitalStarAlgHom_apply_mul_eq_zero\">2</a> seem like they may be wrong.</li>\n</ul>",
        "id": 505841169,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742040030
    },
    {
        "content": "<p>I am currently confused about whether these \"mathematically meaningless generalizations\" are a bad idea or not. Initially I thought they would cause trouble somehow, but I cannot find an explicit example. The thing we don't really want to have to do is to <em>deduce</em> that an AddCommMonoid which is a module over a ring is actually an AddCommGroup, but these examples are not doing this -- they seem to be making our life easier rather than harder.</p>",
        "id": 505858039,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742052421
    },
    {
        "content": "<p>I think they're just meaningless, not harmful. So it may not make sense to go through the code base and get rid of cases like this for no benefit, though it's relevant to me, because I think my code should not offer suggestions that don't actually increase generality, though it complicates the implementation.</p>",
        "id": 505858647,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742052836
    },
    {
        "content": "<p>I've marked <a href=\"https://github.com/leanprover-community/mathlib4/pull/22566\">#22566</a> ready for review again, it's ~25 cases of CommRing -&gt; Ring/Semiring</p>",
        "id": 505863770,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742056408
    },
    {
        "content": "<p>I think that your \"mathematically meaningless\" changes might be actively helpful, because if you're only asking that M be a monoid rather than a group you might be asking typeclass inference an easier question.</p>",
        "id": 505864260,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742056789
    },
    {
        "content": "<p>I think this is usually a harder question for typeclass inference, actually, since now TC search needs to apply one more forgetful instance than before</p>",
        "id": 505864920,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1742057238
    },
    {
        "content": "<p>Furthermore, I have occasionally done refactors where I needed to turn <code>[Ring R] [AddCommMonoid M] [Module R M]</code> assumptions on some lemmas to <code>[Ring R] [AddCommGroup M] [Module R M]</code>. That got me confused for a really long time because I thought I had accidentally ungeneralised lemmas, and I had started trying to work around it</p>",
        "id": 505865096,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1742057351
    },
    {
        "content": "<p>So you're convinced that <code>[AddCommGroup M]</code> is better here, even if the lemma never uses negation on <code>M</code>? Is <code>[CommRing R] [CommRing S] [Module R S]</code> worse than <code>[CommRing R] [CommRing S] [Algebra R S]</code>? (are these the same? They feel the same to me but I didn't check carefully)</p>",
        "id": 505865243,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742057462
    },
    {
        "content": "<p><code>[CommRing R] [CommRing S] [Module R S]</code> might be better than <code>[CommRing R] [CommRing S] [Algebra R S]</code> just because <code>Algebra</code> is rather a heavy import <span aria-label=\"face with hand over mouth\" class=\"emoji emoji-1f92d\" role=\"img\" title=\"face with hand over mouth\">:face_with_hand_over_mouth:</span></p>",
        "id": 505865596,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1742057703
    },
    {
        "content": "<p>One could say the same thing about groups over monoids!</p>",
        "id": 505865817,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742057843
    },
    {
        "content": "<p>No, because they both are in <a href=\"https://tqft.net/mathlib4files/Algebra/Group/Defs\">file#Algebra/Group/Defs</a></p>",
        "id": 505866838,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1742058552
    },
    {
        "content": "<p>So you're saying we should merge modules with algebras :-)</p>",
        "id": 505867685,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742059199
    },
    {
        "content": "<p>With all these considerations, I also always have a lingering doubt that maybe, to reach the <em>really minimal instances</em> in small steps, you have to go through stages where you are in a worse situation than where you were, before you start getting to a better place.</p>",
        "id": 505926274,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1742106298
    },
    {
        "content": "<p>I think to find a most-general set of instances, you have to do some kind of instance search on all of the type classes in a definition at once, instead of what I'm doing (looking at them one at a time.) However, I think for now given the state of things, that's ok as it's still finding plenty of places where generalization is possible. And for theorems with few type class assumptions, it'll be fairly optimal</p>",
        "id": 506528826,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742315908
    },
    {
        "content": "<p>I'm trying a slightly different approach to make the changes easier to review, and also easier for me to bundle. Just pick files/directories with a decent number of generalizations, instead of grouping them by source/destination type class. Today I put up</p>",
        "id": 506529922,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742316191
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23056\">#23056</a> generalize Mathlib.Algebra.Ring.Periodic</p>",
        "id": 506529954,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742316200
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23058\">#23058</a> generalize Mathlib.Algebra.TrivSqZeroExt</p>",
        "id": 506529989,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742316209
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23060\">#23060</a> generalize Mathlib.Data.Num.Lemmas</p>",
        "id": 506530019,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742316216
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23061\">#23061</a> generalize Mathlib.Data.Matrix</p>",
        "id": 506530089,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742316235
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23062\">#23062</a> generalize Mathlib.Order</p>",
        "id": 506532062,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742316770
    },
    {
        "content": "<p>That's all I'll get to for today</p>",
        "id": 506532136,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742316792
    },
    {
        "content": "<p>I should probably call out one thing with these changes, in addition to trying to generalize to parent classes, I also have some more general non-parent classes that I now try to substitute, e.g. Group -&gt; DivisionMonoid or Group -&gt; CancelMonoid. This has slightly increased the number of generalizations I find, so I'm currently tracking around ~700 in Mathlib, up from ~600.</p>",
        "id": 506534566,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742317531
    },
    {
        "content": "<p>I'd argue that there's nothing special about parent classes</p>",
        "id": 506536048,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742317960
    },
    {
        "content": "<p>Agreed. Ideally I'd have a generic way of identifying these generalizations, but for now I just use a fixed list for common type classes</p>",
        "id": 506536938,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742318231
    },
    {
        "content": "<p>In reviews for <a href=\"https://github.com/leanprover-community/mathlib4/pull/23140\">#23140</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/23144\">#23144</a> <span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> mentioned Group-&gt;DivisionMonoid (or equivalently AddGroup-&gt;SubtractionMonoid) is a less-likely to be useful generalization. This probably depends on the context, e.g. it may be more useful in pure group theoretic contexts, less useful when there is a bunch of other structure around making that small additional amount of generality less likely to be used. Just figured I'd bring it up here in case anyone else had thoughts about when it should be limited/removed. Keeping the linter as-is is the easiest thing for me, so I'll do that bar any comments to the contrary.</p>",
        "id": 507011208,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742485829
    },
    {
        "content": "<p>OK, it takes some effort to put these PRs together, so rather than doing it piecemeal I've sat down and put up PRs for almost all remaining generalizations. After this, I'd say there are only about ~3 PRs left. All PRs have passed CI and had !bench run. Here's the list:</p>",
        "id": 507308628,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571744
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23195\">#23195</a> feat: generalize Mathlib.Algebra.BigOperators + CharP + Star + misc others</p>",
        "id": 507308762,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571782
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23153\">#23153</a> feat: generalize Mathlib.Algebra.Order + Polynomial</p>",
        "id": 507308899,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571820
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23190\">#23190</a> feat: generalize Mathlib.Algebra.Algebra + Module</p>",
        "id": 507309057,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571855
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23189\">#23189</a> feat: generalize Mathlib.Analysis</p>",
        "id": 507309079,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571862
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23185\">#23185</a> feat: generalize Mathlib.Combinatorics</p>",
        "id": 507309106,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571870
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23146\">#23146</a> feat: generalize Mathlib.Data</p>",
        "id": 507309136,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571879
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23191\">#23191</a> feat: generalize Mathlib.FieldTheory</p>",
        "id": 507309157,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571885
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23192\">#23192</a> feat: generalize Mathlib.GroupTheory</p>",
        "id": 507309200,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571897
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23179\">#23179</a> feat: generalize Mathlib.LinearAlgebra</p>",
        "id": 507309237,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571904
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23147\">#23147</a> feat: generalize Mathlib.MeasureTheory</p>",
        "id": 507309358,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571927
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23187\">#23187</a> feat: generalize Mathlib.NumberTheory</p>",
        "id": 507309390,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571933
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23173\">#23173</a> feat: generalize half of Mathlib.RingTheory</p>",
        "id": 507309440,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571946
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23194\">#23194</a> feat: generalize rest of Mathlib.RingTheory</p>",
        "id": 507309469,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571953
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23193\">#23193</a> feat: generalize Mathlib.Topology</p>",
        "id": 507309492,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742571958
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> I posted this on <a href=\"https://github.com/leanprover-community/mathlib4/pull/23189\">#23189</a>, but I'll repeat it here for discussion. </p>\n<p>something about this linter makes me skeptical: it only caught declarations with type class arguments provided <em>explicitly</em> in the declaration (as opposed to in a <code>variable</code> line). This makes me suspect that it <em>didn't</em> look for changes to other declarations (or, if it did, it tried to change <code>variable</code> blocks which failed because some of the declarations in the block needed the existing variables). In either of these cases, I think we <em>shouldn't</em> merge these because it is introducing semi-arbitrary discrepancies in generalization.</p>",
        "id": 507317390,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1742574090
    },
    {
        "content": "<p>Am I wrong about my suspicion?</p>",
        "id": 507317442,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1742574103
    },
    {
        "content": "<p>As you noticed and I've mentioned in this thread before: I am only trying to generalize explicit type arguments, not ones in <code>variable</code> blocks, because trying to generalize those as well makes it very difficult to PR these changes: do you then do <code>omit [Foo X] in</code> in the relevant theorems? try to split that particular theorem into a separate variable block? it requires a lot of manual labor to reconcile these as it's not something I can automate.</p>\n<p>That said, there is one place where I do look at the entire set of type classes, and that's when I do a pass to try to weed out useless generalizations (e.g. doing IsTopologicalRing X-&gt;IsTopologicalSemiring X when you otherwise have Ring X)</p>",
        "id": 507318480,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742574357
    },
    {
        "content": "<p>There are 2 things I gather from your feedback: 1) some of the generalizations are not useful. This is very useful feedback and I'd be happy to teach the linter to avoid these if I can figure out an algorithm to do so. Your two comments about ContinuousAdd + ContinuousSMul, and the point about RCLike + EuclideanSpace make sense to me, I'm not quite sure if there's an algorithm for the third review comment</p>\n<p>2) that not generalizing type classes in variable blocks as well is an issue, and I could imagine that this could be one? but I'm not quite sure I understand what the specific point you're making is</p>",
        "id": 507320310,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742574803
    },
    {
        "content": "<p>Incidentally, <span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span>'s <a href=\"#narrow/channel/287929-mathlib4/topic/Linter.20for.20generalizing.20type.20class.20hypotheses/with/507247536\">linter</a> from today's thread does work on type classes in variable blocks, though I think the difficulty of applying it will be exactly the manual labor required to actually apply these in a sensible way at scale.</p>",
        "id": 507320970,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742574967
    },
    {
        "content": "<p>My two cents on the discussion here. I'd rather make the modifications when they are useful, i.e., we notice that something has to be changed because we didn't do things in the right generality -- but almost always this will not just be a typeclass change, it will require some deeper refactoring. The pointless generalizations of this thread could make these useful refactorings actively harder, if they have put in some theorems some assumptions which are mathematically meaningless but could be non-compatible with the useful generalizations driven by mathematics. </p>\n<p>TLDR: if it ain't broken, don't fix it, especially if your fix might create more work later on.</p>",
        "id": 507322416,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1742575362
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110050\">Sébastien Gouëzel</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322337.20type.20class.20generalization/near/507322416\">said</a>:</p>\n<blockquote>\n<p>The pointless generalizations of this thread could make these useful refactorings actively harder, if they have put in some theorems some assumptions which are mathematically meaningless but could be non-compatible with the useful generalizations driven by mathematics. </p>\n</blockquote>\n<p>I don't understand this. Isn't the point of a generalization that it can be used in strictly more places?</p>",
        "id": 507324106,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1742575852
    },
    {
        "content": "<p>Vlad, my third comment on the PR is actually the most important one, and it's connected to <span class=\"user-mention silent\" data-user-id=\"110050\">Sébastien Gouëzel</span>'s point about not doing arbitrary generalizations unconnected to mathematics. In particular, because this linter is only catching decls with explicit assumptions, it found this one lemma about <code>IsVonNBounded</code> which just perchance doesn't need the full assumptions, but in practice that's totally useless. Moreover, if we somehow change something related to <code>IsVonNBounded</code> then it's possible that this declaration would break in the future only because we generalized it for no reason.</p>",
        "id": 507324226,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1742575887
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> see <span aria-label=\"up\" class=\"emoji emoji-2b06\" role=\"img\" title=\"up\">:up:</span></p>",
        "id": 507324262,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1742575896
    },
    {
        "content": "<p>Yes, that makes sense to me. I think this also probably varies in different parts of Mathlib, e.g. in early Algebra theorems with a single type class assumption, CommRing-&gt;Ring is an unambiguously good change, versus generalizations in later theory with large sets of typeclass assumptions where there are many available generalizations that have a higher likelihood of not being mathematically useful</p>",
        "id": 507324792,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742576045
    },
    {
        "content": "<p>That's not to say all the things flagged here are useless, as there were a few I thought could be handy (e.g., there's a <code>StrictOrderedSemiring → OrderedSemiring</code>, a <code>ConnectedSpace → PreconnectedSpace</code>). In contrast, there's a <code>SeminormedAddCommGroup → Norm</code> which is likely not particularly useful. So I think if you want to do use this linter, the correct approach is to look at what it outputs and have a good think about whether it's actually a worthwhile change.</p>",
        "id": 507325266,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1742576176
    },
    {
        "content": "<p>I'm not able to make those calls, so I'd be happy to have PRs closed if they're not useful and obviously if parts of it are useful people can just take those bits. If some of the PRs in other parts of the library are useful, that's also obviously great. I'm not particularly married to this linter, I just wanted to finish what I started when I started working on this.</p>",
        "id": 507327631,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742576821
    },
    {
        "content": "<p>I think the way you're splitting the PRs has been good so far; indeed these need manual review and some of the generalizations are dubious, but many are reasonable</p>",
        "id": 507342720,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1742581749
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"761203\">Vlad Tsyrklevich</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322337.20type.20class.20generalization/near/507320310\">said</a>:</p>\n<blockquote>\n<p>2) that not generalizing type classes in variable blocks as well is an issue, and I could imagine that this could be one? but I'm not quite sure I understand what the specific point you're making is</p>\n</blockquote>\n<p>I just came across a situation where section typeclass variable <code>[LinearOrder α]</code> (instead of <code>PartialOrder</code>) were to strong, see <a href=\"https://github.com/leanprover-community/mathlib4/pull/23810\">#23810</a>. I am not sure what the best way would be to do this automatically, my method that I did by hand could be in principle automated: I duplicated the code into two sections <code>PartialOrder</code> and <code>LinearOrder</code>, removed from the first one the theorems that couldn't be proven just using <code>PartialOrder</code>, and from the second section the once that were already in the other section.</p>\n<p>I personally find the generalization from <code>LinearOrder</code> to <code>PartialOrder</code> more mathematically meaningful than say from <code>PartialOrder</code> to <code>PreOrder</code> or <code>LE</code>.</p>",
        "id": 510868279,
        "sender_full_name": "Bernhard Reinke",
        "timestamp": 1744100413
    },
    {
        "content": "<p>Thank you for all the reviews this past week! I have just finished going through the last feedback I had open. I am waiting on approval of 2 follow-up changes from <span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span>, and otherwise the only remaining open generalization PR is <a href=\"https://github.com/leanprover-community/mathlib4/pull/23179\">#23179</a> for Mathlib.LinearAlgebra.</p>",
        "id": 511937791,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1744574341
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> What do you think about adding this linter to mathlib, disabled by default?</p>\n<p>Case in point: I'm currently creating a number of PRs which generalise typeclasses (normed spaces to suitable enorm classes). It would really help me to have a local opt in to the linter, which also covers variable blocks. How difficult is that?</p>",
        "id": 515268887,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746010126
    },
    {
        "content": "<p>I was never fully satisfied with the final state of the linter, it's something I could look at upstreaming, but you may be better off actually trying to use Jovan's linter from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Linter.20for.20generalizing.20type.20class.20hypotheses/with/507102487\">#mathlib4 &gt; Linter for generalizing type class hypotheses</a>. For one it will cover type classes in variable blocks. It is in some ways overly aggressive for doing library-wide generalization, but I think it may actually be better for trying to generalize a small piece of mathlib.</p>",
        "id": 515287879,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1746015363
    },
    {
        "content": "<p>You should just be able to paste those imports/code into your file and maybe limiting the namespace in the final line to whatever you're working in.</p>",
        "id": 515288087,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1746015417
    },
    {
        "content": "<p>So, I'm looking for a linter which covers variable blocks; I don't need auto-generated declarations (so a syntax linter would also work for me). Did your linter cover variable blocks? Otherwise, I'll use Jovan's linter for now.</p>",
        "id": 515292197,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746016446
    },
    {
        "content": "<p>No it did not, so I think you're better off with Jovan's.</p>",
        "id": 515292337,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1746016482
    },
    {
        "content": "<p>Sure, makes sense. Thanks for the quick answer!</p>",
        "id": 515293069,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746016665
    }
]