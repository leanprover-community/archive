[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/19119\">#19119</a> (+30 plus tests, -26) is somewhere between a bugfix and a user-experience improvement: it records the representatives of atoms chosen in <code>ring</code> and <code>abel</code>, so that (e.g.) the result of <code>ring_nf</code> and <code>abel_nf</code> is stable when used simultaneously on multiple expressions.</p>",
        "id": 483045712,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731942240
    },
    {
        "content": "<p>I thought they were already doing that?</p>",
        "id": 483051872,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731943649
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">ring_nf</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"c1\">-- h : R (a * 2) (x * 2)</span>\n</code></pre></div>",
        "id": 483059561,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731945408
    },
    {
        "content": "<p>You're probably thinking of your PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/5403\">#5403</a>, which stabilized the <em>atom ordering</em> in <code>abel</code>.  By contrast, this stabilizes the <em>syntactic representative</em> of a particular atom.</p>",
        "id": 483060422,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731945614
    },
    {
        "content": "<p>by the way you can probably get a <code>guard_hyp =</code> test to work here if you use semireducible defeq mode and use an example like <code>R (id x + x) (x + id x)</code></p>",
        "id": 483061788,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731945928
    },
    {
        "content": "<p>What exactly do you mean by \"stable\" here?</p>",
        "id": 483069631,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731947899
    },
    {
        "content": "<p>Can you give an example that is unstable?</p>",
        "id": 483069672,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731947913
    },
    {
        "content": "<p>See just above in this thread.</p>",
        "id": 483069722,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731947925
    },
    {
        "content": "<p>Oh sorry, I somehow misread that every time I looked at it. Should <code>ring_nf</code> be unfolding <code>let</code>s at all?</p>",
        "id": 483076148,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731949609
    },
    {
        "content": "<p>(given how we pushed against core to make <code>simp</code> not unfold <code>let</code>s)</p>",
        "id": 483076214,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731949627
    },
    {
        "content": "<p>It shouldn't, but I can't fix that until <a href=\"https://github.com/leanprover/lean4/pull/6053\">lean4#6053</a> makes it to mathlib.</p>",
        "id": 483076735,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731949785
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover-community/mathlib4/pull/19120\">#19120</a>.</p>",
        "id": 483076855,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731949811
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2319119.20atom.20representatives.20for.20ring.20and.20abel/near/483061788\">said</a>:</p>\n<blockquote>\n<p>by the way you can probably get a <code>guard_hyp =</code> test to work here if you use semireducible defeq mode and use an example like <code>R (id x + x) (x + id x)</code></p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> You're proposing a test like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">ring_nf!</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">guard_hyp</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>right?  Which works to detect the presence of this bug at semireducible transparency (<code>ring_nf!</code>), but would not detect the presence of this bug if it slipped back at (say) reducible transparency only?</p>",
        "id": 483103034,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731956949
    },
    {
        "content": "<p>It would be good to use a test that doesn't rely on the <code>let</code> behavior, either way.</p>",
        "id": 483103834,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731957227
    },
    {
        "content": "<p>OK, I changed the test from a let to an abbrev.</p>",
        "id": 483106753,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731958197
    },
    {
        "content": "<p>Is it possible to change the reducibility mid-proof? Then you could run <code>ring_nf</code> with it reducible, but the <code>guard_hyp</code> with it irreducible</p>",
        "id": 483118996,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731962409
    },
    {
        "content": "<p>Sorry, I don't follow, can you say more?</p>",
        "id": 483121786,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731963394
    },
    {
        "content": "<p>That was really a Lean question; I'm imagining something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hR</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Reflexive</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">myId</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">myId</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">abel_nf</span>\n<span class=\"w\">    </span><span class=\"n\">seal</span><span class=\"w\"> </span><span class=\"n\">myId</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">      </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">myId</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">myId</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hR</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>but <code>seal</code> doesn't do this today, and I don't know whether it is a trivial macro to write, or its absence is a fundamental design choice in how reducibility works</p>",
        "id": 483122271,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731963576
    }
]