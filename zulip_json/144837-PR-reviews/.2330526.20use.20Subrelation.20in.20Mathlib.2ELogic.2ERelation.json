[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/30526\">#30526</a>: chore(Logic/Relation): replace every <code>∀ x y, r x y → r' x y</code> with <code>Subrelation r r'</code></p>\n<p>I think it's not that controversial to say that <code>∀ x y, r x y → r' x y</code> is a mouthful, preferably replaced by a definition that's easier to read.</p>\n<p><code>r ≤ r'</code> is a good choice, taking advantage of the <code>LE</code> instances on both <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Order/Basic.html#Prop.le\"><code>Prop</code></a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Order/Basic.html#Pi.hasLe\"><code>Pi</code></a>, and it is defeq to the forall version.<br>\nThe problem is that those instances are not available (yet?) in <code>Mathlib.Logic.Relation</code>; see <a href=\"https://github.com/leanprover-community/mathlib4/blob/0fd80fa2193aa3881510b8e33b5110c3aab283ae/Mathlib/Logic/Relation.lean#L238\">this existing comment by Eric</a>.</p>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subrelation#doc\">docs#Subrelation</a> from Lean Core is also an option: <code>Subrelation r r'</code> is defeq to <code>∀ {x y}, r x y → r' x y</code>.<br>\n(btw it can't fix the TODO because <code>Subrelation</code> requires <code>α → α → Prop</code> so no <code>α → β → Prop</code>)</p>\n<p>Personally I like <code>≤</code> a bit better, but since it's not available in <code>Mathlib.Logic.Relation</code> this PR adds <code>Subrelation</code> everywhere.<br>\nThis makes <code>x y</code> optional, which necessitates a few more changes outside of this file.</p>\n<p>Items to discuss:</p>\n<ul>\n<li>When both are available, do we prefer <code>≤</code> or <code>Subrelation</code>? Would the answer change if <code>Subrelation</code> had non-optional args?</li>\n<li>If we prefer <code>≤</code>, how can we change the imports to make it available to <code>Mathlib.Logic.Relation</code>?</li>\n<li>I made this PR assuming that the import change won't happen soon, to mark all places that are actually a subrelation in disguise (some are non-obvious). Regardless of the other decisions, I think a version of this should be merged - possibly with a local <code>abbrev relLe r r' := ∀ x y, r x y → r' x y</code> if converting to optional args (even temporarily) is deemed bad.</li>\n</ul>",
        "id": 546572621,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761180298
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> surely cares more than me here</p>",
        "id": 546572676,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1761180340
    },
    {
        "content": "<p>I believe we should remove <code>Subrelation</code> completely (or at least as much as core allows)</p>",
        "id": 546597202,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1761199961
    },
    {
        "content": "<p>There is also this idea: <a href=\"https://github.com/leanprover/lean4/pull/10471\">lean4#10471</a>.</p>",
        "id": 546598173,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1761200421
    },
    {
        "content": "<p>I just posted on it:</p>\n<blockquote>\n<p>Note that it can only ever be a drop-in replacement when its arguments are <em>not</em> lambdas, as otherwise the expanded version is further beta-reduced (which is good for user experience).</p>\n</blockquote>",
        "id": 546602839,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1761202721
    },
    {
        "content": "<p>A similar consideration applies to Snir's PR (I haven't looked yet to see whether it's respected there)</p>",
        "id": 546602943,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1761202770
    },
    {
        "content": "<p>I've been thinking about this somewhat. Don't we already have a simple way to spell this out? <code>Subrelation r s</code> is the exact same as <code>r ≤ s</code>.</p>",
        "id": 547034313,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1761375281
    },
    {
        "content": "<p>the problem was that it increases the imports</p>",
        "id": 547053574,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761394843
    },
    {
        "content": "<p>Maybe we can move these <code>LE</code> instances on pi types to core?</p>",
        "id": 547253912,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1761564949
    },
    {
        "content": "<p>Any verdict?</p>",
        "id": 561302468,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764636507
    },
    {
        "content": "<p>Let me ping this thread again, now that many of us are back from the holidays. :) Can we summarize our options here, with the pros and cons?</p>",
        "id": 566588132,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767719844
    },
    {
        "content": "<p>Summary: <a href=\"https://tqft.net/mathlib4files/Logic/Relation\">file#Logic/Relation</a> uses the construct <code>∀ x y, r x y → r' x y</code> a lot. This is a common pattern for being a subrelation. Mathlib usually uses <code>r ≤ r'</code> thanks to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Pi.hasLe#doc\">docs#Pi.hasLe</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Prop.le#doc\">docs#Prop.le</a>, but that file doesn't import those instances.</p>\n<p>Options:<br>\n1) Move <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Pi.hasLe#doc\">docs#Pi.hasLe</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Prop.le#doc\">docs#Prop.le</a> from <a href=\"https://tqft.net/mathlib4files/Order/Basic\">file#Order/Basic</a> to somewhere <a href=\"https://tqft.net/mathlib4files/Logic/Relation\">file#Logic/Relation</a> already imports, possibly upstreaming to batteries or core<br>\n2) Import <a href=\"https://tqft.net/mathlib4files/Order/Basic\">file#Order/Basic</a> in <a href=\"https://tqft.net/mathlib4files/Logic/Relation\">file#Logic/Relation</a><br>\n3) Use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subrelation#doc\">docs#Subrelation</a>, <code>Subrelation r r'</code> is <code>∀ {a b}, r a b → r' a b</code>. Since <code>a b</code> are implicit, changing the usual <code>∀</code> version to <code>Subrelation</code> affects users of the theorems.<br>\n4) <code>local instance : LE (α → β → Prop) := ⟨fun r r' ↦ ∀ a b, r a b → r' a b⟩</code> </p>\n<p>I think the work in <a href=\"https://github.com/leanprover-community/mathlib4/pull/30526\">#30526</a> is useful regardless: the point is to identify all the places in <a href=\"https://tqft.net/mathlib4files/Logic/Relation\">file#Logic/Relation</a> that spell out the subrelation property and replace them, which is nontrivial. It currently uses (3) and fixes the problems caused by the binder change.</p>\n<p>As for pros/cons for the options, we should decide whether we prefer implicit or explicit <code>a b</code>, and idk how hard reworking the imports is. I think (4) is perhaps the least controversial?</p>",
        "id": 566604856,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1767726303
    },
    {
        "content": "<p>Is this work really necessary? Is it unblocking any application? If not, I am willing to say the file is \"good enough\" and we shouldn't let it distract us from the greater goals of the community</p>",
        "id": 566608534,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1767727784
    },
    {
        "content": "<p>You could say that about many refactors. I don't see how this is much of a distraction.</p>",
        "id": 566612384,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1767729367
    },
    {
        "content": "<p>Also, I do think this is hurting the loogle-ability of this file, which causes me (and probably others) to reprove some of its theorems inline.</p>",
        "id": 566612385,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1767729369
    },
    {
        "content": "<p>I disagree with Yaël. I think our library design is important and ignoring it just leads to many future headaches. </p>\n<p>My opinion here is that <code>Subrelation</code> is an alternate name with less API for something that already exists in <code>≤</code>. It should not be difficult to move the LE instance on pi types to some really basic file, and replace all use of <code>Subrelation</code> throughout.</p>",
        "id": 566629834,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1767737478
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2330526.20use.20Subrelation.20in.20Mathlib.2ELogic.2ERelation/near/566629834\">said</a>:</p>\n<blockquote>\n<p>My opinion here is that <code>Subrelation</code> is an alternate name with less API for something that already exists in <code>≤</code>. It should not be difficult to move the LE instance on pi types to some really basic file, and replace all use of <code>Subrelation</code> throughout.</p>\n</blockquote>\n<p>I agree, and I think is good for discovery. Downstream in CSLib this file not importing these instances lead me to otherwise search and end up using <code>Subrelation</code>.</p>",
        "id": 566633592,
        "sender_full_name": "Chris Henson",
        "timestamp": 1767739964
    },
    {
        "content": "<p>/poll Where should we move the <code>LE</code> instances on <code>Prop</code> &amp; <code>Pi</code> to?</p>",
        "id": 567986325,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768397468
    },
    {
        "content": "<p>(I think moving to batteries or lean-core will take time and possibly be rejected, so I prefer staying in Mathlib for now)</p>",
        "id": 567987739,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768397871
    },
    {
        "content": "<p>I vote for option 5, unless that causes problems, in which case option 4 seems fine.</p>",
        "id": 568049214,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1768413783
    },
    {
        "content": "<p>Option 5 causes <code>assert_not_exists Monoid Preorder</code> in <a href=\"https://github.com/leanprover-community/mathlib4/blob/be04ab25ca4157be69980ea7f908c865738b7388/Mathlib/Data/List/Perm/Basic.lean#L26\"><code>Data.List.Perm.Basic</code></a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Declaration</span><span class=\"w\"> </span><span class=\"n\">Preorder</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">allowed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">imported</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"bp\">.</span>\n<span class=\"n\">It</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"bp\">.</span><span class=\"n\">PartialOrder</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">imported</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"bp\">.</span><span class=\"n\">LinearOrder</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">imported</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Basic</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">imported</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Logic</span><span class=\"bp\">.</span><span class=\"n\">Relation</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">imported</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>and also triggers <code>assert_not_exists DenselyOrdered</code> in both <a href=\"https://github.com/leanprover-community/mathlib4/blob/be04ab25ca4157be69980ea7f908c865738b7388/Mathlib/Algebra/Group/Opposite.lean#L20\"><code>Algebra.Group.Opposite</code></a> and <a href=\"https://github.com/leanprover-community/mathlib4/blob/be04ab25ca4157be69980ea7f908c865738b7388/Mathlib/Algebra/Group/Units/Hom.lean#L41\"><code>Algebra.Group.Units.Hom</code></a></p>",
        "id": 570195625,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1769464514
    },
    {
        "content": "<p>So I went with option 4 for now, but it should be trivial to switch to any of the others if we prefer</p>",
        "id": 570195701,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1769464556
    }
]