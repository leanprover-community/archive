[
    {
        "content": "<p>I just noticed (when updating a project to current Mathlib) that the PR in the title changed</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"bp\">.</span><span class=\"n\">mod_four_ne_three_of_dvd_isSquare_neg_one</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hpp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsSquare</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>\n<p>to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mod_four_ne_three_of_mem_primeFactors_of_isSquare_neg_one</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">primeFactors</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsSquare</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>\n<p>The problem with this is that there are no lemmas that show a statement of the form <code>p ∈ n.primeFactors</code>:<br>\n<span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> ⊢ ?p ∈ Nat.primeFactors _<br>\nso this version is hard to use.</p>",
        "id": 560237631,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764099743
    },
    {
        "content": "<p><span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span> nothing found</p>",
        "id": 560237633,
        "sender_full_name": "loogle",
        "timestamp": 1764099744
    },
    {
        "content": "<p>There are only the somewhat unwieldy equivalences<br>\n<span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> ?p ∈ Nat.primeFactors _ ↔ _</p>",
        "id": 560237719,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764099792
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Nat/PrimeFin.html#Nat.mem_primeFactors_iff_mem_primeFactorsList\">Nat.mem_primeFactors_iff_mem_primeFactorsList</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Nat/PrimeFin.html#Nat.mem_primeFactors_of_ne_zero\">Nat.mem_primeFactors_of_ne_zero</a>, and <a href=\"https://loogle.lean-lang.org/?q=%3Fp%20%E2%88%88%20Nat.primeFactors%20_%20%E2%86%94%20_\">1 more</a></p>",
        "id": 560237721,
        "sender_full_name": "loogle",
        "timestamp": 1764099793
    },
    {
        "content": "<p>but, e.g., no lemma that says that <code>p ∈ Nat.primeFactors p</code> when <code>p</code> is a prime.<br>\n<span class=\"user-mention\" data-user-id=\"933054\">@Snir Broshi</span> can you perhaps add some API for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.primeFactors#doc\">docs#Nat.primeFactors</a> so that your new version is easier to use?</p>",
        "id": 560237845,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764099845
    },
    {
        "content": "<p>But the previous version is strictly stronger, right? I.e., it implies the new one (because if <code>p ∈ n.primeFactors</code> then <code>p.Prime</code>), while the converse is not true. So shouldn't we have kept the previous one also?</p>",
        "id": 560241522,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1764100876
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.mem_primeFactors#doc\">docs#Nat.mem_primeFactors</a><br>\nModulo the edge case <code>n = 0</code>, <code>p ∈ Nat.primeFactors n</code> is equivalent to <code>p.Prime</code> and <code>p ∣ n</code>, so mathematically, there is really no difference. (When <code>n = 0</code>, both versions do not give something useful; the assumptions cannot be satisfied.)</p>",
        "id": 560242313,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764101066
    },
    {
        "content": "<p>I hadn't scrolled to the right, so I hadn't notice the <code>p | n</code> assumption in the first version :-)</p>",
        "id": 560242858,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1764101187
    },
    {
        "content": "<p>Like the comment I left in the deprecation, have you tried <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.mem_primeFactors#doc\">docs#Nat.mem_primeFactors</a> ?</p>",
        "id": 560242977,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764101215
    },
    {
        "content": "<p>btw you might like <a href=\"https://github.com/leanprover-community/mathlib4/pull/30273/commits/ca1014ef5b3f95e7d55ccac36d0b05da98b8e5a9\">this commit</a></p>",
        "id": 560243172,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764101267
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"bp\">.</span><span class=\"n\">mod_four_ne_three_of_dvd_isSquare_neg_one</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hpp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsSquare</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">mod_four_ne_three_of_mem_primeFactors_of_isSquare_neg_one</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mem_primeFactors</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">hpp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hn</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ZMod</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hs</span>\n</code></pre></div>",
        "id": 560243234,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764101283
    },
    {
        "content": "<p>Yes, but it makes the code more ugly (I need to write <code>(Nat.mem_primeFactors.mpr ⟨hp, p.dvd_refl, hp.ne_zero⟩)</code> instead of <code>hp p.dvd_refl</code>).</p>",
        "id": 560243366,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764101309
    },
    {
        "content": "<p>In any case, it should by an API lemma that a prime is a member of its prime factors...</p>",
        "id": 560243950,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764101452
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/commit/1eb907d5c6dad5fe2b7c5e6bd74bae14e57b829c\">This</a> is the actual PR I made, the rest of the decisions were made by Riccardo, a number theory maintainer</p>",
        "id": 560244203,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764101508
    },
    {
        "content": "<p>I agree the conversion between <code>Prime</code> and <code>primeFactors</code> isn't so pretty, but OTOH many of the lemmas in that file had the hypotheses <code>p | n</code> and <code>p.Prime</code>, which are an inconvenient way to write <code>p ∈ n.primeFactors</code> (unless <code>n = 0</code>)</p>",
        "id": 560244835,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764101653
    },
    {
        "content": "<p>I have to say that I find <code>Nat.mem_primeFactors.mpr ⟨_, _, _⟩</code> more inconvenient.</p>",
        "id": 560245151,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764101760
    },
    {
        "content": "<p>I don't see a reason to carry around <code>p | n</code> and <code>p.Prime</code> separately, IMO when you have both you should <code>have : p ∈ n.primeFactors := ...</code></p>",
        "id": 560245608,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764101857
    },
    {
        "content": "<p>but I'm not doing number theory, so I'm fine with whatever you decide to do</p>",
        "id": 560245643,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764101876
    },
    {
        "content": "<p>At this point, <code>Nat.mem_primeFactors</code> is essentially the <em>only</em> API lemma that allows to produce a statement of the form <code>p ∈ n.primeFactors</code>, so if you want people to use <code>Nat.primeFactors</code> more, you should make it easy to do so.</p>",
        "id": 560245658,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764101882
    },
    {
        "content": "<p>I don't see why that's a bad thing, that's the characterization of being a prime factor</p>",
        "id": 560245816,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764101941
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"130384\">@Riccardo Brasca</span></p>",
        "id": 560250207,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764103705
    },
    {
        "content": "<p>I had the impression the new version is more natural, but I probably assumed the API for <code>primeFactors</code> was good enough. I have no strong opinion on going back to the old version, but we shouldn't have definitions with a bad API.</p>",
        "id": 560323063,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1764143142
    },
    {
        "content": "<p>My rationale is that if we have a definition we should use it, rather than spalling explicitly what it means (but of course this only works if the API is good).</p>",
        "id": 560323738,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1764143389
    },
    {
        "content": "<p>I agree with Michael here. The point of <code>primeFactors</code> is that it's a finset, not that it bundles the divisibility and primality conditions.</p>",
        "id": 560327231,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1764144710
    },
    {
        "content": "<p>Ah ok, I can very well have misunderstood the point of <code>primeFactors</code>, but still having a better API cannot hurt.</p>",
        "id": 560327740,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1764144885
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2330273.20.28already.20merged.29/near/560327740\">said</a>:</p>\n<blockquote>\n<p>having a better API cannot hurt.</p>\n</blockquote>\n<p>This is the point I wanted to make. If I have time, I may open a PR with a couple of API lemmas, but this is unlikely to happen today-</p>",
        "id": 560334456,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764146957
    },
    {
        "content": "<p>Having a better API <em>can</em> hurt, because it's more API surface</p>",
        "id": 560339914,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1764148565
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2330273.20.28already.20merged.29/near/560334456\">said</a>:</p>\n<blockquote>\n<p>I may open a PR with a couple of API lemmas</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/32145\">#32145</a></p>",
        "id": 560462821,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764185727
    }
]