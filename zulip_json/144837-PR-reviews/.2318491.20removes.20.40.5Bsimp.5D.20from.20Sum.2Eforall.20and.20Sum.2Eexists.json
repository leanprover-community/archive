[
    {
        "content": "<p>The actual removal occurs in <a href=\"https://github.com/leanprover/lean4/pull/5900\">lean#5900</a>. These lemmas have complicated right hand sides, and cause problems for confluence. (Confluence tool coming soon!)</p>\n<p>We can just turn @[simp] back on for these lemmas globally in Mathlib, but I'd prefer the approach in this PR.</p>",
        "id": 479853393,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730373049
    },
    {
        "content": "<p>This sounds like it implicates <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Prod.forall#doc\">docs#Prod.forall</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subtype.forall#doc\">docs#Subtype.forall</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=forall_or_imp#doc\">docs#forall_or_imp</a> etc too?</p>",
        "id": 479967150,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730413135
    },
    {
        "content": "<p>(maybe that last one doesn't exist...)</p>",
        "id": 479967285,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730413205
    },
    {
        "content": "<p>Can you elaborate on the confluence issues it causes? Looking at <a href=\"https://github.com/leanprover-community/mathlib4/pull/18491\">#18491</a> it looks fairly handy, though of course the diff wouldn't reveal the places where we had to previously work around non-confluence.</p>",
        "id": 479967978,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730413651
    },
    {
        "content": "<p>I don't think those you mention have more complicated RHSs, in the way that occurs for <code>Sum</code>. But nevertheless you are right that I include <code>Prod.forall</code> and <code>Subtype.forall</code> in the confluence checker whitelists.</p>",
        "id": 480001214,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730440793
    },
    {
        "content": "<p>It would be good to have resolution on <a href=\"https://github.com/leanprover-community/mathlib4/pull/18491\">#18491</a> (either merging, or deciding we want to add <code>@[simp]</code> back in Mathlib), as this will break in nightly-testing in a few hours.</p>",
        "id": 480001328,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730440829
    },
    {
        "content": "<p>I'm not fully convinced by the \"the RHS is more complex\" argument; sure, the expression is deeper, but the quantification is over a less complex type, and it lets lemmas of the form <code>f (inl x) = g x</code> apply.</p>",
        "id": 480017096,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730450829
    },
    {
        "content": "<p>Which is to say, if the other <code>forall</code>s are whitelisted, I'd argue this one should be too; and if it's too late for that on the nightly, let's add <code>simp</code> in mathlib.</p>",
        "id": 480017160,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730450874
    },
    {
        "content": "<p>I agree that the forall lemma looks like a good simp lemma. I have more mixed feelings about the exists one, but still I'd argue it is also good.</p>",
        "id": 480030239,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1730457404
    },
    {
        "content": "<p>Okay. We'll turn them on in Mathlib for now. I've done this in nightly-testing.</p>",
        "id": 480030849,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730457658
    },
    {
        "content": "<p>Once the confluence tool arrives, if Mathlib wants to start using it (I hope so) then these simp lemmas will probably need to appear in the Mathlib whitelists.</p>",
        "id": 480030905,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730457691
    },
    {
        "content": "<p>I'm also open to turning them back on a simp lemmas globally, but not today. :-)</p>",
        "id": 480031045,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730457746
    },
    {
        "content": "<p>Can you give an example of a confluence issue they cause?</p>",
        "id": 480032448,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730458387
    },
    {
        "content": "<p>Maybe next week, out of time here.</p>",
        "id": 480032586,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730458444
    },
    {
        "content": "<p>Typical example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">exists</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"k\">forall</span>\n\n<span class=\"n\">simp_lc</span><span class=\"w\"> </span><span class=\"n\">inspect</span><span class=\"w\"> </span><span class=\"n\">exists_eq</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">exists</span>\n</code></pre></div>\n<p>prints:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Expression</span>\n<span class=\"w\">      </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a'</span>\n<span class=\"w\">    </span><span class=\"n\">reduces</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exists_eq</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"w\">      </span><span class=\"n\">True</span>\n<span class=\"w\">    </span><span class=\"n\">and</span><span class=\"w\">     </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">exists</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a'</span>\n</code></pre></div>",
        "id": 480346814,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730676585
    },
    {
        "content": "<p><code>simp_lc check in Sum _root_</code> on that branch finds many (24) more.</p>",
        "id": 480346891,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730676655
    },
    {
        "content": "<p>Would lowering the priority of all of these <code>exists</code> and <code>forall</code> lemmas help?</p>",
        "id": 480381803,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730705102
    },
    {
        "content": "<p>I agree that there's no way to add a lemma to make that confluent, thanks for the example</p>",
        "id": 480381849,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730705139
    }
]