[
    {
        "content": "<p>In  <a href=\"https://github.com/leanprover-community/mathlib4/pull/14826\">#14826</a> I am splitting <code>RingTheory.IntegralClosure</code> to several files (creating a new folder <code>RingTheory.IntegralClosure</code>). At the beginning I though to use <code>Defs</code> and <code>Basic</code> as usual, but <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> pointed out that we can also do the splitting <code>IsIntegralElement</code>/<code>Algebra.IsIntegral</code>/<code>IsIntegrallyClosed</code>. Currently, I did <em>both</em>, meaning that there are three subfolders</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">IntegralClosure</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">IsIntegral</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Defs</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Basic</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Algebra</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Defs</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Basic</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">IsIntegralClosure</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Defs</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Basic</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosed</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">IntegralRestrict</span>\n<span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>What do you think? Is this splitting maybe too much?</p>",
        "id": 452074893,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1721223809
    },
    {
        "content": "<p>I think that granularity is great</p>",
        "id": 452076390,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721224071
    },
    {
        "content": "<p>To restate the comments on that PR, I don't like <code>Defs</code> / <code>Basic</code> splits.<br>\nFirst of all the fact that <code>Basic</code> is not the most basic file is confusing to me.<br>\nSecond, a def is useless without API lemmas and when I want to <code>Go to Definition</code> to find the lemmas I can find none.<br>\nI understand that it is a necessary evil to reduce imports on lower-heirarchical files but I don't think it is applicable here.</p>",
        "id": 452076408,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1721224075
    },
    {
        "content": "<p>We could have a <code>def_file_start ... def_file_end</code> command that takes a sequence of commands as input, writes them to a <code>Defs.lean</code> file in the same folder as the current one and is otherwise embedded inside the <code>Basic</code> file.  This does not yet fix the \"jump to def\" issue, but does mean that the files are not split and yet they are...</p>",
        "id": 452077878,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721224304
    },
    {
        "content": "<p>(Not really a serious suggestion, btw.)</p>",
        "id": 452077945,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721224315
    },
    {
        "content": "<p>In my opinion the most important thing is having <em>folders</em>, to avoid files that become super long.  Then I am less sure... sometimes we need theorems even to write down definitions (for example in this case the integral closure is a subalgebra, so we need to know nontrivial facts to even define what the integral closure is).</p>",
        "id": 452078878,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1721224472
    },
    {
        "content": "<p>I think that granular files are great, \"go to definition\" is awesome, but there is some glue missing for \"go to theory\" jump <em>forwards</em>.</p>",
        "id": 452079851,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721224631
    },
    {
        "content": "<p>Maybe there could be a mechanism where a <code>Defs.lean</code> file contains a clickable link to the corresponding <code>Basic.lean</code> file?</p>",
        "id": 452080085,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721224670
    },
    {
        "content": "<p>I'm a fan of folders and granularity and short files, but I hope basic lemmas can come with defs, and if some results are splitted out they get descriptive file names and not <code>Defs</code> or <code>Basic</code> or <code>Lemmas</code>.</p>",
        "id": 452080166,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1721224681
    },
    {
        "content": "<p>Maybe, every file <code>X</code> should have easy access to the files that <code>import X</code>.</p>",
        "id": 452080435,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721224724
    },
    {
        "content": "<p>Something like \"flipping to the next page\", when, in the old days, there were books.</p>",
        "id": 452080765,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721224781
    },
    {
        "content": "<p>Discovery of API seems an editor/LSP problem that shouldn’t be solved via imports</p>",
        "id": 452081773,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721224928
    },
    {
        "content": "<p>VSCode has a <code>Show Call Hierarchy</code> functionality, but I find that it gives sometimes too much information and too little context.</p>",
        "id": 452083445,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721225192
    },
    {
        "content": "<p>Maybe we can try to enforce the rule that in the <code>Defs</code> file we can put everything that is matematically very basic and does not require any other import</p>",
        "id": 452083836,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1721225250
    },
    {
        "content": "<p>Anyway, this has derailed a bit the main focus of the discussion that maybe part of this thread deserves to be split out.</p>",
        "id": 452083981,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721225272
    },
    {
        "content": "<p>Is anyone opposed to merging as is?</p>",
        "id": 452089831,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721226286
    },
    {
        "content": "<p>I'm pretty ambivalent about exactly what goes in <code>Defs</code>, but I think it should be no more than what is possible without the minimal imports required for the definitions. We could go even further, and ask for nothing but the <code>rfl</code> lemmas.</p>\n<p>Having minimal import <code>Defs</code> becomes particularly powerful when it's pervasive. It gives us short import chains to definitions, and really helps reducing the \"thicket\" nature of Mathlib's import graph, which is to a very large extent unnecessary.</p>\n<p>(This also helps for being able to minimize problems, and more generally improves maintainability by reducing the \"action at a distance\" effects of random imports. The maintainability issue here is <em>really</em> important; imagine what it will be like if we don't improve the import structure before Mathlib is 10x bigger!)</p>\n<p>I definitely appreciate the findability problems from having small <code>Defs</code> files. There is no problem with including good documentation in <code>Defs</code> files: indeed they should all have a module doc which explains in which other files the theorems about these definitions can be found! (Ideally at the level of sections in the module doc per downstream file, with bulleted lists of the main theorems.)</p>\n<p>I am 100% behind the idea that we should not, in the long run, have any <code>Lemmas</code> files: they are stopgap measures, and everyone should be trying to further split or rearrange <code>Lemmas</code> files into files with subject specific names.</p>",
        "id": 452100302,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721228152
    },
    {
        "content": "<p>Beyond <code>simp</code> and TC synthesis, are there other big drivers of “action at a distance”?</p>",
        "id": 452103281,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721228844
    },
    {
        "content": "<p>I don't see how <code>Basic</code> is different from <code>Lemmas</code> semantic-wise.</p>",
        "id": 452103764,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1721228950
    },
    {
        "content": "<p>Yeah, I agree this is too bland</p>",
        "id": 452103925,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721228981
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2314826.20Split.20RingTheory.2EIntegralClosure/near/452078878\">said</a>:</p>\n<blockquote>\n<p>In my opinion the most important thing is having <em>folders</em>, to avoid files that become super long.  Then I am less sure... sometimes we need theorems even to write down definitions (for example in this case the integral closure is a subalgebra, so we need to know nontrivial facts to even define what the integral closure is).</p>\n</blockquote>\n<p>I globally agree with the whole idea, but I find it a pity that the website does not allow a smooth browsing of folders. If I do not know where a result is and click on the name of the file, the left panel starts again at the top instead of focusing on the folder containing the displayed file. So, in this sense, a lot of \" fold(er)ing\" is a bit painful. Of course, I am all in favour of prioritizing library design, though...</p>",
        "id": 452108767,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1721230091
    },
    {
        "content": "<p>Well, these are two completely questions in my opinion. Note that <a href=\"https://github.com/leanprover-community/mathlib4/pull/14829\">#14829</a> has the same problem. I really think we should decide what is standard we want (and then we can of course improve the website/VS Code extension).</p>",
        "id": 452110940,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1721230747
    },
    {
        "content": "<p>I certainly agree they are two completely (different?) questions, and I am again all in favour of prioritizing library design. I just wanted to say that this will mean that tackling the website browsing quality will become more important, that's all.</p>",
        "id": 452126706,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1721234154
    },
    {
        "content": "<p>I would also like to seperate \"defs + rfl lemmas\" from the rest of the theory.<br>\nSome \"jump to the next page\" feature would be great to have. And I think a file called <code>Basic.lean</code> is a perfect place to build the basic theory for a def. So every def could have a pointer to its theory file. But maybe a reverse lookup would scale better and be more useful.</p>",
        "id": 452270724,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1721288316
    },
    {
        "content": "<p>Should we split this thread into discussion about Defs files and discussion about Riccardo's PR?</p>",
        "id": 452270806,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1721288346
    },
    {
        "content": "<p>I don't think the distinction of <code>rfl</code> and not-<code>rfl</code> matters. defeq is overrated anyways.<br>\nFor example which of the following is by-definition and which is not?<br>\n<code>IsNoetherian R M ↔ WellFounded ((· &gt; ·) : Submodule R M → Submodule R M → Prop)</code><br>\n<code>IsNoetherian R M ↔ ∀ s : Submodule R M, s.FG</code><br>\nRequiring users to know how things are defined to know which file to import breaks the abstraction boundaries given by the defs.</p>",
        "id": 452271579,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1721288630
    },
    {
        "content": "<p>I think Kim's and Johan's arguments apply to (semi)basic files, but not advanced ones</p>",
        "id": 452271779,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1721288671
    },
    {
        "content": "<p>I think users shouldn't need to know. I completely agree with that. So the rule should be to always import <code>FooBar.Basic</code> and not <code>FooBar.Defs</code> (unless you are writing <code>Xyzzy.Defs</code> of course).</p>\n<p>But by having only rfl lemmas in <code>Defs</code> files, I think we can end up with an extremely lightweight import graph for them. And that really helps with maintaining and especially with building MWE's.</p>\n<p>And I actually would love to converge in the long term to having such a split for advanced maths as well.</p>",
        "id": 452275321,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1721289510
    },
    {
        "content": "<p>I like the split and should there be a command <code>go_to_basic_file</code> that jumps from <code>X.Defs</code> to <code>X.Basic</code>?</p>",
        "id": 452276035,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721289673
    },
    {
        "content": "<p>It would be nice if it were a \"Go to definition\" link, so that Ctrl-Click on the command would take you to the start of <code>X.Basic</code>.</p>",
        "id": 452276220,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721289717
    },
    {
        "content": "<p>In that case I think <code>rfl</code> lemmas should also be in <code>Basic</code> and not <code>Defs</code>. Defs should contain defs and defs only. A problem I had with <a href=\"https://github.com/leanprover-community/mathlib4/pull/14826\">#14826</a> (that has since been improved after the further split) is that there are lemmas both in <code>Basic</code> and <code>Defs</code> and that is very confusing to me.</p>",
        "id": 452277002,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1721289887
    },
    {
        "content": "<p>I'd be happy if the docstring of the def contains a link to the <code>Basic</code> file that is clickable in vscode (is it possible?)</p>",
        "id": 452277381,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1721289958
    },
    {
        "content": "<p>Using the <code>Comment Anchor</code> extension in VSCode, you can plant an anchor in a file and make clickable links to it from elsewhere.</p>",
        "id": 452280235,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721290463
    },
    {
        "content": "<p>Anchor:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">// ANCHOR[id=myReference]</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>reference:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">// LINK Mathlib/RingTheory/Polynomial/Basic.lean#myReference</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 452280388,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721290484
    },
    {
        "content": "<p>I'm sure that we can also code something with the same effect in Lean as well.</p>",
        "id": 452280857,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721290562
    },
    {
        "content": "<p>The same problem is happening with <a href=\"https://github.com/leanprover-community/mathlib4/pull/14829\">#14829</a>. For example, in <code>Mathlib.RingTheory.LocalRing.Defs</code> currently there is (<code>R</code> is local here)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- The ideal of elements that are not units. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nonunits</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"n\">zero_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">zero_mem_nonunits</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">zero_ne_one</span>\n<span class=\"w\">  </span><span class=\"n\">add_mem'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nonunits_add</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"n\">hy</span>\n<span class=\"w\">  </span><span class=\"n\">smul_mem'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mul_mem_nonunits_right</span>\n<span class=\"bp\">#</span><span class=\"n\">align</span><span class=\"w\"> </span><span class=\"n\">local_ring</span><span class=\"bp\">.</span><span class=\"n\">maximal_ideal</span><span class=\"w\"> </span><span class=\"n\">LocalRing</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span>\n</code></pre></div>\n<p>This looks like a fundamental definition for local rings, but to write it we need to know that the nonunits form an ideal. Do you think this should to <code>Basic</code>?</p>",
        "id": 452312534,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1721299952
    },
    {
        "content": "<p>Are there new imports to do this?</p>",
        "id": 452313296,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721300195
    },
    {
        "content": "<p>Yes, <code>LocalRing</code> is defined via units, so the definition does not even mention ideals.</p>",
        "id": 452313653,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1721300303
    },
    {
        "content": "<p>Maybe prove it in <code>LocalRing/Basic</code> and add that def in <code>LocalRing/MaximalIdeal/Defs</code> which imports it.</p>",
        "id": 452314065,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1721300409
    },
    {
        "content": "<p>My only concern with this solution is that maybe we are doing too much splitting. It would be something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">LocalRing</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">MaximalIdeal</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Defs</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Basic</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">RingHom</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Defs</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Basic</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">ResidueField</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Defs</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Basic</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Defs</span>\n<span class=\"bp\">│</span><span class=\"w\">   </span><span class=\"bp\">├──</span><span class=\"w\"> </span><span class=\"n\">Basic</span>\n<span class=\"bp\">└──</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 452314801,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1721300615
    },
    {
        "content": "<p>These all seem pretty fundamental objects of study which will grow naturally in the future</p>",
        "id": 452314959,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721300656
    },
    {
        "content": "<p>OK, doing it.</p>",
        "id": 452315026,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1721300678
    }
]