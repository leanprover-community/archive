[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22226\">#22226</a> is the first in a series of PRs that attempt to improve generality in the current API for matrix rank.</p>\n<p>At the moment, for <code>A : Matrix m n R</code>, the term <code>A.rank</code> is only well-defined for <code>Fintype n</code> and <code>CommRing R</code>. This is because the definition is in terms of <code>MulVecLin</code>, which requires these typeclass assumptions. The <code>Fintype</code> assumption, especially, is a little unfortunate, since it necessitates unnecessary and column/row-asymmetric <code>Fintype</code> assumptions throughout the API, and makes it impossible to state the important lemma <code>rank_transpose</code> for infinite matrices.</p>\n<p>We don't touch the current definition <code>Matrix.rank</code> directly here, but we introduce cardinal and ENat-valued notions of rank for infinite matrices, with basic API for monotonicity. The lemma <code>cRank_toNat_eq_rank</code> is a proof of concept - it shows that the current <code>Matrix.rank</code> could easily be redefined as <code>Matrix.rank A := (Matrix.cRank A).toNat</code> with a strict gain in generality, and no loss to the existing API. The plan is to do this, and thereby prove <code>rank_transpose</code> in greater generality, in coming PRs.</p>\n<p>The definition <code>Matrix.eRank</code> is also natural, since <code>Matrix.eRank_transpose</code> will be true, but <code>Matrix.cRank_transpose</code> will not.</p>",
        "id": 501409302,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1740343858
    },
    {
        "content": "<p>I guess an alternative here would be to define something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mulFinVecLin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→₀</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→ₗ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">vi</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">vi</span>\n<span class=\"w\">  </span><span class=\"n\">map_add'</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">classical</span>\n<span class=\"w\">    </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">sum_add_index</span><span class=\"w\"> </span><span class=\"bp\">?_</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">zero_def</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">add_def</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_add</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">map_smul'</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">classical</span>\n<span class=\"w\">    </span><span class=\"n\">dsimp</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">sum_smul_index</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">smul_sum</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">smul_def</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_left_comm</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">zero_def</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and use that instead of <code>mulVecLin</code></p>",
        "id": 501427814,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740359802
    },
    {
        "content": "<p>I suspect the two approaches are not equivalent on semirings, but likely we don't care for now.</p>",
        "id": 501427914,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740359860
    },
    {
        "content": "<p>This needs commutativity, right?</p>",
        "id": 501515162,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1740396136
    },
    {
        "content": "<p>Not if we make it <code>MulOpposite R</code>-linear</p>",
        "id": 501518658,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740397172
    },
    {
        "content": "<p>I see. Is there a reason to prefer this approach? For me, the term 'rank' is 'dimension of something', and that conceptually doesn't need to go through linear operators.</p>",
        "id": 501519052,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1740397284
    },
    {
        "content": "<p>I didn't mention this (because I think the non-junk-valued approach with infinite matrices is best), but redefining <code>Matrix.rank A := finrank R &lt;| span R &lt;| range Aᵀ</code> is a one-line improvement to the generality of the current definition as well.</p>",
        "id": 501521563,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1740397964
    },
    {
        "content": "<p>Bumping this. The material in this one is the first step to a sensible API for bases of the row and column space of a matrix as sets. The need for this came up, for example, in  <a class=\"stream-topic\" data-stream-id=\"217875\" href=\"/#narrow/channel/217875-Is-there-code-for-X.3F/topic/Gaussian.20Elimination.20for.20Matrices/with/437918422\">#Is there code for X? &gt; Gaussian Elimination for Matrices</a></p>",
        "id": 505130159,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741785512
    },
    {
        "content": "<p>Thanks for the ping. I have one question. Please ping me again, because I agree it will be good to get this in soon.</p>",
        "id": 505340674,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741851398
    },
    {
        "content": "<p>As per my reply to the comment, I think I might need some help with the universe-wrangling if we want a fully type-heterogeneous version for submatrix monotonicity. I already needed help for the three-universe case that's in there.  (<a class=\"stream-topic\" data-stream-id=\"217875\" href=\"/#narrow/channel/217875-Is-there-code-for-X.3F/topic/Cardinal.20lift.20problem/with/501399956\">#Is there code for X? &gt; Cardinal lift problem</a> )</p>",
        "id": 505472209,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741883953
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"329425\">@Peter Nelson</span> I pushed something to your branch. I need to run now. I think it could maybe be cleaned / golfed a bit.</p>",
        "id": 505476773,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741885095
    },
    {
        "content": "<p>I pushed some more cleanup and highlighted a remaining golf location</p>",
        "id": 505503463,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741892305
    },
    {
        "content": "<p>My general tip for universe-adjacent code is to do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">ul</span><span class=\"w\"> </span><span class=\"n\">um</span><span class=\"w\"> </span><span class=\"n\">un</span><span class=\"w\"> </span><span class=\"n\">uo</span><span class=\"w\"> </span><span class=\"n\">uR</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">ul</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">um</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">un</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">uo</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">uR</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>because it's much easier to understand the issue in errors about unifying<code>max ul um uR</code> and <code>max un um uR</code> than random numeric universes.</p>",
        "id": 505503644,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741892369
    },
    {
        "content": "<p>Sorry, I messed things up with the latest push - I was golfing Johan's code simultaneously. </p>\n<p>I am going to revert to <code>m/m_0</code> notation for types rather than <code>l m n o</code>, to avoid confusion about which is the smaller, and which are the rows and columns.</p>",
        "id": 505505180,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741892837
    },
    {
        "content": "<p>They don't have to be smaller, right?</p>",
        "id": 505505614,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741892999
    },
    {
        "content": "<p>Note that there is precedent for such names around</p>\n<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> Matrix.submatrix</p>",
        "id": 505505730,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741893031
    },
    {
        "content": "<p>Sure, but 'sub' is an evocative term and in 90% of cases they are. Nobody would guess the type naming incorrectly the way I'm doing it.</p>",
        "id": 505505731,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741893031
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Matrix/Defs.html#Matrix.submatrix\">Matrix.submatrix</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Matrix/Defs.html#Matrix.submatrix_id_id\">Matrix.submatrix_id_id</a>, and <a href=\"https://loogle.lean-lang.org/?q=Matrix.submatrix\">100 more</a></p>",
        "id": 505505733,
        "sender_full_name": "loogle",
        "timestamp": 1741893032
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"329425\">Peter Nelson</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322226.20Infinite.20matrix.20rank/near/505505180\">said</a>:</p>\n<blockquote>\n<p>Sorry, I messed things up with the latest push - I was golfing Johan's code simultaneously.</p>\n</blockquote>\n<p>Are you happy for me to revert to f2073e1ac0f203cc3ac07b3d75a5cc465369daf0 to get the versions I had there?</p>",
        "id": 505506233,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741893193
    },
    {
        "content": "<p>I'm just about to push a fix with a shorter proof than the one in your PR. gimme a sec</p>",
        "id": 505506414,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741893246
    },
    {
        "content": "<p>All I really care about is that the statements and theorem names are <a href=\"https://github.com/leanprover-community/mathlib4/blob/f2073e1ac0f203cc3ac07b3d75a5cc465369daf0/Mathlib/Data/Matrix/Rank.lean#L45C1-L70C44\">what I had there</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">lift_cRank_submatrix_le</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">lift</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">un</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">submatrix</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cRank</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">lift</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">ul</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">cRank</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- your proof</span>\n\n<span class=\"sd\">/-- A copy of `lift_cRank_submatrix_le` for when `l` and `n` are in the same universe. -/</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">cRank_submatrix_le</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">uln</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">uln</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">submatrix</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cRank</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">cRank</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">lift_cRank_submatrix_le</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>\n<p>and that all the <code>id</code> lemmas get dropped</p>",
        "id": 505506668,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741893327
    },
    {
        "content": "<p>My push just did that. I'm happy with this - I incorrectly assumed that the heterogeneous lemma would have five universes appearing in the statement rather than three. I'ts much nicer this way.</p>",
        "id": 505506956,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741893409
    },
    {
        "content": "<p>You've still got all the id lemmas floating around that were deliberately removed in my version</p>",
        "id": 505507083,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741893462
    },
    {
        "content": "<p>Ok, I'll take care of that.</p>",
        "id": 505507119,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741893476
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"329425\">Peter Nelson</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322226.20Infinite.20matrix.20rank/near/505505731\">said</a>:</p>\n<blockquote>\n<p>Sure, but 'sub' is an evocative term and in 90% of cases they are. Nobody would guess the type naming incorrectly the way I'm doing it.</p>\n</blockquote>\n<p>There's no precedent for using <code>m₀</code> and <code>n₀</code> around <code>submatrix</code> according to loogle, but plenty of precedent for <code>l m n o</code> in some order. I'd prefer that we remain consistent and reused the existing variables in the file.</p>",
        "id": 505507389,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741893556
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"329425\">Peter Nelson</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322226.20Infinite.20matrix.20rank/near/505506414\">said</a>:</p>\n<blockquote>\n<p>I'm just about to push a fix with a shorter proof than the one in your PR. gimme a sec</p>\n</blockquote>\n<p>I think mine was longer because I inlined the id lemmas into the general one</p>",
        "id": 505507465,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741893583
    },
    {
        "content": "<p>I think the current convention is consistently problematic. <code>m</code> being the rows and <code>n</code> being the columns is a form of consistency that comes with benefits to the user - that of immediately knowing what the types mean from their name.</p>",
        "id": 505507964,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741893746
    },
    {
        "content": "<p>Using the letters in the roman alphabet in the order they appear is a convention with no mathematical meaning.</p>",
        "id": 505508327,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1741893869
    },
    {
        "content": "<p>Thanks, <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> for your very detailed reviewing! Do you think this is ready to merge?</p>",
        "id": 506203088,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1742228759
    }
]