[
    {
        "content": "<p>Starting a thread per <span class=\"user-mention\" data-user-id=\"110050\">@S√©bastien Gou√´zel</span>'s comment:</p>\n<blockquote>\n<p>I am not convinced that we should merge this now. I agree that there is a performance improvement, but if we want to go this way we should probably do it for the other classes like NormedAddCommGroup and friends. I expect this will give much bigger performance improvement even, but at the expense of a reduced readability of typeclasses declarations. Until we have a way to shortcut variables declarations (something like <code>[[NormedAddCommGroup E]]</code> which would automatically register the lower typeclasses), I am not convinced that the performance gain outweighs the readability loss. But in any case this is a major design decision with consequences all over mathlib, so this should definitely be discussed thoroughly on Zulip before any PR in this direction is merged and we have a clear plan to go forward.</p>\n</blockquote>",
        "id": 536024350,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1756128067
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28803\">#28803</a></p>",
        "id": 536027787,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1756129282
    },
    {
        "content": "<p>Regarding the <code>[[NormedAddCommGroup E]]</code> idea, S√©bastien has a few more posts starting here <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512234387\">#mathlib4 &gt; Normed modules @ üí¨</a>  which go more in-depth into what we want here. This is certainly a feature which has been requested since before the port to Lean 4, so perhaps in parallel with this thread, we should try and put together a specification / try to find someone who can get started on it.</p>",
        "id": 536031384,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1756130353
    },
    {
        "content": "<p>Regarding the proliferation of typeclasses: let me point out that this is not specific to this particular unbundling/slowdown phenomenon; this is happening all over mathlib. For example the way to say \"Let L/K be a finite Galois extension of number fields with Galois group G, which then obviously also acts on the integers B of L fixing the integers A of K\" is this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let K be a number field with ring of integers A</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NumberField</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsFractionRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let L be a number field containing K</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NumberField</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">-- and let B be the integers of L (which of course contains A)</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Let G be the Galois group of L/K</span>\n<span class=\"w\">    </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">SMulCommClass</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">IsInvariant</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">SMulCommClass</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">IsInvariant</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Then we can do stuff</span>\n</code></pre></div>\n<p>and this is often just the first half of the sentence; one might want to also go on and make claims about Galois groups acting on completions or on residue fields etc etc. The whole thing is completely out of control in terms of readability and this issue is independent of the unbundling question.</p>",
        "id": 536060458,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756138604
    },
    {
        "content": "<p>I am very unclear about the fix for this, because people want to say lots of different but related things, but my instinct has been to just think \"yeah well someone might come and clean this up someday\" and I'm pretty convinced that more monstrosities like this will be appearing whether or not we refactor how we do normed algebra, so somehow it doesn't quite feel like a relevant concern to me.</p>",
        "id": 536061361,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756138898
    },
    {
        "content": "<p>How much shorter would your example get if we had some kind of <code>[[]]</code> notation today? Is there a point where things get unreadable even then?</p>",
        "id": 536065049,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1756140106
    },
    {
        "content": "<p>I don't know how the <code>[[]]</code> notation is supposed to work in my example. This is just an example of a general \"AKLB phenomenon\" where the proliferation occurs.</p>",
        "id": 536066236,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756140488
    },
    {
        "content": "<p>Differential geometry also has a huge amount of typeclass soup. My best plan for supervising students is to make a cheat sheet \"this is the right soup for your case\" with typeclass incantations to copy-paste. Unbundling may make this worse, but going from \"copy-paste 3 lines\" to \"copy-paste four lines\" is not that significant.</p>",
        "id": 536074257,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756143320
    },
    {
        "content": "<p>I guess my feeling is that we should take the speed-up and live with the readability loss because the speed-up benefits everyone, including people who are not using these parts of the library (it speeds up CI etc) and the readability loss (which affects fewer people) will be fixed when someone who understands how to fix it and cares enough to fix it, fixes it.</p>",
        "id": 536075180,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756143660
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/536075180\">said</a>:</p>\n<blockquote>\n<p>the readability loss (which affects fewer people) will be fixed when someone who understands how to fix it and cares enough to fix it, fixes it.</p>\n</blockquote>\n<p>My fear is that it's never fixed. And if it's never fixed, I'm not sure we should favor performance over readability. Because the machines will get faster, but the human brains won't, so better optimize for the human brain. For instance, it has been argued recently that if using <code>grind</code> makes a proof twice slower but twice shorter -- so, improves readability over performance -- then we should take it.</p>",
        "id": 536087791,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756148220
    },
    {
        "content": "<p>(I had forgotten that Kyle had worked on a version of the <code>[[]]</code>: <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Introducing.20all.20dependent.20variables/with/345287477\">#mathlib4 &gt; Introducing all dependent variables</a>. Let me ask there what the status is...)</p>",
        "id": 536089996,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1756148999
    },
    {
        "content": "<p>If the choice is between merging now (and thus making the library a little more unreadable) and then waiting to see if readability gets fixed, and waiting to see if readability gets fixed during which time this PR will inevitably rot, is it better to merge this one now but then impose the position that no further work should be done in this direction (e.g. the further work I suggest in the PR which will make the library a little more unreadable again) until we've figured out how to make the library readable again?</p>\n<p>To give some concrete example: on master right now we have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œµ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ESeminormedAddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n</code></pre></div>\n<p>and after <a href=\"https://github.com/leanprover-community/mathlib4/pull/28803\">#28803</a> we will have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œµ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ESeminormedAddMonoid</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n</code></pre></div>\n<p>and after my proposed further refactor we will have something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œµ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ENorm</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">IsESeminormedAddMonoid</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsContinuousENorm</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>. So a nice test case for <code>[[]]</code> would be whether this last thing could be turned into something as nice as the first thing.</p>",
        "id": 536104708,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756154419
    },
    {
        "content": "<p>I think there is a readability loss here by allowing the enormed versions to go out of sync with the normed ones.</p>",
        "id": 536111652,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756157081
    },
    {
        "content": "<p>Verbose *and\" inconsistent is not a great mix, since there's then more space to make errors and they're harder to spot</p>",
        "id": 536111893,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756157206
    },
    {
        "content": "<p>Can you elaborate what you mean by \"out of sync\"? To some extent, that is already the case; if I want to change <code>NormedAddCommGroup</code> to <code>ENormedAddMonoid</code>, I need to add <code>TopologicalSpace</code> (for mathematical reasons).</p>",
        "id": 536112095,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756157307
    },
    {
        "content": "<p>(For the record, <a href=\"https://github.com/leanprover-community/mathlib4/pull/23966\">#23966</a> unbundled {Seminormed,Normed}{Add,}{Comm,}Group: it was an order of magnitude larger (3000 lines diff), as rotted for several months now, and the performance was a bit of a wash back then.)</p>",
        "id": 536112214,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756157365
    },
    {
        "content": "<p>My impression was that the light unbundling performed in 28803 (as opposed to the \"full unbundling\" Kevin describes) strikes some middle ground between performance and readability. I would indeed be opposed to the full deal, until we can make things decently readable again. But the enorm changes alone seems not too bad for me.</p>",
        "id": 536112511,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756157494
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/536112095\">said</a>:</p>\n<blockquote>\n<p>To some extent, that is already the case; if I want to change <code>NormedAddCommGroup</code> to <code>ENormedAddMonoid</code>, I need to add <code>TopologicalSpace</code> (for mathematical reasons).</p>\n</blockquote>\n<p>Are there any mathematical reasons for not including <code>TopologicalSpace</code> in <code>ENormedAddMonoid</code>? I understand it's not uniquely determined, but is that enough of a reason?</p>",
        "id": 536159992,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1756186145
    },
    {
        "content": "<p>Doesn't this design suggestion go directly in the opposite direction to what we're trying to achieve? There are no mathematical reasons for <code>OrderedAddMonoid</code> not existing but it made typeclass inference much slower.</p>",
        "id": 536196420,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756200887
    },
    {
        "content": "<p>Yes, there are: ENNReal (the motivating example for the ENorm design) has a topology, but it is <em>not</em> the one induced by its enorm, but the order topology. You want to provide the topology separately --- unlike for <code>NormedAddCommGroup</code>s (where the norm induces the topology).</p>",
        "id": 536200805,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756202133
    },
    {
        "content": "<p>Okay, but why can't <code>ENormedAddMonoid</code> come with a topology anyway? My concern is expectability compared to <code>NormedAddCommGroup</code></p>",
        "id": 536218193,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1756208946
    },
    {
        "content": "<p>The payoff for unbundling the algebra hierarchy from anything is much higher than for the other hierarchies. If performance is the motivating factor, then I would only separate this out until evidence emerges that further unbundling is required.</p>",
        "id": 536228640,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756212341
    },
    {
        "content": "<p>I'm coming back to this thread after finally going through the discussion in <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/variable.21/with/434445176\">#mathlib4 &gt; variable!</a>. It seems to me that <code>variable?</code> is a first step towards address the readability issues we're discussing here, but we just haven't been using it. I didn't even know about it (or I forgot about its existence) until yesterday. </p>\n<p>Unless there's something I'm missing, it doesn't seem like the readability problems with typeclass soup are totally out of reach -- aren't we in a position where we can start using <code>variable?</code> (or the hypothetical <code>variable!</code> variant, I guess) to reduce \"typeclass soup\" and then try to improve the parts that don't work well?</p>",
        "id": 536288270,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1756231349
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/536104708\">said</a>:</p>\n<blockquote>\n<p>So a nice test case for <code>[[]]</code> would be whether this last thing could be turned into something as nice as the first thing.</p>\n</blockquote>\n<p>I have an RFC (<a href=\"https://github.com/leanprover/lean4/pull/8279\">lean#8279</a>) for a different approach for improving readability in the type class maze. In my suggested solution, we can do all of the above performance optimizations, while maintaining the original types and notation. In your concrete example, this would mean that we would define</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">ESeminormedAddCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">E</span>\n<span class=\"w\">  </span><span class=\"n\">ENorm</span><span class=\"w\"> </span><span class=\"n\">E</span>\n<span class=\"w\">  </span><span class=\"n\">IsESeminormedAddMonoid</span><span class=\"w\"> </span><span class=\"n\">E</span>\n<span class=\"w\">  </span><span class=\"n\">IsConinuousENorm</span><span class=\"w\"> </span><span class=\"n\">E</span>\n</code></pre></div>\n<p>The effect would be that we can still work with <code> ESeminormedAddCommMonoid E</code> as we do currently, but under the hood, type class search uses the more granular type classes.</p>",
        "id": 536312328,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756242345
    },
    {
        "content": "<p>I think I love it! It's not completely clear to me if it's better to introduce this as a first class citizen, like you do in the RFC, or if this should just be a notation-like thing. I mean the following: If you declare</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">VectorSpace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">VectorSpace</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>with the current RFC when proving a lemma you would have assumptions <code>[Semiring K] [VectorSpace K V] [AddCommGroup V] [Module K V]</code>, where the latter two would be created automatically from the class abbrev (and there would be a mechanism for this). </p>\n<p>Another possibility would be that, in the <code>variable</code> line, <code>[VectorSpace K V]</code> is expanded implicitly to <code>[AddCommGroup V] [Module K V]</code>, in the sense that the former would just be a notation for the latter. The question is what is easier/cleaner to implement, which I can't say anything about.</p>",
        "id": 536391208,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756290856
    },
    {
        "content": "<p>I envisioned it so that the only visible assumptions are <code>[Semiring K] [VectorSpace K V]</code>. The assumptions <code>[AddCommGroup V] [Module K V]</code> would only be stored inside of <code>LocalInstances</code>, which is a list of instances that is not visible to the user, only to type-class search.</p>\n<p>I should probably make that clearer in the RFC.</p>",
        "id": 536391732,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756291121
    },
    {
        "content": "<p>In any case, this would go a long way solving our spaghetti classes in differential geometry, while being completely predictable and not relying on typeclass inference, so it shouldn't have any performance impact.</p>\n<p>For instance, the declaration of two smooth manifolds over a field <code>ùïú</code> would go from</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NontriviallyNormedField</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelWithCorners</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ChartedSpace</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsManifold</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">E'</span><span class=\"w\"> </span><span class=\"n\">H'</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">H'</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">I'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelWithCorners</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E'</span><span class=\"w\"> </span><span class=\"n\">H'</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ChartedSpace</span><span class=\"w\"> </span><span class=\"n\">H'</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsManifold</span><span class=\"w\"> </span><span class=\"n\">I'</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NontriviallyNormedField</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SpaceWithNormedModel</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelWithCorners</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Manifold</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">E'</span><span class=\"w\"> </span><span class=\"n\">H'</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SpaceWithNormedModel</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E'</span><span class=\"w\"> </span><span class=\"n\">H'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">I'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelWithCorners</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E'</span><span class=\"w\"> </span><span class=\"n\">H'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Manifold</span><span class=\"w\"> </span><span class=\"n\">I'</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">M'</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 536391980,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756291252
    },
    {
        "content": "<p>It could of course also be a notation-like thing. But that only helps to improve the source code. It doesn't change hover info, or the mathlib docs.</p>",
        "id": 536394480,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756292205
    },
    {
        "content": "<p>In your RFC, if we have around assumptions <code>[AddCommGroup V] [Module K V]</code>, would a lemma assuming <code>[VectorSpace K V]</code> apply? This would be the case with the notation-like viewpoint, and I think that's really important to ensure.</p>",
        "id": 536398956,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756294137
    },
    {
        "content": "<p>Another comment is that this would be great for refactors. For instance, say we want to unbundle algebra from topology in <code>[NormedAddCommGroup G]</code> and <code>[NontriviallyNormedField ùïú]</code>. In the current situation, this would mean changing the definition, and also all the <code>variable</code> lines using these in many many files. With your RFC, one would just change the definition and add a <code>class abbrev</code>, making it much easier to write, to read, and to review.</p>",
        "id": 536399560,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756294360
    },
    {
        "content": "<p>Yes, in my RFC, the constructor of the <code>class abbrev</code>, in this case <code>VectorSpace.mk</code>, is the only instance of the class. So when synthesizing <code>[VectorSpace K V]</code>, it will first look for a local instance of type <code>VectorSpace K V</code>, and otherwise it will apply <code>VectorSpace.mk</code> and search for <code>[AddCommGroup V]</code> and then <code>[Module K V]</code>.</p>",
        "id": 536399793,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756294452
    },
    {
        "content": "<p>By the way, this already works with the current implementation of <code>class abbrev</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">VectorSpace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">VectorSpace</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span>\n</code></pre></div>\n<p>My RFC is just about making it not be a (performance) footgun</p>",
        "id": 536400568,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756294773
    },
    {
        "content": "<p>Color me somewhat skeptical about using typeclass synthesis to in some way solve issues about typeclass synthesis. Though feel free to disabuse me of this skepticism.</p>\n<p>What is the argument against a macro + minimal elaborator + environmental extension to track aliases (in particular no hooking into typeclass resolution)?</p>",
        "id": 536421295,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756301490
    },
    {
        "content": "<p>For what it's worth, I am convinced that Jovan's solution would work very well, with an implementation cost that wouldn't be too bad. If core is not interested, we could switch to a more notation-like model, but that would be suboptimal in terms of readability and docgen. <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>, do you have some opinions on the RFC?</p>",
        "id": 536426316,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756302939
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/536421295\">said</a>:</p>\n<blockquote>\n<p>Color me somewhat skeptical about using typeclass synthesis to in some way solve issues about typeclass synthesis. Though feel free to disabuse me of this skepticism.</p>\n</blockquote>\n<p>Maybe your scepticism comes from the fact that usually, adding more type classes makes type class search slower. For example, adding a new class <code>MyFavouriteField Œ±</code> means that this class needs to be tried every time when you write an operation like <code>+</code>, <code>-</code>, <code>/</code>, or if you synthesize <code>AddGroup _</code>.</p>\n<p>The difference is that a <code>class abbrev</code> will never show up in the type class search of an \"unrelated\" class like <code>Add</code> (that is, after my RFC is implemented). This means that however many <code>class abbrev</code>s you define/import, it won't slow down other type class searches.</p>\n<p>It will only appear in the type class search if the type class search goal or a local variable is the <code>class abbrev</code> in question (or a <code>class abbrev</code> defined in terms of the <code>class abbrev</code>).</p>",
        "id": 536432275,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756304562
    },
    {
        "content": "<p>What is the instance synthesis path from <code>MyFavoriteField</code> to <code>Add</code>?</p>",
        "id": 536432785,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756304702
    },
    {
        "content": "<p>It is somewhat long:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Search for Add given MyFavouriteField</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>import Mathlib\n\nclass MyFavouriteField (Œ± : Type*) extends Field Œ±\n\nvariable [MyFavouriteField Œ±]\n\nset_option trace.Meta.synthInstance true\n#synth Add Œ±\n/-\n[Meta.synthInstance] ‚úÖÔ∏è Add Œ± ‚ñº\n  [] new goal Add Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @Distrib.toAdd to Add Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NonUnitalNonAssocSemiring.toDistrib to Distrib Œ± ‚ñ∂\n  [] ‚ùåÔ∏è apply @DirectSum.GradeZero.nonUnitalNonAssocSemiring to NonUnitalNonAssocSemiring Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NonUnitalNonAssocCommSemiring.toNonUnitalNonAssocSemiring to NonUnitalNonAssocSemiring Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NonUnitalNonAssocCommRing.toNonUnitalNonAssocCommSemiring to NonUnitalNonAssocCommSemiring Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NonUnitalCommRing.toNonUnitalNonAssocCommRing to NonUnitalNonAssocCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NonUnitalNormedCommRing.toNonUnitalCommRing to NonUnitalCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NonUnitalCommCStarAlgebra.toNonUnitalNormedCommRing to NonUnitalNormedCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply CommCStarAlgebra.toNonUnitalCommCStarAlgebra to NonUnitalCommCStarAlgebra Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NormedCommRing.toNonUnitalNormedCommRing to NonUnitalNormedCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @CommCStarAlgebra.toNormedCommRing to NormedCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NormedField.toNormedCommRing to NormedCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @DenselyNormedField.toNormedField to NormedField Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @RCLike.toDenselyNormedField to DenselyNormedField Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NontriviallyNormedField.toNormedField to NormedField Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @DenselyNormedField.toNontriviallyNormedField to NontriviallyNormedField Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NonUnitalSeminormedCommRing.toNonUnitalCommRing to NonUnitalCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @SeminormedCommRing.toNonUnitalSeminormedCommRing to NonUnitalSeminormedCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NormedCommRing.toSeminormedCommRing to SeminormedCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @NonUnitalNormedCommRing.toNonUnitalSeminormedCommRing to NonUnitalSeminormedCommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @CommRing.toNonUnitalCommRing to NonUnitalCommRing Œ± ‚ñ∂\n  [] ‚ùåÔ∏è apply @DirectSum.GradeZero.commRing to CommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @EuclideanDomain.toCommRing to CommRing Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @Field.toEuclideanDomain to EuclideanDomain Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply @MyFavouriteField.toField to Field Œ± ‚ñ∂\n  [] ‚úÖÔ∏è apply inst‚úù to MyFavouriteField Œ± ‚ñ∂\n  [resume] propagating MyFavouriteField Œ± to subgoal MyFavouriteField Œ± of Field Œ± ‚ñ∂\n  [resume] propagating Field Œ± to subgoal Field Œ± of EuclideanDomain Œ± ‚ñ∂\n  [resume] propagating EuclideanDomain Œ± to subgoal EuclideanDomain Œ± of CommRing Œ± ‚ñ∂\n  [resume] propagating CommRing Œ± to subgoal CommRing Œ± of NonUnitalCommRing Œ± ‚ñ∂\n  [resume] propagating NonUnitalCommRing Œ± to subgoal NonUnitalCommRing Œ± of NonUnitalNonAssocCommRing Œ± ‚ñ∂\n  [resume] propagating NonUnitalNonAssocCommRing Œ± to subgoal NonUnitalNonAssocCommRing Œ± of NonUnitalNonAssocCommSemiring Œ± ‚ñ∂\n  [resume] propagating NonUnitalNonAssocCommSemiring Œ± to subgoal NonUnitalNonAssocCommSemiring Œ± of NonUnitalNonAssocSemiring Œ± ‚ñ∂\n  [resume] propagating NonUnitalNonAssocSemiring Œ± to subgoal NonUnitalNonAssocSemiring Œ± of Distrib Œ± ‚ñ∂\n  [resume] propagating Distrib Œ± to subgoal Distrib Œ± of Add Œ± ‚ñ∂\n  [] result CommRing.toNonUnitalCommRing.toNonUnitalNonAssocCommRing.toNonUnitalNonAssocCommSemiring.toDistrib.toAdd\n-/\n</code></pre></div>\n</div></div>",
        "id": 536433769,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756304965
    },
    {
        "content": "<p>In what context do we have <code>MyFavoriteField.toField</code> available?</p>",
        "id": 536434157,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756305077
    },
    {
        "content": "<p>If you write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MyFavouriteField</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n</code></pre></div>\n<p>which is the usual way to extend the algebraic hierarchy, then <code>MyFavouriteField.toField</code> is automatically added as an instance.</p>",
        "id": 536434394,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756305148
    },
    {
        "content": "<p>I am confused that there is no <code>class abbrev</code> in your example.</p>",
        "id": 536435553,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756305526
    },
    {
        "content": "<p>Oh, sorry I misunderstood your question.</p>\n<p>If we define <code>MyFavouriteField </code> using <code>class abbrev</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">MyFavouriteField</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n<span class=\"w\">  </span><span class=\"n\">SomeOtherClass</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n</code></pre></div>\n<p>Then the following would happen:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MyFavouriteField</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>would add to the local context the variable <code>inst : MyFavouriteField Œ±</code> and would add to the local instances the instances <code>inst : MyFavouriteField Œ±</code>, <code>inst.toField : Field Œ±</code> and <code>inst.toSomeOtherClass : SomeOtherClass Œ±</code>. Then in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">Œ±</span>\n</code></pre></div>\n<p>The search path would go through the same as above until it hit <code>Field Œ±</code>, and then it is done by the instance <code>inst.toField</code>. Even if there was no instance of type <code>Field Œ±</code>, it would not search for an instance of <code>MyFavouriteField Œ±</code>.</p>",
        "id": 536438656,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756306413
    },
    {
        "content": "<p>I'm confused about something with this suggestion. Let's say that <code>MyRing Œ±</code> and <code>MyStrongerRing Œ±</code> are both <code>class abbrev</code>s for <code>Ring Œ±</code> + some other stuff, and that the typeclasses for for <code>MyStrongerRing</code> imply those for <code>MyRing</code> (but <code>MyRing</code> is <em>not</em> one of the listed classes in <code>MyStrongerRing</code>). Then I write a theorem <code>foo [MyRing Œ±] : ...</code>. I can't then directly apply that theorem to a context where I have <code>[MyStrongerRing Œ±]</code> because there is no instance of <code>MyStrongerRing.toMyRing</code>, right? (I mean, I could first <em>build</em> a <code>MyRing Œ±</code>, but that wouldn't work in statements, and it would be cumbersome in proofs.)</p>\n<p>Presumably I've misunderstood something, but I don't see where.</p>",
        "id": 536452466,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1756310351
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span>, I had the same question, and Jovan has already answered above:</p>\n<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/536399793\">said</a>:</p>\n<blockquote>\n<p>Yes, in my RFC, the constructor of the <code>class abbrev</code>, in this case <code>VectorSpace.mk</code>, is the only instance of the class. So when synthesizing <code>[VectorSpace K V]</code>, it will first look for a local instance of type <code>VectorSpace K V</code>, and otherwise it will apply <code>VectorSpace.mk</code> and search for <code>[AddCommGroup V]</code> and then <code>[Module K V]</code>.</p>\n</blockquote>",
        "id": 536453128,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756310556
    },
    {
        "content": "<p>In your case, you need <code>MyRing Œ±</code> to apply your lemma, and it will be synthesized if (and only if!) all the classes appearing in <code>MyRing Œ±</code> can be synthetized by typeclass inference.</p>",
        "id": 536453305,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756310627
    },
    {
        "content": "<p>I guess that a macro expanding to <code>class abbrev</code> + <code>attribute [instance 0] X.toY ...</code> plus some scoped instances would be pretty close to functionally equivalent (expecting users to open namespaces)?</p>",
        "id": 536453777,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756310793
    },
    {
        "content": "<p>Aha, so the idea is that (in the RFC) <code>class abbrev</code> globally allows you to bundle subclasses to make the larger class, but it only <em>locally</em> allows you to unbundle those classes.</p>",
        "id": 536453882,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1756310826
    },
    {
        "content": "<p>I think I love this.</p>",
        "id": 536454025,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1756310876
    },
    {
        "content": "<p>Isn't <code>attribute [instance 0] X.toY</code> tried after all other instances have been tried? If so, then it wouldn't be functionally equivalent, because failure times could increase a lot.</p>",
        "id": 536454637,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756311081
    },
    {
        "content": "<p>Moreover, to change the way in which local instances are added we really need to make a change in core Lean.</p>",
        "id": 536454779,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756311131
    },
    {
        "content": "<p>Sure, but that is not the key point. You can reach in and remove it from the instance extension after declaring with some other incantation that I forgot now.</p>",
        "id": 536454789,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756311133
    },
    {
        "content": "<p>So <code>variable</code> and <code>def/theorem</code> would read some list of class abbrevs from the environment and then add the ones that match?</p>",
        "id": 536455044,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756311223
    },
    {
        "content": "<p>Exactly, It already works like this for <code>class</code>. Each new local declaration's type is checked to see if it is a class, and if so, it is added to the local instances. I propose to then also check if it is a <code>class abbrev</code> and if so, add the extra local instances.</p>",
        "id": 536455744,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756311463
    },
    {
        "content": "<p>We don't record <code>class abbrev</code>'s anywhere yet do we?</p>",
        "id": 536456063,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756311564
    },
    {
        "content": "<p>The current implementation is just a macro. The doc-string says it expands</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">params</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">D_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">D_n</span>\n</code></pre></div>\n<p>into</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">params</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">D_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">D_n</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">mk</span>\n</code></pre></div>",
        "id": 536456575,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756311716
    },
    {
        "content": "<p>Why should it be called <code>class abbrev</code>? The name would be a little bit misleading, as both <code>class</code> and <code>abbrev</code> have some meaning which you're overriding here.</p>",
        "id": 536456677,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756311746
    },
    {
        "content": "<p>Perhaps <code>class_alias</code>? Someone might have a better idea.</p>",
        "id": 536457326,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756311998
    },
    {
        "content": "<p>Though you could also convince me to keep it as is.</p>",
        "id": 536457590,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756312081
    },
    {
        "content": "<p><code>class_bundle</code>? Or <code>classBundle</code> :-)</p>",
        "id": 536457652,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756312107
    },
    {
        "content": "<p>In terms of things we could do today in mathlib, it seems like we could </p>\n<ul>\n<li>declare a new command <code>class_bundle</code> which expands to the same syntax as <code>class abbrev</code> but runs a command to delete the projection instances</li>\n<li>declare a new command <code>bundle_install</code> which adds the desired instances to the local instance cache</li>\n<li>work around <code>def/theorem</code>'s and <code>let/have</code>'s. Custom commands for the former seems strange but there is precedent for the latter. </li>\n</ul>\n<p>I agree that going through core is more elegant but I doubt it will be done in the near future. </p>\n<p>How much that is an overlap of <code>variable?</code> without its typeclass synthesis features?</p>",
        "id": 536459045,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1756312574
    },
    {
        "content": "<p>The annoying part is that we need to make <code>withLocalDecl</code> add the extra instances into the local instances. So the minimal change in core would be to make <code>withLocalDecl</code> extensible. Then in mathlib, we could supply the function that figures out which local instances should be added based on if the class is a <code>class_bundle</code>. But this is such an unnatural thing to make extensible that I doubt core will want to do it.</p>",
        "id": 536461004,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756313286
    },
    {
        "content": "<p>Coming back to <a href=\"https://github.com/leanprover-community/mathlib4/pull/28803\">#28803</a>, is the conclusion that we'll put it (and future such unbundling refactors) on hold until there's some clarity on what will happen on <a href=\"https://github.com/leanprover/lean4/pull/8279\">lean#8279</a> ?</p>",
        "id": 536831098,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1756487479
    },
    {
        "content": "<p>Yes, I think that's the wisest move. If <a href=\"https://github.com/leanprover/lean4/pull/8279\">lean#8279</a> becomes a thing, refactors will be much easier (to the point that we can test several strategies and see what gives the best performance outcome)</p>",
        "id": 536832826,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1756488177
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> would you be willing to make a branch with the necessary changes to core? I wonder whether core might be more tempted to jump at it if there was some evidence we might be able to point to for its utility.</p>\n<p>If it's too much work, just say so.</p>",
        "id": 536850837,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1756495837
    },
    {
        "content": "<p>I've made an attempt at <a href=\"https://github.com/leanprover/lean4/pull/10178\">lean#10178</a>. Since I changed the <code>class</code> environment extension, I think there might be some bootstrapping problem that I don't understand. Anyways, there is a mysterious build error.</p>",
        "id": 536914640,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756560231
    },
    {
        "content": "<p>Ok, the lean toolchain from the PR now has an implementation of the new <code>class abbrev</code>. The following code works as a MWE showing that it works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">class_abbrev</span><span class=\"kd\">]</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">toA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">toB</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">mk</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"c1\">-- fails without a time-out</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"mi\">100000</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 537671207,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756992078
    },
    {
        "content": "<p>To get mathlib building with this, I need to fix an error in Qq, but I wasn't sure what the best way is to do that.</p>",
        "id": 537671465,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756992136
    },
    {
        "content": "<p>As in, I know how to fix it, but there is no adaptation branch to push the change to</p>",
        "id": 537673350,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756992655
    },
    {
        "content": "<p>I've created a branch <a href=\"https://github.com/leanprover-community/quote4/tree/lean-pr-testing-10178\">https://github.com/leanprover-community/quote4/tree/lean-pr-testing-10178</a> on Qq that you can open PRs to; please ping me when you need them to be merged.</p>",
        "id": 537675331,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1756993207
    },
    {
        "content": "<p>Ok, I've made a PR: <a href=\"https://github.com/leanprover-community/quote4/pull/99\">https://github.com/leanprover-community/quote4/pull/99</a></p>",
        "id": 537681530,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756994902
    },
    {
        "content": "<p>I tried opening <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/pull/54\">a PR</a> into the mathlib4-nightly-testing branch pointing it to the new Qq branch but it seems like there's still <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/17468725775/job/49611292387?pr=54#step:19:221\">an error</a>.</p>",
        "id": 537699387,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1756999601
    },
    {
        "content": "<p>Here's a fixed version of the PR: <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/pull/55\">https://github.com/leanprover-community/mathlib4-nightly-testing/pull/55</a></p>",
        "id": 537778426,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757035291
    },
    {
        "content": "<p>Merged, thanks!</p>",
        "id": 537779127,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1757035873
    },
    {
        "content": "<p>Do I understand correctly that the branch here has a working mathlib, and that we can start experimenting with it, or showcasing it? </p>\n<p>If so, could you briefly say what syntax we should use? Is <code>class abbrev foo extends ...</code> enough, or should we use a structure with <code>@[class_abbrev]</code> and declaring manually the <code>.mk</code> instance as you do above?</p>",
        "id": 537798495,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1757051967
    },
    {
        "content": "<p>Yes, correct. The syntax isn't in its final form yet, and is how I wrote it in the example above:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">class_abbrev</span><span class=\"kd\">]</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyClassAbbrev</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">toA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">toB</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Followed by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">MyClassAbbrev</span><span class=\"bp\">.</span><span class=\"n\">mk</span>\n</code></pre></div>\n<p><code>class abbrev</code> still does the old behaviour for now.</p>",
        "id": 537819784,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757061224
    },
    {
        "content": "<p>Just tried it, but</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">binary</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">provided</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">windows'</span>\n</code></pre></div>\n<p><span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 537826744,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1757063660
    },
    {
        "content": "<p>Ah yes, you can work around this by usid Gitpod (it will soon stop existing I think), or locally by using WSL.</p>",
        "id": 537829716,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757064611
    },
    {
        "content": "<p>To use Gitpod, just press the \"Open in Gitpod\" button in <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/pull/55\">https://github.com/leanprover-community/mathlib4-nightly-testing/pull/55</a></p>",
        "id": 537834343,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757066121
    },
    {
        "content": "<p>Works fine with WSL, thanks.</p>",
        "id": 537853516,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1757073479
    },
    {
        "content": "<p>I have experimented a little bit, and I have a bug report (unless I am doing something wrong). On branch <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/tree/SG_test\">https://github.com/leanprover-community/mathlib4-nightly-testing/tree/SG_test</a>, where I just change the file <code>Mathlib/Analysis/Normed/Group/Basic.lean</code>, I get a failure down in this file, in the lines</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SeminormedCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SeminormedCommGroup</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">}</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œµ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ESeminormedCommMonoid</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">dist_inv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">dist</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Åª¬π</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">dist</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">‚Åª¬π</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">dist_eq_norm_div</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">norm_inv'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">‚Åª¬π</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">inv_div</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">div_inv_eq_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_comm</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I have only bundled things for <code>ESeminormedCommMonoid</code>, so this should not play any role in this lemma as only <code>E</code> is used, not <code>Œµ</code>. But the last <code>mul_comm</code> fails with the error message</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">free</span><span class=\"w\"> </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"ss\">`_fvar</span><span class=\"bp\">.</span><span class=\"m\">101526</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>You can check out the branch if you want to have a look.</p>",
        "id": 537861775,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1757076162
    },
    {
        "content": "<p>is it a problem with <code>dist_inv</code> or <code>to_additive</code>?</p>",
        "id": 537865921,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757077396
    },
    {
        "content": "<p>Removing <code>to_additive</code> doesn't make a difference. It's an issue with the implementation of <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> 's great <code>class_abbrev</code> mechanism: in the file, I redefine <code>ESeminormedCommMonoid</code> as </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">class_abbrev</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">to_additive</span><span class=\"kd\">]</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ESeminormedCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommMonoid</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithESeminormedMonoid</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ESeminormedCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">mk</span>\n</code></pre></div>\n<p>It's the presence of the bundle in the <code>variable</code> lines that creates the issue: if I comment the line</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œµ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ESeminormedCommMonoid</span><span class=\"w\"> </span><span class=\"n\">Œµ</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>then everything works fine.</p>",
        "id": 537869259,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1757078408
    },
    {
        "content": "<p>I see, the problem is in the interaction of the <code>variable</code> and <code>theorem</code> commands.  <code>theorem</code> erases all variables from the local context that aren't used in the theorem statement. But it seems that it doesn't also erase these new local instances that I've added. So it's trying to apply this instance, and hence getting an unknown free variable error.</p>",
        "id": 537876555,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757080537
    },
    {
        "content": "<p>I've pushed a fix. The problem was that <code>LocalIstances.erase</code> was using <code>Array.eraseP</code>, which crucially \"Removes the first element that satisfies the predicate <code>p</code>\", instead of removing all such elements.</p>",
        "id": 537880489,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757081556
    },
    {
        "content": "<p>Can I step back ask a more philosophical question: are there more general situations which would benefit from the \"only expose projections as instances in the presence of a local instance of the initial class\" approach?</p>",
        "id": 537919951,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1757094459
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/537829716\">said</a>:</p>\n<blockquote>\n<p>Ah yes, you can work around this by usid Gitpod (it will soon stop existing I think), or locally by using WSL.</p>\n</blockquote>\n<p>It will stop being called gitpod soon, but it will keep existing under the name Ona</p>",
        "id": 537940084,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1757103065
    },
    {
        "content": "<p>The \"only expose projections as instances in the presence of a local instance of the initial class\" approach is an optimization that is possible under the assumption that there are no global instances of the initial class, other than the <code>.mk</code> constructor. In the final implementation it should throw an error if you try to add a global instance of a <code>class abbrev</code>, telling you to add the fields as separate instances.</p>\n<p>So no, I don't think there are more general situations where this makes sense.</p>",
        "id": 537940794,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757103440
    },
    {
        "content": "<p>I've updated the <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/tree/SG_test\"><code>SG_test</code> branch</a> just now. Not sure if this is expected, but there are still build errors: <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/17504045529/job/49723564541#step:19:44\">https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/17504045529/job/49723564541#step:19:44</a></p>",
        "id": 537944939,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1757105279
    },
    {
        "content": "<ol>\n<li>Assuming no new fields for the moment, what is a situation I don't want to build instances for the parents and let <code>mk</code> take over? </li>\n<li>Some mechanism for building a class abbreviated instance directly might be ergonomic anyway.</li>\n</ol>",
        "id": 537945146,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1757105350
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/537944939\">said</a>:</p>\n<blockquote>\n<p>I've updated the <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/tree/SG_test\"><code>SG_test</code> branch</a> just now. Not sure if this is expected, but there are still build errors: <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/17504045529/job/49723564541#step:19:44\">https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/17504045529/job/49723564541#step:19:44</a></p>\n</blockquote>\n<p>Sure, there will be a lot of build errors, because many instance declarations will need to be tweaked. I'm working on it, and it's going pretty smoothly for now.</p>",
        "id": 537945410,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1757105446
    },
    {
        "content": "<p>Ah, didn't realize you were already working on it! Apologies if my commit makes you have to force push...</p>",
        "id": 537945743,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1757105600
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/537945146\">said</a>:</p>\n<blockquote>\n<ol>\n<li>Assuming no new fields for the moment, what is a situation I don't want to build instances for the parents and let <code>mk</code> take over? </li>\n<li>Some mechanism for building a class abbreviated instance directly might be ergonomic anyway.</li>\n</ol>\n</blockquote>\n<p>I'm not sure I understand your first question. For the second question, it would certainly be possible to allow declaring an instance of a <code>class abbrev</code>, and then have some automation that creates the instances from the field automatically. But I think thatin practice, it will be nicer and cleaner to just declare the instances for the child classes directly.</p>",
        "id": 537947555,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757106431
    },
    {
        "content": "<p>I won't be at a computer for the next 10 days, so let's hope there are no more bugs <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 537947562,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757106434
    },
    {
        "content": "<p>Well a nontrivial part of the algebraic hierarchy can be put into 1 and I wouldn't have thought it a class abbrev. </p>\n<p>Hopefully it is a vacation. Enjoy!</p>",
        "id": 537948307,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1757106816
    },
    {
        "content": "<p>Thank you <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span> <span aria-label=\"man climbing\" class=\"emoji emoji-1f9d7-200d-2642\" role=\"img\" title=\"man climbing\">:man_climbing:</span></p>",
        "id": 537949070,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1757107225
    },
    {
        "content": "<p>I'm slowly working my way through mathlib. The main difficulty is that, at some points, I forget to remove some instances of classes that I've converted to <code>class_abbrev</code>: most of the time, they don't compile, but sometimes they do, and then it creates performance issue in later files which are very hard to track down. Do you think that at some point it will be possible to forbid declaring such instances, or warn on them? That would be extremely helpful -- but this can definitely wait for 15 days!</p>",
        "id": 538014560,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1757175266
    },
    {
        "content": "<p>Ok, I've added an error message if you try to declare an instance of a <code>class_abbrev</code> (except for the structure constructor, which should be the only instance) in <a href=\"https://github.com/leanprover/lean4/pull/10178\">lean#10178</a></p>",
        "id": 539701180,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758008049
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110050\">@S√©bastien Gou√´zel</span> if you would like help on that branch, I'm happy to lend a hand, but I understand if having another person would do more harm than good.</p>",
        "id": 539835046,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1758047846
    },
    {
        "content": "<p>The branch is fully building, with a gain of roughly 3% on compile time but unacceptable performance hits in some declarations and a few unification issues (where more type annotations are needed). I think the performance hits would probably be solved by <a href=\"https://github.com/leanprover/lean4/pull/8883\">lean4#8883</a>, but without it I don't think this is really conclusive.</p>",
        "id": 539835540,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758048029
    },
    {
        "content": "<p>It's <a href=\"https://github.com/leanprover-community/mathlib4/pull/29614\">#29614</a>, if you want to play with it. I'm not planning to touch it in the near future.</p>",
        "id": 539835738,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758048094
    },
    {
        "content": "<p>(There was an issue with <code>to_additive</code> getting confused in some manifold files, so I just removed the additivized declarations because I couldn't find a workaround and it wasn't the main focus)</p>",
        "id": 539836140,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758048228
    },
    {
        "content": "<p>Gain as in it was 3% faster? Where can we see the performance result?</p>",
        "id": 539838649,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758049197
    },
    {
        "content": "<p>In fact I had messed up with the speedcenter output. Redoing it cleanly, I see instead a slowdown (0.82% more instructions), at <a href=\"https://speed.lean-lang.org/mathlib4/compare/e7b27246-a3e6-496a-b552-ff4b45c7236e/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash1=2bd7addf5ea686ae42b44468eb548e84ff0e367c&amp;hash2=6bb83bb9cad036b019e892bbe9ac233a0373da72\">https://speed.lean-lang.org/mathlib4/compare/e7b27246-a3e6-496a-b552-ff4b45c7236e/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash1=2bd7addf5ea686ae42b44468eb548e84ff0e367c&amp;hash2=6bb83bb9cad036b019e892bbe9ac233a0373da72</a></p>\n<p>The left run corresponds to the <a href=\"https://github.com/leanprover/lean4/pull/10178\">lean4#10178</a> branch without any change, the right run with the unbundling between norm and algebra.</p>",
        "id": 539885069,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758053117
    },
    {
        "content": "<p>I've had a look at the branch, but I think you're doing something fishy there. For example in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">class_abbrev</span><span class=\"kd\">]</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">CStarAlgebra</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithNormedRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StarRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CompleteSpace</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CStarRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NormSMulClass</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StarModule</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>It doesn't make sense to have a separate <code>[Ring A]</code> and <code>[StarRing A]</code> instance, because both of these give a separate <code>Mul A</code> instance. Similarly, you would never write both those hypotheses together locally.</p>",
        "id": 539943547,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758093291
    },
    {
        "content": "<p><code>StarRing</code> doesn't extend <code>Mul</code>, it it has it as a parameter (actually, it has <code>NonUnitalNonAssocRing</code> as a parameter).</p>",
        "id": 539992704,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1758109495
    },
    {
        "content": "<p>Unless that branch changes this, which I don't think it would?</p>",
        "id": 539992904,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1758109564
    },
    {
        "content": "<p>In a class_abbrev, one should definitely <em>not</em> have two entries defining the same data field, but instead some classes with disjoint data, and some mixin entries in terms of these data. For instance, <code>NormedRing A</code> becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">class_abbrev</span><span class=\"kd\">]</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">NormedRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithNormedRing</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>where <code>WithNormedRing</code> is a mixin defined as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">WithNormedRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NonUnitalRing</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Norm</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MetricSpace</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">dist_eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dist</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">norm_mul_le</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>\n<p>I tried to do this everywhere, but it's definitely possible that I've messed up somewhere between what has data and what is a mixin. For <code>StarRing</code>, it's a mixin taking <code>[Ring A]</code> as a parameter, so I don't think there is an issue here, though.</p>",
        "id": 540000302,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758111621
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/539992704\">said</a>:</p>\n<blockquote>\n<p><code>StarRing</code> doesn't extend <code>Mul</code>, it it has it as a parameter</p>\n</blockquote>\n<p>Ah oops I missed that</p>",
        "id": 540006648,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758113416
    },
    {
        "content": "<p>By the way, there seems to be a performance issue with <a href=\"https://github.com/leanprover/lean4/pull/10178\">lean4#10178</a>. A comparison with a random recent branch gives +58% instructions, +20% wall-clock, see<br>\n<a href=\"https://speed.lean-lang.org/mathlib4/compare/c8f83be7-e7c3-462a-a794-8cf977fe2309/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=2bd7addf5ea686ae42b44468eb548e84ff0e367c\">https://speed.lean-lang.org/mathlib4/compare/c8f83be7-e7c3-462a-a794-8cf977fe2309/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=2bd7addf5ea686ae42b44468eb548e84ff0e367c</a></p>",
        "id": 540008028,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758113784
    },
    {
        "content": "<p>Thats's strange. But we should compare it to the nightly branch that it was forked from</p>",
        "id": 540008987,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758114030
    },
    {
        "content": "<p>Yes, definitely. I'm not sure how to locate it, though, which is why I took a random branch instead.</p>",
        "id": 540034207,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758120140
    },
    {
        "content": "<p>I found the branch, just started a bench from a draft PR. Once the bench is complete we will be able to compare.</p>",
        "id": 540036137,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758120574
    },
    {
        "content": "<p>Indeed, there is no significant performance issue when comparing to the branch it was forked from, see <a href=\"https://speed.lean-lang.org/mathlib4/compare/e7b27246-a3e6-496a-b552-ff4b45c7236e/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash1=afe72e68283d0c004c4edb52dcda9b07a814e967&amp;hash2=2bd7addf5ea686ae42b44468eb548e84ff0e367c\">https://speed.lean-lang.org/mathlib4/compare/e7b27246-a3e6-496a-b552-ff4b45c7236e/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash1=afe72e68283d0c004c4edb52dcda9b07a814e967&amp;hash2=2bd7addf5ea686ae42b44468eb548e84ff0e367c</a>. I wonder what creates this big difference compared to master, but it's not coming from your changes.</p>",
        "id": 540062371,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1758127993
    },
    {
        "content": "<p>Oh, that's nice. Maybe I should rebase my changes to a more recent version.</p>",
        "id": 540063994,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758128600
    },
    {
        "content": "<p>Btw I did rebase the changes in the lean PR, so you can merge the testing branch to get a more recent mathlib version to play with.</p>",
        "id": 540751819,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758533521
    }
]