[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28658\">#28658</a> (co-authored by <span class=\"user-mention\" data-user-id=\"585783\">@Arend Mellendijk</span> and <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span>) is a complete rewrite of <code>field_simp</code>. The need for such a rewrite has been discussed many times, including <a href=\"#narrow/channel/113488-general/topic/Help.20with.20.60nightly-testing.60/near/424206307\">here</a>, <a href=\"#narrow/channel/287929-mathlib4/topic/To.20automate.20or.20not.20to.20automate.3F/near/429427778\">here</a>, <a href=\"#narrow/channel/287929-mathlib4/topic/Rewriting.20field_simp.20-.20how.3F/near/456323853\">here</a>, <a href=\"#narrow/channel/287929-mathlib4/topic/!bench.20failed.3F/near/479816922\">here</a>.</p>\n<p>There is a tracking issue (<a href=\"https://github.com/leanprover-community/mathlib4/pull/15486\">#15486</a>) for Mathlib use cases which ought to be <code>field_simp</code> uses, but which have been replaced with explicit lemma invocations because <code>field_simp</code> is too slow. I <a href=\"https://github.com/leanprover-community/mathlib4/blob/644792174dccca1b50fee47f9a303abc0a7efa05/MathlibTest/FieldSimp.lean#L541-L557\">extracted</a> one of these as a test case: our rewritten <code>field_simp</code> gives a 6x speedup on this example!</p>\n<p>One other nice thing about our new implementation (which is nothing complicated, just reducing expressions to an internal normal form <code>x1 ^ k1 * ... * xn ^ kn</code>, where <code>x1</code>, ... <code>xn</code> are atoms tracked by the <code>AtomM</code> monad and <code>k1</code>, ... <code>kn</code> are integers) is that it can clear some denominators which were out of scope for the old algorithm, frequently to users' confusion! For example it can reduce <code>x / (x * y)</code>, given <code>(hx : x ≠ 0)</code>, to <code>1 / y</code>.</p>",
        "id": 536084025,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756146899
    },
    {
        "content": "<p>This is a big PR: the <a href=\"https://github.com/leanprover-community/mathlib4/pull/28658/commits/34451004e62c28832c0578b646e01ed45c0a24a1\">tactic implementation</a> itself is (+1318, -265), and then there are <a href=\"https://github.com/leanprover-community/mathlib4/pull/28658/commits/2b332130067e087ddbfbbffa3e0fb9ed78a92495\">fixes across the library</a> amounting to (+511, -533), across 181 files. Because it touches so many files, the PR is quite susceptible to rotting. Indeed I have already fixed merge conflicts once :). So it would be great if one of our meta reviewers has the energy to tackle this PR head-on!</p>",
        "id": 536084999,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756147243
    },
    {
        "content": "<p>One other remark: there's <em>lots</em> more work to do on <code>field_simp</code>:</p>\n<ul>\n<li>the <a href=\"#narrow/channel/113488-general/topic/Help.20with.20.60nightly-testing.60/near/424206307\">oft</a>-<a href=\"#narrow/channel/287929-mathlib4/topic/To.20automate.20or.20not.20to.20automate.3F/near/429490088\">requested</a> <a href=\"#narrow/channel/287929-mathlib4/topic/Rewriting.20field_simp.20-.20how.3F/near/456324788\">feature</a> of a <code>field_simp!</code> which more aggressively clears denominators, generating nonzeroness goals as needed</li>\n<li>the <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Is.20there.20a.20field_simp.20variant.20that.20generates.20hypotheses.3F/near/397742378\">nearly</a>-as-<a href=\"#narrow/channel/287929-mathlib4/topic/Rewriting.20field_simp.20-.20how.3F/near/475141667\">oft</a>-requested feature of handling inequalities by analogy with the current handling of equalities</li>\n<li>a less ad-hoc discharger</li>\n</ul>\n<p>I'd like to work on all these things, but <a href=\"https://github.com/leanprover-community/mathlib4/pull/28658\">#28658</a>'s rewrite of the <code>field_simp</code> architecture is a prerequisite!</p>",
        "id": 536087098,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756147988
    },
    {
        "content": "<p>FWIW, <a href=\"https://github.com/leanprover-community/mathlib4/pull/28917\">#28917</a> restores the field_simp proofs which were reverted for <a href=\"https://github.com/leanprover-community/mathlib4/pull/15486\">#15486</a>.</p>",
        "id": 536092638,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756150040
    },
    {
        "content": "<p><span aria-label=\"writing\" class=\"emoji emoji-270d\" role=\"img\" title=\"writing\">:writing:</span> (please feel free to ping after changes; the meta code looks fine enough to me)</p>",
        "id": 536150679,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1756182074
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>, thanks for the review! One question: sometimes there are changes in the adaptation commit along the lines of <code>field_simp</code> -&gt; <code>simp [field]</code>. You're proposing squeezing these, when nonterminal.</p>\n<p>I'm happy to do this, but wanted to check: the reason I hadn't done this was for faithfulness with the original code.  The old <code>field_simp</code> subsumed <code>simp</code>, so <code>simp [field]</code> is a closer analogy than <code>simp only [field, ...]</code>.</p>\n<p>I guess your point is that since we're touching these lines anyway, we might as well make this improvement?</p>",
        "id": 536214167,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756207474
    },
    {
        "content": "<p>Same question re the simp calls with custom dischargers, e.g. <code>field_simp</code> -&gt; <code>simp (disch := assumption) [field]</code>. I wrote them this way (which I agree is weird) to mimic more literally what the old <code>field_simp</code> was doing: it ran a full <code>simp</code> with <code>field_simp_discharge</code> as the discharger, so even simp-lemmas which had nothing to do with fields could get their side conditions discharged by <code>field_simp_discharge</code>.</p>",
        "id": 536217431,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756208672
    },
    {
        "content": "<p>Hmm. For the dischargers I'm confident about my suggestion to use <code>simp_all</code> or <code>simp [*]</code> where possible.</p>\n<p>I'm uncertain what to do about the simps. I think we <em>should</em> squeeze them, I don't particularly mind if that happens in this PR or a follow-up.</p>\n<p>In retrospect we should have never let people use non-terminal <code>field_simp</code> with an uncontrolled call to <code>simp</code> internally, but it was too convenient. :-(</p>",
        "id": 536235617,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1756214498
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328658.20New.20.60field_simp.60/near/536235617\">said</a>:</p>\n<blockquote>\n<p>In retrospect we should have never let people use non-terminal <code>field_simp</code> with an uncontrolled call to <code>simp</code> internally, but it was too convenient. :-(</p>\n</blockquote>\n<p>Agreed!</p>",
        "id": 536236895,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756214885
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328658.20New.20.60field_simp.60/near/536235617\">said</a>:</p>\n<blockquote>\n<p>I'm uncertain what to do about the simps. I think we <em>should</em> squeeze them, I don't particularly mind if that happens in this PR or a follow-up.</p>\n</blockquote>\n<p>I think it's fine to do it in this PR, just wanted to record the choice explicitly.</p>",
        "id": 536237049,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756214928
    },
    {
        "content": "<p>I addressed most review comments, including squeezing most simps. About a dozen remain. <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> Would you like to take care of them? I need to turn to other things now...</p>",
        "id": 536238541,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756215335
    },
    {
        "content": "<p>I'd like to provide some test cases from <a href=\"https://github.com/leanprover-community/mathlib4/pull/13782\">#13782</a>; ideally they could all be solved by <code>field_simp</code> alone.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">FieldSimp</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Ring</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">smulY_sub_negY_aux</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">field_simp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">addX_smul_one_smul_one_aux</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"n\">a₂</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">dx</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">dx</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">dx</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a₂</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">dx</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">dx</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">field_simp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">addY_smul_one_smul_one_aux</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"w\"> </span><span class=\"n\">dx</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">ψ₃</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">((</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">dx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">ψ₃</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"bp\">-</span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">dx</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">ψ₃</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">ψ₃</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">dy</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">field_simp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">smulY_neg_aux</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hz</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a₃</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">neg_pow</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">field_simp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">smulX_add_aux</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m₂</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m₂</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m₂</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">field_simp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">smulY_add_sub_negY_aux</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m₂</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">am</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">m₂</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">am</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">))</span>\n<span class=\"w\">      </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m₂</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">am</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">field_simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">maxDischargeDepth</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">})</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n</code></pre></div>",
        "id": 536265641,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1756223057
    },
    {
        "content": "<p>Actually these aux lemmas themselves are extracted from <a href=\"https://github.com/leanprover-community/mathlib4/blob/DivisionPolynomial_smul/Mathlib/AlgebraicGeometry/EllipticCurve/DivisionPolynomial/ZSMul.lean#L216-L310\">proofs</a> due to performance reasons, and hopefully they no longer need to be extracted after <a href=\"https://github.com/leanprover-community/mathlib4/pull/28658\">#28658</a>.</p>",
        "id": 536266756,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1756223371
    },
    {
        "content": "<p>Thanks! I just checked: <code>field_simp; ring</code> can solve the first three lemmas; the fourth lemma does not require the <code>rw [neg_pow]</code> any more; the last two follow from <code>field_simp</code> alone.<br>\nDo you have a big proof you want me to test on?</p>",
        "id": 536275634,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756226140
    },
    {
        "content": "<p>The first three fail for not-so-deep reasons: the field_simp normal form simply does not normalise e.g. <code>1 - (1 + x)</code> to <code>x</code>; you need <code>ring</code> (or perhaps <code>abel</code>) to do this.</p>",
        "id": 536275776,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756226187
    },
    {
        "content": "<p>A future <code>field</code> tactic, which roughly does <code>field_simp; ring1</code>, should solve all of these.</p>",
        "id": 536275853,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756226208
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> Ping; we have addressed virtually all comments - so this is ready for another look.<br>\n(Two small asterisks are (1) the comment about <code>prod''</code>, which <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> is thinking about this morning, and (2) whether we'd like to land <a href=\"https://github.com/leanprover-community/mathlib4/pull/29010\">#29010</a> before this one. But this doesn't preclude looking at everything else.)</p>",
        "id": 536371420,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756283561
    },
    {
        "content": "<p>One more request: that for all the new <code>set_option linter.unusedSimpArgs false</code>, we add a link to some explanation, perhaps just Heather's explanation in the PR review.</p>",
        "id": 536508281,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1756337105
    },
    {
        "content": "<p>Otherwise, <span aria-label=\"peace sign\" class=\"emoji emoji-270c\" role=\"img\" title=\"peace sign\">:peace_sign:</span></p>",
        "id": 536508319,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1756337135
    },
    {
        "content": "<p>I'll open an issue and link to it, even though the expected fix is just a new discharger.</p>\n<p>Edit: opened as issue <a href=\"https://github.com/leanprover-community/mathlib4/pull/29041\">#29041</a></p>",
        "id": 536509843,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756338291
    },
    {
        "content": "<p>Thanks for jumping through that last hoop. My janitorial instincts just hate to see undocumented <code>set_option</code>s in the library. :-)</p>",
        "id": 536529381,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1756355899
    },
    {
        "content": "<p>As follow-up clean-up, <a href=\"https://github.com/leanprover-community/mathlib4/pull/28917\">#28917</a> is now ready for review. (This restores some proofs which used to be <code>field_simp</code>, but were squeezed because of performance reasons.)</p>",
        "id": 536549370,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756367561
    },
    {
        "content": "<p>Next follow-up is <a href=\"https://github.com/leanprover-community/mathlib4/pull/28918\">#28918</a>, which removes the last uses of the <code>field_simps</code> simp set. (We did not remove it in <code>28568</code> to keep the diff small, but morally it was always part of the PR.)</p>",
        "id": 536567157,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756373424
    }
]