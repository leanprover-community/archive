[
    {
        "content": "<p>Could someone assist me with the <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/10195454419/job/28204195606?pr=15397\">failure</a> of the too-many-lines linter at <a href=\"https://github.com/leanprover-community/mathlib4/pull/15397\">#15397</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">::</span><span class=\"n\">ERR</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"bp\">=</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">SetTheory</span><span class=\"bp\">/</span><span class=\"n\">Cardinal</span><span class=\"bp\">/</span><span class=\"n\">Ordinal</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">,</span><span class=\"n\">line</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"n\">code</span><span class=\"bp\">=</span><span class=\"n\">ERR_NUM_LIN</span><span class=\"bp\">::</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">SetTheory</span><span class=\"bp\">/</span><span class=\"n\">Cardinal</span><span class=\"bp\">/</span><span class=\"n\">Ordinal</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ERR_NUM_LIN</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"mi\">1501</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">most</span><span class=\"w\"> </span><span class=\"mi\">1700</span><span class=\"w\"> </span><span class=\"n\">allowed</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">split</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">up</span>\n</code></pre></div>\n<p>Possible ways to help:</p>\n<ul>\n<li>work out what has gone wrong here and fix it: 1501 &lt; 1700</li>\n<li>modify the error message so it gives actionable advice including how to add this file to the exceptions</li>\n<li><del>tell me where the exceptions live!</del> Make the exceptions more robust so merely changing the number of lines doesn't require changing the exception</li>\n<li>add an exception to this PR</li>\n</ul>",
        "id": 455610967,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1722507944
    },
    {
        "content": "<p>I have not read carefully the relevant linter, but the doc-string for this error message says the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"sd\">/-- The current file was too large: this error contains the current number of lines</span>\n<span class=\"sd\">  as well as a size limit (slightly larger). On future runs, this linter will allow this file</span>\n<span class=\"sd\">  to grow up to this limit. -/</span>\n</code></pre></div>",
        "id": 455616831,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722510005
    },
    {
        "content": "<p>It suggests that a second run would not make the linter complain, but I do not understand how that mechanism can work.</p>",
        "id": 455617149,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722510070
    },
    {
        "content": "<p>It does explain why a larger limit than what it says make the linter unhappy...</p>",
        "id": 455617272,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722510093
    },
    {
        "content": "<p>I'll ping <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span>, since I think that he will know what to do!</p>",
        "id": 455617512,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722510130
    },
    {
        "content": "<p>Presumably I need to run something and commit something in order for it to behave differently next time!</p>",
        "id": 455617584,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1722510142
    },
    {
        "content": "<p>Yes, I think that Michael had a \"shake linters\" command, but I do not know the status of that.</p>",
        "id": 455617842,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722510192
    },
    {
        "content": "<p>I also know that YaÃ«l was not too happy with the linter suggesting to split the file by default, since, unless you know what you are doing, you should add an exception, rather than splitting the file!</p>",
        "id": 455618334,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722510280
    },
    {
        "content": "<p>Ugh, someone rewrote that linter in lean. I added an exception blindly</p>",
        "id": 455647407,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1722518591
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/Too.20many.20lines.20linter/near/455617842\">said</a>:</p>\n<blockquote>\n<p>Yes, I think that Michael had a \"shake linters\" command, but I do not know the status of that.</p>\n</blockquote>\n<p>Side aspects first: yup, I rewrote that lint in Lean, you're welcome.<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/pull/14697\">#14697</a> rewrites the automatic updating of style exceptions in Lean: once that PR is merged, you can just say <code>lake exe lint_style --update</code> to ignore the exception (and the CI error should tell you so). Would somebody (Damiano maybe) like to review it? I just merged master again.</p>",
        "id": 455725545,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722536660
    },
    {
        "content": "<p>Now for the main error message: I think I understood what happened.<br>\nTL;DR: adding an exception is the correct call in the short term.</p>",
        "id": 455726490,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722536872
    },
    {
        "content": "<p>Long version: </p>\n<ol>\n<li>\n<p>The file <code>SetTheory/Ordinal</code> had less than 1500 lines prior to the PR, so passed the linter. After the PR, it had 1501 lines, which exceeds the cut-off of 1500 lines. Yes, this means small perturbations can cause a sudden error. I don't see how to fully avoid this.<br>\n(Once a file is too large, the linter adds some slack to avoid flagging every PR adding just a hand-ful of lines. I could, as a one-time change, add such entries for every file with currently 1300 lines. Let me know if this would help.)</p>\n</li>\n<li>\n<p>Because of this, the linter complained (like it should). The error message has a bug, though: it should not mention 1700 (as there is no exception for this file yet). Let me send a PR...</p>\n</li>\n<li>The PR above will add actionable advice on updating this. If reviewing this takes too long, I can add something in the short term (only to remove it again in <a href=\"https://github.com/leanprover-community/mathlib4/pull/14697\">#14697</a>).</li>\n<li>As for silencing the linter: in the short term, adding an exception seems the right call. If you see an obvious way to split a few hundred lines off that file, that's obviously also fine --- but definitely optional!</li>\n</ol>",
        "id": 455728184,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722537273
    },
    {
        "content": "<p>Does the lean translation have a command to update the exceptions automatically?</p>",
        "id": 455729750,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1722537763
    },
    {
        "content": "<p>For now, <code>update-style-exceptions</code> still handles this.</p>",
        "id": 455729816,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722537790
    },
    {
        "content": "<p>After <a href=\"https://github.com/leanprover-community/mathlib4/pull/14697\">#14697</a>, this is replaced by <code>lake exe lint_style --update</code></p>",
        "id": 455729877,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722537814
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15414\">#15414</a> fixes the error message; review welcome!</p>",
        "id": 455737968,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722540325
    },
    {
        "content": "<p>Thank you, Michael, for rewriting the linter in Lean, to begin with. I think this really helps for maintainability, plus its great when we learn about missing features or problems in Lean itself from doing this.</p>",
        "id": 455771482,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1722553125
    },
    {
        "content": "<p>Thanks a lot for the reviews! I merged master on <a href=\"https://github.com/leanprover-community/mathlib4/pull/14697\">#14697</a>, can somebody re-bors it?</p>",
        "id": 455870228,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722587158
    },
    {
        "content": "<p>I was thinking that maybe the \"too many lines\" linter could be implemented as a syntax linter that emits a warning when the current declaration has starting position above 1500.  The mechanism to silence it would be to make its option be a natural number and the linter actually compares to 1500 the difference of the current position of the command and the value of the option.</p>",
        "id": 457295247,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723104118
    },
    {
        "content": "<p>So, for instance, writing <code>set_option linter.longFile 2000</code> at the beginning of a file (or, really anywhere before the line 1500), allows the file to be up to 3500 lines long, before the linter starts complaining.</p>",
        "id": 457295461,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723104168
    },
    {
        "content": "<p>This would make it very easy to silence the linter, would not require a list of exceptions, other than the per-file <code>set_option</code>s.</p>",
        "id": 457295555,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723104203
    },
    {
        "content": "<p>Does this seem like an improvement over the current situation?</p>",
        "id": 457295597,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723104216
    },
    {
        "content": "<p>Since it was completely straightforward to implement, I just PRed this syntax linter! <a href=\"https://github.com/leanprover-community/mathlib4/pull/15610\">#15610</a></p>\n<p>I will wait for CI to tell me which files do not comply with the linter.</p>",
        "id": 457318196,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723109996
    },
    {
        "content": "<p>An advantage of the syntax linter is that it can also self-correct: when it reaches the last line of a file, the linter can make sure that the option for the linter is not exceedingly large.  Currently, the long file linter seems to operate with increases of 200.</p>",
        "id": 457349309,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723118739
    },
    {
        "content": "<p>Wouldn't it be less confusing to have the number being the bound, rather than bound-1500?</p>",
        "id": 459404780,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1723191283
    },
    {
        "content": "<p>Yes, indeed, this is what the implementation does actually.</p>",
        "id": 459419260,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723195282
    },
    {
        "content": "<p>And another advantage is that now you write the exception directly on the file, rather than having to update a separate file with all the exceptions.</p>",
        "id": 459419523,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723195356
    },
    {
        "content": "<p>Thank you for porting my Lean port of the python linter into a proper syntax linter. I'll be happy to review it next week (if nobody else has done so by then).</p>",
        "id": 459540464,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723226747
    }
]