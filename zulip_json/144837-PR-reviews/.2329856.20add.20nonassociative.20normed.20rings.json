[
    {
        "content": "<p>What do we think about this? Instructions are up by +500G, but not being able to talk about these objects causes pain for people developing this material. I don't really see how we can not have them. (I haven't carefully reviewed the PR yet, I'm just stumbling on the issue of performance first.)</p>\n<p>I'll note that the unital versions are still missing, which would be another slowdown. I think when weighing the costs of separating the algebra and analysis hierarchies, we should be sure it include the fact that with our current design, we can't even talk about all the variants we might want without causing additional slowdowns.</p>\n<p>cc: <span class=\"user-mention\" data-user-id=\"373192\">@Christopher Hoskin</span></p>",
        "id": 558027472,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763494855
    },
    {
        "content": "<p>This is a <code>Prop</code> right? Can I interest people in calling it <code>IsNonUnitalNonAssocSeminormedRing</code>? (my first reaction was \"oh my goodness we definitely don't want that\" and then I looked at the definition and found to my relief that it was a mixin). </p>\n<p>I think that we have to have stuff like this, this is the design pattern we have chosen. Adding more stuff slows things down, this is a fact of life. Do you understand what happened to <code>Mathlib.Analysis.CStarAlgebra.ContinuousFunctionalCalculus.Isometric</code>? I don't have that free hour this evening to get a before and after copy of mathlib running simultaneously!</p>",
        "id": 558036119,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763497759
    },
    {
        "content": "<p>No Kevin, it extends <code>Norm</code> and <code>NonUnitalNonAssocRing</code>, so it's not a mixin.</p>",
        "id": 558036233,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763497816
    },
    {
        "content": "<p>Oh I'm just using the word wrong then. I mean \"it's a Prop, which is good\".</p>",
        "id": 558036286,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763497834
    },
    {
        "content": "<p>No, it's not.</p>",
        "id": 558036309,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763497844
    },
    {
        "content": "<p>Oh! Then what are we doing?</p>",
        "id": 558036347,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763497864
    },
    {
        "content": "<p>Shouldn't it be <code>[Norm R] [NonUnitalNonAssocRing R] [PesudoMetricSpace R] [IsNonUnitalNonAssocSeminormedRing R]</code>?</p>",
        "id": 558036533,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763497941
    },
    {
        "content": "<p>That's not what we do for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NormedRing#doc\">docs#NormedRing</a> ?</p>",
        "id": 558036591,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763497964
    },
    {
        "content": "<p>Yeah and that's bad too!</p>",
        "id": 558036613,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763497975
    },
    {
        "content": "<p>great, I'd love to refactor the hierarchy, but that's not what we have right now.</p>",
        "id": 558036658,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763497994
    },
    {
        "content": "<p>huh, wasn't there a PR which did all of this? Did it rot?</p>",
        "id": 558036712,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763498020
    },
    {
        "content": "<p>The issue is that we still don't have the version of <code>class abbrev</code> that works the way we want.</p>",
        "id": 558036718,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763498023
    },
    {
        "content": "<p>So your question is \"should we dig ourselves in deeper\"?</p>",
        "id": 558036799,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763498059
    },
    {
        "content": "<p>I'm saying: \"we should probably be consistent (because mixing and matching patterns probably is the worst option for performance oveall), we need this so people can do work on it, and yes, as a consequence it means we make performance worse.\"</p>",
        "id": 558037002,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763498143
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24040\">#24040</a> indeed it's rotted</p>",
        "id": 558037064,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763498168
    },
    {
        "content": "<p>There's a much more recent one from <span class=\"user-mention silent\" data-user-id=\"110050\">SÃ©bastien GouÃ«zel</span> that uses <span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span>'s proposed <code>class abbrev</code> change to core. I don't think there's a PR though.</p>",
        "id": 558037167,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763498215
    },
    {
        "content": "<p>So the situation is that ideally we need a huge refactor, but for various reasons that's not happening for a while, and you're blocked unless you have a way of talking about nonassociative normed rings :-(</p>",
        "id": 558062435,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763498286
    },
    {
        "content": "<p>well, I'm not blocked, but <span class=\"user-mention silent\" data-user-id=\"373192\">Christopher Hoskin</span> is I think.</p>",
        "id": 558062606,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763498362
    },
    {
        "content": "<p>If my understanding is correct then it sounds like we should merge, and we should also get our act together. I don't know what <code>class abbrev</code> is, does it make the refactor easier? What's wrong with <a href=\"https://github.com/leanprover-community/mathlib4/pull/24040\">#24040</a>?</p>",
        "id": 558062675,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763498387
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover-community/mathlib4/pull/29614\">#29614</a> and <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60\">#PR reviews &gt; #28803 refactor: unbundle algebra from &#96;ENormed&#42;&#96;</a> and <a href=\"https://github.com/leanprover/lean4/pull/10178\">lean4#10178</a></p>",
        "id": 558062994,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763498517
    },
    {
        "content": "<p>Oh so it's just a readability issue? I am happily typing <code>[Field K] [TopologicalSpace K] [ValuativeRel K] [IsNonarchimedeanField K]</code> everywhere at the minute.</p>",
        "id": 558063180,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763498603
    },
    {
        "content": "<p>(in a parallel universe <code>[ValuativeRel K]</code> was spelt <code>[Preorder K]</code>)</p>",
        "id": 558063284,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763498652
    },
    {
        "content": "<p>Readability is part of it, but <a href=\"https://github.com/leanprover-community/mathlib4/pull/29614\">#29614</a> also unbundles topology and algebra.</p>",
        "id": 558063368,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763498692
    },
    {
        "content": "<p>(but whilst the order people won the argument for <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">C</mi></mrow><annotation encoding=\"application/x-tex\">\\mathbb{C}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">C</span></span></span></span>, they lost it for <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">Q</mi><mi>p</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Q}_p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.975em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">Q</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span></span></span></span> for some reason)</p>",
        "id": 558063372,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763498694
    },
    {
        "content": "<p>Given that the <code>class abbrev</code> issue is P-low I'm not sure it makes sense waiting on it. My instinct is that either we come up with a coherent plan to get a refactor over the line and lose readability (I think that us people who use Lean have a very skewed view of what counts as readable anyway) or we don't do this and merge the PR. But I think that making huge refactor PRs and just hoping that they magically get over the line doesn't work.</p>",
        "id": 558064465,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763499136
    },
    {
        "content": "<p>I also agree to just merge it. It is a slowdown, yes, but it seems acceptable</p>",
        "id": 558067462,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1763500329
    },
    {
        "content": "<p>Kevin, just FYI that <a href=\"https://github.com/leanprover/lean4/pull/8279\">lean4#8279</a> was marked P-low long before we had a big discussion about it in Mathlib. If we decided we love <a href=\"https://github.com/leanprover-community/mathlib4/pull/29614\">#29614</a> and it has benefits, then we could tell core, \"hey, we love this, and there already exists an implementation in <a href=\"https://github.com/leanprover/lean4/pull/10178\">lean4#10178</a>, can we have it please?\" and I think there's a decent chance they would oblige us.</p>",
        "id": 558068449,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763500703
    },
    {
        "content": "<p>Just for the record, <a href=\"https://github.com/leanprover-community/mathlib4/pull/29614\">#29614</a> led to a performance drop (by 2% maybe), and worse unification at several places (so I had to add a lot of type ascriptions), so for me this is a failed experiment.</p>",
        "id": 558130744,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1763537321
    },
    {
        "content": "<p>So is the massive refactor the way to go forwards and, if so, how are we going to manage it? Maybe we need a plan?</p>",
        "id": 558173378,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763550588
    },
    {
        "content": "<p>I recall that one reason for <a href=\"https://github.com/leanprover-community/mathlib4/pull/29614\">#29614</a>'s slowness was another Lean core bug, with Jovan also had a fix for. Can we try these together? I would hope that a situation \"with these somewhat reasonable patches to core Lean, mathlib is in a much better place\" is hopefully enough to approach core successfully.</p>",
        "id": 558176174,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1763551385
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2329856.20add.20nonassociative.20normed.20rings/near/558173378\">said</a>:</p>\n<blockquote>\n<p>So is the massive refactor the way to go forwards and, if so, how are we going to manage it? Maybe we need a plan?</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/29614\">#29614</a> <em>is</em> the massive refactor. I have completed it, and benched it. And it is bad performancewise, contrary to expectations.</p>",
        "id": 558184661,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1763553993
    },
    {
        "content": "<p>I am confused because that PR looks to me like a draft PR which never once passed CI and hence the <code>!bench</code> command issued in September could not (and did not) return any useful information (or indeed any information at all). From the way people are talking about it I must have a serious misunderstanding of what is going on.</p>\n<p>I remember when Yuyang Zhao separated the <code>Ordered</code> heirarchy from the algebra heirarchy in a series of PRs, the first few had very poor performance, and then when we made it through to the end we had very very good performance (which easily compensated). Example: the benchmarking for <a href=\"https://github.com/leanprover-community/mathlib4/pull/20594\">#20594</a> was <a href=\"https://github.com/leanprover-community/mathlib4/pull/20594#issuecomment-2777681750\">not great</a> and then the benchmarking for <a href=\"https://github.com/leanprover-community/mathlib4/pull/20595\">#20595</a> (which depended on 20594) was <a href=\"https://github.com/leanprover-community/mathlib4/pull/20595#issuecomment-2780666099\">even worse</a>. But then we got to the end with <a href=\"https://github.com/leanprover-community/mathlib4/pull/20676\">#20676</a> (which depended on 20595) and the performance change was <a href=\"https://github.com/leanprover-community/mathlib4/pull/20676#issuecomment-2790076259\">stunning</a>. Could the same thing be happening here? Am I making any sense? I am still quite confused about where the evidence is that the refactor is not a good idea.</p>",
        "id": 558297191,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763584416
    },
    {
        "content": "<p>You can see the message with the bench at <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328803.20refactor.3A.20unbundle.20algebra.20from.20.60ENormed*.60/near/539885069\">#PR reviews &gt; #28803 refactor: unbundle algebra from &#96;ENormed&#42;&#96; @ ðŸ’¬</a> </p>\n<p>The reason !bench didn't show anything on the PR is that the PR is based on a nonstandard Lean branch, for which the speedcenter had no comparison. I benched the base branch separately, and then compared the two branches in the speedcenter as indicated in the message above. And the outcome was a 0.83% slowdown (which came as a surprise to me).</p>",
        "id": 558302110,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1763586107
    },
    {
        "content": "<p>It'd probably be good to loop in <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> (who was working on this); I might have missed it, but I didn't see a comment from him on the performance results.</p>",
        "id": 558302498,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1763586265
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28803\">#28803</a> has</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span> Benchmark                                                               Metric         Change\n<span class=\"w\"> </span> =============================================================================================\n<span class=\"gi\">+ ~Mathlib.Algebra.Module.ZLattice.Basic                                  instructions    -7.6%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.CStarAlgebra.CStarMatrix                              instructions   -13.1%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.CStarAlgebra.ContinuousFunctionalCalculus.NonUnital   instructions    -5.8%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.Calculus.ContDiff.Basic                               instructions    -4.0%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.Calculus.ContDiff.FTaylorSeries                       instructions    -7.4%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.Calculus.FDeriv.Analytic                              instructions    -5.6%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.Calculus.FDeriv.Mul                                   instructions    -3.5%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.Fourier.FourierTransformDeriv                         instructions    -3.8%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.InnerProductSpace.Adjoint                             instructions    -8.6%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.Normed.Lp.lpSpace                                     instructions   -19.6%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.Normed.Operator.LinearIsometry                        instructions    -7.1%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.NormedSpace.BallAction                                instructions   -11.5%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.NormedSpace.Multilinear.Basic                         instructions    -7.7%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.NormedSpace.Multilinear.Curry                         instructions    -6.9%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.NormedSpace.PiTensorProduct.InjectiveSeminorm         instructions   -14.4%</span>\n<span class=\"gi\">+ ~Mathlib.Analysis.Seminorm                                              instructions   -11.8%</span>\n<span class=\"gi\">+ ~Mathlib.Geometry.Manifold.MFDeriv.NormedSpace                          instructions    -6.2%</span>\n<span class=\"gi\">+ ~Mathlib.Geometry.Manifold.Riemannian.Basic                             instructions   -19.8%</span>\n<span class=\"gi\">+ ~Mathlib.Geometry.Manifold.VectorBundle.Hom                             instructions    -9.5%</span>\n<span class=\"gi\">+ ~Mathlib.Geometry.Manifold.VectorBundle.Riemannian                      instructions   -10.6%</span>\n<span class=\"gi\">+ ~Mathlib.LinearAlgebra.Matrix.SchurComplement                           instructions   -16.5%</span>\n<span class=\"gi\">+ ~Mathlib.MeasureTheory.Function.Holder                                  instructions   -13.0%</span>\n<span class=\"gi\">+ ~Mathlib.MeasureTheory.Function.LpSpace.Basic                           instructions   -10.5%</span>\n<span class=\"gi\">+ ~Mathlib.MeasureTheory.Function.SimpleFuncDenseLp                       instructions   -17.7%</span>\n<span class=\"gi\">+ ~Mathlib.MeasureTheory.Group.FundamentalDomain                          instructions   -16.7%</span>\n<span class=\"gi\">+ ~Mathlib.NumberTheory.NumberField.Ideal.Basic                           instructions   -53.2%</span>\n<span class=\"gi\">+ ~Mathlib.NumberTheory.NumberField.Units.DirichletTheorem                instructions   -13.6%</span>\n<span class=\"gi\">+ ~Mathlib.Topology.Algebra.Module.FiniteDimension                        instructions   -10.5%</span>\n<span class=\"gi\">+ ~Mathlib.Topology.VectorBundle.Hom                                      instructions    -8.8%</span>\n<span class=\"gi\">+ ~Mathlib.Topology.VectorBundle.Riemannian                               instructions    -6.9%</span>\n</code></pre></div>\n<p>and build time of -0.81% (-1.2 trillion instructions). And we're saying that this is not a good result? I am still totally confused.</p>",
        "id": 558305616,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763587380
    },
    {
        "content": "<p>My understanding is that</p>\n<ul>\n<li>the performance impact of just unbundling ENorm was good,</li>\n<li>but this has a readability impact (which some consider worse - and some prefer the performance improvement),</li>\n<li>and the <code>class abbrev</code> was meant to be our way to have the cake and eat it: mark the ENormedFoo class as class abbrev's, giving you faster typeclass search while retaining readability.</li>\n</ul>\n<p>That's how the discussion got here.</p>",
        "id": 558306028,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1763587540
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110050\">@SÃ©bastien GouÃ«zel</span> my point above is that the drop in performance you witnessed is not as bad as it seems, because that approach allows you to unbundle algebra and topology hierarchies, and therefore allows you to talk about things that we currently can't mention, as is the case for the classes in this PR.</p>",
        "id": 558306158,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763587608
    },
    {
        "content": "<p>For the performance of class abbrev: can we combine <a href=\"https://github.com/leanprover/lean4/pull/10178\">lean4#10178</a> with <a href=\"https://github.com/leanprover/lean4/pull/8883\">lean4#8883</a> (ideally, both rebased on 4.26.0-rc1 or current core), adjust <a href=\"https://github.com/leanprover-community/mathlib4/pull/29614\">#29614</a> to that branch and benchmark that?</p>",
        "id": 558306246,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1763587642
    },
    {
        "content": "<p>If we added all the classes we currently don't have, it might well be the case that we see a 2% slowdown anyway.</p>",
        "id": 558306247,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1763587642
    },
    {
        "content": "<p>My main issue with the refactor is not so much the performance, but the fact that unification became worse (I had to add many type ascriptions that were not needed, at seemingly random places). If there had been a performance boost in exchange, I could have lived with it, but with performance not increasing it looked like a no go.</p>",
        "id": 558307197,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1763588042
    },
    {
        "content": "<p>Fair point. As <a href=\"https://github.com/leanprover/lean4/pull/8883\">lean4#8883</a> also seems to some exponential behaviour in unification, I'm getting increasingly curious about testing the combination.</p>",
        "id": 558307462,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1763588128
    },
    {
        "content": "<p>What exactly became worse about unification? You say you had to add some type ascriptions? What for?</p>",
        "id": 558310129,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763589135
    },
    {
        "content": "<p>I've been busy with various projects, so I didn't work on this <code>class abbrev</code> more. But my understanding was that we should test that the <code>class abbrev</code> helps to unbundle type classes more easily. Such an exposition would be necessary to convince core of the benefit</p>",
        "id": 558310441,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763589267
    },
    {
        "content": "<p>Whilst class abbrev looks unlikely to land any time soon, it was suggested that we could just get around it with tricks in mathlib (writing our own macros or whatever). Would this solve the readability problem?</p>",
        "id": 558384397,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763631031
    },
    {
        "content": "<p>The <code>class abbrev</code> I have in mind cannot be implemented without changes in core. So I think we are limited in what we can do just in mathlib.</p>",
        "id": 558416266,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763641383
    }
]