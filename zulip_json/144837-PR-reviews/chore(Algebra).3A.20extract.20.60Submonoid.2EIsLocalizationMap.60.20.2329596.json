[
    {
        "content": "<blockquote>\n<p>chore(Algebra): extract <code>Submonoid.IsLocalizationMap</code> <a href=\"https://github.com/leanprover-community/mathlib4/pull/29596\">#29596</a></p>\n</blockquote>\n<p>I am quite confused by the performance reports on this PR. There's a 10% regression, but <span class=\"user-mention\" data-user-id=\"224323\">@Junyan Xu</span> and I both don't understand where it's coming from. Local measurements don't add up to this global measurement.</p>",
        "id": 561330399,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764655144
    },
    {
        "content": "<p>We're talking about this comment <a href=\"https://github.com/leanprover-community/mathlib4/pull/29596#issuecomment-3590610070\">https://github.com/leanprover-community/mathlib4/pull/29596#issuecomment-3590610070</a> on github, right?</p>\n<p>I did</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>for both the \"before\" commit <code>09610fd</code> and the \"after\" commit <code>8f19afb</code>, cut and pasted the contents of the infoview into two files (because I am not very good at computers), and compared. The salient points in the diff (i.e. where things differed by more than a percent or so, at least according to my manual editing of the diff file) were:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>1147c1150\n&lt; [Elab.command] [6966900.000000] open TensorProduct in\n---\n&gt; [Elab.command] [10370119.000000] open TensorProduct in\n...\n1155c1158\n&lt; [Elab.command] [6962591.000000] instance (S : Submonoid R) [Module.FinitePresentation R M] :\n---\n&gt; [Elab.command] [10365810.000000] instance (S : Submonoid R) [Module.FinitePresentation R M] :\n...\n1399c1402\n&lt; [Elab.command] [69497508.000000] open IsLocalizedModule in\n---\n&gt; [Elab.command] [83775961.000000] open IsLocalizedModule in\n...\n1453c1456\n&lt; [Elab.command] [69486773.000000] /-- Let `M` `N` be a finitely presented `R`-modules.\n---\n&gt; [Elab.command] [83765226.000000] /-- Let `M` `N` be a finitely presented `R`-modules.\n...\n1502c1505\n&lt; [Elab.command] [69493036.000000] /-- Let `M` `N` be a finitely presented `R`-modules.\n---\n&gt; [Elab.command] [83771489.000000] /-- Let `M` `N` be a finitely presented `R`-modules.\n...\n1551c1554\n&lt; [Elab.command] [69493297.000000] /-- Let `M` `N` be a finitely presented `R`-modules.\n---\n&gt; [Elab.command] [83771750.000000] /-- Let `M` `N` be a finitely presented `R`-modules.\n1600c1603\n&lt; [Elab.async] [28983120.000000] elaborating proof of Module.FinitePresentation.exists_lift_equiv_of_isLocalizedModule ▶\n---\n&gt; [Elab.async] [30673007.000000] elaborating proof of Module.FinitePresentation.exists_lift_equiv_of_isLocalizedModule ▶\n1604c1607\n&lt; [Elab.async] [828241.000000] Lean.addDecl ▶\n---\n&gt; [Elab.async] [809897.000000] Lean.addDecl ▶\n...\n1793c1796\n&lt; [Elab.command] [37911723.000000] /-- Let `M` be a finitely presented `R`-module, `N` a `R`-module, `S : Submonoid R`.\n---\n&gt; [Elab.command] [55835961.000000] /-- Let `M` be a finitely presented `R`-module, `N` a `R`-module, `S : Submonoid R`.\n1801c1804\n&lt; [Elab.command] [37917857.000000] /-- Let `M` be a finitely presented `R`-module, `N` a `R`-module, `S : Submonoid R`.\n---\n&gt; [Elab.command] [55842095.000000] /-- Let `M` be a finitely presented `R`-module, `N` a `R`-module, `S : Submonoid R`.\n...\n1820c1823\n&lt; [Elab.command] [8747670.000000] theorem linearEquivMapExtendScalars_apply [Module.FinitePresentation R M] (f : M →ₗ[R] N) :\n---\n&gt; [Elab.command] [15709420.000000] theorem linearEquivMapExtendScalars_apply [Module.FinitePresentation R M] (f : M →ₗ[R] N) :\n...\n1827c1830\n&lt; [Elab.command] [8753801.000000] theorem Module.FinitePresentation.linearEquivMapExtendScalars_apply [Module.FinitePresentation R M]\n---\n&gt; [Elab.command] [15715551.000000] theorem Module.FinitePresentation.linearEquivMapExtendScalars_apply [Module.FinitePresentation R M]\n1834c1837\n&lt; [Elab.command] [8754057.000000] lemma Module.FinitePresentation.linearEquivMapExtendScalars_apply [Module.FinitePresentation R M]\n---\n&gt; [Elab.command] [15715807.000000] lemma Module.FinitePresentation.linearEquivMapExtendScalars_apply [Module.FinitePresentation R M]\n1841c1844\n&lt; [Elab.async] [3423361.000000] elaborating proof of Module.FinitePresentation.linearEquivMapExtendScalars_apply ▶\n---\n&gt; [Elab.async] [3689707.000000] elaborating proof of Module.FinitePresentation.linearEquivMapExtendScalars_apply ▶\n...\n1852c1855\n&lt; [Elab.command] [9579825.000000] @[simp]\n---\n&gt; [Elab.command] [16996922.000000] @[simp]\n1860c1863\n&lt; [Elab.command] [9585958.000000] @[simp]\n---\n&gt; [Elab.command] [17003055.000000] @[simp]\n1869c1872\n&lt; [Elab.command] [9586216.000000] @[simp]\n---\n&gt; [Elab.command] [17003313.000000] @[simp]\n1878c1881\n&lt; [Elab.async] [3436681.000000] elaborating proof of Module.FinitePresentation.linearEquivMapExtendScalars_symm_apply ▶\n---\n&gt; [Elab.async] [3702937.000000] elaborating proof of Module.FinitePresentation.linearEquivMapExtendScalars_symm_apply ▶\n</code></pre></div>\n<p>In particular there certainly have been some big changes here.</p>\n<p>Because I've got everything up and running let's take a look at one of the biggest offenders: <code>Module.FinitePresentation.linearEquivMapExtendScalars_apply</code>. Before this is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">command</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">8746016.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">linearEquivMapExtendScalars_apply</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">FinitePresentation</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→ₗ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">FinitePresentation</span><span class=\"bp\">.</span><span class=\"n\">linearEquivMapExtendScalars</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">LocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">mkLinearMap</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→ₗ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">IsLocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">mapExtendScalars</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">mkLinearMap</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">mkLinearMap</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">))</span>\n<span class=\"w\">            </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"n\">IsLocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">linearEquiv_apply</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n</code></pre></div>\n<p>and after it's</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">command</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">15709622.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">linearEquivMapExtendScalars_apply</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">FinitePresentation</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→ₗ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">FinitePresentation</span><span class=\"bp\">.</span><span class=\"n\">linearEquivMapExtendScalars</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">LocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">mkLinearMap</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→ₗ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">IsLocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">mapExtendScalars</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">mkLinearMap</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">mkLinearMap</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">))</span>\n<span class=\"w\">            </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"n\">IsLocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">linearEquiv_apply</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n</code></pre></div>\n<p>which is nearly twice as long. Taking apart the traces, one place where they diverge is here. </p>\n<p>Before: </p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>              [Meta.synthInstance] [210793.000000] ✅️ IsLocalization S (Localization S) ▼\n                [whnf] [28.000000] Non-easy whnf: IsLocalization S (Localization S)\n                [whnf] [28.000000] Non-easy whnf: IsLocalization S (Localization S)\n                [] [517.000000] new goal IsLocalization S (Localization S) ▶\n                [] [138685.000000] ✅️ apply @Localization.isLocalization to IsLocalization S (Localization S) ▶\n                [isDefEq] [69702.000000] ✅️ IsLocalization S (Localization S) =?= IsLocalization S (Localization S) ▶\n                [check] [1183.000000] ✅️ Localization.isLocalization ▶\n              [Meta.isDefEq] [78550.000000] ✅️ ?m.135 =?= Localization.isLocalization ▶\n</code></pre></div>\n<p>After:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>              [Meta.synthInstance] [1551976.000000] ✅️ IsLocalization S (Localization S) ▼\n                [whnf] [131.000000] Non-easy whnf: IsLocalization S (Localization S) ▶\n                [whnf] [131.000000] Non-easy whnf: IsLocalization S (Localization S) ▶\n                [] [1294.000000] new goal S.IsLocalizationMap ⇑(algebraMap R (Localization S)) ▶\n                [] [1247685.000000] ✅️ apply @Localization.isLocalization to S.IsLocalizationMap ⇑(algebraMap R (Localization S)) ▶\n                [isDefEq] [300550.000000] ✅️ S.IsLocalizationMap ⇑(algebraMap R (Localization S)) =?= IsLocalization S (Localization S) ▶\n                [check] [1183.000000] ✅️ Localization.isLocalization ▶\n              [Meta.isDefEq] [276737.000000] ✅️ ?m.135 =?= Localization.isLocalization ▶\n</code></pre></div>\n<p>The traces appear to diverge at this point: the \"new goal\" is more complex in the \"after\" commit and typeclass inference takes a lot longer to solve it.</p>\n<p>In short, there is definitely a difference between the two commits and it seems that typeclass inference is behaving differently.</p>",
        "id": 561548433,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764724916
    },
    {
        "content": "<p>Looking at the contents of the PR, could this be the culprit:<br>\n<a href=\"/user_uploads/3121/A4Kmw1nCSMDD5lcSmaWNXJyF/Screenshot-from-2025-12-03-01-28-56.png\">Screenshot from 2025-12-03 01-28-56.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/A4Kmw1nCSMDD5lcSmaWNXJyF/Screenshot-from-2025-12-03-01-28-56.png\" title=\"Screenshot from 2025-12-03 01-28-56.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"740x186\" src=\"/user_uploads/thumbnail/3121/A4Kmw1nCSMDD5lcSmaWNXJyF/Screenshot-from-2025-12-03-01-28-56.png/840x560.webp\"></a></div>",
        "id": 561548965,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764725356
    },
    {
        "content": "<p>Thanks for the diagnosis! IsLocalization is Prop-valued so I don't think this makes a difference. I realized that I could make IsLocalization extend IsLocalizationMap (instead of an abbrev of IsLocalizationMap) and hopefully that alleviates the performance issue.</p>",
        "id": 561592247,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764752542
    },
    {
        "content": "<p>Definitely the IsLocalization instance synthesis gets much slower, but also the Module and IsScalarTower instance syntheses, and I'm puzzled what could have affected those ...<br>\n<a href=\"/user_uploads/3121/PB6Phnz3J4vyL1gKMEhPRs4-/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/PB6Phnz3J4vyL1gKMEhPRs4-/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1693x584\" src=\"/user_uploads/thumbnail/3121/PB6Phnz3J4vyL1gKMEhPRs4-/image.png/840x560.webp\"></a></div>",
        "id": 561621708,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764760518
    },
    {
        "content": "<p>Oh I see, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Module/LocalizedModule/Basic.html#LocalizedModule.isModule\">LocalizedModule.isModule</a> takes a IsLocalization instance.</p>",
        "id": 561645943,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764767149
    },
    {
        "content": "<p><code>extends</code> doesn't work well; it blocks the name <code>IsLocalization.surj</code> etc. </p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>invalid declaration name `IsLocalization.surj`, structure `IsLocalization` has field `surj`\n</code></pre></div>\n<p>but doesn't add <code>IsLocalization.surj</code> to the environment. If it doesn't block the name so I could add a version with different argument explicitness that would be great. Looks like the best solution now is to make IsLocalization a structure with IsLocalizationMap as the only field.</p>",
        "id": 561646701,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764767328
    },
    {
        "content": "<p>Figured out a trick to solve this: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- An auxiliary typeclass to avoid auto-generated declarations</span>\n<span class=\"sd\">under the `IsLocalization` namespace. -/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IsLocalization'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">IsLocalizationMap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">algebraMap</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IsLocalization</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">IsLocalization'</span>\n</code></pre></div>",
        "id": 561991362,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764890424
    }
]