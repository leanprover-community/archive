[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/11521\">#11521</a> introduces a new <code>fast_instance% inst</code> elaborator, which takes an instance expression<code>inst</code> and tried to replace as much of it as possible with existing instances.</p>\n<p>Using this in a number of places is <a href=\"http://speed.lean-fro.org/mathlib4/compare/1fa7b43f-361e-40fa-90a0-aaa1a6372cee/to/0be42ab7-df41-4ea7-93c9-24da90211a38\">looking pretty promising</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span> Benchmark                                              Metric         Change\n<span class=\"w\"> </span> ============================================================================\n<span class=\"gi\">+ ~Mathlib.AlgebraicGeometry.GammaSpecAdjunction         instructions   -11.0%</span>\n<span class=\"gi\">+ ~Mathlib.AlgebraicGeometry.Spec                        instructions   -13.0%</span>\n<span class=\"gi\">+ ~Mathlib.FieldTheory.AbelRuffini                       instructions   -45.4%</span>\n<span class=\"gi\">+ ~Mathlib.FieldTheory.Adjoin                            instructions    -9.9%</span>\n<span class=\"gi\">+ ~Mathlib.FieldTheory.PurelyInseparable                 instructions   -13.1%</span>\n<span class=\"gi\">+ ~Mathlib.FieldTheory.SeparableDegree                   instructions   -20.4%</span>\n<span class=\"gi\">+ ~Mathlib.FieldTheory.Subfield                          instructions   -14.6%</span>\n<span class=\"gi\">+ ~Mathlib.FieldTheory.Subfield.Order                    instructions   -76.7%</span>\n<span class=\"gi\">+ ~Mathlib.NumberTheory.NumberField.CanonicalEmbedding   instructions    -7.7%</span>\n<span class=\"gi\">+ ~Mathlib.NumberTheory.NumberField.ClassNumber          instructions   -17.6%</span>\n<span class=\"gi\">+ ~Mathlib.NumberTheory.NumberField.Discriminant         instructions    -8.5%</span>\n<span class=\"gi\">+ ~Mathlib.NumberTheory.NumberField.FractionalIdeal      instructions   -20.4%</span>\n<span class=\"gi\">+ ~Mathlib.NumberTheory.NumberField.Units                instructions    -6.1%</span>\n<span class=\"gi\">+ ~Mathlib.NumberTheory.RamificationInertia              instructions    -3.9%</span>\n<span class=\"gi\">+ ~Mathlib.RingTheory.Subring.Order                      instructions   -79.3%</span>\n<span class=\"gi\">+ ~Mathlib.RingTheory.Subsemiring.Order                  instructions   -64.4%</span>\n</code></pre></div>\n<p>(note that some of these are quite small files, so the improvement is not actually as big as it looks)</p>",
        "id": 428421032,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711148306
    },
    {
        "content": "<p>Some things to consider:</p>\n<ul>\n<li>Are there better names? <span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span>  suggests <code>compact_instance%</code> which is a little more accurate; though I'd rather not make two renames in a row if there's an even better option</li>\n<li>This doesn't work with <code>where</code> notation, because there is nowhere to insert the term.</li>\n<li>In theory it's probably safe to put <code>fast_instance%</code>on everything; should we have an <code>instanceüèéÔ∏è </code> keyword instead that make it easier to do so? Should this feature be part of the core <code>instance</code>?</li>\n</ul>",
        "id": 428421307,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711148489
    },
    {
        "content": "<p>Isn't the operation \"flattening\" somehow?</p>",
        "id": 428421424,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1711148554
    },
    {
        "content": "<p>As in you are flattening the arguments to the (nested) constructors</p>",
        "id": 428421460,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1711148576
    },
    {
        "content": "<p>The original motivation here was to speed up uses of things like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Function.Injective.ring#doc\">docs#Function.Injective.ring</a>, but it also works on cases like <code>{ instB, instA }</code></p>",
        "id": 428421464,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711148581
    },
    {
        "content": "<p>What do you mean by flattening here?</p>",
        "id": 428421518,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711148614
    },
    {
        "content": "<p>Okay nevermind it does not do what I thought it did</p>",
        "id": 428421613,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1711148669
    },
    {
        "content": "<p>Opposite of flattening I would think</p>",
        "id": 428421692,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711148748
    },
    {
        "content": "<p>I guess it's more accurately \"recycling\"</p>",
        "id": 428421827,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1711148835
    },
    {
        "content": "<p>It is about ~500B over the whole library which is good. There is probably room to speed things up at least double or triple given experiments I‚Äôve run</p>",
        "id": 428421843,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711148860
    },
    {
        "content": "<p>This isn‚Äôt recursive is it?</p>",
        "id": 428422088,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711149030
    },
    {
        "content": "<p>It is recursive</p>",
        "id": 428422141,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711149078
    },
    {
        "content": "<p>Does it generate the instances it cannot find?</p>",
        "id": 428422154,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711149099
    },
    {
        "content": "<p>I think the outcome is that it usually finds instance for the data fields, and anything that is leftover comes from the original <code>inst</code></p>",
        "id": 428422233,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711149133
    },
    {
        "content": "<p>Beyond just speeding things up, I think that something like this is could be a big part of the UX of constructing instances going forward where the exact inheritance graph for structures is less prominent.</p>",
        "id": 428422504,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711149363
    },
    {
        "content": "<p>At least to the user</p>",
        "id": 428422540,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711149379
    },
    {
        "content": "<p>Yes, this is kind of the point; of course, people can still fiddle with parent orders in the <em>definition</em> of the typeclasses if they so desire, but this should insulate the user from those choices</p>",
        "id": 428422559,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711149402
    },
    {
        "content": "<p>It also aids refactors</p>",
        "id": 428422562,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711149405
    },
    {
        "content": "<p>/poll What should we call this elaborator</p>\n<ul>\n<li>fast_instance%</li>\n<li>compact_instance%</li>\n<li>recycle_instances_in%<br>\n*</li>\n</ul>",
        "id": 428423562,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711150092
    },
    {
        "content": "<p>Maybe <code>shallow_instance%</code>? Is \"shallow\" a good word to describe the kind of instances this elaborator aims to produce?<br>\nOr maybe <code>optimize_instance%</code> to evoke a more flexible specification?</p>",
        "id": 428424399,
        "sender_full_name": "Timo Carlin-Burns",
        "timestamp": 1711150751
    },
    {
        "content": "<p>Do you see this elaborator as a black box to just produce a more optimized instance that just happens to currently only perform recycling, or do you see it as a specific tool among others that a library author should intelligently choose between for optimizing instances? If the former, <code>fast_instance%</code> or <code>optimize_instance%</code> seem preferable to a more specific name.</p>",
        "id": 428424709,
        "sender_full_name": "Timo Carlin-Burns",
        "timestamp": 1711150984
    },
    {
        "content": "<p>My hunch is that it is possible to write the instance such that it is always the correct choice, and at worse does nothing</p>",
        "id": 428425388,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711151478
    },
    {
        "content": "<p>Other possibilities: <code>fold_up%</code>, <code>bundle_up%</code></p>",
        "id": 428426857,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711152610
    },
    {
        "content": "<p>Let's see if I got what this right:</p>\n<p><code>fast_instance% e</code> takes the expression <code>e</code> and normalizes <code>e</code> so that it is a structure constructor application such that each of its instance arguments are either canonical instances or (recursively) normalized expressions.</p>",
        "id": 428427735,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1711153429
    },
    {
        "content": "<p>I don‚Äôt think it does the following but I want to check. (Edit: checked)</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">class</span> <span class=\"n\">A</span> <span class=\"n\">where</span>\n  <span class=\"n\">x</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span>\n\n<span class=\"kd\">class</span> <span class=\"n\">B</span> <span class=\"kd\">extends</span> <span class=\"n\">A</span> <span class=\"n\">where</span>\n <span class=\"n\">y</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">B</span> <span class=\"o\">:=</span> <span class=\"n\">fast_instance</span><span class=\"bp\">%</span> <span class=\"o\">{</span><span class=\"n\">x</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span> <span class=\"o\">,</span> <span class=\"n\">y</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span><span class=\"o\">}</span>\n<span class=\"c\">/-</span><span class=\"cm\">  returns B.mk (A.mk 0) 0 and not B.mk instA 0 where instA is a generated declaration? -/</span>\n</code></pre></div>",
        "id": 428428464,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711154048
    },
    {
        "content": "<p>Also I would like <code>where‚Äô</code> syntax where we do this for all structure instances and generate declarations for the parents recursively</p>",
        "id": 428428727,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711154342
    },
    {
        "content": "<p>One thing to note is that the \"canonical\" instance chosen is just the one found via <code>inferInstance</code>; this would be even more performant if preferred parents had a higher <code>priority</code> than non-preferred parents</p>",
        "id": 428429473,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711155120
    },
    {
        "content": "<p>Another suggestion: <code>rectify_instance%</code></p>",
        "id": 428431816,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711157555
    },
    {
        "content": "<p>This seems similar to how <a href=\"https://en.wikipedia.org/wiki/Dictionary_coder\">https://en.wikipedia.org/wiki/Dictionary_coder</a> works ... maybe <code>compress</code> is better than <code>compact(ify)</code></p>",
        "id": 428440006,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1711165420
    },
    {
        "content": "<p>I'm not sure a dictionary coder is a good point of comparison. This is taking the instance fields of the instance and re-synthesizing them (using only the type) and replacing the term, meanwhile <em>expanding</em> the term so that there is an explicit structure constructor.</p>\n<p>It's not looking for previous terms that it can re-use, which is what I'd think a dictionary coder would be like.</p>",
        "id": 428440589,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1711165785
    },
    {
        "content": "<p>(In compilers, I guess the analogue of a dictionary coder would be an optimization called global value numbering. That sort of optimization is frequently done in Lean, but not here.)</p>",
        "id": 428440644,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1711165807
    },
    {
        "content": "<p>Thanks, I now have a better idea how it works, and I'd like to suggest <code>streamline</code> ...</p>",
        "id": 429058223,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1711178507
    },
    {
        "content": "<p><code>normalize</code>?</p>",
        "id": 429066807,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1711187387
    },
    {
        "content": "<p><code>norm_inst</code>?</p>",
        "id": 429082864,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1711202021
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/428440589\">said</a>:</p>\n<blockquote>\n<p>I'm not sure a dictionary coder is a good point of comparison. This is taking the instance fields of the instance and re-synthesizing them (using only the type) and replacing the term, meanwhile <em>expanding</em> the term so that there is an explicit structure constructor.</p>\n<p>It's not looking for previous terms that it can re-use, which is what I'd think a dictionary coder would be like.</p>\n</blockquote>\n<p>To me, the fact it is checking for defeq on the synthesized terms, makes me mentally view the input and output of the resynth as the ‚Äúsame‚Äù because I‚Äôm quotienting by defeq. </p>\n<p>Also there isn‚Äôt always a constructor application. If you already have a defeq instance in scope for original class, that will get slotted in correct?</p>",
        "id": 429084820,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711203598
    },
    {
        "content": "<p>The (perhaps far flung) analogy in my head is choosing length minimizing paths in a homotopy class.</p>",
        "id": 429085067,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711203729
    },
    {
        "content": "<p>What is quickest way to pass this to all instances for testing?</p>",
        "id": 429373051,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711368561
    },
    {
        "content": "<p>Brute force (python) it is</p>",
        "id": 429470206,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711387014
    },
    {
        "content": "<p>Something that occurred to me is that we could create a term version of <code>where</code> for the purpose of making it easy to insert material around the <code>where</code>.</p>\n<p>Imagine replacing <code>instance : Foo X where ...</code> with <code>instance : Foo X := where% ...</code> and it Just Works<span aria-label=\"tm\" class=\"emoji emoji-2122\" role=\"img\" title=\"tm\">:tm:</span></p>",
        "id": 429486239,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1711392235
    },
    {
        "content": "<p>I like standardizing around <code>where</code> for syntax also. More legible</p>",
        "id": 429487542,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711392734
    },
    {
        "content": "<p>That syntax sounds great, but I'm a bit worried about trying to lump it in with <code>fast_instance%</code> and nothing happening as a result. Perhaps worth making an RFC for?</p>",
        "id": 429490332,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711393770
    },
    {
        "content": "<p>I think it's fine making something called <code>where%</code> and using it to keep the diff down for <code>fast_instance%</code>. Maybe only <code>fast_instance_where%</code> would make it into mathlib?</p>",
        "id": 429490684,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1711393895
    },
    {
        "content": "<p>Yes definitely out of scope for this PR but great of another!</p>",
        "id": 429491541,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711394209
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/11668\">#11668</a> is a haphazard attempt at seeing the performance implications of more widespread use. I replaced all <code>:=</code> on the same line as <code>instance</code> with <code>:= fast_instance%</code>. Probably not the smartest move but see below</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span> Benchmark                                                        Metric         Change\n<span class=\"w\"> </span> ======================================================================================\n<span class=\"gi\">+ build                                                            instructions     -2.0 %</span>\n</code></pre></div>\n<p><a href=\"http://speed.lean-fro.org/mathlib4/compare/1fa7b43f-361e-40fa-90a0-aaa1a6372cee/to/5fbd62e2-7598-41b8-bd61-2072734154d2\">Full benchmark</a></p>",
        "id": 429522409,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711406236
    },
    {
        "content": "<p>Nothing in that PR should be considered for anything else in life</p>",
        "id": 429522442,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711406261
    },
    {
        "content": "<p>Maybe the <code>instance</code> keyword really should do this all automagically? I guess the real test will be the <code>where</code>s</p>",
        "id": 429522528,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711406300
    },
    {
        "content": "<p>Yes, I think both should recalibrate the instances in sympathy with the machine</p>",
        "id": 429522586,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711406366
    },
    {
        "content": "<p>About halfway through, I realized that I should have replaced the <code>:=</code> in the next 2 to 4 lines instead <span aria-label=\"lol\" class=\"emoji emoji-1f606\" role=\"img\" title=\"lol\">:lol:</span> Those are the complicated instances</p>",
        "id": 429524333,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711407290
    },
    {
        "content": "<p>If it's recursive then that doesn't matter, right?</p>",
        "id": 429531973,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711411760
    },
    {
        "content": "<p>Sorry I wasn‚Äôt clear perhaps. I inserted into things like </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span> <span class=\"n\">foo</span> <span class=\"o\">:</span> <span class=\"n\">Stuff</span> <span class=\"o\">:=</span> <span class=\"bp\">‚Ä¶</span>\n</code></pre></div>\n<p>and I am saying it would have been to insert into things like </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span> <span class=\"n\">complicatedFoo</span> <span class=\"o\">:</span> <span class=\"o\">(</span><span class=\"n\">A</span> <span class=\"n\">B</span> <span class=\"n\">C</span> <span class=\"n\">D</span> <span class=\"n\">E</span> <span class=\"n\">F</span> <span class=\"n\">G</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">LongClassName1</span><span class=\"o\">]</span> <span class=\"bp\">‚Ä¶.</span>\n<span class=\"bp\">‚Ä¶</span><span class=\"n\">more</span> <span class=\"n\">lines</span>\n<span class=\"bp\">‚Ä¶</span><span class=\"n\">even</span> <span class=\"n\">more</span> <span class=\"n\">lines</span>\n<span class=\"o\">[</span><span class=\"n\">LongClassName37</span><span class=\"o\">]</span> <span class=\"o\">:</span> <span class=\"n\">Stuff</span> <span class=\"o\">:=</span> <span class=\"bp\">‚Ä¶</span>\n</code></pre></div>",
        "id": 429532336,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711411975
    },
    {
        "content": "<p>The latter are probably deeper in the hierarchy and would benefit more from the change</p>",
        "id": 429532463,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1711412061
    },
    {
        "content": "<p>This is belated merged now. The PR only includes the elaborator and test. For the effects of inserting it, see <a href=\"https://github.com/leanprover-community/mathlib4/pull/20933\">#20933</a>. Thanks to <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> and <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> for their patience. I‚Äôd like to think a bit about how to elegantly apply this (rather than brute force from <a href=\"https://github.com/leanprover-community/mathlib4/pull/20933\">#20933</a>) before touching Mathlib.</p>",
        "id": 495589231,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737667967
    },
    {
        "content": "<p>I don‚Äôt think there is any good <code>macro</code> based way to insert this automatically but hope I am wrong. How much can we automate this without feeling the performance burden?</p>",
        "id": 495589633,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737668137
    },
    {
        "content": "<p>Related but unrelated, I did wonder about the benefit of navigating inside any application in the expression more generally</p>",
        "id": 495590852,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737668670
    },
    {
        "content": "<p>Wrong PR number?</p>",
        "id": 495592519,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737669426
    },
    {
        "content": "<p>Dadgum. <a href=\"https://github.com/leanprover-community/mathlib4/pull/20993\">#20993</a></p>",
        "id": 495592687,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737669494
    },
    {
        "content": "<p>Thanks for the reminder to merge the other one though</p>",
        "id": 495592720,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737669510
    },
    {
        "content": "<p>Ha!</p>",
        "id": 495592740,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737669526
    },
    {
        "content": "<p>Glad to be of service</p>",
        "id": 495592756,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737669537
    },
    {
        "content": "<p>Perhaps worth noting that we never remembered to consider the poll results above, and <code>fast_instance%</code> was the name that stuck</p>",
        "id": 495593128,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737669695
    },
    {
        "content": "<p>Yes, I would be happy to change the name if there is consensus. But this is better than nothing. I think the speed ups will benefit the concrete category refactor amongst other things</p>",
        "id": 495593248,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737669747
    },
    {
        "content": "<p>A <code>fast_instance</code> keyword replacing <code>instance</code> seems like the natural way to apply this to mathlib without too much work</p>",
        "id": 495594097,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737670127
    },
    {
        "content": "<p>That could also support <code>where</code> notation</p>",
        "id": 495594113,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737670137
    },
    {
        "content": "<p>It'd also be easy to support <code>{ __fast := true, ... }</code> for <code>fast_instance% { ... }</code>, which would then automatically support</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">__</span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>as well.</p>",
        "id": 495618320,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737683978
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span> perhaps?</p>",
        "id": 495675389,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1737712877
    },
    {
        "content": "<p>Thanks for the cc. :)</p>",
        "id": 495677289,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737713433
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495618320\">said</a>:</p>\n<blockquote>\n<p>It'd also be easy to support <code>{ __fast := true, ... }</code> for <code>fast_instance% { ... }</code>, which would then automatically support</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">__</span><span class=\"n\">fast</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>as well.</p>\n</blockquote>\n<p>If I understand correctly, this elaborator would be mostly applied when the instance is defined as a term (e.g. <code>Function.Injective.group ...</code>) instead of a constructor application. So <code>{ __fast := true }</code> would be less useful unfortunately.</p>",
        "id": 495677928,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737713613
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495594097\">said</a>:</p>\n<blockquote>\n<p>A <code>fast_instance</code> keyword replacing <code>instance</code> seems like the natural way to apply this to mathlib without too much work</p>\n</blockquote>\n<p>I'm worried that things can be quite confusing if terms get elaborated to something very different depending on the declaration keyword. Putting a <code>fast_instance%</code> into the term itself signals clearly that there is some magic going on.</p>\n<p>Also: using a term elaborator allows us to have fast non-instances:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">instFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fast_instance</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">instFoo</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"bp\">...</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">instFoo</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 495678743,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737713857
    },
    {
        "content": "<p>On the other hand, maybe the <code>fast_instance</code> decl keyword could be a self-replacing macro, with a <code>Try this:</code> message.</p>",
        "id": 495679167,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737713973
    },
    {
        "content": "<p>Do we have something that applies all <code>try this:</code>es in a project automatically?</p>",
        "id": 495679223,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737713992
    },
    {
        "content": "<p>I think <a href=\"https://github.com/leanprover-community/mathlib4/pull/20784\">https://github.com/leanprover-community/mathlib4/pull/20784</a> is an example of a constructor application that would be improved by this macro (that is, the macro has the same effect as the change in that PR)</p>",
        "id": 495679326,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737714010
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495679167\">said</a>:</p>\n<blockquote>\n<p>On the other hand, maybe the <code>fast_instance</code> decl keyword could be a self-replacing macro, with a <code>Try this:</code> message.</p>\n</blockquote>\n<p>Self-replacing as what?</p>",
        "id": 495679375,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737714028
    },
    {
        "content": "<p>As a <code>:= fast_instance% ...</code> term</p>",
        "id": 495679466,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737714059
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495678743\">said</a>:</p>\n<blockquote>\n<p>I'm worried that things can be quite confusing if terms get elaborated to something very different depending on the declaration keyword. </p>\n</blockquote>\n<p>Recall that the resulting term is equal to the original up to \"instances\" defeq, so I would claim this doesn't meet the bar for \"very different\".</p>",
        "id": 495680046,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737714226
    },
    {
        "content": "<p>These are certainly some really exciting benchmarks! I'd like to check out what's up with the <code>Mathlib.LinearAlgebra.TensorProduct.Graded.Internal</code> slowdown. Maybe an instance that didn't get <code>fast_instance%</code>d is getting slow unification with one that is?</p>",
        "id": 495680188,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737714256
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495680046\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/stream/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495678743\">said</a>:</p>\n<blockquote>\n<p>I'm worried that things can be quite confusing if terms get elaborated to something very different depending on the declaration keyword. </p>\n</blockquote>\n<p>Recall that the resulting term is equal to the original up to \"instances\" defeq, so I would claim this doesn't meet the bar for \"very different\".</p>\n</blockquote>\n<p>You're absolutely right! I should have been more precise that this is about the user-facing appearance, not the actual defeqs.</p>",
        "id": 495680413,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737714321
    },
    {
        "content": "<p>I think Kyle's <code>__fast</code> suggestion is a good compromise (in the constructor application case)</p>",
        "id": 495680525,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737714360
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495680188\">said</a>:</p>\n<blockquote>\n<p>These are certainly some really exciting benchmarks! I'd like to check out what's up with the <code>Mathlib.LinearAlgebra.TensorProduct.Graded.Internal</code> slowdown. Maybe an instance that didn't get <code>fast_instance%</code>d is getting slow unification with one that is?</p>\n</blockquote>\n<p>I suspect what's going on deep down is that <code>Submodule.addCommGroup.toAddCommMonoid =?= Submodule.toAddCommMonoid</code> is getting slower. Let me sprinkle a few extra <code>fast_instance%</code>s in those files and see if that helps...</p>",
        "id": 495687474,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737716370
    },
    {
        "content": "<p>(Hard to say for sure since it seems more like a case of repeated extremely fast unifications (microseconds) going down to simply fast (miliseconds), so the <code>isDefEq</code> trace at this level is rather annoying to check...)</p>",
        "id": 495687747,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737716451
    },
    {
        "content": "<p>Great news: the <code>fast_instance%</code> sprinkling worked! :D Specifically looks like <code>Submodule.addCommMonoid</code> and <code>Submodule.addCommGroup</code> also should receive a <code>fast_instance%</code>, and then everything in <code>Graded.Internal</code> gets quite a bit faster (like a third or half the time) compared to the master branch.</p>",
        "id": 495689808,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737717156
    },
    {
        "content": "<p>In summary, I think this PR looks great, and modulo style bikeshedding I'm all in favour! <span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span></p>",
        "id": 495690576,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737717439
    },
    {
        "content": "<p>How bad would it be to make instance <em>always</em> mean <code>fast_instance%</code> in mathlib?</p>",
        "id": 495691011,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737717595
    },
    {
        "content": "<p>If nothing else this would be a very good test to see what the performance impact of using it everywhere would be, even if the user impact is less optimal</p>",
        "id": 495691111,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737717622
    },
    {
        "content": "<p>It also might be a compelling argument for changing the semantics of <code>instance</code> upstream</p>",
        "id": 495691218,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737717667
    },
    {
        "content": "<p>There are a couple cases that <code>fast_instance%</code> does not handle, but they seem to all be nicely caught+error'd so it should be easy enough to fall back to the original elaboration in that case. So for testing I'd definitely be in favour.</p>",
        "id": 495691416,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1737717739
    },
    {
        "content": "<p>It sounds like we want to stick with <code>:= fast_instance%</code> for terms. Kyle's suggested syntax and Eric's suggested experiment (which I both totally agree with) can be layered upon this.</p>",
        "id": 495712490,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737724812
    },
    {
        "content": "<p>It is already starting to rot so I will prepare <a href=\"https://github.com/leanprover-community/mathlib4/pull/20993\">#20993</a> in its current form to move forward. Please object if you wish!</p>",
        "id": 495712955,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737724937
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495691416\">said</a>:</p>\n<blockquote>\n<p>So for testing I'd definitely be in favour.</p>\n</blockquote>\n<p>If the testing is very positive, I'd argue we should just submit the test version, and put up with the fact that <code>import Mathlib</code> changes the meaning of the <code>instance</code> keyword, since to almost all users the difference isn't actually noticeable. This is much easier to revert if necessary, saves us having to manage rotting PRs, and means all new instances automatically get this treatment.</p>",
        "id": 495713637,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737725140
    },
    {
        "content": "<p>If the result is really positive, that's fairly strong evidence that <code>instance</code> should just behave that way always, and so if core eventually adopts it it also means there is very little to clean up in mathlib afterwards</p>",
        "id": 495713809,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737725186
    },
    {
        "content": "<p>I think the testing will at least identify a pattern in the expressions where <code>fast_instance</code> is most useful. Then we can also think about automatic application based on the shape of the expression or any other adjustments</p>",
        "id": 495714389,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737725368
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20993\">#20993</a> is now ready for review</p>",
        "id": 495757872,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737738515
    },
    {
        "content": "<p>Thanks a lot for this experiment! I've kicked it on the queue.<br>\nWe can easily revert this if the follow-up experiment with changing the semantics of <code>instance</code> is successful.<br>\nBut we shouldn't let the current effort behind <a href=\"https://github.com/leanprover-community/mathlib4/pull/20993\">#20993</a> rot, in case the follow-up experiment is unsuccessful.</p>",
        "id": 495781880,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1737748108
    },
    {
        "content": "<p>That's really impressive! It looks like that <a href=\"https://github.com/leanprover-community/mathlib4/pull/20993\">#20993</a> only addressed uses within the <code>Algebra</code> folder? Is there a reason it was restricted to that?</p>",
        "id": 495783413,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1737748693
    },
    {
        "content": "<p>I don't think the applications of <code>fast_instance</code> there are exhaustive. It was that the <code>Function.Injective/Surjective</code> constructors in <code>Algebra</code> were the most common problems in other situations. If there are more, we should try it out there</p>",
        "id": 495789738,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737751343
    },
    {
        "content": "<p>We probably have a decent number of these for the <code>Normed{AlgebraStructure}</code> variants.</p>",
        "id": 495794694,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1737753627
    },
    {
        "content": "<p>Go for it!</p>",
        "id": 495795227,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737753898
    },
    {
        "content": "<p>I've gotten lost in <code>RingTheory.Kaehler.JacobiZariski</code> at the moment</p>",
        "id": 495795306,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737753936
    },
    {
        "content": "<p>well, probably I won't get around to it until Monday.</p>",
        "id": 495795459,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1737753992
    },
    {
        "content": "<blockquote>\n<p>If there are more, we should try it out there</p>\n</blockquote>\n<p>I disagree; applying things manually much more is going to create more stuff that rots. Now that nothing is actively rotting,  I think we should try applying things globally via overriding the <code>instance</code> keyword.</p>",
        "id": 495817632,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737766829
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21039\">#21039</a> contains a preliminary hack</p>",
        "id": 495819624,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737768082
    },
    {
        "content": "<p>The errors this is producing are quite strange, and suggest a bug in the current <code>fast_instance%</code></p>",
        "id": 495824569,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737771447
    },
    {
        "content": "<p>I agree with Eric, that we should try an approach on a more global level now first.</p>",
        "id": 495841249,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1737785929
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2311521.20speeding.20up.20lots.20of.20instances/near/495824569\">said</a>:</p>\n<blockquote>\n<p>The errors this is producing are quite strange, and suggest a bug in the current <code>fast_instance%</code></p>\n</blockquote>\n<p>The final <code>else</code> of <code>makeFastInstance</code> starts with a <code>forallTelescope</code> and returns a <code>mkLambdaFVars</code>: could this be a <code>forall</code> vs <code>lambda</code> mismatch?</p>",
        "id": 495848353,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737792399
    },
    {
        "content": "<p>I think it might be an implicit lambda issue</p>",
        "id": 495859660,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737802219
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> No there's no mismatch here, the pattern is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">provided</span>\n<span class=\"n\">forallTelescopeReducing</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">tyArgs</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">provided'</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">withReducibleAndInstances</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whnf</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mkAppN</span><span class=\"w\"> </span><span class=\"n\">provided</span><span class=\"w\"> </span><span class=\"n\">tyArgs</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">provided'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"n\">transform</span><span class=\"w\"> </span><span class=\"n\">provided'</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">something</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">same</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"w\">  </span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"n\">tyArgs</span><span class=\"w\"> </span><span class=\"n\">provided'</span>\n</code></pre></div>\n<p>This lets us go \"under the binders\" of a lambda.</p>",
        "id": 495988272,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737914648
    },
    {
        "content": "<p>If implicit lambda is an issue, maybe using <code>@</code> prefixes can help ‚Äî the syntax <code>@(stx)</code> disables implicit lambdas and does nothing else.</p>",
        "id": 495988417,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737914780
    },
    {
        "content": "<p>Even with the current state of <a href=\"https://github.com/leanprover-community/mathlib4/pull/21039\">#21039</a>, we can glean some information. The final file to build was <code>Analysis.CStarAlgebra.lpSpace</code>. We can time clean builds of this file on that branch </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Build<span class=\"w\"> </span>completed<span class=\"w\"> </span>successfully.\n<span class=\"w\">    </span>Command<span class=\"w\"> </span>being<span class=\"w\"> </span>timed:<span class=\"w\"> </span><span class=\"s2\">\"lake build Mathlib.Analysis.CStarAlgebra.lpSpace\"</span>\n<span class=\"w\">    </span>User<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>seconds<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">3811</span>.66\n<span class=\"w\">    </span>System<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>seconds<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">885</span>.90\n<span class=\"w\">    </span>Percent<span class=\"w\"> </span>of<span class=\"w\"> </span>CPU<span class=\"w\"> </span>this<span class=\"w\"> </span>job<span class=\"w\"> </span>got:<span class=\"w\"> </span><span class=\"m\">755</span>%\n<span class=\"w\">    </span>Elapsed<span class=\"w\"> </span><span class=\"o\">(</span>wall<span class=\"w\"> </span>clock<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>h:mm:ss<span class=\"w\"> </span>or<span class=\"w\"> </span>m:ss<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">10</span>:22.06\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>shared<span class=\"w\"> </span>text<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>unshared<span class=\"w\"> </span>data<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>stack<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>total<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Maximum<span class=\"w\"> </span>resident<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">1681216</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>resident<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Major<span class=\"w\"> </span><span class=\"o\">(</span>requiring<span class=\"w\"> </span>I/O<span class=\"o\">)</span><span class=\"w\"> </span>page<span class=\"w\"> </span>faults:<span class=\"w\"> </span><span class=\"m\">13815</span>\n<span class=\"w\">    </span>Minor<span class=\"w\"> </span><span class=\"o\">(</span>reclaiming<span class=\"w\"> </span>a<span class=\"w\"> </span>frame<span class=\"o\">)</span><span class=\"w\"> </span>page<span class=\"w\"> </span>faults:<span class=\"w\"> </span><span class=\"m\">242898470</span>\n<span class=\"w\">    </span>Voluntary<span class=\"w\"> </span>context<span class=\"w\"> </span>switches:<span class=\"w\"> </span><span class=\"m\">22083</span>\n<span class=\"w\">    </span>Involuntary<span class=\"w\"> </span>context<span class=\"w\"> </span>switches:<span class=\"w\"> </span><span class=\"m\">26376096</span>\n<span class=\"w\">    </span>Swaps:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>File<span class=\"w\"> </span>system<span class=\"w\"> </span>inputs:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>File<span class=\"w\"> </span>system<span class=\"w\"> </span>outputs:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Socket<span class=\"w\"> </span>messages<span class=\"w\"> </span>sent:<span class=\"w\"> </span><span class=\"m\">358</span>\n<span class=\"w\">    </span>Socket<span class=\"w\"> </span>messages<span class=\"w\"> </span>received:<span class=\"w\"> </span><span class=\"m\">55417</span>\n<span class=\"w\">    </span>Signals<span class=\"w\"> </span>delivered:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Page<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">16384</span>\n<span class=\"w\">    </span>Exit<span class=\"w\"> </span>status:<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<p>and on master (as of <code>efeadfb18697dff701318</code>) </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Build<span class=\"w\"> </span>completed<span class=\"w\"> </span>successfully.\n<span class=\"w\">    </span>Command<span class=\"w\"> </span>being<span class=\"w\"> </span>timed:<span class=\"w\"> </span><span class=\"s2\">\"lake build Mathlib.Analysis.CStarAlgebra.lpSpace\"</span>\n<span class=\"w\">    </span>User<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>seconds<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">3789</span>.42\n<span class=\"w\">    </span>System<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>seconds<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">870</span>.09\n<span class=\"w\">    </span>Percent<span class=\"w\"> </span>of<span class=\"w\"> </span>CPU<span class=\"w\"> </span>this<span class=\"w\"> </span>job<span class=\"w\"> </span>got:<span class=\"w\"> </span><span class=\"m\">758</span>%\n<span class=\"w\">    </span>Elapsed<span class=\"w\"> </span><span class=\"o\">(</span>wall<span class=\"w\"> </span>clock<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>h:mm:ss<span class=\"w\"> </span>or<span class=\"w\"> </span>m:ss<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">10</span>:14.57\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>shared<span class=\"w\"> </span>text<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>unshared<span class=\"w\"> </span>data<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>stack<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>total<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Maximum<span class=\"w\"> </span>resident<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">1672416</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>resident<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Major<span class=\"w\"> </span><span class=\"o\">(</span>requiring<span class=\"w\"> </span>I/O<span class=\"o\">)</span><span class=\"w\"> </span>page<span class=\"w\"> </span>faults:<span class=\"w\"> </span><span class=\"m\">29693</span>\n<span class=\"w\">    </span>Minor<span class=\"w\"> </span><span class=\"o\">(</span>reclaiming<span class=\"w\"> </span>a<span class=\"w\"> </span>frame<span class=\"o\">)</span><span class=\"w\"> </span>page<span class=\"w\"> </span>faults:<span class=\"w\"> </span><span class=\"m\">242616062</span>\n<span class=\"w\">    </span>Voluntary<span class=\"w\"> </span>context<span class=\"w\"> </span>switches:<span class=\"w\"> </span><span class=\"m\">23532</span>\n<span class=\"w\">    </span>Involuntary<span class=\"w\"> </span>context<span class=\"w\"> </span>switches:<span class=\"w\"> </span><span class=\"m\">25346382</span>\n<span class=\"w\">    </span>Swaps:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>File<span class=\"w\"> </span>system<span class=\"w\"> </span>inputs:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>File<span class=\"w\"> </span>system<span class=\"w\"> </span>outputs:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Socket<span class=\"w\"> </span>messages<span class=\"w\"> </span>sent:<span class=\"w\"> </span><span class=\"m\">358</span>\n<span class=\"w\">    </span>Socket<span class=\"w\"> </span>messages<span class=\"w\"> </span>received:<span class=\"w\"> </span><span class=\"m\">55247</span>\n<span class=\"w\">    </span>Signals<span class=\"w\"> </span>delivered:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Page<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">16384</span>\n<span class=\"w\">    </span>Exit<span class=\"w\"> </span>status:<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<p>Generally I am skeptical that universal application of <code>fast_instance</code> will speed things up overall. Calling typeclass synthesis is just about the most expensive general thing you can do so hammering it over and over will bleed away any of the benefits you achieve with the instances with deeply nested non-canonical constructors. </p>\n<p>In fact, I surprised we came out with competitive timings here.</p>",
        "id": 496117376,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737983035
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"455674\">Matej Penciak</span> has marked this topic as resolved.</p>",
        "id": 509988938,
        "sender_full_name": "Notification Bot",
        "timestamp": 1743698458
    }
]