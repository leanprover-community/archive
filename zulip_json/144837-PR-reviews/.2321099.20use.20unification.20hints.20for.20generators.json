[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/21099\">#21099</a>, I use a few unification hints to unify the <code>vars</code> field of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators#doc\">docs#Algebra.Generators</a> of constructors such as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators.comp#doc\">docs#Algebra.Generators.comp</a> with the correct type, in this case</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">unif_hint</span><span class=\"w\"> </span><span class=\"n\">comp_vars_eq_sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"bp\">≟</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">vars</span>\n</code></pre></div>\n<p>This is to make this definitional equality observable at reducible transparency (for more explanation why we want this, I refer to the PR description). Which works, as this test shows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">vars</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>The reason why making <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators.comp#doc\">docs#Algebra.Generators.comp</a> an <code>abbrev</code> does not seem suitable, is that then <code>simp</code> also unfolds the other fields of the definition, in particular <code>val</code>, which is not desirable (sometimes we want to do it, but only in a controlled way). Also this caused a lot of breakage, see <a href=\"https://github.com/leanprover-community/mathlib4/pull/21050\">#21050</a> with instance search no longer reliably finding <code>Algebra (Q.comp P).Ring T</code>.</p>\n<p>I have no clue what these unification hints do under the hood, so I would be happy to hear from someone that understands them why this works and if this is a good idea. Also there is some performance regression in the (already on master) slow file <code>Mathlib.RingTheory.Kaehler.JacobiZariski</code>.<br>\n(cc <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span>)</p>",
        "id": 496095368,
        "sender_full_name": "Christian Merten",
        "timestamp": 1737976067
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span> , should we do the same thing for <code>id</code> and <code>comp</code> of morphisms?</p>",
        "id": 496096310,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737976379
    },
    {
        "content": "<p>I don’t think I’m ready to accept a single file over 1T instructions again.</p>",
        "id": 496107677,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737980043
    },
    {
        "content": "<p>The first parts of the <code>JacobiZariski</code> file should be moved to earlier files, independently of this. This only hides the slowness though.</p>",
        "id": 496109431,
        "sender_full_name": "Christian Merten",
        "timestamp": 1737980663
    },
    {
        "content": "<p>Brief inspection of the file on Friday pointed at universe unification as a major culprit</p>",
        "id": 496110238,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737980911
    },
    {
        "content": "<p>Aside: I find these lines terrifying </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"mi\">999999</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Zero.toOfNat0</span><span class=\"w\"> </span><span class=\"n\">SemilinearMapClass.distribMulActionSemiHomClass</span>\n<span class=\"w\">  </span><span class=\"n\">SemilinearEquivClass.instSemilinearMapClass</span><span class=\"w\"> </span><span class=\"n\">TensorProduct.addZeroClass</span><span class=\"w\"> </span><span class=\"n\">AddZeroClass.toZero</span>\n</code></pre></div>",
        "id": 496119154,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737983547
    },
    {
        "content": "<p>Strictly speaking they are no longer needed after <a href=\"https://github.com/leanprover-community/mathlib4/pull/11521\">#11521</a> and its follow up. But they still do help a bit.</p>",
        "id": 496119333,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737983611
    },
    {
        "content": "<p>So, for an example, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators.H1Cotangent#doc\">docs#Algebra.Generators.H1Cotangent</a>.δAux_toAlgHom goes from <code>type checking took 6.15s</code> to <code>type checking took 130ms</code> on my machine if I change from </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">lemma</span><span class=\"w\"> </span><span class=\"n\">δAux_toAlgHom</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>to </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">lemma</span><span class=\"w\"> </span><span class=\"n\">δAux_toAlgHom</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span>\n<span class=\"w\">   </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 496120420,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737983949
    },
    {
        "content": "<p>If I were to speculate, I would speculate that one shouldn't bundle types with free universe parameters into structures.</p>",
        "id": 496121716,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737984366
    },
    {
        "content": "<p>This makes the API significantly more annoying to use though, because in practice <code>Generators.vars</code> often lives in <code>Type 0</code>, but also often in <code>Type v</code> where <code>S : Type v</code>.</p>",
        "id": 496122278,
        "sender_full_name": "Christian Merten",
        "timestamp": 1737984540
    },
    {
        "content": "<p>Yes, I don't have a good answer for that.</p>",
        "id": 496122401,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737984590
    },
    {
        "content": "<p>I guess we don't have universe unification hints, do we?</p>",
        "id": 496122639,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737984659
    },
    {
        "content": "<p>Adding explicit universes seem to help:<br>\nChanging <code>CotangentSpace.compEquiv</code> to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">compEquiv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃ₗ</span><span class=\"o\">[</span><span class=\"n\">T</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n</code></pre></div>\n<p>And <code>CotangentSpace.compEquiv_symm_inr</code> to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">compEquiv_symm_inr</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">compEquiv</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"bp\">.</span><span class=\"n\">toLinearMap</span><span class=\"w\"> </span><span class=\"bp\">∘ₗ</span>\n<span class=\"w\">      </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">w'</span><span class=\"o\">}</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">toComp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtensionHom</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">liftBaseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n</code></pre></div>\n<p>Reduced the latter from 9.5s to 2.5s on my machine.<br>\nBut I think this might not be the \"right\" universes because it seems to make the rest of the file slower.</p>",
        "id": 496123165,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1737984817
    },
    {
        "content": "<p>To be fair, the universe arithmetic seems complex here by mathlib standards.</p>",
        "id": 496123717,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737984973
    },
    {
        "content": "<p>This behavior is also not new, see <a href=\"https://github.com/leanprover-community/mathlib4/pull/12737\">#12737</a>. It might be time to try to minimize it</p>",
        "id": 496124439,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737985161
    },
    {
        "content": "<p>Replacing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">δAux_toAlgHom</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">Q'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u₃</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">δAux_toAlgHom</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">Q'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>cuts it down to 165ms (from ~7s) on my machine. Which is very strange, because I believe this preserves the same universe generality (<code>w</code> and <code>w'</code> are unused in the first version).</p>",
        "id": 496125110,
        "sender_full_name": "Christian Merten",
        "timestamp": 1737985353
    },
    {
        "content": "<p>Does swapping <code>u₁</code> and <code>u₃</code> have the same effect? I'm suspecting it is the order of which they are declared.</p>",
        "id": 496125485,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1737985443
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2321099.20use.20unification.20hints.20for.20generators/near/496125110\">said</a>:</p>\n<blockquote>\n<p>Replacing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">δAux_toAlgHom</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">Q'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u₃</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">δAux_toAlgHom</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">Q'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>cuts it down to 165ms (from ~7s) on my machine. Which is very strange, because I believe this preserves the same universe generality (<code>w</code> and <code>w'</code> are unused in the first version).</p>\n</blockquote>\n<p>Same here</p>",
        "id": 496125551,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737985461
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2321099.20use.20unification.20hints.20for.20generators/near/496125485\">said</a>:</p>\n<blockquote>\n<p>Does swapping <code>u₁</code> and <code>u₃</code> have the same effect? I'm suspecting it is the order of which they are declared.</p>\n</blockquote>\n<p>Nope</p>",
        "id": 496125646,
        "sender_full_name": "Christian Merten",
        "timestamp": 1737985487
    },
    {
        "content": "<p>So this is clearly a bug? Universe unification should not depend on the naming or the order of declaration of universe variables, right?</p>",
        "id": 496125958,
        "sender_full_name": "Christian Merten",
        "timestamp": 1737985566
    },
    {
        "content": "<p>naming, no. order, maybe</p>",
        "id": 496126135,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1737985621
    },
    {
        "content": "<p>(order of universe variables makes a material difference for the result of a declaration, so it stands to reason it might influence it)</p>",
        "id": 496126392,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1737985687
    },
    {
        "content": "<p>You can permute the declaration of the universes at the start of the file and the performance does not improve. With <code>w</code> and <code>w'</code>, it is fine in either order</p>",
        "id": 496127376,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737985946
    },
    {
        "content": "<p>Maybe it's the consistency of using the same universe variables for the arguments in the declaration and in application?</p>",
        "id": 496127931,
        "sender_full_name": "Christian Merten",
        "timestamp": 1737986096
    },
    {
        "content": "<p>Here's a peculiar behaviour of lean that I think might be related</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">u₁</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"w\"> </span><span class=\"n\">u₃</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u₁</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"w\"> </span><span class=\"n\">u₃</span><span class=\"o\">))}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"c1\">-- foo A : Type (max (max u₁ u₂) u₃)</span>\n</code></pre></div>\n<p>Here the universe of <code>A</code> should be <code>max u₁ (max u₂ u₃)</code> but became <code>max (max u₁ u₂) u₃</code> in <code>foo</code>.</p>",
        "id": 496128416,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1737986220
    },
    {
        "content": "<p>They will even be sorted alphabetically <span aria-label=\"mind\" class=\"emoji emoji-1f92f\" role=\"img\" title=\"mind\">:mind:</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">c</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"c1\">-- foo A : Type (max (max (max a b) c) d)</span>\n</code></pre></div>",
        "id": 496131379,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1737986991
    },
    {
        "content": "<p>You pay the penalty elaborating the statement itself. </p>\n<p>Hmm, a fresh universe variable </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">114532</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">152</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>vs using <code>w</code> for the first one</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">562</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 496131482,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737987006
    },
    {
        "content": "<p>Yes, they are sorted alphabetically</p>",
        "id": 496131545,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737987024
    },
    {
        "content": "<p>The guess is that there is some syntatic check going on here because previous declarations have <code>w</code> in the signature</p>",
        "id": 496131810,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737987094
    },
    {
        "content": "<p>I think when the universes of the two sides of some unification don't match lean will start unfolding both sides before trying to solve the universe unification?</p>",
        "id": 496132129,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1737987172
    },
    {
        "content": "<p>And the universes of both sides don't match because lean sorts the universes differently?</p>",
        "id": 496132424,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1737987252
    },
    {
        "content": "<p>It does seem it is relying on the underlying string itself somehow and sorting alphabetically gives precedent to that being a factor in normalization of levels</p>",
        "id": 496132846,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737987373
    },
    {
        "content": "<p>It seems to be entirely in the kernel</p>",
        "id": 496134010,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1737987687
    },
    {
        "content": "<p>I did a test at <a href=\"https://github.com/leanprover-community/mathlib4/pull/21129\">#21129</a> and instructions are down by 30% with consistent usage of universe variables and ensuring that the universes of <code>R</code>, <code>S</code> and <code>T</code> alphabetically appear before the universes of <code>P</code> and <code>Q</code>.</p>",
        "id": 496151084,
        "sender_full_name": "Christian Merten",
        "timestamp": 1737992045
    },
    {
        "content": "<p>Is there a good way (e.g a trace option) to debug the “kernel type checking” step?</p>",
        "id": 496182585,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738000831
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2321099.20use.20unification.20hints.20for.20generators/near/496128416\">said</a>:</p>\n<blockquote>\n<p>Here the universe of <code>A</code> should be <code>max u₁ (max u₂ u₃)</code> but became <code>max (max u₁ u₂) u₃</code> in <code>foo</code>.</p>\n</blockquote>\n<p>Looks like <a href=\"https://github.com/leanprover/lean4/pull/6760\">lean4#6760</a> is related</p>\n<p>Update: <a href=\"https://github.com/leanprover/lean4/pull/6760\">lean4#6760</a> was closed as a duplicate of <a href=\"https://github.com/leanprover/lean4/pull/5695\">lean4#5695</a>; please upvote that one instead</p>",
        "id": 496238711,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1738025989
    }
]