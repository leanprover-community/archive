[
    {
        "content": "<p>From investigations associated with <a class=\"stream-topic\" data-stream-id=\"428973\" href=\"/#narrow/channel/428973-nightly-testing/topic/Mathlib.20status.20updates/with/426708935\">#nightly-testing &gt; Mathlib status updates</a> I found these relatively new instances which had as keys <code>Unique _</code> (<del>probably</del> maybe due to <code>.carrier</code> being a coercion). </p>\n<p>I don't expect much performance improvement but we don't want Lean trying to find a <code>Group</code> when it is searching for <code>Unique</code> in general.</p>",
        "id": 504580011,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741613013
    },
    {
        "content": "<p>Are coercions excluded from keys!?</p>",
        "id": 504582801,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741613569
    },
    {
        "content": "<p>I didn't supplement my understanding with actually looking at the code again so take that as my guess</p>",
        "id": 504584540,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741613929
    },
    {
        "content": "<p>I did find it odd from my experience so figured that something that mapped to <code>*</code> got inserted</p>",
        "id": 504584779,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741613987
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322780.20scoping.20a.20few.20instances.20with.20weak.20keys/near/504580011\">said</a>:</p>\n<blockquote>\n<p>I don't expect much performance improvement but we don't want Lean trying to find a <code>Group</code> when it is searching for <code>Unique</code> in general.</p>\n</blockquote>\n<p>Such pessimism was unnecessary.</p>",
        "id": 504608647,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741618696
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span> Benchmark   Metric       Change\n<span class=\"w\"> </span> ===============================\n<span class=\"gi\">+ lint        wall-clock    -7.7%</span>\n</code></pre></div>\n<p>Linting instructions almost tipped 5% too</p>",
        "id": 504609694,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741618883
    },
    {
        "content": "<p>Is <code>lint</code> the environment or syntax linter?</p>",
        "id": 504611551,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741619248
    },
    {
        "content": "<p>Environmental</p>",
        "id": 504611646,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741619272
    },
    {
        "content": "<p>Maybe it's worth breaking down that metric further; it would be a shame to make mathlib harder to use to speed up a badly-written linter</p>",
        "id": 504611873,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741619326
    },
    {
        "content": "<p>This is <code>simpNF</code>. The instances in question are never used outside perhaps their homes</p>",
        "id": 504612152,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741619382
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/144837-PR-reviews/topic/.2322780.20scoping.20a.20few.20instances.20with.20weak.20keys/near/504584540\">said</a>:</p>\n<blockquote>\n<p>I didn't supplement my understanding with actually looking at the code again so take that as my guess</p>\n</blockquote>\n<p>The issue is not the coercion, but that <code>of</code> is reducible</p>",
        "id": 504614044,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741619768
    },
    {
        "content": "<p>So actually these can be deleted entirely, <code>inferInstance</code> finds the necessary instances without any <code>instance</code> declarations needed</p>",
        "id": 504614652,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741619889
    },
    {
        "content": "<p>Even better! I've run out of time for now. Feel free to push the deletions</p>",
        "id": 504614934,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741619942
    },
    {
        "content": "<p>I came back and deleted them. Going to run again but people can scan through the output of </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">DiscrTree</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">env.constants.toList.filterM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">isInstance</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">forallMetaTelescopeReducing</span><span class=\"w\"> </span><span class=\"n\">info.type</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">keys</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkPath</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">keys.size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">keys</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">star</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"{name} : {keys}\"</span>\n</code></pre></div>\n<p>for other possibly insane instances.</p>",
        "id": 504683279,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741639355
    }
]