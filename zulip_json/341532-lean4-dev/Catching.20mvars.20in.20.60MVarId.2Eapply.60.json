[
    {
        "content": "<p>I think the MVarId catching logic in <code>MVarId.apply</code> should get mvars from the actual expression assignment to the current goal:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">otherMVarIds</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMVarsNoDelayed</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAppN</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">newMVars</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>as opposed to</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">otherMVarIds</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMVarsNoDelayed</span><span class=\"w\"> </span><span class=\"n\">e</span>\n</code></pre></div>\n<p>This is because  the <code>isDefEqApply</code> in the <code>go</code> loop could potentially <del>delay</del> assign some mvars in <code>newMVars</code>, in which case the value of the <del>delayed</del> assignment would be lost since <code>otherMVarIds</code> only contain mvars from <code>e</code>.</p>\n<p>I found a corner case in my project that suffers from this issue, but I don't know how to reliably reproduce this case.</p>",
        "id": 498584011,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1739093725
    },
    {
        "content": "<p>Specifically when <code>ctxApprox</code> is true, <code>isExprDefEq</code> can cause mvars in <code>newMVars</code> to be assigned to another (unassigned) mvar with a smaller context, so there should be a way to catch them.</p>\n<p>e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newMVars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newMVars.filterM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">mvar.mvarId</span><span class=\"bp\">!.</span><span class=\"n\">isAssigned</span>\n</code></pre></div>\n<p>Instead of this, we could have</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newMVars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">newMVars.filterMapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExprMVarAssignment</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">mvar</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"n\">inner</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">inner</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n</code></pre></div>\n<p>which will ensure <code>ctxApprox</code>'d mvars are accounted for.</p>",
        "id": 498893915,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1739233059
    },
    {
        "content": "<p>I don't know how to reliably trigger <code>ctxApprox</code>. Otherwise I can write a MWE that showcases when <code>.apply</code> loses track of a mvar.</p>",
        "id": 499362542,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1739411894
    }
]