[
    {
        "content": "<p>Admittedly I'm a new user but I spent a whole half an hour on this.</p>\n<p>This proof works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cpos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_sub</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>This proof doesn't:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cpos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_sub</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">tactic 'rewrite' failed, did not find instance of the pattern in the target expression</span>\n<span class=\"cm\">  ?a * (?b - ?c)</span>\n\n<span class=\"cm\">a b c k : ℕ</span>\n<span class=\"cm\">cpos : 0 &lt; c</span>\n<span class=\"cm\">h : k ∣ c * a - c * b</span>\n<span class=\"cm\">⊢ k ∣ c * (a - b)</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>This specific failure is confusing because \"the pattern\" is <em>definitely there</em>, it's just the types don't match. (Presumably I was supposed to know that naturals are not, in fact, a <code>NonUnitalNonAssocRing</code>. Or maybe they are? I don't know how to check.)</p>\n<p>I wonder if it would be possible to give a better error message in cases like this? Or is it on me for not looking at the \"Expected type\" pane? What is the mechanism by which I was expected to find the real error cause in this example?</p>\n<p>I also have another example, arguably a more severe one.</p>\n<p>This proof works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cpos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_sub</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>This proof doesn't:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cpos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_sub</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">tactic 'rewrite' failed, equality or iff proof expected</span>\n<span class=\"cm\">  ?m.563</span>\n\n<span class=\"cm\">a b c k : ℕ</span>\n<span class=\"cm\">cpos : 0 &lt; c</span>\n<span class=\"cm\">h : k ∣ c * a - c * b</span>\n<span class=\"cm\">⊢ k ∣ c * (a - b)</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>Yeah, I know, same problem, etc. But the error message here led me on a completely false trail. It seemed to imply that the <code>rw</code> tactic is only valid to \"apply\" to an expression that looks like an equality (<code>=</code>) or an iff (<code>↔</code>). Being an inexperienced user, I took what it was saying at face value, and thought that somehow <code>rw</code> doesn't work for rewriting statements like <code>k ∣ c * (a - b)</code>. Which is, of course, completely wrong, so I wasted a bunch of time.</p>\n<p>How I'd love to see this solved, in the order of preference:</p>\n<ul>\n<li>An ideal error message would have \"Did you mean <code>Nat.mul_sub</code>?\" Presumably the compiler is aware of which namespaces have a theorem with the same name whose types match up unlike mine. But maybe this is too idealistic.</li>\n<li>The next best thing would be if <code>tactic 'rewrite' failed, equality or iff proof expected</code> in the second example instead told me something that reflected the real cause of the issue.</li>\n</ul>\n<p>Thanks for reading my rant!</p>",
        "id": 500777655,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740016162
    },
    {
        "content": "<p>I'm guessing in the second example, the error message means that <em>the thing I'm passing to <code>rw</code></em> needs to be an equality or an iif. But since that's what it <em>looks like</em> in the definition, it's not obvious that it ended up being something else (presumably it never got properly \"synthesized\" so it's some broken placeholder, and <code>rw</code> bails on it?)</p>\n<p>So maybe there's an opportunity to improve the <code>rw</code> error message when the thing being passed to it is completely borked.</p>",
        "id": 500778218,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740016594
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418569\">@Dan Abramov</span> are you perhaps using an older version of Lean?</p>\n<p>I get:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cpos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_sub</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>producing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">NonUnitalNonAssocRing</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n</code></pre></div>",
        "id": 500779707,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740017556
    },
    {
        "content": "<p>But ideally the first example would manage to do the same thing. Usually in this case of a failed rewrite I would hover over the lemma to manually inspect the type signature, and hopefully realise that the typeclass was the problem.</p>\n<p>Pinging <span class=\"user-mention\" data-user-id=\"478376\">@Joseph Rotella</span>, could you track the first example somewhere? It would be great to improve the error message there.</p>\n<p>Checking alternative namespaces and suggesting the lemma that the user really wanted would, of course, be wonderful! :-)</p>",
        "id": 500779895,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740017690
    },
    {
        "content": "<p>Looks like I have 4.16.0 installed but running 4.13.0 in the project as per my (maybe outdated?) <code>mathematics_in_lean</code> checkout. Sorry I'm not testing against the latest.</p>",
        "id": 500781271,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740018597
    },
    {
        "content": "<p>Re: error message, to be clear, I get both:</p>\n<p><a href=\"/user_uploads/3121/JNdPYfDmSj99oNPCpyHqVuqg/Screenshot-2025-02-20-at-02.30.11.png\">Screenshot 2025-02-20 at 02.30.11.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/JNdPYfDmSj99oNPCpyHqVuqg/Screenshot-2025-02-20-at-02.30.11.png\" title=\"Screenshot 2025-02-20 at 02.30.11.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"820x1158\" src=\"/user_uploads/thumbnail/3121/JNdPYfDmSj99oNPCpyHqVuqg/Screenshot-2025-02-20-at-02.30.11.png/840x560.webp\"></a></div><p>As a user I usually mentally skip the first one because I have completely no idea what it is saying (what does it mean to \"fail to synthesize\"? this feels like compiler speak leaking into userland so I tend to ignore messages like this).</p>\n<p>Whereas the \"tactic 'rewrite' failed\" below is at least familiar, usually meaningful, and has context. (In this case, it's misleading though.)</p>",
        "id": 500781449,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740018704
    },
    {
        "content": "<blockquote>\n<p>Usually in this case of a failed rewrite I would hover over the lemma to manually inspect the type signature, and hopefully realise that the typeclass was the problem.</p>\n</blockquote>\n<p>How would you know that it is a problem? There is nothing I can see indicating that <code>N</code> doesn't implement it. And I presume it would require hunting through many definitions to find all typeclasses that N implements. So what is a good way to find this out aside from memorizing all the relevant typeclasses?</p>\n<p>Tbh I would expect the tooling to say something like \"<code>a</code> is <code>ℕ</code> which does not implement <code>NonUnitalNonAssocRing</code>\".</p>\n<p>Is this what \"failed to synthesize NonUnitalNonAssocRing ℕ\" was supposed to convey?</p>",
        "id": 500782005,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740019054
    },
    {
        "content": "<p>Just to clarify my confusion, I find the wording \"failed to synthesize A B\" close to being a word salad — if it really means \"B is not of type A\", IMO it would be a big improvement to rephrase it as such (and even better if it mentioned <em>which variable</em> failed that check).</p>",
        "id": 500782202,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740019172
    },
    {
        "content": "<p>So I guess there's three separate things:</p>\n<ul>\n<li>Would be nice to improve \"cannot match pattern\" when it <em>does</em> match the shape of the syntax but fails due to typeclasses. In this case, it would be better if the error messaged emphasized the issue with typeclasses. This applies to the first example.<ul>\n<li>For bonus points, it would be nice if it suggested namespaced theorems with the same name if any match the typeclasses.</li>\n</ul>\n</li>\n<li>Would be nice to rephrase \"Cannot synthesize A B\" into \"Expected type A, but got variable x of incompatible type B\" or even just \"A is not compatible with B\" or \"A does not implement B\" or something like that. This applies to the second example only.</li>\n<li>Would be nice to not show \"equality of iff expected\" at all, or to change its wording, when the root issue is due to typeclasses. Right now it's shown <em>together</em> with \"Cannot synthesize\" but it's unclear which one is the root issue. This applies to the second example only.</li>\n</ul>",
        "id": 500782692,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740019469
    },
    {
        "content": "<p>\"Failed to synthesize\" is talking about the instance argument in <code>mul_sub</code>. It couldn't find an instance to use for that argument.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">mul_sub</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NonUnitalNonAssocRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>\n<p>The fact that the error is that it could not synthesize a <code>NonUnitalNonAssocRing ℕ</code> instance, that means that <code>ℕ</code> doesn't implement it.</p>",
        "id": 500785054,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740021008
    },
    {
        "content": "<p>It could at least say \"failed to synthesize instance\" to let you know that there was no instance of that type it could find.</p>",
        "id": 500785183,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740021119
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"418569\">Dan Abramov</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500782202\">said</a>:</p>\n<blockquote>\n<p>Just to clarify my confusion, I find the wording \"failed to synthesize A B\" close to being a word salad — if it really means \"B is not of type A\", IMO it would be a big improvement to rephrase it as such (and even better if it mentioned <em>which variable</em> failed that check).</p>\n</blockquote>\n<p>Fundamentally, the way typeclasses and instances work in Lean is incompatible with this. They might be called <em>type</em>classes, but the class system is a way to synthesize a term of a particular type automatically. We might think about <code>NonUnitalNonAssocRing ℕ</code> as if it's implemented \"for\" <code>ℕ</code>, but in general, the question is just whether or not there's a <code>NonUnitalNonAssocRing ℕ</code> instance to be found, which is then used for the instance argument.</p>\n<p>One of the ways to check from outside a tactic is with the <code>#synth NonUnitalNonAssocRing ℕ</code> command.</p>\n<p>I worry that having error messages pretend that classes are attached to types would give incorrect mental models of how Lean works.</p>",
        "id": 500785437,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740021286
    },
    {
        "content": "<p>(deleted, nevermind, that was a different error)</p>",
        "id": 500785672,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740021440
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"418569\">Dan Abramov</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500782692\">said</a>:</p>\n<blockquote>\n<p>For bonus points, it would be nice if it suggested namespaced theorems with the same name if any match the typeclasses.</p>\n</blockquote>\n<p>That could potentially be helpful (though at the same time fairly complicated to do).</p>\n<p>Another approach is to figure out if there's a more general setting that would include Nat as well. On one hand, that would make <code>mul_sub</code> work, but on another it might be some weird algebraic structure you'd have to learn something about. Having classes like <code>NonUnitalNonAssocRing</code> is a consequence to trying to make theorems generally applicable...</p>",
        "id": 500786257,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740021839
    },
    {
        "content": "<blockquote>\n<p>We might think about <code>NonUnitalNonAssocRing ℕ</code> as if it's implemented \"for\" <code>ℕ</code>, but in general, the question is just whether or not there's a <code>NonUnitalNonAssocRing ℕ</code> instance to be found, which is then used for the instance argument.</p>\n</blockquote>\n<p>Would \"Could not pass <code>a : ℕ</code> as <code>NonUnitalNonAssocRing</code> because no <code>NonUnitalNonAssocRing ℕ</code> instance was found\" be accurate? I'm all for presenting an accurate mental model; the issue in this case for me is that the error does nothing to teach me what the mental model is. It just looks like some internal diagnostic. Tbh I didn't even realize this <em>is</em> the error message I'm supposed to care about.</p>",
        "id": 500786343,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740021878
    },
    {
        "content": "<p>In particular, I did not even notice <code>ℕ</code> in the error message because it's printed right after <code>NonUnitalNonAssocRing</code>. So I missed that it's a \"Thing A doesn't work with thing B\" kind of thing.</p>",
        "id": 500786435,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740021957
    },
    {
        "content": "<p><code>NonUnitalNonAssocRing ℕ</code> is the actual Lean expression for the type though. Typeclasses in Lean are nothing more than a way to automatically insert arguments for you. (While doing some backtracking Prolog-like search to piece the instances together, since instances themselves can have instance parameters too.)</p>",
        "id": 500786530,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740022009
    },
    {
        "content": "<p>I do think there is some sort of bug in the error reporting. Somewhere in the system it has the match it found, and the failure to synthesize the instances is causing it to throw that away.</p>",
        "id": 500786658,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740022083
    },
    {
        "content": "<p>What I don't see is how it connects to my code. Missing <code>ℕ</code> is my bad, sure. But even then, it would help to at least know which argument failed to match, or that indeed it's one of the arguments that was failing. To give a sense of where I'm coming from — something like <a href=\"https://elm-lang.org/news/compiler-errors-for-humans\">https://elm-lang.org/news/compiler-errors-for-humans</a> is inspiring, and I'd like to see more Lean errors feel \"connected\" to the code being written.</p>",
        "id": 500786769,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740022160
    },
    {
        "content": "<p>The issue though is that there's no argument that failed to match though, unless by \"match\" you mean this instance synthesis subproblem failure</p>",
        "id": 500786899,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740022227
    },
    {
        "content": "<p>I do agree that this can be better</p>",
        "id": 500786918,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740022243
    },
    {
        "content": "<p>I'm just trying to work out which part is the underlying problem</p>",
        "id": 500786953,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740022266
    },
    {
        "content": "<p>Looking at this code:</p>\n<p><a href=\"/user_uploads/3121/2CGcUapBhUpn6apVvJlH-H_U/Screenshot-2025-02-20-at-03.30.28.png\">Screenshot 2025-02-20 at 03.30.28.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/2CGcUapBhUpn6apVvJlH-H_U/Screenshot-2025-02-20-at-03.30.28.png\" title=\"Screenshot 2025-02-20 at 03.30.28.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1418x646\" src=\"/user_uploads/thumbnail/3121/2CGcUapBhUpn6apVvJlH-H_U/Screenshot-2025-02-20-at-03.30.28.png/840x560.webp\"></a></div><p>I see a few ways to interpret the mistake, as a chain from the root cause to the surface:</p>\n<ul>\n<li>Root cause (user error): The user is using a wrong <code>mul_sub</code><ul>\n<li>One degree of separation: The user is passing a <code>Nat</code> there. But this <code>mul_sub</code> doesn't take a <code>Nat</code> — it takes a <code>NonUnitalNonAssocRing</code>.<ul>\n<li>Two degrees of separation: Perhaps <code>Nat</code> is a <code>NonUnitalNonAssocRing</code>? But we weren't able to find a way to treat <code>Nat</code> as a <code>NonUnitalNonAssocRing</code>. Alas :(</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>To me, the issue is that the error message effectively only reports the innermost problem. It's very hard to notice the tiny part that's relevant in the hovered box, and to connect it to my code.</p>\n<p><a href=\"/user_uploads/3121/mE2AEk2V64NRSnzF8zd0rA5Q/Screenshot-2025-02-20-at-03.30.28.png\">Screenshot 2025-02-20 at 03.30.28.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/mE2AEk2V64NRSnzF8zd0rA5Q/Screenshot-2025-02-20-at-03.30.28.png\" title=\"Screenshot 2025-02-20 at 03.30.28.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1418x646\" src=\"/user_uploads/thumbnail/3121/mE2AEk2V64NRSnzF8zd0rA5Q/Screenshot-2025-02-20-at-03.30.28.png/840x560.webp\"></a></div><p>I'm not sure what to propose concretely, but I'd like to see more of the \"problem chain\" reflected in the user-visible diagnostics.</p>",
        "id": 500787326,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740022542
    },
    {
        "content": "<p>Let's be sure to disentangle two issues:</p>\n<ol>\n<li>There's the issue that it reports \"no match found\" with metavariables. This should not be there. It's a red herring, and it is throwing people off. In fact, I fixed this <code>mul_sub c</code> example in <a href=\"https://github.com/leanprover/lean4/pull/6891\">lean4#6891</a>.</li>\n<li>How to report synthesis errors in terms in general.</li>\n</ol>",
        "id": 500787495,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740022669
    },
    {
        "content": "<p>With 2, the synthesis error is the general one. It's exactly the same as if you had done</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mul_sub</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>You'll get the synthesis error on <code>mul_sub c</code>. It's a function application, and it fails to fill in the instance argument, like in any other instance synthesis failure.</p>\n<p>I agree that the failure should have some more information, but there's not a great chain-of-reasoning story here.</p>",
        "id": 500787703,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740022807
    },
    {
        "content": "<p>Yea. I'm trying to look at this holistically (we've not \"solved\" the problem until the entire flow is good, even down to how it's displayed in VS Code) but mostly focusing on (2) now.</p>\n<p>Basically, my problem in (2) is that you have to know that if a function takes A and you give it B, Lean will need \"synthesize\" <code>B A</code>\" by searching for instances of that, and then if it doesn't find it, it'll complain about <em>that</em>. But knowledge is not appropriate to expect at the user education level when this error shows up. This error shows up all the time to beginners. I've been learning Lean almost full time for several weeks and I still have no idea how typeclasses work or what instances are or any of that. So it's not appropriate to make understanding this a hard dependency for solving this error message.</p>",
        "id": 500787714,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740022822
    },
    {
        "content": "<blockquote>\n<p>It's a function application, and it fails to fill in the instance argument, like in any other instance synthesis failure.</p>\n</blockquote>\n<p>What is the instance argument in this case? Is it <code>α</code>? Is it <code>c</code>? Which argument does the error refer to?</p>",
        "id": 500787903,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740022974
    },
    {
        "content": "<p>I mean <code>[NonUnitalNonAssocRing ℕ]</code> itself. That's the instance argument.</p>",
        "id": 500787952,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023017
    },
    {
        "content": "<p><code>nat_sub</code>'s second argument is a structure that packages up all the data and proofs of a non-unital non-associative ring (whatever those are). It's implicit, and it's synthesized by the typeclass system based on available instances.</p>",
        "id": 500788044,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023056
    },
    {
        "content": "<p>The name of the argument is unspecified. Instance arguments are generally never passed to nor referred to by name.</p>",
        "id": 500788094,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023098
    },
    {
        "content": "<p>I see. So the real chain of what happened was:</p>\n<ul>\n<li>I passed <code>c</code> which is <code>Nat</code></li>\n<li>This inferred the type <code>(a b c : α)</code> to be <code>(a b c : Nat)</code></li>\n<li>This means <code>[NonUnitalNonAssocRing α]</code> became <code>[NonUnitalNonAssocRing Nat]</code></li>\n<li>But there is no such thing, hence the error</li>\n</ul>\n<p>?</p>",
        "id": 500788110,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740023104
    },
    {
        "content": "<p>You could write <code>[inst : NonUnitalNonAssocRing Nat]</code> as well, to give it a name.</p>",
        "id": 500788127,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023114
    },
    {
        "content": "<p>Yes, correct.</p>",
        "id": 500788145,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023127
    },
    {
        "content": "<p>I get that failing to instantiate some term is a general error but can this error be special-cased in this more specific circumstance (instance arguments)?</p>",
        "id": 500788298,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740023242
    },
    {
        "content": "<p>This is the error in that special case. The error is missing the word \"instance\"</p>",
        "id": 500788391,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023293
    },
    {
        "content": "<p>If you see \"could not synthesize placeholder\", that's a more general failure. There's also \"type mismatch\" errors, which come from failed coercions.</p>",
        "id": 500788456,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023354
    },
    {
        "content": "<p>I feel something like this would feel clearer:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">pass</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NonUnitalNonAssocRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">no</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">NonUnitalNonAssocRing</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"bp\">.</span>\n<span class=\"n\">Either</span><span class=\"w\"> </span><span class=\"n\">you're</span><span class=\"w\"> </span><span class=\"n\">passing</span><span class=\"w\"> </span><span class=\"n\">incompatible</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>What do you think?</p>",
        "id": 500788822,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740023605
    },
    {
        "content": "<p>Trying to make this \"cannot synthesize\" error better for new users is a very hard problem:</p>\n<ul>\n<li>Typeclass synthesis is a fundamental feature that is used pervasively by the entire library.</li>\n<li>Everyone sees this error all the time, new users and experienced alike. We can't put an entire manual here. There's room for improvement of course, and at the least a reference manual link.</li>\n<li>There's no system to trace <em>why</em> a particular unification happened, so we can't currently try to explain what chain of reasoning led to the system looking for this instance. There are still some things we could do better here, like show the function application where the failure occurred, to let users see what types were inferred.</li>\n<li>Mathlib is designed to be very general. This leads to unfamiliar algebraic structures like <code>NonUnitalNonAssocRing</code>, and it makes it harder to get into the system. The antipode would be having a <code>mul_sub</code> per type, which is not scalable.</li>\n</ul>",
        "id": 500788835,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023619
    },
    {
        "content": "<p>Yeah I sympathize with this being a hard problem. Curious what you think about the proposal above. I don't want to make it a mouthful if it shows up all the time but the key thing it fails to convey right now, IMO, is where its \"two sides\" are coming from. It just says \"can't do <code>A B</code>\" but <code>A</code> is coming from my code and <code>B</code> is coming from a library. It's not obvious how the system \"got to\" <code>A B</code>. Even if it reads technically, I think making the \"we tried to match the inferred A with expected B\" somewhere would be very valuable instead of failing at the last moment (<code>A B</code> failed).</p>",
        "id": 500789185,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740023858
    },
    {
        "content": "<p>Here's another attempt:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>While elaborating the expression\n  mul_sub c\nthe instance implicit argument of type\n  NonUnitalNonAssocRing ℕ\ncould not be synthesized.\n\nThis could be because of a missing instance, a missing import,\nor incorrect arguments.\n</code></pre></div>",
        "id": 500789261,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740023887
    },
    {
        "content": "<p>In this case, the <em>decision</em> to \"put A and B together\" is something that Lean chose to do when matching up expressions. I didn't <em>write</em> <code>A B</code> in my code. So I feel like presenting the error from the perspective of <code>A B</code> failed is wrong. It needs to \"backtrack\" the explanation to what <em>I'm</em> aware of as a user, if that makes sense. That's the philosophical principle I'm trying to stick to. Of course, if <em>my</em> code said <code>A B</code>, it would be a different story.</p>",
        "id": 500789343,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740023952
    },
    {
        "content": "<p>You did (indirectly) write <code>A B</code> in the code though. It's in the type of <code>mul_sub</code>, which you used.</p>\n<p>I get what you're saying, but there are many many places in Lean where when you write something somewhere, it gets unified into another position.</p>",
        "id": 500789480,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024034
    },
    {
        "content": "<p>Yea. I guess I'm advocating for the compiler errors to try to track these unification decisions and special-case some of them with better error messages.</p>",
        "id": 500789572,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740024085
    },
    {
        "content": "<p>Right now, the best we have would be to print out the type of <code>mul_sub</code>, or to print out the instance argument in that type, and hope the variable name alpha doesn't shadow anything in the local context, making things horribly confusing</p>",
        "id": 500789746,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024190
    },
    {
        "content": "<p>If we can't do that, I wonder if we can keep the <code>[</code> and <code>]</code> in the error message. This would serve as a strong hint that it maps 1:1 to the signature, which I think would provide the intution for what the \"instance argument\" is. I didn't understand the notation until you said it's an argument and it's literally being filled in.</p>",
        "id": 500789754,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740024200
    },
    {
        "content": "<p>At least with the error message proposal I suggested:</p>\n<ol>\n<li>You can hover over <code>mul_sub</code> to see its type.</li>\n<li>\"instance implicit argument\" is the key phrase. I'm not sure this error message is the place to learn about <code>[...]</code> being an instance implicit argument, but I'm sure we could make something short to put there, but in any case \"instance implicit argument\" can be searched for in the manual.</li>\n</ol>",
        "id": 500789879,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024275
    },
    {
        "content": "<p>Is this too long?</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>While elaborating the expression\n  mul_sub c\nthe instance implicit argument\n  [NonUnitalNonAssocRing α]\nwas inferred to be\n  [NonUnitalNonAssocRing ℕ]\nbut could not be synthesized.\n\nThis could be because of a missing instance, a missing import,\nor incorrect arguments.\n</code></pre></div>",
        "id": 500789924,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740024318
    },
    {
        "content": "<p>Do you think it would be confusing if a user had alpha in their local context? This alpha and the local context alpha are different.</p>",
        "id": 500789955,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024356
    },
    {
        "content": "<p>Example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Sub</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_sub</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 500790107,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024456
    },
    {
        "content": "<p>(A better example would have alpha here be for a different type not involved in the goal, but I hope that's enough to point toward the general issue)</p>",
        "id": 500790179,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024486
    },
    {
        "content": "<p>It's not great when error messages have elements that are valid in different local contexts.</p>",
        "id": 500790217,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024527
    },
    {
        "content": "<p>Yea that's fair. I suppose just the formatting changes would go a long way — I probably wouldn't have missed <code>ℕ</code> in the message with this formatting.</p>",
        "id": 500790345,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740024619
    },
    {
        "content": "<p>How about this?</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>failed to synthesize the instance implicit argument\n  [NonUnitalNonAssocRing ℕ]\nwhile elaborating the application\n  mul_sub c\n\nThis could be because of a missing instance, a missing import,\nor incorrect arguments.\n</code></pre></div>",
        "id": 500790396,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024672
    },
    {
        "content": "<p>Yeah this is a significant improvement IMO!</p>",
        "id": 500790431,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740024700
    },
    {
        "content": "<p>:shipit:</p>",
        "id": 500790441,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740024715
    },
    {
        "content": "<p>I'm not sold on including the square brackets; I worry it might looking like a one-element list.</p>\n<p>It's more grammatical writing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">implicit</span><span class=\"w\"> </span><span class=\"n\">argument</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">NonUnitalNonAssocRing</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"n\">during</span><span class=\"w\"> </span><span class=\"n\">elaboration</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">application</span>\n<span class=\"w\">  </span><span class=\"n\">mul_sub</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>",
        "id": 500790525,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024765
    },
    {
        "content": "<p>Want to make a Lean 4 issue to track this? This isn't a five minute job (or I might do it right now), and it'll take work getting the right information to the right places to generate this error.</p>",
        "id": 500790705,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740024898
    },
    {
        "content": "<p>I'd appreciate if you could do it (a bit late for me so I should really go to sleep)! And thanks for sticking with me here.</p>",
        "id": 500790835,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740024982
    },
    {
        "content": "<p>Ok, I'll star the message and get around to it at some point :-)</p>",
        "id": 500790871,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740025014
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"418569\">Dan Abramov</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500787714\">said</a>:</p>\n<blockquote>\n<p>I've been learning Lean almost full time for several weeks and I still have no idea how typeclasses work or what instances are or any of that. So it's not appropriate to make understanding this a hard dependency for solving this error message.</p>\n</blockquote>\n<p>This is suggest there is something very suboptimal with your way of learning Lean, and working on that is probably more immediately useful for you than working on error messages (but improving error messages is always great, even if it requires users to read them). The type class system is a very very core component of Lean. What resource are you using to learn Lean? We can probably help you find a suitable place where you can learn about type classes.</p>",
        "id": 500823006,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740041004
    },
    {
        "content": "<p>I learnt them from <a href=\"https://leanprover.github.io/theorem_proving_in_lean4/\">#tpil</a> which has a <a href=\"https://leanprover.github.io/theorem_proving_in_lean4/type_classes.html\">section on them</a>.</p>",
        "id": 500826038,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740041898
    },
    {
        "content": "<p>There are explained in many different places, but not every place will be equally accessible depending on what Dan read before, that’s why I’m asking about his current learning resources.</p>",
        "id": 500827361,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740042289
    },
    {
        "content": "<p>Something else that could be useful to point out: Dan, you should be very careful whenever you use subtraction of natural numbers. This is a very weird operation since it has type <code>ℕ → ℕ → ℕ</code> so it’s bound to do something weird to <code>a - b</code> when <code>b</code> is greater than <code>a</code> (namely it returns <code>0</code>). So you shouldn’t expect any general lemma about subtraction to apply to <code>ℕ</code>. For instance that <code>Nat.mul_sub</code> actually takes some thinking. It’s kind of a miracle that it actually holds, and the proof is completely different from the proof you would do for a ring (say for ℤ).</p>",
        "id": 500828347,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740042623
    },
    {
        "content": "<p>So, before seeing any error message, the first survival trick is to look at the statement and think “this statement is cursed, because it has a natural number subtraction, should I reconsider?”</p>",
        "id": 500828680,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740042728
    },
    {
        "content": "<p>I mean, I’ll sure get to them — I understand they’re pretty important. I’m going through Mathematics in Lean and I’m on the fourth chapter now. However, I don’t think I can agree with your statement — of course they’re important to learn by the time you’re doing real stuff, but if we just think from the perspective of learning order, learning to <code>apply</code> theorems about numbers comes way before. And if you can run into an error at that point, the error should be comprehensible.</p>\n<p>My background is not in academy (it’s web development). And I want to stress that I’m not just raising this because I got stuck and am uniquely averse to learning typeclasses. I’m raising this because I see it as a basic usability issue that impedes learning. Learning about typeclasses will be important, but it shouldn’t “block” you from understanding what amounts to a basic type error in other languages. I don’t propose to fundamentally change something here, but to make the diagnostic slightly more suggestive so that it provides the right intuition (and if anything, can serve as a starting point to learn about typeclasses). And because my background is not in academia but in mainstream software development tools, I’m trying to apply a slightly higher standard to usability because that’s important if we want a broader audience to not get stuck learning Lean. Hope that makes sense as a motivation.</p>",
        "id": 500860822,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740052790
    },
    {
        "content": "<p>Improving error messages totally makes sense! It’s a never ending quest, and I certainly hope this thread contributes to it.</p>",
        "id": 500861412,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740052928
    },
    {
        "content": "<p>And indeed MIL will tell you about type classes but a bit later since, as you point out, they are not really needed at this stage.</p>",
        "id": 500861546,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740052973
    },
    {
        "content": "<p>Is the exercise with natural number subtraction that started this thread in MIL? If yes then I will definitely fix that trap.</p>",
        "id": 500861639,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740053008
    },
    {
        "content": "<p>I got into it from this exercise in chapter 4:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nnz</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pow_eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">r</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">npow_nz</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">npowz</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">nnz</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pow_eq_zero</span><span class=\"w\"> </span><span class=\"n\">npowz</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">eq1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">factorization_pow'</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">eq2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">factorization_pow'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">factorization_mul'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_comm</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">npow_nz</span>\n<span class=\"w\">    </span><span class=\"n\">norm_num</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">eq1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pow_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eq2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_comm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_sub_cancel</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_sub</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- forgot to put Nat. here</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">dvd_mul_right</span>\n</code></pre></div>\n<p>Adding <code>Nat.*</code> hasn't been a habit for me because earlier chapters mostly used theorems without prefixes and I forgot that.</p>",
        "id": 500866701,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740054759
    },
    {
        "content": "<p>Another nit I want to raise is that the <code>Additional diagnostic information may be available using the set_option diagnostics true command.</code> addendum is distracting and should IMO be at least separated by an extra newline from the actual error. It's not helpful here and makes scanning the error message more difficult.</p>\n<p><a href=\"/user_uploads/3121/ViHwYYP_JpmOyUX_mbTnrpb5/Screenshot-2025-02-20-at-12.37.37.png\">Screenshot 2025-02-20 at 12.37.37.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/ViHwYYP_JpmOyUX_mbTnrpb5/Screenshot-2025-02-20-at-12.37.37.png\" title=\"Screenshot 2025-02-20 at 12.37.37.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"750x312\" src=\"/user_uploads/thumbnail/3121/ViHwYYP_JpmOyUX_mbTnrpb5/Screenshot-2025-02-20-at-12.37.37.png/840x560.webp\"></a></div>",
        "id": 500867716,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740055117
    },
    {
        "content": "<p>Ok, that’s definitely not the intended solution, as hinted at by</p>\n<blockquote>\n<p>At the very end, you can use <code>Nat.dvd_sub'</code> and <code>Nat.dvd_mul_right</code> to finish it off.</p>\n</blockquote>\n<p>but it’s a natural thing to do anyway.</p>",
        "id": 500871563,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740056287
    },
    {
        "content": "<p>Ah yeah fair enough, I kind of enjoy avoiding hints at this point and trying to bruteforce it myself.</p>",
        "id": 500886308,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740060247
    },
    {
        "content": "<p>Feeling silly but I just spent another 20 minutes on this exact set of errors.</p>\n<p>My code, simplified, was this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bla</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">div_mul_cancel</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">ring</span>\n</code></pre></div>\n<p>I got this useless error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">rewrite'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span>\n\n<span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>But it was, of course, literally that pattern!</p>\n<p>Then I remembered about this issue and tried</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bla</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">div_mul_cancel</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n</code></pre></div>\n<p>to see if I might get a more helpful error message and now I was getting</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n</code></pre></div>\n<p>At this point I spent another 10 minutes because I thought <code>ℕ</code> was a group (but it really wasn't) and I must be doing something else wrong (but ofc it's not a group).</p>\n<p>I know this is user error etc, just conveying how it felt to use this.</p>",
        "id": 500909875,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740065995
    },
    {
        "content": "<p>If you import all of Mathlib, and Lean cannot find an instance about a basic type, like <code>ℕ, ℤ, ℚ, ℝ, ℂ</code> (and more), a very good heuristic is that the instance is actually false.</p>",
        "id": 500912769,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1740066712
    },
    {
        "content": "<p>This is indeed exactly the same issue as this morning: it has not much to do with type-class synthesis but a lot to do with dangerous operation on ℕ. Your statement is simply false. For instance 1 is a counter-example.</p>",
        "id": 500921168,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740068878
    },
    {
        "content": "<p>This time the issue is not subtraction but division.</p>",
        "id": 500921265,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740068895
    },
    {
        "content": "<p>Again division on ℕ has type <code>ℕ → ℕ → ℕ</code>, so it cannot be what you think it is.</p>",
        "id": 500921382,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740068927
    },
    {
        "content": "<p>Right, I understand what the issue is, I just wish the cause was more clearly communicated.</p>",
        "id": 500921585,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1740068975
    },
    {
        "content": "<p>The FRO is working on that.</p>",
        "id": 500921681,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740069000
    },
    {
        "content": "<p>And I’m working on rewriting the MIL example we discussed before to avoid creating that risk.</p>",
        "id": 500922078,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740069092
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"418569\">Dan Abramov</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500867716\">said</a>:</p>\n<blockquote>\n<p>Another nit I want to raise is that the <code>Additional diagnostic information may be available using the set_option diagnostics true command.</code> addendum is distracting and should IMO be at least separated by an extra newline from the actual error. It's not helpful here and makes scanning the error message more difficult.</p>\n<p><a href=\"/user_uploads/3121/ViHwYYP_JpmOyUX_mbTnrpb5/Screenshot-2025-02-20-at-12.37.37.png\">Screenshot 2025-02-20 at 12.37.37.png</a></p>\n</blockquote>\n<p>This one at least is easy to implement: <a href=\"https://github.com/leanprover/lean4/pull/7169\">lean#7169</a>. I've asked Kyle and <span class=\"user-mention\" data-user-id=\"478376\">@Joseph Rotella</span> to review; I let them merge if they're happy.</p>",
        "id": 500970885,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740086235
    },
    {
        "content": "<p>Just chiming in late here, but I agree with Dan that these are amongst the least helpful common messages from Lean! </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">rewrite'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span>\n</code></pre></div>\n<p>when the pattern is obviously there is just <em>frustrating</em>.</p>\n<p>So Dan, despite our various pushbacks and explanations that it's complicated to fix --- we are grateful for you taking the time to explain your unhappy encounters with error messages. It is really helpful to hear the new-user-but-knows-UX perspective, as too often we've just got used to these issues.</p>",
        "id": 500971313,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740086418
    },
    {
        "content": "<p>When lean throws the <code>did not find instance</code> error, could it also add a line after saying <code>where the appropriate type(s) satisfy `[typeclass assumptions]` </code>?</p>",
        "id": 500971772,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740086642
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500971313\">said</a>:</p>\n<blockquote>\n<p>Just chiming in late here, but I agree with Dan that these are amongst the least helpful common messages from Lean! </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">rewrite'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span>\n</code></pre></div>\n<p>when the pattern is obviously there is just <em>frustrating</em>.</p>\n</blockquote>\n<p>Of course it’s super frustrating, I don’t think anyone denied that! And it stays frustrating after many years of seeing that message. It’s improving (the failed instance synthesis message is already great progress) and I’m very optimistic we will soon see the end of those messages.</p>",
        "id": 500973901,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740087538
    },
    {
        "content": "<p>Reading back quickly that thread after seeing Kim’s message mentioning “pushbacks”, I’m sorry that it may sound like that. I think one issue is that knowing that Dan has a strong programming background probably led us too quickly into super technical discussion territory without spending much time on the “yes that error message is frustrating” part.</p>",
        "id": 500974396,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740087750
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> There's a suggestion here: <a class=\"message-link\" href=\"/#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500790525\">#lean4 dev &gt; Misleading error message on type mismatch @ 💬</a>  (and a couple messages up). I'm interested in seeing how you'd incorporate your suggestion in a concrete example.</p>",
        "id": 500974875,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740087964
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500971313\">said</a>:</p>\n<blockquote>\n<p>Just chiming in late here, but I agree with Dan that these are amongst the least helpful common messages from Lean! </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">rewrite'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">b</span>\n</code></pre></div>\n<p>when the pattern is obviously there is just <em>frustrating</em>.</p>\n</blockquote>\n<p>I hope it didn't seem like I was pushing back on this being a problem! In <a class=\"message-link\" href=\"/#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500786658\">#lean4 dev &gt; Misleading error message on type mismatch @ 💬</a> (maybe there's a better message, it's a long thread, and I was slightly confused in this one because there are lots of errors under consideration) I was calling this a bug. It's not too bad to fix. There are two solutions: (1) record the first match that results in an instance failure and using that match in the error message, or (2) trying to rewrite again <em>without</em> doing instance synthesis while matching, and then doing instance synthesis afterwards once a match is committed to, which generates the error.</p>\n<p><strong>Edit:</strong> Oh, I really misunderstood the issue here. I wasn't thinking about how the failure is that the implicit arguments aren't of the right form (I imagined there were instances that needed solving after the match). My first thought is to retry matching with all the implicits cleared, but I'll have to think about this...</p>",
        "id": 500975470,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740088207
    },
    {
        "content": "<p>I like the suggestion above, actually.  One thing that I also like about the suggestion is that it no longer uses <code>instance</code> to mean something that is not the \"command\" <code>instance</code>.</p>",
        "id": 500975634,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740088289
    },
    {
        "content": "<p>Is it possible to also, for a rw failure of this sort, to track the syntax of the attempted rewrite and the syntax of the location to be rewritten, and notice when they pp the same? And in that case, do a ^^ style indicator with a pp.all to highlight the difference?</p>",
        "id": 500989600,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1740094050
    },
    {
        "content": "<p>I've got a first approximation of a more helpful error on match failure (<a href=\"https://github.com/leanprover/lean4/pull/7172\">lean4#7172</a>).</p>\n<p>The way it works is that if there is no match, it tries to diagnose if the failure is because there are instance arguments that are failing to unify. To do this, it takes the pattern, it replaces all the instance arguments it can with metavariables without making the pattern type incorrect, and then looks for a match again. If there is a match, then it uses the match to produce a \"has type expecting type\" style error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mul_sub'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NonUnitalNonAssocRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_sub'</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  tactic 'rewrite' failed, did not find an exact match for the pattern</span>\n<span class=\"cm\">  in the target expression</span>\n\n<span class=\"cm\">  Found approximate match</span>\n<span class=\"cm\">    c * @HSub.hSub Nat Nat Nat (@instHSub Nat instSubNat) a b</span>\n<span class=\"cm\">  but expecting pattern</span>\n<span class=\"cm\">    c * @HSub.hSub Nat Nat Nat (@instHSub Nat SubNegMonoid.toSub) a b</span>\n<span class=\"cm\">  -/</span>\n</code></pre></div>",
        "id": 501144591,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740156147
    },
    {
        "content": "<p>It's not great to look at, but there are still some improvements that can be made here. For example, given the match, it can try synthesizing the instance arguments for the rw lemma. That can diagnose that the problem is that it doesn't apply because there's no <code>NonUnitalNonAssocRing Nat</code> instance, and report that rather than showing a confusing-looking diff with <code>@</code>'s.</p>\n<p>Imagine something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">rewrite'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span>\n<span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"n\">approximate</span><span class=\"w\"> </span><span class=\"k\">match</span>\n<span class=\"w\">  </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">implicit</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pattern</span>\n<span class=\"w\">  </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">following</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">synthesized</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">NonUnitalNonAssocRing</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>",
        "id": 501144907,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740156251
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500970885\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"418569\">Dan Abramov</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Misleading.20error.20message.20on.20type.20mismatch/near/500867716\">said</a>:</p>\n<blockquote>\n<p>Another nit I want to raise is that the <code>Additional diagnostic information may be available using the set_option diagnostics true command.</code> addendum is distracting and should IMO be at least separated by an extra newline from the actual error. It's not helpful here and makes scanning the error message more difficult.</p>\n<p><a href=\"/user_uploads/3121/ViHwYYP_JpmOyUX_mbTnrpb5/Screenshot-2025-02-20-at-12.37.37.png\">Screenshot 2025-02-20 at 12.37.37.png</a></p>\n</blockquote>\n<p>This one at least is easy to implement: <a href=\"https://github.com/leanprover/lean4/pull/7169\">lean#7169</a>. I've asked Kyle and <span class=\"user-mention silent\" data-user-id=\"478376\">Joseph Rotella</span> to review; I let them merge if they're happy.</p>\n</blockquote>\n<p>I agree with the newline, but I would argue that the message about <code>set_option diagnostics true</code> is not useful at all. I almost never use this command. If I want to investigate a type class synthesis failure, I use <code>set_option trace.Meta.synthInstance true</code> (possibly combined with <code>trace.Meta.isDefEq</code> or <code>trace.profiler</code>). So if anything, I think the error should mention <code>trace.Meta.synthInstance</code>. (though in this example that isn't too useful either)</p>",
        "id": 501387029,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1740326309
    }
]