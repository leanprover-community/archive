[
    {
        "content": "<p>I am currently debugging some kernel busyloop in lean and am very lost.</p>",
        "id": 479977333,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420345
    },
    {
        "content": "<p>At a high-level, I want to proof these two statements equal:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Com</span><span class=\"w\"> </span><span class=\"n\">InstCombine</span><span class=\"bp\">.</span><span class=\"n\">LLVM</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">InstCombine</span><span class=\"bp\">.</span><span class=\"n\">Ty</span><span class=\"bp\">.</span><span class=\"n\">bitvec</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">aaaaa</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Com</span><span class=\"w\"> </span><span class=\"n\">InstCombine</span><span class=\"bp\">.</span><span class=\"n\">LLVM</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">InstCombine</span><span class=\"bp\">.</span><span class=\"n\">Ty</span><span class=\"bp\">.</span><span class=\"n\">bitvec</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ctxt</span><span class=\"bp\">.</span><span class=\"n\">snoc</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n</code></pre></div>",
        "id": 479977354,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420373
    },
    {
        "content": "<p>In this repo: <a href=\"https://github.com/opencompl/lean-mlir/tree/lean-deadlock\">https://github.com/opencompl/lean-mlir/tree/lean-deadlock</a></p>",
        "id": 479977361,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420384
    },
    {
        "content": "<p>I tried the last two days reducing the test case, but was unsuccessful.</p>",
        "id": 479977379,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420402
    },
    {
        "content": "<p>I call a couple of tactics to simplify the <code>aaaaa</code> rhs of my <code>lhs = aaaaa</code> identity.</p>",
        "id": 479977447,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420439
    },
    {
        "content": "<p>The tactics succeed, but lean hangs in the kernel.</p>",
        "id": 479977457,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420450
    },
    {
        "content": "<p><code>set_option debug.skipKernelTC true</code> stops lean hanging.</p>",
        "id": 479977498,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420488
    },
    {
        "content": "<p>And replacing the <code>-1</code> (which seems to be translated to a large unsigned value) to 0, 1, or any small positive number also accelerates things.</p>",
        "id": 479977554,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420523
    },
    {
        "content": "<p>At 60000 the lean kernel kernel becomes slow again and starts hanging.</p>",
        "id": 479977566,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420539
    },
    {
        "content": "<p>The entire <code>hanging</code> is very fragile.</p>",
        "id": 479977576,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420554
    },
    {
        "content": "<p>I found a different sequence of tactics (replacing <code>simp</code> with <code>rw</code>) that leads to the exact same output with <code>set_option pp.all true</code> enabled.</p>",
        "id": 479977605,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420585
    },
    {
        "content": "<p>Still, when this state is generated with <code>rw</code> lean's kernel check is fast, but when using <code>simp</code> lean hangs.</p>",
        "id": 479977624,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420609
    },
    {
        "content": "<p>I am a bit out of my depth with respect to how to debug this.</p>",
        "id": 479977765,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730420720
    },
    {
        "content": "<p>With `set_options diagnostics true' I get:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">150035</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">44</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"bp\">▼</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">150035</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">casesOn</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">90048</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"bp\">.</span><span class=\"n\">match_1</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">30004</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">beq</span><span class=\"bp\">.</span><span class=\"n\">match_1</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">30001</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">InstCombine</span><span class=\"bp\">.</span><span class=\"n\">Ty</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">411</span>\n</code></pre></div>",
        "id": 479979464,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730422472
    },
    {
        "content": "<p>The number of Nat.rec increases as I increase the integer value in my input. So it seems there is too much unfolded here.</p>",
        "id": 479979501,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730422511
    },
    {
        "content": "<p>I tried <a href=\"https://github.com/leanprover/lean4/issues/5724\">https://github.com/leanprover/lean4/issues/5724</a> and it seems one of my reduced test cases is solved by it.</p>",
        "id": 479986004,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730428009
    },
    {
        "content": "<p>I am currently looking back to debugging why the full test case. I see similar hanging there.</p>",
        "id": 479986051,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1730428063
    }
]