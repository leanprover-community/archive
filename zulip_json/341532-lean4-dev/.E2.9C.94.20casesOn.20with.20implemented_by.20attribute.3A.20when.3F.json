[
    {
        "content": "<p>The function ToLCNF.toLCNF, on master as of today with <a href=\"https://github.com/leanprover/lean4/commit/d981fa0fafe06ea602808eea0d4ac4afd9e4517a\">d981fa0\n</a> by <span class=\"user-mention\" data-user-id=\"656225\">@Cameron Zwarich</span>, has a special case for when a casesOn declaration has the attribute @[implemented_by]. When would the elaborator produce this case?</p>",
        "id": 513027423,
        "sender_full_name": "Simon Dima",
        "timestamp": 1744980459
    },
    {
        "content": "<p>This is produced by the <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Elab/ComputedFields.lean\"><code>computed_field</code> construct</a>. The current implementation here uses <code>implemented_by</code> and unsafe casts, which is probably not the most optimal solution.</p>\n<p>In the new compiler, <code>casesOn</code> is converted to a primitive <code>cases</code> construct very early on, as opposed to the old compiler where <code>casesOn</code> was kept throughout the optimizer. It is somewhat tricky to implement <code>implemented_by</code> for <code>casesOn</code> when this transformation has already been performed, so my solution is to just leave the <code>casesOn</code> in these situations and use the generic implementation of <code>implemented_by</code>. This works  but it results in some missed optimizations, so it will probably have to be revisited (or we just add <code>casesOn</code>-specific optimizations to the optimizer).</p>",
        "id": 513043097,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1744986854
    },
    {
        "content": "<p>Thanks, I didn't know about computed fields! (They don't seem to be documented anywhere apart from the source code you linked, is that right?)<br>\nAfter some playing around on the <code>new_codegen</code> branch with <code>compiler.enableNew true</code> and <code>pp.match true</code>, it seems to me like the implementation of <code>visitCasesImplementedBy</code> doesn't do anything on quite a large class of <code>casesOn</code> applications. Am I missing something?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">opt</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">computed_field</span><span class=\"kd\">]</span>\n<span class=\"w\">  </span><span class=\"n\">dummy</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">unit</span>\n\n<span class=\"sd\">/-- Works here, with alternatives of the form fun ..args =&gt; frobnicate (constructor ..args) directly passed to casesOn. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo_arg_manual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"bp\">.</span><span class=\"n\">casesOn</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"o\">)</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Does not work, because the elaborator generates a definition for match_1 which is basically an eta-expansion of casesOn</span>\n<span class=\"sd\">with the motive and minor premises themselves eta-expanded</span>\n<span class=\"sd\">(plus one extra unit argument for the .none branch, probably because the constructor takes 0 arguments).</span>\n<span class=\"sd\">ToLCNF gets expressions after inlining of auxiliary matcher definitions done by inlineMatchers, so it sees something like</span>\n<span class=\"sd\">`(fun x h_1 h_2 =&gt; opt.casesOn x (fun n =&gt; h_1 n) (h_2 Unit.unit)) (fun n =&gt; id (.some n)) (fun _ =&gt; .none)`,</span>\n<span class=\"sd\">and visitCasesImplementedBy will not be able to recognize the discriminee being reconstructed (though it would after some reduction).</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo_arg_sugary</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">foo_arg_sugary</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">foo_arg_sugary</span><span class=\"bp\">.</span><span class=\"n\">match_1</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Doesn't work because here the reconstructed discriminee is not the argument of an application</span>\n<span class=\"sd\">but rather the applicand (to zero arguments).</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo_manual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"bp\">.</span><span class=\"n\">casesOn</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n<span class=\"c1\">-- Doubly doesn't work.</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo_sugary</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n<span class=\"c1\">-- Doesn't work because visitCasesImplementedBy only checks direct arguments of frobnicate, not subexpressions.</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo_in_arg_manual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"bp\">.</span><span class=\"n\">casesOn</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 513071813,
        "sender_full_name": "Simon Dima",
        "timestamp": 1744998454
    },
    {
        "content": "<p>Yes, it doesn't do anything on most applications. It mainly gets applied in cases like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>where the discriminant is bound in the pattern. The elaborator reconstructs the term instead of reusing <code>e</code>. This would ordinarily be fine, but it causes problems with hash-consing of <code>Expr</code> (which uses a computed field to store its hash value), where a new term is constructed that was never hash-consed. In the old compiler, the \"case of known constructor\" optimizations always optimize this away, but those are prevented by the use of <code>implemented_by</code>.</p>\n<p>The eventual goal is to just fix the elaborator to always reuse the discriminant, but we decided that blocking adoption of the new compiler on that change would be a bad idea. Alternatively, I might just implement the optimization for <code>casesOn</code> in the <code>simp</code> pass and remove this.</p>",
        "id": 513073025,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1744999047
    },
    {
        "content": "<p>I see, thanks. I assume the use case for giving a name <code>a</code> to the entire pattern instead of just using <code>e</code> is when <code>e</code> itself is a complicated expression and not a variable name, does that come up often?</p>\n<p>Does the elaborator guarantee that <code>casesOn</code> will only be given minor premises which start with as many lambda abstractions as the field count of the corresponding constructor?</p>",
        "id": 513077303,
        "sender_full_name": "Simon Dima",
        "timestamp": 1745000172
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"893179\">Simon Dima</span> has marked this topic as resolved.</p>",
        "id": 513077985,
        "sender_full_name": "Notification Bot",
        "timestamp": 1745000486
    },
    {
        "content": "<p>I rewrote the handling of <code>implemented_by</code> for <code>casesOn</code> in <a href=\"https://github.com/leanprover/lean4/pull/8754\">lean4#8754</a>. As I note, it could be improved further, but this is probably sufficient for enabling the new compiler.</p>",
        "id": 524010602,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1749846834
    }
]