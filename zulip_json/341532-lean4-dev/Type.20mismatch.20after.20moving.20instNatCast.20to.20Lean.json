[
    {
        "content": "<p>I am currently flashing out some of the BitVec &lt;-&gt; Fin interfaces in Lean working on this patch: <a href=\"https://github.com/leanprover/lean4/pull/5680/files\">https://github.com/leanprover/lean4/pull/5680/files</a>.</p>",
        "id": 476578130,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728797530
    },
    {
        "content": "<p>Unfortunately, I get the seemingly unrelated error in FloatArray:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">    </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">uget</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>This code worked before , but fails after adding:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instNatCast</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NatCast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">natCast</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">ofNat''</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 476578164,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728797598
    },
    {
        "content": "<p>This error arises in these lines (where I added explicit type annotations to simplify debugging)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GetElem</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getElem</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">LT</span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">instLTNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">uget</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 476578193,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728797635
    },
    {
        "content": "<p>The instance at <a href=\"https://github.com/leanprover/lean4/blob/1d8555fe0bdd02c82664446309b2e167ac89c9e9/src/Init/Data/FloatArray/Basic.lean#L65C1-L67C1\">https://github.com/leanprover/lean4/blob/1d8555fe0bdd02c82664446309b2e167ac89c9e9/src/Init/Data/FloatArray/Basic.lean#L65C1-L67C1</a> should be:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GetElem</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getElem</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">uget</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>The issue is that <code>i.val</code> is actually <code>Fin USize.size</code> instead of <code>Nat</code>, which picks out the wrong coercion.</p>",
        "id": 476602722,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1728822544
    },
    {
        "content": "<p>This seems to work. Thank you, <span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span>.</p>",
        "id": 476602946,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728822755
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"122318\">Tobias Grosser</span> has marked this topic as resolved.</p>",
        "id": 476602949,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728822762
    },
    {
        "content": "<p>Actually, now I am in an entire new mess.</p>",
        "id": 476603154,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728822991
    },
    {
        "content": "<p>It seems this cast lemmas has broken many things in Fin/Lemmas.lean.</p>",
        "id": 476603199,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728823075
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">application type mismatch</span>\n<span class=\"cm\">  Nat.le_of_lt_succ (is_lt i)</span>\n<span class=\"cm\">argument</span>\n<span class=\"cm\">  is_lt i</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  ↑i &lt; n + 1 : Prop</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  ↑i &lt; (↑↑n).succ : Prop</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">is_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">le_of_lt_succ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">is_lt</span>\n</code></pre></div>",
        "id": 476603232,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728823110
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"122318\">Tobias Grosser</span> has marked this topic as unresolved.</p>",
        "id": 476603260,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728823143
    },
    {
        "content": "<p>It's probably not ideal to have casts both ways between <code>Nat</code> and <code>Fin</code>. It's a coin toss which applies in each case.</p>",
        "id": 476603366,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1728823211
    },
    {
        "content": "<p>Right.</p>",
        "id": 476603381,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728823223
    },
    {
        "content": "<p>I took this code from mathlib (<a href=\"https://github.com/leanprover-community/mathlib4/blob/81d66bb893988a10f0e7f3b5baa2f8bc0f35993f/Mathlib/Data/Fin/Basic.lean#L432\">https://github.com/leanprover-community/mathlib4/blob/81d66bb893988a10f0e7f3b5baa2f8bc0f35993f/Mathlib/Data/Fin/Basic.lean#L432</a>), where this setup seems to work.</p>",
        "id": 476603447,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728823300
    },
    {
        "content": "<p>Well not really, Kyle has frequently complained about essentially this issue. You should avoid binary operators between a <code>Nat</code> and a <code>Fin</code> unless you have a <code>↑</code> on one side because it's ambiguous.</p>",
        "id": 476604272,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728824124
    },
    {
        "content": "<p>Interesting.</p>",
        "id": 476605282,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728825028
    },
    {
        "content": "<p>I guess this means moving NatCast to Lean proper is a bad idea.</p>",
        "id": 476605428,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728825154
    },
    {
        "content": "<p>Thank you for the insight.</p>",
        "id": 476605430,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728825158
    },
    {
        "content": "<p>I think NatCast is already in lean proper?</p>",
        "id": 476606236,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728825907
    },
    {
        "content": "<p>it just doesn't have an instance for <code>Fin</code> until it gets one indirectly in mathlib because it's a ring</p>",
        "id": 476606283,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728825956
    },
    {
        "content": "<p>NatCast ist, but the following instance is not:<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/blob/81d66bb893988a10f0e7f3b5baa2f8bc0f35993f/Mathlib/Data/Fin/Basic.lean#L432C1-L433C29\">https://github.com/leanprover-community/mathlib4/blob/81d66bb893988a10f0e7f3b5baa2f8bc0f35993f/Mathlib/Data/Fin/Basic.lean#L432C1-L433C29</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instNatCast</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NatCast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">natCast</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">ofNat''</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 476606285,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728825957
    },
    {
        "content": "<p>(Also, it seems to get this instance directly, AFAIU the code above)</p>",
        "id": 476606373,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728825985
    },
    {
        "content": "<p>ah, that may be true but I think that's just to avoid diamond issues</p>",
        "id": 476606385,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826010
    },
    {
        "content": "<p>Right.</p>",
        "id": 476606389,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826014
    },
    {
        "content": "<p>I am working towards upstreaming: <a href=\"https://github.com/opencompl/lean-mlir/blob/main/SSA/Projects/InstCombine/ForMathlib.lean\">https://github.com/opencompl/lean-mlir/blob/main/SSA/Projects/InstCombine/ForMathlib.lean</a> and am trying to see where each theorem fits best (Lean vs. Mathlib)</p>",
        "id": 476606490,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826106
    },
    {
        "content": "<p>The objective is to define:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">toFin_injective</span><span class=\"bp\">.</span><span class=\"n\">commRing</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">    </span><span class=\"n\">toFin_zero</span><span class=\"w\"> </span><span class=\"n\">toFin_one</span><span class=\"w\"> </span><span class=\"n\">toFin_add</span><span class=\"w\"> </span><span class=\"n\">toFin_mul</span><span class=\"w\"> </span><span class=\"n\">toFin_neg</span><span class=\"w\"> </span><span class=\"n\">toFin_sub</span>\n<span class=\"w\">    </span><span class=\"n\">toFin_nsmul</span><span class=\"w\"> </span><span class=\"n\">toFin_zsmul</span><span class=\"w\"> </span><span class=\"n\">toFin_pow</span><span class=\"w\"> </span><span class=\"n\">toFin_natCast</span><span class=\"w\"> </span><span class=\"n\">toFin_intCast</span>\n</code></pre></div>",
        "id": 476606498,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826117
    },
    {
        "content": "<p>To unbreak <a href=\"https://github.com/leanprover/lean4/pull/5323\">https://github.com/leanprover/lean4/pull/5323</a>.</p>",
        "id": 476606512,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826140
    },
    {
        "content": "<p>well, I see a ring-shaped issue with upstreaming that</p>",
        "id": 476606526,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826158
    },
    {
        "content": "<p>Can you expand on this.</p>",
        "id": 476606550,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826194
    },
    {
        "content": "<p><code>CommRing</code> is largely agreed to be the domain of mathlib</p>",
        "id": 476606607,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826212
    },
    {
        "content": "<p>so if you need that specifically then I don't think it can be upstreamed</p>",
        "id": 476606627,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826242
    },
    {
        "content": "<p>Ah, I want to upstream the CommRing instance into Mathlib.</p>",
        "id": 476606646,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826271
    },
    {
        "content": "<p>oh, well then there are no problems, and also this thread is in the wrong stream?</p>",
        "id": 476606763,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826326
    },
    {
        "content": "<p>Henrik's patch to Lean4 which transitions uint to bitvec breaks the mathlib build, due to a missing CommRing instance for BitVec.</p>",
        "id": 476606782,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826354
    },
    {
        "content": "<p>So this thread covers both Lean4 and Mathlib.</p>",
        "id": 476606798,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826376
    },
    {
        "content": "<p>So I am trying to break apart the changes that must be made to keep things in the right domains.</p>",
        "id": 476606841,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826411
    },
    {
        "content": "<p>AFAIU BitVec lemmas should go into lean, but CommRing into mathlib.</p>",
        "id": 476606853,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826425
    },
    {
        "content": "<p>I'm confused, can you explain the context and situation here?</p>",
        "id": 476606854,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826428
    },
    {
        "content": "<p>Right, some context might be useful. <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 476606913,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826467
    },
    {
        "content": "<p>There is this Lean4 patch currently proposed to Lean: <a href=\"https://github.com/leanprover/lean4/pull/5323\">https://github.com/leanprover/lean4/pull/5323</a></p>",
        "id": 476606922,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826482
    },
    {
        "content": "<p>hm, I'm already mild negative on this, I thought we didn't want to involve BitVecs in math</p>",
        "id": 476606958,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826523
    },
    {
        "content": "<p>I see.</p>",
        "id": 476607038,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826598
    },
    {
        "content": "<p>So you feel uint counts as 'math'?</p>",
        "id": 476607050,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826614
    },
    {
        "content": "<p>yes</p>",
        "id": 476607057,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826626
    },
    {
        "content": "<p>at least, it's going to make it a lot harder to avoid bitvecs in unrelated code going forward</p>",
        "id": 476607075,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826652
    },
    {
        "content": "<p>but anyway, I guess this is an independent discussion. How does this result in needing a CommRing instance on BitVec?</p>",
        "id": 476607182,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826784
    },
    {
        "content": "<p>(which by the way clearly looks like \"involving bitvecs in math\" so my worries are not unfounded)</p>",
        "id": 476607272,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826838
    },
    {
        "content": "<p>The CommRing instance of UInt requires updating: <a href=\"https://github.com/leanprover-community/mathlib4/blob/lean-pr-testing-5323/Mathlib/Data/UInt.lean#L77\">https://github.com/leanprover-community/mathlib4/blob/lean-pr-testing-5323/Mathlib/Data/UInt.lean#L77</a></p>",
        "id": 476607307,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826894
    },
    {
        "content": "<p>Some time ago there was a push to get mathlib to avoid even <em>mentioning</em> the type BitVec, so this is a bit of reversal</p>",
        "id": 476607337,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826923
    },
    {
        "content": "<p>So it seemed natural to me to first define CommRing for BitVec and then using this definition.</p>",
        "id": 476607366,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728826925
    },
    {
        "content": "<p>but that said I think we should have the instance</p>",
        "id": 476607391,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728826974
    },
    {
        "content": "<p>but shouldn't the proof basically look just like those UInt proofs? Transfer an injective function and then all the proofs are rfl</p>",
        "id": 476607420,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728827014
    },
    {
        "content": "<p>also, what is up with this deprecation?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">UInt</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"ss\">`UInt8.eq_of_val_eq</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">deprecated</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`UInt8.eq_of_toBitVec_eq</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">instead</span>\n</code></pre></div>\n<p>The API should let me step over the bitvec step if I want to</p>",
        "id": 476607653,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728827262
    },
    {
        "content": "<p>I guess there are several parts of this conversation. I am mostly interested in defining CommRing (BigVec w).</p>",
        "id": 476607765,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728827330
    },
    {
        "content": "<p>I think the answer to that is to just upstream everything to mathlib</p>",
        "id": 476607856,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728827404
    },
    {
        "content": "<p>To keep the conversation focused (and complexity at a level that is suitable for my mathlib skills), maybe its best if I create a simple PR for the <code>CommRing</code> instance.</p>",
        "id": 476607882,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728827425
    },
    {
        "content": "<p>I will propose a patch for <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Data/BitVec.lean\">https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Data/BitVec.lean</a>.</p>",
        "id": 476607923,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728827479
    },
    {
        "content": "<p>Thank you.</p>",
        "id": 476607925,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728827483
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476607420\">said</a>:</p>\n<blockquote>\n<p>but shouldn't the proof basically look just like those UInt proofs? Transfer an injective function and then all the proofs are rfl</p>\n</blockquote>\n<p>There is a single proof that is not refl as explained in the PR</p>",
        "id": 476608345,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728827901
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476607182\">said</a>:</p>\n<blockquote>\n<p>but anyway, I guess this is an independent discussion. How does this result in needing a CommRing instance on BitVec?</p>\n</blockquote>\n<p>Using the <code>BitVec</code> instance to define the <code>UInt</code> one should be the right way to go because we want to have <code>BitVec</code> in between UInt and Fin now no?</p>",
        "id": 476608397,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728827965
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476607653\">said</a>:</p>\n<blockquote>\n<p>also, what is up with this deprecation?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">UInt</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"ss\">`UInt8.eq_of_val_eq</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">deprecated</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`UInt8.eq_of_toBitVec_eq</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">instead</span>\n</code></pre></div>\n<p>The API should let me step over the bitvec step if I want to</p>\n</blockquote>\n<p>You can do that by using the proper lemma in <code>BitVec</code>, I don't think we shoudl expose the transitive closure of our abstraction level shfit lemmas as explicit lemmas</p>",
        "id": 476608483,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728828009
    },
    {
        "content": "<p>OK, the CommRing instance seems to work: <a href=\"https://github.com/leanprover-community/mathlib4/pull/17700\">https://github.com/leanprover-community/mathlib4/pull/17700</a></p>",
        "id": 476608525,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728828047
    },
    {
        "content": "<p>I am currently cleaning this up.</p>",
        "id": 476608547,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728828062
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476608483\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476607653\">said</a>:</p>\n<blockquote>\n<p>also, what is up with this deprecation?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">UInt</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"ss\">`UInt8.eq_of_val_eq</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">deprecated</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`UInt8.eq_of_toBitVec_eq</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">instead</span>\n</code></pre></div>\n<p>The API should let me step over the bitvec step if I want to</p>\n</blockquote>\n<p>You can do that by using the proper lemma in <code>BitVec</code>, I don't think we shoudl expose the transitive closure of our abstraction level shfit lemmas as explicit lemmas</p>\n</blockquote>\n<p>We should if that's the API people were using before</p>",
        "id": 476609049,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828482
    },
    {
        "content": "<p>just because core wants to define things this way doesn't mean downstream users want to deal with this too</p>",
        "id": 476609084,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828512
    },
    {
        "content": "<p>There are now 3 steps from UInt8 to Nat, I don't want to have to apply 3 lemmas instead of 1</p>",
        "id": 476609126,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828572
    },
    {
        "content": "<p>Well there should just, not be a need to do this in almost all situations after the API is finished.</p>",
        "id": 476609249,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728828682
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476608345\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476607420\">said</a>:</p>\n<blockquote>\n<p>but shouldn't the proof basically look just like those UInt proofs? Transfer an injective function and then all the proofs are rfl</p>\n</blockquote>\n<p>There is a single proof that is not refl as explained in the PR</p>\n</blockquote>\n<p>Not explained as far as I can tell, but mentioned once. What's the issue exactly?</p>",
        "id": 476609351,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828765
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5323#issuecomment-2407062190\">https://github.com/leanprover/lean4/pull/5323#issuecomment-2407062190</a></p>\n<blockquote>\n<p>I addressed all comments and everything in batteries and mathlib apart from a singular sorry here: <a href=\"https://github.com/leanprover-community/mathlib4/blob/lean-pr-testing-5323/Mathlib/Data/UInt.lean#L77\">https://github.com/leanprover-community/mathlib4/blob/lean-pr-testing-5323/Mathlib/Data/UInt.lean#L77</a> is fixed. This was previously rfl but is now not rfl anymore. It also appears there is very little API around this thing so I don't quite see how to do a nice proof here without definition bashing.</p>\n</blockquote>",
        "id": 476609367,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728828795
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476609249\">said</a>:</p>\n<blockquote>\n<p>Well there should just, not be a need to do this in almost all situations after the API is finished.</p>\n</blockquote>\n<p>There should not be a need to relate unsigned integers to natural numbers?</p>",
        "id": 476609369,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828795
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> yes I see that, that's what I call a mention</p>",
        "id": 476609393,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828817
    },
    {
        "content": "<p>it's just restating what you said</p>",
        "id": 476609403,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828825
    },
    {
        "content": "<p>what is not refl and why?</p>",
        "id": 476609408,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828834
    },
    {
        "content": "<p>The proof that is linked?</p>",
        "id": 476609452,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728828845
    },
    {
        "content": "<p>I see a sorry, do you want me to compile it to find out the goal?</p>",
        "id": 476609481,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828875
    },
    {
        "content": "<p>it also doesn't answer the why</p>",
        "id": 476609549,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828946
    },
    {
        "content": "<p>which change broke it?</p>",
        "id": 476609562,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728828956
    },
    {
        "content": "<p>Having the redefinition of UInt in terms of BitVec and then fixing the file you are looking at in a way that Kim deemed reasonable broke it.</p>",
        "id": 476609625,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728828997
    },
    {
        "content": "<p>this is completely not answering the question</p>",
        "id": 476609653,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728829025
    },
    {
        "content": "<p>you are saying all of the things I knew before looking at the PR</p>",
        "id": 476609658,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728829037
    },
    {
        "content": "<p>what specifically did you change and why is it causing this breakage</p>",
        "id": 476609668,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728829060
    },
    {
        "content": "<p>I guess I can compile it and see what's going on. Might be a learning experience for me as well.</p>",
        "id": 476609681,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728829082
    },
    {
        "content": "<p>The proof state is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">x</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"n\">x</span><span class=\"bp\">✝</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">x</span><span class=\"bp\">✝</span>\n</code></pre></div>\n<p>where the lhs casts Int to UInt8 and the rhs casts int to Fin. I presume that the fact that <code>.val</code> is now not the only projection of the structure anymore broke the <code>rfl</code> thing, I do not know why it broke precisely.</p>",
        "id": 476609794,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728829200
    },
    {
        "content": "<p>I can reproduce this proof state in my build:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">x</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"n\">x</span><span class=\"bp\">✝</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">x</span><span class=\"bp\">✝</span>\n</code></pre></div>",
        "id": 476610746,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728829949
    },
    {
        "content": "<p>Francois advised me to use <code>.toNat</code> instead of <code>.val</code> at some point.</p>",
        "id": 476610945,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728830162
    },
    {
        "content": "<p>Maybe the same ambiguity is biting us here.</p>",
        "id": 476611037,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728830234
    },
    {
        "content": "<p>I don't think ambiguity can explain a non-refl proof, this is a change of definitions</p>",
        "id": 476611062,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830261
    },
    {
        "content": "<p>How do I track this down?</p>",
        "id": 476611174,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728830336
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/commit/0aa61183b0ba32a07b90fc6fb5fea72f876fde17\">https://github.com/leanprover-community/mathlib4/commit/0aa61183b0ba32a07b90fc6fb5fea72f876fde17</a> seems harmless.</p>",
        "id": 476611305,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728830462
    },
    {
        "content": "<p>So if we work out the definitions:</p>\n<ul>\n<li><code>↑(x : Int) : UInt8</code> is defined as <code>mk (↑(x : Int) : BitVec 8)</code> (note that it's BitVec and not Fin now) </li>\n<li>which resolves via the <code>IntCast (BitVec 8)</code> instance, which comes from... nowhere?</li>\n</ul>",
        "id": 476611319,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830475
    },
    {
        "content": "<p>master has a <code>CommSemiring</code> instance but not a <code>CommRing</code> instance for BitVec</p>",
        "id": 476611331,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830497
    },
    {
        "content": "<p>so I'm not sure who is providing this intcast instance</p>",
        "id": 476611345,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830508
    },
    {
        "content": "<p>basically the problem in 0aa6118 is that line 70 (which was not touched) uses the <code>mk</code> function which has silently changed type</p>",
        "id": 476611456,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830616
    },
    {
        "content": "<p>Right.</p>",
        "id": 476611461,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728830626
    },
    {
        "content": "<p>But should this line not break, if there is no IntCast instance for UInt via BitVec?</p>",
        "id": 476611522,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728830649
    },
    {
        "content": "<p>but I'm not sure how this typechecks in the first place</p>",
        "id": 476611524,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830653
    },
    {
        "content": "<p>that line should be a type error if there is no IntCast instance for BitVec</p>",
        "id": 476611540,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830676
    },
    {
        "content": "<p>so such an instance must exist somehow</p>",
        "id": 476611554,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830693
    },
    {
        "content": "<p>Yeah it sits in core</p>",
        "id": 476611579,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728830719
    },
    {
        "content": "<p>and its definition is apparently not defeq to the original definition which used mod on Fin n</p>",
        "id": 476611580,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830722
    },
    {
        "content": "<p><a href=\"https://loogle.lean-lang.org/?q=IntCast+%28BitVec+%3Fw%29\">https://loogle.lean-lang.org/?q=IntCast+%28BitVec+%3Fw%29</a></p>",
        "id": 476611588,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728830741
    },
    {
        "content": "<p>Interesting.</p>",
        "id": 476611849,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728830947
    },
    {
        "content": "<p>Thank you for understanding this.</p>",
        "id": 476611862,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728830961
    },
    {
        "content": "<p>So what is the <code>IntCast (Fin n)</code> definition defeq to?</p>",
        "id": 476611879,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728830987
    },
    {
        "content": "<p>that is the RHS of the goal</p>",
        "id": 476611937,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831015
    },
    {
        "content": "<p>it seems like the LHS should be defeq to <code>x % Int.ofNat 256</code> which looks okay</p>",
        "id": 476611988,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831091
    },
    {
        "content": "<p>I am afraid I don't fully follow.</p>",
        "id": 476612101,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831198
    },
    {
        "content": "<p>How did you derive this?</p>",
        "id": 476612106,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831205
    },
    {
        "content": "<p>Because of structure eta, we only really care about the nat part of the expression, the rest is just proofs. So all the <code>mk</code> wrappers do nothing, and <code>val</code> just cancels those wrappers out anyway. The only part that matters is the nat part of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BitVec.ofInt#src\">src#BitVec.ofInt</a> , which is <code>(i % (Int.ofNat (2^n))).toNat</code></p>",
        "id": 476612263,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831354
    },
    {
        "content": "<p>actually I guess the <code>.toNat</code> part could also be troublesome</p>",
        "id": 476612311,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831371
    },
    {
        "content": "<p>there was something in the PR description about removing some variant of mod, maybe this is the issue?</p>",
        "id": 476612330,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831391
    },
    {
        "content": "<p>I feel the mod issue is unrelated.</p>",
        "id": 476612377,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831435
    },
    {
        "content": "<p>That variant of mod was removing <code>UIntx</code> mod <code>Nat</code> in favor of just having <code>UintX</code> mod <code>UIntX</code></p>",
        "id": 476612385,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728831446
    },
    {
        "content": "<p>The definition of BitVec.ofInt is historically grown.</p>",
        "id": 476612387,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831449
    },
    {
        "content": "<p>Where do I find the intCast instance of Fin, which was used before?</p>",
        "id": 476612436,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831483
    },
    {
        "content": "<p>Loogle does not help: <a href=\"https://loogle.lean-lang.org/?q=IntCast+%28Fin+%3Fw%29\">https://loogle.lean-lang.org/?q=IntCast+%28Fin+%3Fw%29</a></p>",
        "id": 476612468,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831506
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476612385\">said</a>:</p>\n<blockquote>\n<p>That variant of mod was removing <code>UIntx</code> mod <code>Nat</code> in favor of just having <code>UintX</code> mod <code>UIntX</code></p>\n</blockquote>\n<p>That's not a valid replacement?</p>",
        "id": 476612483,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831533
    },
    {
        "content": "<p>if you mod by something larger than 256 it's not equivalent to reducing the denominator first</p>",
        "id": 476612505,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831569
    },
    {
        "content": "<p>but I don't think it's implicated here, at least I haven't found any calls to <code>modn</code> appearing in these functions</p>",
        "id": 476612587,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831619
    },
    {
        "content": "<p>what does <code>#synth IntCast (Fin 256)</code> give you <span class=\"user-mention\" data-user-id=\"122318\">@Tobias Grosser</span> ?</p>",
        "id": 476612621,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831649
    },
    {
        "content": "<p>Ring.toIntCast</p>",
        "id": 476612665,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831693
    },
    {
        "content": "<p><code>modn</code> was only used to define left and right shift such that it doesn't cause UB in core and that def can be easily done with just UInt</p>",
        "id": 476612686,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728831711
    },
    {
        "content": "<p>you should be able to hover the expression until you find something that's actually about Fin</p>",
        "id": 476612696,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831720
    },
    {
        "content": "<p>I don't think it's about UB, the function has different semantics</p>",
        "id": 476612811,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831788
    },
    {
        "content": "<p>It is about UB in core</p>",
        "id": 476612829,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728831809
    },
    {
        "content": "<p>I agree that in the case of modding by a constant like <code>8</code> it makes no difference</p>",
        "id": 476612844,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831824
    },
    {
        "content": "<p>Shifting to the left on a UIntX by more than X is UB. So the shifter is changed. This was previously modn and is now just mod</p>",
        "id": 476612858,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728831840
    },
    {
        "content": "<blockquote>\n<p>@Ring.toIntCast (Fin 256) CommRing.toRing : IntCast (Fin 256)</p>\n</blockquote>",
        "id": 476612910,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831860
    },
    {
        "content": "<p>that's C semantics, not lean</p>",
        "id": 476612912,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831862
    },
    {
        "content": "<blockquote>\n<p>@CommRing.toRing (Fin 256) (Fin.instCommRing 256)</p>\n</blockquote>",
        "id": 476612939,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728831886
    },
    {
        "content": "<p>in lean shifting to the left should just result in multiplication by 2^n and then modding by the byte size</p>",
        "id": 476612951,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728831899
    },
    {
        "content": "<p>Yes, but the Lean function has to reflect what we implemented in the C runtime. And this is what is implemented in the C rutnime.</p>",
        "id": 476612972,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728831929
    },
    {
        "content": "<p>I've been over this discussion already internally and it was decided to keep it the way it is at least for now.</p>",
        "id": 476612987,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728831944
    },
    {
        "content": "<p>suggesting that users replace uses of <code>modn</code> with <code>mod</code> is dangerous because it's not semantics preserving</p>",
        "id": 476613081,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728832004
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476613081\">said</a>:</p>\n<blockquote>\n<p>suggesting that users replace uses of <code>modn</code> with <code>mod</code> is dangerous because it's not semantics preserving</p>\n</blockquote>\n<p>Interesting observation.</p>",
        "id": 476613101,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728832023
    },
    {
        "content": "<p>if you want to remove native support for <code>modn</code> it can still be simulated with a branch on the value</p>",
        "id": 476613104,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728832024
    },
    {
        "content": "<p><code>if h : b &lt; UIntN.size then a % &lt;&lt;b, h&gt;&gt; else a</code></p>",
        "id": 476613209,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728832115
    },
    {
        "content": "<p>You can discuss that one out with reviewers on the PR if you like.</p>",
        "id": 476613358,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728832285
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"122318\">Tobias Grosser</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476612939\">said</a>:</p>\n<blockquote>\n<p>@CommRing.toRing (Fin 256) (Fin.instCommRing 256)</p>\n</blockquote>\n<p>I don't see anything in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.instCommRing#src\">src#Fin.instCommRing</a> which would give the value of <code>intCast</code>, so it's probably getting the default implementation, which is not a mod expression</p>",
        "id": 476613433,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728832331
    },
    {
        "content": "<p>Where do I find the default implementation?</p>",
        "id": 476613447,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728832358
    },
    {
        "content": "<p>Besides, it's not like modn is deleted, it's just that there is this signular change of not havign <code>modn</code> coming up in shfits anymore and generally preferring <code>mod</code> over <code>modn</code> in API lemmas when applicable.</p>",
        "id": 476613451,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728832361
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Default value for `IntCast.intCast` in an `AddGroupWithOne`. -/</span>\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">castDef</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NatCast</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Neg</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">negSucc</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 476613591,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728832467
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476613451\">said</a>:</p>\n<blockquote>\n<p>Besides, it's not like modn is deleted, it's just that there is this signular change of not havign <code>modn</code> coming up in shfits anymore and generally preferring <code>mod</code> over <code>modn</code> in API lemmas when applicable.</p>\n</blockquote>\n<p>In this case, <code>modn</code> should either not be deprecated or should have a deprecation which does not just point at <code>UintN.mod</code> but uses text to explain what the options are</p>",
        "id": 476613673,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728832541
    },
    {
        "content": "<p>Replacing <code>modn</code> with <code>mod</code> in shifts is perfectly fine, the part I find questionable is the removal of the functions (which may have been in use downstream)</p>",
        "id": 476613758,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728832605
    },
    {
        "content": "<p>and I have confirmed that <code>Fin.instCommRing</code> uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Int.castDef#src\">src#Int.castDef</a></p>",
        "id": 476613800,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728832659
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476613358\">said</a>:</p>\n<blockquote>\n<p>You can discuss that one out with reviewers on the PR if you like.</p>\n</blockquote>\n<p>^</p>",
        "id": 476613806,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728832666
    },
    {
        "content": "<p>There is two people on the PR that think this change is fine, you don't think it's fine, I don't care what happens as long as it gets merged.</p>",
        "id": 476613875,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728832688
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Type.20mismatch.20after.20moving.20instNatCast.20to.20Lean/near/476613800\">said</a>:</p>\n<blockquote>\n<p>and I have confirmed that <code>Fin.instCommRing</code> uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Int.castDef#src\">src#Int.castDef</a></p>\n</blockquote>\n<p>Right.</p>",
        "id": 476614040,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728832835
    },
    {
        "content": "<p>I guess now we now why the casts have changed semantics.</p>",
        "id": 476614066,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728832863
    },
    {
        "content": "<p>I feel the new definition is a bit more correct than the old one.</p>",
        "id": 476614090,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728832892
    },
    {
        "content": "<p>Meaning, it implements two's complement conversion or sth similar.</p>",
        "id": 476614106,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728832911
    },
    {
        "content": "<p>I guess it is obvious to you why the refl proof breaks and how to fix it?</p>",
        "id": 476614155,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728832933
    },
    {
        "content": "<p>The implementation of <code>intCast</code> for <code>Fin</code> should also use mod</p>",
        "id": 476614191,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728832985
    },
    {
        "content": "<p>I think you just need to add a line to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.instCommRing#src\">src#Fin.instCommRing</a> for this</p>",
        "id": 476614283,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728833054
    },
    {
        "content": "<p>although maybe it is better to separately define <code>IntCast (Fin n)</code> and then add it to the structure before the <code>where</code></p>",
        "id": 476614300,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728833098
    },
    {
        "content": "<p>And I guess I would define Fin.ofInt as well?</p>",
        "id": 476614340,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728833147
    },
    {
        "content": "<p>surely this already exists?</p>",
        "id": 476614350,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728833160
    },
    {
        "content": "<p><a href=\"https://loogle.lean-lang.org/?q=Fin.ofInt\">https://loogle.lean-lang.org/?q=Fin.ofInt</a></p>",
        "id": 476614407,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728833182
    },
    {
        "content": "<p>unknown identifier 'Fin.ofInt'</p>",
        "id": 476614408,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728833188
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span>  Int -&gt; Fin ?n</p>",
        "id": 476614425,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728833209
    },
    {
        "content": "<p><span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span> nothing found</p>",
        "id": 476614426,
        "sender_full_name": "loogle",
        "timestamp": 1728833210
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BitVec.ofInt#src\">src#BitVec.ofInt</a> seems to be reinventing such a function</p>",
        "id": 476614468,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728833257
    },
    {
        "content": "<p>in fact I think you could just copy and paste that function with <code>n</code> instead of <code>2^n</code></p>",
        "id": 476614546,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728833338
    },
    {
        "content": "<p>Like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ofInt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))),</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">⟩</span>\n</code></pre></div>",
        "id": 476615105,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728833813
    },
    {
        "content": "<p>yes, and then <code>instance intCast : IntCast (Fin n) := \\&lt;Fin.ofInt\\&gt;</code> and <code>instance : CommRing (Fin n) := { ..., Fin.intCast n with ... }</code></p>",
        "id": 476615199,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728833891
    },
    {
        "content": "<p>OK.</p>",
        "id": 476615227,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728833926
    },
    {
        "content": "<p>hopefully you should be able to confirm that adding those lines makes the <code>sorry</code> in question <code>rfl</code> again</p>",
        "id": 476615254,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728833956
    },
    {
        "content": "<p>Although, if the goal is to make this file only go via <code>toBitVec</code> instead of <code>val</code>, then probably the <code>CommRing UIntN</code> proof should be lifting from <code>toBitVec</code> (which would make this proof <code>rfl</code> anyway since now both sides will be using the bitvec <code>ofInt</code> implementation), but you will also need that <code>CommRing (BitVec n)</code> instance in that case</p>",
        "id": 476615396,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728834109
    },
    {
        "content": "<p>That was the original goal of this thread as explained above yes.</p>",
        "id": 476615629,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728834328
    },
    {
        "content": "<p>OK, this gives a clear path forward.</p>",
        "id": 476615766,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728834429
    },
    {
        "content": "<p>Thanks a lot.</p>",
        "id": 476615796,
        "sender_full_name": "Tobias Grosser",
        "timestamp": 1728834479
    },
    {
        "content": "<p>But thanks for figuring out the defeq issue for us <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>",
        "id": 476615858,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728834509
    },
    {
        "content": "<p>Should the definition use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Int.natMod#doc\">docs#Int.natMod</a> ?</p>",
        "id": 477519033,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729196812
    },
    {
        "content": "<p>it's defeq to it either way</p>",
        "id": 477731503,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729283928
    }
]