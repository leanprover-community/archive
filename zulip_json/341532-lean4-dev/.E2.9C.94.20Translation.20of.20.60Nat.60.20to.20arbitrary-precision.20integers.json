[
    {
        "content": "<p>I'm trying to follow where the new compiler does the various parts of converting Lean's logical model of <code>Nat</code> to using GMP in the runtime. My current understanding is that</p>\n<ul>\n<li><code>Nat.add</code>, <code>Nat.mul</code> et al. are declared as <code>@[extern]</code> in <code>Init</code>, and as such use the runtime implementation of <code>lean_nat_add</code>, <code>lean_nat_mul</code> in <code>lean.h</code></li>\n<li>LCNF literals of type <code>Nat</code> carry the value as a <code>Nat</code> and are included in the generated C or LLVM files by <code>emitNumLit</code> which represents small values directly as unboxed integers and creates large numbers by calling a GMP function on a string representing the number</li>\n<li>Applications of <code>Nat.succ</code> in LCNF are converted to calls to <code>Nat.add</code> in <code>ToIR</code> on <a href=\"https://github.com/leanprover/lean4/blob/bc47aa180b0eee21b5350ea367ec891acbe26165/src/Lean/Compiler/IR/ToIR.lean#L253\">line 253</a></li>\n</ul>\n<p>Is that right? It seems like there is no explicit translation of the constructor <code>Nat.zero</code> to a literal <code>0</code> anywhere. Does this rely on <a href=\"https://lean-lang.org/doc/reference/latest///////////////////////////////////////////The-Type-System/Inductive-Types/#inductive-types-standard-representation\">the way constructors without arguments are represented</a>?</p>",
        "id": 522132611,
        "sender_full_name": "Simon Dima",
        "timestamp": 1748959314
    },
    {
        "content": "<p>Yes, that's correct. Given a definition like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n</code></pre></div>\n<p>the old compiler will convert it to a constant in the <code>lcnf</code> pass, and it stays this way until codegen:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">input</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n<span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n<span class=\"o\">[</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">eta_expand</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n<span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n<span class=\"o\">[</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">lcnf</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n<span class=\"mi\">0</span>\n<span class=\"bp\">...</span>\n<span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_1</span>\n</code></pre></div>\n<p>Meanwhile, the new compiler never does anything to the constructor and it stays as a constructor until codegen:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctor_0</span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">]</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">x_1</span>\n</code></pre></div>\n<p>As you point out, the pun of the scalar encoding of nullary constructors works out here, so it didn't seem like there was any reason to change this. The one reason to maybe do something here is that the new compiler's approach to nullary constructors leads to more <code>unbox</code> operations, whereas the old compiler would just treat them as plain scalars (usually <code>u8</code>). These extra operations should all get optimized away by LLVM, but they probably add some small tax to IR size and interpreter performance (and can make diffing IR between the two a bit more tedious).</p>",
        "id": 522235614,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1748994547
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"893179\">Simon Dima</span> has marked this topic as resolved.</p>",
        "id": 522289408,
        "sender_full_name": "Notification Bot",
        "timestamp": 1749023654
    }
]