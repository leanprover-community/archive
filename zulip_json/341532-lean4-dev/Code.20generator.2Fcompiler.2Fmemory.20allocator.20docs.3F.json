[
    {
        "content": "<p>I managed to cause a crash in Lean (filed <a href=\"https://github.com/leanprover/lean4/issues/5612\">here</a>).</p>\n<p>At first, I thought is was simple stack overflow (due to the structure of the code, which is what I was trying to test).  However, to investigate, I built a debug version of Lean and it's not entirely clear to me that it is:</p>\n<p>The final part of the stack looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">EXC_BAD_ACCESS</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">code</span><span class=\"bp\">=</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x16fe03fe8</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010889056c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">allocator</span><span class=\"bp\">::</span><span class=\"n\">heap</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"bp\">::__</span><span class=\"mi\">1</span><span class=\"bp\">::__</span><span class=\"n\">cxx_atomic_load</span><span class=\"o\">[</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"n\">ue170006</span><span class=\"o\">]</span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">allocator</span><span class=\"bp\">::</span><span class=\"n\">heap</span><span class=\"bp\">*&gt;</span><span class=\"o\">(</span><span class=\"bp\">__</span><span class=\"n\">a</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781c000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">order</span><span class=\"bp\">=</span><span class=\"n\">memory_order_seq_cst</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">cxx_atomic_impl</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"mi\">364</span><span class=\"o\">:</span><span class=\"mi\">47</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000108890550</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`std</span><span class=\"bp\">::__</span><span class=\"mi\">1</span><span class=\"bp\">::__</span><span class=\"n\">atomic_base</span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">allocator</span><span class=\"bp\">::</span><span class=\"n\">heap</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">&gt;::</span><span class=\"n\">load</span><span class=\"o\">[</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"n\">ue170006</span><span class=\"o\">](</span><span class=\"n\">this</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781c000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">m</span><span class=\"bp\">=</span><span class=\"n\">memory_order_seq_cst</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">atomic_base</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"mi\">60</span><span class=\"o\">:</span><span class=\"mi\">14</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000108890524</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`std</span><span class=\"bp\">::__</span><span class=\"mi\">1</span><span class=\"bp\">::__</span><span class=\"n\">atomic_base</span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">allocator</span><span class=\"bp\">::</span><span class=\"n\">heap</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">&gt;::</span><span class=\"n\">operator</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">::</span><span class=\"n\">allocator</span><span class=\"bp\">::</span><span class=\"n\">heap</span><span class=\"bp\">*</span><span class=\"o\">[</span><span class=\"n\">abi</span><span class=\"o\">:</span><span class=\"n\">ue170006</span><span class=\"o\">](</span><span class=\"n\">this</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781c000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">atomic_base</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"o\">:</span><span class=\"mi\">53</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010888f1ac</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">allocator</span><span class=\"bp\">::</span><span class=\"n\">page</span><span class=\"bp\">::</span><span class=\"n\">get_heap</span><span class=\"o\">(</span><span class=\"n\">this</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781c000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">84</span><span class=\"o\">:</span><span class=\"mi\">32</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010888f088</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">allocator</span><span class=\"bp\">::</span><span class=\"n\">page</span><span class=\"bp\">::</span><span class=\"n\">push_free_obj</span><span class=\"o\">(</span><span class=\"n\">this</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781c000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781ca98</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">210</span><span class=\"o\">:</span><span class=\"mi\">20</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000108890338</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">dealloc_small_core</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781ca98</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">430</span><span class=\"o\">:</span><span class=\"mi\">12</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">6</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010889036c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean_free_small</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781ca98</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">alloc</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">446</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">7</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010884f648</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean_free_small_object</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781ca98</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"mi\">374</span><span class=\"o\">:</span><span class=\"mi\">5</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">8</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010884f7e4</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean</span><span class=\"bp\">::</span><span class=\"n\">lean_del_core</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781ca98</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">todo</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000016fe041f0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">273</span><span class=\"o\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">9</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010884f6d8</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean_dec_ref_cold</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781ca98</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">329</span><span class=\"o\">:</span><span class=\"mi\">13</span>\n<span class=\"w\">  </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001053d3980</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l___private_Lean_Util_Trace_0__Lean_checkTraceOption</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">188</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">11</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001063d2950</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_isTracingEnabledFor___at_Lean_Meta_processPostponed_loop___spec__1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">80</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">12</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062bda08</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfCore_go___spec__3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1776</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">13</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062ed31c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfImp___spec__3___lambda__4</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">320</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000108872a78</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean_apply_5</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012780f208</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a1</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x00000001278178b8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a2</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x0000000140531c28</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a3</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x0000000127819848</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x0000000140531c68</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a5</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x0000000000000001</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">349</span><span class=\"o\">:</span><span class=\"mi\">24</span>\n</code></pre></div>\n<p>Looking higher up the stack, I see the function</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">9</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000000010884f6d8</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean_dec_ref_cold</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000012781ca98</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">329</span><span class=\"o\">:</span><span class=\"mi\">13</span>\n<span class=\"w\">   </span><span class=\"mi\">326</span><span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"k\">else</span>\n<span class=\"w\">   </span><span class=\"mi\">327</span><span class=\"w\">          </span><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">todo</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"bp\">;</span>\n<span class=\"w\">   </span><span class=\"mi\">328</span><span class=\"w\">          </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"mi\">329</span><span class=\"w\">              </span><span class=\"n\">lean_del_core</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">todo</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p>So this appears to be a part of some garbage-collection process; in this case, specifically, hitting the \"LEAN_SMALL_ALLOCATOR\":</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">   </span><span class=\"mi\">372</span><span class=\"w\">  </span><span class=\"n\">static</span><span class=\"w\"> </span><span class=\"kn\">inline</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"n\">lean_free_small_object</span><span class=\"o\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">   </span><span class=\"mi\">373</span><span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">ifdef</span><span class=\"w\"> </span><span class=\"n\">LEAN_SMALL_ALLOCATOR</span>\n<span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"mi\">374</span><span class=\"w\">      </span><span class=\"n\">lean_free_small</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">   </span><span class=\"mi\">375</span><span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"k\">else</span>\n</code></pre></div>\n<p>Ultimately, the crash happens inside of <code>get_heap</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\">       </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">get_heap</span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">m_header</span><span class=\"bp\">.</span><span class=\"n\">m_heap</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>Is there any documentation anywhere where I could read more about how the memory allocator works/is supposed to work in Lean?</p>\n<p>In addition, is there a \"trace\"-like command I can use which writes eagerly to e.g. stderr?  I don't get traces when Lean crashes.  (Side note, I also noticed that tracing in debug mode is extremely slow and makes it less useful with deeply recursive functions).</p>\n<p>Thanks!</p>",
        "id": 474682577,
        "sender_full_name": "Tom",
        "timestamp": 1727990089
    },
    {
        "content": "<p><code>sandebug</code> reports it's a stack overflow after all.  However, if there's an answer to my questions, I'd still love to know.</p>",
        "id": 474684661,
        "sender_full_name": "Tom",
        "timestamp": 1727991142
    },
    {
        "content": "<p>if you have a stack overflow, the top part of the stack is usually not interesting. Is there a huge middle part containing a repetitive element?</p>",
        "id": 474687320,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992545
    },
    {
        "content": "<p>the top part will be some random code which happened to be the first to cross the threshold while sitting on top of a giant stack of other calls using up most of stack memory</p>",
        "id": 474687437,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992593
    },
    {
        "content": "<p>Yes, it seems to be coming from recursion in whnfCore.</p>\n<p>I realized the top of the stack would be a read herring.  My current hypothesis is that this:</p>\n<p><code>        let f' ‚Üê go f</code></p>\n<p>In WHNF.lean on line 595 is not in a tail position.</p>",
        "id": 474687720,
        "sender_full_name": "Tom",
        "timestamp": 1727992719
    },
    {
        "content": "<p>e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10339</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062eb93c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_withTraceNode___at_Lean_Meta_whnfImp___spec__1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">664</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10340</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062ec330</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfImp___spec__3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1912</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10341</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000106295ce4</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l___private_Lean_Meta_WHNF_0__Lean_Meta_reduceRec___rarg</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1352</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10342</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062bf958</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfCore_go___spec__3___lambda__4</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2636</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10343</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062bda94</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfCore_go___spec__3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1916</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10344</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062bd0b0</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l___private_Lean_Meta_WHNF_0__Lean_Meta_deltaBetaDefinition___at_Lean_Meta_whnfCore_go___spec__2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">784</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10345</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062bf86c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfCore_go___spec__3___lambda__4</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2400</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10346</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062bda94</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfCore_go___spec__3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1916</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10347</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062c026c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfCore_go___spec__3___lambda__5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">856</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10348</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062bda94</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfCore_go___spec__3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1916</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10349</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x00000001062ed31c</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`l_Lean_Meta_whnfEasyCases___at_Lean_Meta_whnfImp___spec__3___lambda__4</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">320</span>\n<span class=\"w\">    </span><span class=\"n\">frame</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">10350</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x0000000108872a78</span><span class=\"w\"> </span><span class=\"n\">libleanshared</span><span class=\"bp\">.</span><span class=\"n\">dylib</span><span class=\"ss\">`lean_apply_5</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x00000001006790c8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a1</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x0000000100685f38</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a2</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000011fb35c28</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a3</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000010067a738</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a4</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x000000011fb35c68</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a5</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x0000000000000001</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"bp\">.</span><span class=\"n\">cpp</span><span class=\"o\">:</span><span class=\"mi\">349</span><span class=\"o\">:</span><span class=\"mi\">24</span>\n</code></pre></div>",
        "id": 474687815,
        "sender_full_name": "Tom",
        "timestamp": 1727992781
    },
    {
        "content": "<p>that's not enough calls to count</p>",
        "id": 474687837,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992800
    },
    {
        "content": "<p>is there on the order of 4000 similar looking calls in the call stack</p>",
        "id": 474687924,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992821
    },
    {
        "content": "<p>If I'm understanding the mangling correctly, it's picking the third alternative of <code>whngCore.go</code>, i.e. the <code>app</code> version.</p>",
        "id": 474687951,
        "sender_full_name": "Tom",
        "timestamp": 1727992832
    },
    {
        "content": "<p>that call is not in tail position, but this is expected, WHNF is just traversing the term and deep terms are bad</p>",
        "id": 474687995,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992859
    },
    {
        "content": "<p>I didn't want to spam the thread with the full <code>bt</code> but it's just a snippet that seems to be recurring, yes.</p>",
        "id": 474688048,
        "sender_full_name": "Tom",
        "timestamp": 1727992893
    },
    {
        "content": "<p>in that case maybe you gave WHNF a deep term</p>",
        "id": 474688108,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992923
    },
    {
        "content": "<p>what is the code which is causing this error?</p>",
        "id": 474688150,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992934
    },
    {
        "content": "<p>Yes, I linked it in the associated issue at the start of the thread.</p>",
        "id": 474688166,
        "sender_full_name": "Tom",
        "timestamp": 1727992947
    },
    {
        "content": "<p>you cranked up the maxRecDepth, this is basically taking the safety off the footgun</p>",
        "id": 474688211,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727992982
    },
    {
        "content": "<p>the maxRecDepth is there for a reason, to avoid you seeing the real stack limit</p>",
        "id": 474688251,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993001
    },
    {
        "content": "<p>the typeclass instance is generating a very deep term in that example</p>",
        "id": 474688308,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993039
    },
    {
        "content": "<p>Right, I understand.  I was trying to reproduce another issue for someone else which required me to do that.  I can close the issue if your take is \"works as expected\".  This crash was just a side-effect.</p>",
        "id": 474688404,
        "sender_full_name": "Tom",
        "timestamp": 1727993080
    },
    {
        "content": "<p>you can probably get the crash to go away if you also increase the C stack limit, but this requires tinkering with OS settings</p>",
        "id": 474688481,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993143
    },
    {
        "content": "<p>Right.  I'll see if I can come up with a different approach.</p>\n<p>Any thoughts about my other questions, specifically:</p>\n<ul>\n<li>Any code gen or allocator docs?</li>\n<li>A \"trace\"-like command I can use which writes eagerly to e.g. stderr?</li>\n</ul>",
        "id": 474688712,
        "sender_full_name": "Tom",
        "timestamp": 1727993263
    },
    {
        "content": "<p>It's a shame that <code>whnfCore</code> is not tail recursive because it's pretty close.  Is this one of the \"frozen\" sections of the code?</p>",
        "id": 474688874,
        "sender_full_name": "Tom",
        "timestamp": 1727993366
    },
    {
        "content": "<p>it's not frozen, but it is \"no user serviceable parts inside\"</p>",
        "id": 474689475,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993732
    },
    {
        "content": "<p>I'll move on then.</p>",
        "id": 474689499,
        "sender_full_name": "Tom",
        "timestamp": 1727993754
    },
    {
        "content": "<p>the answer to whether there are docs for X in lean is usually no unless it's user-facing</p>",
        "id": 474689602,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993795
    },
    {
        "content": "<p>there are a few module docs here and there</p>",
        "id": 474689652,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993813
    },
    {
        "content": "<p>for tracing, there is <code>dbg_trace \"foo\"</code> (which works also on pure functions) and <code>trace[Meta.debug] \"foo\"</code> (which shows up with <code>set_option trace.Meta.debug true</code>)</p>",
        "id": 474689851,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993903
    },
    {
        "content": "<p>I don't see those outputs when Lean crashes though, unless I'm doing something wrong.</p>",
        "id": 474689891,
        "sender_full_name": "Tom",
        "timestamp": 1727993946
    },
    {
        "content": "<p>you can try using <code>panic!</code>, this will go to the output panel</p>",
        "id": 474689932,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993975
    },
    {
        "content": "<p>you usually don't want to write directly to stderr because lean is talking to vscode via LSP protocol and that would mess it up</p>",
        "id": 474689941,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727993983
    },
    {
        "content": "<p>although actually maybe stderr is fine and it's only stdout that's off limits</p>",
        "id": 474690044,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727994035
    },
    {
        "content": "<p>Makes sense on LSP.  I am having to run the the cmdline anyway since the code crashes Lean and hence the server.</p>",
        "id": 474690051,
        "sender_full_name": "Tom",
        "timestamp": 1727994038
    },
    {
        "content": "<p>I think stderr also goes to the output panel</p>",
        "id": 474690057,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727994044
    },
    {
        "content": "<p>if you are ok writing to stdout on a plain lean program you can use <code>println!</code></p>",
        "id": 474690093,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727994069
    },
    {
        "content": "<p>or <code>IO.eprintln</code> for stderr</p>",
        "id": 474690200,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727994124
    },
    {
        "content": "<p>Ok, those two make sense but does the MetaM monad support IO?  Which is where I was trying to do the stderr tracing.</p>",
        "id": 474690263,
        "sender_full_name": "Tom",
        "timestamp": 1727994181
    },
    {
        "content": "<p>it does, most of lean's elaborator monads extend IO</p>",
        "id": 474690629,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727994381
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Code.20generator.2Fcompiler.2Fmemory.20allocator.20docs.3F/near/474688251\">said</a>:</p>\n<blockquote>\n<p>the maxRecDepth is there for a reason, to avoid you seeing the real stack limit</p>\n</blockquote>\n<p>It might not be checked in the recursive loop?</p>",
        "id": 474691085,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727994611
    },
    {
        "content": "<p>Yeah, I see no <del><code>checkSystem</code></del> <code>withIncRecDepth</code> <a href=\"https://github.com/leanprover/lean4/blob/v4.12.0/src/Lean/Meta/WHNF.lean#L596\">in <code>go</code></a></p>",
        "id": 474691253,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727994720
    },
    {
        "content": "<p>That whole file contains only a single <code>withIncRecDepth</code>. <span aria-label=\"fear\" class=\"emoji emoji-1f628\" role=\"img\" title=\"fear\">:fear:</span></p>",
        "id": 474692975,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727995638
    },
    {
        "content": "<p>actually I'm not sure that call can lead to deep recursion? It's calling <code>go</code> on the head of an application, which means that the recursive call can't end up in the app case anymore</p>",
        "id": 474697877,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727998461
    },
    {
        "content": "<p>oh but that call could end up calling <code>go</code> on an arbitrary term, for instance the <code>letE</code> case just instantiates the binder and tail-calls <code>go</code>, so if you had an application whose head is a let that instantiates to an application with a let at the head and so on, you would get a non-tail-recursive stack as deep as the term</p>",
        "id": 474698111,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727998631
    }
]