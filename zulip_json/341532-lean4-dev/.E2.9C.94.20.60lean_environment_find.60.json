[
    {
        "content": "<p>Has this function changed between v4.15.0 and v4.17.0?</p>\n<p>As an example, if I compile this with <code>lean -c /tmp/mystery.c ...</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kd\">@[</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">mystery_env_find</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">envFind</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ConstantInfo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e.find</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>it compiles to</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"n\">LEAN_EXPORT</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mystery_env_find</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">_start</span><span class=\"p\">:</span>\n<span class=\"p\">{</span>\n<span class=\"n\">lean_object</span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"n\">x_3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">l_Lean_Environment_find_x3f</span><span class=\"p\">(</span><span class=\"n\">x_1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"p\">);</span>\n<span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Note how it uses this <code>l_Lean_Environment_find_x3f</code> function instead of <code>lean_environment_find</code>. Why does this happen?</p>\n<p>Moreover, I have some FFI code that previously (in v4.15.0) uses <code>lean_environment_find</code> and they started breaking once I updated to v4.17.0. I had to replace them by <code>l_Lean_Environment_find_x3f</code> to get them to work again.</p>",
        "id": 508982543,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1743303066
    },
    {
        "content": "<p>You should not rely on <code>[export]</code>s from other repos, that should definitely be considered private information. Instead introduce your own export like in your example.</p>",
        "id": 509026768,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743341988
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/.60lean_environment_find.60/near/509026768\">said</a>:</p>\n<blockquote>\n<p>You should not rely on <code>[export]</code>s from other repos, that should definitely be considered private information. Instead introduce your own export like in your example.</p>\n</blockquote>\n<p>even the ones in Lean's prelude should not be used? e.g. <code>@[export lean_expr_mk_mvar] def mkMVarEx : MVarId → Expr := mkMVar</code>. I've been using these functions for more than a year and they seem fine</p>",
        "id": 509055627,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1743361413
    },
    {
        "content": "<p>They might be fine but exported symbols (as well as their type signature) are not part of the public API that the Lean project exposes and should thus not be relied upon.</p>",
        "id": 509059412,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1743364587
    },
    {
        "content": "<p>are only the symbols in <code>lean.h</code> fair game?</p>",
        "id": 509059431,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1743364609
    },
    {
        "content": "<p>I don't think we have a deprecation process or something like that for those but they are certainly much more stable than stuff like <code>@[export]</code> yes.</p>",
        "id": 509059538,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1743364694
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"599027\">Leni Aniva</span> has marked this topic as resolved.</p>",
        "id": 509060647,
        "sender_full_name": "Notification Bot",
        "timestamp": 1743365536
    }
]