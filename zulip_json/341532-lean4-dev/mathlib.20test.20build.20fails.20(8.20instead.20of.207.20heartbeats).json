[
    {
        "content": "<p>Hello, I have <a href=\"https://github.com/leanprover/lean4/pull/6823\">PRed</a> two new <code>builtin</code> constructs for bootstrapping. The changes do not at all seem to be related to mathlib and the new constructs are used nowhere, so I was surprised to see some mathlib test fail:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">6206</span><span class=\"bp\">/</span><span class=\"mi\">6245</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">MathlibTest</span><span class=\"bp\">.</span><span class=\"n\">CountHeartbeats</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=</span><span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">MathlibTest</span><span class=\"bp\">/</span><span class=\"n\">CountHeartbeats</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">17</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">minimum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">2000.</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">MathlibTest</span><span class=\"bp\">/</span><span class=\"n\">CountHeartbeats</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">16</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">❌️</span><span class=\"w\"> </span><span class=\"n\">Docstring</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"bp\">`#</span><span class=\"n\">guard_msgs</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"w\"> </span><span class=\"n\">message</span><span class=\"o\">:</span>\n\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">minimum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">2000.</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>For context, this is the test:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- info: Used 7 heartbeats, which is less than the minimum of 2000. -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">guard_min_heartbeats</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>According to the test, only 7 heartbeats are expected here and, as <span class=\"user-mention\" data-user-id=\"260921\">@Markus Himmel</span> thankfully remembered, this was <a href=\"#narrow/channel/428973-nightly-testing/topic/.2321042.20adaptations.20for.20nightly-2025-01-24\">recently changed</a> from 8 to 7 to fix this test.</p>\n<p>Nevertheless, I can't explain this to myself. My small changes are built directly on top of nightly-2025-01-28 and <a href=\"https://github.com/leanprover/lean4/pull/6842\">if I revert them</a>, the <code>CountHeartbeats</code> test becomes green again, locally as well as in CI.</p>\n<p>Does anybody have an idea what the problem is? Do you consider it plausible that a change such as mine (adding two new files, simply defining new syntax, a builtin elaborator and a builtin attribute, all of them unused as of now) should affect the heartbeats of such a simple lemma?</p>",
        "id": 496521240,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1738148522
    },
    {
        "content": "<p>We should remove these tests. This is just noise, and it is getting in the way of Lean development. We should <em>never</em> have tests that depend on an exact number of heartbeats.</p>\n<p>I think <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> added these tests?</p>",
        "id": 496530874,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738151772
    },
    {
        "content": "<p>Yes, I am responsible for this: there is a PR in progress by <span class=\"user-mention\" data-user-id=\"385895\">@Jon Eugster</span>  to fix bugs in the implementation and I will suggest to make a \"test\" version that does not report the actual numbers.</p>",
        "id": 496541850,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738155367
    },
    {
        "content": "<p>If it is urgent, I can prepare a PR to implement this change earlier (though likely not for several hours).</p>",
        "id": 496541977,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738155409
    },
    {
        "content": "<p>If there is already a fix planned, I could just change the tests back to 8 for now. This would unblock me, although it is possible that the next person that changes something will find themselves in the situation that the heartbeats have changed again. What do you think?</p>",
        "id": 496550570,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1738157984
    },
    {
        "content": "<p>Yes, just change them freely to get unblocked, and it sounds like Damiano / Jon will make sure that the exact numbers disappear from tests later.</p>",
        "id": 496652503,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738188737
    },
    {
        "content": "<p>Ah, I forgot to reply here: I am coordinating with Jon whether to incorporate the changes in his PR or producing a separate one with this change.</p>",
        "id": 496652657,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738188802
    },
    {
        "content": "<p>I will probably produce an option to report a \"round down to the nearest multiple of <del>100</del>1000\" for the heartbeats, so that the tests will be more robust, but might still make sure that the command is working as expected.</p>",
        "id": 496652806,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738188859
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/mathlib.20test.20build.20fails.20.288.20instead.20of.207.20heartbeats.29/near/496530874\">said</a>:</p>\n<blockquote>\n<p>We should <em>never</em> have tests that depend on an exact number of heartbeats.</p>\n</blockquote>\n<p>I'm on the fence on this; tests which record arbitrary limits are useful as canaries for detecting when the limit changes; but they should come with a comment saying that you should always just change the number to make it pass again.</p>",
        "id": 496655436,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738189971
    },
    {
        "content": "<p>I share your feeling Eric, but maybe it makes sense to have the test file for the linter not include the numbers and having a separate mechanism that tracks changes to heartbeats in a less intrusive way?</p>",
        "id": 496656013,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738190239
    },
    {
        "content": "<p>I'm happy with rounding to the nearest 1000.</p>",
        "id": 496656760,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738190585
    },
    {
        "content": "<p>Thanks for helping me out, everyone!</p>",
        "id": 496711776,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1738223513
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21251\">#21251</a> adds an <code>Option</code> to report approximate counts and uses it in the tests.</p>",
        "id": 496723831,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738227756
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, this somehow seems to have relapsed on <code>master</code>. Could you investigate? Did someone revert <a href=\"https://github.com/leanprover-community/mathlib4/pull/21251\">#21251</a>?</p>",
        "id": 509066668,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743370547
    },
    {
        "content": "<p>I'll look into this tomorrow: I'm not aware of a change, but have also been out of the loop for almost two weeks.</p>",
        "id": 509068279,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743371886
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21251\">#21251</a> has not been reverted.  The only change after that PR has been <a href=\"https://github.com/leanprover-community/mathlib4/pull/22568\">#22568</a>, fixing a spelling mistake in a module doc.</p>",
        "id": 509122720,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743407088
    },
    {
        "content": "<p>There is one <code>#count_heartbeats in</code> that was still missing the <code>approximately</code> flag and there are two <code>guard_min_heartbeats ... in</code> that are possible also culprits.</p>",
        "id": 509122992,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743407167
    },
    {
        "content": "<p>I am going to add the <code>approximately</code> flag to the <code>#count_heartbeats</code>, but the others do not (yet?) have the <code>approximately</code> mechanism.</p>",
        "id": 509123123,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743407208
    },
    {
        "content": "<p>Could you say which tests are failing?  Everything seems to work for me locally.</p>",
        "id": 509123162,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743407221
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23476\">#23476</a> adds the missing <code>approximately</code>.</p>",
        "id": 509123687,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743407384
    },
    {
        "content": "<p>All exact heartbeat messages regularly break on nightly-testing, they should all be avoided</p>",
        "id": 509131169,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743409441
    },
    {
        "content": "<p>I just updated the PR: now it also adds the <code>approximately</code> flag to <code>guard_min_heartbeats</code> and uses it in the tests.</p>",
        "id": 509142331,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743412421
    },
    {
        "content": "<p>The test file should now only contain heartbeat counts that are rounded down to the nearest 1k.</p>",
        "id": 509142494,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1743412457
    }
]