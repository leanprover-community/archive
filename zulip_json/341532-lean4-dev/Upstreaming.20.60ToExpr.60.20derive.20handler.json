[
    {
        "content": "<p>I'd like to upstream a derive handler for <code>ToExpr</code> into core. I figured I'd get the ball rolling by working on a PR (<a href=\"https://github.com/leanprover/lean4/pull/5906\">lean4#5906</a>) to do just that, but <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> responded:</p>\n<blockquote>\n<p>It's still not clear how this ToExpr deriving handler will appear in core, and it has some issues that will likely need more core fixes (for example, <code>ToLevel</code> should not need to live in a universe above <code>Type</code>, yet it does).</p>\n</blockquote>\n<p>I'd be curious if people have thought on how to address these issues? It's quite painful not having <code>ToExpr</code> handlers available in LNSym.</p>",
        "id": 479956160,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1730407124
    },
    {
        "content": "<p>I've been thinking about addressing this issue, and it's one of the reasons I haven't yet begun upstreaming that ToExpr derive handler myself yet :-)</p>\n<p>The universe issue is tracked in <a href=\"https://github.com/leanprover/lean4/pull/2116\">lean4#2116</a></p>",
        "id": 479956621,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730407365
    },
    {
        "content": "<p>There's also the matter that core hasn't decide it wants this handler. If you could create an issue explaining that you want it and why, that would help me with the process of getting it in.</p>",
        "id": 479957078,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730407589
    },
    {
        "content": "<p>(That should be <a href=\"https://github.com/leanprover/lean4/pull/2116\">lean4#2116</a>, I assume)</p>\n<p>Interestingly, I tried to work around the universe bump issue by referring to the universe in an existential, like so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ToLevel</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- A `Level` that represents the universe level `u`. -/</span>\n<span class=\"w\">  </span><span class=\"n\">toLevel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The universe itself. This is only here to avoid the \"unused universe parameter\" error. -/</span>\n<span class=\"w\">  </span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>Unfortunately, this still complains that <code>u</code> is unused</p>",
        "id": 479957184,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1730407643
    },
    {
        "content": "<p>The issue doesn't have to be too detailed, but the question is \"why core, why not another library, or why can't you embed it into LNSym\"</p>",
        "id": 479957214,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730407658
    },
    {
        "content": "<p>One \"why put it in core\" reason for me is \"it'll support <code>#eval</code> automatically pretty printing results\"</p>",
        "id": 479957322,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730407706
    },
    {
        "content": "<p>There's also the added complexity that if the point is to support a Qq-lite library like you mentioned, should ToExpr be dropped in favor of a richer type that supports that sort of thing better?</p>\n<p>This is where upstreaming the ToExpr deriving handler to Batteries got stuck, because some think it should be a ToQExpr deriving handler instead.</p>",
        "id": 479957593,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730407837
    },
    {
        "content": "<p>Here's a Qq version of ToExpr and a deriving handler by the way: <a href=\"https://github.com/leanprover-community/mathlib4/pull/5952\">mathlib4#5952</a></p>",
        "id": 479958868,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730408515
    },
    {
        "content": "<p>I guess for me the main reason for having the <code>ToExpr</code> derive handler in core is that <code>ToExpr</code> itself lives in core, and is used. That usage <em>today</em> could be nicer by having the derive handler available (even in projects that don't want to depend on Mathlib/Std4/Quote4).</p>\n<p>Having a <code>ToQExpr</code> typeclass and derive handler certainly would be nice, but that's not entirely the same discussion; then we're talking about deprecating <code>ToExpr</code> entirely. I'd be happy with either having the <code>ToExpr</code> derive handler or having <code>ToExprQ</code> and a handler, but currently we have neither (in core)</p>",
        "id": 479961285,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1730409811
    },
    {
        "content": "<p>I created an issue: <a href=\"https://github.com/leanprover/lean4/issues/5909\">https://github.com/leanprover/lean4/issues/5909</a></p>",
        "id": 479964809,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1730411769
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481133\">Alex Keizer</span> <a href=\"#narrow/channel/341532-lean4-dev/topic/Upstreaming.20.60ToExpr.60.20derive.20handler/near/479957184\">said</a>:</p>\n<blockquote>\n<p>(That should be <a href=\"https://github.com/leanprover/lean4/pull/2116\">lean4#2116</a>, I assume)</p>\n<p>Interestingly, I tried to work around the universe bump issue by referring to the universe in an existential, like so:<br>\n...</p>\n</blockquote>\n<p>I was being a bit silly there, the default value of a field is not actually part of the structure's definition so the error is correct (even if it looks a bit funny at first glance).</p>\n<p>The following, <em>does</em> work: <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- A class to create `Level` expressions that denote particular universe levels in Lean.</span>\n<span class=\"sd\">`Lean.ToLevel.toLevel.{u}` evaluates to a `Lean.Level` term representing `u` -/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ToLevel</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- A `Level` that represents the universe level `u`. -/</span>\n<span class=\"w\">  </span><span class=\"n\">toLevel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The universe itself. This is only here to avoid the \"unused universe parameter\" error.</span>\n<span class=\"sd\">    We'll remove this field once https://github.com/leanprover/lean4/issues/2116 gets fixed.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">ToLevel</span><span class=\"w\"> </span><span class=\"c1\">-- Lean.ToLevel.{u} : Type</span>\n</code></pre></div>",
        "id": 479965786,
        "sender_full_name": "Alex Keizer",
        "timestamp": 1730412328
    },
    {
        "content": "<p>I think <a href=\"https://github.com/leanprover/lean4/pull/2116\">lean4#2116</a> has a simpler workaround in the comments via a <code>let</code>?</p>",
        "id": 480382830,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730705654
    }
]