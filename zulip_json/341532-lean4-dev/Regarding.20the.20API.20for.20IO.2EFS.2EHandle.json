[
    {
        "content": "<p>Hello Lean developers. I am feeling lost/dissatisfied over the limited API for file IO in Lean, and wanted to learn more about available tools, ways the API could improve, and general strategies to effectively use Lean's IO.</p>\n<p>Currently, I am trying to improve a research tool that I've written in Lean for SAT proof checking. One of the improvements/features I want to implement is proof streaming. This means that the Lean program will need to read a proof file as it's produced by a SAT solver (through a pipe). As a result, typical IO operations like <code>.readToEnd</code> will not suffice, as proofs can, in the worst case, be gigabytes or terabytes in size.</p>\n<p>Looking over the file IO data structures and APIs in Lean, I discovered <a href=\"https://github.com/leanprover/lean4/blob/21d71de481e3d497a3ceeac85e50b50338b5636d/src/Init/System/IO.lean#L333\"><code>FS.Handle</code></a>, which does most of what I want. However, the available operations on handles are somewhat limited: a program can request a block of bytes with <code>read : USize -&gt; IO ByteArray</code>, or a program can request a line of text with <code>getLine : IO String</code>. Given my use case, these operations raise a few issues/questions:</p>\n<ol>\n<li>To use <code>read</code>, the program is somewhat responsible for \"buffering\" the input, in order to catch cases where tokens span across read calls. It's not too hard to solve this problem by engineering a <code>BufferedHandle</code> on top of <code>Handle</code> and implement C-style <code>getc</code> or (extremely limited) <code>fscanf</code> functionality. <strong>Is this approach reasonable, and/or does an implementation already exist?</strong></li>\n<li>The <code>getLine</code> function returns a Lean <code>String</code>. Lean's strings are UTF-8 encoded. However, the data I'm working with is purely ASCII, so it would be more performant(?) to work with an iterator on a <code>ByteArray</code> instead. Yet I don't know of an easy way to O(1) convert <code>String</code> to <code>ByteArray</code> (<code>unsafeCast</code> doesn't work). <strong>Would adding a <code>getLineBytes</code> function to <code>Handle</code>'s API be a wanted feature, and if so, would I submit a PR for it? Or is there a good way to treat <code>String</code>s as <code>ByteArray</code>s?</strong></li>\n<li>More generally, are there plans to implement C-style <code>printf</code>/<code>scanf</code> functions? Are there libraries that do this?</li>\n<li>Anything else to add to this discussion?</li>\n</ol>",
        "id": 471046217,
        "sender_full_name": "Cayden Codel",
        "timestamp": 1726594348
    },
    {
        "content": "<p>A quick search on Zulip shows that there has been some recent work on Lean's file IO (e.g., see <a href=\"https://github.com/leanprover/lean4/pull/4950\">this PR</a>, or the <a href=\"https://github.com/hargoniX/socket.lean\">Socket.lean repository</a>). But I wanted to get a fuller picture of things, and so I felt a post here would be a good starting point.</p>",
        "id": 471046693,
        "sender_full_name": "Cayden Codel",
        "timestamp": 1726594499
    },
    {
        "content": "<p>We would eventually want to get a nice file IO API at the level of rust's std::io but that's on the (rather long) TODO list.</p>",
        "id": 471094784,
        "sender_full_name": "Henrik BÃ¶ving",
        "timestamp": 1726607316
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"424407\">Cayden Codel</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Regarding.20the.20API.20for.20IO.2EFS.2EHandle/near/471046217\">said</a>:</p>\n<blockquote>\n<p>I don't know of an easy way to O(1) convert <code>String</code> to <code>ByteArray</code> (<code>unsafeCast</code> doesn't work). [...] Or is there a good way to treat <code>String</code>s as <code>ByteArray</code>s?**</p>\n</blockquote>\n<p>There is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=String.toUTF8#doc\">docs4#String.toUTF8</a> to covert a <code>String</code> to a <code>ByteArray</code>. It does perform a memory copy, though.</p>",
        "id": 474040271,
        "sender_full_name": "Mac Malone",
        "timestamp": 1727789817
    }
]