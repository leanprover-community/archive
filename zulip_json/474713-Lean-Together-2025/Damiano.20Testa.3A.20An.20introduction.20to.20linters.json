[
    {
        "content": "<p>A thread for discussion about this talk.</p>",
        "id": 493603152,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736866452
    },
    {
        "content": "<p><a href=\"https://arxiv.org/pdf/2004.03673\">Back in the day</a> we used the term \"semantic linter\" approximately for what Damiano is calling an environment linter but I never completely convinced myself it was the right name. There are interesting edge cases.</p>",
        "id": 493603750,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1736866620
    },
    {
        "content": "<p>The unused variable linter, for one. It's local, can run per-declaration, is seen in languages that only have syntax linters... but at the same time it doesn't operate only on the surface syntax of the declaration.</p>",
        "id": 493604046,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1736866697
    },
    {
        "content": "<p>So I think Damiano's distinction is a better one!</p>",
        "id": 493604156,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1736866726
    },
    {
        "content": "<p>Are you referring to the <code>linter.unusedVariables</code> syntax linter or the <code>unusedArguments</code> environment linter, <span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span>?</p>",
        "id": 493604683,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736866854
    },
    {
        "content": "<p>In the Lean 3 days we only had <code>unusedArguments</code></p>",
        "id": 493604897,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1736866910
    },
    {
        "content": "<p>Great talk, thanks! Let me ask my question here, in case the answer is useful more permanently:<br>\nIf I like working on linters and want to help out, are there any particular places which need help?</p>",
        "id": 493606854,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1736867439
    },
    {
        "content": "<p>linters all the way down</p>",
        "id": 493607343,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736867591
    },
    {
        "content": "<p>Is it hard to describe the trick for allowing linters to persist information? I am just curious.</p>",
        "id": 493607774,
        "sender_full_name": "Jeremy Avigad",
        "timestamp": 1736867734
    },
    {
        "content": "<p>how was the syntaxtree visualisation made?</p>",
        "id": 493607905,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736867772
    },
    {
        "content": "<p>I imagine Lean linters are written in Lean; is deep knowledge of the language required or does general knowledge on functional-style languages suffice?</p>",
        "id": 493608055,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1736867827
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110865\">Jeremy Avigad</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493607774\">said</a>:</p>\n<blockquote>\n<p>Is it hard to describe the trick for allowing linters to persist information? I am just curious.</p>\n</blockquote>\n<p>I assume it's \"Use <code>IO.Ref</code>\", which means that the state is global and not preserved with the usual mental model of progress in the file.</p>",
        "id": 493608111,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736867850
    },
    {
        "content": "<p>is there a tool to dump a parse tree in e.g. XML or JSON format, or does one need to write a custom linter akin to the ones talked about here?</p>",
        "id": 493608308,
        "sender_full_name": "Jesse Alama",
        "timestamp": 1736867916
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/rZqRNaxs1Es4wBZH3JD9YW7j/2025_Lean_Together_linter_talk.pdf\">Linter talk slides</a></p>",
        "id": 493608884,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868095
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493606854\">said</a>:</p>\n<blockquote>\n<p>Great talk, thanks! Let me ask my question here, in case the answer is useful more permanently:<br>\nIf I like working on linters and want to help out, are there any particular places which need help?</p>\n</blockquote>\n<p>I know that I am not very good at writing fast code: if you know how to write code efficiently and do not know about linters, maybe a good way to learn might be to try to streamline existing code.</p>",
        "id": 493609392,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868227
    },
    {
        "content": "<p>As with formalization, a great way of learning is to choose a goal of something to lint and try to write the linter yourself!</p>",
        "id": 493609524,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868257
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110596\">Rob Lewis</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493604156\">said</a>:</p>\n<blockquote>\n<p>So I think Damiano's distinction is a better one!</p>\n</blockquote>\n<p>I thought that this was a standard name: I have been using for a while, but I think that I heard it from someone else...</p>",
        "id": 493609692,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868315
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110865\">Jeremy Avigad</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493607774\">said</a>:</p>\n<blockquote>\n<p>Is it hard to describe the trick for allowing linters to persist information? I am just curious.</p>\n</blockquote>\n<p>What Eric said is correct: there is an <code>IO.Ref</code> that stores the \"current\" imports.  This <code>IO.Ref</code> is accessed by the linter after each command: if the commands are parsed linearly, then what each command sees is the effect of having modified the <code>IO.Ref</code> with all the previous commands.</p>",
        "id": 493609924,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868392
    },
    {
        "content": "<p>If, instead, the file is not parsed linearly, then you do not know how modified it before you access it and everything becomes confused.</p>",
        "id": 493610009,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868421
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493607905\">said</a>:</p>\n<blockquote>\n<p>how was the syntaxtree visualisation made?</p>\n</blockquote>\n<p>I have a custom function that displays <code>Syntax</code> and <code>Expr</code> trees.</p>",
        "id": 493610129,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868450
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493608055\">said</a>:</p>\n<blockquote>\n<p>I imagine Lean linters are written in Lean; is deep knowledge of the language required or does general knowledge on functional-style languages suffice?</p>\n</blockquote>\n<p>They are written in Lean, indeed.  The fact that the language is the same, means that everything is familiar.  If you have done some meta-programming, a linter is simply a function from Syntax that runs in the <code>CommandElabM</code> monad.</p>",
        "id": 493610412,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868525
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"754512\">Jesse Alama</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493608308\">said</a>:</p>\n<blockquote>\n<p>is there a tool to dump a parse tree in e.g. XML or JSON format, or does one need to write a custom linter akin to the ones talked about here?</p>\n</blockquote>\n<p>I played around with a flexible linter that you can activate with a piece of syntax and then flags those uses.</p>",
        "id": 493610536,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868560
    },
    {
        "content": "<p>It worked reasonably well, but it was never PRed to mathlib.</p>",
        "id": 493610579,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736868571
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493610412\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493608055\">said</a>:</p>\n<blockquote>\n<p>I imagine Lean linters are written in Lean; is deep knowledge of the language required or does general knowledge on functional-style languages suffice?</p>\n</blockquote>\n<p>They are written in Lean, indeed.  The fact that the language is the same, means that everything is familiar.  If you have done some meta-programming, a linter is simply a function from Syntax that runs in the <code>CommandElabM</code> monad.</p>\n</blockquote>\n<p>Perhaps one could make a custom linter that emits the syntax tree in a format I have in mind. (In other words, just to repeat the earlier comment about linters all the way down, we need a linter to enable more linting!)</p>",
        "id": 493610758,
        "sender_full_name": "Jesse Alama",
        "timestamp": 1736868610
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493606854\">said</a>:</p>\n<blockquote>\n<p>Great talk, thanks! Let me ask my question here, in case the answer is useful more permanently:<br>\nIf I like working on linters and want to help out, are there any particular places which need help?</p>\n</blockquote>\n<p>Probably different people have different opinions about what's most important, but I made <a href=\"https://github.com/leanprover-community/mathlib4/pull/7217\">#7217</a> as a tracking issue for desired linters, based both on the mathlib style guide and zulip conversations/my own thoughts. People should feel free to use that issue as inspiration or edit things into the list there if they'd like.</p>",
        "id": 493613360,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1736869325
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"754512\">Jesse Alama</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493608308\">said</a>:</p>\n<blockquote>\n<p>is there a tool to dump a parse tree in e.g. XML or JSON format, or does one need to write a custom linter akin to the ones talked about here?</p>\n</blockquote>\n<p>Although probably of general interest and definitely useful for some task, my instinct would be to <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> this in any specific case: I'd guess that working within Lean would be the nicest way to interact with syntax trees!</p>",
        "id": 493614910,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1736869785
    },
    {
        "content": "<p>I had to run after the first 10mins, so sorry if this was answered during the talk: Why are the environments linters not automatically run at the end of the file (as if every file ended with <code>#lint</code>)?</p>",
        "id": 493617406,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1736870460
    },
    {
        "content": "<p>I think the answer is \"environment linters aren't part of Lean itself, they're just a program that lives in Batteries\". I don't believe there is any way to run something at the end of a file, in general?</p>",
        "id": 493620105,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736871221
    },
    {
        "content": "<p>I believe this has been discussed before, but I would love linters that suggest a fix rather than just saying \"there's a problem here\". We have all the infrastructure (linters and code actions); we just need to teach Lean not to kill code actions when it resets the environment after a linter has been run.</p>",
        "id": 493622377,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1736871865
    },
    {
        "content": "<p>yes, there is an open issue about that (edit: thanks, <a href=\"https://github.com/leanprover/lean4/pull/4363\">lean4#4363</a>)</p>",
        "id": 493628685,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736873709
    },
    {
        "content": "<p>The issue in question: <br>\n<a href=\"https://github.com/leanprover/lean4/issues/4363https://github.com/leanprover/lean4/issues/4363\">https://github.com/leanprover/lean4/issues/4363https://github.com/leanprover/lean4/issues/4363</a></p>",
        "id": 493632584,
        "sender_full_name": "Ayhon",
        "timestamp": 1736874963
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493620105\">said</a>:</p>\n<blockquote>\n<p>I don't believe there is any way to run something at the end of a file, in general?</p>\n</blockquote>\n<p>Maybe worth a feature request? It would be great if mathlib contributers would have to wait for CI to come back to be reminded to lint their files.</p>",
        "id": 493643140,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1736878888
    },
    {
        "content": "<p>You could have a <em>syntax</em> linter that, on reaching the end of a file runs <code>#lint</code> and reports the outcome if there are errors.</p>",
        "id": 493651875,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736882203
    },
    {
        "content": "<p>I believe there are some environment linters like simp theorems that require a project-wide view, they would get weaker when run at the end of each file</p>",
        "id": 493652982,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736882616
    },
    {
        "content": "<p>Your <a href=\"https://github.com/leanprover-community/mathlib4/pull/20750\">#20750</a> even does that <span aria-label=\"racecar\" class=\"emoji emoji-1f3ce\" role=\"img\" title=\"racecar\">:racecar:</span></p>",
        "id": 493653049,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1736882635
    },
    {
        "content": "<p>Indeed, this is not the \"final\" word on environment linters, but it would catch quite a few issues early, I think.</p>",
        "id": 493653219,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736882682
    },
    {
        "content": "<p>Clearly there are declaration linters, module linters, and library linters</p>",
        "id": 493653295,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1736882708
    },
    {
        "content": "<p>Anyway, I wrote it just as a proof of concept: the fact that it <em>can</em> be done like this, does not mean that this is how is <em>should</em> be done!</p>",
        "id": 493653324,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736882724
    },
    {
        "content": "<p>Having the docBlame linter nudge me early seems certainly nice to have. (Perhaps it should just run <code>#lint only docBlame</code>? Or opt out of certain linters, like the simpNF one?)</p>",
        "id": 493654434,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1736883102
    },
    {
        "content": "<p><span aria-label=\"video camera\" class=\"emoji emoji-1f4f9\" role=\"img\" title=\"video camera\">:video_camera:</span> Video recording: <a href=\"https://youtu.be/734jMwgjkkM\">https://youtu.be/734jMwgjkkM</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"734jMwgjkkM\" href=\"https://youtu.be/734jMwgjkkM\"><img src=\"https://uploads.zulipusercontent.net/fc020e2319767447887ee6d6ad5e94cbc1696171/68747470733a2f2f692e7974696d672e636f6d2f76692f3733346a4d77676a6b6b4d2f64656661756c742e6a7067\"></a></div>",
        "id": 493668117,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1736887921
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/474713-Lean-Together-2025/topic/Damiano.20Testa.3A.20An.20introduction.20to.20linters/near/493653049\">said</a>:</p>\n<blockquote>\n<p>Your <a href=\"https://github.com/leanprover-community/mathlib4/pull/20750\">#20750</a> even does that <span aria-label=\"racecar\" class=\"emoji emoji-1f3ce\" role=\"img\" title=\"racecar\">:racecar:</span></p>\n</blockquote>\n<p>Does <code>Parser.isTerminalCommand</code> really fire on the end of a file? Or only on <code>#exit</code>?</p>",
        "id": 493670271,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736888697
    },
    {
        "content": "<p>It fires on <code>#exit</code>, the end of the file and at <code>import</code>s.</p>",
        "id": 493673675,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890039
    },
    {
        "content": "<p>The firing at the end of file is prevented by setting the linter option.</p>",
        "id": 493673698,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890052
    },
    {
        "content": "<p>The firing at <code>import</code> is not relevant for the linter, since linters do not actually run after <code>import</code> commands.</p>",
        "id": 493673738,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890072
    },
    {
        "content": "<p>The implementation of <code>isTerminal</code> is simply</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isTerminalCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Command.exit</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Command.import</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Command.eoi</span>\n</code></pre></div>",
        "id": 493673886,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890125
    },
    {
        "content": "<p>When lean parses a file, it adds a \"fictitious\" <code>eoi</code> node to \"close off\" the file and the linter latches onto that.  I made the linter work also on <code>#exit</code> since otherwise testing it is hard.</p>",
        "id": 493674390,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890314
    },
    {
        "content": "<p>However, this linter is another one that would require a nolints file and I am not too convinced that it is better to have it as a syntax linter, than simply running it in CI.</p>",
        "id": 493674609,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890395
    },
    {
        "content": "<p>I did not expect linters to be run against <code>eoi</code>!</p>",
        "id": 493675708,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736890836
    },
    {
        "content": "<p>Already the long file linter does that.  And maybe also the <code>minImports</code> linter.</p>",
        "id": 493675773,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890863
    },
    {
        "content": "<p>In fact, the longFile linter takes the position information of <code>eoi</code> and decides what to do.</p>",
        "id": 493675849,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890888
    },
    {
        "content": "<p>(This is the linter that is a pain to test and having a file with multiple <code>#exit</code> is <em>very</em> convenient for testing the various settings.)</p>",
        "id": 493675925,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736890916
    },
    {
        "content": "<p>In fact, given how linters run, <code>eoi</code> is the only \"anchor\" that they have to some absolute information about a file.  Everything else is little more than heuristic.</p>",
        "id": 493676161,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736891005
    },
    {
        "content": "<p>I enjoyed the talk very much! I was wondering if code was available for the linters mentioned in the slide about in-progress/prototype linters? In particular I'm currently working on a connected declarations linter to find not only minimal imports but also minimal <code>Name</code> references in each declaration. In any case, very interested to see future work in this area, is there anything you would recommend following to keep up to date with this?</p>",
        "id": 493894472,
        "sender_full_name": "nrs",
        "timestamp": 1736937434
    },
    {
        "content": "<p>The development of code for finding connected declarations is partly on hold, since <a href=\"#narrow/channel/113488-general/topic/Minimal.20lean.20file.20for.20a.20definition.20or.20theorem/near/473893608\">this comment</a>.</p>",
        "id": 493897943,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736938651
    },
    {
        "content": "<p>Oh that topic is directly relevant to what I'm trying to do, thank you! Thanks again for the talk, have begun digging through the source of some linters you mention</p>",
        "id": 493899003,
        "sender_full_name": "nrs",
        "timestamp": 1736938995
    },
    {
        "content": "<p>As for available code: I <em>think</em> that I linked most available PRs.  A lot of the tools that should go into finding connected declarations have in fact become independent tools that are mostly merged.</p>",
        "id": 493899094,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736939021
    },
    {
        "content": "<p>Useful functions are <code>getUsedConstants</code> and friends, but they only give <code>Expr</code> information: to get a file that actually builds, I had developed the code that became the <code>minImports</code> linter, accessing syntax and tactic information.</p>",
        "id": 493899459,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736939133
    },
    {
        "content": "<p>After that, to get which variables in scope are needed, I have been developing tools to work with that, which is partly how the unusedVariable linter (<a href=\"https://github.com/leanprover-community/mathlib4/pull/17715\">#17715</a>) came about (this still requires work).</p>",
        "id": 493899751,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736939217
    },
    {
        "content": "<p>Ah I see! Thanks for taking the time, will be going through the references you mention today</p>",
        "id": 493900354,
        "sender_full_name": "nrs",
        "timestamp": 1736939403
    },
    {
        "content": "<p>No problem!  If you see a specific missing reference, let me know and I will try to dig it out, but not everything is really \"available\".</p>",
        "id": 493906889,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736941575
    }
]